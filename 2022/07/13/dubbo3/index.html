<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="stylesheet" href="https://npm.elemecdn.com/lxgw-wenkai-screen-webfont/style.css" media="print" onload='this.media="all"'><link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png"><link rel="icon" href="/img/fluid.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="wugengfeng"><meta name="keywords" content="wugengfeng"><meta name="description" content="文章参考博客：风祈的时光录  前期准备  dubbo3 源码 官方文档 源码构建 12下载源码 git clone https:&#x2F;&#x2F;github.com&#x2F;apache&#x2F;dubbo.git编译打包 mvn clean source:jar install -Dmaven.test.skip dubbo sample 源码  dubbo admin 安装  前提条件是需要先安装 zookeeper 1"><meta property="og:type" content="article"><meta property="og:title" content="dubbo3"><meta property="og:url" content="https://wugengfeng.cn/2022/07/13/dubbo3/index.html"><meta property="og:site_name" content="技术博客"><meta property="og:description" content="文章参考博客：风祈的时光录  前期准备  dubbo3 源码 官方文档 源码构建 12下载源码 git clone https:&#x2F;&#x2F;github.com&#x2F;apache&#x2F;dubbo.git编译打包 mvn clean source:jar install -Dmaven.test.skip dubbo sample 源码  dubbo admin 安装  前提条件是需要先安装 zookeeper 1"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://wugengfeng.cn/img/banner/dubbo.png"><meta property="article:published_time" content="2022-07-13T09:45:57.000Z"><meta property="article:modified_time" content="2023-07-14T06:49:15.573Z"><meta property="article:author" content="wugengfeng"><meta property="article:tag" content="wugengfeng"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://wugengfeng.cn/img/banner/dubbo.png"><meta name="baidu-site-verification" content="codeva-uJ0fkFPmHB"><title>dubbo3 - 技术博客</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="/css/custom.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var dntVal,CONFIG={hostname:"wugengfeng.cn",root:"/",version:"1.9.3",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!1,element:"h9",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:1},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!1,follow_dnt:!0,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml"};CONFIG.web_analytics.follow_dnt&&(dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on")))</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="技术博客" type="application/atom+xml"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>吴耿锋</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> <span>首页</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> <span>归档</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> <span>分类</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> <span>标签</span></a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> <span>关于</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="dubbo3"></span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2022-07-13 17:45" pubdate>2022年7月13日 下午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 58k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 481 分钟</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 style="display:none">dubbo3</h1><div class="markdown-body"><p>文章参考博客：<a target="_blank" rel="noopener" href="https://imlql.cn/categories/rpc/Dubbo%E6%BA%90%E7%A0%81%E7%B3%BB%E5%88%97v1/">风祈的时光录</a></p><h2 id="前期准备"><a class="markdownIt-Anchor" href="#前期准备"></a> 前期准备</h2><h3 id="dubbo3-源码"><a class="markdownIt-Anchor" href="#dubbo3-源码"></a> dubbo3 源码</h3><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/dev/build/">官方文档 源码构建</a></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">下载源码 git clone https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/apache/</span>dubbo.git<br>编译打包 mvn clean source:jar install -Dmaven.test.skip<br></code></pre></td></tr></table></figure><p><a target="_blank" rel="noopener" href="https://github.com/apache/dubbo-samples">dubbo sample 源码</a></p><h3 id="dubbo-admin-安装"><a class="markdownIt-Anchor" href="#dubbo-admin-安装"></a> dubbo admin 安装</h3><blockquote><p><strong>前提条件是需要先安装 zookeeper</strong></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">docker pull zookeeper<br><br>docker <span class="hljs-built_in">run</span> -d -e <span class="hljs-attribute">TZ</span>=<span class="hljs-string">&quot;Asia/Shanghai&quot;</span> -p 2181:2181 --name zookeeper  zookeeper<br></code></pre></td></tr></table></figure><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">获取docker容器：docker pull docker.io<span class="hljs-regexp">/apache/</span>dubbo-admin:<span class="hljs-number">0.4</span>.<span class="hljs-number">0</span><br><br>运行：docker run -d --name dubbo-admin -p <span class="hljs-number">8080</span>:<span class="hljs-number">8080</span> -e admin.registry.address=zookeeper:<span class="hljs-regexp">//i</span>p:<span class="hljs-number">2181</span> -e admin.config-center=zookeeper:<span class="hljs-regexp">//i</span>p:<span class="hljs-number">2181</span> -e admin.metadata-report.address=zookeeper:<span class="hljs-regexp">//i</span>p:<span class="hljs-number">2181</span> docker.io<span class="hljs-regexp">/apache/</span>dubbo-admin:<span class="hljs-number">0.4</span>.<span class="hljs-number">0</span><br></code></pre></td></tr></table></figure></blockquote><h2 id="整体设计"><a class="markdownIt-Anchor" href="#整体设计"></a> 整体设计</h2><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/dev/design/">官方文档 框架设计</a></p><blockquote><p><img src="/2022/07/13/dubbo3/%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84.png" srcset="/img/loading.gif" lazyload alt></p></blockquote><h2 id="基本介绍"><a class="markdownIt-Anchor" href="#基本介绍"></a> 基本介绍</h2><h3 id="什么是rpc"><a class="markdownIt-Anchor" href="#什么是rpc"></a> 什么是RPC</h3><blockquote><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%88%86%E5%B8%83%E5%BC%8F%E8%AE%A1%E7%AE%97">分布式计算</a>中，<strong>远程过程调用</strong>（英语：<strong>R</strong>emote <strong>P</strong>rocedure <strong>C</strong>all，<strong>RPC</strong>）是一个计算机通信<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%B6%B2%E7%B5%A1%E5%82%B3%E8%BC%B8%E5%8D%94%E8%AD%B0">协议</a>。该协议允许运行于一台计算机的<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%A8%8B%E5%BA%8F">程序</a>调用另一个<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4">地址空间</a>（通常为一个开放网络的一台计算机）的<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%AD%90%E7%A8%8B%E5%BA%8F">子程序</a>，而程序员就像调用本地程序一样，无需额外地为这个交互作用编程（无需关注细节）。RPC是一种服务器-客户端（Client/Server）模式，经典实现是一个通过<strong>发送请求-接受回应</strong>进行信息交互的系统。</p><p>如果涉及的软件采用<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%BC%96%E7%A8%8B">面向对象编程</a>，那么远程过程调用亦可称作<strong>远程调用</strong>或<strong>远程方法调用</strong>，例：<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Java_RMI">Java RMI</a>。</p><p>RPC是一种<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1">进程间通信</a>的模式，程序分布在不同的<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4">地址空间</a>里。如果在同一主机里，RPC可以通过不同的虚拟地址空间（即便使用相同的物理地址）进行通讯，而在不同的主机间，则通过不同的物理地址进行交互。许多技术（通常是不兼容）都是基于这种概念而实现的</p><p><em><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E9%81%A0%E7%A8%8B%E9%81%8E%E7%A8%8B%E8%AA%BF%E7%94%A8">–来至自维基百科</a></em></p><hr><p><strong>远程方法调用</strong>和<strong>本地方法调用</strong>是相对的两个概念，本地方法调用指的是进程内部的方法调用，而远程方法调用指的是两个进程内的方法相互调用</p><p>如果实现远程方法调用，基本的就是通过网络，通过传输数据来进行调用</p><p>所以就有了：</p><ol><li>RPC over <code>Http</code>：基于Http协议来传输数据</li><li>PRC over <code>Tcp</code>：基于Tcp协议来传输数据</li></ol><p>对于所传输的数据，可以交由RPC的双方来协商定义，但基本都会包括：</p><ol><li><strong>调用的是哪个类或接口</strong></li><li><strong>调用的是哪个方法，方法名和方法参数类型</strong>（考虑方法重载）</li><li><strong>调用方法的入参</strong></li></ol><p>所以，我们其实可以看到RPC的自定义性是很高的，各个公司内部都可以实现自己的一套RPC框架，而<strong>Dubbo</strong>就是阿里所开源出来的一套RPC框架，<span style="border-bottom:2px dashed green">根据上面所描述的条件很容易联想到将类名，方法名称，参数，参数列表通过网络传输到服务提供方，通过反射等方式执行服务提供方代码逻辑后将返回值原路返回，这就是整个Dubbo实现RPC调用的基本原理</span></p></blockquote><h3 id="什么是dubbo"><a class="markdownIt-Anchor" href="#什么是dubbo"></a> 什么是Dubbo</h3><blockquote><p>官网地址：<a target="_blank" rel="noopener" href="http://dubbo.apache.org/zh/">http://dubbo.apache.org/zh/</a></p><p>目前，官网上是这么介绍的：<strong>Apache Dubbo 是一款高性能、轻量级的开源 Java服务框架</strong></p><p>在几个月前，官网的介绍是：<strong>Apache Dubbo 是一款高性能、轻量级的开源 JavaRPC框架</strong></p><p>为什么会将<strong>RPC</strong>改为<strong>服务</strong>？</p><p><span style="border-bottom:2px dashed green">Dubbo一开始的定位就是RPC，专注于两个服务之间的调用。但随着微服务的盛行，除开<strong>服务调用</strong>之外，Dubbo也在逐步的涉猎 <code>服务治理</code>、<code>服务监控</code>、<code>服务网关</code> 等等，所以现在的Dubbo目标已经不止是RPC框架了，而是和Spring Cloud类似想成为了一个<strong>服务</strong>框架</span></p><p>dubbo RPC主要用于两个dubbo系统之间作远程调用，特别适合高并发、小数据的互联网场景</p><p>Dubbo网关参考：<a target="_blank" rel="noopener" href="https://github.com/apache/dubbo-proxy%EF%BC%88%E7%A4%BE%E5%8C%BA%E4%B8%8D%E6%98%AF%E5%BE%88%E6%B4%BB%E8%B7%83%EF%BC%89">https://github.com/apache/dubbo-proxy（社区不是很活跃）</a></p></blockquote><h3 id="基本原理"><a class="markdownIt-Anchor" href="#基本原理"></a> 基本原理</h3><blockquote><p><strong>相关文档</strong></p><ul><li><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/concepts/service-discovery/">文档 服务发现</a></li><li><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/blog/2021/06/02/dubbo3-%E5%BA%94%E7%94%A8%E7%BA%A7%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0/">社区 应用级发现</a></li><li><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/blog/2019/10/17/dubbo-%E4%B8%AD%E7%9A%84-url-%E7%BB%9F%E4%B8%80%E6%A8%A1%E5%9E%8B/">社区 URL同一建模</a></li></ul><p><img src="/2022/07/13/dubbo3/%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0.png" srcset="/img/loading.gif" lazyload alt></p><p>值得注意的是，dubbo3服务注册粒度由<code>接口级</code>改为<code>应用级</code></p></blockquote><h3 id="开源rpc框架对比"><a class="markdownIt-Anchor" href="#开源rpc框架对比"></a> 开源RPC框架对比</h3><blockquote><table><thead><tr><th>功能</th><th>Hessian</th><th>Montan</th><th>rpcx</th><th>gRPC</th><th>Thrift</th><th>Dubbo</th><th>Dubbox</th><th>Spring Cloud</th></tr></thead><tbody><tr><td>开发语言</td><td>跨语言</td><td>Java</td><td>Go</td><td>跨语言</td><td>跨语言</td><td>Java</td><td>Java</td><td>Java</td></tr><tr><td>分布式(服务治理)</td><td>×</td><td>√</td><td>√</td><td>×</td><td>×</td><td>√</td><td>√</td><td>√</td></tr><tr><td>多序列化框架支持</td><td>hessian</td><td>√(支持Hessian2、Json,可扩展)</td><td>√</td><td>× 只支持(protobuf)</td><td>×(thrift格式)</td><td>√</td><td>√</td><td>√</td></tr><tr><td>多种注册中心</td><td>×</td><td>√</td><td>√</td><td>×</td><td>×</td><td>√</td><td>√</td><td>√</td></tr><tr><td>管理中心</td><td>×</td><td>√</td><td>√</td><td>×</td><td>×</td><td>√</td><td>√</td><td>√</td></tr><tr><td>跨编程语言</td><td>√</td><td>×(支持php client和C server)</td><td>×</td><td>√</td><td>√</td><td>×</td><td>×</td><td>×</td></tr><tr><td>支持REST</td><td>×</td><td>×</td><td>×</td><td>×</td><td>×</td><td>×</td><td>√</td><td>√</td></tr><tr><td>关注度</td><td>低</td><td>中</td><td>低</td><td>中</td><td>中</td><td>中</td><td>高</td><td>中</td></tr><tr><td>上手难度</td><td>低</td><td>低</td><td>中</td><td>中</td><td>中</td><td>低</td><td>低</td><td>中</td></tr><tr><td>运维成本</td><td>低</td><td>中</td><td>中</td><td>中</td><td>低</td><td>中</td><td>中</td><td>中</td></tr><tr><td>开源机构</td><td>Caucho</td><td>Weibo</td><td>Apache</td><td>Google</td><td>Apache</td><td>Alibaba</td><td>Dangdang</td><td>Apache</td></tr></tbody></table></blockquote><h2 id="基本与高级应用"><a class="markdownIt-Anchor" href="#基本与高级应用"></a> 基本与高级应用</h2><h3 id="启动时检查"><a class="markdownIt-Anchor" href="#启动时检查"></a> 启动时检查</h3><blockquote><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/examples/preflight-check/">使用文档 启动时检查</a></p><p><span style="border-bottom:2px dashed green">在<strong>消费端</strong>启动时检查依赖的服务是否可用，不可用时会抛出异常，阻止 Spring 初始化完成，默认开启</span></p><ul><li><p>服务级别配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DubboReference(check = true)</span><br></code></pre></td></tr></table></figure></li><li><p>全局配置</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">dubbo:</span>  <br>  <span class="hljs-attr">consumer:</span><br>    <span class="hljs-attr">check:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure></li><li><p>XML 配置参考官方文档</p></li></ul></blockquote><h3 id="线程模型"><a class="markdownIt-Anchor" href="#线程模型"></a> 线程模型</h3><blockquote><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/examples/thread-model/">使用文档 线程模型</a></p><p><font size="5">配置 Dubbo 中的线程模型</font></p><p>如果事件处理的逻辑能迅速完成，并且不会发起新的 IO 请求，比如只是在内存中记个标识，则直接在 IO 线程上处理更快，因为减少了线程池调度。</p><p>但如果事件处理逻辑较慢，或者需要发起新的 IO 请求，比如需要查询数据库，则必须派发到线程池，否则 IO 线程阻塞，将导致不能接收其它请求。</p><p>如果用 IO 线程处理事件，又在事件处理过程中发起新的 IO 请求，比如在连接事件中发起登录请求，会报“可能引发死锁”异常，但不会真死锁。</p><ul><li><p>XML 配置 （缺省配置）</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dubbo:protocol</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dubbo&quot;</span> <span class="hljs-attr">dispatcher</span>=<span class="hljs-string">&quot;all&quot;</span> <span class="hljs-attr">threadpool</span>=<span class="hljs-string">&quot;fixed&quot;</span> <span class="hljs-attr">threads</span>=<span class="hljs-string">&quot;200&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>yml 配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">dubbo:</span>  <br>  <span class="hljs-attr">protocol:</span><br>    <span class="hljs-attr">dispatcher:</span> <span class="hljs-string">all</span><br>    <span class="hljs-attr">threadpool:</span> <span class="hljs-string">fixed</span><br>    <span class="hljs-attr">threads:</span> <span class="hljs-number">200</span><br></code></pre></td></tr></table></figure></li></ul><hr><p><strong>Dispatcher</strong></p><ul><li><code>all</code> 所有消息都派发到线程池，包括请求，响应，连接事件，断开事件，心跳等。(默认配置)</li><li><code>direct</code> 所有消息都不派发到线程池，全部在 IO 线程上直接执行。</li><li><code>message</code> 只有请求响应消息派发到线程池，其它连接断开事件，心跳等消息，直接在 IO 线程上执行。</li><li><code>execution</code> 只有请求消息派发到线程池，不含响应，响应和其它连接断开事件，心跳等消息，直接在 IO 线程上执行。</li><li><code>connection</code> 在 IO 线程上，将连接断开事件放入队列，有序逐个执行，其它消息派发到线程池。</li></ul><hr><p><strong>ThreadPool</strong></p><ul><li><code>fixed</code> 固定大小线程池，启动时建立线程，不关闭，一直持有。(默认配置)</li><li><code>cached</code> 缓存线程池，空闲一分钟自动删除，需要时重建。</li><li><code>limited</code> 可伸缩线程池，但池中的线程数只会增长不会收缩。只增长不收缩的目的是为了避免收缩时突然来了大流量引起的性能问题。</li><li><code>eager</code> 优先创建<code>Worker</code>线程池。在任务数量大于<code>corePoolSize</code>但是小于<code>maximumPoolSize</code>时，优先创建<code>Worker</code>来处理任务。当任务数量大于<code>maximumPoolSize</code>时，将任务放入阻塞队列中。阻塞队列充满时抛出<code>RejectedExecutionException</code>。(相比于<code>cached</code>:<code>cached</code>在任务数量超过<code>maximumPoolSize</code>时直接抛出异常而不是将任务放入阻塞队列)</li></ul></blockquote><h3 id="消费端线程模型"><a class="markdownIt-Anchor" href="#消费端线程模型"></a> 消费端线程模型</h3><blockquote><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/examples/consumer-threadpool/">官方介绍</a></p></blockquote><h3 id="直接提供者"><a class="markdownIt-Anchor" href="#直接提供者"></a> 直接提供者</h3><blockquote><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/examples/explicit-target/">使用文档 直连提供者</a></p><p><font size="5">Dubbo 中点对点的直连方式</font></p><p>在开发及测试环境下，经常需要绕过注册中心，只测试指定服务提供者，这时候可能需要点对点直连，点对点直连方式，将以服务接口为单位，忽略注册中心的提供者列表，A 接口配置点对点，不影响 B 接口从注册中心获取列表</p><p><span style="border-bottom:2px dashed green">主要用于开发阶段本地调试</span></p><ul><li><p>XML</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dubbo:reference</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;xxxService&quot;</span> <span class="hljs-attr">interface</span>=<span class="hljs-string">&quot;com.alibaba.xxx.XxxService&quot;</span> <span class="hljs-attr">url</span>=<span class="hljs-string">&quot;dubbo://localhost:20890&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>-D 参数</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">java -Dcom<span class="hljs-selector-class">.alibaba</span><span class="hljs-selector-class">.xxx</span>.XxxService=dubbo:<span class="hljs-comment">//localhost:20890</span><br></code></pre></td></tr></table></figure></li><li><p>注解</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DubboReference(url = &quot;dubbo://localhost:20880&quot;)</span><br></code></pre></td></tr></table></figure></li></ul></blockquote><h3 id="只订阅"><a class="markdownIt-Anchor" href="#只订阅"></a> 只订阅</h3><blockquote><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/examples/subscribe-only/">使用文档 只订阅</a></p><p><font size="5">只订阅不注册</font></p><p>为方便开发测试，经常会在线下共用一个所有服务可用的注册中心，这时，如果一个正在开发中的服务提供者注册，可能会影响消费者不能正常运行</p><p>可以让服务提供者开发方，只订阅服务(开发的服务可能依赖其它服务)，而不注册正在开发的服务，通过直连测试正在开发的服务</p><p><span style="border-bottom:2px dashed green">主要用于开发阶段本地调试</span></p><ul><li><p>XML</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dubbo:registry</span> <span class="hljs-attr">address</span>=<span class="hljs-string">&quot;10.20.153.10:9090&quot;</span> <span class="hljs-attr">register</span>=<span class="hljs-string">&quot;false&quot;</span> /&gt;</span><br>或者<br><span class="hljs-tag">&lt;<span class="hljs-name">dubbo:registry</span> <span class="hljs-attr">address</span>=<span class="hljs-string">&quot;10.20.153.10:9090?register=false&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">dubbo:</span><br>  <span class="hljs-attr">registry:</span><br>    <span class="hljs-attr">address:</span> <span class="hljs-string">zookeeper://my-server:2181</span><br>    <span class="hljs-attr">register:</span> <span class="hljs-literal">false</span><br></code></pre></td></tr></table></figure></li></ul></blockquote><h3 id="多注册中心"><a class="markdownIt-Anchor" href="#多注册中心"></a> 多注册中心</h3><blockquote><ul><li><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/examples/multi-registry/#%E5%A4%9A%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%B3%A8%E5%86%8C">使用文档 多注册中心</a></li><li><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/dev/impls/registry/">扩展文档 注册中心扩展</a></li></ul><p><font size="5">在 Dubbo 中把同一个服务注册到多个注册中心上</font></p><p>Dubbo 支持同一服务向多注册中心同时注册，或者不同服务分别注册到不同的注册中心上去，甚至可以同时引用注册在不同注册中心上的同名服务。另外，注册中心是支持自定义扩展的</p><p><span style="border-bottom:2px dashed green">在没有配置 <code>default=false</code> 的注册中心都是默认的注册中心(默认值是 true)，不管服务怎么指定注册中心都一定会注册到配置 <code>default=false</code> 的注册中心</span></p><hr><p><strong>多注册中心</strong></p><p><img src="/2022/07/13/dubbo3/%E5%A4%9A%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%B3%A8%E5%86%8C.png" srcset="/img/loading.gif" lazyload alt></p><p>比如：中文站有些服务来不及在青岛部署，只在杭州部署，而青岛的其它应用需要引用此服务，就可以将服务同时注册到两个注册中心</p><p>注意：3.0.9的 <code>default=false</code> 有bug, 默认还是会向 <code>default=false</code> 的注册中心注册</p><ul><li><p>XML</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:dubbo</span>=<span class="hljs-string">&quot;http://dubbo.apache.org/schema/dubbo&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.3.xsd http://dubbo.apache.org/schema/dubbo http://dubbo.apache.org/schema/dubbo/dubbo.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dubbo:application</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;world&quot;</span>  /&gt;</span><br>    <span class="hljs-comment">&lt;!-- 多注册中心配置 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dubbo:registry</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;hangzhouRegistry&quot;</span> <span class="hljs-attr">address</span>=<span class="hljs-string">&quot;10.20.141.150:9090&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dubbo:registry</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;qingdaoRegistry&quot;</span> <span class="hljs-attr">address</span>=<span class="hljs-string">&quot;10.20.141.151:9010&quot;</span> <span class="hljs-attr">default</span>=<span class="hljs-string">&quot;false&quot;</span> /&gt;</span><br>    <span class="hljs-comment">&lt;!-- 向多个注册中心注册 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dubbo:service</span> <span class="hljs-attr">interface</span>=<span class="hljs-string">&quot;com.alibaba.hello.api.HelloService&quot;</span> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;1.0.0&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;helloService&quot;</span> <span class="hljs-attr">registry</span>=<span class="hljs-string">&quot;hangzhouRegistry,qingdaoRegistry&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>注解</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 多注册中心配置</span><br><span class="hljs-attr">dubbo:</span> <br> <span class="hljs-attr">registries:</span><br>    <span class="hljs-attr">hangzhouRegistry:</span><br>      <span class="hljs-attr">address:</span> <span class="hljs-string">zookeeper://10.20.141.150:9090:9090</span><br>    <span class="hljs-attr">qingdaoRegistry:</span><br>      <span class="hljs-attr">default:</span> <span class="hljs-literal">false</span> <span class="hljs-comment">#默认不向这个注册中心注册，除非指定</span><br>      <span class="hljs-attr">address:</span> <span class="hljs-string">zookeeper://10.20.141.151:9090</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DubboService(registry = &#123;&quot;hangzhouRegistry&quot;,&quot;qingdaoRegistry&quot;&#125;)</span><br></code></pre></td></tr></table></figure></li></ul><hr><p><strong>不同服务使用不同注册中心</strong></p><p><img src="/2022/07/13/dubbo3/%E4%B8%8D%E5%90%8C%E6%9C%8D%E5%8A%A1%E4%BD%BF%E7%94%A8%E4%B8%8D%E5%90%8C%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83.png" srcset="/img/loading.gif" lazyload alt></p><p>比如：CRM 有些服务是专门为国际站设计的，有些服务是专门为中文站设计的</p><ul><li><p>XML</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:dubbo</span>=<span class="hljs-string">&quot;http://dubbo.apache.org/schema/dubbo&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.3.xsd http://dubbo.apache.org/schema/dubbo http://dubbo.apache.org/schema/dubbo/dubbo.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dubbo:application</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;world&quot;</span>  /&gt;</span><br>    <span class="hljs-comment">&lt;!-- 多注册中心配置 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dubbo:registry</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;chinaRegistry&quot;</span> <span class="hljs-attr">address</span>=<span class="hljs-string">&quot;10.20.141.150:9090&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dubbo:registry</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;intlRegistry&quot;</span> <span class="hljs-attr">address</span>=<span class="hljs-string">&quot;10.20.154.177:9010&quot;</span> <span class="hljs-attr">default</span>=<span class="hljs-string">&quot;false&quot;</span> /&gt;</span><br>    <span class="hljs-comment">&lt;!-- 向中文站注册中心注册 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dubbo:service</span> <span class="hljs-attr">interface</span>=<span class="hljs-string">&quot;com.alibaba.hello.api.HelloService&quot;</span> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;1.0.0&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;helloService&quot;</span> <span class="hljs-attr">registry</span>=<span class="hljs-string">&quot;chinaRegistry&quot;</span> /&gt;</span><br>    <span class="hljs-comment">&lt;!-- 向国际站注册中心注册 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dubbo:service</span> <span class="hljs-attr">interface</span>=<span class="hljs-string">&quot;com.alibaba.hello.api.DemoService&quot;</span> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;1.0.0&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;demoService&quot;</span> <span class="hljs-attr">registry</span>=<span class="hljs-string">&quot;intlRegistry&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>注解</p><p>yml 需要先配置多注册中心</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 这个服务会注册到 intlRegistry 和 chinaRegistry</span><br><span class="hljs-meta">@DubboService(registry = &quot;chinaRegistry&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HelloService</span> &#123;<br>  ...<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DubboService(registry = &quot;intlRegistry&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DemoService</span> &#123;<br>  ...<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><hr><p><strong>多注册中心引用</strong></p><p><img src="/2022/07/13/dubbo3/%E5%A4%9A%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E5%BC%95%E7%94%A8.png" srcset="/img/loading.gif" lazyload alt></p><p>比如：CRM 需同时调用中文站和国际站的 PC2 服务，PC2 在中文站和国际站均有部署，接口及版本号都一样，但连的数据库不一样</p><ul><li><p>XML</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:dubbo</span>=<span class="hljs-string">&quot;http://dubbo.apache.org/schema/dubbo&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.3.xsd http://dubbo.apache.org/schema/dubbo http://dubbo.apache.org/schema/dubbo/dubbo.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dubbo:application</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;world&quot;</span>  /&gt;</span><br>    <span class="hljs-comment">&lt;!-- 多注册中心配置 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dubbo:registry</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;chinaRegistry&quot;</span> <span class="hljs-attr">address</span>=<span class="hljs-string">&quot;10.20.141.150:9090&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dubbo:registry</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;intlRegistry&quot;</span> <span class="hljs-attr">address</span>=<span class="hljs-string">&quot;10.20.154.177:9010&quot;</span> <span class="hljs-attr">default</span>=<span class="hljs-string">&quot;false&quot;</span> /&gt;</span><br>    <span class="hljs-comment">&lt;!-- 引用中文站服务 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dubbo:reference</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;chinaHelloService&quot;</span> <span class="hljs-attr">interface</span>=<span class="hljs-string">&quot;com.alibaba.hello.api.HelloService&quot;</span> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;1.0.0&quot;</span> <span class="hljs-attr">registry</span>=<span class="hljs-string">&quot;chinaRegistry&quot;</span> /&gt;</span><br>    <span class="hljs-comment">&lt;!-- 引用国际站站服务 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dubbo:reference</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;intlHelloService&quot;</span> <span class="hljs-attr">interface</span>=<span class="hljs-string">&quot;com.alibaba.hello.api.HelloService&quot;</span> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;1.0.0&quot;</span> <span class="hljs-attr">registry</span>=<span class="hljs-string">&quot;intlRegistry&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>注解</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DubboReference(registry = &quot;chinaHelloService&quot;)</span><br>HelloService helloService;<br></code></pre></td></tr></table></figure><p>如果只是测试环境临时需要连接两个不同注册中心，使用竖号分隔多个不同注册中心地址：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:dubbo</span>=<span class="hljs-string">&quot;http://dubbo.apache.org/schema/dubbo&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.3.xsd http://dubbo.apache.org/schema/dubbo http://dubbo.apache.org/schema/dubbo/dubbo.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dubbo:application</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;world&quot;</span>  /&gt;</span><br>    <span class="hljs-comment">&lt;!-- 多注册中心配置，竖号分隔表示同时连接多个不同注册中心，同一注册中心的多个集群地址用逗号分隔 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dubbo:registry</span> <span class="hljs-attr">address</span>=<span class="hljs-string">&quot;10.20.141.150:9090|10.20.154.177:9010&quot;</span> /&gt;</span><br>    <span class="hljs-comment">&lt;!-- 引用服务 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dubbo:reference</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;helloService&quot;</span> <span class="hljs-attr">interface</span>=<span class="hljs-string">&quot;com.alibaba.hello.api.HelloService&quot;</span> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;1.0.0&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure></li></ul></blockquote><h3 id="服务分组"><a class="markdownIt-Anchor" href="#服务分组"></a> 服务分组</h3><blockquote><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/examples/service-group/">使用文档 服务分组</a></p><p><span style="border-bottom:2px dashed green">当一个接口有多种实现时，可以用 group 区分</span></p><ul><li><p>XML</p><p><strong>服务</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dubbo:service</span> <span class="hljs-attr">group</span>=<span class="hljs-string">&quot;feedback&quot;</span> <span class="hljs-attr">interface</span>=<span class="hljs-string">&quot;com.xxx.IndexService&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dubbo:service</span> <span class="hljs-attr">group</span>=<span class="hljs-string">&quot;member&quot;</span> <span class="hljs-attr">interface</span>=<span class="hljs-string">&quot;com.xxx.IndexService&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure><hr><p><strong>引用</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dubbo:reference</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;feedbackIndexService&quot;</span> <span class="hljs-attr">group</span>=<span class="hljs-string">&quot;feedback&quot;</span> <span class="hljs-attr">interface</span>=<span class="hljs-string">&quot;com.xxx.IndexService&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dubbo:reference</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;memberIndexService&quot;</span> <span class="hljs-attr">group</span>=<span class="hljs-string">&quot;member&quot;</span> <span class="hljs-attr">interface</span>=<span class="hljs-string">&quot;com.xxx.IndexService&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure><hr><p><strong>任意组</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dubbo:reference</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;barService&quot;</span> <span class="hljs-attr">interface</span>=<span class="hljs-string">&quot;com.foo.BarService&quot;</span> <span class="hljs-attr">group</span>=<span class="hljs-string">&quot;*&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure><hr></li><li><p>注解</p><p>实现一个服务，服务端使用服务分组实现加法和减法两种实现，客户端根据需要引用</p><p><strong>接口项目</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">GroupService</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-title function_">calculate</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><hr><p><strong>服务端</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DubboService(group = &quot;add&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GroupAddServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">GroupService</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">calculate</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> &#123;<br>        <span class="hljs-keyword">return</span> a + b;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DubboService(group = &quot;sub&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GroupSubServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">GroupService</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">calculate</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> &#123;<br>        <span class="hljs-keyword">return</span> a - b;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><hr><p><strong>消费端</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GroupTest</span> &#123;<br>    <span class="hljs-meta">@DubboReference(group = &quot;sub&quot;)</span><br>    GroupService groupService;<br>        <br><span class="hljs-comment">/*    @DubboReference(group = &quot;add&quot;)</span><br><span class="hljs-comment">    GroupService groupService;*/</span><br>        <br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 根据引入不同的分组实现不同的计算逻辑</span><br>        System.out.println(groupService.calculate(<span class="hljs-number">10</span>, <span class="hljs-number">5</span>));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul></blockquote><h3 id="静态服务"><a class="markdownIt-Anchor" href="#静态服务"></a> 静态服务</h3><blockquote><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/examples/static-service/">使用文档 静态服务</a></p><p><font size="5">将 Dubbo 服务标识为非动态管理模式</font></p><p>有时候希望人工管理服务提供者的上线和下线，此时需将注册中心标识为非动态管理模式，模块的上下线</p><hr><ul><li><p><strong>XML</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dubbo:registry</span> <span class="hljs-attr">address</span>=<span class="hljs-string">&quot;10.20.141.150:9090&quot;</span> <span class="hljs-attr">dynamic</span>=<span class="hljs-string">&quot;false&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure><p>或者</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dubbo:registry</span> <span class="hljs-attr">address</span>=<span class="hljs-string">&quot;10.20.141.150:9090?dynamic=false&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure><hr></li><li><p><strong>注解</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DubboService(dynamic = false)</span><br></code></pre></td></tr></table></figure></li></ul></blockquote><h3 id="多版本"><a class="markdownIt-Anchor" href="#多版本"></a> 多版本</h3><blockquote><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/examples/multi-versions/">使用文档 多版本</a></p><p><font size="5">在 Dubbo 中为同一个服务配置多个版本</font></p><p><img src="/2022/07/13/dubbo3/%E5%A4%9A%E7%89%88%E6%9C%AC.png" srcset="/img/loading.gif" lazyload alt></p><p><span style="border-bottom:2px dashed green">当一个接口实现，出现不兼容升级时，可以用版本号过渡，版本号不同的服务相互间不引用</span></p><p>可以按照以下的步骤进行版本迁移：</p><ol><li>在低压力时间段，先升级一半提供者为新版本</li><li>再将所有消费者升级为新版本</li><li>然后将剩下的一半提供者升级为新版本</li></ol><hr><p><strong>老版本服务提供者配置</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DubboService(version = &quot;1.0.0&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VersionServerImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">VersionServer</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">version</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;1.0.0&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>新版本服务提供者配置</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DubboService(version = &quot;2.0.0&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VersionServerImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">VersionServer</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">version</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;2.0.0&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><hr><p><strong>老版本服务消费者配置</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DubboReference(version = &quot;1.0.0&quot;)</span><br>VersionServer versionServer;<br></code></pre></td></tr></table></figure><p><strong>新版本服务消费者配置</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DubboReference(version = &quot;2.0.0&quot;)</span><br>VersionServer versionServer;<br></code></pre></td></tr></table></figure><hr><p><strong>如果不需要区分版本，可以按照以下的方式配置</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DubboReference(version = &quot;*&quot;)</span><br>VersionServer versionServer;<br></code></pre></td></tr></table></figure></blockquote><h3 id="分组聚合"><a class="markdownIt-Anchor" href="#分组聚合"></a> 分组聚合</h3><blockquote><ul><li><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/examples/group-merger/">使用文档 分组聚合</a></li><li><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/blog/2018/10/27/dubbo%E6%9C%8D%E5%8A%A1%E5%88%86%E7%BB%84%E5%92%8C%E7%89%88%E6%9C%AC%E8%81%9A%E5%90%88/">实现原理</a></li></ul><p><font size="5">通过分组对结果进行聚合并返回聚合后的结果</font></p><p>分组合并可以指定 <code>服务级别</code> <code>方法级别</code> <code>指定方法合并</code> <code>指定方法不合并</code>，<span style="border-bottom:2px dashed green">需要合并的方法返回值必须是个 <code>集合</code></span></p><p>通过分组对结果进行聚合并返回聚合后的结果，比如菜单服务，用group区分同一接口的多种实现，现在消费方需从每种group中调用一次并返回结果，对结果进行合并之后返回，这样就可以实现聚合菜单项</p><hr><p><strong>接口项目</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">GroupMergerService</span> &#123;<br>    <span class="hljs-comment">// A模块菜单</span><br>    List&lt;String&gt; <span class="hljs-title function_">menuA</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-comment">// B模块菜单</span><br>    String <span class="hljs-title function_">menuB</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><hr><p><strong>服务端</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DubboService(group = &quot;user&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GroupMergerServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">GroupMergerService</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">menuA</span><span class="hljs-params">()</span> &#123;<br>        List&lt;String&gt; menus = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        menus.add(<span class="hljs-string">&quot;user.1&quot;</span>);<br>        menus.add(<span class="hljs-string">&quot;user.2&quot;</span>);<br>        <span class="hljs-keyword">return</span> menus;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">menuB</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;user&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DubboService(group = &quot;order&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GroupMergerServiceImpl2</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">GroupMergerService</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">menuA</span><span class="hljs-params">()</span> &#123;<br>        List&lt;String&gt; menus = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        menus.add(<span class="hljs-string">&quot;order.1&quot;</span>);<br>        menus.add(<span class="hljs-string">&quot;order.2&quot;</span>);<br>        <span class="hljs-keyword">return</span> menus;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">menuB</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;order&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><hr><p><strong>消费端</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GroupMergerTest</span> &#123;<br>    <span class="hljs-meta">@DubboReference(group = &quot;*&quot;, merger = &quot;true&quot;)</span><br>    GroupMergerService groupMergerService;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// user.1</span><br>        <span class="hljs-comment">// user.2</span><br>        <span class="hljs-comment">// order.1</span><br>        <span class="hljs-comment">// order.2</span><br>        List&lt;String&gt; menuList = groupMergerService.menuA();<br>        menuList.forEach(line -&gt; log.info(line));<br><br>        <span class="hljs-comment">// 报错 There is no merger to merge result (返回值需要集合)</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> groupMergerService.menuB();<br>        System.out.println(s);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></blockquote><h3 id="参数验证"><a class="markdownIt-Anchor" href="#参数验证"></a> 参数验证</h3><blockquote><ul><li><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/examples/parameter-validation/">使用文档 参数验证</a></p></li><li><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/dev/impls/filter/">扩展文档 调用拦截扩展</a></p></li><li><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/dev/impls/validation/">扩展文档 验证扩展</a></p></li></ul><p><font size="5">在 Dubbo 中进行参数验证</font></p><p>参数验证功能是基于 <a target="_blank" rel="noopener" href="https://jcp.org/en/jsr/detail?id=303">JSR303</a> 实现的，用户只需标识 JSR303 标准的验证 annotation，并通过声明 filter 来实现验证, <span style="border-bottom:2px dashed green">验证逻辑建议放在消费端，这能能够在验证异常后不进行RPC调用</span></p><hr><p><strong>接口项目</strong></p><p>添加 maven 依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-validation<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>通用返回实体</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@Accessors(chain = true)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">R</span>&lt;T&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">private</span> Integer code;<br>    <span class="hljs-keyword">private</span> T data;<br>    <span class="hljs-keyword">private</span> String message;<br>&#125;<br></code></pre></td></tr></table></figure><p>实体对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@Accessors(chain = true)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-meta">@Min(value = 0, message = &quot;最小值要大于0&quot;)</span><br>    <span class="hljs-meta">@Max(value = 1000, message = &quot;最大值不能超过1000&quot;)</span><br>    <span class="hljs-keyword">private</span> Integer id;<br><br>    <span class="hljs-meta">@NotNull(message = &quot;name 不能为空&quot;)</span><br>    <span class="hljs-keyword">private</span> String name;<br>&#125;<br></code></pre></td></tr></table></figure><p>服务接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ValidationService</span> &#123;<br>    R&lt;Void&gt; <span class="hljs-title function_">addUser</span><span class="hljs-params">(User user)</span>;<br><br>    R&lt;Void&gt; <span class="hljs-title function_">select</span><span class="hljs-params">(<span class="hljs-meta">@NotNull(message = &quot;id 不能为空&quot;)</span> Integer id)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><hr><p><strong>服务端</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DubboService</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ValidationServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ValidationService</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> R&lt;Void&gt; <span class="hljs-title function_">addUser</span><span class="hljs-params">(User user)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">R</span>().setCode(<span class="hljs-number">200</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> R&lt;Void&gt; <span class="hljs-title function_">select</span><span class="hljs-params">(Integer id)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">R</span>().setCode(<span class="hljs-number">200</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><hr><p><strong>消费端</strong></p><p><strong>验证扩展 参数校验器</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span>: ken 😃</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span>: 2022-07-22</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span>: 参数校验器</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * 首先编写自定义的校验器。实现Validation接口。再编写自己的校验者</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ParamValidation</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">JValidation</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Validator <span class="hljs-title function_">getValidator</span><span class="hljs-params">(URL url)</span> &#123;<br>        <span class="hljs-comment">// 自定义校验者</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ParamValidator</span>(url);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>参数校验者</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span>: ken 😃</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span>: 2022-07-22</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span>: 参数校验者 拷贝 org.apache.dubbo.validation.support.jvalidation.JValidator </span><br><span class="hljs-comment"> **/</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ParamValidator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Validator</span> &#123;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">validate</span><span class="hljs-params">(String methodName, Class&lt;?&gt;[] parameterTypes, Object[] arguments)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>		...<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-comment">// 修改点</span><br>            <span class="hljs-comment">// 如果是 ConstraintViolationException 直接返回，3.0.9会重新封装成 ValidationException</span><br>            <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> ConstraintViolationException) &#123;<br>                <span class="hljs-keyword">throw</span> e;<br>            &#125;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ValidationException</span>(e.getMessage());<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>扩展验证拦截器</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span>: ken 😃</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span>: 2022-07-22</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span>: 参考 org.apache.dubbo.validation.filter.ValidationFilter </span><br><span class="hljs-comment"> **/</span><br><span class="hljs-meta">@Activate(group = &#123;CONSUMER, PROVIDER&#125;, value = VALIDATION_KEY, order = 10000)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DubboValidationFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> &#123;<br>    <span class="hljs-keyword">private</span> Validation validation;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValidation</span><span class="hljs-params">(Validation validation)</span> &#123;<br>        <span class="hljs-built_in">this</span>.validation = validation;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">invoke</span><span class="hljs-params">(Invoker&lt;?&gt; invoker, Invocation invocation)</span> <span class="hljs-keyword">throws</span> RpcException &#123;<br>        <span class="hljs-keyword">if</span> (validation != <span class="hljs-literal">null</span> &amp;&amp; !invocation.getMethodName().startsWith(<span class="hljs-string">&quot;$&quot;</span>)<br>                &amp;&amp; ConfigUtils.isNotEmpty(invoker.getUrl().getMethodParameter(invocation.getMethodName(), VALIDATION_KEY))) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">Validator</span> <span class="hljs-variable">validator</span> <span class="hljs-operator">=</span> validation.getValidator(invoker.getUrl());<br>                <span class="hljs-keyword">if</span> (validator != <span class="hljs-literal">null</span>) &#123;<br>                    validator.validate(invocation.getMethodName(), invocation.getParameterTypes(), invocation.getArguments());<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (ConstraintViolationException e) &#123;<br>                <span class="hljs-comment">// 处理参数校验异常 返回通用 VO</span><br>                ConstraintViolation&lt;?&gt; constraintViolation = e.getConstraintViolations().stream().findFirst().get();<br>                <span class="hljs-type">R</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">R</span>()<br>                        .setCode(<span class="hljs-number">1000</span>)<br>                        .setMessage(constraintViolation.getMessage());<br>                <span class="hljs-keyword">return</span> AsyncRpcResult.newDefaultAsyncResult(result, invocation);<br>            &#125; <span class="hljs-keyword">catch</span> (RpcException e) &#123;<br>                <span class="hljs-keyword">throw</span> e;<br>            &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;<br>                <span class="hljs-keyword">return</span> AsyncRpcResult.newDefaultAsyncResult(t, invocation);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> invoker.invoke(invocation);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>添加SPI配置</strong></p><ul><li><p><strong>Filter</strong></p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs 1c"><span class="hljs-string">|-resources</span><br>    <span class="hljs-string">|-META-INF</span><br>        <span class="hljs-string">|-dubbo</span><br>            <span class="hljs-string">|-org.apache.dubbo.rpc.Filter</span><br></code></pre></td></tr></table></figure><p><strong>org.apache.dubbo.rpc.Filter</strong></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">dubboValidation=com<span class="hljs-selector-class">.wgf</span><span class="hljs-selector-class">.springboot</span><span class="hljs-selector-class">.filter</span>.DubboValidationFilter<br></code></pre></td></tr></table></figure></li><li><p><strong>Validation</strong></p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs 1c"><span class="hljs-string">|-resources</span><br>    <span class="hljs-string">|-META-INF</span><br>        <span class="hljs-string">|-dubbo</span><br>            <span class="hljs-string">|-org.apache.dubbo.validation.Validation</span><br></code></pre></td></tr></table></figure><p><strong>org.apache.dubbo.validation.Validation</strong></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">paramValidation=com<span class="hljs-selector-class">.wgf</span><span class="hljs-selector-class">.springboot</span><span class="hljs-selector-class">.validation</span>.ParamValidation<br></code></pre></td></tr></table></figure></li></ul><p><strong>修改 yml 配置</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">dubbo:</span><br>  <span class="hljs-attr">consumer:</span><br>    <span class="hljs-attr">validation:</span> <span class="hljs-string">&#x27;paramValidation&#x27;</span>			<span class="hljs-comment"># 启用自定义验证</span><br>    <span class="hljs-attr">filter:</span> <span class="hljs-string">&#x27;dubboValidation, -validation&#x27;</span>	<span class="hljs-comment"># 启用自定义参数校验拦截器，禁用默认的参数校验拦截器</span><br></code></pre></td></tr></table></figure><p><strong>测试</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ValidationTest</span> &#123;<br>    <span class="hljs-meta">@DubboReference</span><br>    ValidationService validationService;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addTest</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>()<br>                .setId(<span class="hljs-number">10</span>);<br>        R&lt;Void&gt; r = validationService.addUser(user);<br>        Assertions.assertEquals(r.getCode(), <span class="hljs-number">200</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">selectTest</span><span class="hljs-params">()</span> &#123;<br>        R&lt;Void&gt; r = validationService.select(<span class="hljs-literal">null</span>);<br>        Assertions.assertEquals(r.getCode(), <span class="hljs-number">200</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><hr><p>3.0.9 版本如果需要实现验证异常后返回自定义的VO, 需要扩展 <code>JValidation</code> 和 <code>JValidator</code>, 因为 <code>ConstraintViolationException</code> 异常被 <code>JValidator</code> 捕获重新抛出 <code>ValidationException</code> , 并且需要重写 （取消默认实现用 -）<code>ValidationFilter</code>, 验证异常后返回自定义的VO</p></blockquote><h3 id="负载均衡"><a class="markdownIt-Anchor" href="#负载均衡"></a> 负载均衡</h3><blockquote><p><strong>相关文档</strong></p><ul><li><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/examples/loadbalance/">使用文档 负载均衡</a></p></li><li><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/dev/source/loadbalance/#m-zhdocsv27devsourceloadbalance">源码文档 负载均衡</a></p></li><li><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v3.0/references/spis/load-balance/#m-zhdocsv30referencesspisload-balance">参考文档 负载扩展</a></p></li></ul><p>LoadBalance 中文意思为负载均衡，它的职责是将网络请求，或者其他形式的负载“均摊”到不同的机器上。避免集群中部分服务器压力过大，而另一些服务器比较空闲的情况。通过负载均衡，可以让每台服务器获取到适合自己处理能力的负载。在为高负载服务器分流的同时，还可以避免资源浪费，一举两得</p><hr><p><strong>Random LoadBalance</strong></p><ul><li><strong>随机</strong>，按权重设置随机概率。</li><li>在一个截面上碰撞的概率高，但调用量越大分布越均匀，而且按概率使用权重后也比较均匀，有利于动态调整提供者权重。</li></ul><hr><p><strong>RoundRobin LoadBalance</strong></p><ul><li><strong>轮询</strong>，按公约后的权重设置轮询比率。</li><li>存在慢的提供者累积请求的问题，比如：第二台机器很慢，但没挂，当请求调到第二台时就卡在那，久而久之，所有请求都卡在调到第二台上。</li></ul><hr><p><strong>LeastActive LoadBalance</strong></p><ul><li><strong>最少活跃调用数</strong>，相同活跃数的随机，活跃数指调用前后计数差。</li><li>使慢的提供者收到更少请求，因为越慢的提供者的调用前后计数差会越大</li></ul><p><strong>最少活跃数应该是在服务提供者端进行统计的，服务提供者统计有多少个请求正在执行中。但在Dubbo中，就是不讲道理，它是在消费端进行统计的，为什么能在消费端进行统计？</strong></p><ol><li>每个消费者都会从注册中心（常用的是Zookeeper）缓存所调用服务的所有提供者信息到本地，比如记为p1、p2、p3三个服务提供者，每个提供者内都有一个属性记为active，默认位0</li><li>消费者在调用服务时，如果负载均衡策略是<strong>leastactive</strong></li><li>消费者端会判断缓存的所有服务提供者的active，选择最小的，如果都相同，则随机</li><li>选出某一个服务提供者后，假设是p2，Dubbo就会对p2.active+1</li><li>然后真正发出请求调用该服务</li><li>消费端收到响应结果后，对p2.active-1</li><li>这样就完成了对某个服务提供者当前活跃调用数进行了统计，并且并不影响服务调用的性能</li><li>如果由服务提供者来统计调用数反而不好统计，因为服务提供者有多个，你无法确定是哪个服务提供者统计调用数，除非你放到zookeeper这种分布式共享的数据中心，但是这样的话，每个消费者都要请求zookeeper找到需要调用的那一台服务提供者机器然后加1，在调用结束后，还要在zookeeper上进行减1操作，zookeeper明显扛不住。</li><li>由服务消费者来统计调用数的话，虽然每个消费者都有自己的一套调用数数据，调用数数据可能不一样，但是经过长时间的调用后，每个消费者自己本地存的调用数据还是能够有差不多的趋势（这里的趋势不是指数据相等）。比如说p2响应很慢，堆积了很多请求，那么每个消费者在请求多次后，短时间内都不会再请求p2</li></ol><p><span style="border-bottom:2px dashed green"><strong>总结</strong>：如果由服务提供者来统计调用次数，那么就需要共享每个服务接口的调用次数，不管是使用那种共享中间件都会有额外的开销。最节省性能的算法是在服务消费者端的jvm内存维护一份本地的服务调用次数表，再选择空闲服务调用，这样可以避免数据共享的复杂性</span></p><hr><p><strong>ConsistentHash LoadBalance</strong></p><ul><li><strong>一致性 Hash</strong>，相同参数的请求总是发到同一提供者。</li><li>当某一台提供者挂时，原本发往该提供者的请求，基于虚拟节点，平摊到其它提供者，不会引起剧烈变动。</li><li>算法参见：<a target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/Consistent_hashing">http://en.wikipedia.org/wiki/Consistent_hashing</a></li><li>缺省只对第一个参数 Hash，如果要修改，请配置 <code>&lt;dubbo:parameter key=&quot;hash.arguments&quot; value=&quot;0,1&quot; /&gt;</code></li><li>缺省用 160 份虚拟节点，如果要修改，请配置 <code>&lt;dubbo:parameter key=&quot;hash.nodes&quot; value=&quot;320&quot; /&gt;</code></li></ul><hr><p><strong>配置</strong></p><p><strong>服务端</strong></p><ul><li><p>XML</p><ul><li><p>服务级别</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dubbo:service</span> <span class="hljs-attr">interface</span>=<span class="hljs-string">&quot;...&quot;</span> <span class="hljs-attr">loadbalance</span>=<span class="hljs-string">&quot;roundrobin&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>方法级别</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dubbo:service</span> <span class="hljs-attr">interface</span>=<span class="hljs-string">&quot;...&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dubbo:method</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;hello&quot;</span> <span class="hljs-attr">loadbalance</span>=<span class="hljs-string">&quot;roundrobin&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dubbo:service</span>&gt;</span><br></code></pre></td></tr></table></figure></li></ul></li><li><p>注解</p><ul><li><p>服务级别</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DubboService(loadbalance = &quot;roundrobin&quot;)</span><br></code></pre></td></tr></table></figure></li><li><p>方法级别</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DubboService(methods = &#123;</span><br><span class="hljs-meta">        @Method(name = &quot;...&quot;, loadbalance = &quot;roundrobin&quot;)</span><br><span class="hljs-meta">&#125;)</span><br></code></pre></td></tr></table></figure></li></ul></li></ul><p><strong>客户端</strong></p><ul><li><p>XML</p><ul><li><p>服务级别</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dubbo:reference</span> <span class="hljs-attr">interface</span>=<span class="hljs-string">&quot;...&quot;</span> <span class="hljs-attr">loadbalance</span>=<span class="hljs-string">&quot;roundrobin&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>方法级别</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dubbo:reference</span> <span class="hljs-attr">interface</span>=<span class="hljs-string">&quot;...&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dubbo:method</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;...&quot;</span> <span class="hljs-attr">loadbalance</span>=<span class="hljs-string">&quot;roundrobin&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dubbo:reference</span>&gt;</span><br></code></pre></td></tr></table></figure></li></ul></li><li><p>注解</p><ul><li><p>服务级别</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-meta">@DubboReference(loadbalance = <span class="hljs-string">&quot;roundrobin&quot;</span>)</span><br></code></pre></td></tr></table></figure></li><li><p>方法级别</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DubboReference(methods = &#123;</span><br><span class="hljs-meta">  @Method(name = &quot;...&quot;, loadbalance = &quot;roundrobin&quot;)</span><br><span class="hljs-meta">&#125;)</span><br></code></pre></td></tr></table></figure></li></ul></li><li><p>yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">dubbo:</span><br>  <span class="hljs-attr">provider:</span><br>      <span class="hljs-attr">loadbalance:</span> <span class="hljs-string">roundrobin</span><br></code></pre></td></tr></table></figure></li></ul><p><strong>官方已提供扩展</strong></p><ul><li><code>org.apache.dubbo.rpc.cluster.loadbalance.RandomLoadBalance</code></li><li><code>org.apache.dubbo.rpc.cluster.loadbalance.RoundRobinLoadBalance</code></li><li><code>org.apache.dubbo.rpc.cluster.loadbalance.LeastActiveLoadBalance</code></li><li><code>org.apache.dubbo.rpc.cluster.loadbalance.ConsistentHashLoadBalance</code></li></ul><p><strong>可取值：</strong> <code>random</code> <code>roundrobin</code> <code>leastactive</code> <code>consistenthash</code></p><p>在集群负载均衡时，Dubbo 提供了多种均衡策略，<strong>缺省为 <code>random</code> 随机调用</strong></p><hr><p><span style="border-bottom:2px dashed green">如果在<strong>消费端</strong>和<strong>服务端</strong>都配置了负载均衡策略，<strong>以消费端为准</strong></span></p><p><span style="border-bottom:2px dashed green">如果在<strong>服务级别</strong>和<strong>方法级别</strong>都配置了负载均衡策略，<strong>以方法级别为准</strong>，遵循配置就近原则</span></p></blockquote><h3 id="服务超时"><a class="markdownIt-Anchor" href="#服务超时"></a> 服务超时</h3><blockquote><p>默认超时时间：1000ms</p><p>超时会触发<a href="#%E6%9C%8D%E5%8A%A1%E9%87%8D%E8%AF%95">重试机制</a>：默认重试两次，不包含第一次</p><p><span style="border-bottom:2px dashed green">在服务提供者和服务消费者上都可以配置服务超时时间，这两者是不一样的</span></p><p><strong>服务端</strong></p><table><thead><tr><th style="text-align:left">服务级别 xml</th><th style="text-align:left">&lt;dubbo:service interface=“…” timeout=“4000” /&gt;</th></tr></thead><tbody><tr><td style="text-align:left"><strong>方法级别 xml</strong></td><td style="text-align:left"><strong>&lt;dubbo:service interface=“…”&gt;<br>&lt;dubbo:method name=“…” loadbalance=“roundrobin”/&gt;<br>&lt;/dubbo:reference&gt;</strong></td></tr><tr><td style="text-align:left"><strong>服务级别 注解</strong></td><td style="text-align:left"><strong>@DubboService(timeout = 3000)</strong></td></tr><tr><td style="text-align:left"><strong>方法级别 注解</strong></td><td style="text-align:left"><strong>@DubboService(methods = {<br>@Method(name = “methodTimeout”, timeout = 5000)<br>})</strong></td></tr></tbody></table><hr><p><strong>消费端</strong></p><table><thead><tr><th style="text-align:left">服务级别 xml</th><th style="text-align:left">&lt;dubbo:reference interface=“…” timeout=“4000” /&gt;</th></tr></thead><tbody><tr><td style="text-align:left"><strong>方法级别 xml</strong></td><td style="text-align:left"><strong>&lt;dubbo:reference interface=“…”&gt;<br>&lt;dubbo:method name=“…” loadbalance=“roundrobin”/&gt;<br>&lt;/dubbo:reference&gt;</strong></td></tr><tr><td style="text-align:left"><strong>服务级别 注解</strong></td><td style="text-align:left"><strong>@DubboReference(timeout = 3000)</strong></td></tr><tr><td style="text-align:left"><strong>方法级别 注解</strong></td><td style="text-align:left"><strong>@DubboReference(methods = {<br>@Method(name = “xxx”, timeout = 5000)<br>})</strong></td></tr><tr><td style="text-align:left"><strong>全局配置 xml</strong></td><td style="text-align:left"><strong>&lt;dubbo:provider timeout=“5000”/&gt;</strong></td></tr></tbody></table><hr><p><strong>yml</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 按服务配置</span><br><span class="hljs-attr">dubbo:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">xxx:</span><br>      <span class="hljs-attr">timeout:</span> <span class="hljs-number">3000</span><br>			<br><span class="hljs-comment"># 全局配置</span><br><span class="hljs-attr">dubbo:</span><br>  <span class="hljs-attr">provider:</span><br>    <span class="hljs-attr">timeout:</span> <span class="hljs-number">3000</span><br></code></pre></td></tr></table></figure><p><strong>消费者调用一个服务，分为三步：</strong></p></blockquote><pre class="mermaid">sequenceDiagram
	消费端 ->> 服务端 : 1. 消费者发送请求（网络传输）
	服务端 ->> 服务端 : 2. 执行逻辑
	服务端 ->> 消费端 : 3. 服务端返回响应（网络请求）</pre><blockquote><blockquote><p><strong>如果在服务端和消费端只在其中一方配置了 <code>timeout</code>，那么没有歧义，表示消费端调用服务的超时时间</strong>，<strong>消费端如果超过时间还没有收到响应结果，则消费端会抛超时异常</strong>。但服务端不会抛异常，服务端在执行服务后，会检查<strong>执行该服务</strong>的时间，如果超过timeout，则会打印一个<strong>超时日志</strong>。服务会正常的执行完</p></blockquote><p><strong>如果在服务端和消费端各配了一个timeout，那就比较复杂了，假设</strong></p><ol><li>服务执行为2s</li><li>消费端timeout=1s</li><li>服务端timeout=3s</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 服务端</span><br><span class="hljs-meta">@DubboService(timeout = 3000)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TimeOutServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">TimeOutService</span> &#123;<br>...<br>&#125;<br><br><span class="hljs-comment">// 消费端</span><br><span class="hljs-meta">@DubboReference(timeout = 1000)</span><br>TimeOutService timeOutService;<br></code></pre></td></tr></table></figure><ul><li><span style="border-bottom:2px dashed green">那么消费端调用服务时，消费端会收到超时异常（因为消费端超时了），服务端一切正常（服务端没有超时），实际服务端正常执行业务流程</span></li><li><span style="border-bottom:2px dashed green">无论何种情况，服务端的timeout配置的作用是：<strong>如果服务执行时间超过这个timeout，仅仅只是打印一个超时日志</strong></span></li></ul></blockquote><h3 id="provider超时打断"><a class="markdownIt-Anchor" href="#provider超时打断"></a> provider超时打断</h3><blockquote><p><font size="5">Dubbo provider执行超时释放执行线程</font></p><p>支持provider根据超时时间进行业务打断</p><p>适用场景：对于一个provider，如果某个操作执行超时，则打断(释放)该执行线程，而不是仅仅打印超时日志</p><blockquote><p><strong>提示</strong></p><p>支持版本：<code>2.7.12</code> 之后版本，<code>3.0.x</code> 暂不支持</p><p>核心实现类 <code>org.apache.dubbo.remoting.transport.dispatcher.all2.AllChannelHandler2</code></p></blockquote><p><strong>接口项目</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">TimeoutReleaseService</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">hello</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><hr><p><strong>服务端</strong></p><p>yml配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">dubbo:</span><br>  <span class="hljs-attr">protocol:</span><br>    <span class="hljs-attr">dispatcher:</span> <span class="hljs-string">all2</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@DubboService(timeout = 1000, retries = 0)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TimeoutReleaseServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">TimeoutReleaseService</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> &#123;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>                TimeUnit.MILLISECONDS.sleep(<span class="hljs-number">200</span>);<br>                log.info(i + <span class="hljs-string">&quot;&quot;</span>);<br>            &#125;<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            log.error(<span class="hljs-string">&quot;线程被打断&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><hr><p><strong>消费端</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TimeoutReleaseTest</span> &#123;<br>    <span class="hljs-meta">@DubboReference</span><br>    TimeoutReleaseService timeoutReleaseService;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>        timeoutReleaseService.hello();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>运行结果，服务端超时</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-number">2022</span>-<span class="hljs-number">07</span>-<span class="hljs-number">23</span> <span class="hljs-number">16</span>:<span class="hljs-number">21</span>:<span class="hljs-number">56.977</span>  INFO <span class="hljs-number">3344</span> --- <span class="hljs-selector-attr">[:20880-thread-2]</span> c<span class="hljs-selector-class">.w</span><span class="hljs-selector-class">.s</span><span class="hljs-selector-class">.p</span><span class="hljs-selector-class">.TimeoutReleaseServiceImpl</span>        : <span class="hljs-number">0</span><br><span class="hljs-number">2022</span>-<span class="hljs-number">07</span>-<span class="hljs-number">23</span> <span class="hljs-number">16</span>:<span class="hljs-number">21</span>:<span class="hljs-number">57.180</span>  INFO <span class="hljs-number">3344</span> --- <span class="hljs-selector-attr">[:20880-thread-2]</span> c<span class="hljs-selector-class">.w</span><span class="hljs-selector-class">.s</span><span class="hljs-selector-class">.p</span><span class="hljs-selector-class">.TimeoutReleaseServiceImpl</span>        : <span class="hljs-number">1</span><br><span class="hljs-number">2022</span>-<span class="hljs-number">07</span>-<span class="hljs-number">23</span> <span class="hljs-number">16</span>:<span class="hljs-number">21</span>:<span class="hljs-number">57.383</span>  INFO <span class="hljs-number">3344</span> --- <span class="hljs-selector-attr">[:20880-thread-2]</span> c<span class="hljs-selector-class">.w</span><span class="hljs-selector-class">.s</span><span class="hljs-selector-class">.p</span><span class="hljs-selector-class">.TimeoutReleaseServiceImpl</span>        : <span class="hljs-number">2</span><br><span class="hljs-number">2022</span>-<span class="hljs-number">07</span>-<span class="hljs-number">23</span> <span class="hljs-number">16</span>:<span class="hljs-number">21</span>:<span class="hljs-number">57.586</span>  INFO <span class="hljs-number">3344</span> --- <span class="hljs-selector-attr">[:20880-thread-2]</span> c<span class="hljs-selector-class">.w</span><span class="hljs-selector-class">.s</span><span class="hljs-selector-class">.p</span><span class="hljs-selector-class">.TimeoutReleaseServiceImpl</span>        : <span class="hljs-number">3</span><br><span class="hljs-number">2022</span>-<span class="hljs-number">07</span>-<span class="hljs-number">23</span> <span class="hljs-number">16</span>:<span class="hljs-number">21</span>:<span class="hljs-number">57.790</span>  INFO <span class="hljs-number">3344</span> --- <span class="hljs-selector-attr">[:20880-thread-2]</span> c<span class="hljs-selector-class">.w</span><span class="hljs-selector-class">.s</span><span class="hljs-selector-class">.p</span><span class="hljs-selector-class">.TimeoutReleaseServiceImpl</span>        : <span class="hljs-number">4</span><br><span class="hljs-number">2022</span>-<span class="hljs-number">07</span>-<span class="hljs-number">23</span> <span class="hljs-number">16</span>:<span class="hljs-number">21</span>:<span class="hljs-number">57.868</span> ERROR <span class="hljs-number">3344</span> --- <span class="hljs-selector-attr">[:20880-thread-2]</span> c<span class="hljs-selector-class">.w</span><span class="hljs-selector-class">.s</span><span class="hljs-selector-class">.p</span><span class="hljs-selector-class">.TimeoutReleaseServiceImpl</span>        : 线程被打断<br></code></pre></td></tr></table></figure></blockquote><h3 id="服务重试"><a class="markdownIt-Anchor" href="#服务重试"></a> 服务重试</h3><blockquote><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/examples/%E9%87%8D%E8%AF%95%E6%AC%A1%E6%95%B0%E9%85%8D%E7%BD%AE/">使用文档 重试次数配置</a></p><p>超时和重试一般情况下是成对配置的</p><p><span style="border-bottom:2px dashed green">Dubbo 服务在尝试调用一次之后，如出现非业务异常(服务突然不可用、超时等)，Dubbo 默认会进行额外的最多2次重试</span></p><p><strong>服务端</strong></p><p><font color="red">目前 3.0.9 版本使用注解 <code>@DubboService(timeout = 3000, retries = 1)</code> 重试次数不生效，只有客户端配置才生效，原因是服务端注册时注册URL没有加上注解的重试配置</font></p><table><thead><tr><th style="text-align:left">服务级别 xml</th><th style="text-align:left">&lt;dubbo:service interface=“…” timeout=“4000” retries=“2”/&gt;</th></tr></thead><tbody><tr><td style="text-align:left"><strong>方法级别 xml</strong></td><td style="text-align:left"><strong>&lt;dubbo:service interface=“…”&gt;<br>&lt;dubbo:method name=&quot;…&quot;timeout=“4000” retries=“2”/&gt;<br>&lt;/dubbo:service&gt;</strong></td></tr><tr><td style="text-align:left"><strong>服务级别 注解</strong></td><td style="text-align:left"><strong>@DubboService(timeout = 3000, retries = 2) 3.0.9 不生效</strong></td></tr><tr><td style="text-align:left"><strong>方法级别 注解</strong></td><td style="text-align:left"><strong>@DubboService(methods = {<br>@Method(name = “globalTimeout”, timeout = 3000, retries = 0)<br>}) 3.0.9 不生效</strong></td></tr></tbody></table><hr><p><strong>客户端</strong></p><table><thead><tr><th style="text-align:left"><strong>服务级别 xml</strong></th><th style="text-align:left">&lt;dubbo:reference interface=“…” timeout=“4000” retries=“2”/&gt;</th></tr></thead><tbody><tr><td style="text-align:left"><strong>方法级别 xml</strong></td><td style="text-align:left"><strong>&lt;dubbo:reference interface=“…”&gt;<br>&lt;dubbo:method name=&quot;…&quot;timeout=“4000” retries=“2”/&gt;<br>&lt;/dubbo:reference&gt;</strong></td></tr><tr><td style="text-align:left"><strong>服务级别 注解</strong></td><td style="text-align:left"><strong>@DubboReference(timeout = 2000, retries = 2)</strong></td></tr><tr><td style="text-align:left"><strong>方法级别 注解</strong></td><td style="text-align:left"><strong>@DubboReference(methods = {<br>@Method(name = “…”, timeout = 2000, retries = 2)}<br>)</strong></td></tr></tbody></table><hr><p><strong>yml</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 客户端全局配置</span><br><span class="hljs-attr">dubbo:</span><br>  <span class="hljs-attr">consumer:</span><br>    <span class="hljs-attr">retries:</span> <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure></blockquote><h3 id="集群容错"><a class="markdownIt-Anchor" href="#集群容错"></a> 集群容错</h3><blockquote><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/examples/fault-tolerent-strategy/">使用文档 集群容错</a></p><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/dev/impls/cluster/">扩展文档 集群扩展</a></p><p><font color="red">目前 3.0.9 版本在服务端配置不生效，消费端正常</font></p><p><strong>集群容错表示</strong>：<span style="border-bottom:2px dashed green">服务消费者在调用某个服务时，这个服务有多个服务提供者，在经过负载均衡后选出其中一个服务提供者之后进行调用，但调用报错后，Dubbo所采取的后续处理策略。</span></p><p><strong>集群容错模式</strong></p><ul><li><p><strong>Failover Cluster (默认)</strong></p></li><li><p><strong>取值：failover</strong></p><p>失败自动切换，当出现失败，重试其它服务器。通常用于读操作，但重试会带来更长延迟。<strong>可通过 <code>retries=&quot;2&quot;</code> 来设置重试次数(不含第一次)</strong></p><hr></li><li><p><strong>Failfast Cluster</strong></p></li><li><p><strong>取值：failfast</strong></p><p>快速失败，只发起一次调用，失败立即报错。<strong>通常用于非幂等性的写操作，比如新增记录</strong></p><hr></li><li><p><strong>Failsafe Cluster</strong></p></li><li><p><strong>取值：failsafe</strong></p><p>失败安全，出现异常时，直接忽略。<strong>通常用于写入审计日志等操作</strong></p><hr></li><li><p><strong>Failback Cluster</strong></p></li><li><p><strong>取值：failback</strong></p><p>失败自动恢复，后台记录失败请求，定时重发。<strong>通常用于消息通知操作</strong></p><hr></li><li><p><strong>Forking Cluster</strong></p></li><li><p><strong>取值：forking</strong></p><p>并行调用多个服务器，只要一个成功即返回。<strong>通常用于实时性要求较高的读操作，但需要浪费更多服务资源。可通过 <code>forks=&quot;2&quot;</code> 来设置最大并行数</strong></p><hr></li><li><p><strong>Broadcast Cluster</strong></p></li><li><p><strong>取值：broadcast</strong></p><p>广播调用所有提供者，<strong>逐个调用，任意一台报错则报错。通常用于通知所有提供者更新缓存或日志等本地资源信息</strong></p><p>现在广播调用中，可以通过 broadcast.fail.percent 配置节点调用失败的比例，当达到这个比例后，BroadcastClusterInvoker 将不再调用其他节点，直接抛出异常。 broadcast.fail.percent 取值在 0～100 范围内。默认情况下当全部调用失败后，才会抛出异常。 broadcast.fail.percent 只是控制的当失败后是否继续调用其他节点，并不改变结果(任意一台报错则报错)。broadcast.fail.percent 参数 在 dubbo2.7.10 及以上版本生效</p><p>Broadcast Cluster 配置 broadcast.fail.percent</p><p>broadcast.fail.percent=20 代表了当 20% 的节点调用失败就抛出异常，不再调用其他节点</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DubboReference(cluster = &quot;broadcast&quot;, parameters = &#123;&quot;broadcast.fail.percent&quot;, &quot;20&quot;&#125;)</span><br></code></pre></td></tr></table></figure></li></ul><hr><p><strong>yml</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 客户端全局配置</span><br><span class="hljs-attr">dubbo:</span><br>  <span class="hljs-attr">consumer:</span><br>    <span class="hljs-attr">cluster:</span> <span class="hljs-string">failfast</span><br></code></pre></td></tr></table></figure><p><strong>客户端的服务级别配置</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DubboReference(cluster = &quot;forking&quot;)</span><br></code></pre></td></tr></table></figure></blockquote><h3 id="服务降级"><a class="markdownIt-Anchor" href="#服务降级"></a> 服务降级</h3><blockquote><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/examples/service-downgrade/">使用文档 服务降级</a></p><p>更复杂的服务降级参考 <a href="#%E6%9C%AC%E5%9C%B0%E4%BC%AA%E8%A3%85">本地伪装</a></p><ul><li><p>服务降级表示：服务消费者在调用某个服务提供者时，如果该服务提供者报错了，所采取的备选措施</p></li><li><p>集群容错和服务降级的区别在于：</p><ul><li>集群容错是整个集群范围内的容错</li><li>服务降级是单个服务提供者的自身容错</li></ul></li></ul><p><strong>用法</strong></p><ul><li><p><span style="border-bottom:2px dashed green"><code>mock=force:return+null</code> 表示消费方对该服务的方法调用都直接返回 null 值，不发起远程调用。</span>用来屏蔽不重要服务不可用时对调用方的影响</p></li><li><p><span style="border-bottom:2px dashed green"><code>mock=fail:return+null</code> 表示消费方对该服务的方法调用在失败后，再返回 null 值，不抛异常。</span>用来容忍不重要服务不稳定时对调用方的影响</p></li></ul><hr><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DubboReference(mock = &quot;force:return 123&quot;)</span><br></code></pre></td></tr></table></figure><p>不发起远程调用，直接返回 <code>mork</code> 的值</p><hr><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DubboReference(timeout = 1000, mock = &quot;fail: return 123&quot;)</span><br></code></pre></td></tr></table></figure><p>尝试远程调用，如果超时则返回 <code>mork</code> 的值</p><p><strong>注意</strong></p><ul><li>如果服务调用超时会返回 <code>mork</code> 的值，但是服务端默认会被调用三次，因为默认的 <a href="#%E9%9B%86%E7%BE%A4%E5%AE%B9%E9%94%99">集群容错</a> 是 <code>failover</code></li><li><span style="border-bottom:2px dashed green">如果服务端抛出异常会将异常传递到消费端，而不是返回 <code>mork</code> 的值</span></li></ul></blockquote><h3 id="指定ip"><a class="markdownIt-Anchor" href="#指定ip"></a> 指定IP</h3><blockquote><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/examples/invoke-with-specified-ip/">使用文档 指定IP</a></p><blockquote><p><strong>提示</strong></p><p>支持版本：<code>2.7.12</code> 之后, <code>3.0.x</code> 暂不支持</p></blockquote><p><font size="5">对于Provider集群中注册的多个实例，指定Ip:Port进行调用</font></p><p><span style="border-bottom:2px dashed green">当多个Provider注册到注册中心时，可以通过在RpcContext中动态的指定其中一个实例的Ip，Port进行Dubbo调用</span></p><hr><p><strong>接口项目</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SpecifiedIpService</span> &#123;<br>    String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><hr><p><strong>服务 1</strong></p><ul><li>ip 192.168.1.106</li><li>port 20880</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DubboService</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpecifiedIpServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SpecifiedIpService</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;i am provider&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>服务 2</strong></p><ul><li>ip 192.168.1.106</li><li>port 20881</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DubboService</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpecifiedIpServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SpecifiedIpService</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;i am provider2&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><hr><p><strong>消费端</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpecifiedIpTest</span> &#123;<br>    <span class="hljs-meta">@DubboReference(parameters = &#123;&quot;router&quot;,&quot;address&quot;&#125;)</span><br>    SpecifiedIpService specifiedIpService;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 根据provider的ip,port创建Address实例</span><br>        <span class="hljs-type">Address</span> <span class="hljs-variable">address</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Address</span>(<span class="hljs-string">&quot;192.168.1.106&quot;</span>, <span class="hljs-number">20880</span>);<br>        RpcContext.getContext().setObjectAttachment(<span class="hljs-string">&quot;address&quot;</span>, address);<br>        log.info(specifiedIpService.hello());<br><br>        address = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Address</span>(<span class="hljs-string">&quot;192.168.1.106&quot;</span>, <span class="hljs-number">20881</span>);<br>        RpcContext.getContext().setObjectAttachment(<span class="hljs-string">&quot;address&quot;</span>, address);<br>        log.info(specifiedIpService.hello());<br>    &#125;<br>&#125;<br><br><span class="hljs-number">2022</span>-<span class="hljs-number">07</span>-<span class="hljs-number">23</span> <span class="hljs-number">16</span>:<span class="hljs-number">46</span>:<span class="hljs-number">14.352</span>  INFO <span class="hljs-number">3988</span> --- [           main] com.wgf.springboot.SpecifiedIpTest       : i am provider<br><span class="hljs-number">2022</span>-<span class="hljs-number">07</span>-<span class="hljs-number">23</span> <span class="hljs-number">16</span>:<span class="hljs-number">46</span>:<span class="hljs-number">14.431</span>  INFO <span class="hljs-number">3988</span> --- [           main] com.wgf.springboot.SpecifiedIpTest       : i am provider2<br></code></pre></td></tr></table></figure></blockquote><h3 id="收集广播响应"><a class="markdownIt-Anchor" href="#收集广播响应"></a> 收集广播响应</h3><blockquote><p><font size="5">Dubbo broadcast2 广播模式收集所有服务提供者的接口响应</font></p><p><span style="border-bottom:2px dashed green">适用场景：对于一个dubbo消费者，广播调用多个dubbo 提供者，该消费者可以收集所有服务提供者的响应结果</span></p><blockquote><p><strong>提示</strong></p><p>支持版本：<code>2.7.12</code> 后，<code>3.0.x</code> 无效</p></blockquote><hr><p><strong>接口项目</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BroadcastService</span> &#123;<br>    String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><hr><p><strong>服务端 1</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DubboService</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BroadcastServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BroadcastService</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>服务端 2</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DubboService</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BroadcastServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BroadcastService</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span> / <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><hr><p><strong>消费端</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BroadcastTest</span> &#123;<br>    <span class="hljs-meta">@DubboReference(cluster = &quot;broadcast2&quot;)</span><br>    BroadcastService broadcastService;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span>&#123;<br>            broadcastService.hello();<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            Map&lt;String, String&gt; m = RpcContext.getServerContext().getAttachments();<br>            log.info(m.toString()+<span class="hljs-string">&quot;|&quot;</span>+<span class="hljs-string">&quot;fail&quot;</span>);<br>        &#125;<br>        Map&lt;String, String&gt; m = RpcContext.getServerContext().getAttachments();<br>        log.info(m.toString()+<span class="hljs-string">&quot;|&quot;</span>+<span class="hljs-string">&quot;success&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-number">2022</span>-<span class="hljs-number">07</span>-<span class="hljs-number">23</span> <span class="hljs-number">23</span>:<span class="hljs-number">19</span>:<span class="hljs-number">38.571</span>  INFO <span class="hljs-number">712</span> --- [           main] com.wgf.springboot.BroadcastTest         : &#123;broadcast.results=[&#123;<span class="hljs-string">&quot;ip&quot;</span>:<span class="hljs-string">&quot;192.168.1.106&quot;</span>,<span class="hljs-string">&quot;port&quot;</span>:<span class="hljs-number">20880</span>,<span class="hljs-string">&quot;exceptionMsg&quot;</span>:<span class="hljs-string">&quot;/ by zero&quot;</span>&#125;,&#123;<span class="hljs-string">&quot;ip&quot;</span>:<span class="hljs-string">&quot;192.168.1.106&quot;</span>,<span class="hljs-string">&quot;port&quot;</span>:<span class="hljs-number">20881</span>,<span class="hljs-string">&quot;exceptionMsg&quot;</span>:<span class="hljs-string">&quot;/ by zero&quot;</span>&#125;]&#125;|success<br></code></pre></td></tr></table></figure></blockquote><h3 id="结果缓存"><a class="markdownIt-Anchor" href="#结果缓存"></a> 结果缓存</h3><blockquote><p><font size="5">Dubbo broadcast2 广播模式收集所有服务提供者的接口响应</font></p><p>结果缓存，用于加速热门数据的访问速度，Dubbo 提供声明式缓存，以减少用户加缓存的工作量</p><blockquote><p><strong>提示</strong></p><p><code>2.1.0</code> 以上版本支持</p><p>支持 <code>服务级别</code> <code>方法级别</code></p></blockquote><hr><p><strong>缓存类型</strong></p><ul><li><code>lru</code> 基于最近最少使用原则删除多余缓存，保持最热的数据被缓存</li><li><code>threadlocal</code> 当前线程缓存，比如一个页面渲染，用到很多 portal，每个 portal 都要去查用户信息，通过线程缓存，可以减少这种多余访问</li><li><code>jcache</code> 与 <a target="_blank" rel="noopener" href="http://jcp.org/en/jsr/detail?id=107%27">JSR107</a> 集成，可以桥接各种缓存实现</li></ul><hr><p><strong>接口项目</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ResultCacheService</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-title function_">increment</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><hr><p><strong>服务端</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DubboService</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResultCacheServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ResultCacheService</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">seq</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">0</span>);<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">increment</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> seq.incrementAndGet();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><hr><p><strong>消费端</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResultCacheTest</span> &#123;<br>    <span class="hljs-meta">@DubboReference(cache = &quot;lru&quot;)</span><br>    ResultCacheService resultCacheService;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>        IntStream.range(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>).forEach(line -&gt; log.info(resultCacheService.increment() + <span class="hljs-string">&quot;&quot;</span>));<br>    &#125;<br>&#125;<br><br>INFO <span class="hljs-number">11740</span> --- [           main] com.wgf.springboot.ResultCacheTest       : <span class="hljs-number">1</span><br>INFO <span class="hljs-number">11740</span> --- [           main] com.wgf.springboot.ResultCacheTest       : <span class="hljs-number">2</span><br>INFO <span class="hljs-number">11740</span> --- [           main] com.wgf.springboot.ResultCacheTest       : <span class="hljs-number">2</span><br>INFO <span class="hljs-number">11740</span> --- [           main] com.wgf.springboot.ResultCacheTest       : <span class="hljs-number">2</span><br>INFO <span class="hljs-number">11740</span> --- [           main] com.wgf.springboot.ResultCacheTest       : <span class="hljs-number">2</span><br>INFO <span class="hljs-number">11740</span> --- [           main] com.wgf.springboot.ResultCacheTest       : <span class="hljs-number">2</span><br>INFO <span class="hljs-number">11740</span> --- [           main] com.wgf.springboot.ResultCacheTest       : <span class="hljs-number">2</span><br>INFO <span class="hljs-number">11740</span> --- [           main] com.wgf.springboot.ResultCacheTest       : <span class="hljs-number">2</span><br>INFO <span class="hljs-number">11740</span> --- [           main] com.wgf.springboot.ResultCacheTest       : <span class="hljs-number">2</span><br>INFO <span class="hljs-number">11740</span> --- [           main] com.wgf.springboot.ResultCacheTest       : <span class="hljs-number">2</span><br></code></pre></td></tr></table></figure></blockquote><h3 id="事件通知"><a class="markdownIt-Anchor" href="#事件通知"></a> 事件通知</h3><blockquote><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/examples/events-notify/">使用文档 事件通知</a></p><p><font size="5">在调用之前、调用之后、出现异常时的事件通知</font></p><p>在调用之前、调用之后、出现异常时，会触发 <code>oninvoke</code>、<code>onreturn</code>、<code>onthrow</code> 三个事件，可以配置当事件发生时，通知哪个类的哪个方法</p><blockquote><p><strong>提示</strong></p><p>支持版本：<code>2.0.7</code> 之后</p></blockquote><hr><p><strong>接口项目</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">EventsNotifyService</span> &#123;<br>    String <span class="hljs-title function_">hello</span><span class="hljs-params">(String name)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><hr><p><strong>服务端</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DubboService</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EventsNotifyServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">EventsNotifyService</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;test&quot;</span>.equals(name)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;调用异常&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello !!&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><hr><p><strong>消费端</strong></p><p>定义事件通知接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">EventsNotify</span> &#123;<br>     <span class="hljs-keyword">void</span> <span class="hljs-title function_">onReturn</span><span class="hljs-params">(String result, String name)</span>;<br><br>     <span class="hljs-keyword">void</span> <span class="hljs-title function_">onThrow</span><span class="hljs-params">(Throwable ex, String name)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>实现事件通知接口并注册到Spring 容器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Service(&quot;eventsNotify&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EventsNotifyImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">EventsNotify</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onReturn</span><span class="hljs-params">(String result, String name)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;result : &#123;&#125;&quot;</span>, result);<br>        log.info(<span class="hljs-string">&quot;name : &#123;&#125;&quot;</span>, name);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onThrow</span><span class="hljs-params">(Throwable ex, String name)</span> &#123;<br>        log.error(ex.getMessage());<br>        log.info(<span class="hljs-string">&quot;name : &#123;&#125;&quot;</span>, name);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>使用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EventsNotifyTest</span> &#123;<br>    <span class="hljs-meta">@DubboReference(methods = &#123;</span><br><span class="hljs-meta">            @Method(name = &quot;hello&quot;, async = true,</span><br><span class="hljs-meta">                    onreturn = &quot;eventsNotify.onReturn&quot;,</span><br><span class="hljs-meta">                    onthrow = &quot;eventsNotify.onThrow&quot;</span><br><span class="hljs-meta">            )</span><br><span class="hljs-meta">    &#125;)</span><br>    EventsNotifyService eventsNotifyService;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>        eventsNotifyService.hello(<span class="hljs-string">&quot;wgf&quot;</span>);<br>        eventsNotifyService.hello(<span class="hljs-string">&quot;test&quot;</span>);<br>    &#125;<br>&#125;<br><br>  <span class="hljs-comment">//INFO 16480 --- [andler-thread-1] c.w.springboot.notify.EventsNotifyImpl   : result : hello !!</span><br>  <span class="hljs-comment">//INFO 16480 --- [andler-thread-1] c.w.springboot.notify.EventsNotifyImpl   : name : wgf</span><br> <span class="hljs-comment">//ERROR 16480 --- [andler-thread-1] c.w.springboot.notify.EventsNotifyImpl   : 调用异常</span><br>  <span class="hljs-comment">//INFO 16480 --- [andler-thread-1] c.w.springboot.notify.EventsNotifyImpl   : name : test</span><br></code></pre></td></tr></table></figure></blockquote><h3 id="本地伪装"><a class="markdownIt-Anchor" href="#本地伪装"></a> 本地伪装</h3><blockquote><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/examples/local-mock/">使用文档 本地伪装</a></p><p><font color="red"><strong>注意</strong>：服务降级 和 本地伪装 只能处理Dubbo框架自身的 RpcException，业务异常熔断需要集成 <a target="_blank" rel="noopener" href="https://blog.51cto.com/u_15127575/2902122">其他中间件</a></font></p><p>Mock 是 Stub 的一个子集，便于服务提供方在客户端执行容错逻辑</p><p>本地伪装就是Mock，Dubbo中Mock的功能相对于本地存根更简单一点，Mock其实就是Dubbo中的 <code>服务降级</code>，不同的名词罢了</p><hr><p><strong>接口项目</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">LocalMockService</span> &#123;<br>    String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>mock实现</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LocalMockServiceMock</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">LocalMockService</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;服务降级数据&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><hr><p><strong>服务端</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DubboService</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LocalMockServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">LocalMockService</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            TimeUnit.SECONDS.sleep(<span class="hljs-number">1100</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><hr><p><strong>消费端</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LocalMockTest</span> &#123;<br>    <span class="hljs-comment">// 本地伪装只能处理Dubbo框架自身调用异常，无法处理业务异常</span><br>    <span class="hljs-meta">@DubboReference(mock = &quot;com.wgf.springboot.connector.mock.LocalMockServiceMock&quot;, timeout = 1000)</span><br>    LocalMockService localMockService;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>        log.info(localMockService.hello());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></blockquote><h3 id="本地存根"><a class="markdownIt-Anchor" href="#本地存根"></a> 本地存根</h3><blockquote><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/examples/local-stub/">使用文档 本地存根</a></p><p>在 Dubbo 中利用本地存根在客户端执行部分逻辑</p><p>本地存根，名字很抽象，但实际上不难理解，<span style="border-bottom:2px dashed green">本地存根就是一段逻辑，这段逻辑是在服务消费端执行的</span>，这段逻辑一般都是由服务提供者提供，服务提供者可以利用这种机制在服务消费者远程调用服务提供者之前或之后再做一些其他事情，比如结果缓存，请求参数验证等等</p><hr><p><strong>接口项目</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">LocalStubService</span> &#123;<br>    String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>同包下本地存根实现</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span>: ken 😃</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span>: 2022-07-19</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span>: 本地存根实现</span><br><span class="hljs-comment"> * 本地存根其实就是使用装饰者模式在本地增强一些功能</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LocalStubServiceStub</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">LocalStubService</span> &#123;<br>    <span class="hljs-comment">// 真正的远端调用对象</span><br>    <span class="hljs-keyword">private</span> LocalStubService localStubService;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">LocalStubServiceStub</span><span class="hljs-params">(LocalStubService localStubService)</span> &#123;<br>        <span class="hljs-built_in">this</span>.localStubService = localStubService;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">hello</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.localStubService.hello();<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hi &quot;</span> + hello;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><hr><p><strong>服务端</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DubboService</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LocalStubServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">LocalStubService</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;wgf&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><hr><p><strong>消费端</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LocalStubTest</span> &#123;<br>    <span class="hljs-comment">// stub=true的是个默认配置,默认用接口的全限定类名+Stub去调用</span><br>    <span class="hljs-meta">@DubboReference(stub = &quot;true&quot;)</span><br>    LocalStubService localStubService;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>        log.info(localStubService.hello());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><hr><ol><li>stub=true的是个默认配置，默认用接口的全限定类名+Stub去调用</li><li>也可以用 stub=权限定类名 进行调用</li><li>stub实现必须传入一个<strong>远程的调用对象，也就是暴露的服务接口</strong></li><li><strong>stub实现必须要有一个传入远程调用对象的构造参数</strong></li><li><strong>说白了就是使用装饰者模式在消费端本地进行功能增强</strong></li></ol></blockquote><h3 id="延迟暴露"><a class="markdownIt-Anchor" href="#延迟暴露"></a> 延迟暴露</h3><blockquote><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/examples/delay-publish/">使用文档 延迟暴露</a></p><p><font size="5">延迟暴露 Dubbo 服务</font></p><p><span style="border-bottom:2px dashed green">如果你的服务需要预热时间，比如初始化缓存，等待相关资源就位等，可以使用 delay 进行延迟暴露。</span>我们在 Dubbo 2.6.5 版本中对服务延迟暴露逻辑进行了细微的调整，将需要延迟暴露（delay &gt; 0）服务的倒计时动作推迟到了 Spring 初始化完成后进行。你在使用 Dubbo 的过程中，并不会感知到此变化，因此请放心使用</p><p>如果依赖服务开启启动时检查则如果服务同时重启依赖服务可能会启动失败</p><hr><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DubboService(delay = 60000)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DelayPublishServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DelayPublishService</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></blockquote><h3 id="延迟连接"><a class="markdownIt-Anchor" href="#延迟连接"></a> 延迟连接</h3><blockquote><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/examples/lazy-connect/">使用文档 延迟连接</a></p><p><font size="5">在 Dubbo 中配置延迟连接</font></p><blockquote><p><strong>提示</strong></p><p>该配置只对使用长连接的 dubbo 协议生效</p></blockquote><p>延迟连接用于减少长连接数。当有调用发起时，再创建长连接</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 默认值就是 false</span><br><span class="hljs-meta">@DubboReference(lazy = false)</span><br>xxxService xxxService; <br></code></pre></td></tr></table></figure></blockquote><h3 id="参数回调"><a class="markdownIt-Anchor" href="#参数回调"></a> 参数回调</h3><blockquote><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/examples/callback-parameter/">使用文档 参数回调</a></p><p>参数回调方式与调用本地 callback 或 listener 相同，只需要在 Spring 的配置文件中声明哪个参数是 callback 类型即可。<span style="border-bottom:2px dashed green">Dubbo 将基于长连接生成反向代理，这样就可以从服务器端调用客户端逻辑</span></p><hr><p><strong>接口项目</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span>: ken.😊</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@create</span>: 2022-07-19 22:28</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span>: 定义回调参数接口</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">CallbackListener</span> &#123;<br>    String <span class="hljs-title function_">getFirstName</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">CallbackService</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 第二个参数是回调参数</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> lastName</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> callbackListener</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    String <span class="hljs-title function_">hello</span><span class="hljs-params">(String lastName, CallbackListener callbackListener)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><hr><p><strong>服务端</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span>: ken.😊</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@create</span>: 2022-07-19 22:33</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span>: 参数回调</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * 这个回调对象CallbackListener是Dubbo给我们生成的代理对象</span><br><span class="hljs-comment"> * 通过 <span class="hljs-doctag">@Argument</span> 注解指定哪个参数是回调参数</span><br><span class="hljs-comment"> * callbacks = 3 支持3个回调，数目超过了会报错</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-meta">@DubboService(methods = &#123;</span><br><span class="hljs-meta">        @Method(name = &quot;hello&quot;, arguments = &#123;</span><br><span class="hljs-meta">                @Argument(index = 1, callback = true)</span><br><span class="hljs-meta">        &#125;)</span><br><span class="hljs-meta">&#125;, callbacks = 3)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CallbackServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CallbackService</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">(String lastName, CallbackListener callbackListener)</span> &#123;<br>        <span class="hljs-comment">// 回调客户端逻辑</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">firstName</span> <span class="hljs-operator">=</span> callbackListener.getFirstName();<br>        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">&quot;hello %s %s&quot;</span>, firstName, lastName);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><hr><p><strong>消费端</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 回调接口实现</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyCallback</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CallbackListener</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getFirstName</span><span class="hljs-params">()</span> &#123;<br>        log.info(<span class="hljs-string">&quot;参数回调&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;wu&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CallbackTest</span> &#123;<br>    <span class="hljs-meta">@DubboReference</span><br>    CallbackService callbackService;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 创建回调参数</span><br>        <span class="hljs-type">CallbackListener</span> <span class="hljs-variable">callbackListener</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyCallback</span>();<br>        log.info(callbackService.hello(<span class="hljs-string">&quot;gengfeng&quot;</span>, callbackListener));<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 输出</span><br><span class="hljs-comment">//2022-07-19 22:51:45.791  INFO 1885 --- [andler-thread-2] com.wgf.springboot.callback.MyCallback   : 参数回调</span><br><span class="hljs-comment">//2022-07-19 22:51:45.799  INFO 1885 --- [           main] com.wgf.springboot.CallbackTest          : hello wu gengfeng</span><br></code></pre></td></tr></table></figure></blockquote><h3 id="异步执行"><a class="markdownIt-Anchor" href="#异步执行"></a> 异步执行</h3><blockquote><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/examples/async-execute-on-provider/">使用文档 异步执行</a></p><p><font size="5">Dubbo 服务提供方的异步执行</font></p><p>Provider端异步执行将阻塞的业务从Dubbo内部线程池切换到业务自定义线程，<span style="border-bottom:2px dashed green">避免Dubbo线程池的过度占用，有助于避免不同服务间的互相影响。异步执行无益于节省资源或提升RPC响应性能，</span>因为如果业务执行需要阻塞，则始终还是要有线程来负责执行</p><blockquote><p><strong>注意</strong></p><p>Provider 端 <code>异步执行</code> 和 Consumer 端 <code>异步调用</code> 是相互独立的，你可以任意正交组合两端配置</p><ul><li>Consumer同步 - Provider同步</li><li>Consumer异步 - Provider同步</li><li>Consumer同步 - Provider异步</li><li>Consumer异步 - Provider异步</li></ul></blockquote><ul><li><p><strong>用法一</strong> 参考 <a href="#%E5%BC%82%E6%AD%A5%E8%B0%83%E7%94%A8">异步调用</a> 用的 <code>AsyncCallServiceImpl</code></p></li><li><p><strong>用法二</strong> 使用AsyncContext</p><p>Dubbo 提供了一个类似 Serverlet 3.0 的异步接口<code>AsyncContext</code>，<strong>在没有 CompletableFuture 签名接口的情况下，也可以实现 Provider 端的异步执行</strong></p></li></ul><hr><p><strong>接口项目</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AsyncExecuteService</span> &#123;<br>    String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><hr><p><strong>服务端</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@DubboService</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncExecuteServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AsyncExecuteService</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> &#123;<br>        log.info(Thread.currentThread().getName());<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">AsyncContext</span> <span class="hljs-variable">asyncContext</span> <span class="hljs-operator">=</span> RpcContext.startAsync();<br><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-comment">// 如果要使用上下文，则必须要放在第一句执行</span><br>            asyncContext.signalContextSwitch();<br>            log.info(Thread.currentThread().getName());<br>            <span class="hljs-keyword">try</span> &#123;<br>                Thread.sleep(<span class="hljs-number">500</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>            <span class="hljs-comment">// 写回响应</span><br>            asyncContext.write(<span class="hljs-string">&quot;Hello&quot;</span>);<br>        &#125;).start();<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//INFO 9340 --- [:20880-thread-5] c.w.s.provider.AsyncExecuteServiceImpl   : DubboServerHandler-192.168.1.106:20880-thread-5</span><br><span class="hljs-comment">//INFO 9340 --- [      Thread-17] c.w.s.provider.AsyncExecuteServiceImpl   : Thread-17</span><br></code></pre></td></tr></table></figure><hr><p><strong>客户端</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncExecuteTest</span> &#123;<br>    <span class="hljs-meta">@DubboReference</span><br>    AsyncExecuteService asyncExecuteService;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>        Assertions.assertEquals(asyncExecuteService.hello(), <span class="hljs-string">&quot;Hello&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></blockquote><h3 id="异步调用"><a class="markdownIt-Anchor" href="#异步调用"></a> 异步调用</h3><blockquote><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/examples/async-call/">使用文档 异步调用</a></p><p><a target="_blank" rel="noopener" href="https://imlql.cn/post/d3c530c4.html">其他异步调用方式</a></p><p>理解起来比较容易，主要要理解 <a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904195162636295">CompletableFuture</a>。只是说dubbo也可以支持java的CompletableFuture</p><p><strong><code>sent</code> 属性</strong></p><ul><li><code>sent=&quot;true&quot;</code> 等待消息发出，消息发送失败将抛出异常。</li><li><code>sent=&quot;false&quot;</code> 不等待消息发出，将消息放入 IO 队列，即刻返回。</li><li>如果你只是想异步，完全忽略返回值，可以配置 <code>return=&quot;false&quot;</code>，以减少 Future 对象的创建和管理成本</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DubboReference(methods = &#123;</span><br><span class="hljs-meta">  @Method(name = &quot;hello&quot;, async = true, sent = false)</span><br><span class="hljs-meta">&#125;)</span><br></code></pre></td></tr></table></figure><hr><p><strong>接口项目</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AsyncCallService</span> &#123;<br>    <span class="hljs-comment">// 有多种扩展模式, 默认方法扩展、RpcContext</span><br>    CompletableFuture&lt;String&gt; <span class="hljs-title function_">hello</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><hr><p><strong>服务端</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@DubboService</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncCallServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AsyncCallService</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> CompletableFuture&lt;String&gt; <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> &#123;<br>        log.info(<span class="hljs-string">&quot;hello&quot;</span>);<br>        <span class="hljs-comment">// 建议为supplyAsync提供自定义线程池，避免使用JDK公用线程池</span><br>        <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; &#123;<br>            <span class="hljs-comment">// 将同步逻辑包装成异步</span><br>            <span class="hljs-keyword">return</span> getName();<br>        &#125;);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            TimeUnit.MILLISECONDS.sleep(<span class="hljs-number">500</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        log.info(<span class="hljs-string">&quot;getName&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;wgf&quot;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 输出</span><br><span class="hljs-comment">// 2022-07-19 23:47:30.242  INFO 2216 --- [:20880-thread-5] c.w.s.provider.AsyncCallServiceImpl      : hello</span><br><span class="hljs-comment">// 2022-07-19 23:47:30.749  INFO 2216 --- [onPool-worker-1] c.w.s.provider.AsyncCallServiceImpl      : getName</span><br></code></pre></td></tr></table></figure><hr><p><strong>消费端</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncCallTest</span> &#123;<br>    <span class="hljs-meta">@DubboReference(methods = &#123;</span><br><span class="hljs-meta">            @Method(name = &quot;hello&quot;, async = true)</span><br><span class="hljs-meta">    &#125;)</span><br>    AsyncCallService asyncCallService;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        CompletableFuture&lt;String&gt; future = asyncCallService.hello();<br>        <br>        <span class="hljs-comment">// future 可以使用其他 Api 等待结果返回</span><br>        future.whenComplete((result, exception) -&gt; &#123;<br>            <span class="hljs-keyword">if</span> (exception == <span class="hljs-literal">null</span>) &#123;<br>                log.info(<span class="hljs-string">&quot;异步调用返回值：&#123;&#125;&quot;</span>, result);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                exception.printStackTrace();<br>            &#125;<br>        &#125;);<br><br>        log.info(<span class="hljs-string">&quot;测试执行完毕&quot;</span>);<br><br>        <span class="hljs-comment">// 等待异步返回</span><br>        TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 输出</span><br><span class="hljs-comment">// 2022-07-19 23:42:47.311  INFO 2194 --- [           main] com.wgf.springboot.AsyncCallTest         : 测试执行完毕</span><br><span class="hljs-comment">// 2022-07-19 23:42:48.320  INFO 2194 --- [andler-thread-1] com.wgf.springboot.AsyncCallTest         : 异步调用返回值：wgf</span><br></code></pre></td></tr></table></figure></blockquote><h3 id="并发控制"><a class="markdownIt-Anchor" href="#并发控制"></a> 并发控制</h3><blockquote><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/examples/concurrency-control/">使用文档 并发控制</a></p><p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1883475">相关博客</a></p><p><font size="5">Dubbo 中的并发控制，可控制 <code>服务级别</code> <code>方法级别</code> <code>服务端</code> <code>消费端</code></font></p><hr><p><strong>用法一 <code>服务级别</code> 限制服务器端并发执行线程数</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DubboService(executes = 1)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConcurrencyServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConcurrencyService</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            TimeUnit.MILLISECONDS.sleep(<span class="hljs-number">200</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello&quot;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 并发超过会引发Rpc异常</span><br></code></pre></td></tr></table></figure><hr><p><strong>用法二 <code>方法级别</code> 限制服务器端并发执行线程数</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DubboService(methods = &#123;</span><br><span class="hljs-meta">        @Method(name = &quot;hello&quot;, executes = 1)</span><br><span class="hljs-meta">&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConcurrencyServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConcurrencyService</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            TimeUnit.MILLISECONDS.sleep(<span class="hljs-number">200</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><hr><p><strong>用法三 <code>服务级别</code> 限制每客户端并发执行请求数</strong></p><p>说明：<code>2.7.x</code> 版本生效，<code>3.0.x</code>版本不生效</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DubboReference(actives = 1)</span><br>ConcurrencyService concurrencyService;<br></code></pre></td></tr></table></figure><hr><p><strong>用法四 <code>方法级别</code> 限制每客户端并发执行请求数</strong></p><p>说明：<code>2.7.x</code> 版本生效，<code>3.0.x</code>版本不生效</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DubboReference(methods = &#123;</span><br><span class="hljs-meta">        @Method(name = &quot;hello&quot;, actives = 1)</span><br><span class="hljs-meta">&#125;)</span><br>ConcurrencyService concurrencyService;<br></code></pre></td></tr></table></figure></blockquote><h3 id="连接控制"><a class="markdownIt-Anchor" href="#连接控制"></a> 连接控制</h3><blockquote><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/examples/config-connections/">使用文档 连接控制</a></p><p><font size="5">Dubbo 中服务端和客户端的连接控制</font></p><hr><p><strong>服务端连接控制</strong></p><p>限制服务器端接受的连接不能超过 N 个</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">dubbo:</span><br>  <span class="hljs-attr">provider:</span><br>    <span class="hljs-attr">protocol:</span> <span class="hljs-string">dubbo</span><br>    <span class="hljs-attr">accepts:</span> <span class="hljs-number">10</span><br></code></pre></td></tr></table></figure><p>或者</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">dubbo:</span><br>  <span class="hljs-attr">protocol:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">dubbo</span><br>    <span class="hljs-attr">accepts:</span> <span class="hljs-number">10</span><br></code></pre></td></tr></table></figure><p>或者</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DubboService(connections = 1)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConnectionsServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConnectionsService</span> &#123;<br>  ...<br>&#125;<br></code></pre></td></tr></table></figure><p>或者</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DubboReference(connections = 1)</span><br>ConnectionsService connectionsService;<br></code></pre></td></tr></table></figure></blockquote><h3 id="粘滞连接"><a class="markdownIt-Anchor" href="#粘滞连接"></a> 粘滞连接</h3><blockquote><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/examples/stickiness/">使用文档 粘滞连接</a></p><p><font size="5">为有状态服务配置粘滞连接</font></p><p><span style="border-bottom:2px dashed green">粘滞连接用于有状态服务(当有多个服务提供者)，尽可能让客户端总是向同一提供者发起调用，除非该提供者挂了，再连另一台。</span></p><p>粘滞连接将自动开启<a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/examples/lazy-connect">延迟连接</a>，以减少长连接数。</p><p>支持<strong>消费端</strong> <code>服务级别</code> <code>方法级别</code> 配置</p><hr><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DubboReference(sticky = true)</span><br>StickyService stickyService;<br></code></pre></td></tr></table></figure></blockquote><h3 id="泛化调用"><a class="markdownIt-Anchor" href="#泛化调用"></a> 泛化调用</h3><blockquote><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/examples/generic-reference/">使用文档 使用泛化调用</a></p><p><span style="border-bottom:2px dashed green">泛化接口调用方式主要用于客户端没有 API 接口及模型类元的情况，参数及返回值中的所有 POJO 均用 <code>Map</code> 表示</span>，通常用于框架集成，比如：实现一个通用的服务测试框架，可通过 <code>GenericService</code> 调用所有服务实现，<code>GenericService</code> 是 Dubbo 提供的</p><hr><p><strong>消费端</strong></p></blockquote><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GenericTest</span> &#123;<br><br>    <span class="hljs-comment">// 泛化 LoadBalanceService</span><br>    <span class="hljs-meta">@DubboReference(interfaceName = &quot;com.wgf.springboot.connector.LoadBalanceService&quot;, generic = true)</span><br>    GenericService genericService;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 方法名称</span><br>        <span class="hljs-comment">// 参数类型</span><br>        <span class="hljs-comment">// 参数</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">hello</span> <span class="hljs-operator">=</span> genericService.$invoke(<span class="hljs-string">&quot;hello&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;java.lang.String&quot;</span>&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;wgf&quot;</span>&#125;);<br>        System.out.println(hello);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></blockquote><h3 id="json泛化调用"><a class="markdownIt-Anchor" href="#json泛化调用"></a> json泛化调用</h3><blockquote><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/examples/generic-invoke-with-json">使用文档 json泛化调用</a></p><blockquote><p><strong>提示</strong></p><p>支持版本：<code>2.7.12</code>之后， <code>3.0.x</code> 暂时不支持</p></blockquote><p>对于Dubbo泛化调用，提供一种新的方式：直接传递字符串来完成一次调用。即用户可以直接传递参数对象的json字符串来完成一次Dubbo泛化调用</p><hr><p><strong>接口项目</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">GenericJsonService</span> &#123;<br>    User <span class="hljs-title function_">add</span><span class="hljs-params">(User user)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><hr><p><strong>服务端</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@DubboService</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GenericJsonServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">GenericJsonService</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">add</span><span class="hljs-params">(User user)</span> &#123;<br>        log.info(user.toString());<br>        <span class="hljs-keyword">return</span> user;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><hr><p><strong>消费端</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GenericJsonTest</span> &#123;<br>    <span class="hljs-meta">@DubboReference(interfaceName = &quot;com.wgf.springboot.connector.GenericJsonService&quot;, generic = true)</span><br>    GenericService genericService;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;&#x27;id&#x27;:10,&#x27;name&#x27;:&#x27;wgf&#x27;&#125;&quot;</span>;<br><br>        <span class="hljs-comment">// 3.0.x 版本不支持 2.7.12 之后支持</span><br>        <span class="hljs-comment">// RpcContext中设置generic=gson</span><br>        RpcContext.getContext().setAttachment(<span class="hljs-string">&quot;generic&quot;</span>,<span class="hljs-string">&quot;gson&quot;</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> genericService.$invoke(<span class="hljs-string">&quot;add&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;com.wgf.springboot.entity.User&quot;</span>&#125;,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;json&#125;);<br>        log.info(result.toString());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></blockquote><h3 id="泛化服务"><a class="markdownIt-Anchor" href="#泛化服务"></a> 泛化服务</h3><blockquote><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/examples/generic-service/">使用文档 实现泛化调用</a></p><p><span style="border-bottom:2px dashed green">泛化接口实现方式主要用于服务器端没有 API 接口及模型类元的情况，参数及返回值中的所有 POJO 均用 Map 表示</span></p><p><strong>实现一个通用的远程服务 Mock 框架</strong>，可通过实现 GenericService 接口处理所有服务请求</p><hr><p><strong>服务端</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span>: ken 😃</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span>: 2022-07-20</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span>:</span><br><span class="hljs-comment"> * 泛化 LoadBalanceService 服务 实现一个mock服务，需要通过version和原版本区分</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-meta">@DubboService(interfaceName = &quot;com.wgf.springboot.connector.LoadBalanceService&quot;, version = &quot;mock&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GenericServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">GenericService</span> &#123;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> method         方法名字</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> parameterTypes 参数类型数组</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> args           参数值数组</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object $invoke(String method, String[] parameterTypes, Object[] args) <span class="hljs-keyword">throws</span> GenericException &#123;<br>        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">&quot;调用 %s 方法&quot;</span>, method);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><hr><p><strong>消费端</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GenericServiceTest</span> &#123;<br><br>    <span class="hljs-comment">// 指定为泛化版本</span><br>    <span class="hljs-meta">@DubboReference(version = &quot;mock&quot;)</span><br>    LoadBalanceService loadBalanceService;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>        log.info(loadBalanceService.hello(<span class="hljs-string">&quot;test&quot;</span>));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><hr><ul><li>服务端会暴露原版和泛化的 <code>LoadBalanceService</code> 服务</li><li>如果没有指定 <code>mock</code> 版本，默认执行 <code>LoadBalanceService</code> 实现原逻辑</li><li>指定 <code>mock</code> 版本，则会进入泛化服务的 <code>$invoke</code> 方法中</li></ul></blockquote><h3 id="rest支持"><a class="markdownIt-Anchor" href="#rest支持"></a> REST支持</h3><blockquote><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/rest/">使用文档 REST 支持</a></p><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/advanced/multi-protocols/">使用文档 多协议</a></p><p>注意Dubbo的REST也是Dubbo所支持的一种<strong>协议</strong></p><p>当我们用Dubbo提供了一个服务后，如果消费者没有使用Dubbo也想调用服务，那么这个时候我们就可以让我们的服务支持REST协议，这样消费者就可以通过REST形式调用我们的服务了</p><p>注意：如果某个服务只有REST协议可用，那么该服务必须用@Path注解定义访问路径</p><p><strong>接口项目</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RestService</span> &#123;<br>    Map&lt;Integer, Object&gt; <span class="hljs-title function_">selectUser</span><span class="hljs-params">(Integer id)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><hr><p><strong>服务端</strong></p><p>添加依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.dubbo<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>dubbo-rpc-rest<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.0.9<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span>: ken 😃</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span>: 2022-07-20</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span>: REST 应用，服务可以同时支持多个协议</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-meta">@Path(&quot;test&quot;)</span><br><span class="hljs-meta">@DubboService(protocol = &#123;&quot;rest&quot;, &quot;dubbo&quot;&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RestServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RestService</span> &#123;<br><br>    <span class="hljs-meta">@GET</span><br>    <span class="hljs-meta">@Path(&quot;selectUser&quot;)</span><br>    <span class="hljs-meta">@Produces(&#123;ContentType.APPLICATION_JSON_UTF_8&#125;)</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Map&lt;Integer, Object&gt; <span class="hljs-title function_">selectUser</span><span class="hljs-params">(<span class="hljs-meta">@QueryParam(&quot;id&quot;)</span> Integer id)</span> &#123;<br>        Map&lt;Integer, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map.put(id, <span class="hljs-string">&quot;test&quot;</span>);<br>        <span class="hljs-keyword">return</span> map;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>多协议配置</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">dubbo:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">dubbo-springboot-provider</span><br>  <span class="hljs-attr">protocols:</span><br>    <span class="hljs-attr">dubbo:</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">dubbo</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">-1</span><br>    <span class="hljs-attr">rest:</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">rest</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br>      <span class="hljs-attr">server:</span> <span class="hljs-string">jetty</span><br>  <span class="hljs-attr">registry:</span><br>    <span class="hljs-attr">id:</span> <span class="hljs-string">zk-registry</span><br>    <span class="hljs-attr">address:</span> <span class="hljs-string">zookeeper://my-server:2181</span><br>  <span class="hljs-attr">config-center:</span><br>    <span class="hljs-attr">address:</span> <span class="hljs-string">zookeeper://my-server:2181</span><br>  <span class="hljs-attr">metadata-report:</span><br>    <span class="hljs-attr">address:</span> <span class="hljs-string">zookeeper://my-server:2181</span><br></code></pre></td></tr></table></figure><hr><p><strong>客户端</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RestTest</span> &#123;<br>    <span class="hljs-comment">// 使用dubbo 协议</span><br>    <span class="hljs-meta">@DubboReference</span><br>    RestService restService;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>        Assertions.assertEquals(restService.selectUser(<span class="hljs-number">1</span>).get(<span class="hljs-number">1</span>), <span class="hljs-string">&quot;test&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>浏览器访问</strong> ：<a target="_blank" rel="noopener" href="http://localhost:8080/test/selectUser?id=2">http://localhost:8080/test/selectUser?id=2</a></p></blockquote><h3 id="msgpack序列化"><a class="markdownIt-Anchor" href="#msgpack序列化"></a> msgpack序列化</h3><blockquote><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docsv2.7/user/examples/msgpack-serialization/">使用文档 msgpack序列化</a></p><p><a target="_blank" rel="noopener" href="https://msgpack.org/">msgpack 官网</a></p><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_37941483/article/details/97824391">msgpack 用法</a></p><p><img src="https://pic2.zhimg.com/v2-8b9d5831d58b4265e2449ae6a5c048e7_1440w.jpg?source=172ae18b" srcset="/img/loading.gif" lazyload alt></p><p><code>MessagePack</code> 是一种高效的二进制序列化格式。它允许您在 JSON 等多种语言之间交换数据。但它更快更小。小整数被编码为一个字节，典型的短字符串除了字符串本身之外只需要一个额外的字节</p><p><span style="border-bottom:2px dashed green">需要注意的是解包顺序必须与打包顺序一致（字段顺序），否则会出错。也就是说协议格式的维护要靠两端手写代码进行保证，而这是很不安全的</span></p><blockquote><p><strong>提示</strong></p><p>支持版本：<code>2.7.12</code> 之后</p></blockquote></blockquote><h3 id="回声测试"><a class="markdownIt-Anchor" href="#回声测试"></a> 回声测试</h3><blockquote><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/examples/echo-service/">使用文档 回声测试</a></p><p><font size="5">通过回声测试检测 Dubbo 服务是否可用</font></p><p>回声测试用于检测服务是否可用，回声测试按照正常请求流程执行，能够测试整个调用是否通畅，可用于监控。</p><p><span style="border-bottom:2px dashed green">所有服务自动实现 <code>EchoService</code> 接口，只需将任意服务引用强制转型为 <code>EchoService</code>，即可使用。</span></p><hr><p><strong>接口项目</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">TestEchoService</span> &#123;<br>    String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><hr><p><strong>服务端</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DubboService</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestEchoServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">TestEchoService</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;HELLO&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><hr><p><strong>消费端</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EchoTest</span> &#123;<br>    <span class="hljs-meta">@DubboReference</span><br>    TestEchoService testEchoService;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">EchoService</span> <span class="hljs-variable">echoService</span> <span class="hljs-operator">=</span> (EchoService) testEchoService;<br>        log.info(echoService.$echo(<span class="hljs-string">&quot;ok&quot;</span>).toString());<br>    &#125;<br>&#125;<br><br>INFO <span class="hljs-number">3448</span> --- [           main] com.wgf.springboot.EchoTest              : ok<br></code></pre></td></tr></table></figure></blockquote><h3 id="上下文信息"><a class="markdownIt-Anchor" href="#上下文信息"></a> 上下文信息</h3><blockquote><ul><li><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/examples/context/">使用文档 上下文信息</a></li><li><a target="_blank" rel="noopener" href="https://www.javadoc.io/static/com.alibaba/dubbo/2.5.4/com/alibaba/dubbo/rpc/RpcContext.html">RpcContext (Dubbo 2.5.4 API) (javadoc.io)</a></li></ul><p><font size="5">通过上下文存放当前调用过程中所需的环境信息</font></p><p>上下文中存放的是当前调用过程中所需的环境信息。所有配置信息都将转换为 URL 的参数</p><p>RpcContext 是一个 ThreadLocal 的临时状态记录器，当接收到 RPC 请求，或发起 RPC 请求时，RpcContext 的状态都会变化。比如：A 调 B，B 再调 C，则 B 机器上，在 B 调 C 之前，RpcContext 记录的是 A 调 B 的信息，在 B 调 C 之后，RpcContext 记录的是 B 调 C 的信息。</p><hr><p><strong>服务端</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DubboService</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RpcContextServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RpcContextService</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">RpcContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> RpcContext.getContext();<br>        <span class="hljs-comment">// 反射输出</span><br>        RpcContextService.print(context);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><hr><p><strong>消费端</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RpcContextTest</span> &#123;<br>    <span class="hljs-meta">@DubboReference</span><br>    RpcContextService rpcContextService;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>        rpcContextService.hello();<br>        <span class="hljs-comment">// 注意 调用后获取上下文</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">RpcContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> RpcContext.getContext();<br>        RpcContextService.print(context);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></blockquote><h3 id="隐式参数"><a class="markdownIt-Anchor" href="#隐式参数"></a> 隐式参数</h3><blockquote><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/examples/attachment/">使用文档 隐式参数</a></p><p><font size="5">通过 Dubbo 中的 Attachment 在服务消费方和提供方之间隐式传递参数</font></p><p>可以通过 <code>RpcContext</code> 上的 <code>setAttachment</code> 和 <code>getAttachment</code> 在服务消费方和提供方之间进行参数的隐式传递</p><blockquote><p><strong>注意</strong></p><p>path, group, version, dubbo, token, timeout 几个 key 是保留字段，请使用其它值</p></blockquote><hr><p><strong>接口项目</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AttachmentService</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">hello</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><hr><p><strong>服务端</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@DubboService</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AttachmentServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AttachmentService</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 隐式参数获取 用于框架集成，不建议常规业务使用</span><br>        log.info(RpcContext.getContext().getAttachment(<span class="hljs-string">&quot;param&quot;</span>));<br>    &#125;<br>&#125;<br><br>INFO <span class="hljs-number">11172</span> --- [:<span class="hljs-number">20880</span>-thread-<span class="hljs-number">5</span>] c.w.s.provider.AttachmentServiceImpl     : test<br></code></pre></td></tr></table></figure><hr><p><strong>消费端</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AttachmentTest</span> &#123;<br><br>    <span class="hljs-meta">@DubboReference</span><br>    AttachmentService attachmentService;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 传递隐式参数</span><br>        RpcContext.getContext().setAttachment(<span class="hljs-string">&quot;param&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>);<br>        attachmentService.hello();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></blockquote><h3 id="tls"><a class="markdownIt-Anchor" href="#tls"></a> TLS</h3><blockquote><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/examples/tls/">使用文档 TLS</a></p><p><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/TLS/2979545">传输安全协议 TLS</a></p><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/e1c9dd00d476?u_atoken=3a6c9a4b-68c8-485e-9d52-04ebf9261208&amp;u_asession=01mMZ9SAVvRlLN6-Wh7ri0xTVIbjdtBXo5G1CC0N0WZfnJvDKCgB1ShBeFzlKnyrJwX0KNBwm7Lovlpxjd_P_q4JsKWYrT3W_NKPr8w6oU7K-R6TRxO0ihTvWWNUzrPU68nHmbkqVcEgdObpAroqY1_GBkFo3NEHBv0PZUm6pbxQU&amp;u_asig=051ZX8QUh5wZOZfUrsSO4L-yRT93kvEChklUd6SHgux_dTCClmiRDMbOJcslRETovwJgZlaMB5rlx6OymhpMszeR8nUEuve-zRSqwDhgyc-v8TEkz1KZntES6Q4BuF958fTfgSZigK_fCaQjulkbchOmT0iaLHqWpWKMWUoxRgK739JS7q8ZD7Xtz2Ly-b0kmuyAKRFSVJkkdwVUnyHAIJzbls6tphYka4jcBMD5fgMWf9roUlNbsn8EVkLFhWeYak6xbSxAaWh9ph0bRUFW-6vO3h9VXwMyh6PgyDIVSG1W8b4bod_TvZEbcR_kRfUEkn6UBi2EXEzpguGgi5tijWlncWsnrO5WxVz02p-sX6q1qsErCUJSVaj9M_NL5D2hVPmWspDxyAEEo4kbsryBKb9Q&amp;u_aref=gDe38Vg8S9kaDGiTeOF2AIf3AeQ%3D">SSL 证书配置博客</a></p><p><font size="5">通过 TLS 保证传输安全</font></p><p>2.7.5 版本在传输链路的安全性上做了很多工作，对于内置的 Dubbo Netty Server 和新引入的 gRPC 协议都提供了基于 TLS 的安全链路传输机制</p><p>TLS 的配置都有统一的入口，如下所示：</p><hr><p><strong>Provider 端</strong></p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">SslConfig sslConfig = <span class="hljs-keyword">new</span> <span class="hljs-constructor">SslConfig()</span>;<br>sslConfig.set<span class="hljs-constructor">ServerKeyCertChainPath(<span class="hljs-string">&quot;path to cert&quot;</span>)</span>;<br>sslConfig.set<span class="hljs-constructor">ServerPrivateKeyPath(<span class="hljs-params">args</span>[1])</span>;<br><span class="hljs-comment">// 如果开启双向 cert 认证</span><br><span class="hljs-keyword">if</span> (mutualTls) &#123;<br>  sslConfig.set<span class="hljs-constructor">ServerTrustCertCollectionPath(<span class="hljs-params">args</span>[2])</span>;<br>&#125;<br><br>ProtocolConfig protocolConfig = <span class="hljs-keyword">new</span> <span class="hljs-constructor">ProtocolConfig(<span class="hljs-string">&quot;dubbo/grpc&quot;</span>)</span>;<br>protocolConfig.set<span class="hljs-constructor">SslEnabled(<span class="hljs-params">true</span>)</span>;<br></code></pre></td></tr></table></figure><hr><p><strong>Consumer 端</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (!mutualTls) &#123;&#125;<br>    sslConfig.setClientTrustCertCollectionPath(args[<span class="hljs-number">0</span>]);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    sslConfig.setClientTrustCertCollectionPath(args[<span class="hljs-number">0</span>]);<br>    sslConfig.setClientKeyCertChainPath(args[<span class="hljs-number">1</span>]);<br>    sslConfig.setClientPrivateKeyPath(args[<span class="hljs-number">2</span>]);<br>&#125;<br></code></pre></td></tr></table></figure></blockquote><h3 id="令牌验证"><a class="markdownIt-Anchor" href="#令牌验证"></a> 令牌验证</h3><blockquote><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/examples/token-authorization/">使用文档 令牌验证</a></p><p><font size="5">通过令牌验证在注册中心控制权限</font></p><p><img src="https://dubbo.apache.org/imgs/user/dubbo-token.jpg" srcset="/img/loading.gif" lazyload alt></p><p><span style="border-bottom:2px dashed green">通过令牌验证在注册中心控制权限，以决定要不要下发令牌给消费者，可以防止消费者绕过注册中心访问提供者，</span>另外通过注册中心可灵活改变授权方式，而不需修改或升级提供者</p><hr><p><strong>服务端 全局配置</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">dubbo:</span><br>  <span class="hljs-attr">provider:</span><br>    <span class="hljs-attr">token:</span> <span class="hljs-string">&#x27;true&#x27;</span>  <span class="hljs-comment"># 随机token令牌，使用UUID生成</span><br></code></pre></td></tr></table></figure><p>或</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">dubbo:</span><br>  <span class="hljs-attr">provider:</span><br>    <span class="hljs-attr">token:</span> <span class="hljs-string">&#x27;123456&#x27;</span>  <span class="hljs-comment"># 固定token令牌，相当于密码</span><br></code></pre></td></tr></table></figure><hr><p><strong>服务端 <code>服务级别</code> 配置</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DubboService(token = &quot;true&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">xxxServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">xxxService</span>&#123;<br>...<br>&#125;<br></code></pre></td></tr></table></figure><p>或</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DubboService(token = &quot;123456&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">xxxServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">xxxService</span>&#123;<br>...<br>&#125;<br></code></pre></td></tr></table></figure><hr><p>测试 本地直连会抛出异常</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoadBalanceTest</span> &#123;<br>    <span class="hljs-comment">// 绕过注册中心 本地直连方式</span><br>    <span class="hljs-meta">@DubboReference(url = &quot;dubbo://localhost:20880&quot;)</span><br>    LoadBalanceService loadBalanceService;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>        IntStream.range(<span class="hljs-number">0</span>, <span class="hljs-number">20</span>). forEach(line -&gt; log.info(loadBalanceService.hello(String.valueOf(line))));<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// org.apache.dubbo.rpc.RpcException: Invalid token! Forbid invoke remote service in\terface ...</span><br></code></pre></td></tr></table></figure></blockquote><h3 id="路由规则"><a class="markdownIt-Anchor" href="#路由规则"></a> 路由规则</h3><blockquote><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/examples/routing-rule/">使用文档 路由规则</a></p><p><font size="5">通过 Dubbo 中的路由规则做服务治理</font></p><p><span style="border-bottom:2px dashed green">路由规则在发起一次RPC调用前起到过滤目标服务器地址的作用，过滤后的地址列表，将作为消费端最终发起RPC调用的备选地址</span></p><ul><li>条件路由。支持以服务或 Consumer 应用为粒度配置路由规则。</li><li>标签路由。以 Provider 应用为粒度配置路由规则。</li></ul><hr><p><strong><font size="4">条件路由</font></strong></p><p>您可以随时在服务治理控制台 <a target="_blank" rel="noopener" href="https://github.com/apache/dubbo-admin">Dubbo-Admin</a> 写入路由规则</p><p>admin 控制台具体配置参考使用文档</p></blockquote><h3 id="配置规则"><a class="markdownIt-Anchor" href="#配置规则"></a> 配置规则</h3><blockquote><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/examples/config-rule/">使用文档 规则配置</a></p><p><font size="5">在 Dubbo 中配置应用级治理规则和服务级治理规则</font></p><blockquote><p><strong>提示</strong></p><p>本文描述的是新版本规则配置，而不是<a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/examples/config-rule-deprecated">老版本配置规则</a></p></blockquote><p>覆盖规则是 Dubbo 设计的在无需重启应用的情况下，动态调整 RPC 调用行为的一种能力。2.7.0 版本开始，支持从<strong>服务</strong>和<strong>应用</strong>两个粒度来调整动态配置</p><p>请在<a target="_blank" rel="noopener" href="http://47.91.207.147/#/governance/config">服务治理控制台</a>查看或修改覆盖规则 「动态配置」</p><p>使用请查看使用文档</p></blockquote><h3 id="优雅停机"><a class="markdownIt-Anchor" href="#优雅停机"></a> 优雅停机</h3><blockquote><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/examples/graceful-shutdown/#m-zhdocsv27userexamplesgraceful-shutdown">使用文档 优雅停机</a></p><p><font size="5">让 Dubbo 服务完成优雅停机</font></p><p><span style="border-bottom:2px dashed green">Dubbo 是通过 JDK 的 ShutdownHook 来完成优雅停机的，所以如果用户使用 <code>kill -9 PID</code> 等强制关闭指令，是不会执行优雅停机的，只有通过 <code>kill PID</code> 时，才会执行</span></p><hr><p><font size="5">原理</font></p><p><strong>服务提供方</strong></p><ul><li>停止时，先标记为不接收新请求，新请求过来时直接报错，让客户端重试其它机器（默认的集群容错 Failover）</li><li>然后，检测线程池中的线程是否正在运行，如果有，等待所有线程执行完成，除非超时，则强制关闭</li></ul><p><strong>服务消费方</strong></p><ul><li>停止时，不再发起新的调用请求，所有新的调用在客户端即报错</li><li>然后，检测有没有请求的响应还没有返回，等待响应返回，除非超时，则强制关闭</li></ul><hr><p><font size="5">设置方式</font></p><p>设置优雅停机超时时间，缺省超时时间是 10 秒，如果超时则强制关闭</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">dubbo:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">shutwait:</span> <span class="hljs-number">15000</span><br></code></pre></td></tr></table></figure><p>如果 ShutdownHook 不能生效，可以自行调用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">DubboShutdownHook.destroyAll();<br></code></pre></td></tr></table></figure><blockquote><p><strong>建议</strong></p><p>使用 tomcat 等容器部署的场景，建议通过扩展 ContextListener 等自行调用以下代码实现优雅停机</p></blockquote></blockquote><h3 id="主机绑定"><a class="markdownIt-Anchor" href="#主机绑定"></a> 主机绑定</h3><blockquote><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/examples/hostname-binding/#m-zhdocsv27userexampleshostname-binding">使用文档 主机绑定</a></p><p><font size="5">在 Dubbo 中绑定主机名</font></p><hr><p><font size="4">查找顺序</font></p><p>缺省主机 IP 查找顺序：</p><ul><li>通过 <code>LocalHost.getLocalHost()</code> 获取本机地址</li><li>如果是 <code>127.*</code> 等 loopback 地址，则扫描各网卡，获取网卡 IP</li></ul><hr><p><font size="4">主机配置</font></p><p>注册的地址如果获取不正确，比如需要注册公网地址，可以：</p><ol><li><p>可以在 <code>/etc/hosts</code> 中加入：机器名 公网 IP，比如：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">test1</span> <span class="hljs-number">205.182.23.201</span><br></code></pre></td></tr></table></figure></li><li><p>在 <code>dubbo.xml</code> 中加入主机地址的配置：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dubbo:protocol</span> <span class="hljs-attr">host</span>=<span class="hljs-string">&quot;205.182.23.201&quot;</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>Yml 文件:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">dubbo:</span>  <br>  <span class="hljs-attr">protocol:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-string">&#x27;205.182.23.201&#x27;</span><br></code></pre></td></tr></table></figure></li><li><p>或在 <code>dubbo.properties</code> 中加入主机地址的配置:</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">dubbo.protocol.host</span>=<span class="hljs-string">205.182.23.201</span><br></code></pre></td></tr></table></figure></li></ol><hr><p><font size="4">端口配置</font></p><p>缺省主机端口与协议相关：</p><table><thead><tr><th>协议</th><th>端口</th></tr></thead><tbody><tr><td>dubbo</td><td>20880</td></tr><tr><td>rmi</td><td>1099</td></tr><tr><td>http</td><td>80</td></tr><tr><td>hessian</td><td>80</td></tr><tr><td>webservice</td><td>80</td></tr><tr><td>memcached</td><td>11211</td></tr><tr><td>redis</td><td>6379</td></tr></tbody></table><p>可以按照下面的方式配置端口：</p><ol><li><p>在 <code>dubbo.xml</code> 中加入主机地址的配置：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dubbo:protocol</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dubbo&quot;</span> <span class="hljs-attr">port</span>=<span class="hljs-string">&quot;20880&quot;</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>在 <code>dubbo.properties</code> 中加入主机地址的配置：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">dubbo.protocol.dubbo.port</span>=<span class="hljs-string">20880</span><br></code></pre></td></tr></table></figure></li><li><p>yml 配置文件:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">dubbo:</span>  <br>  <span class="hljs-attr">protocol:</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">20880</span><br></code></pre></td></tr></table></figure></li></ol></blockquote><h3 id="主机配置"><a class="markdownIt-Anchor" href="#主机配置"></a> 主机配置</h3><blockquote><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/examples/set-host/">使用文档 主机配置</a></p><p><font size="5">自定义 Dubbo 服务对外暴露的主机地址</font></p><p>服务地址默认取值：<code>InetAddress.getLocalHost().getHostAddress()</code> 获取默认 host</p><p>主要解决服务提供者暴露服务的IP地址，可以指定 <code>内网地址</code> 或 <code>公网地址</code> 或者是 <code>一个域名</code></p><p>同时也可以解决 <code>docker</code> 映射</p><p>具体使用参考使用文档</p></blockquote><p>&lt;&lt;&lt;&lt;&lt;&lt;&lt; Updated upstream</p><h3 id="序列化框架"><a class="markdownIt-Anchor" href="#序列化框架"></a> 序列化框架</h3><p>=======</p><h3 id="序列化漫谈"><a class="markdownIt-Anchor" href="#序列化漫谈"></a> 序列化漫谈</h3><blockquote><blockquote><blockquote><blockquote><blockquote><blockquote><blockquote><p>Stashed changes</p></blockquote></blockquote></blockquote></blockquote></blockquote></blockquote></blockquote><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/serialization/#m-zhdocsv27userserialization">官方文档 序列化漫谈</a></p><table><thead><tr><th>框架</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td><strong>Kryo</strong></td><td>速度快，序列化后体积小</td><td>跨语言支持较复杂，字段增、减，序列化和反序列化时无法兼容</td></tr><tr><td><strong>Hessian</strong></td><td>默认支持跨语言</td><td>较慢，字段增、减，序列化和反序列化时可以兼容</td></tr><tr><td><strong>Protostuff</strong></td><td>速度快，基于protobuf</td><td>需静态编译，只能在末尾添加新字段</td></tr><tr><td><strong>Protostuff-Runtime</strong></td><td>无需静态编译，但序列化前需预先传入schema</td><td>不支持无默认构造函数的类，反序列化时需用户自己初始化序列化后的对象，其只负责将该对象进行赋值</td></tr><tr><td><strong>Java</strong></td><td>使用方便，可序列化所有类</td><td>速度慢，占空间</td></tr></tbody></table><h2 id="源码"><a class="markdownIt-Anchor" href="#源码"></a> 源码</h2><blockquote><p>**<a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/dev/source/dubbo-spi/#3-dubbo-spi-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90">源码部分只提供 DEMO 及运行结果，源码的解析请看最权威的官方文档</a> **</p></blockquote><h3 id="dubbo-spi"><a class="markdownIt-Anchor" href="#dubbo-spi"></a> Dubbo SPI</h3><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/dev/source/dubbo-spi/">官方文档 Dubbo SPI</a></p><blockquote><p>SPI 全称为 Service Provider Interface，是一种服务发现机制。SPI 的本质是将接口实现类的全限定名配置在文件中，并由服务加载器读取配置文件，加载实现类。这样可以在运行时，动态为接口替换实现类。正因此特性，我们可以很容易的通过 SPI 机制为我们的程序提供拓展功能。SPI 机制在第三方框架中也有所应用，比如 Dubbo 就是通过 SPI 机制加载所有的组件。不过，Dubbo 并未使用 Java 原生的 SPI 机制，而是对其进行了增强，使其能够更好的满足需求。在 Dubbo 中，SPI 是一个非常重要的模块。基于 SPI，我们可以很容易的对 Dubbo 进行拓展。如果大家想要学习 Dubbo 的源码，SPI 机制务必弄懂。接下来，我们先来了解一下 Java SPI 与 Dubbo SPI 的用法，然后再来分析 Dubbo SPI 的源码</p></blockquote><h4 id="java-spi"><a class="markdownIt-Anchor" href="#java-spi"></a> Java SPI</h4><blockquote><p><strong>定义 SPI 接口</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * SPI 接口</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Animal</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">name</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><hr><p><strong>接口实现</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Cat</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Animal</span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">name</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;cat&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Animal</span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">name</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;dog&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><hr><p><strong>resources <code>META-INF\services</code> 添加接口全限定名配置文件</strong></p><p><code>com.wgf.springboot.spi.java.Animal</code></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus">com<span class="hljs-selector-class">.wgf</span><span class="hljs-selector-class">.springboot</span><span class="hljs-selector-class">.spi</span><span class="hljs-selector-class">.java</span><span class="hljs-selector-class">.Cat</span><br>com<span class="hljs-selector-class">.wgf</span><span class="hljs-selector-class">.springboot</span><span class="hljs-selector-class">.spi</span><span class="hljs-selector-class">.java</span>.Dog<br></code></pre></td></tr></table></figure><hr><p><strong>使用 <code>ServiceLoader</code> 加载配置的实现类</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpiTest</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * java spi 机制</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">spiTest</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 加载 META-INF/services/com.wgf.springboot.spi.java.Animal 文件下配置的SPI接口实现类</span><br>        ServiceLoader&lt;Animal&gt; serviceLoader = ServiceLoader.load(Animal.class);<br>        log.info(<span class="hljs-string">&quot;Java SPI&quot;</span>);<br>        serviceLoader.forEach( line -&gt; line.name());<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// cat</span><br><span class="hljs-comment">// dog</span><br></code></pre></td></tr></table></figure></blockquote><h4 id="dubbo-扩展spi"><a class="markdownIt-Anchor" href="#dubbo-扩展spi"></a> Dubbo 扩展SPI</h4><blockquote><p><span style="border-bottom:2px dashed green">Dubbo 并未使用 Java SPI，而是重新实现了一套功能更强的 SPI 机制。Dubbo SPI 的相关逻辑被封装在了 ExtensionLoader 类中，通过 ExtensionLoader，我们可以加载指定的实现类。Dubbo SPI 所需的配置文件需放置在 META-INF/dubbo 路径下</span></p><p><strong>Java SPI 默认会加载配置文件下的所有配置类，在实际场景中很多 SPI 可能都不会被使用，造成资源浪费</strong></p><p>与 Java SPI 实现类配置不同，Dubbo SPI 是通过键值对的方式进行配置，这样我们可以按需加载指定的实现类。另外，在测试 Dubbo SPI 时，需要在 Robot 接口上标注 <code>@SPI</code> 注解</p><hr><p><strong>定义 SPI 接口</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SPI</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Robot</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><hr><p><strong>SPI 接口实现类</strong></p><p><strong>注意</strong>：SPI 接口的实现类必须有无参构造函数，因为 <code>ExtensionLoader</code> 底层是通过 <code>Class.getDeclaredConstructor()</code> 获取构造函数反射创建 SPI 实现类的</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OptimusPrime</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Robot</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Hello, I am Optimus Prime&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Bumblebee</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Robot</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Hello, I am Bumblebee&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><hr><p><strong>SPI 文件配置 <code>resources\META-INF\dubbo\com.wgf.springboot.spi.dubbo.Robot</code></strong></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus">optimusPrime = com<span class="hljs-selector-class">.wgf</span><span class="hljs-selector-class">.springboot</span><span class="hljs-selector-class">.spi</span><span class="hljs-selector-class">.dubbo</span><span class="hljs-selector-class">.OptimusPrime</span><br>bumblebee = com<span class="hljs-selector-class">.wgf</span><span class="hljs-selector-class">.springboot</span><span class="hljs-selector-class">.spi</span><span class="hljs-selector-class">.dubbo</span>.Bumblebee<br></code></pre></td></tr></table></figure><hr><p><strong>使用</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpiTest</span> &#123;<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-comment">// 扩展加载器， 类似 java spi 的 ServiceLoader</span><br>        ExtensionLoader&lt;Robot&gt; extensionLoader =<br>                ExtensionLoader.getExtensionLoader(Robot.class);<br><br>        <span class="hljs-comment">// 需要用到哪个 SPI 的实现类用对应的 key 进行加载</span><br>        <span class="hljs-comment">// 第一次调用 extensionLoader 方法时，默认会去解析 resources\META-INF\dubbo\com.wgf.springboot.spi.dubbo.Robot</span><br>        <span class="hljs-comment">// 将所有 SPI 配置类加载到 cachedNames 中缓存</span><br>        <span class="hljs-type">Robot</span> <span class="hljs-variable">optimusPrime</span> <span class="hljs-operator">=</span> extensionLoader.getExtension(<span class="hljs-string">&quot;optimusPrime&quot;</span>);<br>        optimusPrime.sayHello();<br><br>        <span class="hljs-type">Robot</span> <span class="hljs-variable">bumblebee</span> <span class="hljs-operator">=</span> extensionLoader.getExtension(<span class="hljs-string">&quot;bumblebee&quot;</span>);<br>        bumblebee.sayHello();<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//Hello, I am Optimus Prime</span><br><span class="hljs-comment">//Hello, I am Bumblebee</span><br></code></pre></td></tr></table></figure></blockquote><h4 id="dubbo-spi实现aop"><a class="markdownIt-Anchor" href="#dubbo-spi实现aop"></a> Dubbo SPI实现AOP</h4><blockquote><p><strong>AOP 具体实现类</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * dubbo SPI 的 AOP 使用 装饰者模式实现</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RobotWrapper</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Robot</span> &#123;<br>    <span class="hljs-keyword">private</span> Robot robot;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RobotWrapper</span><span class="hljs-params">(Robot robot)</span> &#123;<br>        <span class="hljs-built_in">this</span>.robot = robot;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> &#123;<br>        log.info(<span class="hljs-string">&quot;包装方法开始&quot;</span>);<br>        robot.sayHello();<br>        log.info(<span class="hljs-string">&quot;包装方法结束&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><hr><p><strong>SPI 文件配置 <code>resources\META-INF\dubbo\com.wgf.springboot.spi.dubbo.Robot</code> 添加AOP实现类全限定类名</strong></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus">optimusPrime = com<span class="hljs-selector-class">.wgf</span><span class="hljs-selector-class">.springboot</span><span class="hljs-selector-class">.spi</span><span class="hljs-selector-class">.dubbo</span><span class="hljs-selector-class">.OptimusPrime</span><br>bumblebee = com<span class="hljs-selector-class">.wgf</span><span class="hljs-selector-class">.springboot</span><span class="hljs-selector-class">.spi</span><span class="hljs-selector-class">.dubbo</span><span class="hljs-selector-class">.Bumblebee</span><br>com<span class="hljs-selector-class">.wgf</span><span class="hljs-selector-class">.springboot</span><span class="hljs-selector-class">.spi</span><span class="hljs-selector-class">.dubbo</span>.RobotWrapper<br></code></pre></td></tr></table></figure><hr><p><strong>测试</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpiTest</span> &#123;<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-comment">// 扩展加载器， 类似 java spi 的 ServiceLoader</span><br>        ExtensionLoader&lt;Robot&gt; extensionLoader =<br>                ExtensionLoader.getExtensionLoader(Robot.class);<br><br>        <span class="hljs-comment">// 需要用到哪个 SPI 的实现类用对应的 key 进行加载</span><br>        <span class="hljs-comment">// 第一次调用 extensionLoader 方法时，默认会去解析 resources\META-INF\dubbo\com.wgf.springboot.spi.dubbo.Robot</span><br>        <span class="hljs-comment">// 将所有 SPI 配置类加载到 cachedNames 中缓存</span><br>        <span class="hljs-type">Robot</span> <span class="hljs-variable">optimusPrime</span> <span class="hljs-operator">=</span> extensionLoader.getExtension(<span class="hljs-string">&quot;optimusPrime&quot;</span>);<br>        optimusPrime.sayHello();<br><br>        <span class="hljs-type">Robot</span> <span class="hljs-variable">bumblebee</span> <span class="hljs-operator">=</span> extensionLoader.getExtension(<span class="hljs-string">&quot;bumblebee&quot;</span>);<br>        bumblebee.sayHello();<br>    &#125;<br>&#125;<br><span class="hljs-comment">//17:10:18.053 [main] INFO com.wgf.springboot.spi.dubbo.RobotWrapper - 包装方法开始</span><br><span class="hljs-comment">//Hello, I am Optimus Prime</span><br><span class="hljs-comment">//17:10:18.053 [main] INFO com.wgf.springboot.spi.dubbo.RobotWrapper - 包装方法结束</span><br><span class="hljs-comment">//17:10:18.053 [main] INFO com.wgf.springboot.spi.dubbo.RobotWrapper - 包装方法开始</span><br><span class="hljs-comment">//Hello, I am Bumblebee</span><br><span class="hljs-comment">//17:10:18.053 [main] INFO com.wgf.springboot.spi.dubbo.RobotWrapper - 包装方法结束</span><br></code></pre></td></tr></table></figure></blockquote><h4 id="dubbo-spi实现ioc"><a class="markdownIt-Anchor" href="#dubbo-spi实现ioc"></a> Dubbo SPI实现IOC</h4><blockquote><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/dev/source/adaptive-extension/">官方文档 SPI 自适应拓展</a></p><p>对应于Adaptive机制，Dubbo提供了一个注解<code>@Adaptive</code>，该注解可以用于接口的某个子类上，也可以用于接口方法上。如果用在接口的子类上，则表示Adaptive机制的实现会按照该子类的方式进行自定义实现；如果用在方法上，则表示Dubbo会为该接口自动生成一个子类，并且按照一定的格式重写该方法，而其余没有标注<code>@Adaptive</code>注解的方法将会默认抛出异常</p><hr><p><strong>SPI 接口</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SPI</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">LoadBalance</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 自适应扩展，value用于指定 URL 的属性，通过解析URL 参数(loadbalance) 对应的 value 完成SPI注入</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> url</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Adaptive(&quot;loadbalance&quot;)</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">balance</span><span class="hljs-params">(URL url)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><hr><p><strong>SPI 实现类</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 装饰者模式</span><br><span class="hljs-comment"> * IOC 注入实现类，注入只能是注入SPI 实现类</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CommonLoadBalance</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">LoadBalance</span> &#123;<br>    <span class="hljs-keyword">private</span> LoadBalance loadBalance;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">balance</span><span class="hljs-params">(URL url)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;IOC 调用前&quot;</span>);<br>        loadBalance.balance(url);<br>        log.info(<span class="hljs-string">&quot;IOC 调用后&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 提供注入 set 方法</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> loadBalance</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setLoadBalance</span><span class="hljs-params">(LoadBalance loadBalance)</span> &#123;<br>        <span class="hljs-built_in">this</span>.loadBalance = loadBalance;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RandomLoadBalance</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">LoadBalance</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">balance</span><span class="hljs-params">(URL url)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;随机负载均衡策略&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WeightsLoadBalance</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">LoadBalance</span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">balance</span><span class="hljs-params">(URL url)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;权重负载均衡策略&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><hr><p>**SPI 文件配置 <code>resources\META-INF\dubbo\SPI 文件配置 resources\META-INF\dubbo\com.wgf.springboot.spi.dubbo.Robot 添加AOP实现类全限定类名</code> **</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus">randomLoadBalance=com<span class="hljs-selector-class">.wgf</span><span class="hljs-selector-class">.springboot</span><span class="hljs-selector-class">.spi</span><span class="hljs-selector-class">.dubbo</span><span class="hljs-selector-class">.ioc</span><span class="hljs-selector-class">.RandomLoadBalance</span><br>weightsLoadBalance=com<span class="hljs-selector-class">.wgf</span><span class="hljs-selector-class">.springboot</span><span class="hljs-selector-class">.spi</span><span class="hljs-selector-class">.dubbo</span><span class="hljs-selector-class">.ioc</span><span class="hljs-selector-class">.WeightsLoadBalance</span><br>commonLoadBalance=com<span class="hljs-selector-class">.wgf</span><span class="hljs-selector-class">.springboot</span><span class="hljs-selector-class">.spi</span><span class="hljs-selector-class">.dubbo</span><span class="hljs-selector-class">.ioc</span>.CommonLoadBalance<br></code></pre></td></tr></table></figure><hr><p><strong>测试</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IocTest</span> &#123;<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>        ExtensionLoader&lt;LoadBalance&gt; extensionLoader = ExtensionLoader.getExtensionLoader(LoadBalance.class);<br>        <span class="hljs-type">LoadBalance</span> <span class="hljs-variable">loadBalance</span> <span class="hljs-operator">=</span> extensionLoader.getExtension(<span class="hljs-string">&quot;commonLoadBalance&quot;</span>);<br>        <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> URL.valueOf(<span class="hljs-string">&quot;test://localhost/test?loadbalance=randomLoadBalance&quot;</span>);<br>        loadBalance.balance(url);<br><br>        url = URL.valueOf(<span class="hljs-string">&quot;test://localhost/test?loadbalance=weightsLoadBalance&quot;</span>);<br>        loadBalance.balance(url);<br>    &#125;<br>&#125;<br><span class="hljs-comment">//18:05:21.306 [main] INFO com.wgf.springboot.spi.dubbo.ioc.CommonLoadBalance - IOC 调用前</span><br><span class="hljs-comment">//随机负载均衡策略</span><br><span class="hljs-comment">//18:05:21.321 [main] INFO com.wgf.springboot.spi.dubbo.ioc.CommonLoadBalance - IOC 调用后</span><br><span class="hljs-comment">//18:05:21.321 [main] INFO com.wgf.springboot.spi.dubbo.ioc.CommonLoadBalance - IOC 调用前</span><br><span class="hljs-comment">//权重负载均衡策略</span><br><span class="hljs-comment">//18:05:21.321 [main] INFO com.wgf.springboot.spi.dubbo.ioc.CommonLoadBalance - IOC 调用后</span><br></code></pre></td></tr></table></figure></blockquote><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css"></div><hr><div><div class="post-metas my-3"></div><div class="license-box my-3"><div class="license-title"><div>dubbo3</div><div>https://wugengfeng.cn/2022/07/13/dubbo3/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>wugengfeng</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2022年7月13日</div></div><div class="license-meta-item"><div>许可协议</div><div><a target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2022/08/18/zookeeper/" title="zookeeper"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">zookeeper</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2022/06/15/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/" title="netty核心原理"><span class="hidden-mobile">netty核心原理</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目录</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",function(){NProgress.done()})</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t){var e=Fluid.plugins.typing,i=t.getElementById("subtitle");i&&e&&e(i.getAttribute("data-typed-text"))}((window,document))</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",function(){var t,o=jQuery("#toc");0!==o.length&&window.tocbot&&(t=jQuery("#board-ctn").offset().top,window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-t},CONFIG.toc)),0<o.find(".toc-list-item").length&&o.css("visibility","visible"),Fluid.events.registerRefreshCallback(function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;0<t.find(".toc-list-item").length&&t.css("visibility","visible")}}))})</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",function(){Fluid.plugins.fancyBox()})</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>