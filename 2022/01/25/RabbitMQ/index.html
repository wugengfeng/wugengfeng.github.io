<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="stylesheet" href="https://npm.elemecdn.com/lxgw-wenkai-screen-webfont/style.css" media="print" onload='this.media="all"'><link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png"><link rel="icon" href="/img/fluid.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="wugengfeng"><meta name="keywords" content="wugengfeng"><meta name="description" content="思维导图  MQ的相关概念  MQ介绍 MQ（Message Queue）消息队列是一种基本的数据结构，遵循先进先出 （FIFO） 原则。它通过将待传递的数据（消息）存储在队列中，利用队列机制来实现消息的传递。在这个模型中，生产者生成消息并将其放入队列，而消费者则负责处理这些消息。消费者可以主动从指定队列中拉取消息，或者通过订阅特定队列来接收MQ服务端推送的消息。这种方式实现了可靠的消息传递和异步"><meta property="og:type" content="article"><meta property="og:title" content="RabbitMQ"><meta property="og:url" content="https://wugengfeng.cn/2022/01/25/RabbitMQ/index.html"><meta property="og:site_name" content="技术博客"><meta property="og:description" content="思维导图  MQ的相关概念  MQ介绍 MQ（Message Queue）消息队列是一种基本的数据结构，遵循先进先出 （FIFO） 原则。它通过将待传递的数据（消息）存储在队列中，利用队列机制来实现消息的传递。在这个模型中，生产者生成消息并将其放入队列，而消费者则负责处理这些消息。消费者可以主动从指定队列中拉取消息，或者通过订阅特定队列来接收MQ服务端推送的消息。这种方式实现了可靠的消息传递和异步"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://wugengfeng.cn/img/banner/rabbitmq.png"><meta property="article:published_time" content="2022-01-25T15:09:28.000Z"><meta property="article:modified_time" content="2023-10-10T08:13:21.422Z"><meta property="article:author" content="wugengfeng"><meta property="article:tag" content="wugengfeng"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://wugengfeng.cn/img/banner/rabbitmq.png"><meta name="baidu-site-verification" content="codeva-uJ0fkFPmHB"><title>RabbitMQ - 技术博客</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="/css/custom.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var dntVal,CONFIG={hostname:"wugengfeng.cn",root:"/",version:"1.9.3",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!1,element:"h9",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:1},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!1,follow_dnt:!0,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml"};CONFIG.web_analytics.follow_dnt&&(dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on")))</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="技术博客" type="application/atom+xml"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>吴耿锋</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> <span>首页</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> <span>归档</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> <span>分类</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> <span>标签</span></a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> <span>关于</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="RabbitMQ"></span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2022-01-25 23:09" pubdate>2022年1月25日 晚上</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 65k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 544 分钟</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 style="display:none">RabbitMQ</h1><div class="markdown-body"><p><a target="_blank" rel="noopener" href="https://mubu.com/doc/4nPxE1zM0m2#m">思维导图</a></p><h2 id="mq的相关概念"><a class="markdownIt-Anchor" href="#mq的相关概念"></a> MQ的相关概念</h2><h3 id="mq介绍"><a class="markdownIt-Anchor" href="#mq介绍"></a> MQ介绍</h3><p>MQ（Message Queue）消息队列是一种基本的数据结构，遵循先进先出 <code>（FIFO）</code> 原则。它通过将待传递的数据（消息）存储在队列中，利用队列机制来实现消息的传递。<span class="green-line">在这个模型中，生产者生成消息并将其放入队列，而消费者则负责处理这些消息。消费者可以主动从指定队列中拉取消息，或者通过订阅特定队列来接收MQ服务端推送的消息。这种方式实现了可靠的消息传递和异步通信。</span></p><h3 id="mq的作用"><a class="markdownIt-Anchor" href="#mq的作用"></a> MQ的作用</h3><p>消息队列中间件是分布式系统中重要的组件，主要解决应用解耦，异步消息，流量削锋等问题，实现高性能，高可用，可伸缩和最终一致性架构。</p><p class="note note-primary">削峰</p><p>在高并发场景下，通过消息队列实现异步业务处理，可以有效提升系统的高峰期业务处理能力，避免系统瘫痪。</p><p><img src="/2022/01/25/RabbitMQ/%E5%89%8A%E5%B3%B0.png" srcset="/img/loading.gif" lazyload alt></p><p>如果订单系统最多能处理一万次订单，这个处理能力应付正常时段的下单时绰绰有余，正常时段我们下单一秒后就能返回结果。但是在高峰期，如果有两万次下单操作系统是处理不了的，只能限制订单超过一万后不允许用户下单。使用消息队列做缓冲，我们可以取消这个限制，把一秒内下的订单分散成一段时间来处理，这时有些用户可能在下单十几秒后才能收到下单成功的操作，但是比不能下单的体验要好</p><p class="note note-primary">解耦</p><p><img src="/2022/01/25/RabbitMQ/%E8%A7%A3%E8%80%A6.png" srcset="/img/loading.gif" lazyload alt></p><p>当一个业务需要多个模块协同工作，或者一条消息需要被多个系统处理时，可以通过发送一条消息队列（MQ）来解耦这些模块。主业务完成后，只需发送MQ消息，其他模块可以独立地消费这些消息，从而实现业务功能，降低了模块之间的耦合度。</p><p class="note note-primary">异步</p><p><img src="/2022/01/25/RabbitMQ/%E5%BC%82%E6%AD%A5.png" srcset="/img/loading.gif" lazyload alt></p><p>主要业务执行完毕后，附属业务通过消息队列（MQ）以异步方式处理，以缩短业务响应时间，从而改善用户体验。</p><h3 id="mq-的分类"><a class="markdownIt-Anchor" href="#mq-的分类"></a> MQ 的分类</h3><p class="note note-primary">ActiveMQ</p><p><code>低吞吐</code></p><p><strong>优点</strong>：单机吞吐量高达万级，消息时效性在毫秒级别，具备高可用性，采用主从架构提供稳健的高可用性支持，具有较低的消息可靠性风险，降低了数据丢失的概率。</p><p><strong>缺点</strong>：当前官方社区对ActiveMQ 5.x的维护逐渐减少，因此在高吞吐量场景下的使用相对较少。</p><p class="note note-primary">Kafka</p><p><code>高吞吐</code> <code>队列数量和性能成反比</code></p><p><strong>优点</strong>： Kafka以其高吞吐量著称，单机写入每秒可达百万条消息。它具有出色的性能表现，时效性达毫秒级，以及高可用性。作为分布式系统，Kafka能够在多个节点上保留数据的多个副本，即使个别节点宕机也不会丢失数据或导致不可用情况。消费者可以通过拉取（Pull）方式获取消息，保证消息有序性，以及确保每条消息被消费且仅被消费一次。Kafka还受益于优秀的第三方管理界面Kafka-Manager。在日志领域，Kafka应用成熟广泛，得到多家公司和开源项目的采用。它主要用于大数据领域的实时计算（例如Flink、CDC、ETL）以及日志采集，提供简单MQ功能和可靠的消息传递。</p><p><strong>缺点</strong>：Kafka在单机支持队列/分区超过64个时，可能导致负载明显升高。增多的队列数量会降低发送消息的响应时间，因为使用短轮询方式，实时性受轮询间隔时间影响。此外，Kafka不直接支持消费失败的消息重试，这需要由消费者自行处理。尽管它支持消息顺序，但当代理宕机时可能会导致消息乱序。需要注意的是，Kafka社区更新相对缓慢，这可能影响到新功能的发布和问题修复的速度。</p><p class="note note-primary">RocketMQ</p><p><code>中吞吐</code> <code>功能比kafka丰富</code> <code>支持语言不多</code></p><p><strong>优点</strong>：RocketMQ以中等吞吐量的性能表现著称，单机吞吐量可达十万级。它拥有出色的可用性，并采用分布式架构，因此能够实现消息的高可靠性，几乎可以做到零消息丢失。RocketMQ的MQ功能相对丰富，且它是一个分布式系统，因此具备出色的扩展性，能够支持高达10亿条消息的堆积，而不会因此导致性能下降。需要指出的是，RocketMQ是使用Java实现的，尽管它在某些设计思想上可能受到了Kafka的影响。</p><p><strong>缺点</strong>：对于支持的客户端语言，RocketMQ主要支持Java和C++，但需要指出的是C++的客户端支持相对不够成熟。此外，RocketMQ的社区活跃度一般，相对于某些其他消息队列系统，社区支持有限。此外，RocketMQ并没有在其核心中实现JMS等接口，因此在将某些系统迁移到RocketMQ时可能需要修改大量的代码。</p><p class="note note-primary">RabbitMQ</p><p><code>低吞吐</code> <code>功能齐全</code> <code>多语言</code></p><p>Kafka是一个于2007年发布的消息中间件系统，它在高级消息队列协议（AMQP）的基础上开发而成，被广泛认为是当前最主流的消息中间件之一。</p><p><strong>优点</strong>：RabbitMQ得益于Erlang语言的高并发特性，具备出色的性能。它支持每秒万级别的吞吐量，拥有完善的消息队列（MQ）功能，以及强大的健壮性和稳定性。RabbitMQ易于使用，跨平台支持多种编程语言，包括Python、Ruby、.NET、Java、JMS、C、PHP、ActionScript、XMPP、STOMP等。该系统提供了全面的文档支持，并且具备出色的开源管理界面，为用户提供极佳的使用体验。RabbitMQ拥有活跃的社区支持，更新频率相当高。</p><p><strong>缺点</strong>：商业版需要收费，学习成本较高。</p><h3 id="mq的选择"><a class="markdownIt-Anchor" href="#mq的选择"></a> MQ的选择</h3><ol><li><p><strong>Kafka</strong>:</p><p>特点：Kafka采用基于Pull的消息消费模式，追求高吞吐量。最初设计用于日志收集和传输，非常适合处理产生大量数据的互联网服务的数据收集业务。对于大型公司，尤其是需要日志采集功能、CDC、ETL的场景，Kafka是首选。</p></li><li><p><strong>RocketMQ</strong>:</p><p>特点：RocketMQ天生为金融互联网领域而生，特别适用于对可靠性要求极高的场景，例如电商中的订单扣款以及业务削峰。在大量交易涌入时，RocketMQ可以保证后端能够及时处理。其稳定性在阿里双11等大型活动中得到了多次验证。如果您的业务涉及到这些高并发场景，强烈建议选择RocketMQ。</p></li><li><p><strong>RabbitMQ</strong>:</p><p>特点：RabbitMQ结合Erlang语言本身的并发优势，具有出色的性能和微秒级的时效性。社区活跃度高，管理界面也非常便捷。如果您的数据量规模不是特别大，尤其对于中小型公司而言，建议优先选择功能比较完备的RabbitMQ。</p></li></ol><h3 id="mq的缺点"><a class="markdownIt-Anchor" href="#mq的缺点"></a> MQ的缺点</h3><ol><li><p>系统可用性降低。依赖服务也多，服务越容易挂掉。需要考虑MQ瘫痪的情况</p></li><li><p>系统复杂性提高。需要考虑<code>消息丢失</code>、消息<code>重复消费</code>、消息传递的<code>顺序性</code></p></li><li><p>业务一致性。主业务和从属业务一致性的处理</p></li></ol><h2 id="前置"><a class="markdownIt-Anchor" href="#前置"></a> 前置</h2><p><a target="_blank" rel="noopener" href="https://github.com/wugengfeng/rabbitmq-demo">项目源码</a></p><p><strong>docker快速安装</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker pull rabbitmq:management<br><br>docker run -di --name=rabbitmq -p 5671:5671 -p 5672:5672 -p 4369:4369 -p 15671:15671 -p 15672:15672 -p 25672:25672 rabbitmq:management<br></code></pre></td></tr></table></figure><h2 id="rabbitmq-的概念"><a class="markdownIt-Anchor" href="#rabbitmq-的概念"></a> RabbitMQ 的概念</h2><p>RabbitMQ 是一个由 erlang 开发的 <a target="_blank" rel="noopener" href="https://www.jianshu.com/p/66bb8445ea6e">AMQP</a> (Advanced Message Queuing Protocol) 的开源实现</p><h3 id="生产者"><a class="markdownIt-Anchor" href="#生产者"></a> 生产者</h3><p>产生数据发送消息的程序是生产者，产生数据后投递到交换机中</p><h3 id="交换机"><a class="markdownIt-Anchor" href="#交换机"></a> 交换机</h3><p>交换机（Exchange）是RabbitMQ消息传递的核心组件之一。它的主要作用是接收生产者发送的消息，并根据特定的路由规则，将这些消息路由到一个或多个队列中。</p><h4 id="direct-exchange"><a class="markdownIt-Anchor" href="#direct-exchange"></a> Direct exchange</h4><p><code>直连交换机</code></p><ul><li><strong>定义与用途</strong>：<ul><li>直连交换机（Direct Exchange）是RabbitMQ中的基础交换机类型。</li><li>它的主要功能是根据消息中的路由键（Routing Key）将消息准确地路由到对应的队列。</li></ul></li><li><strong>路由键匹配</strong>：<ul><li>在直连交换机下，路由键必须进行精确匹配。</li><li>只有当消息的Routing Key与队列绑定的Routing Key完全一致时，消息才会被投递到该队列。</li></ul></li><li><strong>队列与路由键的关系</strong>：<ul><li>一个队列可以绑定到多个Routing Key。</li><li>这为消息的灵活路由提供了可能性。</li></ul></li><li><strong>操作步骤</strong>：<ol><li>将队列绑定到直连交换机，并为该绑定指定一个路由键。</li><li>当消息携带的路由键与某个队列的绑定路由键匹配时，交换机将消息路由到该队列。</li></ol></li></ul><p><img src="/2022/01/25/RabbitMQ/%E7%9B%B4%E8%BF%9E%E4%BA%A4%E6%8D%A2%E6%9C%BA.png" srcset="/img/loading.gif" lazyload alt></p><p class="note note-primary">demo</p><p>添加队列和交换机配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DirectConfig</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DIRECT_EXCHANGE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;direct_exchange&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DIRECT_QUEUE</span>  <span class="hljs-operator">=</span> <span class="hljs-string">&quot;direct.queue&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ROUTING_KEY</span>  <span class="hljs-operator">=</span> <span class="hljs-string">&quot;queue&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建队列</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">directQueue</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(DIRECT_QUEUE);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建交换机</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> DirectExchange <span class="hljs-title function_">directExchange</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DirectExchange</span>(DIRECT_EXCHANGE);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 绑定队列</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> directQueue</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> directExchange</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">bindDirectQueue</span><span class="hljs-params">(Queue directQueue, DirectExchange directExchange)</span> &#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(directQueue).to(directExchange).with(ROUTING_KEY);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>添加队列监听</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DirectListener</span> &#123;<br>    <span class="hljs-meta">@RabbitListener(queues = DirectConfig.DIRECT_QUEUE)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">receive</span><span class="hljs-params">(String msg)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;队列 &#123;&#125; 接收信息:&#123;&#125;&quot;</span>, DirectConfig.DIRECT_QUEUE, msg);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>单元测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendDirect</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>       <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">2</span>; i++) &#123;<br>           rabbitTemplate.convertAndSend(DirectConfig.DIRECT_EXCHANGE, DirectConfig.ROUTING_KEY, i+ <span class="hljs-string">&quot;&quot;</span>);<br>       &#125;<br>       TimeUnit.SECONDS.sleep(<span class="hljs-number">10</span>);<br>   &#125;<br></code></pre></td></tr></table></figure><p>日志</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs verilog">INFO <span class="hljs-number">28275</span> --- [ntContainer#<span class="hljs-number">0</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.DirectListener</span>     : 队列 direct<span class="hljs-variable">.queue</span> 接收信息:<span class="hljs-number">0</span><br>INFO <span class="hljs-number">28275</span> --- [ntContainer#<span class="hljs-number">0</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.DirectListener</span>     : 队列 direct<span class="hljs-variable">.queue</span> 接收信息:<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><h4 id="topic-exchange"><a class="markdownIt-Anchor" href="#topic-exchange"></a> Topic exchange</h4><p><code>主题交换机</code></p><ol><li><code>定义与用途</code>： 主题交换机（Topic Exchange）是RabbitMQ中一种灵活且功能丰富的交换机类型，主要用于实现复杂的消息路由规则，允许一条消息根据路由键模糊匹配，被投递到多个队列。</li><li><code>基本特性</code>：<ul><li>主题交换机是直连交换机的扩展，允许一个队列绑定多个Routing Key。</li><li>它通过路由键的模糊匹配，能够将消息路由到一个或多个绑定队列。</li></ul></li><li><code>路由键规则</code>： 发送到主题交换机的消息的Routing Key必须是由点号（.）分隔的单词列表，如：“stock.usd.nyse”, “nyse.vmw”, “quick.orange.rabbit”。这些单词没有特定要求，但整个路由键的长度不得超过255个字节。</li><li><code>通配符</code>： 主题交换机在匹配路由键时，支持两种通配符：<ul><li><code>*</code>（星号）：匹配路由键中的一个单词。</li><li><code>#</code>（井号）：匹配路由键中的零或多个单词。</li></ul></li><li><code>灵活性</code>： 通过模糊匹配和通配符的使用，主题交换机能够满足多样化和复杂的消息路由需求，展现出极高的灵活性。</li></ol><p><img src="/2022/01/25/RabbitMQ/%E4%B8%BB%E9%A2%98%E4%BA%A4%E6%8D%A2%E6%9C%BA.png" srcset="/img/loading.gif" lazyload alt></p><p><img src="/2022/01/25/RabbitMQ/topic%E4%BA%A4%E6%8D%A2%E6%9C%BA.png" srcset="/img/loading.gif" lazyload alt></p><ul><li><code>quick.orange.rabbit</code> 被队列 Q1Q2 接收到</li><li><code>lazy.orange.elephant</code> 被Q1Q3 接收到</li><li><code>quick.orange.fox</code> 被队列 Q1 接收到</li><li><code>lazy.brown.fox</code> 被队列 Q2 接收到</li><li><code>quick.brown.fox</code> 不匹配任何绑定不会被任何队列接收到会被丢弃</li></ul><p class="note note-primary">demo</p><p>添加队列和交换机配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TopicConfig</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TOPIC_EXCHANGE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;topic_exchange&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TOPIC_QUEUE_1</span>  <span class="hljs-operator">=</span> <span class="hljs-string">&quot;topic.queue1&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TOPIC_QUEUE_2</span>  <span class="hljs-operator">=</span> <span class="hljs-string">&quot;topic.queue2&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ROUTING_KEY</span>    <span class="hljs-operator">=</span> <span class="hljs-string">&quot;topic.test&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ROUTING_KEY2</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&quot;topic.#&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建队列</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">topicQueue1</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(TOPIC_QUEUE_1);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建队列</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">topicQueue2</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(TOPIC_QUEUE_2);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建交换机</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> TopicExchange <span class="hljs-title function_">topicExchange</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TopicExchange</span>(TOPIC_EXCHANGE);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 绑定队列</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> topicQueue1</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> topicExchange</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">bindTopicQueue1</span><span class="hljs-params">(Queue topicQueue1, TopicExchange topicExchange)</span> &#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(topicQueue1).to(topicExchange).with(ROUTING_KEY);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 绑定队列</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> topicQueue1</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> topicExchange</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">bindTopicQueue2</span><span class="hljs-params">(Queue topicQueue2, TopicExchange topicExchange)</span> &#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(topicQueue2).to(topicExchange).with(ROUTING_KEY2);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>添加队列监听</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TopicListener</span> &#123;<br>    <span class="hljs-meta">@RabbitListener(queues = TopicConfig.TOPIC_QUEUE_1)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">receive</span><span class="hljs-params">(String msg)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;队列 &#123;&#125; 接收信息:&#123;&#125;&quot;</span>, TopicConfig.TOPIC_QUEUE_1, msg);<br>    &#125;<br><br>    <span class="hljs-meta">@RabbitListener(queues = TopicConfig.TOPIC_QUEUE_2)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">receive2</span><span class="hljs-params">(String msg)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;队列 &#123;&#125; 接收信息:&#123;&#125;&quot;</span>, TopicConfig.TOPIC_QUEUE_2, msg);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>单元测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendTopic</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>    rabbitTemplate.convertAndSend(TopicConfig.TOPIC_EXCHANGE, TopicConfig.ROUTING_KEY, TopicConfig.ROUTING_KEY);<br>    rabbitTemplate.convertAndSend(TopicConfig.TOPIC_EXCHANGE, <span class="hljs-string">&quot;topic.hello&quot;</span>, <span class="hljs-string">&quot;topic.hello&quot;</span>);<br>    rabbitTemplate.convertAndSend(TopicConfig.TOPIC_EXCHANGE, <span class="hljs-string">&quot;topic.hi.hello&quot;</span>, <span class="hljs-string">&quot;topic.hi.hello&quot;</span>);<br>    TimeUnit.SECONDS.sleep(<span class="hljs-number">10</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>日志</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs verilog">INFO <span class="hljs-number">10456</span> --- [ntContainer#<span class="hljs-number">0</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.TopicListener</span>      : 队列 topic<span class="hljs-variable">.queue1</span> 接收信息:topic<span class="hljs-variable">.test</span><br>INFO <span class="hljs-number">10456</span> --- [ntContainer#<span class="hljs-number">1</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.TopicListener</span>      : 队列 topic<span class="hljs-variable">.queue2</span> 接收信息:topic<span class="hljs-variable">.test</span><br>INFO <span class="hljs-number">10456</span> --- [ntContainer#<span class="hljs-number">1</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.TopicListener</span>      : 队列 topic<span class="hljs-variable">.queue2</span> 接收信息:topic<span class="hljs-variable">.hi</span><span class="hljs-variable">.hello</span><br>INFO <span class="hljs-number">10456</span> --- [ntContainer#<span class="hljs-number">1</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.TopicListener</span>      : 队列 topic<span class="hljs-variable">.queue2</span> 接收信息:topic<span class="hljs-variable">.hello</span><br></code></pre></td></tr></table></figure><h4 id="fanout-exchange"><a class="markdownIt-Anchor" href="#fanout-exchange"></a> Fanout exchange</h4><p><code>扇出交换机</code></p><ol><li><code>无需路由键</code>： 扇出交换机（Fanout Exchange）在进行消息路由时，不需要路由键（Routing Key）。即便消息中包含路由键，该键也不会影响消息的路由过程。</li><li><code>广播特性</code>： 当消息发送到扇出交换机时，该交换机会将消息转发给所有绑定到它的队列，实现了一种广播的效果。</li><li><code>多队列绑定</code>： 如果有N个队列绑定到某个扇出交换机上，当有消息发送给该交换机时，交换机会将消息发送给这所有的N个队列，确保每个队列都能收到消息的拷贝。</li></ol><p><img src="/2022/01/25/RabbitMQ/%E6%89%87%E5%BD%A2%E4%BA%A4%E6%8D%A2%E6%9C%BA.png" srcset="/img/loading.gif" lazyload alt></p><p class="note note-primary">demo</p><p>添加队列交换机配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FanoutConfig</span> &#123;<br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">FANOUT_EXCHANGE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;fanout_exchange&quot;</span>;<br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">FANOUT_QUEUE_1</span>  <span class="hljs-operator">=</span> <span class="hljs-string">&quot;fanout.queue_1&quot;</span>;<br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">FANOUT_QUEUE_2</span>  <span class="hljs-operator">=</span> <span class="hljs-string">&quot;fanout.queue_2&quot;</span>;<br><br> <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建队列</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">fanoutQueue1</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(FANOUT_QUEUE_1);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建队列</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">fanoutQueue2</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(FANOUT_QUEUE_2);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建交换机</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> FanoutExchange <span class="hljs-title function_">fanoutExchange</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FanoutExchange</span>(FANOUT_EXCHANGE);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 绑定队列</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> fanoutQueue1</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> fanoutExchange</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">bindFanoutQueue1</span><span class="hljs-params">(Queue fanoutQueue1, FanoutExchange fanoutExchange)</span> &#123;<br>        <span class="hljs-comment">// 不需要 routing_key</span><br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(fanoutQueue1).to(fanoutExchange);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 绑定队列</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> fanoutQueue2</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> fanoutExchange</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">bindFanoutQueue</span><span class="hljs-params">(Queue fanoutQueue2, FanoutExchange fanoutExchange)</span> &#123;<br>        <span class="hljs-comment">// 不需要 routing_key</span><br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(fanoutQueue2).to(fanoutExchange);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>添加队列监听</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FanoutListener</span> &#123;<br>    <span class="hljs-meta">@RabbitListener(queues = FanoutConfig.FANOUT_QUEUE_1)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">receive</span><span class="hljs-params">(String msg)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;队列 &#123;&#125; 接收信息:&#123;&#125;&quot;</span>, TopicConfig.TOPIC_QUEUE_1, msg);<br>    &#125;<br><br>    <span class="hljs-meta">@RabbitListener(queues = FanoutConfig.FANOUT_QUEUE_2)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">receive2</span><span class="hljs-params">(String msg)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;队列 &#123;&#125; 接收信息:&#123;&#125;&quot;</span>, TopicConfig.TOPIC_QUEUE_2, msg);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>单元测试</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">sendFanout</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;<br>    rabbitTemplate.convertAndSend(FanoutConfig.FANOUT_EXCHANGE, <span class="hljs-keyword">null</span>, <span class="hljs-string">&quot;test&quot;</span>);<br>    TimeUnit.SECONDS.sleep(<span class="hljs-number">10</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>日志</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs verilog">INFO <span class="hljs-number">31660</span> --- [ntContainer#<span class="hljs-number">1</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.FanoutListener</span>     : 队列 topic<span class="hljs-variable">.queue1</span> 接收信息:test<br>INFO <span class="hljs-number">31660</span> --- [ntContainer#<span class="hljs-number">2</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.FanoutListener</span>     : 队列 topic<span class="hljs-variable">.queue2</span> 接收信息:test<br></code></pre></td></tr></table></figure><h4 id="headers-exchange"><a class="markdownIt-Anchor" href="#headers-exchange"></a> Headers exchange</h4><p><code>头交换机</code></p><ol><li><code>工作原理</code>： 头交换机（Headers Exchange）与主题交换机类似，但不是使用路由键来路由消息，而是使用消息头中的键值对来建立路由规则。通过判断消息头的键值对是否与绑定的条件相匹配，来确定消息的路由路径。</li><li><code>x-match 参数</code>： 头交换机有一个重要的参数：<code>x-match</code>，它决定了消息头的匹配规则。<ul><li>当 <code>x-match</code> 设置为 <code>any</code> 时，只要消息头中的任意一个键值对满足绑定条件，就视为匹配成功。</li><li>当 <code>x-match</code> 设置为 <code>all</code>（默认设置）时，消息头中的所有键值对都必须满足绑定条件，才视为匹配成功。</li></ul></li><li><code>性能考虑</code>： 由于头交换机在进行匹配时需要检查消息头中的多个属性，可能会导致性能较差，因此一般不推荐在对性能要求较高的场景中使用。</li></ol><p><img src="/2022/01/25/RabbitMQ/%E5%A4%B4%E9%83%A8%E4%BA%A4%E6%8D%A2%E6%9C%BA.png" srcset="/img/loading.gif" lazyload alt></p><p><img src="/2022/01/25/RabbitMQ/%E5%A4%B4%E4%BA%A4%E6%8D%A2%E6%9C%BA.png" srcset="/img/loading.gif" lazyload alt></p><p class="note note-primary">demo</p><p>添加队列交换机配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeadersConfig</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">HEADERS_EXCHANGE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;headers_exchange&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">HEADERS_QUEUE_1</span>  <span class="hljs-operator">=</span> <span class="hljs-string">&quot;headers.queue1&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">HEADERS_QUEUE_2</span>  <span class="hljs-operator">=</span> <span class="hljs-string">&quot;headers.queue2&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建队列</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">headersQueue1</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(HEADERS_QUEUE_1);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建队列</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">headersQueue2</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(HEADERS_QUEUE_2);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建交换机</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> HeadersExchange <span class="hljs-title function_">headersExchange</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HeadersExchange</span>(HEADERS_EXCHANGE);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 绑定队列</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> directQueue</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> directExchange</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">bindHeadersQueue1</span><span class="hljs-params">(Queue headersQueue1, HeadersExchange headersExchange)</span> &#123;<br>        <span class="hljs-comment">// 消息头属性</span><br>        Map&lt;String,Object&gt; headerMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(<span class="hljs-number">8</span>);<br>        headerMap.put(<span class="hljs-string">&quot;color&quot;</span>, <span class="hljs-string">&quot;black&quot;</span>);<br>        headerMap.put(<span class="hljs-string">&quot;aging&quot;</span>, <span class="hljs-string">&quot;fast&quot;</span>);<br>        <span class="hljs-comment">// whereAny 其中一项匹配即可</span><br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(headersQueue1).to(headersExchange).whereAny(headerMap).match();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 绑定队列</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> directQueue</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> directExchange</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">bindHeadersQueue2</span><span class="hljs-params">(Queue headersQueue2, HeadersExchange headersExchange)</span> &#123;<br>        <span class="hljs-comment">// 消息头属性</span><br>        Map&lt;String,Object&gt; headerMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(<span class="hljs-number">8</span>);<br>        headerMap.put(<span class="hljs-string">&quot;color&quot;</span>, <span class="hljs-string">&quot;black&quot;</span>);<br>        headerMap.put(<span class="hljs-string">&quot;aging&quot;</span>, <span class="hljs-string">&quot;fast&quot;</span>);<br>        <span class="hljs-comment">// whereAll 完全匹配</span><br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(headersQueue2).to(headersExchange).whereAll(headerMap).match();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>添加队列监听</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeadersListener</span> &#123;<br>    <span class="hljs-meta">@RabbitListener(queues = HeadersConfig.HEADERS_QUEUE_1)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">receive</span><span class="hljs-params">(String msg)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;队列 &#123;&#125; 接收信息:&#123;&#125;&quot;</span>, TopicConfig.TOPIC_QUEUE_1, msg);<br>    &#125;<br><br>    <span class="hljs-meta">@RabbitListener(queues = HeadersConfig.HEADERS_QUEUE_2)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">receive2</span><span class="hljs-params">(String msg)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;队列 &#123;&#125; 接收信息:&#123;&#125;&quot;</span>, TopicConfig.TOPIC_QUEUE_2, msg);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>单元测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendHeaders</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-type">MessageProperties</span> <span class="hljs-variable">messageProperties</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageProperties</span>();<br>        messageProperties.setHeader(<span class="hljs-string">&quot;color&quot;</span>, <span class="hljs-string">&quot;black&quot;</span>);<br>        <span class="hljs-type">SimpleMessageConverter</span> <span class="hljs-variable">messageConverter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleMessageConverter</span>();<br>        <span class="hljs-type">Message</span>                <span class="hljs-variable">message</span>          <span class="hljs-operator">=</span> messageConverter.toMessage(<span class="hljs-string">&quot;test1&quot;</span>, messageProperties);<br>        rabbitTemplate.convertAndSend(HeadersConfig.HEADERS_EXCHANGE, <span class="hljs-literal">null</span>, message);<br><br>        messageProperties.setHeader(<span class="hljs-string">&quot;aging&quot;</span>, <span class="hljs-string">&quot;fast&quot;</span>);<br>        message          = messageConverter.toMessage(<span class="hljs-string">&quot;test2&quot;</span>, messageProperties);<br>        rabbitTemplate.convertAndSend(HeadersConfig.HEADERS_EXCHANGE, <span class="hljs-literal">null</span>, message);<br>    &#125;<br></code></pre></td></tr></table></figure><p>日志</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs verilog">INFO <span class="hljs-number">4330</span> --- [ntContainer#<span class="hljs-number">3</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.HeadersListener</span>    : 队列 topic<span class="hljs-variable">.queue1</span> 接收信息:test1<br>INFO <span class="hljs-number">4330</span> --- [ntContainer#<span class="hljs-number">4</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.HeadersListener</span>    : 队列 topic<span class="hljs-variable">.queue2</span> 接收信息:test2<br>INFO <span class="hljs-number">4330</span> --- [ntContainer#<span class="hljs-number">3</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.HeadersListener</span>    : 队列 topic<span class="hljs-variable">.queue1</span> 接收信息:test2<br></code></pre></td></tr></table></figure><h4 id="默认交换机"><a class="markdownIt-Anchor" href="#默认交换机"></a> 默认交换机</h4><p><img src="/2022/01/25/RabbitMQ/%E9%BB%98%E8%AE%A4%E4%BA%A4%E6%8D%A2%E6%9C%BA.png" srcset="/img/loading.gif" lazyload alt></p><p><img src="/2022/01/25/RabbitMQ/%E9%BB%98%E8%AE%A4%E4%BA%A4%E6%8D%A2%E6%9C%BA%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81.png" srcset="/img/loading.gif" lazyload alt></p><p>默认交换机（Default Exchange）是RabbitMQ预先声明的一个特殊的直连交换机（Direct Exchange），其名称为空字符串。这个交换机具有以下特点，使其在简单应用中非常实用：</p><ol><li><code>自动绑定</code>： 每个新创建的队列都会自动绑定到默认交换机上。绑定时使用的路由键（Routing Key）与队列的名称相同。</li><li><code>简化的消息发送</code>： 由于每个队列都自动绑定到默认交换机，并使用队列名称作为路由键，因此在发送消息时，可以省略交换机的名称，直接使用队列名称作为<code>routing key</code>来发送消息。</li></ol><h3 id="队列"><a class="markdownIt-Anchor" href="#队列"></a> 队列</h3><p>队列是RabbitMQ的核心组件，作为一种内部数据结构，用于存储经过RabbitMQ的消息。尽管消息在RabbitMQ和应用程序之间流动，但它们实际上只能被存储在队列中。队列的容量基本上只受到主机内存和磁盘限制的约束，因此它可以被视为一个庞大的消息缓冲区。多个生产者可以向同一个队列发送消息，同时多个消费者也可以从一个队列中接收数据。</p><h4 id="临时队列"><a class="markdownIt-Anchor" href="#临时队列"></a> 临时队列</h4><p><code>没有消费者订阅时，自动删除</code></p><p><img src="/2022/01/25/RabbitMQ/%E4%B8%B4%E6%97%B6%E9%98%9F%E5%88%97.png" srcset="/img/loading.gif" lazyload alt></p><p>当消费者断开连接时，队列将会被删除。自动删除队列允许的消费者没有限制，也就是说<span class="green-line">当这个队列上最后一个消费者断开连接才会执行删除</span></p><h3 id="消费者"><a class="markdownIt-Anchor" href="#消费者"></a> 消费者</h3><p>消费者通常是指等待接收并处理消息的程序，这里的“消费”一词与“接收”含义相近。值得注意的是，生产者、消费者和消息中间件常常不会部署在同一台机器上。同时，一个应用程序有可能同时充当生产者和消费者的角色。</p><h5 id="获取消息的两种方式"><a class="markdownIt-Anchor" href="#获取消息的两种方式"></a> 获取消息的两种方式</h5><p class="note note-primary">推模式（Push）</p><p>推模式是RabbitMQ的 <code>默认</code> 消息获取模式，它以高效率和实时性为特点。</p><p>如果消费者处理消息的速率跟不上生产者的生产速度，可能会导致系统宕机。</p><p><code>优点</code>：在推模式下，消息会被提前推送给消费者，消费者需要设置一个 <code>缓冲区</code> 来缓存这些消息。这样，消费者总是有一批待处理的消息存储在内存中，从而保证了处理效率和数据的实时性。</p><p><code>缺点</code>：当大量消息在缓冲区堆积时，会给消费者端的服务带来较大的处理压力。如果消费者的处理能力无法满足大量消息的处理需求，可能会导致服务宕机。</p><p><span class="green-line">推模式常用的实现方式为spring-boot-starter-amqp的<code>@RabbitListener</code>注解</span></p><p class="note note-primary">拉模式（Pull）</p><p>拉模式允许消费者以可控的速率获取消息。</p><p>消息的实时性在此模式下依赖于消费者的拉取策略。</p><p>需要权衡拉取频率和消息的时效性，以避免资源浪费和处理延迟。</p><p><code>优点</code>：与推模式相比，拉模式的一大优势在于消费者可以根据自己的处理能力来拉取消息，这有助于防止因消息堆积导致的服务宕机。</p><p><code>缺点</code>：在拉模式下，消费者端需要不断地从服务器端拉取消息，处理完一定量的消息后再次进行拉取。设定拉取消息的间隔成为了一个挑战：间隔太短会导致消费者处于<code>忙等</code>状态，浪费资源；而间隔太长，则可能导致服务器端的消息未能及时处理。</p><p><span class="green-line"><strong>RabbitMQ</strong>支持客户端批量拉取消息，客户端可以连续调用 <code>basicGet</code> 方法拉取多条消息，处理完成之后一次性<code>ACK</code></span></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PullMsgService</span> &#123;<br><br> <span class="hljs-meta">@Autowired</span><br> RabbitTemplate rabbitTemplate;<br><br> <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 主动拉取消息</span><br><span class="hljs-comment">     * rabbitmq 提供 channel.basicGet API用于主动拉取消息</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> queueName 队列名称</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> count     每一批次获取总数</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> timeOut   超时时间，超时强制返回</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> consumer  业务实现</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pull</span><span class="hljs-params">(String queueName, Integer count, <span class="hljs-type">int</span> timeOut, Consumer&lt;List&lt;String&gt;&gt; consumer)</span> &#123;<br><br>        rabbitTemplate.execute(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelCallback</span>&lt;Object&gt;() &#123;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">doInRabbit</span><span class="hljs-params">(Channel channel)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>                List&lt;String&gt; msgList      = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>                <span class="hljs-type">long</span>         <span class="hljs-variable">start</span>        <span class="hljs-operator">=</span> System.currentTimeMillis();<br>                <span class="hljs-type">long</span>         end;<br>                GetResponse  response;<br>                <span class="hljs-type">GetResponse</span>  <span class="hljs-variable">lastResponse</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>                <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        end      = System.currentTimeMillis();<br>                        response = channel.basicGet(queueName, <span class="hljs-literal">false</span>);<br><br>                        <span class="hljs-keyword">if</span> (response == <span class="hljs-literal">null</span>) &#123;<br>                            <span class="hljs-keyword">if</span> (msgList.size() == <span class="hljs-number">0</span>) &#123;<br>                                log.info(<span class="hljs-string">&quot;没有消息&quot;</span>);<br>                                TimeUnit.SECONDS.sleep(<span class="hljs-number">5</span>);<br>                                start = System.currentTimeMillis();<br>                                <span class="hljs-keyword">continue</span>;<br>                            &#125;<br>                        &#125; <span class="hljs-keyword">else</span> &#123;<br>                            <span class="hljs-type">String</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(response.getBody(), <span class="hljs-string">&quot;utf-8&quot;</span>);<br>                            lastResponse = response;<br>                            msgList.add(msg);<br>                        &#125;<br><br>                        <span class="hljs-type">long</span> <span class="hljs-variable">step</span> <span class="hljs-operator">=</span> end - start;<br>                        <span class="hljs-keyword">if</span> ((step &gt; timeOut &amp;&amp; msgList.size() &gt; <span class="hljs-number">0</span>) || msgList.size() &gt;= count) &#123;<br>                            consumer.accept(msgList);<br>                            channel.basicAck(lastResponse.getEnvelope().getDeliveryTag(), <span class="hljs-literal">true</span>);<br>                            start = System.currentTimeMillis();<br>                            msgList.clear();<br>                        &#125;<br>                    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                        channel.basicNack(lastResponse.getEnvelope().getDeliveryTag(), <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>);<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="rabbitmq-名词解释"><a class="markdownIt-Anchor" href="#rabbitmq-名词解释"></a> RabbitMQ 名词解释</h3><p><img src="/2022/01/25/RabbitMQ/rabbitMQ%E6%9E%B6%E6%9E%84.png" srcset="/img/loading.gif" lazyload alt></p><ul><li><code>Broker</code>：是负责接收、存储和分发消息的应用程序，它构成了消息队列系统的核心组件。RabbitMQ Server便是一个典型的Message Broke</li><li><code>Virtual host</code>：Virtual Host（虚拟主机）是一种逻辑分组，它允许你在同一个RabbitMQ实例中隔离不同的环境。每个Virtual Host都有自己独立的Exchange（交换器）、Queue（队列）和Binding（绑定），以及独立的权限管理，是多租户的实现。</li><li><code>Channel</code>：Channel（通道）是建立在Connection（连接）之上的一个轻量级的虚拟连接，它是AMQP协议中的一个重要概念。Channel是客户端与Broker之间进行通信的最常用的接口。主要特点有：<ul><li><code>轻量级</code>：Channel是轻量级的，创建和销毁的代价较低</li><li><code>多路复用</code>：在一个TCP连接（Connection）中，可以创建多个Channel，每个Channel都有一个唯一的ID，这样可以实现多路复用</li><li><code>隔离性</code>：每个Channel都是独立的，Channel之间互不影响</li></ul></li><li><code>Exchange</code>：用于处理消息路由的核心组件。当生产者发送消息到RabbitMQ时，它会首先被发送到一个Exchange。Exchange根据预定的规则和绑定（Bindings）信息，决定如何路由这个消息</li><li><code>Queue</code>：用于存储消息的数据结构。消费者从队列中获取消息进行处理</li><li><code>Binding</code>：用于连接Exchange（交换器）和Queue（队列）的路由规则。通过Binding，RabbitMQ能够知道如何根据路由键（Routing Key）和交换器类型将消息正确地路由到相应的队列</li></ul><h2 id="使用rabbitmq"><a class="markdownIt-Anchor" href="#使用rabbitmq"></a> 使用RabbitMQ</h2><p class="note note-primary">原生客户端</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BasicTest</span> &#123;<br>    <span class="hljs-keyword">protected</span> ConnectionFactory connectionFactory;<br>    <span class="hljs-keyword">protected</span> Connection connection;<br>    <span class="hljs-keyword">protected</span> Channel channel;<br><br>    <span class="hljs-meta">@BeforeEach</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException &#123;<br>        connectionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConnectionFactory</span>();<br>        connectionFactory.setHost(<span class="hljs-string">&quot;localhost&quot;</span>);<br>        connectionFactory.setUsername(<span class="hljs-string">&quot;rabbitmq&quot;</span>);<br>        connectionFactory.setPassword(<span class="hljs-string">&quot;wgf123&quot;</span>);<br>        connection = connectionFactory.newConnection();<br>        channel = connection.createChannel();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>生产者</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProducerTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BasicTest</span>&#123;<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-meta">@SneakyThrows</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">send</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 生成一个队列</span><br><span class="hljs-comment">         * 1.队列名称</span><br><span class="hljs-comment">         * 2.队列里面的消息是否持久化 默认消息存储在内存中</span><br><span class="hljs-comment">         * 3.该队列是否只供一个消费者进行消费 是否进行共享 true 可以多个消费者消费</span><br><span class="hljs-comment">         * 4.是否自动删除 最后一个消费者端开连接以后 该队列是否自动删除 true 自动删除</span><br><span class="hljs-comment">         * 5.其他参数</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">queueName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;test&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Hello&quot;</span>;<br>        channel.queueDeclare(queueName, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);<br>        channel.basicPublish(<span class="hljs-string">&quot;&quot;</span>, queueName, <span class="hljs-literal">null</span>, message.getBytes());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>消费者</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConsumerTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BasicTest</span> &#123;<br><br>    <span class="hljs-meta">@SneakyThrows</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">listener</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">//推送的消息如何进行消费的接口回调</span><br>        <span class="hljs-type">DeliverCallback</span> <span class="hljs-variable">deliverCallback</span> <span class="hljs-operator">=</span> (consumerTag, delivery) -&gt; &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(delivery.getBody());<br>            log.info(message);<br>        &#125;;<br><br>        <span class="hljs-comment">//取消消费的一个回调接口 如在消费的时候队列被删除掉了</span><br>        <span class="hljs-type">CancelCallback</span> <span class="hljs-variable">cancelCallback</span> <span class="hljs-operator">=</span> (consumerTag) -&gt; &#123;<br>            System.out.println(<span class="hljs-string">&quot;消息消费被中断&quot;</span>);<br>        &#125;;<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">queueName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;test&quot;</span>;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 消费者消费消息</span><br><span class="hljs-comment">         * 1.消费哪个队列</span><br><span class="hljs-comment">         * 2.消费成功之后是否要自动应答 true 代表自动应答 false 手动应答</span><br><span class="hljs-comment">         * 3.消费者未成功消费的回调</span><br><span class="hljs-comment">         */</span><br>        channel.basicConsume(queueName, <span class="hljs-literal">true</span>, deliverCallback, cancelCallback);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p class="note note-primary">Spring Boot</p><p>添加依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br> <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br> <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>添加配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br><span class="hljs-attr">rabbitmq:</span><br> <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span><br> <span class="hljs-attr">host:</span> <span class="hljs-string">localhost</span><br> <span class="hljs-attr">username:</span> <br> <span class="hljs-attr">password:</span> <br></code></pre></td></tr></table></figure><p>创建队列</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">QueueConfig</span> &#123;<br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">QUEUE_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;test_queue&quot;</span>;<br><br> <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 简单定义消息队列</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">simpleQueue</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 不指定交换机则使用默认交换机将消息转发到队列</span><br>        <span class="hljs-keyword">return</span> QueueBuilder.durable(<span class="hljs-string">&quot;test_queue&quot;</span>).build();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>创建监听器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleListener</span> &#123;<br><br>    <span class="hljs-meta">@RabbitListener(queues = QueueConfig.QUEUE_NAME)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">receive</span><span class="hljs-params">(String msg)</span> &#123;<br>      log.info(msg);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>发送消息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">QeueuTest</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    RabbitTemplate rabbitTemplate; <br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">simpleSend</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        rabbitTemplate.convertAndSend(QueueConfig.QUEUE_NAME, <span class="hljs-string">&quot;test&quot;</span>);<br>        <span class="hljs-comment">// 暂停等待消息接收</span><br>        TimeUnit.SECONDS.sleep(<span class="hljs-number">5</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="消息分发"><a class="markdownIt-Anchor" href="#消息分发"></a> 消息分发</h3><p><img src="/2022/01/25/RabbitMQ/workQueues.png" srcset="/img/loading.gif" lazyload alt></p><p class="note note-primary">多消费者分发</p><p>多消费者的消息分发是一种常见的用于提高消息处理能力和实现负载均衡的策略。当多个消费者（Consumers）订阅同一个队列（Queue）时，RabbitMQ默认采用轮询分发策略将队列中的消息分发给各个消费者。<span class="green-line">多消费者间不保证消息有序，单消费者内消息有序。</span></p><p class="note note-primary">多线程分发</p><p>为确保每条消息仅被消费一次，在使用直连交换机的场景下，当存在多个消费者或一个消费者启动多个线程进行消息处理时，通常为每个线程分配一个独立的Channel（非线程安全）。这导致消息队列与消费者Channel之间形成一对多的关系，从而使得各个消费者Channel之间产生竞争。</p><h4 id="消费者多线程消费"><a class="markdownIt-Anchor" href="#消费者多线程消费"></a> 消费者多线程消费</h4><p><img src="/2022/01/25/RabbitMQ/%E5%A4%9AChannel.png" srcset="/img/loading.gif" lazyload alt></p><p><img src="/2022/01/25/RabbitMQ/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%B6%88%E8%B4%B9%E6%B6%88%E6%81%AF.png" srcset="/img/loading.gif" lazyload alt></p><p><span class="green-line">一个消息消费者开启多线程消费，那么每个线程会单独对应一个<code>Channel</code>，多线程消费场景下，不能够保证跨线程间的消息有序性，只能保证本线程消息的有序性</span></p><p>使用<code>@RabbitListener</code>注解的<code>concurrency</code>属性指定线程数</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RabbitListener(queues = AckQueueConfig.ACK_QUEUE, concurrency = &quot;5&quot;)</span><br></code></pre></td></tr></table></figure><h4 id="轮询分发默认"><a class="markdownIt-Anchor" href="#轮询分发默认"></a> 轮询分发（默认）</h4><p><span class="green-line">轮询分发是 RabbitMQ 的默认消息分发策略。在这种策略下，RabbitMQ 会按照消息到达的顺序，依次将消息分发给各个消费者。</span>这种方式能够确保所有的消费者能够平均地处理消息，实现负载均衡。</p><p><code>缺点</code>：轮询分发不考虑消费者的实际处理能力和性能差异，可能会导致性能浪费。例如，如果一个消费者处理消息的速度比另一个慢，快速的消费者会在等待新消息时出现空闲，从而导致资源未被充分利用。</p><p class="note note-primary">验证</p><p><em>每秒发送一条消息</em></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">QeueuTest</span> &#123;<br> <span class="hljs-meta">@Autowired</span><br> RabbitTemplate rabbitTemplate;<br><br> <span class="hljs-meta">@Test</span><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">simpleSend</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>     <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>         rabbitTemplate.convertAndSend(QueueConfig.QUEUE_NAME, i + <span class="hljs-string">&quot;&quot;</span>);<br>         TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>);<br>     &#125;<br> &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p class="note note-primary">定义多个监听器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleListener</span> &#123;<br><br> <span class="hljs-meta">@RabbitListener(queues = QueueConfig.QUEUE_NAME)</span><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">receive</span><span class="hljs-params">(String msg)</span> &#123;<br>   log.info(<span class="hljs-string">&quot;&#123;&#125;:&#123;&#125;&quot;</span>, <span class="hljs-string">&quot;receive&quot;</span>, msg);<br> &#125;<br><br> <span class="hljs-meta">@RabbitListener(queues = QueueConfig.QUEUE_NAME)</span><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">receive2</span><span class="hljs-params">(String msg)</span> &#123;<br>     log.info(<span class="hljs-string">&quot;&#123;&#125;:&#123;&#125;&quot;</span>, <span class="hljs-string">&quot;receive2&quot;</span>, msg);<br> &#125;<br><br> <span class="hljs-meta">@RabbitListener(queues = QueueConfig.QUEUE_NAME)</span><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">receive3</span><span class="hljs-params">(String msg)</span> &#123;<br>     log.info(<span class="hljs-string">&quot;&#123;&#125;:&#123;&#125;&quot;</span>, <span class="hljs-string">&quot;receive3&quot;</span>, msg);<br> &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p class="note note-primary">执行结果</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs verilog">INFO <span class="hljs-number">14984</span> --- [ntContainer#<span class="hljs-number">0</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.SimpleListener</span>     : receive:<span class="hljs-number">0</span><br>INFO <span class="hljs-number">14984</span> --- [ntContainer#<span class="hljs-number">1</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.SimpleListener</span>     : receive2:<span class="hljs-number">1</span><br>INFO <span class="hljs-number">14984</span> --- [ntContainer#<span class="hljs-number">2</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.SimpleListener</span>     : receive3:<span class="hljs-number">2</span><br>INFO <span class="hljs-number">14984</span> --- [ntContainer#<span class="hljs-number">0</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.SimpleListener</span>     : receive:<span class="hljs-number">3</span><br>INFO <span class="hljs-number">14984</span> --- [ntContainer#<span class="hljs-number">1</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.SimpleListener</span>     : receive2:<span class="hljs-number">4</span><br>INFO <span class="hljs-number">14984</span> --- [ntContainer#<span class="hljs-number">2</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.SimpleListener</span>     : receive3:<span class="hljs-number">5</span><br>INFO <span class="hljs-number">14984</span> --- [ntContainer#<span class="hljs-number">0</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.SimpleListener</span>     : receive:<span class="hljs-number">6</span><br>INFO <span class="hljs-number">14984</span> --- [ntContainer#<span class="hljs-number">1</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.SimpleListener</span>     : receive2:<span class="hljs-number">7</span><br>INFO <span class="hljs-number">14984</span> --- [ntContainer#<span class="hljs-number">2</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.SimpleListener</span>     : receive3:<span class="hljs-number">8</span><br>INFO <span class="hljs-number">14984</span> --- [ntContainer#<span class="hljs-number">0</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.SimpleListener</span>     : receive:<span class="hljs-number">9</span><br></code></pre></td></tr></table></figure><h4 id="不公平分发"><a class="markdownIt-Anchor" href="#不公平分发"></a> 不公平分发</h4><p><img src="/2022/01/25/RabbitMQ/prefeth.png" srcset="/img/loading.gif" lazyload alt></p><p>在某些场景下，RabbitMQ的默认轮询分发方式可能不是最优选择。例如，当存在处理速度不一的两个消费者时，轮询方式可能导致快速消费者有大量空闲时间，而慢速消费者则持续繁忙。尽管RabbitMQ默认采用这种公平的分发策略，但在这种情况下，它可能不是最有效的。</p><p>为了解决这个问题，我们可以让消费者在完成当前任务并发送确认回执后，才接收下一个消息。这样，RabbitMQ会将新消息分发给当前不忙的消费者。但是，如果所有消费者都在处理任务，且队列中不断有新消息加入，就有可能导致队列积压。此时，我们可以考虑增加消费者数量或调整消息存储策略来解决这个问题。</p><p class="note note-primary">prefetch 预取值</p><p>prefetch值用于限制Consumer消息缓冲区的大小，这对吞吐量有直接影响。</p><p>消息的发送本质上是异步的，因此，channel上通常会有多个消息。同时，消费者的手动确认也是异步的，这就产生了一个未确认消息的缓冲区。为避免缓冲区内未确认消息的无限制增长，建议开发人员限制此缓冲区的大小，这可以通过设置预取计数值来实现。</p><p><span class="green-line">此值定义了channel上允许的未确认消息的最大数量。当未确认消息数量达到此值时，RabbitMQ将停止向该通道发送新消息</span>，直到有至少一个未处理的消息被确认。例如，若通道上有未确认的消息5、6、7、8，且预取计数设置为4，则RabbitMQ不会再向该通道发送新消息，直到有消息被确认。一旦消息被确认，RabbitMQ会立即发送新消息。</p><p>消息确认和QoS预取值对吞吐量有显著影响。通常，增加预取值会提高向消费者传递消息的速度。<strong>虽然提高预取值会增加传输速率，但同时也会增加已传递但未处理消息的数量，导致消费者的RAM消耗增加.</strong> 因此，使用具有高预取值的自动确认模式或手动确认模式时需谨慎，<span class="green-line">若消费者消费了大量消息但未进行确认，会导致连接节点的内存消耗增大</span>。</p><p>为了避免这种情况，我们可以设置参数</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yaml">  <span class="hljs-attr">port:</span> <span class="hljs-number">8081</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-string">localhost</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">rabbitmq</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">wgf123</span><br>    <span class="hljs-attr">listener:</span><br>      <span class="hljs-attr">simple:</span><br>        <span class="hljs-attr">prefetch:</span> <span class="hljs-number">5</span> <span class="hljs-comment"># 动态调整</span><br></code></pre></td></tr></table></figure><p><code>springBoot默认值是250</code>，当一个队列有多个消费者时，可以根据消费者不同的消费能力灵活配置</p><p>demo 启用两个实例，实例1 prefetch = 1，实例2 prefetch = 5，并发送20条消息</p><p><img src="/2022/01/25/RabbitMQ/PrefetchCount.png" srcset="/img/loading.gif" lazyload alt></p><p class="note note-primary">结果</p><p>实例1</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs verilog">INFO <span class="hljs-number">28572</span> --- [ntContainer#<span class="hljs-number">5</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.SimpleListener</span>     : receive:<span class="hljs-number">2</span><br>INFO <span class="hljs-number">28572</span> --- [ntContainer#<span class="hljs-number">5</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.SimpleListener</span>     : receive:<span class="hljs-number">8</span><br>INFO <span class="hljs-number">28572</span> --- [ntContainer#<span class="hljs-number">5</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.SimpleListener</span>     : receive:<span class="hljs-number">15</span><br></code></pre></td></tr></table></figure><p>实例2</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs verilog">INFO <span class="hljs-number">28901</span> --- [ntContainer#<span class="hljs-number">5</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.SimpleListener</span>     : receive:<span class="hljs-number">1</span><br>INFO <span class="hljs-number">28901</span> --- [ntContainer#<span class="hljs-number">5</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.SimpleListener</span>     : receive:<span class="hljs-number">3</span><br>INFO <span class="hljs-number">28901</span> --- [ntContainer#<span class="hljs-number">5</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.SimpleListener</span>     : receive:<span class="hljs-number">4</span><br>INFO <span class="hljs-number">28901</span> --- [ntContainer#<span class="hljs-number">5</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.SimpleListener</span>     : receive:<span class="hljs-number">5</span><br>INFO <span class="hljs-number">28901</span> --- [ntContainer#<span class="hljs-number">5</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.SimpleListener</span>     : receive:<span class="hljs-number">6</span><br>INFO <span class="hljs-number">28901</span> --- [ntContainer#<span class="hljs-number">5</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.SimpleListener</span>     : receive:<span class="hljs-number">7</span><br>INFO <span class="hljs-number">28901</span> --- [ntContainer#<span class="hljs-number">5</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.SimpleListener</span>     : receive:<span class="hljs-number">9</span><br>INFO <span class="hljs-number">28901</span> --- [ntContainer#<span class="hljs-number">5</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.SimpleListener</span>     : receive:<span class="hljs-number">10</span><br>INFO <span class="hljs-number">28901</span> --- [ntContainer#<span class="hljs-number">5</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.SimpleListener</span>     : receive:<span class="hljs-number">11</span><br>INFO <span class="hljs-number">28901</span> --- [ntContainer#<span class="hljs-number">5</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.SimpleListener</span>     : receive:<span class="hljs-number">12</span><br>INFO <span class="hljs-number">28901</span> --- [ntContainer#<span class="hljs-number">5</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.SimpleListener</span>     : receive:<span class="hljs-number">13</span><br>INFO <span class="hljs-number">28901</span> --- [ntContainer#<span class="hljs-number">5</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.SimpleListener</span>     : receive:<span class="hljs-number">14</span><br>INFO <span class="hljs-number">28901</span> --- [ntContainer#<span class="hljs-number">5</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.SimpleListener</span>     : receive:<span class="hljs-number">16</span><br>INFO <span class="hljs-number">28901</span> --- [ntContainer#<span class="hljs-number">5</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.SimpleListener</span>     : receive:<span class="hljs-number">17</span><br>INFO <span class="hljs-number">28901</span> --- [ntContainer#<span class="hljs-number">5</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.SimpleListener</span>     : receive:<span class="hljs-number">18</span><br>INFO <span class="hljs-number">28901</span> --- [ntContainer#<span class="hljs-number">5</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.SimpleListener</span>     : receive:<span class="hljs-number">19</span><br>INFO <span class="hljs-number">28901</span> --- [ntContainer#<span class="hljs-number">5</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.SimpleListener</span>     : receive:<span class="hljs-number">20</span><br></code></pre></td></tr></table></figure><h3 id="消息队列参数配置"><a class="markdownIt-Anchor" href="#消息队列参数配置"></a> 消息队列参数配置</h3><table><thead><tr><th style="text-align:left">参数名称</th><th style="text-align:left">说明</th></tr></thead><tbody><tr><td style="text-align:left"><code>x-message-ttl</code></td><td style="text-align:left">消息在队列中过期的时间,单位ms</td></tr><tr><td style="text-align:left"><code>x-expires</code></td><td style="text-align:left">队列在多长时间没有被使用后删除</td></tr><tr><td style="text-align:left"><code>x-max-length</code></td><td style="text-align:left">限制队列中消息的最大条数。超过设定值后，<br>新消息会替换旧消息，遵循先进先出原则</td></tr><tr><td style="text-align:left"><code>x-max-length-bytes</code></td><td style="text-align:left">设定队列占用内存的最大字节数。达到限制时，<br>将采用LRU算法删除旧消息</td></tr><tr><td style="text-align:left"><code>x-dead-letter-routing-key</code></td><td style="text-align:left">死信队列路由key</td></tr><tr><td style="text-align:left"><code>x-dead-letter-exchange</code></td><td style="text-align:left">死信队列交换机，创建queue时参数arguments设置了<br>x-dead-letter-routing-key和x-dead-letter-exchange，<br>会在x-message-ttl时间到期后把消息放到x-dead-letter-routing-key<br>和x-dead-letter-exchange指定的队列中达到延迟队列的目的</td></tr><tr><td style="text-align:left"><code>x-max-priority</code></td><td style="text-align:left">具有更高优先级的队列具有较高的优先权，优先级高的消<br>息具备优先被消费的特权[1,255]</td></tr><tr><td style="text-align:left"><code>x-queue-mode</code></td><td style="text-align:left">lazt。指定惰性队列 惰性队列会尽可能的将消息存入磁盘中，<br>而在消费者消费到相应的消息时才会被加载到内存中，它的<br>一个重要设计目标是能够支持更长的队列，即支持更多的消<br>息存储。当消费者由于各种各样的原因（比如消费者下线、<br>跌机、或者由于维护而关闭等）致使长时间不能消费消息而<br>造成堆积时，惰性队列就很必要了</td></tr><tr><td style="text-align:left"><code>x-queue-master-locator</code></td><td style="text-align:left">决定队列master节点的选择策略（集群）<br>min-masters：选择master queue 数最少的那个服务节点host<br>client-local：选择与client相连接的那个服务节点host<br>random：随机分配</td></tr></tbody></table><h4 id="创建消息队列"><a class="markdownIt-Anchor" href="#创建消息队列"></a> 创建消息队列</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> name       队列名称</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> durable    是否持久化，如果设置为true，服务器重启了队列仍然存在（默认为true）</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> exclusive  是否为独享队列（排他性队列），只有自己可见的队列，即不允许其它用户访问(默认false)</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> autoDelete 当没有任何消费者使用时，自动删除该队列(默认为false,设置为true即为临时队列)</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> arguments  其他参数</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">Queue</span><span class="hljs-params">(String name, <span class="hljs-type">boolean</span> durable, <span class="hljs-type">boolean</span> exclusive, <span class="hljs-type">boolean</span> autoDelete,</span><br><span class="hljs-params">             <span class="hljs-meta">@Nullable</span> Map&lt;String, Object&gt; arguments)</span> &#123;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="消息异步发布确认"><a class="markdownIt-Anchor" href="#消息异步发布确认"></a> 消息异步发布确认</h2><p><span class="green-line">生产者发送消息，是先发送消息到<code>Exchange</code>，然后<code>Exchange</code>再路由到<code>Queue</code>。这中间就需要确认两个事情，第一，消息是否成功发送到<code>Exchange</code>；第二，消息是否正确的通过<code>Exchange</code>路由到<code>Queue</code></span></p><p><img src="/2022/01/25/RabbitMQ/%E6%8A%95%E9%80%92%E7%A1%AE%E8%AE%A4.png" srcset="/img/loading.gif" lazyload alt></p><p>spring提供了两个回调函数来处理这两种消息发送确认</p><h3 id="confirmcallback"><a class="markdownIt-Anchor" href="#confirmcallback"></a> ConfirmCallback</h3><p><code>发布确认</code></p><p><code>ConfirmCallback</code> 是一个用于处理消息确认的回调接口。它用于确保消息是否成功到达交换机。</p><ul><li><p><strong>消息成功到达交换机</strong>：</p><p>​	如果消息成功发送到交换机，<code>confirm</code> 方法将被调用，<code>ack</code> 参数为 <code>true</code>，表示消息已经被确认。</p></li><li><p><strong>消息未能到达交换机</strong>：</p><p>​	如果消息未能到达交换机，<code>confirm</code> 方法同样会被调用，但此时 <code>ack</code> 参数为 <code>false</code>。</p></li></ul><p><code>回调参数</code>：</p><ol><li><strong><code>CorrelationData correlationData</code></strong>：<ul><li>唯一标识发送的消息，与确认或拒绝的消息关联。</li></ul></li><li><strong><code>boolean ack</code></strong>：<ul><li><code>true</code> 表示消息成功到达交换机，<code>false</code> 表示发送失败。</li></ul></li><li><strong><code>String cause</code></strong>：<ul><li>拒绝时包含原因，成功时为 <code>null</code>。</li></ul></li></ol><p class="note note-primary">源码实现</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MsgConfirmCallback</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RabbitTemplate</span>.ConfirmCallback &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">confirm</span><span class="hljs-params">(CorrelationData correlationData, <span class="hljs-type">boolean</span> ack, String cause)</span> &#123;<br>        <span class="hljs-comment">// 如果发送到交换器都没有成功（比如说删除了交换器），ack 返回值为 false</span><br>        <span class="hljs-comment">// 如果发送到交换器成功，返回值为还是 true</span><br><br>        <span class="hljs-comment">// 获取消息id</span><br>        <span class="hljs-comment">//String messageId = correlationData.getId();</span><br>        log.info(<span class="hljs-string">&quot;ConfirmCallback , correlationData = &#123;&#125; , ack = &#123;&#125; , cause = &#123;&#125; &quot;</span>, correlationData, ack, cause);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="returncallback"><a class="markdownIt-Anchor" href="#returncallback"></a> ReturnCallback</h3><p><code>消息回退</code></p><p><code>ReturnCallback</code> 是 RabbitMQ 中的一个回调机制，用于处理未能路由到合适队列的消息。只有消息没有被正确路由，才会回调此接口。</p><p><code>回调参数</code>：</p><ul><li><code>message</code>：未能路由到队列的消息。</li><li><code>replyCode</code>：RabbitMQ 返回的错误代码。</li><li><code>replyText</code>：RabbitMQ 返回的错误描述。</li><li><code>exchange</code>：发送消息时使用的交换机。</li><li><code>routingKey</code>：发送消息时使用的路由</li></ul><p><strong>实现源码</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MsgReturnCallback</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RabbitTemplate</span>.ReturnCallback &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">returnedMessage</span><span class="hljs-params">(Message message, <span class="hljs-type">int</span> replyCode, String replyText, String exchange, String routingKey)</span> &#123;<br>        <span class="hljs-comment">// 获取消息id</span><br>        <span class="hljs-comment">// String   messageId = message.getMessageProperties().getMessageId();</span><br>        log.info(<span class="hljs-string">&quot;ReturnCallback unroutable messages, message = &#123;&#125; , replyCode = &#123;&#125; , replyText = &#123;&#125; , exchange = &#123;&#125; , routingKey = &#123;&#125; &quot;</span>, message, replyCode, replyText, exchange, routingKey);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="整合"><a class="markdownIt-Anchor" href="#整合"></a> 整合</h3><p class="note note-primary">添加两个Callback</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RabbitmqConfig</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    MsgConfirmCallback msgConfirmCallback;<br><br>    <span class="hljs-meta">@Autowired</span><br>    MsgReturnCallback msgReturnCallback;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> RabbitTemplate <span class="hljs-title function_">rabbitTemplate</span><span class="hljs-params">(ConnectionFactory connectionFactory)</span> &#123;<br>        <span class="hljs-comment">// connectionFactory包含yml配置文件配置信息</span><br>        <span class="hljs-type">RabbitTemplate</span> <span class="hljs-variable">template</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RabbitTemplate</span>(connectionFactory);<br><br>        <span class="hljs-comment">//mandatory参数说明: 交换器无法根据自身类型和路由键找到一个符合条件的队列时的处理方式; true表示会调用Basic.Return命令返回给生产者; false表示丢弃消息</span><br>        template.setMandatory(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-comment">// 消息从 producer 到 exchange 正常则会返回一个 confirmCallback</span><br>        template.setConfirmCallback(msgConfirmCallback);<br><br>        <span class="hljs-comment">// 消息从 exchange–&gt;queue 投递失败则会返回一个 returnCallback</span><br>        template.setReturnCallback(msgReturnCallback);<br><br>        <span class="hljs-keyword">return</span> template;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p class="note note-primary">开启回调配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8081</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">121.37</span><span class="hljs-number">.23</span><span class="hljs-number">.172</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">rabbitmq</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">wgf123</span><br>    <span class="hljs-attr">publisher-confirm-type:</span> <span class="hljs-string">correlated</span>  <span class="hljs-comment"># 发布消息成功到交换器后会触发回调方法</span><br></code></pre></td></tr></table></figure><p class="note note-primary">发送消息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testCallback</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">//correlationDataId相当于消息的唯一表示</span><br>    <span class="hljs-type">UUID</span> <span class="hljs-variable">correlationDataId</span> <span class="hljs-operator">=</span> UUID.randomUUID();<br>    <span class="hljs-comment">// 这里设置的id是给ConfirmCallback使用的</span><br>    <span class="hljs-type">CorrelationData</span> <span class="hljs-variable">correlationData</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CorrelationData</span>(correlationDataId.toString());<br>    <span class="hljs-comment">//发送MQ</span><br>    rabbitTemplate.convertAndSend(DirectConfig.DIRECT_EXCHANGE, <span class="hljs-string">&quot;test-queue&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>, (message) -&gt; &#123;<br>        <span class="hljs-comment">// 这里设置的id是给 ReturnCallback 使用的</span><br>        message.getMessageProperties().setMessageId(correlationData.getId());<br>        <span class="hljs-keyword">return</span> message;<br>    &#125;, correlationData);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="ack消息确认机制"><a class="markdownIt-Anchor" href="#ack消息确认机制"></a> ACK消息确认机制</h2><p><img src="/2022/01/25/RabbitMQ/ack%E6%B5%81%E7%A8%8B.png" srcset="/img/loading.gif" lazyload alt></p><p>当消费者从 RabbitMQ 接收到一条消息并成功处理后，消费者需要向 RabbitMQ 发送 ACK 反馈。只有在 RabbitMQ 收到这个 ACK 反馈后，它才会将该消息从队列中删除。</p><ol><li><strong>处理网络不稳定或服务器异常</strong><ul><li>如果消费者在处理消息时遇到网络不稳定或服务器异常等问题，可能导致无法发送 ACK 反馈。</li><li>RabbitMQ 将认为这条消息没有被正常消费，于是将其重新放回队列中等待处理。</li></ul></li><li><strong>集群环境下的处理</strong><ul><li>在 RabbitMQ 集群中，如果一个消费者未能发送 ACK 反馈，RabbitMQ 不会无限期等待。</li><li>相反，它会立即将该消息推送给在线的其他消费者，以确保消息和任务不会丢失。</li></ul></li><li><strong>消息的删除条件</strong><ul><li>消费者成功处理消息并发送 ACK 反馈。</li><li>RabbitMQ 确认接收到了这个 ACK 反馈。</li></ul></li></ol><p>消息的ACK确认机制默认是打开的(自动ACK)</p><h3 id="消息自动重新入列"><a class="markdownIt-Anchor" href="#消息自动重新入列"></a> 消息自动重新入列</h3><p><code>Channel断开，未ACK的消息重新入列</code></p><p><img src="/2022/01/25/RabbitMQ/%E9%87%8D%E5%9B%9E%E9%98%9F%E5%88%97.png" srcset="/img/loading.gif" lazyload alt></p><p>如果消费者因某些原因失去与 RabbitMQ 的连接（例如通道关闭、连接关闭或TCP连接丢失），导致消息未能发送 ACK 确认，RabbitMQ 将察觉到消息未被完全处理，并会将其重新放回队列。如果此时有其他可用的消费者可以处理这条消息，RabbitMQ 将尽快将消息重新分发给另一个消费者。这样，即使某个消费者偶尔故障，也可以确保不会丢失任何消息。这个机制保障了消息的可靠传递和处理，即使在不稳定的网络环境或消费者故障的情况下也能保持消息的完整性。</p><h3 id="自动ack"><a class="markdownIt-Anchor" href="#自动ack"></a> 自动ack</h3><p><code>优点</code></p><ul><li><strong>简单易用</strong>：不需要显式的确认消息，减少了开发的复杂性。</li><li><strong>性能较高</strong>：由于不涉及额外的确认步骤，处理速度较快，适用于一些不需要严格消息确认的场景。</li></ul><p><code>缺点</code></p><ul><li><strong>消息丢失风险</strong>：最大的缺点是消息一旦被投递给消费者就被认为已处理，如果消费者在处理消息时发生故障，消息将会丢失。</li><li><strong>无法保证可靠性</strong>：无法确保每条消息都被成功处理，适用于不太关键的场景。</li></ul><h3 id="手动ack"><a class="markdownIt-Anchor" href="#手动ack"></a> 手动ack</h3><p><code>优点</code></p><ul><li><strong>消息可靠性</strong>：消费者可以在处理消息后显式确认，确保消息已经被成功处理，减少了消息丢失的风险。</li><li><strong>灵活性</strong>：可以自定义确认的时机，例如，只有在下游业务成功完成后才确认消息。</li></ul><p><code>缺点</code></p><ul><li><strong>开发复杂性</strong>：需要显式调用API来确认消息，增加了开发的复杂性。</li><li><strong>性能开销</strong>：相比自动ACK，手动ACK可能会引入一些性能开销，因为需要额外的确认步骤。</li></ul><p class="note note-primary">使用手动ack</p><p>添加配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br><span class="hljs-attr">rabbitmq:</span><br> <span class="hljs-attr">listener:</span><br>   <span class="hljs-attr">acknowledge-mode:</span> <span class="hljs-string">manual</span> <span class="hljs-comment"># ack应答设置为手动模式</span><br></code></pre></td></tr></table></figure><p>监听器实现</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AckListener</span> &#123;<br><br> <span class="hljs-meta">@RabbitListener(queues = AckQueueConfig.ACK_QUEUE)</span><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">listener</span><span class="hljs-params">(String message, Channel channel, Message messageEntity)</span> &#123;<br>     <span class="hljs-type">int</span> <span class="hljs-variable">num</span> <span class="hljs-operator">=</span> Integer.valueOf(message);<br><br>     <span class="hljs-keyword">try</span> &#123;<br>         <span class="hljs-comment">// 让值大于5抛异常进行Nack, 消息就会重回队列头部进行下次消费，这里的代码num&gt;5会是一个死循环消费</span><br>         <span class="hljs-keyword">if</span> (num &gt;= <span class="hljs-number">5</span>) &#123;<br>             <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>();<br>         &#125;<br><br>         log.info(<span class="hljs-string">&quot;队列：&#123;&#125; 接收到消息：&#123;&#125;&quot;</span>, AckQueueConfig.ACK_QUEUE, message);<br><br>         <span class="hljs-comment">/**</span><br><span class="hljs-comment">             * 消息消费确认</span><br><span class="hljs-comment">             * 如果客户端在线没有签收这条Message，则此消息进入Unacked状态，此时监听器阻塞等待消息确认，不推送新Message</span><br><span class="hljs-comment">             * 如果待消息确认并且客户端下线，下次客户端上线重新推送上次Unacked状态Message</span><br><span class="hljs-comment">             */</span><br>            channel.basicAck(messageEntity.getMessageProperties().getDeliveryTag(), <span class="hljs-literal">false</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            log.error(<span class="hljs-string">&quot;消费消息异常&quot;</span>, e);<br><br>            <span class="hljs-comment">/**</span><br><span class="hljs-comment">             * 第一个参数deliveryTag：发布的每一条消息都会获得一个唯一的deliveryTag，deliveryTag在channel范围内是唯一的</span><br><span class="hljs-comment">             * 第二个参数multiple：批量确认标志。如果值为true，包含本条消息在内的、所有比该消息deliveryTag值小的消息都会被处理</span><br><span class="hljs-comment">             * 第三个参数requeue：表示如何处理这条消息，如果值为true，则重新放入RabbitMQ的发送队列，如果值为false，则通知RabbitMQ销毁这条消息</span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// nack 消息回到队列头部后会被重新消费，如果多次nack的会无限循环，卡在这里</span><br>                channel.basicNack(messageEntity.getMessageProperties().getDeliveryTag(), <span class="hljs-literal">false</span>,<span class="hljs-literal">true</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (IOException ex) &#123;<br>                <span class="hljs-comment">// TODO 重试逻辑或业务补偿（发往死信队列或Redis等）</span><br>                log.error(<span class="hljs-string">&quot;nack失败&quot;</span>, ex);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>发送消息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">send</span><span class="hljs-params">(String msgId, String exchange, String routingKey, Object msg)</span> &#123;<br>      <span class="hljs-type">CorrelationData</span> <span class="hljs-variable">correlationData</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CorrelationData</span>(msgId);<br>      <span class="hljs-comment">//发送MQ</span><br>      rabbitTemplate.convertAndSend(exchange, routingKey, msg, (message) -&gt; &#123;<br>          message.getMessageProperties().setMessageId(correlationData.getId());<br>          <span class="hljs-keyword">return</span> message;<br>      &#125;, correlationData);<br>  &#125;<br><br>  <span class="hljs-meta">@Test</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ackTest</span><span class="hljs-params">()</span> &#123;<br>      IntStream.range(<span class="hljs-number">0</span>, <span class="hljs-number">6</span>).forEach(line -&gt; &#123;<br>          <span class="hljs-comment">//correlationDataId相当于消息的唯一表示</span><br>          <span class="hljs-type">String</span> <span class="hljs-variable">msgId</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString();<br>          <span class="hljs-built_in">this</span>.send(msgId, DirectConfig.DIRECT_EXCHANGE, AckQueueConfig.ROUTING_KEY, line);<br>      &#125;);<br>  &#125;<br></code></pre></td></tr></table></figure><h3 id="ack重试配置"><a class="markdownIt-Anchor" href="#ack重试配置"></a> ack重试配置</h3><p><strong><code>retry只能在自动ack模式下使用</code></strong></p><p><span class="green-line">重试并不是RabbitMQ重新发送了消息，仅仅是spring封装消费者内部进行了重试，换句话说就是重试跟mq没有任何关系；</span>配置重试次数，当超过重试次数消息投递到异常队列</p><p>实现<code>MessageRecoverer</code>接口的<code>recover</code>方法，当重试次数上限则调用该方法处理</p><p>添加配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br><span class="hljs-attr">port:</span> <span class="hljs-number">8081</span><br><span class="hljs-attr">spring:</span><br><span class="hljs-attr">rabbitmq:</span><br> <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span><br> <span class="hljs-attr">host:</span> <span class="hljs-string">localhost</span><br> <span class="hljs-attr">username:</span> <span class="hljs-string">rabbitmq</span><br> <span class="hljs-attr">password:</span> <span class="hljs-string">wgf123</span><br> <span class="hljs-attr">publisher-confirm-type:</span> <span class="hljs-string">correlated</span>  <span class="hljs-comment"># 发布消息成功到交换器后会触发回调方法</span><br> <span class="hljs-attr">listener:</span><br>   <span class="hljs-attr">simple:</span><br>     <span class="hljs-attr">prefetch:</span> <span class="hljs-number">5</span><br>     <span class="hljs-comment">#acknowledge-mode: manual  # 手动ack模式（关闭手动ack）</span><br>     <span class="hljs-attr">retry:</span>					<span class="hljs-comment"># 重试配置</span><br>       <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>       <span class="hljs-attr">max-attempts:</span> <span class="hljs-number">5</span>       <span class="hljs-comment"># 最大重试次数</span><br>       <span class="hljs-attr">max-interval:</span> <span class="hljs-number">10000</span>   <span class="hljs-comment"># 重试最大间隔时间</span><br>       <span class="hljs-attr">initial-interval:</span> <span class="hljs-number">2000</span>  <span class="hljs-comment"># 重试初始间隔时间</span><br>       <span class="hljs-attr">multiplier:</span> <span class="hljs-number">2</span> <span class="hljs-comment"># 间隔时间乘子，间隔时间*乘子=下一次的间隔时间，最大不能超过设置的最大间隔时间</span><br>     <span class="hljs-attr">default-requeue-rejected:</span> <span class="hljs-literal">true</span>  <span class="hljs-comment"># 重试次数超过上面的设置之后是否丢弃</span><br></code></pre></td></tr></table></figure><p>队列和重试策略配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RetryConfig</span> &#123;<br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">RETRY_EXCHANGE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;retry.queue&quot;</span>;<br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">RETRY_QUEUE</span>    <span class="hljs-operator">=</span> <span class="hljs-string">&quot;retry.queue&quot;</span>;<br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ROUTING_KEY</span>    <span class="hljs-operator">=</span> <span class="hljs-string">&quot;retry&quot;</span>;<br><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ERROR_QUEUE</span>       <span class="hljs-operator">=</span> <span class="hljs-string">&quot;retry.error&quot;</span>;<br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ERROR_ROUTING_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;error&quot;</span>;<br><br> <span class="hljs-meta">@Autowired</span><br> RabbitTemplate rabbitTemplate;<br><br> <span class="hljs-meta">@Bean</span><br> <span class="hljs-keyword">public</span> DirectExchange <span class="hljs-title function_">retryExchange</span><span class="hljs-params">()</span> &#123;<br>     <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DirectExchange</span>(RETRY_EXCHANGE);<br> &#125;<br><br> <span class="hljs-meta">@Bean</span><br> <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">retryQueue</span><span class="hljs-params">()</span> &#123;<br>     <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(RETRY_QUEUE);<br> &#125;<br><br> <span class="hljs-meta">@Bean</span><br> <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">bindRetryQueue</span><span class="hljs-params">(Queue retryQueue, DirectExchange retryExchange)</span> &#123;<br>     <span class="hljs-keyword">return</span> BindingBuilder.bind(retryQueue).to(retryExchange).with(ROUTING_KEY);<br> &#125;<br><br> <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 异常队列</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">errorQueue</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(ERROR_QUEUE);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 交换机绑定异常队列</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> errorQueue</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> directExchange</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">bindErrorQueue</span><span class="hljs-params">(Queue errorQueue, DirectExchange retryExchange)</span> &#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(errorQueue).to(retryExchange).with(ERROR_ROUTING_KEY);<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 调试时，配置打开</span><br><span class="hljs-comment">     * MessageRecoverer 的实现类。达到重试次数后将消息丢第到异常队列</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> MessageRecoverer <span class="hljs-title function_">republishMessageRecoverer</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 重试次数上限将消息丢到异常队列</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RepublishMessageRecoverer</span>(rabbitTemplate, RETRY_EXCHANGE, ERROR_ROUTING_KEY);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>消息监听器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RetryListener</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">0</span>);<br><br>    <span class="hljs-meta">@RabbitListener(queues = RetryConfig.RETRY_QUEUE)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">listener</span><span class="hljs-params">(String message, Channel channel, Message messageEntity)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        log.info(<span class="hljs-string">&quot;消费次数：&#123;&#125;&quot;</span>, count.incrementAndGet());<br>        <span class="hljs-comment">// 必须抛出异常才能触发重试次数</span><br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>发送消息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">retryTest</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>    <span class="hljs-built_in">this</span>.rabbitTemplate.convertAndSend(RetryConfig.RETRY_EXCHANGE, RetryConfig.ROUTING_KEY, <span class="hljs-string">&quot;test&quot;</span>);<br>    TimeUnit.SECONDS.sleep(<span class="hljs-number">60</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>日志</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs verilog"><span class="hljs-number">2022</span>-<span class="hljs-number">02</span>-<span class="hljs-number">04</span> <span class="hljs-number">16</span>:<span class="hljs-number">01</span>:<span class="hljs-number">32</span><span class="hljs-variable">.156</span>  INFO <span class="hljs-number">13932</span> --- [tContainer#<span class="hljs-number">13</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.RetryListener</span>      : 消费次数：<span class="hljs-number">1</span><br><span class="hljs-number">2022</span>-<span class="hljs-number">02</span>-<span class="hljs-number">04</span> <span class="hljs-number">16</span>:<span class="hljs-number">01</span>:<span class="hljs-number">34</span><span class="hljs-variable">.157</span>  INFO <span class="hljs-number">13932</span> --- [tContainer#<span class="hljs-number">13</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.RetryListener</span>      : 消费次数：<span class="hljs-number">2</span><br><span class="hljs-number">2022</span>-<span class="hljs-number">02</span>-<span class="hljs-number">04</span> <span class="hljs-number">16</span>:<span class="hljs-number">01</span>:<span class="hljs-number">38</span><span class="hljs-variable">.164</span>  INFO <span class="hljs-number">13932</span> --- [tContainer#<span class="hljs-number">13</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.RetryListener</span>      : 消费次数：<span class="hljs-number">3</span><br><span class="hljs-number">2022</span>-<span class="hljs-number">02</span>-<span class="hljs-number">04</span> <span class="hljs-number">16</span>:<span class="hljs-number">01</span>:<span class="hljs-number">46</span><span class="hljs-variable">.167</span>  INFO <span class="hljs-number">13932</span> --- [tContainer#<span class="hljs-number">13</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.RetryListener</span>      : 消费次数：<span class="hljs-number">4</span><br><span class="hljs-number">2022</span>-<span class="hljs-number">02</span>-<span class="hljs-number">04</span> <span class="hljs-number">16</span>:<span class="hljs-number">01</span>:<span class="hljs-number">56</span><span class="hljs-variable">.168</span>  INFO <span class="hljs-number">13932</span> --- [tContainer#<span class="hljs-number">13</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.RetryListener</span>      : 消费次数：<span class="hljs-number">5</span><br><span class="hljs-number">2022</span>-<span class="hljs-number">02</span>-<span class="hljs-number">04</span> <span class="hljs-number">16</span>:<span class="hljs-number">01</span>:<span class="hljs-number">56</span><span class="hljs-variable">.169</span>  WARN <span class="hljs-number">13932</span> --- [tContainer#<span class="hljs-number">13</span>-<span class="hljs-number">1</span>] o<span class="hljs-variable">.s</span><span class="hljs-variable">.a</span><span class="hljs-variable">.r</span><span class="hljs-variable">.retry</span><span class="hljs-variable">.RepublishMessageRecoverer</span>  : Republishing failed message to exchange &#x27;retry<span class="hljs-variable">.queue</span>&#x27; <span class="hljs-keyword">with</span> routing key error<br></code></pre></td></tr></table></figure><p>消费次数上限丢到error队列</p><p><img src="/2022/01/25/RabbitMQ/%E6%B6%88%E6%81%AF%E9%87%8D%E8%AF%95.jpg" srcset="/img/loading.gif" lazyload alt></p><h2 id="rabbitmq持久化"><a class="markdownIt-Anchor" href="#rabbitmq持久化"></a> RabbitMQ持久化</h2><p>默认情况下，RabbitMQ将exchange、queue、message等数据存储在内存中，这意味着如果RabbitMQ在重启、关闭或宕机时，所有信息都会丢失。</p><p>为了解决这个问题，RabbitMQ提供了持久化功能。通过启用持久化，当RabbitMQ在发生重启、关闭或宕机后重新启动时，它可以从硬盘中恢复exchange、queue、message等数据。</p><p>持久化的配置方式如下：</p><ul><li>exchange 持久化，在声明时指定 durable 为 true</li><li>queue 持久化，在声明时指定 durable 为 true</li><li>message 持久化，在投递时通过参数指定消息持久化，持久化到磁盘</li></ul><p>需要注意的是，exchange和queue的持久化确保了它们自身的元数据不会因异常而丢失，但并不保证其中的message不会丢失。要确保message不会丢失，必须同时将message也标记为持久化。</p><p class="note note-primary">注意</p><ul><li>如果 exchange 和 queue 两者之间有一个持久化，一个非持久化，就不允许建立绑定</li><li>如果 exchange 和 queue 都是持久化的，那么它们之间的 binding 也是持久化的</li><li>exchange 和 queue 持久化的是它们的元数据，保证RabbitMQ重启后 exchange 和 queue 能从磁盘重新加载</li></ul><p class="note note-primary">exchange 持久化</p><p>代码持久化</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> DirectExchange <span class="hljs-title function_">directExchange</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 默认持久化</span><br>    <span class="hljs-comment">// return new DirectExchange(DIRECT_EXCHANGE);</span><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 第一个参数：交换机名称</span><br><span class="hljs-comment">     * 第二个参数：是否持久化</span><br><span class="hljs-comment">     * 第三个参数：是否自动删除，条件：有队列或者交换器绑定了本交换器，然后所有队列或交换器都与本交换器解除绑定，autoDelete=true时，此交换器就会被自动删除</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DirectExchange</span>(DIRECT_EXCHANGE, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>控制台持久化</p><p><img src="/2022/01/25/RabbitMQ/exchange%E6%8C%81%E4%B9%85%E5%8C%96.png" srcset="/img/loading.gif" lazyload alt></p><p class="note note-primary">queue 持久化</p><p>代码持久化</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> name       队列名称</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> durable    是否持久化，如果设置为true，服务器重启了队列仍然存在（默认为true）</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> exclusive  是否为独享队列（排他性队列），只有自己可见的队列，即不允许其它用户访问(默认false)</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> autoDelete 当没有任何消费者使用时，自动删除该队列(默认为false,设置为true即为临时队列)</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> arguments  其他参数</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">Queue</span><span class="hljs-params">(String name, <span class="hljs-type">boolean</span> durable, <span class="hljs-type">boolean</span> exclusive, <span class="hljs-type">boolean</span> autoDelete,</span><br><span class="hljs-params">             <span class="hljs-meta">@Nullable</span> Map&lt;String, Object&gt; arguments)</span> &#123;<br>&#125;<br></code></pre></td></tr></table></figure><p>控制台持久化</p><p><img src="/2022/01/25/RabbitMQ/queue%E6%8C%81%E4%B9%85%E5%8C%96.png" srcset="/img/loading.gif" lazyload alt></p><p class="note note-primary">消息持久化</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">persistenceTest</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 消息持久化</span><br>    <span class="hljs-type">MessagePostProcessor</span> <span class="hljs-variable">messagePostProcessor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessagePostProcessor</span>() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> Message <span class="hljs-title function_">postProcessMessage</span><span class="hljs-params">(Message message)</span> <span class="hljs-keyword">throws</span> AmqpException &#123;<br>            message.getMessageProperties().setDeliveryMode(MessageDeliveryMode.PERSISTENT);<br>            <span class="hljs-keyword">return</span> message;<br>        &#125;<br>    &#125;;<br><br>    rabbitTemplate.convertAndSend(QueueConfig.QUEUE_NAME, <span class="hljs-string">&quot;test&quot;</span>.getBytes(), messagePostProcessor);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="死信队列-dlx"><a class="markdownIt-Anchor" href="#死信队列-dlx"></a> 死信队列 DLX</h2><p><code>死信：无法被消费的消息</code></p><p><code>死信队列：专门存放无法被消费的消息</code></p><p>先从概念解释上搞清楚这个定义，<span class="green-line">死信，顾名思义就是无法被消费的消息，字面意思可以这样理解，一般来说，<code>producer</code> 将消息投递到 <code>broker</code> 或者直接到 <code>queue</code> 里了，<code>consumer</code> 从 <code>queue</code> 取出消息进行消费，但某些时候由于特定的原因导致 queue 中的某些消息无法被消费，这样的消息如果没有后续的处理，就变成了死信，有死信自然就有了死信队列</span></p><p><strong>应用场景</strong>：为了保证订单业务的消息数据不丢失，需要使用到 <code>RabbitMQ</code> 的死信队列机制，<span class="green-line">当消息消费发生异常时，将消息投入死信队列中</span>。还有比如说: 用户在商城下单成功并点击去支付后在指定时间未支付时自动失效</p><h3 id="死信的来源"><a class="markdownIt-Anchor" href="#死信的来源"></a> 死信的来源</h3><p><img src="/2022/01/25/RabbitMQ/%E6%AD%BB%E4%BF%A1%E9%98%9F%E5%88%97%E6%9E%B6%E6%9E%84%E5%9B%BE.png" srcset="/img/loading.gif" lazyload alt></p><ul><li><code>消息 TTL 过期</code></li><li><code>队列达到最大限制淘汰旧消息</code></li><li><code>消息被拒绝(basic.reject 或 basic.nack)并且 requeue=false</code></li></ul><h3 id="死信队列example"><a class="markdownIt-Anchor" href="#死信队列example"></a> 死信队列Example</h3><p><img src="/2022/01/25/RabbitMQ/%E6%AD%BB%E4%BF%A1%E9%98%9F%E5%88%97%E8%A7%84%E5%88%92.png" srcset="/img/loading.gif" lazyload alt></p><p class="note note-primary">交换机和队列配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DeadConfig</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 死信配置</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEAD_EXCHANGE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;dead_exchange&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEAD_QUEUE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;dead.queue&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEAD_ROUTING_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;dead&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 正常交换机与队列配置</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">NORMAL_EXCHANGE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;normal_exchange&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 有TTL过期的队列</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TTL_QUEUE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;dead.ttl.queue&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TTL_ROUTING_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ttl&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 有长度的队列</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">LENGTH_QUEUE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;dead.length.queue&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">LENGTH_ROUTING_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;length&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 拒绝队列</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">NACK_QUEUE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;dead.nack.queue&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">NACK_ROUTING_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;nack&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建死信交换机</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> DirectExchange <span class="hljs-title function_">deadExchange</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DirectExchange</span>(DEAD_EXCHANGE);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建死信队列</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">deadQueue</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(DEAD_QUEUE);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 绑定死信队列</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> directQueue</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> directExchange</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">bindDeadtQueue</span><span class="hljs-params">(Queue deadQueue, DirectExchange deadExchange)</span> &#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(deadQueue).to(deadExchange).with(DEAD_ROUTING_KEY);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 正常交换机</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> DirectExchange <span class="hljs-title function_">normalExchange</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DirectExchange</span>(NORMAL_EXCHANGE);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * TTL过期队列</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">deadTtlQueue</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 正常队列绑定死信队列</span><br>        Map&lt;String, Object&gt; args = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(<span class="hljs-number">8</span>);<br>        <span class="hljs-comment">// 设置TTL过期</span><br>        args.put(<span class="hljs-string">&quot;x-message-ttl&quot;</span>, <span class="hljs-number">10000</span>);<br><br>        <span class="hljs-comment">// 声明死信队列路由键</span><br>        args.put(<span class="hljs-string">&quot;x-dead-letter-routing-key&quot;</span>, DEAD_ROUTING_KEY);<br>        <span class="hljs-comment">// 声明死信队列交换机，消息异常投递到此交换机</span><br>        args.put(<span class="hljs-string">&quot;x-dead-letter-exchange&quot;</span>, DEAD_EXCHANGE);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(TTL_QUEUE, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, args);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 有长度限制的队列</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">deadLengthQueue</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 正常队列绑定死信队列</span><br>        Map&lt;String, Object&gt; args = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(<span class="hljs-number">8</span>);<br><br>        <span class="hljs-comment">// 设置队列最大长度</span><br>        args.put(<span class="hljs-string">&quot;x-max-length&quot;</span>, <span class="hljs-number">4</span>);<br><br>        <span class="hljs-comment">// 声明死信队列路由键</span><br>        args.put(<span class="hljs-string">&quot;x-dead-letter-routing-key&quot;</span>, DEAD_ROUTING_KEY);<br>        <span class="hljs-comment">// 声明死信队列交换机，消息异常投递到此交换机</span><br>        args.put(<span class="hljs-string">&quot;x-dead-letter-exchange&quot;</span>, DEAD_EXCHANGE);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(LENGTH_QUEUE, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, args);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 拒绝队列，监听时NACK</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">deadNackQueue</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 正常队列绑定死信队列</span><br>        Map&lt;String, Object&gt; args = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(<span class="hljs-number">8</span>);<br>        <span class="hljs-comment">// 声明死信队列路由键</span><br>        args.put(<span class="hljs-string">&quot;x-dead-letter-routing-key&quot;</span>, DEAD_ROUTING_KEY);<br>        <span class="hljs-comment">// 声明死信队列交换机，消息异常投递到此交换机</span><br>        args.put(<span class="hljs-string">&quot;x-dead-letter-exchange&quot;</span>, DEAD_EXCHANGE);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(NACK_QUEUE, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, args);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * TTL队列绑定交换机</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> deadTtlQueue</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> normalExchange</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">bingDeadTtlQueue</span><span class="hljs-params">(Queue deadTtlQueue, DirectExchange normalExchange)</span> &#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(deadTtlQueue).to(normalExchange).with(TTL_ROUTING_KEY);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * LENGTH队列绑定交换机</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> deadLengthQueue</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> normalExchange</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">bingDeadLengthQueue</span><span class="hljs-params">(Queue deadLengthQueue, DirectExchange normalExchange)</span> &#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(deadLengthQueue).to(normalExchange).with(LENGTH_ROUTING_KEY);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * NACK队列绑定交换机</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> deadNackQueue</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> normalExchange</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">bingDeadNackQueue</span><span class="hljs-params">(Queue deadNackQueue, DirectExchange normalExchange)</span> &#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(deadNackQueue).to(normalExchange).with(NACK_ROUTING_KEY);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p class="note note-primary">监听器配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DeadListener</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 监听死信队列</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@RabbitListener(queues = DeadConfig.DEAD_QUEUE)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deadListener</span><span class="hljs-params">(String message, Channel channel, Message messageEntity)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        log.info(<span class="hljs-string">&quot;死信队列接受到死信：&#123;&#125;&quot;</span>, message);<br>        channel.basicAck(messageEntity.getMessageProperties().getDeliveryTag(), <span class="hljs-literal">false</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * NACK 监听</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@SneakyThrows</span><br>    <span class="hljs-meta">@RabbitListener(queues = DeadConfig.NACK_QUEUE)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">listener</span><span class="hljs-params">(String message, Channel channel, Message messageEntity)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-comment">// 拒收消息</span><br>        log.info(<span class="hljs-string">&quot;队列：&#123;&#125; 拒收消息：&#123;&#125;&quot;</span>, DeadConfig.TTL_QUEUE, message);<br>        <span class="hljs-comment">// 两种决绝方式都能重新投递死信队列</span><br>        channel.basicNack(messageEntity.getMessageProperties().getDeliveryTag(), <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>);<br>        <span class="hljs-comment">// channel.basicReject(messageEntity.getMessageProperties().getDeliveryTag(), false);</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ttl过期"><a class="markdownIt-Anchor" href="#ttl过期"></a> TTL过期</h3><p>配置正常队列与死信队列绑定</p><p>发送消息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-meta">@SneakyThrows</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deadTtlTest</span><span class="hljs-params">()</span> &#123;<br>    IntStream.range(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>).forEach(line -&gt; &#123;<br>        <span class="hljs-type">int</span>    <span class="hljs-variable">ttl</span> <span class="hljs-operator">=</span> <span class="hljs-number">5000</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;delay:&quot;</span> + line;<br><br>        rabbitTemplate.convertAndSend(DeadConfig.NORMAL_EXCHANGE, DeadConfig.TTL_ROUTING_KEY, msg);<br>        log.info(<span class="hljs-string">&quot;发送一条时长: &#123;&#125; 毫秒信息给队列: &#123;&#125;  内容: &#123;&#125;&quot;</span>, ttl, DeadConfig.TTL_QUEUE, msg);<br>    &#125;);<br>   TimeUnit.SECONDS.sleep(<span class="hljs-number">20</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2022/01/25/RabbitMQ/%E6%AD%BB%E4%BF%A1TTL.png" srcset="/img/loading.gif" lazyload alt></p><p>图中可以看dead.ttl.queue指定了<code>DLX</code> <code>DLK</code>,当消息TTL过期，则会将消息转发到<code>dead_exchange</code>交换机然后根据配置的死信路由键路由到<code>dead.queue</code>队列</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs verilog">INFO <span class="hljs-number">18352</span> --- [ntContainer#<span class="hljs-number">0</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.DeadListener</span>       : 死信队列接受到死信：delay:<span class="hljs-number">0</span><br>INFO <span class="hljs-number">18352</span> --- [ntContainer#<span class="hljs-number">0</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.DeadListener</span>       : 死信队列接受到死信：delay:<span class="hljs-number">1</span><br>INFO <span class="hljs-number">18352</span> --- [ntContainer#<span class="hljs-number">0</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.DeadListener</span>       : 死信队列接受到死信：delay:<span class="hljs-number">2</span><br>INFO <span class="hljs-number">18352</span> --- [ntContainer#<span class="hljs-number">0</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.DeadListener</span>       : 死信队列接受到死信：delay:<span class="hljs-number">3</span><br>INFO <span class="hljs-number">18352</span> --- [ntContainer#<span class="hljs-number">0</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.DeadListener</span>       : 死信队列接受到死信：delay:<span class="hljs-number">4</span><br>INFO <span class="hljs-number">18352</span> --- [ntContainer#<span class="hljs-number">0</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.DeadListener</span>       : 死信队列接受到死信：delay:<span class="hljs-number">5</span><br>INFO <span class="hljs-number">18352</span> --- [ntContainer#<span class="hljs-number">0</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.DeadListener</span>       : 死信队列接受到死信：delay:<span class="hljs-number">6</span><br>INFO <span class="hljs-number">18352</span> --- [ntContainer#<span class="hljs-number">0</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.DeadListener</span>       : 死信队列接受到死信：delay:<span class="hljs-number">7</span><br>INFO <span class="hljs-number">18352</span> --- [ntContainer#<span class="hljs-number">0</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.DeadListener</span>       : 死信队列接受到死信：delay:<span class="hljs-number">8</span><br>INFO <span class="hljs-number">18352</span> --- [ntContainer#<span class="hljs-number">0</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.DeadListener</span>       : 死信队列接受到死信：delay:<span class="hljs-number">9</span><br></code></pre></td></tr></table></figure><h3 id="队列达到最大长度"><a class="markdownIt-Anchor" href="#队列达到最大长度"></a> 队列达到最大长度</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-meta">@SneakyThrows</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deadLengthTest</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>        rabbitTemplate.convertAndSend(DeadConfig.NORMAL_EXCHANGE, DeadConfig.LENGTH_ROUTING_KEY, i + <span class="hljs-string">&quot;&quot;</span>);<br>    &#125;<br>    TimeUnit.SECONDS.sleep(<span class="hljs-number">10</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>先看队列<code>dead.length.queue</code>消息，剩余4条，和配置的容量符合，编号0-5的消息淘汰后被转发到死信队列</p><p><img src="/2022/01/25/RabbitMQ/deadLength.png" srcset="/img/loading.gif" lazyload alt></p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs verilog">INFO <span class="hljs-number">16096</span> --- [ntContainer#<span class="hljs-number">1</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.DeadListener</span>       : 死信队列接受到死信：<span class="hljs-number">0</span><br>INFO <span class="hljs-number">16096</span> --- [ntContainer#<span class="hljs-number">1</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.DeadListener</span>       : 死信队列接受到死信：<span class="hljs-number">2</span><br>INFO <span class="hljs-number">16096</span> --- [ntContainer#<span class="hljs-number">1</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.DeadListener</span>       : 死信队列接受到死信：<span class="hljs-number">1</span><br>INFO <span class="hljs-number">16096</span> --- [ntContainer#<span class="hljs-number">1</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.DeadListener</span>       : 死信队列接受到死信：<span class="hljs-number">4</span><br>INFO <span class="hljs-number">16096</span> --- [ntContainer#<span class="hljs-number">1</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.DeadListener</span>       : 死信队列接受到死信：<span class="hljs-number">5</span><br>INFO <span class="hljs-number">16096</span> --- [ntContainer#<span class="hljs-number">1</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.DeadListener</span>       : 死信队列接受到死信：<span class="hljs-number">3</span><br></code></pre></td></tr></table></figure><p class="note note-primary">队列溢出的默认行为</p><p>当队列的消息超过设置的最大长度或大小时，<span class="green-line">RabbitMQ默认的做法是将处于队列头部的信息（队列中最老的消息）丢弃或变成死信</span></p><h3 id="消息被拒"><a class="markdownIt-Anchor" href="#消息被拒"></a> 消息被拒</h3><p>监听器Nack，拒绝消息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-meta">@SneakyThrows</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deadNackTest</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) &#123;<br>        rabbitTemplate.convertAndSend(DeadConfig.NORMAL_EXCHANGE, DeadConfig.NACK_ROUTING_KEY, i + <span class="hljs-string">&quot;&quot;</span>);<br>    &#125;<br>    TimeUnit.SECONDS.sleep(<span class="hljs-number">10</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2022/01/25/RabbitMQ/deadAck.png" srcset="/img/loading.gif" lazyload alt></p><p>最终所有拒收的消息都被转发到死信队列中</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs verilog">INFO <span class="hljs-number">7464</span> --- [ntContainer#<span class="hljs-number">1</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.DeadListener</span>       : 死信队列接受到死信：<span class="hljs-number">0</span><br>INFO <span class="hljs-number">7464</span> --- [ntContainer#<span class="hljs-number">1</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.DeadListener</span>       : 死信队列接受到死信：<span class="hljs-number">1</span><br>INFO <span class="hljs-number">7464</span> --- [ntContainer#<span class="hljs-number">1</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.DeadListener</span>       : 死信队列接受到死信：<span class="hljs-number">2</span><br></code></pre></td></tr></table></figure><h3 id="basicreject-basicnack-basicrecover区别"><a class="markdownIt-Anchor" href="#basicreject-basicnack-basicrecover区别"></a> basicReject / basicNack / basicRecover区别</h3><p class="note note-primary">Reject</p><p>channel.basicReject(deliveryTag, true);</p><p>basic.reject方法拒绝deliveryTag对应的消息，第二个参数是否<code>requeue</code>，true则重新入队列，否则<code>丢弃</code>或者<code>进入死信队列</code>，<span class="green-line">一次只能拒绝一条</span></p><p class="note note-primary">Nack</p><p>channel.basicNack(deliveryTag, false, true);</p><p>basic.nack方法为不确认deliveryTag对应的消息，第二个参数是否应用于多消息，第三个参数是否<code>requeue</code>，<span class="green-line">与basic.reject区别就是同时支持多个消息</span>，nack后消息重新回到队列头部重新消费，消息还是会被自己重新消费</p><p class="note note-primary">Recover</p><p>channel.basicRecover(true);</p><p>basic.recover是否恢复消息到队列，参数是是否<code>requeue</code>，true则重新入队列，并且<span class="green-line">尽可能的将之前<code>recover</code>的消息投递给<code>其他消费者消费</code>，而不是自己再次消费</span>。false则消息会重新被投递给自己。</p><h2 id="延迟队列"><a class="markdownIt-Anchor" href="#延迟队列"></a> 延迟队列</h2><p><span class="green-line">延迟队列是一种用于实现消息延迟传递的特殊队列类型。它允许你将消息发送到队列，并在一定的延迟时间之后才将消息投递给消费者。</span>这对于需要执行计划任务、调度任务或实现消息重试机制等情况非常有用。</p><h3 id="延迟队列使用场景"><a class="markdownIt-Anchor" href="#延迟队列使用场景"></a> 延迟队列使用场景</h3><ol><li><code>订单超时取消</code>：如果用户下单后十分钟内未支付，系统会自动取消订单，而不需要等待用户手动取消，提供更好的用户体验。</li><li><code>店铺提醒</code>：新创建的店铺如果在十天内没有上传商品，系统会自动发送消息提醒店主，确保店铺及时添加商品。</li><li><code>用户登录提醒</code>：用户注册成功后，如果三天内没有登录，系统将通过短信提醒用户，激发用户活跃度。</li><li><code>退款处理通知</code>：用户发起退款申请后，如果三天内没有得到处理，系统会通知相关运营人员，保障退款流程的顺利进行。</li><li><code>会议提醒</code>：预定的会议开始前十分钟，系统会自动通知所有与会人员，确保大家按时参加会议，提高会议的准时性。</li></ol><p>在这些情况下，延迟队列的作用是在特定的时间点触发相应的任务，而不需要持续不断地查询数据库，从而提高了系统的效率和性能，尤其在处理大规模数据和有时限要求的情况下，延迟队列显得尤为重要和高效。</p><h3 id="代码架构图"><a class="markdownIt-Anchor" href="#代码架构图"></a> 代码架构图</h3><p><code>用TTL和死信队列实现延迟队列功能</code></p><p><img src="/2022/01/25/RabbitMQ/%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97.png" srcset="/img/loading.gif" lazyload alt></p><p>原生延迟队列的核心思想是利用消息的 <code>TTL</code> 和 <code>死信队列</code> 来实现。</p><p>代码结构可以参考 <a href="#ttl过期" title="ttl过期">ttl过期</a> ，不过需要新增一个队列并将其绑定到死信队列上。重要的是，不监听正常队列，而是监听死信队列。这样，RabbitMQ会在消息的TTL过期后自动将消息转发到死信队列，从而实现延迟效果。</p><p class="note note-primary">缺点</p><p>需要注意的是，这种方法的缺点是每增加一个新的时间需求就需要新增一个队列。例如，如果需要一个小时后处理，就需要创建一个TTL为一个小时的队列。对于一些需要不同延迟时间的场景，可能需要创建大量队列，这会导致管理复杂性增加。</p><h3 id="原生延迟队列缺点"><a class="markdownIt-Anchor" href="#原生延迟队列缺点"></a> 原生延迟队列缺点</h3><p><span class="green-line">当队列中的消息按照它们的TTL（生存时间）排列时，如果队列头部的消息的TTL比后面的消息要长，那么头部的消息会阻塞后面的消息。</span></p><p class="note note-primary">缺点</p><p><img src="/2022/01/25/RabbitMQ/%E6%AD%BB%E4%BF%A1%E9%98%9F%E5%88%97%E7%BC%BA%E7%82%B9.png" srcset="/img/loading.gif" lazyload alt></p><p>简单来说，如果你使用消息属性上设置TTL的方式，RabbitMQ只会检查队列中的第一个消息是否过期，如果过期，它会被移到死信队列中。问题在于，如果第一个消息的延迟时间很长，而第二个消息的延迟时间很短，第二个消息并不会优先执行，因为RabbitMQ只检查队列头部的消息是否过期。这可能导致消息执行的顺序不符合你的预期。</p><p class="note note-primary">添加配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TtlQueueConfig</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 死信队列</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEAD_EXCHANGE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;dead_ttl_exchange&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEAD_QUEUE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;dead.ttl.overdue.queue&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEAD_ROUTING_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;overdue&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 正常队列，发送消息时，在消息设置TTL过期</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TTL_EXCHANGE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ttl_exchange&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TTL_QUEUE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ttl.queue&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TTL_ROUTING_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ttl&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建死信交换机</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> DirectExchange <span class="hljs-title function_">deadTtlExchange</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DirectExchange</span>(DEAD_EXCHANGE);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建死信队列，正常队列TTL过期将死信转发到死信队列</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">deadTtlOverdueQueue</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(DEAD_QUEUE);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 绑定死信队列</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">bindDeadTtlOverdueQueue</span><span class="hljs-params">(Queue deadTtlOverdueQueue, DirectExchange deadTtlExchange)</span> &#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(deadTtlOverdueQueue).to(deadTtlExchange).with(DEAD_ROUTING_KEY);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建正常交换机</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> DirectExchange <span class="hljs-title function_">ttlExchange</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DirectExchange</span>(TTL_EXCHANGE);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建正常队列</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">ttlQueue</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 正常队列绑定死信队列</span><br>        Map&lt;String, Object&gt; args = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(<span class="hljs-number">8</span>);<br>        <span class="hljs-comment">// 声明死信队列交换机，消息异常投递到此交换机</span><br>        args.put(<span class="hljs-string">&quot;x-dead-letter-exchange&quot;</span>, DEAD_EXCHANGE);<br>        <span class="hljs-comment">// 声明死信队列路由键</span><br>        args.put(<span class="hljs-string">&quot;x-dead-letter-routing-key&quot;</span>, DEAD_ROUTING_KEY);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(TTL_QUEUE, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, args);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 正常队列绑定交换机</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">bindTtlQueue</span><span class="hljs-params">(Queue ttlQueue, DirectExchange ttlExchange)</span> &#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(ttlQueue).to(ttlExchange).with(TTL_ROUTING_KEY);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p class="note note-primary">添加死信监听器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TtlListener</span> &#123;<br>    <span class="hljs-meta">@RabbitListener(queues = TtlQueueConfig.DEAD_QUEUE)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">receive</span><span class="hljs-params">(String msg)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;死信队列 &#123;&#125; 接收信息:&#123;&#125;&quot;</span>, TtlQueueConfig.DEAD_QUEUE, msg);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p class="note note-primary">发送动态TTL消息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ttlMsgTest</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>    IntStream.range(<span class="hljs-number">0</span>, <span class="hljs-number">4</span>).forEach(line -&gt; &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">ttl</span> <span class="hljs-operator">=</span> <span class="hljs-number">60000</span> - (line * <span class="hljs-number">5000</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;delay:&quot;</span> + line;<br><br>        rabbitTemplate.convertAndSend(TtlQueueConfig.TTL_EXCHANGE, TtlQueueConfig.TTL_ROUTING_KEY, msg, correlationData -&gt; &#123;<br>            <span class="hljs-comment">// 动态设置消息ttl</span><br>            correlationData.getMessageProperties().setExpiration(String.valueOf(ttl));<br>            <span class="hljs-keyword">return</span> correlationData;<br>        &#125;);<br><br><br>        log.info(<span class="hljs-string">&quot;发送一条时长: &#123;&#125; 毫秒信息给延迟队列: &#123;&#125;  内容: &#123;&#125;&quot;</span>, ttl, TtlQueueConfig.TTL_QUEUE, msg);<br>    &#125;);<br>    TimeUnit.SECONDS.sleep(<span class="hljs-number">70</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p class="note note-primary">生产者log</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs verilog"><span class="hljs-number">19</span>:<span class="hljs-number">09</span>:<span class="hljs-number">32</span><span class="hljs-variable">.706</span>  INFO <span class="hljs-number">7708</span> --- [           main] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.QeueuTest</span>                   : 发送一条时长: <span class="hljs-number">60000</span> 毫秒信息给延迟队列: ttl<span class="hljs-variable">.queue</span>  内容: delay:<span class="hljs-number">0</span><br><span class="hljs-number">19</span>:<span class="hljs-number">09</span>:<span class="hljs-number">32</span><span class="hljs-variable">.733</span>  INFO <span class="hljs-number">7708</span> --- [           main] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.QeueuTest</span>                   : 发送一条时长: <span class="hljs-number">55000</span> 毫秒信息给延迟队列: ttl<span class="hljs-variable">.queue</span>  内容: delay:<span class="hljs-number">1</span><br><span class="hljs-number">19</span>:<span class="hljs-number">09</span>:<span class="hljs-number">32</span><span class="hljs-variable">.733</span>  INFO <span class="hljs-number">7708</span> --- [           main] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.QeueuTest</span>                   : 发送一条时长: <span class="hljs-number">50000</span> 毫秒信息给延迟队列: ttl<span class="hljs-variable">.queue</span>  内容: delay:<span class="hljs-number">2</span><br><span class="hljs-number">19</span>:<span class="hljs-number">09</span>:<span class="hljs-number">32</span><span class="hljs-variable">.756</span>  INFO <span class="hljs-number">7708</span> --- [           main] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.QeueuTest</span>                   : 发送一条时长: <span class="hljs-number">45000</span> 毫秒信息给延迟队列: ttl<span class="hljs-variable">.queue</span>  内容: delay:<span class="hljs-number">3</span><br></code></pre></td></tr></table></figure><p class="note note-primary">消费者log</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs verilog"><span class="hljs-number">19</span>:<span class="hljs-number">10</span>:<span class="hljs-number">32</span><span class="hljs-variable">.736</span>  INFO <span class="hljs-number">7708</span> --- [ntContainer#<span class="hljs-number">0</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.TtlListener</span>        : 死信队列 dead<span class="hljs-variable">.ttl</span><span class="hljs-variable">.overdue</span><span class="hljs-variable">.queue</span> 接收信息:delay:<span class="hljs-number">0</span><br><span class="hljs-number">19</span>:<span class="hljs-number">10</span>:<span class="hljs-number">32</span><span class="hljs-variable">.736</span>  INFO <span class="hljs-number">7708</span> --- [ntContainer#<span class="hljs-number">0</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.TtlListener</span>        : 死信队列 dead<span class="hljs-variable">.ttl</span><span class="hljs-variable">.overdue</span><span class="hljs-variable">.queue</span> 接收信息:delay:<span class="hljs-number">1</span><br><span class="hljs-number">19</span>:<span class="hljs-number">10</span>:<span class="hljs-number">32</span><span class="hljs-variable">.736</span>  INFO <span class="hljs-number">7708</span> --- [ntContainer#<span class="hljs-number">0</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.TtlListener</span>        : 死信队列 dead<span class="hljs-variable">.ttl</span><span class="hljs-variable">.overdue</span><span class="hljs-variable">.queue</span> 接收信息:delay:<span class="hljs-number">2</span><br><span class="hljs-number">19</span>:<span class="hljs-number">10</span>:<span class="hljs-number">32</span><span class="hljs-variable">.737</span>  INFO <span class="hljs-number">7708</span> --- [ntContainer#<span class="hljs-number">0</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.TtlListener</span>        : 死信队列 dead<span class="hljs-variable">.ttl</span><span class="hljs-variable">.overdue</span><span class="hljs-variable">.queue</span> 接收信息:delay:<span class="hljs-number">3</span><br></code></pre></td></tr></table></figure><p>对比生产者和消费者的日志时间不难看出，<span class="green-line">TTL时间比第一条时间短的消息全部被第一条阻塞</span></p><h3 id="插件实现延迟队列"><a class="markdownIt-Anchor" href="#插件实现延迟队列"></a> 插件实现延迟队列</h3><p>上文中提到的问题，确实是一个问题，如果不能实现在消息粒度上的TTL，并使其在设置的TTL时间及时死亡，就无法设计成一个通用的延时队列。那如何解决呢，接下来我们就去解决该问题</p><h4 id="安装延时队列插件docker"><a class="markdownIt-Anchor" href="#安装延时队列插件docker"></a> 安装延时队列插件（docker）</h4><ul><li><p>rabbitmq在容器中的插件目录：<code>/opt/rabbitmq/plugins</code></p></li><li><p>在<a target="_blank" rel="noopener" href="https://github.com/rabbitmq/rabbitmq-delayed-message-exchange/tags">Tags · rabbitmq/rabbitmq-delayed-message-exchange · GitHub</a>，下载 <strong>rabbitmq_delayed_message_exchange</strong> 对应版本插件，笔者是在页面获取下载链接使用wget命令下载 <a target="_blank" rel="noopener" href="https://github.com/rabbitmq/rabbitmq-delayed-message-exchange/releases/download/3.8.9/rabbitmq_delayed_message_exchange-3.8.9-0199d11c.ez">3.8.9</a>下载地址</p></li><li><p>修改文件的权限: chmod 755 rabbitmq_delayed_message_exchange-3.8.9-0199d11c.ez</p></li><li><p>执行命令rabbitmq-plugins enable rabbitmq_delayed_message_exchange<br>注意：不需要带插件的版本和文件后缀.ez</p><p><img src="/2022/01/25/RabbitMQ/%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97%E5%AE%89%E8%A3%85%E6%97%A5%E5%BF%97.png" srcset="/img/loading.gif" lazyload alt></p><p>安装成功日志</p></li><li><p>查看已安装的插件：rabbitmq-plugins list</p><p><img src="/2022/01/25/RabbitMQ/%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97%E6%9F%A5%E7%9C%8B.png" srcset="/img/loading.gif" lazyload alt></p></li><li><p>重启RabbitMQ docker容器， 查看插件是否生效</p><p><img src="/2022/01/25/RabbitMQ/%E5%BB%B6%E8%BF%9F%E4%BA%A4%E6%8D%A2%E6%9C%BA2.png" srcset="/img/loading.gif" lazyload alt></p></li></ul><h4 id="代码实现"><a class="markdownIt-Anchor" href="#代码实现"></a> 代码实现</h4><p><img src="/2022/01/25/RabbitMQ/%E5%BB%B6%E8%BF%9F%E4%BA%A4%E6%8D%A2%E6%9C%BA.png" srcset="/img/loading.gif" lazyload alt></p><p class="note note-primary">定义队列和交换机</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DelayedConfig</span> &#123;<br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DELAYED_EXCHANGE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;delayed_exchange&quot;</span>;<br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DELAYED_QUEUE</span>  <span class="hljs-operator">=</span> <span class="hljs-string">&quot;delayed.queue&quot;</span>;<br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DELAYED_ROUTING_KEY</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Delayed&quot;</span>;<br><br> <span class="hljs-meta">@Bean</span><br> <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">delayedQueue</span><span class="hljs-params">()</span> &#123;<br>     <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(DELAYED_QUEUE);<br> &#125;<br><br> <span class="hljs-meta">@Bean</span><br> <span class="hljs-keyword">public</span> CustomExchange <span class="hljs-title function_">delayedExchange</span><span class="hljs-params">()</span> &#123;<br><br>     <span class="hljs-comment">// 延迟交换机类型</span><br>     Map&lt;String, Object&gt; args = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(<span class="hljs-number">8</span>);<br>     args.put(<span class="hljs-string">&quot;x-delayed-type&quot;</span>, <span class="hljs-string">&quot;direct&quot;</span>);<br><br>     <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 1.交换机名称</span><br><span class="hljs-comment">         * 2.交换机类型</span><br><span class="hljs-comment">         * 3.是否需要持久化</span><br><span class="hljs-comment">         * 4.是否自动删除</span><br><span class="hljs-comment">         * 5.其他参数</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomExchange</span>(DELAYED_EXCHANGE, <span class="hljs-string">&quot;x-delayed-message&quot;</span>,<span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>, args);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 延迟交换机绑定队列</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> delayedQueue</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> delayedExchange</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">bindDelayedQueue</span><span class="hljs-params">(Queue delayedQueue, CustomExchange delayedExchange)</span> &#123;<br>         <span class="hljs-keyword">return</span> BindingBuilder.bind(delayedQueue).to(delayedExchange).with(DELAYED_ROUTING_KEY).noargs();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p class="note note-primary">监听器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DelayedListener</span> &#123;<br>    <span class="hljs-comment">// 注释手动ack模式</span><br>    <span class="hljs-meta">@RabbitListener(queues = DelayedConfig.DELAYED_QUEUE)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">listener</span><span class="hljs-params">(String msg)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;延迟队列 &#123;&#125; 接收信息:&#123;&#125;&quot;</span>, DelayedConfig.DELAYED_QUEUE, msg);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p class="note note-primary">发送消息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">delayedTest</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>       IntStream.range(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>).forEach(line -&gt; &#123;<br>           <span class="hljs-type">int</span> <span class="hljs-variable">delay</span> <span class="hljs-operator">=</span> <span class="hljs-number">60000</span> - (line * <span class="hljs-number">5000</span>);<br>           <span class="hljs-type">String</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;delay:&quot;</span> + line;<br><br>           rabbitTemplate.convertAndSend(DelayedConfig.DELAYED_EXCHANGE, DelayedConfig.DELAYED_ROUTING_KEY, msg, correlationData -&gt; &#123;<br>               <span class="hljs-comment">// 设置消息的延迟时间 单位ms</span><br>               correlationData.getMessageProperties().setDelay(delay);<br>               <span class="hljs-keyword">return</span> correlationData;<br>           &#125;);<br><br>           log.info(<span class="hljs-string">&quot;发送一条时长: &#123;&#125; 毫秒信息给延迟队列: &#123;&#125;  内容: &#123;&#125;&quot;</span>, delay, DelayedConfig.DELAYED_QUEUE, msg);<br>       &#125;);<br>       TimeUnit.SECONDS.sleep(<span class="hljs-number">70</span>);<br>   &#125;<br></code></pre></td></tr></table></figure><p class="note note-primary">生产者log</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs verilog"><span class="hljs-number">20</span>:<span class="hljs-number">05</span>:<span class="hljs-number">29</span><span class="hljs-variable">.763</span>  INFO <span class="hljs-number">14100</span> --- [           main] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.QeueuTest</span>                   : 发送一条时长: <span class="hljs-number">60000</span> 毫秒信息给延迟队列: delayed<span class="hljs-variable">.queue</span>  内容: delay:<span class="hljs-number">0</span><br><span class="hljs-number">20</span>:<span class="hljs-number">05</span>:<span class="hljs-number">29</span><span class="hljs-variable">.785</span>  INFO <span class="hljs-number">14100</span> --- [           main] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.QeueuTest</span>                   : 发送一条时长: <span class="hljs-number">55000</span> 毫秒信息给延迟队列: delayed<span class="hljs-variable">.queue</span>  内容: delay:<span class="hljs-number">1</span><br><span class="hljs-number">20</span>:<span class="hljs-number">05</span>:<span class="hljs-number">29</span><span class="hljs-variable">.786</span>  INFO <span class="hljs-number">14100</span> --- [           main] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.QeueuTest</span>                   : 发送一条时长: <span class="hljs-number">50000</span> 毫秒信息给延迟队列: delayed<span class="hljs-variable">.queue</span>  内容: delay:<span class="hljs-number">2</span><br><span class="hljs-number">20</span>:<span class="hljs-number">05</span>:<span class="hljs-number">29</span><span class="hljs-variable">.808</span>  INFO <span class="hljs-number">14100</span> --- [           main] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.QeueuTest</span>                   : 发送一条时长: <span class="hljs-number">45000</span> 毫秒信息给延迟队列: delayed<span class="hljs-variable">.queue</span>  内容: delay:<span class="hljs-number">3</span><br><span class="hljs-number">20</span>:<span class="hljs-number">05</span>:<span class="hljs-number">29</span><span class="hljs-variable">.808</span>  INFO <span class="hljs-number">14100</span> --- [           main] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.QeueuTest</span>                   : 发送一条时长: <span class="hljs-number">40000</span> 毫秒信息给延迟队列: delayed<span class="hljs-variable">.queue</span>  内容: delay:<span class="hljs-number">4</span><br><span class="hljs-number">20</span>:<span class="hljs-number">05</span>:<span class="hljs-number">29</span><span class="hljs-variable">.808</span>  INFO <span class="hljs-number">14100</span> --- [           main] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.QeueuTest</span>                   : 发送一条时长: <span class="hljs-number">35000</span> 毫秒信息给延迟队列: delayed<span class="hljs-variable">.queue</span>  内容: delay:<span class="hljs-number">5</span><br><span class="hljs-number">20</span>:<span class="hljs-number">05</span>:<span class="hljs-number">29</span><span class="hljs-variable">.831</span>  INFO <span class="hljs-number">14100</span> --- [           main] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.QeueuTest</span>                   : 发送一条时长: <span class="hljs-number">30000</span> 毫秒信息给延迟队列: delayed<span class="hljs-variable">.queue</span>  内容: delay:<span class="hljs-number">6</span><br><span class="hljs-number">20</span>:<span class="hljs-number">05</span>:<span class="hljs-number">29</span><span class="hljs-variable">.832</span>  INFO <span class="hljs-number">14100</span> --- [           main] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.QeueuTest</span>                   : 发送一条时长: <span class="hljs-number">25000</span> 毫秒信息给延迟队列: delayed<span class="hljs-variable">.queue</span>  内容: delay:<span class="hljs-number">7</span><br><span class="hljs-number">20</span>:<span class="hljs-number">05</span>:<span class="hljs-number">29</span><span class="hljs-variable">.832</span>  INFO <span class="hljs-number">14100</span> --- [           main] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.QeueuTest</span>                   : 发送一条时长: <span class="hljs-number">20000</span> 毫秒信息给延迟队列: delayed<span class="hljs-variable">.queue</span>  内容: delay:<span class="hljs-number">8</span><br><span class="hljs-number">20</span>:<span class="hljs-number">05</span>:<span class="hljs-number">29</span><span class="hljs-variable">.832</span>  INFO <span class="hljs-number">14100</span> --- [           main] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.QeueuTest</span>                   : 发送一条时长: <span class="hljs-number">15000</span> 毫秒信息给延迟队列: delayed<span class="hljs-variable">.queue</span>  内容: delay:<span class="hljs-number">9</span><br></code></pre></td></tr></table></figure><p class="note note-primary">消费者log</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-number">20</span>:<span class="hljs-number">05</span>:<span class="hljs-number">44.852</span>  INFO <span class="hljs-number">14100</span> --- <span class="hljs-selector-attr">[ntContainer#3-1]</span> com<span class="hljs-selector-class">.wgf</span><span class="hljs-selector-class">.demo</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.DelayedListener</span>    : 延迟队列 delayed<span class="hljs-selector-class">.queue</span> 接收信息:delay:<span class="hljs-number">9</span><br><span class="hljs-number">20</span>:<span class="hljs-number">05</span>:<span class="hljs-number">49.845</span>  INFO <span class="hljs-number">14100</span> --- <span class="hljs-selector-attr">[ntContainer#3-1]</span> com<span class="hljs-selector-class">.wgf</span><span class="hljs-selector-class">.demo</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.DelayedListener</span>    : 延迟队列 delayed<span class="hljs-selector-class">.queue</span> 接收信息:delay:<span class="hljs-number">8</span><br><span class="hljs-number">20</span>:<span class="hljs-number">05</span>:<span class="hljs-number">54.844</span>  INFO <span class="hljs-number">14100</span> --- <span class="hljs-selector-attr">[ntContainer#3-1]</span> com<span class="hljs-selector-class">.wgf</span><span class="hljs-selector-class">.demo</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.DelayedListener</span>    : 延迟队列 delayed<span class="hljs-selector-class">.queue</span> 接收信息:delay:<span class="hljs-number">7</span><br><span class="hljs-number">20</span>:<span class="hljs-number">05</span>:<span class="hljs-number">59.844</span>  INFO <span class="hljs-number">14100</span> --- <span class="hljs-selector-attr">[ntContainer#3-1]</span> com<span class="hljs-selector-class">.wgf</span><span class="hljs-selector-class">.demo</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.DelayedListener</span>    : 延迟队列 delayed<span class="hljs-selector-class">.queue</span> 接收信息:delay:<span class="hljs-number">6</span><br><span class="hljs-number">20</span>:<span class="hljs-number">06</span>:<span class="hljs-number">04.821</span>  INFO <span class="hljs-number">14100</span> --- <span class="hljs-selector-attr">[ntContainer#3-1]</span> com<span class="hljs-selector-class">.wgf</span><span class="hljs-selector-class">.demo</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.DelayedListener</span>    : 延迟队列 delayed<span class="hljs-selector-class">.queue</span> 接收信息:delay:<span class="hljs-number">5</span><br><span class="hljs-number">20</span>:<span class="hljs-number">06</span>:<span class="hljs-number">09.821</span>  INFO <span class="hljs-number">14100</span> --- <span class="hljs-selector-attr">[ntContainer#3-1]</span> com<span class="hljs-selector-class">.wgf</span><span class="hljs-selector-class">.demo</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.DelayedListener</span>    : 延迟队列 delayed<span class="hljs-selector-class">.queue</span> 接收信息:delay:<span class="hljs-number">4</span><br><span class="hljs-number">20</span>:<span class="hljs-number">06</span>:<span class="hljs-number">14.821</span>  INFO <span class="hljs-number">14100</span> --- <span class="hljs-selector-attr">[ntContainer#3-1]</span> com<span class="hljs-selector-class">.wgf</span><span class="hljs-selector-class">.demo</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.DelayedListener</span>    : 延迟队列 delayed<span class="hljs-selector-class">.queue</span> 接收信息:delay:<span class="hljs-number">3</span><br><span class="hljs-number">20</span>:<span class="hljs-number">06</span>:<span class="hljs-number">19.799</span>  INFO <span class="hljs-number">14100</span> --- <span class="hljs-selector-attr">[ntContainer#3-1]</span> com<span class="hljs-selector-class">.wgf</span><span class="hljs-selector-class">.demo</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.DelayedListener</span>    : 延迟队列 delayed<span class="hljs-selector-class">.queue</span> 接收信息:delay:<span class="hljs-number">2</span><br><span class="hljs-number">20</span>:<span class="hljs-number">06</span>:<span class="hljs-number">24.798</span>  INFO <span class="hljs-number">14100</span> --- <span class="hljs-selector-attr">[ntContainer#3-1]</span> com<span class="hljs-selector-class">.wgf</span><span class="hljs-selector-class">.demo</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.DelayedListener</span>    : 延迟队列 delayed<span class="hljs-selector-class">.queue</span> 接收信息:delay:<span class="hljs-number">1</span><br><span class="hljs-number">20</span>:<span class="hljs-number">06</span>:<span class="hljs-number">29.776</span>  INFO <span class="hljs-number">14100</span> --- <span class="hljs-selector-attr">[ntContainer#3-1]</span> com<span class="hljs-selector-class">.wgf</span><span class="hljs-selector-class">.demo</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.DelayedListener</span>    : 延迟队列 delayed<span class="hljs-selector-class">.queue</span> 接收信息:delay:<span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><p><span class="green-line">从log上看，延迟队列实现了消息粒度的TTL</span></p><p><img src="/2022/01/25/RabbitMQ/%E5%BB%B6%E8%BF%9F%E4%BA%A4%E6%8D%A2%E6%9C%BA3.png" srcset="/img/loading.gif" lazyload alt></p><p>延迟交换机可以看正在被延迟的消息条数</p><p class="note note-primary">x-delayed-type 取值</p><ul><li><code>direct</code></li><li><code>fanout</code></li><li><code>topic</code></li><li><code>headers</code></li></ul><h3 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h3><p>延时队列在需要延时处理的场景下非常有用，使用 <code>RabbitMQ</code> 来实现延时队列可以很好的利用 <code>RabbitMQ</code> 的特性，如：消息可靠发送、消息可靠投递、死信队列来保障消息至少被消费一次以及未被正确处理的消息不会被丢弃。另外，通过 <code>RabbitMQ</code>集群的特性，可以很好的解决单点故障问题，不会因为单个节点挂掉导致延时队列不可用或者消息丢失。 当然，延时队列还有很多其它选择，比如利用 Java 的 <code>DelayQueue</code>，利用 Redis 的 zset，利用 Quartz 或者利用 kafka 的时间轮，这些方式各有特点,看需要适用的场景</p><h2 id="优先级队列"><a class="markdownIt-Anchor" href="#优先级队列"></a> 优先级队列</h2><p>优先级队列是一种队列类型，它允许你为消息设置不同的优先级，以便按照这些优先级来处理消息，越高优先级的消息可能越早被处理。</p><p>消费者需要等待所有消息都进入队列后才能开始消费。这是因为要进行消息的优先级排序，队列必须拥有足够的消息来进行比较。因此，只有当队列中积累了足够的消息后，系统才能按照消息的优先级有序地处理它们。</p><h3 id="使用场景"><a class="markdownIt-Anchor" href="#使用场景"></a> 使用场景</h3><p><code>有消息堆积则按优先级排序，优先级高的先执行</code></p><p><img src="/2022/01/25/RabbitMQ/%E4%BC%98%E5%85%88%E7%BA%A7%E9%98%9F%E5%88%97.png" srcset="/img/loading.gif" lazyload alt></p><ol><li><strong>订单处理</strong>：在电子商务平台上，处理订单可能需要不同的速度，以应对大客户和普通客户的需求。通过为订单设置不同的优先级，可以确保及时处理高价值订单。</li><li><strong>任务调度</strong>：在任务调度系统中，某些任务可能比其他任务更重要或更紧急。使用优先级队列可以确保高优先级任务优先执行，以满足业务需求。</li><li><strong>通知和提醒</strong>：在需要发送通知或提醒的应用中，例如发送短信或电子邮件提醒，您可以使用优先级队列来处理即时通知和紧急提醒，确保它们在时间上得到优先处理。</li><li><strong>资源分配</strong>：在资源有限的情况下，可以使用优先级队列来分配资源，确保高优先级任务或消息得到优先满足。</li></ol><h3 id="代码实现-2"><a class="markdownIt-Anchor" href="#代码实现-2"></a> 代码实现</h3><p class="note note-primary">队列配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PriorityConfig</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PRIORITY_QUEUE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;priority.queue&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PRIORITY_EXCHANGE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;priority.queue&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ROUTING_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;priority&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建队列设置优先级</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">priorityQueue</span><span class="hljs-params">()</span> &#123;<br>        Map&lt;String, Object&gt; args = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(<span class="hljs-number">8</span>);<br>        <span class="hljs-comment">// 设置队列的优先级，取值[0~255] 建议[0~10], 如果有消息堆积则会按照优先级排序，越高的越快被消费</span><br>        args.put(<span class="hljs-string">&quot;x-max-priority&quot;</span>, <span class="hljs-number">10</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(PRIORITY_QUEUE, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, args);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建交换机</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> DirectExchange <span class="hljs-title function_">priorityExchange</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 默认持久化</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DirectExchange</span>(PRIORITY_EXCHANGE, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 绑定队列</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> directQueue</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> directExchange</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">bindPriorityQueue</span><span class="hljs-params">(Queue priorityQueue, DirectExchange priorityExchange)</span> &#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(priorityQueue).to(priorityExchange).with(ROUTING_KEY);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p class="note note-primary">消息监听器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PriorityListener</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 要看到效果，必选让消息全部发送到队列后再进行监听消费，让消息有排序的时间，实时消费排序效果不明显</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> msg</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@RabbitListener(queues = PriorityConfig.PRIORITY_QUEUE)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">receive</span><span class="hljs-params">(String msg)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;队列 &#123;&#125; 接收信息:&#123;&#125;&quot;</span>, PriorityConfig.PRIORITY_QUEUE, msg);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p class="note note-primary">发送消息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">priorityTest</span><span class="hljs-params">()</span> &#123;<br>    IntStream.range(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>).forEach(line -&gt; &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">temp</span> <span class="hljs-operator">=</span> line;<br><br>        <span class="hljs-comment">// 能被2整除的优先级最高</span><br>        <span class="hljs-keyword">if</span> (line % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>) &#123;<br>            temp = <span class="hljs-number">10</span>;<br>        &#125;<br><br>        <span class="hljs-type">int</span> <span class="hljs-variable">priority</span> <span class="hljs-operator">=</span> temp;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;优先级:&quot;</span> + priority;<br><br>        rabbitTemplate.convertAndSend(PriorityConfig.PRIORITY_EXCHANGE, PriorityConfig.ROUTING_KEY, msg, correlationData -&gt; &#123;<br>            <span class="hljs-comment">// 设置队列优先级</span><br>            correlationData.getMessageProperties().setPriority(priority);<br>            <span class="hljs-keyword">return</span> correlationData;<br>        &#125;);<br><br>        log.info(<span class="hljs-string">&quot;发送一条优先级: &#123;&#125; 信息给队列: &#123;&#125;  内容: &#123;&#125;&quot;</span>, priority, PriorityConfig.PRIORITY_QUEUE, msg);<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure><p class="note note-primary">生产者log</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs verilog"><span class="hljs-number">22</span>:<span class="hljs-number">29</span>:<span class="hljs-number">31</span><span class="hljs-variable">.274</span>  INFO <span class="hljs-number">14480</span> --- [           main] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.QeueuTest</span>                   : 发送一条优先级: <span class="hljs-number">1</span> 信息给队列: <span class="hljs-keyword">priority</span><span class="hljs-variable">.queue</span>  内容: 优先级:<span class="hljs-number">1</span><br><span class="hljs-number">22</span>:<span class="hljs-number">29</span>:<span class="hljs-number">31</span><span class="hljs-variable">.297</span>  INFO <span class="hljs-number">14480</span> --- [           main] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.QeueuTest</span>                   : 发送一条优先级: <span class="hljs-number">10</span> 信息给队列: <span class="hljs-keyword">priority</span><span class="hljs-variable">.queue</span>  内容: 优先级:<span class="hljs-number">10</span><br><span class="hljs-number">22</span>:<span class="hljs-number">29</span>:<span class="hljs-number">31</span><span class="hljs-variable">.297</span>  INFO <span class="hljs-number">14480</span> --- [           main] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.QeueuTest</span>                   : 发送一条优先级: <span class="hljs-number">3</span> 信息给队列: <span class="hljs-keyword">priority</span><span class="hljs-variable">.queue</span>  内容: 优先级:<span class="hljs-number">3</span><br><span class="hljs-number">22</span>:<span class="hljs-number">29</span>:<span class="hljs-number">31</span><span class="hljs-variable">.321</span>  INFO <span class="hljs-number">14480</span> --- [           main] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.QeueuTest</span>                   : 发送一条优先级: <span class="hljs-number">10</span> 信息给队列: <span class="hljs-keyword">priority</span><span class="hljs-variable">.queue</span>  内容: 优先级:<span class="hljs-number">10</span><br><span class="hljs-number">22</span>:<span class="hljs-number">29</span>:<span class="hljs-number">31</span><span class="hljs-variable">.321</span>  INFO <span class="hljs-number">14480</span> --- [           main] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.QeueuTest</span>                   : 发送一条优先级: <span class="hljs-number">5</span> 信息给队列: <span class="hljs-keyword">priority</span><span class="hljs-variable">.queue</span>  内容: 优先级:<span class="hljs-number">5</span><br><span class="hljs-number">22</span>:<span class="hljs-number">29</span>:<span class="hljs-number">31</span><span class="hljs-variable">.321</span>  INFO <span class="hljs-number">14480</span> --- [           main] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.QeueuTest</span>                   : 发送一条优先级: <span class="hljs-number">10</span> 信息给队列: <span class="hljs-keyword">priority</span><span class="hljs-variable">.queue</span>  内容: 优先级:<span class="hljs-number">10</span><br><span class="hljs-number">22</span>:<span class="hljs-number">29</span>:<span class="hljs-number">31</span><span class="hljs-variable">.345</span>  INFO <span class="hljs-number">14480</span> --- [           main] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.QeueuTest</span>                   : 发送一条优先级: <span class="hljs-number">7</span> 信息给队列: <span class="hljs-keyword">priority</span><span class="hljs-variable">.queue</span>  内容: 优先级:<span class="hljs-number">7</span><br><span class="hljs-number">22</span>:<span class="hljs-number">29</span>:<span class="hljs-number">31</span><span class="hljs-variable">.345</span>  INFO <span class="hljs-number">14480</span> --- [           main] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.QeueuTest</span>                   : 发送一条优先级: <span class="hljs-number">10</span> 信息给队列: <span class="hljs-keyword">priority</span><span class="hljs-variable">.queue</span>  内容: 优先级:<span class="hljs-number">10</span><br><span class="hljs-number">22</span>:<span class="hljs-number">29</span>:<span class="hljs-number">31</span><span class="hljs-variable">.345</span>  INFO <span class="hljs-number">14480</span> --- [           main] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.QeueuTest</span>                   : 发送一条优先级: <span class="hljs-number">9</span> 信息给队列: <span class="hljs-keyword">priority</span><span class="hljs-variable">.queue</span>  内容: 优先级:<span class="hljs-number">9</span><br></code></pre></td></tr></table></figure><p class="note note-primary">消费者log</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs verilog"><span class="hljs-number">22</span>:<span class="hljs-number">30</span>:<span class="hljs-number">29</span><span class="hljs-variable">.740</span>  INFO <span class="hljs-number">21004</span> --- [ntContainer#<span class="hljs-number">0</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.PriorityListener</span>   : 队列 <span class="hljs-keyword">priority</span><span class="hljs-variable">.queue</span> 接收信息:优先级:<span class="hljs-number">10</span><br><span class="hljs-number">22</span>:<span class="hljs-number">30</span>:<span class="hljs-number">29</span><span class="hljs-variable">.742</span>  INFO <span class="hljs-number">21004</span> --- [ntContainer#<span class="hljs-number">0</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.PriorityListener</span>   : 队列 <span class="hljs-keyword">priority</span><span class="hljs-variable">.queue</span> 接收信息:优先级:<span class="hljs-number">10</span><br><span class="hljs-number">22</span>:<span class="hljs-number">30</span>:<span class="hljs-number">29</span><span class="hljs-variable">.742</span>  INFO <span class="hljs-number">21004</span> --- [ntContainer#<span class="hljs-number">0</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.PriorityListener</span>   : 队列 <span class="hljs-keyword">priority</span><span class="hljs-variable">.queue</span> 接收信息:优先级:<span class="hljs-number">10</span><br><span class="hljs-number">22</span>:<span class="hljs-number">30</span>:<span class="hljs-number">29</span><span class="hljs-variable">.742</span>  INFO <span class="hljs-number">21004</span> --- [ntContainer#<span class="hljs-number">0</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.PriorityListener</span>   : 队列 <span class="hljs-keyword">priority</span><span class="hljs-variable">.queue</span> 接收信息:优先级:<span class="hljs-number">10</span><br><span class="hljs-number">22</span>:<span class="hljs-number">30</span>:<span class="hljs-number">29</span><span class="hljs-variable">.743</span>  INFO <span class="hljs-number">21004</span> --- [ntContainer#<span class="hljs-number">0</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.PriorityListener</span>   : 队列 <span class="hljs-keyword">priority</span><span class="hljs-variable">.queue</span> 接收信息:优先级:<span class="hljs-number">9</span><br><span class="hljs-number">22</span>:<span class="hljs-number">30</span>:<span class="hljs-number">29</span><span class="hljs-variable">.754</span>  INFO <span class="hljs-number">21004</span> --- [ntContainer#<span class="hljs-number">0</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.PriorityListener</span>   : 队列 <span class="hljs-keyword">priority</span><span class="hljs-variable">.queue</span> 接收信息:优先级:<span class="hljs-number">7</span><br><span class="hljs-number">22</span>:<span class="hljs-number">30</span>:<span class="hljs-number">29</span><span class="hljs-variable">.754</span>  INFO <span class="hljs-number">21004</span> --- [ntContainer#<span class="hljs-number">0</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.PriorityListener</span>   : 队列 <span class="hljs-keyword">priority</span><span class="hljs-variable">.queue</span> 接收信息:优先级:<span class="hljs-number">5</span><br><span class="hljs-number">22</span>:<span class="hljs-number">30</span>:<span class="hljs-number">29</span><span class="hljs-variable">.755</span>  INFO <span class="hljs-number">21004</span> --- [ntContainer#<span class="hljs-number">0</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.PriorityListener</span>   : 队列 <span class="hljs-keyword">priority</span><span class="hljs-variable">.queue</span> 接收信息:优先级:<span class="hljs-number">3</span><br><span class="hljs-number">22</span>:<span class="hljs-number">30</span>:<span class="hljs-number">29</span><span class="hljs-variable">.755</span>  INFO <span class="hljs-number">21004</span> --- [ntContainer#<span class="hljs-number">0</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.PriorityListener</span>   : 队列 <span class="hljs-keyword">priority</span><span class="hljs-variable">.queue</span> 接收信息:优先级:<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p class="note note-primary">优先级队列标志</p><p><img src="/2022/01/25/RabbitMQ/%E4%BC%98%E5%85%88%E7%BA%A7%E9%98%9F%E5%88%97%E6%A0%87%E5%BF%97.png" srcset="/img/loading.gif" lazyload alt></p><h2 id="惰性队列"><a class="markdownIt-Anchor" href="#惰性队列"></a> 惰性队列</h2><p><code>消息存入磁盘，减少内存占用以便存储更多消息</code></p><p>RabbitMQ 从 <code>3.6.0</code> 版本开始引入了惰性队列的概念。惰性队列（Lazy Queues）是一种特殊类型的队列，旨在提供对大量消息的高效存储和检索。这些队列的设计目标是最小化内存占用，尤其在处理大型消息或大量消息时。以下是有关RabbitMQ惰性队列的详细说明：</p><ol><li><strong>消息的持久性存储</strong>：惰性队列将消息持久地存储在磁盘上而不是内存中，这意味着即使RabbitMQ服务器重新启动，消息也不会丢失。这对于关键数据的可靠性非常重要。</li><li><strong>内存优化</strong>：通常，RabbitMQ队列会将消息保留在内存中以加快消息传递速度。然而，在某些情况下，这可能导致内存耗尽，特别是当处理大型消息或大量消息时。惰性队列通过将消息写入磁盘，减少了内存的使用，因此更适合处理大容量数据。</li><li><strong>延迟加载</strong>：与普通队列不同，惰性队列在消息入队时不会立即将消息写入磁盘。相反，它们采用延迟加载的策略，只有在消息确实需要时才将其加载到内存中。这有助于降低消息入队的延迟，并减少了磁盘I/O的负担。</li><li><strong>适用场景</strong>：惰性队列特别适用于需要处理大型文件、大型数据集或需要长时间存储消息的情况。它们可以减少RabbitMQ服务器的内存占用，从而提高系统的稳定性和性能。</li></ol><p class="note note-primary">注意</p><p>惰性队列的消息存储在<strong>磁盘</strong>上，当消息被消费时，需要从<strong>磁盘</strong>加载到<strong>内存</strong>，然后才会被推送给消费者。因此，惰性队列的消费速度相对较慢。它适合用于消息堆积较多且消息的<strong>实时性要求不高</strong>的场景。</p><h3 id="两种模式"><a class="markdownIt-Anchor" href="#两种模式"></a> 两种模式</h3><p><img src="/2022/01/25/RabbitMQ/%E5%88%9B%E5%BB%BA%E6%83%B0%E6%80%A7%E9%98%9F%E5%88%97.png" srcset="/img/loading.gif" lazyload alt></p><p>队列具备两种模式：<code>default</code> 和 <code>lazy</code>。默认的为 <code>default</code> 模式，在 <code>3.6.0</code> 之前的版本无需做任何变更。<span class="green-line"><code>lazy</code> 模式即为惰性队列的模式</span>，可以通过调用 <code>channel.queueDeclare</code> 方法的时候在参数中设置，也可以通过 Policy 的方式设置，如果一个队列同时使用这两种方式设置的话，那么 Policy 的方式具备更高的优先级。 如果要通过声明的方式改变已有队列的模式的话，那么只能先删除队列，然后再重新声明一个新的</p><p>在队列声明的时候可以通过<code>x-queue-mode</code>参数来设置队列的模式，取值为<code>default</code>和<code>lazy</code></p><h3 id="代码实现-3"><a class="markdownIt-Anchor" href="#代码实现-3"></a> 代码实现</h3><p class="note note-primary">队列配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LazyConfig</span> &#123;<br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">LAZY_QUEUE</span>  <span class="hljs-operator">=</span> <span class="hljs-string">&quot;lazy.queue&quot;</span>;<br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">LAZY_EXCHANGE</span>  <span class="hljs-operator">=</span> <span class="hljs-string">&quot;lazy_exchange&quot;</span>;<br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ROUTING_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;lazy&quot;</span>;<br><br> <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建惰性队列</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">lazyQueue</span><span class="hljs-params">()</span> &#123;<br><br>        <span class="hljs-comment">// 延迟交换机类型</span><br>        Map&lt;String, Object&gt; args = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(<span class="hljs-number">8</span>);<br>        args.put(<span class="hljs-string">&quot;x-queue-mode&quot;</span>, <span class="hljs-string">&quot;lazy&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(LAZY_QUEUE, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, args);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建交换机</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> DirectExchange <span class="hljs-title function_">lazyExchange</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DirectExchange</span>(LAZY_EXCHANGE);<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 队列绑定</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> directQueue</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> directExchange</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">bindLazyQueue</span><span class="hljs-params">(Queue lazyQueue, DirectExchange lazyExchange)</span> &#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(lazyQueue).to(lazyExchange).with(ROUTING_KEY);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p class="note note-primary">发送消息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lazyTest</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; i++) &#123;<br>        rabbitTemplate.convertAndSend(LazyConfig.LAZY_EXCHANGE, LazyConfig.ROUTING_KEY, msg);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p class="note note-primary">惰性队列与普通队列比较</p><p><img src="/2022/01/25/RabbitMQ/%E6%83%B0%E6%80%A7%E9%98%9F%E5%88%97%E6%AF%94%E8%BE%83.png" srcset="/img/loading.gif" lazyload alt></p><p class="note note-primary">内存占用情况</p><p><img src="/2022/01/25/RabbitMQ/%E6%83%B0%E6%80%A7%E9%98%9F%E5%88%97%E5%86%85%E5%AD%98%E6%AF%94%E8%BE%83.png" srcset="/img/loading.gif" lazyload alt></p><p>由此可见惰性队列将数据存储在硬盘中，内存占用较小，适合大量消息堆积场景使用</p><p><code>命令</code>：rabbitmqctl list_queues name messages memory</p><h2 id="备份交换机"><a class="markdownIt-Anchor" href="#备份交换机"></a> 备份交换机</h2><p><code>处理无法被交换机路由的消息</code></p><p><code>消息不丢失又不增加生产者复杂性</code></p><p><img src="/2022/01/25/RabbitMQ/%E5%A4%87%E4%BB%BD%E4%BA%A4%E6%8D%A2%E6%9C%BA.png" srcset="/img/loading.gif" lazyload alt></p><p>在RabbitMQ中，备份交换机可以理解为交换机的“备胎”。<span class="green-line">当一个交换机接收到一条无法路由的消息时，它会把这条消息转发给备份交换机，由备份交换机来进行转发和处理。</span>备份交换机的类型通常为“fanout”型，这样就能把所有消息都投递到与其绑定的队列中。</p><p>备份交换机的优点在于，它提供了一种有效的处理不可路由消息的机制，避免了这些消息被丢失或未被处理的情况。</p><h3 id="代码实现-4"><a class="markdownIt-Anchor" href="#代码实现-4"></a> 代码实现</h3><p class="note note-primary">备份交换机配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BackUpConfig</span> &#123;<br> <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 备份交换机配置</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">BACKUP_EXCHANGE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;backup&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">BACKUP_QUEUE</span>    <span class="hljs-operator">=</span> <span class="hljs-string">&quot;backup.queue&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">WARING_QUEUE</span>    <span class="hljs-operator">=</span> <span class="hljs-string">&quot;waring.queue&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 备份队列</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">backupQueue</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(BACKUP_QUEUE);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 警告队列</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">waringQueue</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(WARING_QUEUE);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 备份交换机</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> FanoutExchange <span class="hljs-title function_">backupExchange</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FanoutExchange</span>(BACKUP_EXCHANGE);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 备份交换机绑定报警队列</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> fanoutQueue1</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> fanoutExchange</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">bindWaringQueue</span><span class="hljs-params">(Queue waringQueue, FanoutExchange backupExchange)</span> &#123;<br>        <span class="hljs-comment">// 不需要 routing_key</span><br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(waringQueue).to(backupExchange);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 备份交换机绑定备份队列</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> fanoutQueue1</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> fanoutExchange</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">bindBackupQueue</span><span class="hljs-params">(Queue backupQueue, FanoutExchange backupExchange)</span> &#123;<br>        <span class="hljs-comment">// 不需要 routing_key</span><br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(backupQueue).to(backupExchange);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 正常交换机队列配置</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">EXCHANGE</span>    <span class="hljs-operator">=</span> <span class="hljs-string">&quot;product_exchange&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">QUEUE</span>       <span class="hljs-operator">=</span> <span class="hljs-string">&quot;product.queue&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ROUTING_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;product&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建队列</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">productQueue</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(QUEUE);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建交换机</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> DirectExchange <span class="hljs-title function_">productExchange</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">ExchangeBuilder</span> <span class="hljs-variable">exchangeBuilder</span> <span class="hljs-operator">=</span> ExchangeBuilder.directExchange(EXCHANGE)<br>                .durable(<span class="hljs-literal">true</span>)<br>                <span class="hljs-comment">// 指定交换机的备份交换机</span><br>                .withArgument(<span class="hljs-string">&quot;alternate-exchange&quot;</span>, BACKUP_EXCHANGE);<br>        <span class="hljs-keyword">return</span> exchangeBuilder.build();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 正常交换机绑定商品队列</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> productQueue</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> productExchange</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">bindProductQueue</span><span class="hljs-params">(Queue productQueue, DirectExchange productExchange)</span> &#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(productQueue).to(productExchange).with(ROUTING_KEY);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p class="note note-primary">消息监听器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BackUpListener</span> &#123;<br>    <span class="hljs-meta">@RabbitListener(queues = BackUpConfig.QUEUE)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">listenerProduct</span><span class="hljs-params">(String msg)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;商品队列接收消息：&#123;&#125;&quot;</span>, msg);<br>    &#125;<br><br>    <span class="hljs-meta">@RabbitListener(queues = BackUpConfig.BACKUP_QUEUE)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">listenerBackup</span><span class="hljs-params">(String msg)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;备份队列接收消息：&#123;&#125;&quot;</span>, msg);<br>    &#125;<br><br>    <span class="hljs-meta">@RabbitListener(queues = BackUpConfig.WARING_QUEUE)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">listenerWaring</span><span class="hljs-params">(String msg)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;报警队列接收消息：&#123;&#125;&quot;</span>, msg);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p class="note note-primary">发送消息</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-meta">@Test</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">backUpTest</span>(<span class="hljs-params"></span>) &#123;<br>       rabbitTemplate.<span class="hljs-title function_">convertAndSend</span>(<span class="hljs-title class_">BackUpConfig</span>.<span class="hljs-property">EXCHANGE</span>, <span class="hljs-title class_">BackUpConfig</span>.<span class="hljs-property">ROUTING_KEY</span>, <span class="hljs-string">&quot;正常商品消息&quot;</span>);<br>       rabbitTemplate.<span class="hljs-title function_">convertAndSend</span>(<span class="hljs-title class_">BackUpConfig</span>.<span class="hljs-property">EXCHANGE</span>, <span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-string">&quot;没有路由键的商品消息&quot;</span>);<br>   &#125;<br></code></pre></td></tr></table></figure><p class="note note-primary">消费者log</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs verilog">INFO <span class="hljs-number">860</span> --- [ntContainer#<span class="hljs-number">1</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.BackUpListener</span>     : 商品队列接收消息：正常商品消息<br>INFO <span class="hljs-number">860</span> --- [ntContainer#<span class="hljs-number">3</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.BackUpListener</span>     : 备份队列接收消息：没有路由键的商品消息<br>INFO <span class="hljs-number">860</span> --- [ntContainer#<span class="hljs-number">2</span>-<span class="hljs-number">1</span>] com<span class="hljs-variable">.wgf</span><span class="hljs-variable">.demo</span><span class="hljs-variable">.listener</span><span class="hljs-variable">.BackUpListener</span>     : 报警队列接收消息：没有路由键的商品消息<br></code></pre></td></tr></table></figure><p>由log体现，路由键为<code>test</code>的消息被转发到备份交换机处理</p><p class="note note-primary">备份交换机标识</p><p><img src="/2022/01/25/RabbitMQ/%E7%BB%91%E5%AE%9A%E4%BA%A4%E6%8D%A2%E6%9C%BA%E6%A0%87%E8%AF%86.png" srcset="/img/loading.gif" lazyload alt></p><p class="note note-primary">控制台指定备份交换机</p><p><img src="/2022/01/25/RabbitMQ/%E6%8C%87%E5%AE%9A%E5%A4%87%E4%BB%BD%E4%BA%A4%E6%8D%A2%E6%9C%BA.png" srcset="/img/loading.gif" lazyload alt></p><h3 id="备份交换机和returncallback"><a class="markdownIt-Anchor" href="#备份交换机和returncallback"></a> 备份交换机和ReturnCallback</h3><p>当交换机绑定了备份交换机并且生产者代码中开启了 <code>mandatory</code> 参数和声明了<a href="#returncallback">ReturnCallback</a>时，备份交换机的优先级更高，会将消息投递到备份交换机，而 ReturnCallback 不执行</p><h2 id="rpc模式"><a class="markdownIt-Anchor" href="#rpc模式"></a> RPC模式</h2><p>TODO</p><p><a target="_blank" rel="noopener" href="https://zq99299.github.io/mq-tutorial/rabbitmq-ac/04/06.html">https://zq99299.github.io/mq-tutorial/rabbitmq-ac/04/06.html</a></p><h2 id="rabbitmq集群"><a class="markdownIt-Anchor" href="#rabbitmq集群"></a> RabbitMQ集群</h2><p><img src="/2022/01/25/RabbitMQ/RabbitMQ%E9%9B%86%E7%BE%A4.png" srcset="/img/loading.gif" lazyload alt></p><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/unqiang/p/12217120.html">集群搭建</a></p><p><a target="_blank" rel="noopener" href="https://blog.51cto.com/knifeedge/5758909">仲裁队列创建</a></p><p>最开始我们介绍了如何安装及运行 RabbitMQ 服务，不过这些是单机版的，无法满足目前真实应用的 要求。如果 RabbitMQ 服务器遇到内存崩溃、机器掉电或者主板故障等情况，该怎么办？单台 RabbitMQ 服务器可以满足每秒 1000 条消息的吞吐量，那么如果应用需要 RabbitMQ 服务满足每秒 10 万条消息的吞吐量呢？购买昂贵的服务器来增强单机 RabbitMQ 务的性能显得捉襟见肘，搭建一个 RabbitMQ 集群才是解决实际问题的关键</p><p class="note note-primary">集群节点类型</p><ul><li><p>内存节点（ram）：就是将元数据都放在内存里，内存节点的话，只要服务重启，该节点的所有数据将会丢失</p></li><li><p>硬盘节点（disk）：就是将元数据都放在硬盘里，所以服务重启的话，数据也还是会存在</p></li></ul><p><code>注意</code>：硬盘节点如果宕机了，交换机，队列，绑定关系将不可创建，但是原有队列还可以正常使用</p><p class="note note-primary">仲裁队列</p><p>在 RabbitMQ 中，仲裁队列（Quorum Queue）是一种高可用性的队列类型，基于 <code>raft</code> 共识算法的变种实现，它提供了一种可靠的消息存储和传递机制，适用于分布式系统中对消息丢失非常敏感的应用场景。仲裁队列是 RabbitMQ 3.8 版本引入的新功能，它与传统的镜像队列（Mirrored Queue）相比具有数据一致性优势。</p><p>描述：</p><ul><li><strong>基于 Raft</strong>：仲裁队列基于 Raft 协议实现，确保在分布式环境中的一致性和容错能力。</li><li><strong>同步复制</strong>：消息在被认为已提交之前，必须被复制到集群中的大多数节点。</li></ul><p>优点：</p><ul><li><strong>强一致性</strong>：由于使用了 Raft 协议，仲裁队列提供了强一致性保证。</li><li><strong>读取性能</strong>：读取操作可以在任何节点上进行，提供较好的读取性能。</li></ul><p>缺点：</p><ul><li><strong>写入性能</strong>：由于同步复制的要求，写入性能可能不如镜像队列。</li></ul><p>使用场景：</p><ul><li>当数据一致性是首要考虑的因素时。</li></ul><p>仲裁队列的消息会优先保存在内存中，使用仲裁队列时，建议定义队列最大长度和最大内存占用，在消息堆积超过阈值时从内存转移到磁盘，以免造成内存高水位</p><p class="note note-primary">镜像队列</p><p>描述：</p><ul><li><strong>异步复制</strong>：消息被首先写入主节点，然后异步复制到镜像节点。</li><li><strong>主-备架构</strong>：主节点负责处理写入，镜像节点用于故障恢复。</li></ul><p>优点：</p><ul><li><strong>写入性能</strong>：由于使用异步复制，写入性能通常优于仲裁队列。</li><li><strong>灵活配置</strong>：允许灵活配置哪些节点应该存储队列的副本。</li></ul><p>缺点：</p><ul><li><strong>一致性问题</strong>：在网络分区或节点故障的情况下，可能会面临一致性问题。</li><li><strong>配置复杂性</strong>：配置比仲裁队列复杂。</li></ul><p>使用场景：</p><ul><li>当写入性能是首要考虑的因素时</li></ul><p class="note note-primary">Haproxy</p><p><img src="/2022/01/25/RabbitMQ/haproxy.png" srcset="/img/loading.gif" lazyload alt></p><ul><li><strong>负载均衡</strong>：HAProxy 可以将来自客户端的连接请求分发到 RabbitMQ 集群中的多个节点。</li><li><strong>高可用性</strong>：在 RabbitMQ 节点发生故障时，HAProxy 可以自动将流量重定向到健康的节点。</li></ul><p class="note note-primary">Keepalived</p><p><strong>故障转移</strong>：RabbitMQ 客户端使用虚拟 IP 地址连接到 RabbitMQ 集群。这样，即使当前的主 RabbitMQ 节点失败，Keepalived 会将虚拟 IP 地址切换到另一个健康的节点，客户端可以在不更改 IP 地址的情况下继续发送和接收消息。</p><h2 id="rabbitmq-可靠性知识"><a class="markdownIt-Anchor" href="#rabbitmq-可靠性知识"></a> RabbitMQ 可靠性知识</h2><h3 id="消息幂等"><a class="markdownIt-Anchor" href="#消息幂等"></a> 消息幂等</h3><p>在使用 RabbitMQ 时，有时候我们会遇到这样一个问题：同一条消息被消费多次，也就是 <code>重复消费</code>。这通常发生在以下几种情况：</p><ol><li><strong>网络中断</strong>：消费者成功处理了消息，但在发送确认（ack）给 RabbitMQ 时网络中断，导致 RabbitMQ 没有收到确认。</li><li><strong>消费异常</strong>：消费者在处理消息时发生异常，虽然消息实际上已被处理，但消费者没有发送确认给 RabbitMQ。</li></ol><p class="note note-primary">如何保证消息幂等性，不被重复消费</p><ul><li><strong>使用唯一消息标识符</strong>：<ul><li>为每条消息分配一个全局唯一的 ID（MessageID）。</li><li>在消费消息之前，检查该消息ID是否已被处理过。</li><li>如果已处理过，跳过该消息；如果未处理过，正常消费并记录该消息ID。</li></ul></li><li><strong>利用业务逻辑</strong>：<ul><li>使用与业务相关的唯一标识符（例如，订单号）来检查消息是否已被处理。</li><li>在处理消息之前，验证该业务标识符是否已在系统中被处理或记录过。</li><li>如果已处理，忽略该消息；如果未处理，正常消费并记录该业务标识符</li></ul></li></ul><h4 id="全局messageid-方案redis"><a class="markdownIt-Anchor" href="#全局messageid-方案redis"></a> 全局MessageID 方案（Redis）</h4><p><code>使用 Redis BitMap判断是否幂等消费</code></p><p><code>生成全局唯一ID，然后由BitMap判断是否消费</code></p><ul><li>利用 redis 执行 <code>setnx</code> 命令，天然具有幂等性。</li><li>利用 <code>SADD queueName 消息id</code> 命令存储待消费消息id</li><li>利用 <code>SISMEMBER queueName 消息id</code> 命令判断消息是否已消费</li><li>利用<code>SREM queueName 消息id</code> 删除已消费的消息id</li></ul><p class="note note-primary">架构图</p><p><img src="/2022/01/25/RabbitMQ/redis%E5%B9%82%E7%AD%89%E6%80%A7.png" srcset="/img/loading.gif" lazyload alt></p><p><code>优点</code>：消息id不和业务绑定，通用性较强</p><p><code>缺点</code>：架构引入了Redis，需要保证Redis的可用性</p><h4 id="使用业务id方案"><a class="markdownIt-Anchor" href="#使用业务id方案"></a> 使用业务ID方案</h4><p><code>使用业务编号作为消息id</code></p><p><code>每次消费时根据消息id查询数据状态，满足则消费消费，否则丢弃消息保证幂等</code></p><p>场景：订单异步退款</p><p class="note note-primary">架构图</p><p><img src="/2022/01/25/RabbitMQ/%E4%B8%9A%E5%8A%A1id%E5%B9%82%E7%AD%89.png" srcset="/img/loading.gif" lazyload alt></p><p><code>优点</code>：架构实现简单，相对可靠，贴合业务</p><p><code>缺点</code>：与业务严重偶合，带有一定的业务入侵，无法通用所有场景</p><h3 id="消息可靠投递"><a class="markdownIt-Anchor" href="#消息可靠投递"></a> 消息可靠投递</h3><p><img src="/2022/01/25/RabbitMQ/%E6%B6%88%E6%81%AF%E5%8F%AF%E9%9D%A0%E6%8A%95%E9%80%92.png" srcset="/img/loading.gif" lazyload alt></p><p class="note note-primary">消息丢失场景</p><ul><li><code>Producer</code>发送消息到 <code>Broker</code> 的过程中，如果<code>Producer</code>或<code>Broker</code>由于网络或者磁盘问题，未能成功接收消息，可能导致消息丢失</li><li><code>Exchange</code>路由<code>Queue</code>过程中，没有匹配到相应的<code>Routing Key</code>导致消息丢失</li><li><code>Comsumer</code>在消费异常时，自动<code>ACK</code>，导致消息没有重回队列头部，消息丢失</li></ul><p class="note note-primary">消息投递到Broker可靠保证</p><p>​ 使用 <a href="#confirmcallback">ConfirmCallback</a> 异步回调确认机制确认消息是否发送到<code>Exchange</code></p><p class="note note-primary">消息Exchange路由到Queue可靠保证</p><ul><li>使用 <a href="returncallback">ReturnCallback</a> 感知消息是否无法路由被退回</li><li>或使用 <a href="#备份交换机">备用交换机</a> 转发无法路由的消息做警报和业务补偿</li></ul><p class="note note-primary">保证消息最终被正确消费</p><ul><li>启用 <a href="#手动ack">手动ack</a> 机制，消费异常进行<code>Nack</code>，让消息重回队列</li><li>或使用 <a href="#死信队列-dlx">死信队列</a> ，消息消费异常拒绝消息签收，转发到死信队列，由其他业务进行补偿</li></ul><p class="note note-primary">消息重发机制（投递失败业务补偿）</p><ul><li>使用Redis持久化消息，提供失败消息重新投递数据支撑，DB层也可选择Mysql等其他产品，具体看业务场景</li><li>定时任务实现消息重新投递，进行业务补偿</li></ul><p class="note note-primary">消息幂等</p><p><a href="#%E6%B6%88%E6%81%AF%E5%B9%82%E7%AD%89">消息幂等</a>，基于Redis的自增Id和<code>BitMap</code>的通用方案或使用业务数据状态</p><p class="note note-primary">消息最终消费保证</p><p>​	采用手动ack + 定时任务 + 人工处理方式保证</p><p class="note note-primary">人工补偿，防止消息无限消费</p><p>当重试超过阈值消息永久存储在DB中，这时需要人工介入进行业务补偿，补偿完毕删除DB数据</p><h3 id="具体实现"><a class="markdownIt-Anchor" href="#具体实现"></a> 具体实现</h3><p>根据以上的理论对方案进行代码实现，解决点有</p><ul><li>消息幂等</li><li>消息可靠投递保证</li><li>消息最终消费保证</li></ul><p class="note note-primary">技术栈</p><ul><li>Mysql，针对<code>11.2章节</code>方案，DB层改为Mysql。原因：底层更通用，便于人工补偿数据检索和扩展。</li><li>MybatisPlus</li><li>RabbitMQ</li><li>Redis，用于生成消息ID <em>(可不用)</em>，可用雪花算法或美团的 <a target="_blank" rel="noopener" href="https://github.com/Meituan-Dianping/Leaf">Leaf</a> 等方式生成；保证消息幂等</li><li>Scheduled，为了方便实现使用Spring定时任务，推荐使用<code>xxl-job</code>等第三方框架进行补偿解耦</li></ul><p>源码地址：<a target="_blank" rel="noopener" href="https://github.com/wugengfeng/rabbitmq-example">rabbitmq-example</a>，模拟用户下单异步生成订单扣减库存流程</p><p class="note note-primary">关键字段说明</p><p>图中的状态代表消息日志状态的流转</p><p><code>logId</code> 消息日志主键，用于变更状态</p><p><code>msgId</code> 消息全局唯一id</p><p><code>messageId</code> <code>logId_msgId</code> 拼接，消息体实际使用的id</p><p class="note note-primary">服务说明</p><p><code>producer_server</code> 消息发送服务，提供消息发送和消息重新投递能力</p><p><code>consumer_server</code> 消息消费者</p><p><code>reparation-server</code> 补偿服务，提供定期补偿消息重新投递，堆积消息日志异步删除能力</p><h4 id="核心代码讲解"><a class="markdownIt-Anchor" href="#核心代码讲解"></a> 核心代码讲解</h4><p><img src="/2022/01/25/RabbitMQ/%E6%B6%88%E6%81%AF%E5%8F%AF%E9%9D%A0%E6%80%A7%E6%8A%95%E9%80%92.png" srcset="/img/loading.gif" lazyload alt></p><p class="note note-primary">producer-server</p><ul><li><p>集成<code>swagger</code> 项目启动访问 <a target="_blank" rel="noopener" href="http://localhost:9000/doc.html">http://localhost:9000/doc.html</a></p></li><li><p><code>MsgController</code> 对外提供消息投递与消息重新投递能力</p></li><li><p><code>RabbitMqUtils</code> 消息投递与持久化具体实现</p></li><li><p><code>SequenceUtils</code> 全局唯一id具体实现</p></li><li><p><code>MsgConfirmCallback</code> 消息投递Broker失败异步回调，重新实现消息投递核心</p></li><li><p><code>MsgReturnCallback</code> 消息路由失败异步回调，重新实现消息投递核心</p></li></ul><p class="note note-primary">consumer-server</p><ul><li><code>@IdempotentMessage</code> 消息幂等与消息重新消费自定义注解，作用于监听方法（可选择是否使用）</li><li><code>RabbitListenerAop</code> 消息幂等于重新消费限制具体实现</li></ul><p class="note note-primary">reparation-server</p><ul><li><code>ReparationTask</code> 消息重新投递具体实现</li><li><code>CleanMsgTask</code> 消息日志异步清理实现</li></ul><p class="note note-primary">消息状态</p><ul><li>投递中</li><li>投递成功</li><li>投递失败</li><li>人工修复</li><li>消费成功</li><li>重复消费</li></ul><p class="note note-primary">额外扩展</p><p><code>路由失败</code>: 也可以使用 <a href="#备份交换机">备份交换机</a> 方案，由<code>reparation-server</code> 监听备份队列进行业务补偿</p><p><code>拒绝消息</code> 重试多次消费上限丢弃消息可以使用 <a href="#死信队列-dlx">死信队列</a> 方案解决</p><p>项目下<code>demo.sql</code>为mysql DDL 脚本</p><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css"></div><hr><div><div class="post-metas my-3"></div><div class="license-box my-3"><div class="license-title"><div>RabbitMQ</div><div>https://wugengfeng.cn/2022/01/25/RabbitMQ/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>wugengfeng</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2022年1月25日</div></div><div class="license-meta-item"><div>许可协议</div><div><a target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2022/02/04/Redis/" title="Redis"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">Redis</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"></article></div></div></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目录</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",function(){NProgress.done()})</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t){var e=Fluid.plugins.typing,i=t.getElementById("subtitle");i&&e&&e(i.getAttribute("data-typed-text"))}((window,document))</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",function(){var t,o=jQuery("#toc");0!==o.length&&window.tocbot&&(t=jQuery("#board-ctn").offset().top,window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-t},CONFIG.toc)),0<o.find(".toc-list-item").length&&o.css("visibility","visible"),Fluid.events.registerRefreshCallback(function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;0<t.find(".toc-list-item").length&&t.css("visibility","visible")}}))})</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",function(){Fluid.plugins.fancyBox()})</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>