<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="stylesheet" href="https://npm.elemecdn.com/lxgw-wenkai-screen-webfont/style.css" media="print" onload='this.media="all"'><link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png"><link rel="icon" href="/img/fluid.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="wugengfeng"><meta name="keywords" content="wugengfeng"><meta name="description" content="知识体系 思维导图  MongoDB简介 MongoDB 是一款开源的分布式文档数据库，介于关系型数据库和非关系型数据库之间。它是功能最丰富、最像关系型数据库的非关系型数据库产品之一。 MongoDB 支持以 JSON（BSON 是一种类似于 JSON 的二进制格式） 格式存储和查询文档，其底层由 C++ 语言编写。 在 MongoDB 中，每个记录都是一个 JSON 文档，类似于 JSON 对"><meta property="og:type" content="article"><meta property="og:title" content="MongoDB"><meta property="og:url" content="https://wugengfeng.cn/2023/04/14/MongoDB/index.html"><meta property="og:site_name" content="技术博客"><meta property="og:description" content="知识体系 思维导图  MongoDB简介 MongoDB 是一款开源的分布式文档数据库，介于关系型数据库和非关系型数据库之间。它是功能最丰富、最像关系型数据库的非关系型数据库产品之一。 MongoDB 支持以 JSON（BSON 是一种类似于 JSON 的二进制格式） 格式存储和查询文档，其底层由 C++ 语言编写。 在 MongoDB 中，每个记录都是一个 JSON 文档，类似于 JSON 对"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://wugengfeng.cn/2023/04/14/MongoDB/%E6%96%87%E6%A1%A3.png"><meta property="og:image" content="https://wugengfeng.cn/2023/04/14/MongoDB/%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8.png"><meta property="og:image" content="https://wugengfeng.cn/2023/04/14/MongoDB/%E6%96%87%E6%A1%A3%E5%B5%8C%E5%A5%97.png"><meta property="og:image" content="https://wugengfeng.cn/2023/04/14/MongoDB/%E6%9F%A5%E8%AF%A2%E8%AE%A1%E5%88%92%E5%99%A8%E9%80%BB%E8%BE%91.png"><meta property="og:image" content="https://wugengfeng.cn/2023/04/14/MongoDB/mapreduce.png"><meta property="og:image" content="https://wugengfeng.cn/2023/04/14/MongoDB/%E7%B4%A2%E5%BC%95.png"><meta property="og:image" content="https://wugengfeng.cn/2023/04/14/MongoDB/%E5%8D%95%E5%AD%97%E6%AE%B5%E7%B4%A2%E5%BC%95.png"><meta property="og:image" content="https://wugengfeng.cn/2023/04/14/MongoDB/%E5%A4%8D%E5%90%88%E7%B4%A2%E5%BC%95.png"><meta property="og:image" content="https://wugengfeng.cn/2023/04/14/MongoDB/%E5%A4%9A%E9%94%AE%E7%B4%A2%E5%BC%95.png"><meta property="og:image" content="https://wugengfeng.cn/2023/04/14/MongoDB/checkPoint%E5%92%8CJournal.png"><meta property="og:image" content="https://wugengfeng.cn/2023/04/14/MongoDB/GridFS.png"><meta property="og:image" content="https://wugengfeng.cn/2023/04/14/MongoDB/%E5%89%AF%E6%9C%AC%E9%9B%86%E8%AF%BB%E5%86%99.png"><meta property="og:image" content="https://wugengfeng.cn/2023/04/14/MongoDB/%E5%89%AF%E6%9C%AC%E9%9B%86%E8%AF%BB%E5%86%99.png"><meta property="og:image" content="https://wugengfeng.cn/2023/04/14/MongoDB/%E4%B8%BB%E8%8A%82%E7%82%B9%E9%80%89%E4%B8%BE.png"><meta property="og:image" content="https://wugengfeng.cn/2023/04/14/MongoDB/%E4%B8%BB%E8%BE%85%E8%8A%82%E7%82%B9%E6%95%B0%E6%8D%AE%E5%A4%8D%E5%88%B6.png"><meta property="og:image" content="https://wugengfeng.cn/2023/04/14/MongoDB/%E4%BB%B2%E8%A3%81%E8%8A%82%E7%82%B9.png"><meta property="og:image" content="https://wugengfeng.cn/2023/04/14/MongoDB/oplog.png"><meta property="og:image" content="https://wugengfeng.cn/2023/04/14/MongoDB/%E4%B8%BB%E8%8A%82%E7%82%B9%E9%80%89%E4%B8%BE.png"><meta property="og:image" content="https://wugengfeng.cn/2023/04/14/MongoDB/%E8%AF%BB%E5%81%8F%E5%A5%BD.png"><meta property="og:image" content="https://wugengfeng.cn/2023/04/14/MongoDB/%E5%89%AF%E6%9C%AC%E9%9B%86%E6%9E%B6%E6%9E%84.png"><meta property="og:image" content="https://wugengfeng.cn/2023/04/14/MongoDB/%E5%89%AF%E6%9C%AC%E9%9B%86%E8%8A%82%E7%82%B9.png"><meta property="og:image" content="https://wugengfeng.cn/2023/04/14/MongoDB/%E5%88%86%E7%89%87.png"><meta property="og:image" content="https://wugengfeng.cn/2023/04/14/MongoDB/%E5%88%86%E7%89%87%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84.png"><meta property="og:image" content="https://wugengfeng.cn/2023/04/14/MongoDB/%E5%88%86%E7%89%87%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84%E5%9B%BE.png"><meta property="og:image" content="https://wugengfeng.cn/2023/04/14/MongoDB/%E5%88%86%E7%89%87%E8%8C%83%E5%9B%B4.png"><meta property="og:image" content="https://wugengfeng.cn/2023/04/14/MongoDB/hash%E5%88%86%E7%89%87.png"><meta property="og:image" content="https://wugengfeng.cn/2023/04/14/MongoDB/%E8%8C%83%E5%9B%B4%E5%88%86%E7%89%87.png"><meta property="og:image" content="https://wugengfeng.cn/2023/04/14/MongoDB/%E5%88%86%E7%89%87%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1.png"><meta property="og:image" content="https://wugengfeng.cn/2023/04/14/MongoDB/%E5%86%99%E5%85%B3%E6%B3%A8%E5%BC%82%E5%B8%B8.png"><meta property="og:image" content="https://wugengfeng.cn/2023/04/14/MongoDB/%E5%BC%82%E5%B8%B8%E5%9B%9E%E6%BB%9A.png"><meta property="og:image" content="https://wugengfeng.cn/2023/04/14/MongoDB/%E4%BA%8B%E5%8A%A1%E5%9B%9E%E6%BB%9A.png"><meta property="og:image" content="https://wugengfeng.cn/2023/04/14/MongoDB/%E4%BA%8B%E5%8A%A1%E6%95%B0%E6%8D%AE%E5%86%99%E5%85%A5.png"><meta property="article:published_time" content="2023-04-14T09:36:43.000Z"><meta property="article:modified_time" content="2023-08-24T10:48:19.791Z"><meta property="article:author" content="wugengfeng"><meta property="article:tag" content="wugengfeng"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://wugengfeng.cn/2023/04/14/MongoDB/%E6%96%87%E6%A1%A3.png"><meta name="baidu-site-verification" content="codeva-uJ0fkFPmHB"><title>MongoDB - 技术博客</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="/css/custom.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var dntVal,CONFIG={hostname:"wugengfeng.cn",root:"/",version:"1.9.3",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!1,element:"h9",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:1},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!1,follow_dnt:!0,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml"};CONFIG.web_analytics.follow_dnt&&(dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on")))</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="技术博客" type="application/atom+xml"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>吴耿锋</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> <span>首页</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> <span>归档</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> <span>分类</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> <span>标签</span></a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> <span>关于</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="MongoDB"></span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2023-04-14 17:36" pubdate>2023年4月14日 下午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 173k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 1446 分钟</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 style="display:none">MongoDB</h1><div class="markdown-body"><h1 id="知识体系"><a class="markdownIt-Anchor" href="#知识体系"></a> 知识体系</h1><p><a target="_blank" rel="noopener" href="https://mubu.com/doc/6qugBiSXgW2">思维导图</a></p><h1 id="mongodb简介"><a class="markdownIt-Anchor" href="#mongodb简介"></a> <a target="_blank" rel="noopener" href="https://docs.mongoing.com/mongo-introduction">MongoDB简介</a></h1><p>MongoDB 是一款开源的分布式<code>文档</code>数据库，介于关系型数据库和非关系型数据库之间。它是功能最丰富、最像关系型数据库的非关系型数据库产品之一。 MongoDB 支持以 JSON（BSON 是一种类似于 JSON 的二进制格式） 格式存储和查询文档，其底层由 C++ 语言编写。</p><p>在 MongoDB 中，每个记录都是一个 JSON 文档，类似于 JSON 对象。字段的值可以包括其他文档、数组和对象数组，因此可以存储相对复杂的数据类型。而且，<span class="green-line">MongoDB 最大的特点是支持强大的查询语言，其语法类似于面向对象的查询语言，可以实现关系型数据库单表查询的绝大部分功能，并支持对数据建立索引。这使得 MongoDB 在处理大量非结构化数据时非常适合使用。</span></p><p><img src="/2023/04/14/MongoDB/%E6%96%87%E6%A1%A3.png" srcset="/img/loading.gif" lazyload alt="文档"></p><div class="note note-warning"><p>使用文档的优点：</p><ul><li>文档（即对象）对应于许多编程语言中的内置数据类型。</li><li>嵌入式文档和数组减少了对昂贵连接（join）的需求。</li><li>动态模式（不需要事先定义表结构或字段）支持流畅的多态性。</li></ul></div><div class="note note-warning"><p><code>BSON</code>：二进制的JSON，有专门的编解码技术，有额外的日期，二进制数据类型</p><p><a target="_blank" rel="noopener" href="http://c.biancheng.net/json/json-bson.html">JSON和BSON的区别</a></p><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/bson-types/">BSON 数据类型</a></p></div><p class="note note-primary">与关系型数据库对比</p><table><thead><tr><th>MongoDB</th><th>关系型数据库</th></tr></thead><tbody><tr><td>数据库</td><td>数据库</td></tr><tr><td>集合</td><td>表</td></tr><tr><td>文档</td><td>行</td></tr><tr><td>字段</td><td>列</td></tr><tr><td>索引</td><td>索引</td></tr><tr><td>_id</td><td>主键</td></tr><tr><td>视图</td><td>视图</td></tr><tr><td>聚合操作（$lookup）</td><td>表连接</td></tr></tbody></table><p class="note note-primary">数据模型</p><table><thead><tr><th>数据模型</th><th>定义</th></tr></thead><tbody><tr><td>数据库</td><td>最外层的概念，可以理解为逻辑上的名称空间，一个数据库包含多个不同名 称的集合。</td></tr><tr><td>集合</td><td>相当于SQL中的表，一个集合可以存放多个不同的文档。</td></tr><tr><td>文档</td><td>一个文档相当于数据表中的一行，由多个不同的字段组成。</td></tr><tr><td>字段</td><td>文档中的一个属性，等同于列（column）。</td></tr><tr><td>索引</td><td>索引是一种辅助存储技术，用于加速查询。索引是一种特殊的文档，它包含一个或多个键值对，这些键值对与查询的键值对匹配。</td></tr><tr><td>_id</td><td>_id 是 MongoDB 文档中的一个特殊字段，用于唯一标识每个文档。它是一个内置字段，类似RDBMS的主键。</td></tr><tr><td>视图</td><td>可以看作一种虚拟的（非真实存在的）集合，与SQL中的视图类似。从MongoDB 3.4版本开始提供了视图功能，其通过聚合管道技术实现</td></tr><tr><td>聚合 ($lookup)</td><td>用于在集合之间进行关联查询。它类似于 SQL 中的内连接，但可以支持更多的查询操作。</td></tr></tbody></table><p class="note note-primary">支持的数据类型</p><table><thead><tr><th>数据类型</th><th>类型描述</th></tr></thead><tbody><tr><td>整数类型 (Integer)</td><td>支持正整数、负整数和零值。</td></tr><tr><td>浮点数类型 (Float)</td><td>支持单精度浮点数和双精度浮点数。</td></tr><tr><td>字符串类型 (String)</td><td>支持任意长度的字符串。</td></tr><tr><td>布尔类型 (Boolean)</td><td>支持 true 和 false 两个值。</td></tr><tr><td>数组类型 (Array)</td><td>支持任意长度的数组。</td></tr><tr><td>对象类型 (Object)</td><td>支持包含多个字段的对象。</td></tr><tr><td>嵌套类型 (Deep Object)</td><td>支持嵌套对象，即包含多个嵌套对象的类型。</td></tr><tr><td>日期类型 (Date)</td><td>支持 JavaScript 日期对象。</td></tr><tr><td>数字类型 (Number)</td><td>支持任意精度的数字。</td></tr><tr><td>二进制数据 (BinData)</td><td>支持二进制数据。</td></tr><tr><td>自定义类型 (Custom Type)</td><td>支持用户定义的数据类型。</td></tr></tbody></table><h2 id="主要特征"><a class="markdownIt-Anchor" href="#主要特征"></a> 主要特征</h2><p>MongoDB基于灵活的JSON文档模型，非常适合 <code>敏捷式的快速开发</code>。与此同时，<span class="green-line">其与生俱来的高可用、 高水平扩展能力使得它在处理海量、高并发的数据应用时颇具优势</span></p><p class="note note-primary">动态模式</p><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="/2023/04/14/MongoDB/%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8.png" srcset="/img/loading.gif" lazyload alt></div><div class="group-image-wrap"><img src="/2023/04/14/MongoDB/%E6%96%87%E6%A1%A3%E5%B5%8C%E5%A5%97.png" srcset="/img/loading.gif" lazyload alt></div></div></div><p><code>反范式</code>：相对RDBMS错中复杂的表关系，mongoDB的JSON模型允许数组、嵌套对象结构，在数据结构上更接近对象关系，开发代码量低</p><p><code>字段扩展</code>：mongoDB支持动态新增字段，不需要修改表结构，开发灵活，快速响应业务变化</p><p class="note note-primary">强大的查询语言</p><p>相比其他非关系型数据库，MongoDB支持丰富的查询语言，支持读和写操作(CRUD)，比如数据聚合、文本搜索和地理空间查询等。</p><p class="note note-primary">高可用</p><ul><li>自动故障转移</li><li>数据备份</li></ul><p><a target="_blank" rel="noopener" href="https://docs.mongoing.com/replication">副本集</a>是一组维护相同数据集合的 mongod实例，提供了冗余和提高了数据可用性</p><p class="note note-primary">水平扩展</p><ul><li><a target="_blank" rel="noopener" href="https://docs.mongodb.com/v4.2/sharding/#sharding-introduction">分片</a>将数据分布在一个集群的机器上，支持集群节点扩展</li><li>从3.4开始，MongoDB支持基于<a target="_blank" rel="noopener" href="https://docs.mongoing.com/fen-pian/shard-keys">分片键</a>创建数据<a target="_blank" rel="noopener" href="https://docs.mongodb.com/v4.2/core/zone-sharding/#zone-sharding">区域</a>。在平衡群集中，MongoDB仅将区域覆盖的读写定向到区域内的那些分片</li></ul><p class="note note-primary">支持多种存储引擎</p><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/upcoming/storage">存储引擎</a></p><ul><li>WiredTiger存储引擎</li><li>内存存储引擎</li></ul><h2 id="应用场景"><a class="markdownIt-Anchor" href="#应用场景"></a> 应用场景</h2><table><thead><tr><th>应用场景</th><th>MongoDB 优势</th></tr></thead><tbody><tr><td>实时数据处理</td><td>MongoDB 支持实时数据处理，可以实时存储和查询数据</td></tr><tr><td>关系型数据库替代品</td><td>MongoDB 可以存储非结构化数据，可以轻松替代关系型数据库</td></tr><tr><td>大规模数据处理</td><td>MongoDB 支持高效的批量查询和数据批量插入、更新、删除</td></tr><tr><td>日志记录</td><td>MongoDB 支持高效的日志记录和查询，可以实时记录和查询日志数据</td></tr><tr><td>API 存储</td><td>MongoDB 可以存储 API 文档和数据，支持实时查询和更新</td></tr><tr><td>分布式文件系统</td><td>MongoDB 可以充当分布式文件系统的数据库，支持读写分离和数据备份</td></tr><tr><td>分布式消息队列</td><td>MongoDB 可以充当分布式消息队列的数据库，支持消息存储和查询</td></tr><tr><td>社交场景</td><td>存储存储用户信息，以及用户发表的朋友圈信息</td></tr><tr><td>物流场景</td><td>订单状态在运送过程中会不断更新，以 MongoDB 内嵌数组的形式来存储，一次查询就能将订单所有的变更读取出来</td></tr><tr><td>物联网场景</td><td>存储所有接入的智能设备信息，以及设备汇报的日志信息，并对这些信息进行多维度的分析</td></tr></tbody></table><p class="note note-primary">选型原因</p><ul><li>不需要复杂join查询以及事务处理</li><li>需要更高的读写QPS(3000以上)</li><li>需要至少TB或PB级别的数据存储</li><li>业务发展迅速，需要快速水平扩展</li><li>要求应用高可用</li><li>需要地理位置查询，文本查询</li></ul><h1 id="基本命令"><a class="markdownIt-Anchor" href="#基本命令"></a> 基本命令</h1><p>安装平台为<code>Linux</code>，安装版本为社区6.x版本</p><h2 id="linux安装"><a class="markdownIt-Anchor" href="#linux安装"></a> linux安装</h2><p>TODO</p><h2 id="docker安装"><a class="markdownIt-Anchor" href="#docker安装"></a> docker安装</h2><p>创建配置和数据目录</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir -p /data/mongodb/db<br>mkdir -p /data/mongodb/backup<br>mkdir -p /data/mongodb/log<br>mkdir -p /data/mongodb/config<br><br>chmod -R 777 /data/mongodb/db<br>chmod -R 777 /data/mongodb/backup<br>chmod -R 777 /data/mongodb/log<br>chmod -R 777 /data/mongodb/config<br></code></pre></td></tr></table></figure><p>在配置目录下创建 mongod.conf 配置文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs shell">net:<br>  port: 27017<br>  bindIp: 0.0.0.0<br><br>storage:<br>  dbPath: /data/mongodb/db<br>  journal:<br>    enabled: true<br>systemLog:<br>  destination: file<br>  logAppend: true<br>  path:  /data/mongodb/log/mongod.log<br><br>auth: true<br><br>storage:<br>  wiredTiger:<br>    engineConfig:<br>      cacheSizeGB: 0.5<br></code></pre></td></tr></table></figure><p>安装MongoDB</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs gradle">docker run -d \<br>--name mongodb \<br>-p <span class="hljs-number">27017</span>:<span class="hljs-number">27017</span> \<br>-v <span class="hljs-regexp">/data/m</span>ongodb<span class="hljs-regexp">/db/</span>data:<span class="hljs-regexp">/data/</span>db \<br>-v <span class="hljs-regexp">/data/m</span>ongodb<span class="hljs-regexp">/backup:/</span>data/backup \<br>-v <span class="hljs-regexp">/data/m</span>ongodb<span class="hljs-regexp">/log:/</span>data/log \<br>-v <span class="hljs-regexp">/data/m</span>ongodb<span class="hljs-regexp">/config:/</span>data/conf \<br>--privileged=<span class="hljs-keyword">true</span> mongo \<br>--auth<br></code></pre></td></tr></table></figure><p>添加账号</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk">docker exec -it mongodb <span class="hljs-regexp">/bin/</span>bash<br>mongo<br>use admin<br>db.createUser(&#123;user:<span class="hljs-string">&quot;admin&quot;</span>,pwd:<span class="hljs-string">&quot;123456&quot;</span>,roles:[&#123;role:<span class="hljs-string">&#x27;root&#x27;</span>,db:<span class="hljs-string">&#x27;admin&#x27;</span>&#125;]&#125;)<br><span class="hljs-keyword">exit</span><br></code></pre></td></tr></table></figure><h2 id="mongo-shell"><a class="markdownIt-Anchor" href="#mongo-shell"></a> <a target="_blank" rel="noopener" href="https://docs.mongoing.com/the-mongo-shell">Mongo shell</a></h2><p>Mongo shell是一个命令行工具，用于连接和操作MongoDB数据库。并为开发人员提供了直接测试数据库查询和操作的方法</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">mongo<br></code></pre></td></tr></table></figure><blockquote><p>–port:指定端口，默认为27017</p><p>–host:连接的主机地址，默认127.0.0.1</p></blockquote><p><code>Mongo shell</code> 是基于 <code>JavaScript</code> 语法实现的，<span class="green-line">MongoDB使用了SpiderMonkey作为其内部的JavaScript解释器引擎，这是由Mozilla官方提供的JavaScript内核解释器，该解释器也被同样用于大名鼎鼎的Firefox浏览器产品之中。</span>SpiderMonkey对ECMA Script标准兼容性非常好，可以支持ECMA Script 6。可以通过下面的命令检查JavaScript解释器的版本</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-title function_">interpreterVersion</span>()<br><span class="hljs-title class_">MozJS</span>-<span class="hljs-number">60</span><br></code></pre></td></tr></table></figure><p class="note note-primary">命令行帮助</p><p></p><p>要查看选项列表和启动<a target="_blank" rel="noopener" href="https://docs.mongodb.com/master/reference/program/mongo/#bin.mongo"><code>mongo</code></a> shell相关的帮助，请从命令行使用<a target="_blank" rel="noopener" href="https://docs.mongodb.com/master/reference/program/mongo/#cmdoption-mongo-help"><code>--help</code></a>选项</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">mongo --help<br></code></pre></td></tr></table></figure><p class="note note-primary">Shell帮助</p><p></p><p>要查看选项列表和启动<a target="_blank" rel="noopener" href="https://docs.mongodb.com/master/reference/program/mongo/#bin.mongo"><code>mongo</code></a> shell相关的帮助，请从命令行使用<a target="_blank" rel="noopener" href="https://docs.mongodb.com/master/reference/program/mongo/#cmdoption-mongo-help"><code>--help</code></a>选项</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">help<br></code></pre></td></tr></table></figure><p class="note note-primary">数据库帮助</p><p></p><ul><li><p>当需要查看服务器上的数据库列表，请使用 <code>show dbs</code> 命令</p></li><li><p>当需要查看可在db对象上使用的方法的帮助列表，请调用<a target="_blank" rel="noopener" href="https://docs.mongodb.com/master/reference/method/db.help/#db.help"><code>db.help()</code></a>方法</p></li><li><p>当需要查看在 <code>shell</code>中查看某些方法的具体实现，请键入不带括号()的<code>db.&lt;method name&gt;</code>，如以下示例所示，它将返回方法<a target="_blank" rel="noopener" href="https://docs.mongodb.com/master/reference/method/db.updateUser/#db.updateUser"><code>db.updateUser()</code></a>的实现</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">db.updateUser<br></code></pre></td></tr></table></figure></li></ul><p></p><p class="note note-primary">表级别帮助</p><p></p><ul><li><p>要查看当前数据库中的集合列表，请使用 <code>show collections</code> 命令</p></li><li><p>要查看收集对象上可用方法的帮助（例如<code>db.&lt;collection&gt;</code>），请使用<code>db.&lt;collection&gt;.help()</code>方法</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">db.collection.help()<br></code></pre></td></tr></table></figure></li><li><p>创建集合 <code>db.createCollection(name, options)</code></p></li></ul><p></p><p class="note note-primary">游标相关帮助</p><p></p><p>在mongo shell中使用<code>find()</code>方法执行读取操作时，可以使用各种游标方法来修改<code>find()</code>行为，并可以使用各种JavaScript方法来处理从<code>find()</code>方法返回的游标</p><ul><li><p>要列出可用的修饰符和游标处理方法，请使用<code>db.collection.find().help()</code>命令</p></li><li><p>要查看cursor方法的实现，请输入不带括号(())的<code>db.&lt;collection&gt;.find().&lt;method&gt;</code>名称，如以下示例所示，它将返回<code>toArray()</code>方法的实现</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">db.collection.<span class="hljs-built_in">find</span>().toArray<br></code></pre></td></tr></table></figure></li></ul><p>处理游标的一些有用方法是:处理游标的一些有用方法是:</p><ul><li><a target="_blank" rel="noopener" href="https://docs.mongodb.com/master/reference/method/cursor.hasNext/#cursor.hasNext"><code>hasNext()</code></a> 检查光标是否还有更多文档要返回</li><li><a target="_blank" rel="noopener" href="https://docs.mongodb.com/master/reference/method/cursor.next/#cursor.next"><code>next()</code></a>返 回下一个文档，并将光标位置向前移动一个</li></ul><h3 id="数据库操作"><a class="markdownIt-Anchor" href="#数据库操作"></a> 数据库操作</h3><p class="note note-primary">选择和创建数据库</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">use 数据库名称<br></code></pre></td></tr></table></figure><p>如果数据库不存在则自动创建，当刚开始创建一个数据库的时候信息存储在内存中，所以刚创建的数据库是查询不到的。当数据库创建一个集合后，才会把数据库信息持久化到磁盘，此时数据库才能被检索</p><p class="note note-primary">查看数据库</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">show dbs 或 show databases<br></code></pre></td></tr></table></figure><p>查看当前数据库</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">db<br></code></pre></td></tr></table></figure><p class="note note-primary">删除数据库</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">db.dropDatabase()<br></code></pre></td></tr></table></figure><p>用于删除已持久化的数据库</p><p class="note note-primary">数据库命名规则</p><ul><li><p>不能是空字符串（“”)。</p></li><li><p>不得含有’ '（空格)、.、$、/、\和\0 (空字符)。</p></li><li><p>应全部小写。</p></li><li><p>最多64字节。</p></li></ul><p class="note note-primary">默认数据库</p><ul><li><code>admin</code>：这个特殊的数据库主要用于管理 MongoDB 实例，可以创建、删除用户和管理角色。</li><li><code>local</code>：用来存储本地数据的，比如保存自己的复制集状态、操作日志等信息，这个数据库数据不会被复制（可以存储不想被其他节点复制的数据）。</li><li><code>config</code>：用来存储分片集群的配置信息的，如果正在使用 MongoDB 的分片集群功能，则该集群的配置信息将保存在此数据库中。</li></ul><h3 id="集合操作"><a class="markdownIt-Anchor" href="#集合操作"></a> 集合操作</h3><p>特殊集合：</p><ul><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/core/capped-collections/">Capped Collections</a> 固定集合，固定大小的集合，超过大小可以覆盖历史文档</li><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/core/clustered-collections/">Clustered Collections</a> 聚簇集合，使用 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/reference/method/db.createCollection/#std-label-db.createCollection.clusteredIndex">聚簇索引 clustered index</a> 创建的集合称为聚集集合</li></ul><table><thead><tr><th>操作</th><th>说明</th></tr></thead><tbody><tr><td><code>db.createCollection(name, options[可选])</code></td><td>创建集合</td></tr><tr><td><code>show collections</code></td><td>查看集合</td></tr><tr><td><code>db.test.drop()</code></td><td>删除集合</td></tr></tbody></table><p>集合的创建分 <code>显式</code> 和 <code>隐式</code></p><ul><li>显式：<code>db.createCollection(name, options[可选])</code></li><li>隐式：当使用插入方法（insert）插入到一个不存在的集合时，会自动创建该集合</li></ul><div class="note note-warning"><p>注意</p><p>通常采用隐式创建集合，即当向一个集合中插入一个文档的时候，如果集合不存在，则会自动创建集合。</p></div><div class="note note-primary"><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/reference/method/db.createCollection/#definition">options说明</a></p></div><table><thead><tr><th>集合参数</th><th>描述</th></tr></thead><tbody><tr><td>capped</td><td>固定集合（Capped Collections）是性能出色且有着固定大小的集合，对于大小固定，我们可以想象其就像一个环形队列，当集合空间用完后，再插入的元素就会覆盖最初始的头部的元素</td></tr><tr><td>timeseries</td><td>指定集合是否为时间序列集合。时间序列集合包含时间戳和数据值，用于记录时间序列数据。</td></tr><tr><td>expireAfterSeconds</td><td>指定集合中文档的过期时间，单位为秒。当文档的过期时间到达时，该文档将被删除。<br>对于聚集集合，将根据聚集索引键 <code>_id</code> 自动删除文档，并且值必须是日期类型。请参阅 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/core/index-ttl/#std-label-index-feature-ttl">TTL Indexes.</a></td></tr><tr><td>clusteredIndex</td><td>指定集合是否使用聚簇索引。集群索引是将集合中的文档按照某种规则进行排序的索引，可以提高查询效率。</td></tr><tr><td>changeStreamPreAndPostImages</td><td>指定集合是否使用 changeStream。changeStream 是一种用于监视集合中文档更改的 API，可以实时获取集合中文档的更改。</td></tr><tr><td>size</td><td>指定集合的大小，单位为字节。可以使用 size 命令查询集合的大小。</td></tr><tr><td>max</td><td>指定集合中文档的最大数量。如果集合中已经有很多文档，则创建集合时可能会失败。</td></tr><tr><td>storageEngine</td><td>指定集合使用的存储引擎。</td></tr><tr><td>validator</td><td>指定集合中的文档验证器。验证器用于检查文档是否符合特定的验证规则。</td></tr><tr><td>validationLevel</td><td>指定集合中的文档验证级别。验证级别越高，验证器的要求也越高，可以提高查询效率，但可能会导致文档验证时间较长。</td></tr><tr><td>validationAction</td><td>指定集合中的文档验证失败后的行为。可以设置为 drop 或 continue，分别表示验证失败时将文档删除或继续验证。</td></tr><tr><td>indexOptionDefaults</td><td>指定集合中索引默认的属性。</td></tr><tr><td>viewOn</td><td>指定集合中文档的视图名称。可以使用 viewOn 命令查询文档的视图名称。</td></tr><tr><td>pipeline</td><td>指定查询语句中的过滤条件。</td></tr><tr><td>collation</td><td>指定集合中文档的排序规则。</td></tr><tr><td>writeConcern</td><td>指定写入操作的可靠性。writeConcern 文档包含了有关写入操作可靠性的详细信息。</td></tr></tbody></table><h1 id="curd操作"><a class="markdownIt-Anchor" href="#curd操作"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/crud/">CURD操作</a></h1><p>CURD操作指的是文档的创建、读、更新以及删除操作</p><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/sql-comparison/">SQL到mongo的操作映射</a></p><h2 id="插入文档"><a class="markdownIt-Anchor" href="#插入文档"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/tutorial/insert-documents/">插入文档</a></h2><p><code>创建</code> 或 <code>插入</code> 操作将新文档添加到集合中。如果该集合当前不存在，则插入操作将创建该集合</p><p>MongoDB提供以下将文档插入集合的方法：</p><ul><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.insertOne/#mongodb-method-db.collection.insertOne"><code>db.collection.insertOne()</code></a> 插入一个文档</li><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.insertMany/#mongodb-method-db.collection.insertMany"><code>db.collection.insertMany()</code></a> 插入多个文档</li><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.insert/"><code>db.collection.inser()</code></a> 插入一个或多个文档</li><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.insert/"><code>db.collection.save()</code></a> 已废弃，插入或覆盖一个文档</li></ul><p>MongoDB中的所有写入操作在单个文档的级别上都是原子的，参考<a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/write-operations-atomicity/">原子性和事务</a></p><h3 id="insertone"><a class="markdownIt-Anchor" href="#insertone"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.insertOne/#mongodb-method-db.collection.insertOne">insertOne</a></h3><p>将一个文档插入到一个集合中，支持 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/write-concern/#std-label-wc-w">writeConcern 写关注</a></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">collection</span>.<span class="hljs-title function_">insertOne</span>(<br>  &lt;<span class="hljs-variable language_">document</span>&gt;,<br>  &#123;<br>  	<span class="hljs-attr">writeConcern</span>: &lt;<span class="hljs-variable language_">document</span>&gt;<br>  &#125;<br>)<br></code></pre></td></tr></table></figure><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/write-concern/#std-label-wc-w">writeConcern 写关注</a> 决定一个写操作落到多少个节点上才算成功。writeConcern w 属性的取值包括：</p><ul><li><code>0</code>: 发起写操作，不进行写操作确认</li><li><code>1</code>: 请求确认写入操作已传播到复制集中的独立副本或主节点。是MongoDB的默认写关注点</li><li><code>n</code>: 写操作需要被复制到指定节点数才算成功（默认为1，主分片写入成功）</li><li><code>majority</code>：写操作需要被复制到大多数节点上才算成功（半数以上）</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">user</span>.<span class="hljs-title function_">insertOne</span>(<span class="hljs-params">&#123;</span><br><span class="hljs-params">    <span class="hljs-string">&quot;userName&quot;</span>: <span class="hljs-string">&quot;wgf&quot;</span>,</span><br><span class="hljs-params">    <span class="hljs-string">&quot;age&quot;</span>: <span class="hljs-number">20</span>,</span><br><span class="hljs-params">    <span class="hljs-string">&quot;sex&quot;</span>: <span class="hljs-number">1</span>,</span><br><span class="hljs-params">    <span class="hljs-string">&quot;address&quot;</span>: <span class="hljs-string">&quot;shenzhen&quot;</span></span><br><span class="hljs-params">    &#125;</span>)<br><br>&#123;<br>    <span class="hljs-string">&quot;acknowledged&quot;</span> : <span class="hljs-literal">true</span>,<br>    <span class="hljs-string">&quot;insertedId&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;64414ce28dddba084284aa92&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>指定插入1个副本后才算写入成功</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">user</span>.<span class="hljs-title function_">insertOne</span>(&#123;<br>    <span class="hljs-string">&quot;userName&quot;</span>: <span class="hljs-string">&quot;test&quot;</span>,<br>    <span class="hljs-string">&quot;age&quot;</span>: <span class="hljs-number">21</span>,<br>    <span class="hljs-string">&quot;sex&quot;</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;address&quot;</span>: <span class="hljs-string">&quot;shanghai&quot;</span><br>    &#125;,&#123;<br>        <span class="hljs-attr">writeConcern</span>: &#123;<br>                <span class="hljs-attr">w</span>: <span class="hljs-number">1</span><br>            &#125;<br>   &#125;)<br></code></pre></td></tr></table></figure><h3 id="insertmany"><a class="markdownIt-Anchor" href="#insertmany"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.insertMany/">insertMany</a></h3><p>将多个文档插入到一个集合中</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">collection</span>.<span class="hljs-title function_">insertMany</span>(<br>   [ &lt;document 1&gt; , &lt;document 2&gt;, ... ],<br>   &#123;<br>      writeConcern: &lt;document&gt;,<br>      ordered: &lt;boolean&gt;<br>   &#125;<br>)<br></code></pre></td></tr></table></figure><ul><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/write-concern/#std-label-wc-w">writeConcern 写关注</a></li><li>ordered: 是否按照顺序写入，默认为true<ul><li><code>true</code>：顺序插入，如果某个文档插入失败，那么后面的插入操作也会终止</li><li><code>false</code>：无序插入，如果某个文档插入失败，MongoDB 会记录错误，但不会停止插入操作（提高插入性能）</li></ul></li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">user</span>.<span class="hljs-title function_">insertMany</span>(<span class="hljs-params"></span><br><span class="hljs-params">    [</span><br><span class="hljs-params">        &#123;</span><br><span class="hljs-params">            <span class="hljs-string">&quot;userName&quot;</span> : <span class="hljs-string">&quot;zhangsan&quot;</span>,</span><br><span class="hljs-params">            <span class="hljs-string">&quot;age&quot;</span> : <span class="hljs-number">18</span>,</span><br><span class="hljs-params">            <span class="hljs-string">&quot;sex&quot;</span> : <span class="hljs-number">1</span>,</span><br><span class="hljs-params">            <span class="hljs-string">&quot;address&quot;</span> : <span class="hljs-string">&quot;beijing&quot;</span></span><br><span class="hljs-params">        &#125;,</span><br><span class="hljs-params">        &#123;</span><br><span class="hljs-params">            <span class="hljs-string">&quot;userName&quot;</span> : <span class="hljs-string">&quot;lisi&quot;</span>,</span><br><span class="hljs-params">            <span class="hljs-string">&quot;age&quot;</span> : <span class="hljs-number">26</span>,</span><br><span class="hljs-params">            <span class="hljs-string">&quot;sex&quot;</span> : <span class="hljs-number">1</span>,</span><br><span class="hljs-params">            <span class="hljs-string">&quot;address&quot;</span> : <span class="hljs-string">&quot;hainan&quot;</span></span><br><span class="hljs-params">        &#125;,</span><br><span class="hljs-params">    ],</span><br><span class="hljs-params">    &#123;</span><br><span class="hljs-params">        <span class="hljs-string">&quot;ordered&quot;</span>: <span class="hljs-literal">true</span></span><br><span class="hljs-params">    &#125;</span><br><span class="hljs-params"></span>)<br><br><br>&#123;<br>    <span class="hljs-string">&quot;acknowledged&quot;</span> : <span class="hljs-literal">true</span>,<br>    <span class="hljs-string">&quot;insertedIds&quot;</span> : [ <br>        <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;644169568dddba084284aaa5&quot;</span>), <br>        <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;644169568dddba084284aaa6&quot;</span>)<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="insert"><a class="markdownIt-Anchor" href="#insert"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.insert/">insert</a></h3><p>将一个或多个文档插入集合</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">collection</span>.<span class="hljs-title function_">insert</span>(<br>   &lt;document or array of documents&gt;,<br>   &#123;<br>     writeConcern: &lt;document&gt;,<br>     ordered: &lt;boolean&gt;<br>   &#125;<br>)<br></code></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">user</span>.<span class="hljs-title function_">insert</span>(&#123;<br>        <span class="hljs-string">&quot;userName&quot;</span> : <span class="hljs-string">&quot;luliu&quot;</span>,<br>        <span class="hljs-string">&quot;age&quot;</span> : <span class="hljs-number">28</span>,<br>        <span class="hljs-string">&quot;sex&quot;</span> : <span class="hljs-number">0</span>,<br>        <span class="hljs-string">&quot;address&quot;</span> : <span class="hljs-string">&quot;tianjing&quot;</span><br>    &#125;,<br>    &#123;<br>        <span class="hljs-string">&quot;writeConcern&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;w&quot;</span>: <span class="hljs-number">1</span><br>    &#125;<br>&#125;)<br><br><br><span class="hljs-title class_">Inserted</span> <span class="hljs-number">1</span> <span class="hljs-title function_">record</span>(s) <span class="hljs-keyword">in</span> 115ms<br></code></pre></td></tr></table></figure><h3 id="save"><a class="markdownIt-Anchor" href="#save"></a> <a target="_blank" rel="noopener" href="https://docs.mongoing.com/can-kao/mongo-shell-methods/collection-methods/db-collection-save">save</a></h3><p>覆盖现有的文档或插入新文档，具体取决于其document参数</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">collection</span>.<span class="hljs-title function_">save</span>(<br>   &lt;<span class="hljs-variable language_">document</span>&gt;,<br>   &#123;<br>     <span class="hljs-attr">writeConcern</span>: &lt;<span class="hljs-variable language_">document</span>&gt;<br>   &#125;<br>)<br></code></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">products</span>.<span class="hljs-title function_">save</span>( &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">100</span>, <span class="hljs-attr">item</span>: <span class="hljs-string">&quot;water&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">30</span> &#125; )<br></code></pre></td></tr></table></figure><p>如果 _id=100 的记录存在则更新文档(<code>全量覆盖</code>)，否则新增文档</p><h3 id="insert和save的区别"><a class="markdownIt-Anchor" href="#insert和save的区别"></a> insert和save的区别</h3><ul><li><p><code>insert</code>: 若新增数据的主键已经存在，则会抛 org.springframework.dao.DuplicateKeyException 异常提示主键重复，不保存当前数据</p></li><li><p><code>save</code>: 若新增数据的主键已经存在，则会对当前已经存在的数据进行修改操作(文档全量覆盖)</p></li></ul><h2 id="查询文档"><a class="markdownIt-Anchor" href="#查询文档"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/tutorial/query-documents/">查询文档</a></h2><p>查询语法如下</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">collection</span>.<span class="hljs-title function_">find</span>(query, projection, options)<br></code></pre></td></tr></table></figure><p>参数说明：</p><ul><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/query/"><strong>query</strong></a> ：可选，一个查询条件，用于指定要返回的文档</li><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.find/#std-label-method-find-projection"><strong>projection</strong></a> ：可选，使用投影操作符指定返回的字段（默认返回所有），指定返回 <code>&lt;field&gt;: &lt;1 or true&gt;</code>，不返回 <code>&lt;field&gt;: &lt;0 or false&gt;</code></li><li><a target="_blank" rel="noopener" href="https://mongodb.github.io/node-mongodb-native/4.0//interfaces/findoptions.html"><strong>options</strong></a>：可选，查询选项</li></ul><p>如果查询返回的条目数量较多，mongo shell则会自动实现分批显示。默认情况下每次只显示20条，可以输入 <code>it</code> 命令读取下一批</p><p>测试数据</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">[</span><br>    <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;_id&quot;</span> <span class="hljs-punctuation">:</span> ObjectId(<span class="hljs-string">&quot;5e7835466b6f69d428000001&quot;</span>)<span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;name&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Alice&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;age&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">30.0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;address&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;city&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;New York&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;state&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;NY&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;zip&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;10001&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;_id&quot;</span> <span class="hljs-punctuation">:</span> ObjectId(<span class="hljs-string">&quot;5e7835476b6f69d428000002&quot;</span>)<span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;name&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Bob&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;age&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">25.0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;address&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;city&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Chicago&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;state&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;IL&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;zip&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;60606&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;_id&quot;</span> <span class="hljs-punctuation">:</span> ObjectId(<span class="hljs-string">&quot;5e7835486b6f69d428000003&quot;</span>)<span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;name&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Charlie&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;age&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">28.0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;address&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;city&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Houston&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;state&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Texas&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;zip&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;77002&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;_id&quot;</span> <span class="hljs-punctuation">:</span> ObjectId(<span class="hljs-string">&quot;5e7835496b6f69d428000004&quot;</span>)<span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;name&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Dave&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;age&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">35.0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;address&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;city&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;San Francisco&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;state&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;CA&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;zip&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;94107&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;_id&quot;</span> <span class="hljs-punctuation">:</span> ObjectId(<span class="hljs-string">&quot;5e7835496b6f69d428000005&quot;</span>)<span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;name&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Eve&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;age&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">20.0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;address&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;city&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;New York&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;state&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;NY&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;zip&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;10001&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;_id&quot;</span> <span class="hljs-punctuation">:</span> ObjectId(<span class="hljs-string">&quot;5e7835496b6f69d428000006&quot;</span>)<span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;name&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Adam&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;age&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">25.0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;address&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;city&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;London&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;state&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;GB&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;zip&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;E1 4ST&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;_id&quot;</span> <span class="hljs-punctuation">:</span> ObjectId(<span class="hljs-string">&quot;5e7835496b6f69d428000007&quot;</span>)<span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;name&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Greg&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;age&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">30.0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;address&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;city&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;New York&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;state&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;NY&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;zip&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;10001&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;_id&quot;</span> <span class="hljs-punctuation">:</span> ObjectId(<span class="hljs-string">&quot;5e7835496b6f69d428000008&quot;</span>)<span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;name&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Jack&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;age&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">25.0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;address&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;city&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;London&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;state&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;GB&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;zip&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;E1 1AA&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;_id&quot;</span> <span class="hljs-punctuation">:</span> ObjectId(<span class="hljs-string">&quot;5e7835496b6f69d428000009&quot;</span>)<span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;name&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Emily&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;age&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">20.0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;address&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;city&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Paris&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;state&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;FR&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;zip&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;10003&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">]</span><br></code></pre></td></tr></table></figure><p>查询</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs json">db.getCollection(&#x27;user&#x27;).find(<span class="hljs-punctuation">&#123;</span><br>    name<span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Alice&quot;</span><br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br><span class="hljs-punctuation">&#123;</span><br>    name<span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>    age<span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br><span class="hljs-punctuation">&#123;</span><br>    max<span class="hljs-punctuation">:</span> <span class="hljs-number">5</span><br><span class="hljs-punctuation">&#125;</span>)<br></code></pre></td></tr></table></figure><h3 id="查询条件"><a class="markdownIt-Anchor" href="#查询条件"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/query/">查询条件</a></h3><h4 id="比较运算符"><a class="markdownIt-Anchor" href="#比较运算符"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/query-comparison/">比较运算符</a></h4><table><thead><tr><th>SQL</th><th>Mongo</th><th>运算符</th><th>说明</th></tr></thead><tbody><tr><td>a = 1</td><td>{a: 1} 或 {a: {$eq: 1}}</td><td>$eq</td><td>等于</td></tr><tr><td>a != 1</td><td>{a: {$ne: 1}}</td><td>$ne</td><td>不等于</td></tr><tr><td>a &gt; 1</td><td>{a: {$gt: 1}}</td><td>$gt</td><td>大于</td></tr><tr><td>a &gt;= 1</td><td>{a: {$gte: 1}}</td><td>$gte</td><td>大于等于</td></tr><tr><td>a &lt; 1</td><td>{a: {$lt: 1}}</td><td>$lt</td><td>小于</td></tr><tr><td>a &lt;= 1</td><td>{a: {$lte: 1}}</td><td>$lte</td><td>小于等于</td></tr><tr><td>a IN (1, 2, 3)</td><td>{a: {$in: [1, 2, 3]}}</td><td>$in</td><td>多值查询</td></tr><tr><td>a NOT IN (1,2,3)</td><td>{a: {$nin: [1,2,3]}}</td><td>$nin</td><td>多值查询取反</td></tr></tbody></table><h4 id="逻辑运算符"><a class="markdownIt-Anchor" href="#逻辑运算符"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/query-logical/">逻辑运算符</a></h4><table><thead><tr><th>SQL</th><th>Mongo</th><th>运算符</th><th>说明</th></tr></thead><tbody><tr><td>a = 1 AND b = 1</td><td>{a: 1, b: 1}或{$and: [{a: 1}, {b: 1}]}</td><td>$and</td><td>并且</td></tr><tr><td>a = 1 OR b = 1</td><td>{$or: [{a: 1}, {b: 1}]}</td><td>$or</td><td>或者</td></tr><tr><td>a != 1</td><td>{a: { $not: { $eq: 1}}}</td><td>$not</td><td>逻辑否定</td></tr><tr><td>a!=1 AND b!=1</td><td>{$nor: [{a:1}, {b: 1}]}</td><td>$nor</td><td>用于实现多个查询条件之间的逻辑否定</td></tr></tbody></table><h4 id="元素运算符"><a class="markdownIt-Anchor" href="#元素运算符"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/query-element/">元素运算符</a></h4><table><thead><tr><th>SQL</th><th>Mongo</th><th>运算符</th><th>说明</th></tr></thead><tbody><tr><td>a IS NULL</td><td>{a: {$exists: false}}</td><td>$exists</td><td>判断对应字段值是否存在</td></tr><tr><td>-</td><td>{“title” : {$type : ‘string’}} <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/bson-types/">BSON 数据类型</a></td><td>$type</td><td>获取某个字段为指定类型的文档</td></tr></tbody></table><h4 id="数组运算符"><a class="markdownIt-Anchor" href="#数组运算符"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/query-array/">数组运算符</a></h4><table><thead><tr><th>Mongo</th><th>运算符</th><th>说明</th></tr></thead><tbody><tr><td>{ tags: { $all: [ “ssl” , “security” ] } }</td><td>$all</td><td>匹配包含查询中指定的所有元素的数组</td></tr><tr><td>{ results: { $elemMatch: { product: “xyz”, score: { $gte: 8 } } } }<br>results 是个对象数组</td><td><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/projection/elemMatch/#mongodb-projection-proj.-elemMatch">$elemMatch</a></td><td>匹配数组字段，该数组至少有一个元素满足所有查询条件</td></tr><tr><td>{ tag: { $size: 1 } }</td><td>$size</td><td>查询特定长度的数组</td></tr></tbody></table><h3 id="文档查询"><a class="markdownIt-Anchor" href="#文档查询"></a> 文档查询</h3><h4 id="find"><a class="markdownIt-Anchor" href="#find"></a> find</h4><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/reference/method/db.collection.find/#mongodb-method-db.collection.find">db.collection.find(query, projection, options)</a></p><p>查询一个或多个文档，默认返回前20个文档，输入 <code>it</code> 继续迭代</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs json">db.getCollection(&#x27;user&#x27;).find(<br>    <span class="hljs-punctuation">&#123;</span><br>        age<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            $gte<span class="hljs-punctuation">:</span> <span class="hljs-number">32</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-punctuation">&#123;</span><br>        name<span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>        age<span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><br>    <span class="hljs-punctuation">&#125;</span><br>)<br><br><br><br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;_id&quot;</span> <span class="hljs-punctuation">:</span> ObjectId(<span class="hljs-string">&quot;5e7835496b6f69d428000004&quot;</span>)<span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;name&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Dave&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;age&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">35.0</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><h4 id="findone"><a class="markdownIt-Anchor" href="#findone"></a> findOne</h4><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/reference/method/db.collection.findOne/">db.collection.findOne(query, projection, options)</a></p><p>查询单个文档，返回一个满足集合或视图上指定查询条件的文档。如果有多个文档满足查询，则该方法按照反映文档在磁盘上的顺序的 <code>自然顺序返回第一个文档</code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs json">db.getCollection(&#x27;user&#x27;).findOne(<br>    <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-punctuation">&#123;</span><br>        name<span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>        age<span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><br>    <span class="hljs-punctuation">&#125;</span><br>)<br><br><br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;_id&quot;</span> <span class="hljs-punctuation">:</span> ObjectId(<span class="hljs-string">&quot;5e7835466b6f69d428000001&quot;</span>)<span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;name&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Alice&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;age&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">30.0</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><h4 id="findandmodify"><a class="markdownIt-Anchor" href="#findandmodify"></a> findAndModify</h4><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/reference/method/db.collection.findAndModify/">db.collection.findAndModify(document)</a></p><p>以原子方式修改并返回单个文档。默认情况下，返回的文档不包括对更新所做的修改（旧文档）。要返回包含更新修改的文档，请使用 <code>new</code> 选项（新文档）</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs json">db.collection.findAndModify(<span class="hljs-punctuation">&#123;</span><br>    query<span class="hljs-punctuation">:</span> &lt;document&gt;<span class="hljs-punctuation">,</span><br>    sort<span class="hljs-punctuation">:</span> &lt;document&gt;<span class="hljs-punctuation">,</span><br>    remove<span class="hljs-punctuation">:</span> &lt;boolean&gt;<span class="hljs-punctuation">,</span><br>    update<span class="hljs-punctuation">:</span> &lt;document or aggregation pipeline&gt;<span class="hljs-punctuation">,</span> <span class="hljs-comment">// Changed in MongoDB 4.2</span><br>    new<span class="hljs-punctuation">:</span> &lt;boolean&gt;<span class="hljs-punctuation">,</span><br>    fields<span class="hljs-punctuation">:</span> &lt;document&gt;<span class="hljs-punctuation">,</span><br>    upsert<span class="hljs-punctuation">:</span> &lt;boolean&gt;<span class="hljs-punctuation">,</span><br>    bypassDocumentValidation<span class="hljs-punctuation">:</span> &lt;boolean&gt;<span class="hljs-punctuation">,</span><br>    writeConcern<span class="hljs-punctuation">:</span> &lt;document&gt;<span class="hljs-punctuation">,</span><br>    collation<span class="hljs-punctuation">:</span> &lt;document&gt;<span class="hljs-punctuation">,</span><br>    arrayFilters<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span> &lt;filterdocument1&gt;<span class="hljs-punctuation">,</span> ... <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>    let<span class="hljs-punctuation">:</span> &lt;document&gt; <span class="hljs-comment">// Added in MongoDB 5.0</span><br><span class="hljs-punctuation">&#125;</span>);<br></code></pre></td></tr></table></figure><div class="note note-warning"><p><strong>比较</strong></p><p>和 <code>findOneAndUpdate()</code> 比较，<code>findAndModify()</code>方法则可以执行更复杂的操作，如删除、插入、修改等。该方法也可以返回更新前的文档或更新后的文档。</p></div><table><thead><tr><th>参数</th><th>类型</th><th>描述</th></tr></thead><tbody><tr><td><code>query</code></td><td>document</td><td>可选的。修改的选择标准。 <code>query</code>字段使用与db.collection.find()方法中使用的query selectors相同的query selectors。虽然查询可能匹配多个文档，但findAndModify() <strong>只会选择一个文档来修改</strong>。 如果未指定，则默认为空文档。 从 MongoDB 3.6.14(和 3.4.23)开始，如果查询参数不是文档，则操作错误。</td></tr><tr><td><code>sort</code></td><td>document</td><td>可选的。如果查询选择多个文档，则确定操作修改的文档。 findAndModify()修改此参数指定的 sort order 中的第一个文档。 从 MongoDB 3.6.14(和 3.4.23)开始，如果 sort 参数不是文档，则操作错误。</td></tr><tr><td><code>remove</code></td><td>boolean</td><td>必须指定<code>remove</code>或<code>update</code>字段。删除<code>query</code>字段中指定的文档。将其设置为<code>true</code>以删除所选文档。默认值为<code>false</code>。</td></tr><tr><td><code>update</code></td><td>document</td><td>必须指定<code>remove</code>或<code>update</code>字段。执行所选文档的更新。 <code>update</code>字段使用相同的更新 operators或<code>field: value</code>规范来修改所选文档。</td></tr><tr><td><code>new</code></td><td>boolean</td><td>可选的。当<code>true</code>时，返回修改后的文档而不是原始文档。 findAndModify()方法忽略<code>remove</code>操作的<code>new</code>选项。默认值为<code>false</code>。</td></tr><tr><td><code>fields</code></td><td>document</td><td>可选的。 return 的字段子集。 <code>fields</code>文档指定包含<code>1</code>的字段，如：<code>fields: &#123; &lt;field1&gt;: 1, &lt;field2&gt;: 1, ... &#125;</code>。见投影。 从 MongoDB 3.6.14(和 3.4.23)开始，如果 fields 参数不是文档，则操作错误。</td></tr><tr><td><code>upsert</code></td><td>boolean</td><td>可选的。与<code>update</code>字段结合使用。 当<code>true</code>，findAndModify()时： 如果没有文件匹配<code>query</code>，则创建一个新文档。有关详细信息，请参阅upsert 行为。 更新与<code>query</code>匹配的单个文档。 要避免多次 upsert，请确保<code>query</code>字段为唯一索引。 默认为<code>false</code>。</td></tr><tr><td><code>bypassDocumentValidation</code></td><td>boolean</td><td>可选的。允许db.collection.findAndModify在操作期间绕过文档验证。这使您可以更新不符合验证要求的文档。 version 3.2 中的新内容。</td></tr><tr><td><code>writeConcern</code></td><td>document</td><td>可选的。表示写关注的文件。省略使用默认写入问题。 version 3.2 中的新内容。</td></tr><tr><td><code>maxTimeMS</code></td><td>integer</td><td>可选的。指定处理操作的 time 限制(以毫秒为单位)。</td></tr><tr><td><code>collation</code></td><td>document</td><td>可选的。 指定要用于操作的整理。 整理允许用户为 string 比较指定 language-specific 规则，例如字母和重音标记的规则。 排序规则选项具有以下语法： 排序规则：{ locale：<string>， caseLevel：<boolean>， caseFirst：<string>， strength：<int>， numericOrdering：<boolean>， alternate：<string>， maxVariable：<string>， backwards ：<boolean>} 指定排序规则时，<code>locale</code>字段是必填字段;所有其他校对字段都是可选的。有关字段的说明，请参阅整理文件。 如果未指定排序规则但集合具有默认排序规则(请参阅db.createCollection())，则操作将使用为集合指定的排序规则。 如果没有为集合或操作指定排序规则，MongoDB 使用先前版本中用于 string 比较的简单二进制比较。 您无法为操作指定多个排序规则。对于 example，您不能为每个字段指定不同的排序规则，或者如果使用排序执行查找，则不能对查找使用一个排序规则，而对排序使用另一个排序规则。 version 3.4 中的新内容。</boolean></string></string></boolean></int></string></boolean></string></td></tr><tr><td><code>arrayFilters</code></td><td>array</td><td>可选的。过滤器文档的 array，用于确定要在 array 字段上为更新操作修改哪些 array 元素。 在更新文档中，使用$ [<identifier>]过滤后的位置 operator 来定义标识符，然后在 array 过滤器文档中进行 reference。如果标识符未包含在更新文档中，则不能为标识符提供 array 过滤器文档。 <strong>注意</strong> <code>&lt;identifier&gt;</code>必须以小写字母开头，并且只包含字母数字字符。 您可以在更新文档中多次包含相同的标识符;但是，对于更新文档中的每个不同标识符(<code>$[identifier]</code>)，您必须指定<strong>恰好一个</strong>对应的 array 过滤器文档。也就是说，您不能为同一标识符指定多个 array 过滤器文档。对于 example，如果 update 语句包含标识符<code>x</code>(可能多次)，则不能为<code>arrayFilters</code>指定以下内容，其中包含 2 个单独的<code>x</code>过滤器文档： [ { “x.a”: { $gt: 85 } }, { “x.b”: { $gt: 80 } } ] 但是，您可以在同一标识符上指定复合条件单个过滤器文档，例如以下示例： // Example 1 [ { or: [{"x.a": {gt: 85}}, {“x.b”: {$gt: 80}}] } ] // Example 2 [ { and: [{"x.a": {gt: 85}}, {“x.b”: {$gt: 80}}] } ] // Example 3 [ { “x.a”: { $gt: 85 }, “x.b”: { $gt: 80 } } ] 例如，请参阅为 Array Update Operations 指定 arrayFilters。 version 3.6 中的新内容。</identifier></td></tr></tbody></table><p>更新并返回新的文档</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs json">db.user.findAndModify(<span class="hljs-punctuation">&#123;</span><br>        query<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            _id<span class="hljs-punctuation">:</span> ObjectId(<span class="hljs-string">&quot;5e7835466b6f69d428000001&quot;</span>)<br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        update<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            $inc<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span>age<span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        new<span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><br>    <span class="hljs-punctuation">&#125;</span>)<br>    <br><br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;_id&quot;</span> <span class="hljs-punctuation">:</span> ObjectId(<span class="hljs-string">&quot;5e7835466b6f69d428000001&quot;</span>)<span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;name&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Alice&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;age&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">31.0</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;address&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;city&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;New York&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;state&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;NY&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;zip&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;10001&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><h4 id="findoneanddelete"><a class="markdownIt-Anchor" href="#findoneanddelete"></a> findOneAndDelete</h4><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/reference/method/db.collection.findOneAndDelete/">db.collection.findOneAndDelete(filter, options)</a></p><p>根据 <code>filter</code> 和 <code>sort</code> 条件删除单个文档，返回已删除的文档</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs json">db.collection.findOneAndDelete(<br>   &lt;filter&gt;<span class="hljs-punctuation">,</span><br>   <span class="hljs-punctuation">&#123;</span><br>     writeConcern<span class="hljs-punctuation">:</span> &lt;document&gt;<span class="hljs-punctuation">,</span><br>     projection<span class="hljs-punctuation">:</span> &lt;document&gt;<span class="hljs-punctuation">,</span><br>     sort<span class="hljs-punctuation">:</span> &lt;document&gt;<span class="hljs-punctuation">,</span><br>     maxTimeMS<span class="hljs-punctuation">:</span> &lt;number&gt;<span class="hljs-punctuation">,</span><br>     collation<span class="hljs-punctuation">:</span> &lt;document&gt;<br>   <span class="hljs-punctuation">&#125;</span><br>)<br></code></pre></td></tr></table></figure><table><thead><tr><th>参数</th><th>类型</th><th>描述</th></tr></thead><tbody><tr><td><code>filter</code></td><td>document</td><td>更新的选择标准。可以使用与find()方法相同的query selectors。 指定空文档<code>&#123; &#125;</code>以删除集合中返回的第一个文档。 如果未指定，则默认为空文档。 从 MongoDB 3.6.14(和 3.4.23)开始，如果查询参数不是文档，则操作错误。</td></tr><tr><td><code>projection</code></td><td>document</td><td>可选的。 return 的字段子集。 要_返回返回文档中的所有字段，请省略此参数。 从 MongoDB 3.6.14(和 3.4.23)开始，如果投影参数不是文档，则操作错误。</td></tr><tr><td><code>sort</code></td><td>document</td><td>可选的。为<code>filter</code>匹配的文档指定排序 order。 从 MongoDB 3.6.14(和 3.4.23)开始，如果 sort 参数不是文档，则操作错误。 见cursor.sort()。</td></tr><tr><td><code>maxTimeMS</code></td><td>number</td><td>可选的。指定操作必须在其中完成的 time 限制(以毫秒为单位)。如果超出限制则引发错误。</td></tr><tr><td><code>collation</code></td><td>document</td><td>可选的。 指定要用于操作的整理。 整理允许用户为 string 比较指定 language-specific 规则，例如字母和重音标记的规则。 排序规则选项具有以下语法： 排序规则：{ locale：<string>， caseLevel：<boolean>， caseFirst：<string>， strength：<int>， numericOrdering：<boolean>， alternate：<string>， maxVariable：<string>， backwards ：<boolean>} 指定排序规则时，<code>locale</code>字段是必填字段;所有其他校对字段都是可选的。有关字段的说明，请参阅整理文件。 如果未指定排序规则但集合具有默认排序规则(请参阅db.createCollection())，则操作将使用为集合指定的排序规则。 如果没有为集合或操作指定排序规则，MongoDB 使用先前版本中用于 string 比较的简单二进制比较。 您无法为操作指定多个排序规则。对于 example，您不能为每个字段指定不同的排序规则，或者如果使用排序执行查找，则不能对查找使用一个排序规则，而对排序使用另一个排序规则。 version 3.4 中的新内容。</boolean></string></string></boolean></int></string></boolean></string></td></tr></tbody></table><p>按照名称排序，删除第一个文档并返回删除的文档</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs json">db.user.findOneAndDelete(<br>    <span class="hljs-punctuation">&#123;</span><br>        age<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span>$gte<span class="hljs-punctuation">:</span> <span class="hljs-number">30</span><span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-punctuation">&#123;</span><br>        sort<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            name<span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br>)<br><br><br><br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;_id&quot;</span> <span class="hljs-punctuation">:</span> ObjectId(<span class="hljs-string">&quot;5e7835466b6f69d428000001&quot;</span>)<span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;name&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Alice&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;age&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">31.0</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;address&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;city&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;New York&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;state&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;NY&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;zip&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;10001&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><h4 id="findoneandreplace"><a class="markdownIt-Anchor" href="#findoneandreplace"></a> findOneAndReplace</h4><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/reference/method/db.collection.findOneAndReplace/">db.collection.findOneAndReplace(filter, replacement, options)</a></p><p>根据<code>filter</code>和<code>sort</code>条件修改和替换单个文档(全量替换，除了 _id字段)</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs json">db.collection.findOneAndReplace(<br>    &lt;filter&gt;<span class="hljs-punctuation">,</span><br>    &lt;replacement&gt;<span class="hljs-punctuation">,</span><br>    <span class="hljs-punctuation">&#123;</span><br>        projection<span class="hljs-punctuation">:</span> &lt;document&gt;<span class="hljs-punctuation">,</span><br>        sort<span class="hljs-punctuation">:</span> &lt;document&gt;<span class="hljs-punctuation">,</span><br>        maxTimeMS<span class="hljs-punctuation">:</span> &lt;number&gt;<span class="hljs-punctuation">,</span><br>        upsert<span class="hljs-punctuation">:</span> &lt;boolean&gt;<span class="hljs-punctuation">,</span><br>        returnNewDocument<span class="hljs-punctuation">:</span> &lt;boolean&gt;<span class="hljs-punctuation">,</span><br>        collation<span class="hljs-punctuation">:</span> &lt;document&gt;<br>    <span class="hljs-punctuation">&#125;</span><br>)<br></code></pre></td></tr></table></figure><table><thead><tr><th>参数</th><th>类型</th><th>描述</th></tr></thead><tbody><tr><td><code>filter</code></td><td>document</td><td>更新的选择标准。可以使用与find()方法相同的query selectors。 指定一个空文档<code>&#123; &#125;</code>以替换集合中返回的第一个文档。 如果未指定，则默认为空文档。 从 MongoDB 3.6.14(和 3.4.23)开始，如果查询参数不是文档，则操作错误。</td></tr><tr><td><code>replacement</code></td><td>document</td><td>替换文件。 不能包含更新 operators。 <code>&lt;replacement&gt;</code>文档无法指定与替换文档不同的<code>_id</code> value。</td></tr><tr><td><code>projection</code></td><td>document</td><td>可选的。 return 的字段子集。 要_return 匹配文档中的所有字段，请省略此参数。 从 MongoDB 3.6.14(和 3.4.23)开始，如果投影参数不是文档，则操作错误。</td></tr><tr><td><code>sort</code></td><td>document</td><td>可选的。为<code>filter</code>匹配的文档指定排序 order。 从 MongoDB 3.6.14(和 3.4.23)开始，如果 sort 参数不是文档，则操作错误。 见cursor.sort()。</td></tr><tr><td><code>maxTimeMS</code></td><td>number</td><td>可选的。指定操作必须在其中完成的 time 限制(以毫秒为单位)。如果超出限制则引发错误。</td></tr><tr><td><code>upsert</code></td><td>boolean</td><td>可选的。当<code>true</code>，findOneAndReplace()时： 如果没有文档与<code>filter</code>匹配，则从<code>replacement</code>参数插入文档。插入新文档后返回<code>null</code>，除非<code>returnNewDocument</code>是<code>true</code>。 用<code>replacement</code>文档替换与<code>filter</code>匹配的文档。 MongoDB 将<code>_id</code>字段添加到替换文档中，如果未在<code>filter</code>或<code>replacement</code>文档中指定。如果两者都存在<code>_id</code>，则值必须相等。 要避免多次 upsert，请确保<code>query</code>字段为唯一索引。 默认为<code>false</code>。</td></tr><tr><td><code>returnNewDocument</code></td><td>boolean</td><td>可选的。当<code>true</code>时，返回替换文档而不是原始文档。 默认为<code>false</code>。</td></tr><tr><td><code>collation</code></td><td>document</td><td>可选的。 指定要用于操作的整理。 整理允许用户为 string 比较指定 language-specific 规则，例如字母和重音标记的规则。 排序规则选项具有以下语法： 排序规则：{ locale：<string>， caseLevel：<boolean>， caseFirst：<string>， strength：<int>， numericOrdering：<boolean>， alternate：<string>， maxVariable：<string>， backwards ：<boolean>} 指定排序规则时，<code>locale</code>字段是必填字段;所有其他校对字段都是可选的。有关字段的说明，请参阅整理文件。 如果未指定排序规则但集合具有默认排序规则(请参阅db.createCollection())，则操作将使用为集合指定的排序规则。 如果没有为集合或操作指定排序规则，MongoDB 使用先前版本中用于 string 比较的简单二进制比较。 您无法为操作指定多个排序规则。对于 example，您不能为每个字段指定不同的排序规则，或者如果使用排序执行查找，则不能对查找使用一个排序规则，而对排序使用另一个排序规则。 version 3.4 中的新内容。</boolean></string></string></boolean></int></string></boolean></string></td></tr></tbody></table><p>替换文档</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">user</span>.<span class="hljs-title function_">findOneAndReplace</span>(<span class="hljs-params"></span><br><span class="hljs-params">    &#123;</span><br><span class="hljs-params">        _id: ObjectId(<span class="hljs-string">&quot;5e7835476b6f69d428000002&quot;</span>)</span><br><span class="hljs-params">    &#125;,</span><br><span class="hljs-params">    &#123;</span><br><span class="hljs-params">        <span class="hljs-string">&quot;name&quot;</span> : <span class="hljs-string">&quot;wgf&quot;</span>,</span><br><span class="hljs-params">        <span class="hljs-string">&quot;age&quot;</span> : <span class="hljs-number">25</span>,</span><br><span class="hljs-params">        <span class="hljs-string">&quot;address&quot;</span> : &#123;</span><br><span class="hljs-params">            <span class="hljs-string">&quot;city&quot;</span> : <span class="hljs-string">&quot;shenzhen&quot;</span>,</span><br><span class="hljs-params">            <span class="hljs-string">&quot;state&quot;</span> : <span class="hljs-string">&quot;guangdong&quot;</span>,</span><br><span class="hljs-params">            <span class="hljs-string">&quot;zip&quot;</span> : <span class="hljs-string">&quot;518111&quot;</span></span><br><span class="hljs-params">        &#125;</span><br><span class="hljs-params">    &#125;</span><br><span class="hljs-params"></span>)<br><br><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;5e7835476b6f69d428000002&quot;</span>),<br>    <span class="hljs-string">&quot;name&quot;</span> : <span class="hljs-string">&quot;Bob&quot;</span>,<br>    <span class="hljs-string">&quot;age&quot;</span> : <span class="hljs-number">25.0</span>,<br>    <span class="hljs-string">&quot;address&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;city&quot;</span> : <span class="hljs-string">&quot;Chicago&quot;</span>,<br>        <span class="hljs-string">&quot;state&quot;</span> : <span class="hljs-string">&quot;IL&quot;</span>,<br>        <span class="hljs-string">&quot;zip&quot;</span> : <span class="hljs-string">&quot;60606&quot;</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="findoneandupdate"><a class="markdownIt-Anchor" href="#findoneandupdate"></a> findOneAndUpdate</h4><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/reference/method/db.collection.findOneAndUpdate/">db.collection.findOneAndUpdate(filter, update, options)</a></p><p>根据 <code>filter</code> 和 <code>sort</code> 条件更新单个文档</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">collection</span>.<span class="hljs-title function_">findOneAndUpdate</span>(<br>   &lt;filter&gt;,<br>   &lt;update document or aggregation pipeline&gt;, // Changed in MongoDB 4.2<br>   &#123;<br>     projection: &lt;document&gt;,<br>     sort: &lt;document&gt;,<br>     maxTimeMS: &lt;number&gt;,<br>     upsert: &lt;boolean&gt;,<br>     returnDocument: &lt;string&gt;,<br>     returnNewDocument: &lt;boolean&gt;,<br>     collation: &lt;document&gt;,<br>     arrayFilters: [ &lt;filterdocument1&gt;, ... ]<br>   &#125;<br>)<br></code></pre></td></tr></table></figure><table><thead><tr><th>参数</th><th>类型</th><th>描述</th></tr></thead><tbody><tr><td><code>filter</code></td><td>document</td><td>更新的选择标准。可以使用与find()方法相同的query selectors。 指定一个空文档<code>&#123; &#125;</code>以更新集合中返回的第一个文档。 如果未指定，则默认为空文档。 从 MongoDB 3.6.14(和 3.4.23)开始，如果查询参数不是文档，则操作错误。</td></tr><tr><td><code>update</code></td><td>document</td><td>更新文件。 必须仅包含更新 operators。</td></tr><tr><td><code>projection</code></td><td>document</td><td>可选的。 return 的字段子集。 要_返回返回文档中的所有字段，请省略此参数。 从 MongoDB 3.6.14(和 3.4.23)开始，如果投影参数不是文档，则操作错误。</td></tr><tr><td><code>sort</code></td><td>document</td><td>可选的。为<code>filter</code>匹配的文档指定排序 order。 从 MongoDB 3.6.14(和 3.4.23)开始，如果 sort 参数不是文档，则操作错误。 见cursor.sort()。</td></tr><tr><td><code>maxTimeMS</code></td><td>number</td><td>可选的。指定操作必须在其中完成的 time 限制(以毫秒为单位)。如果超出限制则引发错误。</td></tr><tr><td><code>upsert</code></td><td>boolean</td><td>可选的。当<code>true</code>，findOneAndUpdate()时： 如果没有文件匹配<code>filter</code>，则创建一个新文档。有关详细信息，请参阅upsert 行为。插入新文档后返回<code>null</code>，除非<code>returnNewDocument</code>是<code>true</code>。 更新与<code>filter</code>匹配的单个文档。 要避免多次 upsert，请确保<code>filter</code>字段为唯一索引。 默认为<code>false</code>。</td></tr><tr><td><code>returnNewDocument</code></td><td>boolean</td><td>可选的。当<code>true</code>时，返回更新的文档而不是原始文档。 默认为<code>false</code>。</td></tr><tr><td><code>collation</code></td><td>document</td><td>可选的。 指定要用于操作的整理。 整理允许用户为 string 比较指定 language-specific 规则，例如字母和重音标记的规则。 排序规则选项具有以下语法： 排序规则：{ locale：<string>， caseLevel：<boolean>， caseFirst：<string>， strength：<int>， numericOrdering：<boolean>， alternate：<string>， maxVariable：<string>， backwards ：<boolean>} 指定排序规则时，<code>locale</code>字段是必填字段;所有其他校对字段都是可选的。有关字段的说明，请参阅整理文件。 如果未指定排序规则但集合具有默认排序规则(请参阅db.createCollection())，则操作将使用为集合指定的排序规则。 如果没有为集合或操作指定排序规则，MongoDB 使用先前版本中用于 string 比较的简单二进制比较。 您无法为操作指定多个排序规则。对于 example，您不能为每个字段指定不同的排序规则，或者如果使用排序执行查找，则不能对查找使用一个排序规则，而对排序使用另一个排序规则。 version 3.4 中的新内容。</boolean></string></string></boolean></int></string></boolean></string></td></tr><tr><td><code>arrayFilters</code></td><td>array</td><td>可选的。过滤器文档的 array，用于确定要在 array 字段上为更新操作修改哪些 array 元素。 在更新文档中，使用$ [<identifier>]过滤后的位置 operator 来定义标识符，然后在 array 过滤器文档中进行 reference。如果标识符未包含在更新文档中，则不能为标识符提供 array 过滤器文档。 <strong>注意</strong> <code>&lt;identifier&gt;</code>必须以小写字母开头，并且只包含字母数字字符。 您可以在更新文档中多次包含相同的标识符;但是，对于更新文档中的每个不同标识符(<code>$[identifier]</code>)，您必须指定<strong>恰好一个</strong>对应的 array 过滤器文档。也就是说，您不能为同一标识符指定多个 array 过滤器文档。对于 example，如果 update 语句包含标识符<code>x</code>(可能多次)，则不能为<code>arrayFilters</code>指定以下内容，其中包含 2 个单独的<code>x</code>过滤器文档： // INVALID [ { “x.a”: { $gt: 85 } }, { “x.b”: { $gt: 80 } } ] 但是，您可以在同一标识符上指定复合条件单个过滤器文档，例如以下示例： // Example 1 [ { or: [{"x.a": {gt: 85}}, {“x.b”: {$gt: 80}}] } ] // Example 2 [ { and: [{"x.a": {gt: 85}}, {“x.b”: {$gt: 80}}] } ] // Example 3 [ { “x.a”: { $gt: 85 }, “x.b”: { $gt: 80 } } ] 例如，请参阅为 Array Update Operations 指定 arrayFilters。 version 3.6 中的新内容。</identifier></td></tr></tbody></table><p>更新当个文档，并返回旧文档</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">user</span>.<span class="hljs-title function_">findOneAndUpdate</span>(<span class="hljs-params"></span><br><span class="hljs-params">    &#123;</span><br><span class="hljs-params">        name: <span class="hljs-string">&quot;wgf&quot;</span></span><br><span class="hljs-params">    &#125;,</span><br><span class="hljs-params">    &#123;</span><br><span class="hljs-params">        $inc: &#123;</span><br><span class="hljs-params">            age: <span class="hljs-number">1</span></span><br><span class="hljs-params">        &#125;</span><br><span class="hljs-params">    &#125;</span><br><span class="hljs-params"></span>)<br><br><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;5e7835476b6f69d428000002&quot;</span>),<br>    <span class="hljs-string">&quot;name&quot;</span> : <span class="hljs-string">&quot;wgf&quot;</span>,<br>    <span class="hljs-string">&quot;age&quot;</span> : <span class="hljs-number">25.0</span>,<br>    <span class="hljs-string">&quot;address&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;city&quot;</span> : <span class="hljs-string">&quot;shenzhen&quot;</span>,<br>        <span class="hljs-string">&quot;state&quot;</span> : <span class="hljs-string">&quot;guangdong&quot;</span>,<br>        <span class="hljs-string">&quot;zip&quot;</span> : <span class="hljs-string">&quot;518111&quot;</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="嵌套文档查询"><a class="markdownIt-Anchor" href="#嵌套文档查询"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/tutorial/query-embedded-documents/">嵌套文档查询</a></h3><p>测试数据</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">insertMany</span>( [<br>   &#123; <span class="hljs-attr">item</span>: <span class="hljs-string">&quot;journal&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">25</span>, <span class="hljs-attr">size</span>: &#123; <span class="hljs-attr">h</span>: <span class="hljs-number">14</span>, <span class="hljs-attr">w</span>: <span class="hljs-number">21</span>, <span class="hljs-attr">uom</span>: <span class="hljs-string">&quot;cm&quot;</span> &#125;, <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;A&quot;</span> &#125;,<br>   &#123; <span class="hljs-attr">item</span>: <span class="hljs-string">&quot;notebook&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">50</span>, <span class="hljs-attr">size</span>: &#123; <span class="hljs-attr">h</span>: <span class="hljs-number">8.5</span>, <span class="hljs-attr">w</span>: <span class="hljs-number">11</span>, <span class="hljs-attr">uom</span>: <span class="hljs-string">&quot;in&quot;</span> &#125;, <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;A&quot;</span> &#125;,<br>   &#123; <span class="hljs-attr">item</span>: <span class="hljs-string">&quot;paper&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">100</span>, <span class="hljs-attr">size</span>: &#123; <span class="hljs-attr">h</span>: <span class="hljs-number">8.5</span>, <span class="hljs-attr">w</span>: <span class="hljs-number">11</span>, <span class="hljs-attr">uom</span>: <span class="hljs-string">&quot;in&quot;</span> &#125;, <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;D&quot;</span> &#125;,<br>   &#123; <span class="hljs-attr">item</span>: <span class="hljs-string">&quot;planner&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">75</span>, <span class="hljs-attr">size</span>: &#123; <span class="hljs-attr">h</span>: <span class="hljs-number">22.85</span>, <span class="hljs-attr">w</span>: <span class="hljs-number">30</span>, <span class="hljs-attr">uom</span>: <span class="hljs-string">&quot;cm&quot;</span> &#125;, <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;D&quot;</span> &#125;,<br>   &#123; <span class="hljs-attr">item</span>: <span class="hljs-string">&quot;postcard&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">45</span>, <span class="hljs-attr">size</span>: &#123; <span class="hljs-attr">h</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">w</span>: <span class="hljs-number">15.25</span>, <span class="hljs-attr">uom</span>: <span class="hljs-string">&quot;cm&quot;</span> &#125;, <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;A&quot;</span> &#125;<br>]);<br></code></pre></td></tr></table></figure><h4 id="等值查询"><a class="markdownIt-Anchor" href="#等值查询"></a> 等值查询</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">find</span>(<span class="hljs-params"></span><br><span class="hljs-params">    &#123;</span><br><span class="hljs-params">        size: &#123;</span><br><span class="hljs-params">            h: <span class="hljs-number">14</span>,</span><br><span class="hljs-params">            w: <span class="hljs-number">21</span>,</span><br><span class="hljs-params">            uom: <span class="hljs-string">&quot;cm&quot;</span></span><br><span class="hljs-params">        &#125;</span><br><span class="hljs-params">    &#125;</span><br><span class="hljs-params"></span>)<br><br><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;646c8f4baf188546f987c4f9&quot;</span>),<br>    <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;journal&quot;</span>,<br>    <span class="hljs-string">&quot;qty&quot;</span> : <span class="hljs-number">25.0</span>,<br>    <span class="hljs-string">&quot;size&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;h&quot;</span> : <span class="hljs-number">14.0</span>,<br>        <span class="hljs-string">&quot;w&quot;</span> : <span class="hljs-number">21.0</span>,<br>        <span class="hljs-string">&quot;uom&quot;</span> : <span class="hljs-string">&quot;cm&quot;</span><br>    &#125;,<br>    <span class="hljs-string">&quot;status&quot;</span> : <span class="hljs-string">&quot;A&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>对嵌套文档做 <code>等值</code> 查询时，使用查询筛选器文档 <code>&#123; &lt;field&gt;: &lt;value&gt; &#125;</code> ，其中 <code>&lt;value&gt;</code> 是要匹配的文档。</p><p><span class="green-line">对嵌套文档做等值查询时，要求指定的 <code>&lt;value&gt;</code> 文档（包括字段和顺序）完全匹配<span>，例如一下文档字段调换位置就不满足等值查询，查询不出结果</span></span></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">find</span>(<br>    &#123;<br>        <span class="hljs-attr">size</span>: &#123;<br>            <span class="hljs-attr">w</span>: <span class="hljs-number">21</span>,<br>            <span class="hljs-attr">h</span>: <span class="hljs-number">14</span>,<br>            <span class="hljs-attr">uom</span>: <span class="hljs-string">&quot;cm&quot;</span><br>        &#125;<br>    &#125;<br>)<br></code></pre></td></tr></table></figure><h4 id="嵌套文档字段查询"><a class="markdownIt-Anchor" href="#嵌套文档字段查询"></a> 嵌套文档字段查询</h4><p><span class="green-line">要在嵌套文档中的字段上指定查询条件，请使用点符号 ( <code>&quot;field.nestedField&quot;</code> )</span></p><div class="note note-warning"><p><strong>注意</strong></p><p>当在查询语句中使用 <code>&quot;.&quot;</code>，字段和嵌套文档字段必须在引号内</p></div><p>下面例子选择嵌套在 <code>size</code> 字段中的字段 <code>uom</code> 等于 <code>&quot;in&quot;</code> 的所有文档：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">find</span>( &#123; <span class="hljs-string">&quot;size.uom&quot;</span>: <span class="hljs-string">&quot;in&quot;</span> &#125; )<br><br><br><br><span class="hljs-comment">/* 1 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;646c8f4baf188546f987c4fa&quot;</span>),<br>    <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;notebook&quot;</span>,<br>    <span class="hljs-string">&quot;qty&quot;</span> : <span class="hljs-number">50.0</span>,<br>    <span class="hljs-string">&quot;size&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;h&quot;</span> : <span class="hljs-number">8.5</span>,<br>        <span class="hljs-string">&quot;w&quot;</span> : <span class="hljs-number">11.0</span>,<br>        <span class="hljs-string">&quot;uom&quot;</span> : <span class="hljs-string">&quot;in&quot;</span><br>    &#125;,<br>    <span class="hljs-string">&quot;status&quot;</span> : <span class="hljs-string">&quot;A&quot;</span><br>&#125;<br><br><span class="hljs-comment">/* 2 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;646c8f4baf188546f987c4fb&quot;</span>),<br>    <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;paper&quot;</span>,<br>    <span class="hljs-string">&quot;qty&quot;</span> : <span class="hljs-number">100.0</span>,<br>    <span class="hljs-string">&quot;size&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;h&quot;</span> : <span class="hljs-number">8.5</span>,<br>        <span class="hljs-string">&quot;w&quot;</span> : <span class="hljs-number">11.0</span>,<br>        <span class="hljs-string">&quot;uom&quot;</span> : <span class="hljs-string">&quot;in&quot;</span><br>    &#125;,<br>    <span class="hljs-string">&quot;status&quot;</span> : <span class="hljs-string">&quot;D&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="嵌套文档组数查询"><a class="markdownIt-Anchor" href="#嵌套文档组数查询"></a> 嵌套文档组数查询</h3><p class="note note-primary">测试数据</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">insertMany</span>( [<br>   &#123; <span class="hljs-attr">item</span>: <span class="hljs-string">&quot;journal&quot;</span>, <span class="hljs-attr">instock</span>: [ &#123; <span class="hljs-attr">warehouse</span>: <span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">5</span> &#125;, &#123; <span class="hljs-attr">warehouse</span>: <span class="hljs-string">&quot;C&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">15</span> &#125; ] &#125;,<br>   &#123; <span class="hljs-attr">item</span>: <span class="hljs-string">&quot;notebook&quot;</span>, <span class="hljs-attr">instock</span>: [ &#123; <span class="hljs-attr">warehouse</span>: <span class="hljs-string">&quot;C&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">5</span> &#125; ] &#125;,<br>   &#123; <span class="hljs-attr">item</span>: <span class="hljs-string">&quot;paper&quot;</span>, <span class="hljs-attr">instock</span>: [ &#123; <span class="hljs-attr">warehouse</span>: <span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">60</span> &#125;, &#123; <span class="hljs-attr">warehouse</span>: <span class="hljs-string">&quot;B&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">15</span> &#125; ] &#125;,<br>   &#123; <span class="hljs-attr">item</span>: <span class="hljs-string">&quot;planner&quot;</span>, <span class="hljs-attr">instock</span>: [ &#123; <span class="hljs-attr">warehouse</span>: <span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">40</span> &#125;, &#123; <span class="hljs-attr">warehouse</span>: <span class="hljs-string">&quot;B&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">5</span> &#125; ] &#125;,<br>   &#123; <span class="hljs-attr">item</span>: <span class="hljs-string">&quot;postcard&quot;</span>, <span class="hljs-attr">instock</span>: [ &#123; <span class="hljs-attr">warehouse</span>: <span class="hljs-string">&quot;B&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">15</span> &#125;, &#123; <span class="hljs-attr">warehouse</span>: <span class="hljs-string">&quot;C&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">35</span> &#125; ] &#125;<br>]);<br></code></pre></td></tr></table></figure><h4 id="等值查询-2"><a class="markdownIt-Anchor" href="#等值查询-2"></a> 等值查询</h4><p>查询库存对象数组中，仓库为 “A”，库存为 5 的库存数据</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">find</span>(<span class="hljs-params"></span><br><span class="hljs-params">    &#123;</span><br><span class="hljs-params">        instock: &#123;</span><br><span class="hljs-params">            warehouse: <span class="hljs-string">&quot;A&quot;</span>,</span><br><span class="hljs-params">            qty: <span class="hljs-number">5</span></span><br><span class="hljs-params">        &#125;</span><br><span class="hljs-params">    &#125;</span><br><span class="hljs-params"></span>)<br><br><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;644628c7f6e1b1a011924011&quot;</span>),<br>    <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;journal&quot;</span>,<br>    <span class="hljs-string">&quot;instock&quot;</span> : [ <br>        &#123;<br>            <span class="hljs-string">&quot;warehouse&quot;</span> : <span class="hljs-string">&quot;A&quot;</span>,<br>            <span class="hljs-string">&quot;qty&quot;</span> : <span class="hljs-number">5.0</span><br>        &#125;, <br>        &#123;<br>            <span class="hljs-string">&quot;warehouse&quot;</span> : <span class="hljs-string">&quot;C&quot;</span>,<br>            <span class="hljs-string">&quot;qty&quot;</span> : <span class="hljs-number">15.0</span><br>        &#125;<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure><p>当对整个嵌套文档使用等值匹配的时候是要求精确匹配指定文档，包括字段顺序。比如，下面的语句并没有查询到 <strong>inventory</strong> 集合中的任何文档：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">db.inventory.find( <span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;instock&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span> qty<span class="hljs-punctuation">:</span> <span class="hljs-number">5</span><span class="hljs-punctuation">,</span> warehouse<span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;A&quot;</span> <span class="hljs-punctuation">&#125;</span> <span class="hljs-punctuation">&#125;</span> )<br></code></pre></td></tr></table></figure><h4 id="数组嵌套文档指定查询条件"><a class="markdownIt-Anchor" href="#数组嵌套文档指定查询条件"></a> 数组嵌套文档指定查询条件</h4><p>如果你不知道嵌套在数组中的文档的索引位置，请将数组字段的名称与一个点 ( <code>.</code> ) 和嵌套文档中的字段名称连接起来，这样就会返回符合文档数组条件的整个文档</p><div class="note note-warning"><p><strong>注意</strong></p><p>嵌套文档数组中，只要有一个嵌套文档满足条件，就会返回整个文档</p><p>当在查询语句中使用 <code>&quot;.&quot;</code>，字段和嵌套文档字段必须在引号内</p></div><p>查询嵌套文档数组 instock 库存大于等于40的文档</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">find</span>(<br>    &#123;<br>        <span class="hljs-string">&quot;instock.qty&quot;</span>: &#123;<br>            <span class="hljs-attr">$gte</span>: <span class="hljs-number">40</span><br>        &#125;<br>    &#125;<br>)<br><br><br><span class="hljs-comment">/* 1 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;644628c7f6e1b1a011924013&quot;</span>),<br>    <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;paper&quot;</span>,<br>    <span class="hljs-string">&quot;instock&quot;</span> : [ <br>        &#123;<br>            <span class="hljs-string">&quot;warehouse&quot;</span> : <span class="hljs-string">&quot;A&quot;</span>,<br>            <span class="hljs-string">&quot;qty&quot;</span> : <span class="hljs-number">60.0</span><br>        &#125;, <br>        &#123;<br>            <span class="hljs-string">&quot;warehouse&quot;</span> : <span class="hljs-string">&quot;B&quot;</span>,<br>            <span class="hljs-string">&quot;qty&quot;</span> : <span class="hljs-number">15.0</span><br>        &#125;<br>    ]<br>&#125;<br><br><span class="hljs-comment">/* 2 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;644628c7f6e1b1a011924014&quot;</span>),<br>    <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;planner&quot;</span>,<br>    <span class="hljs-string">&quot;instock&quot;</span> : [ <br>        &#123;<br>            <span class="hljs-string">&quot;warehouse&quot;</span> : <span class="hljs-string">&quot;A&quot;</span>,<br>            <span class="hljs-string">&quot;qty&quot;</span> : <span class="hljs-number">40.0</span><br>        &#125;, <br>        &#123;<br>            <span class="hljs-string">&quot;warehouse&quot;</span> : <span class="hljs-string">&quot;B&quot;</span>,<br>            <span class="hljs-string">&quot;qty&quot;</span> : <span class="hljs-number">5.0</span><br>        &#125;<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="使用数组下标查询嵌套文档字段"><a class="markdownIt-Anchor" href="#使用数组下标查询嵌套文档字段"></a> 使用数组下标查询嵌套文档字段</h4><p>查询所有文档中，<code>instock</code> 数组的第一个元素的 <code>qty</code> 小于等于5的文档</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">find</span>(<br>    &#123;<br>        <span class="hljs-string">&quot;instock.0.qty&quot;</span>: &#123;<br>            <span class="hljs-attr">$lte</span>: <span class="hljs-number">5</span><br>        &#125;<br>    &#125;<br>)<br><br><br><span class="hljs-comment">/* 1 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;644628c7f6e1b1a011924011&quot;</span>),<br>    <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;journal&quot;</span>,<br>    <span class="hljs-string">&quot;instock&quot;</span> : [ <br>        &#123;<br>            <span class="hljs-string">&quot;warehouse&quot;</span> : <span class="hljs-string">&quot;A&quot;</span>,<br>            <span class="hljs-string">&quot;qty&quot;</span> : <span class="hljs-number">5.0</span><br>        &#125;, <br>        &#123;<br>            <span class="hljs-string">&quot;warehouse&quot;</span> : <span class="hljs-string">&quot;C&quot;</span>,<br>            <span class="hljs-string">&quot;qty&quot;</span> : <span class="hljs-number">15.0</span><br>        &#125;<br>    ]<br>&#125;<br><br><span class="hljs-comment">/* 2 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;644628c7f6e1b1a011924012&quot;</span>),<br>    <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;notebook&quot;</span>,<br>    <span class="hljs-string">&quot;instock&quot;</span> : [ <br>        &#123;<br>            <span class="hljs-string">&quot;warehouse&quot;</span> : <span class="hljs-string">&quot;C&quot;</span>,<br>            <span class="hljs-string">&quot;qty&quot;</span> : <span class="hljs-number">5.0</span><br>        &#125;<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="数组中的嵌套文档多条件匹配"><a class="markdownIt-Anchor" href="#数组中的嵌套文档多条件匹配"></a> 数组中的嵌套文档多条件匹配</h4><p><strong>单个嵌套文档中的字段满足多个查询条件</strong></p><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/query/elemMatch/#mongodb-query-op.-elemMatch">$elemMatch</a> 操作符为数组中的嵌套文档指定多个查询条件，<span class="green-line">最少一个嵌套文档同时满足所有的查询条件</span></p><p>查询数组中的嵌套文档，至少有一个嵌套文档满足 <code>qty</code> 小于等于5，并且 <code>warehouse</code> 为A的文档数据</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">find</span>(<span class="hljs-params"></span><br><span class="hljs-params">    &#123;</span><br><span class="hljs-params">        instock: &#123;</span><br><span class="hljs-params">            $elemMatch: &#123;</span><br><span class="hljs-params">                qty: &#123;</span><br><span class="hljs-params">                    $lte: <span class="hljs-number">5</span></span><br><span class="hljs-params">                &#125;,</span><br><span class="hljs-params">                warehouse: <span class="hljs-string">&quot;A&quot;</span></span><br><span class="hljs-params">            &#125;</span><br><span class="hljs-params">        &#125;</span><br><span class="hljs-params">    &#125;</span><br><span class="hljs-params"></span>)<br><br><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;644628c7f6e1b1a011924011&quot;</span>),<br>    <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;journal&quot;</span>,<br>    <span class="hljs-string">&quot;instock&quot;</span> : [ <br>        &#123;<br>            <span class="hljs-string">&quot;warehouse&quot;</span> : <span class="hljs-string">&quot;A&quot;</span>,<br>            <span class="hljs-string">&quot;qty&quot;</span> : <span class="hljs-number">5.0</span><br>        &#125;, <br>        &#123;<br>            <span class="hljs-string">&quot;warehouse&quot;</span> : <span class="hljs-string">&quot;C&quot;</span>,<br>            <span class="hljs-string">&quot;qty&quot;</span> : <span class="hljs-number">15.0</span><br>        &#125;<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>多个元素联合满足查询条件</strong></p><p>如果数组字段上的联合查询条件没有使用 <code>$elemMatch</code> 运算符，查询返回数组字段中多个元素联合满足所有的查询条件的所有文档</p><p><span class="green-line">换言之，如果不使用 <code>$elemMatch</code> 运算符，那么对数组文档的查询的多个条件是 <code>or</code> 关系</span></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">find</span>(<span class="hljs-params"></span><br><span class="hljs-params">    &#123;</span><br><span class="hljs-params">        <span class="hljs-string">&quot;instock.qty&quot;</span>: <span class="hljs-number">5</span>,</span><br><span class="hljs-params">        <span class="hljs-string">&quot;instock.warehouse&quot;</span>: <span class="hljs-string">&quot;A&quot;</span></span><br><span class="hljs-params">    &#125;</span><br><span class="hljs-params"></span>)<br><br><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;644628c7f6e1b1a011924011&quot;</span>),<br>    <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;journal&quot;</span>,<br>    <span class="hljs-string">&quot;instock&quot;</span> : [ <br>        &#123;<br>            <span class="hljs-string">&quot;warehouse&quot;</span> : <span class="hljs-string">&quot;A&quot;</span>,<br>            <span class="hljs-string">&quot;qty&quot;</span> : <span class="hljs-number">5.0</span><br>        &#125;, <br>        &#123;<br>            <span class="hljs-string">&quot;warehouse&quot;</span> : <span class="hljs-string">&quot;C&quot;</span>,<br>            <span class="hljs-string">&quot;qty&quot;</span> : <span class="hljs-number">15.0</span><br>        &#125;<br>    ]<br>&#125;<br><br><span class="hljs-comment">/* 2 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;644628c7f6e1b1a011924014&quot;</span>),<br>    <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;planner&quot;</span>,<br>    <span class="hljs-string">&quot;instock&quot;</span> : [ <br>        &#123;<br>            <span class="hljs-string">&quot;warehouse&quot;</span> : <span class="hljs-string">&quot;A&quot;</span>,<br>            <span class="hljs-string">&quot;qty&quot;</span> : <span class="hljs-number">40.0</span><br>        &#125;, <br>        &#123;<br>            <span class="hljs-string">&quot;warehouse&quot;</span> : <span class="hljs-string">&quot;B&quot;</span>,<br>            <span class="hljs-string">&quot;qty&quot;</span> : <span class="hljs-number">5.0</span><br>        &#125;<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure><p>在这个查询中，只要数组中的多个文档组合起来，满足所有查询条件即可</p><h3 id="数组查询"><a class="markdownIt-Anchor" href="#数组查询"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/tutorial/query-arrays/">数组查询</a></h3><p class="note note-primary">测试数据</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">insertMany</span>([<br>   &#123; <span class="hljs-attr">item</span>: <span class="hljs-string">&quot;journal&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">25</span>, <span class="hljs-attr">tags</span>: [<span class="hljs-string">&quot;blank&quot;</span>, <span class="hljs-string">&quot;red&quot;</span>], <span class="hljs-attr">dim_cm</span>: [ <span class="hljs-number">14</span>, <span class="hljs-number">21</span> ] &#125;,<br>   &#123; <span class="hljs-attr">item</span>: <span class="hljs-string">&quot;notebook&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">50</span>, <span class="hljs-attr">tags</span>: [<span class="hljs-string">&quot;red&quot;</span>, <span class="hljs-string">&quot;blank&quot;</span>], <span class="hljs-attr">dim_cm</span>: [ <span class="hljs-number">14</span>, <span class="hljs-number">21</span> ] &#125;,<br>   &#123; <span class="hljs-attr">item</span>: <span class="hljs-string">&quot;paper&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">100</span>, <span class="hljs-attr">tags</span>: [<span class="hljs-string">&quot;red&quot;</span>, <span class="hljs-string">&quot;blank&quot;</span>, <span class="hljs-string">&quot;plain&quot;</span>], <span class="hljs-attr">dim_cm</span>: [ <span class="hljs-number">14</span>, <span class="hljs-number">21</span> ] &#125;,<br>   &#123; <span class="hljs-attr">item</span>: <span class="hljs-string">&quot;planner&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">75</span>, <span class="hljs-attr">tags</span>: [<span class="hljs-string">&quot;blank&quot;</span>, <span class="hljs-string">&quot;red&quot;</span>], <span class="hljs-attr">dim_cm</span>: [ <span class="hljs-number">22.85</span>, <span class="hljs-number">30</span> ] &#125;,<br>   &#123; <span class="hljs-attr">item</span>: <span class="hljs-string">&quot;postcard&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">45</span>, <span class="hljs-attr">tags</span>: [<span class="hljs-string">&quot;blue&quot;</span>], <span class="hljs-attr">dim_cm</span>: [ <span class="hljs-number">10</span>, <span class="hljs-number">15.25</span> ] &#125;<br>]);<br></code></pre></td></tr></table></figure><h4 id="数组字段等值查询"><a class="markdownIt-Anchor" href="#数组字段等值查询"></a> 数组字段等值查询</h4><p>数组字段做等值查询的时候，使用查询文档 <code>&#123; &lt;field&gt;: &lt;value&gt; &#125;</code> ，其中 <code>&lt;value&gt;</code> 是要精确匹配的数组，包括元素的顺序</p><p>下面的查询返回 <code>inventory</code> 集合中数组字段 <code>tags</code> 值是只包含两个元素 <code>&quot;red&quot;</code> 和 <code>&quot;blank&quot;</code> 并且按照指定顺序的数组的所有文档</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">find</span>(<span class="hljs-params"></span><br><span class="hljs-params">    &#123;</span><br><span class="hljs-params">        <span class="hljs-string">&quot;tags&quot;</span>: [<span class="hljs-string">&quot;red&quot;</span>, <span class="hljs-string">&quot;blank&quot;</span>]</span><br><span class="hljs-params">    &#125;</span><br><span class="hljs-params"></span>)<br><br><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;644646dcf6e1b1a011924017&quot;</span>),<br>    <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;notebook&quot;</span>,<br>    <span class="hljs-string">&quot;qty&quot;</span> : <span class="hljs-number">50.0</span>,<br>    <span class="hljs-string">&quot;tags&quot;</span> : [ <br>        <span class="hljs-string">&quot;red&quot;</span>, <br>        <span class="hljs-string">&quot;blank&quot;</span><br>    ],<br>    <span class="hljs-string">&quot;dim_cm&quot;</span> : [ <br>        <span class="hljs-number">14.0</span>, <br>        <span class="hljs-number">21.0</span><br>    ]<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="数组字段包含查询"><a class="markdownIt-Anchor" href="#数组字段包含查询"></a> 数组字段包含查询</h4><p>如果想检索数组中包含 <code>red</code>和 <code>blank</code>两个元素并且<span class="green-line">不在乎元素顺序或者数组中是否有其它元素</span>。可以使用 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/query/all/#mongodb-query-op.-all"><code>$all</code></a> 操作符</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">find</span>(<br>    &#123;<br>        <span class="hljs-attr">tags</span>: &#123;<br>            <span class="hljs-attr">$all</span>: [<span class="hljs-string">&quot;red&quot;</span>, <span class="hljs-string">&quot;blank&quot;</span>]<br>        &#125;<br>    &#125;<br>)<br><br><br><span class="hljs-comment">/* 1 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;644646dcf6e1b1a011924016&quot;</span>),<br>    <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;journal&quot;</span>,<br>    <span class="hljs-string">&quot;qty&quot;</span> : <span class="hljs-number">25.0</span>,<br>    <span class="hljs-string">&quot;tags&quot;</span> : [ <br>        <span class="hljs-string">&quot;blank&quot;</span>, <br>        <span class="hljs-string">&quot;red&quot;</span><br>    ],<br>    <span class="hljs-string">&quot;dim_cm&quot;</span> : [ <br>        <span class="hljs-number">14.0</span>, <br>        <span class="hljs-number">21.0</span><br>    ]<br>&#125;<br><br><span class="hljs-comment">/* 2 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;644646dcf6e1b1a011924017&quot;</span>),<br>    <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;notebook&quot;</span>,<br>    <span class="hljs-string">&quot;qty&quot;</span> : <span class="hljs-number">50.0</span>,<br>    <span class="hljs-string">&quot;tags&quot;</span> : [ <br>        <span class="hljs-string">&quot;red&quot;</span>, <br>        <span class="hljs-string">&quot;blank&quot;</span><br>    ],<br>    <span class="hljs-string">&quot;dim_cm&quot;</span> : [ <br>        <span class="hljs-number">14.0</span>, <br>        <span class="hljs-number">21.0</span><br>    ]<br>&#125;<br><br><span class="hljs-comment">/* 3 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;644646dcf6e1b1a011924018&quot;</span>),<br>    <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;paper&quot;</span>,<br>    <span class="hljs-string">&quot;qty&quot;</span> : <span class="hljs-number">100.0</span>,<br>    <span class="hljs-string">&quot;tags&quot;</span> : [ <br>        <span class="hljs-string">&quot;red&quot;</span>, <br>        <span class="hljs-string">&quot;blank&quot;</span>, <br>        <span class="hljs-string">&quot;plain&quot;</span><br>    ],<br>    <span class="hljs-string">&quot;dim_cm&quot;</span> : [ <br>        <span class="hljs-number">14.0</span>, <br>        <span class="hljs-number">21.0</span><br>    ]<br>&#125;<br><br><span class="hljs-comment">/* 4 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;644646dcf6e1b1a011924019&quot;</span>),<br>    <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;planner&quot;</span>,<br>    <span class="hljs-string">&quot;qty&quot;</span> : <span class="hljs-number">75.0</span>,<br>    <span class="hljs-string">&quot;tags&quot;</span> : [ <br>        <span class="hljs-string">&quot;blank&quot;</span>, <br>        <span class="hljs-string">&quot;red&quot;</span><br>    ],<br>    <span class="hljs-string">&quot;dim_cm&quot;</span> : [ <br>        <span class="hljs-number">22.85</span>, <br>        <span class="hljs-number">30.0</span><br>    ]<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="查询数组字段中的元素"><a class="markdownIt-Anchor" href="#查询数组字段中的元素"></a> 查询数组字段中的元素</h4><p>要查询数组字段是否包含至少一个具有指定值的元素，请使用过滤器 <code>&#123; &lt;field&gt;: &lt;value&gt; &#125;</code> ，其中 <code>&lt;value&gt;</code> 是元素值</p><p>下面的查询是对 <code>tags</code> 数组元素进行查询，要求数组至少包含一个 <code>red</code> 元素</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">find</span>(<br>    &#123;<br>        <span class="hljs-attr">tags</span>: <span class="hljs-string">&quot;red&quot;</span><br>    &#125;<br>)<br><br><br><span class="hljs-comment">/* 1 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;644646dcf6e1b1a011924016&quot;</span>),<br>    <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;journal&quot;</span>,<br>    <span class="hljs-string">&quot;qty&quot;</span> : <span class="hljs-number">25.0</span>,<br>    <span class="hljs-string">&quot;tags&quot;</span> : [ <br>        <span class="hljs-string">&quot;blank&quot;</span>, <br>        <span class="hljs-string">&quot;red&quot;</span><br>    ],<br>    <span class="hljs-string">&quot;dim_cm&quot;</span> : [ <br>        <span class="hljs-number">14.0</span>, <br>        <span class="hljs-number">21.0</span><br>    ]<br>&#125;<br><br><span class="hljs-comment">/* 2 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;644646dcf6e1b1a011924017&quot;</span>),<br>    <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;notebook&quot;</span>,<br>    <span class="hljs-string">&quot;qty&quot;</span> : <span class="hljs-number">50.0</span>,<br>    <span class="hljs-string">&quot;tags&quot;</span> : [ <br>        <span class="hljs-string">&quot;red&quot;</span>, <br>        <span class="hljs-string">&quot;blank&quot;</span><br>    ],<br>    <span class="hljs-string">&quot;dim_cm&quot;</span> : [ <br>        <span class="hljs-number">14.0</span>, <br>        <span class="hljs-number">21.0</span><br>    ]<br>&#125;<br><br><span class="hljs-comment">/* 3 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;644646dcf6e1b1a011924018&quot;</span>),<br>    <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;paper&quot;</span>,<br>    <span class="hljs-string">&quot;qty&quot;</span> : <span class="hljs-number">100.0</span>,<br>    <span class="hljs-string">&quot;tags&quot;</span> : [ <br>        <span class="hljs-string">&quot;red&quot;</span>, <br>        <span class="hljs-string">&quot;blank&quot;</span>, <br>        <span class="hljs-string">&quot;plain&quot;</span><br>    ],<br>    <span class="hljs-string">&quot;dim_cm&quot;</span> : [ <br>        <span class="hljs-number">14.0</span>, <br>        <span class="hljs-number">21.0</span><br>    ]<br>&#125;<br><br><span class="hljs-comment">/* 4 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;644646dcf6e1b1a011924019&quot;</span>),<br>    <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;planner&quot;</span>,<br>    <span class="hljs-string">&quot;qty&quot;</span> : <span class="hljs-number">75.0</span>,<br>    <span class="hljs-string">&quot;tags&quot;</span> : [ <br>        <span class="hljs-string">&quot;blank&quot;</span>, <br>        <span class="hljs-string">&quot;red&quot;</span><br>    ],<br>    <span class="hljs-string">&quot;dim_cm&quot;</span> : [ <br>        <span class="hljs-number">22.85</span>, <br>        <span class="hljs-number">30.0</span><br>    ]<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>在对数组元素进行查询时，可以使用 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/query/#std-label-query-selectors">查询操作符</a></strong></p><p>下面的查询是查询数组 <code>dim_cm</code> 包含至少一个值大于 <code>25</code> 的元素的所有文档</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">find</span>(<span class="hljs-params"></span><br><span class="hljs-params">    &#123;</span><br><span class="hljs-params">        dim_cm: &#123;</span><br><span class="hljs-params">            $gt: <span class="hljs-number">25</span></span><br><span class="hljs-params">        &#125;</span><br><span class="hljs-params">    &#125;</span><br><span class="hljs-params"></span>)<br><br><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;644646dcf6e1b1a011924019&quot;</span>),<br>    <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;planner&quot;</span>,<br>    <span class="hljs-string">&quot;qty&quot;</span> : <span class="hljs-number">75.0</span>,<br>    <span class="hljs-string">&quot;tags&quot;</span> : [ <br>        <span class="hljs-string">&quot;blank&quot;</span>, <br>        <span class="hljs-string">&quot;red&quot;</span><br>    ],<br>    <span class="hljs-string">&quot;dim_cm&quot;</span> : [ <br>        <span class="hljs-number">22.85</span>, <br>        <span class="hljs-number">30.0</span><br>    ]<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="多条件查询数组中的元素"><a class="markdownIt-Anchor" href="#多条件查询数组中的元素"></a> 多条件查询数组中的元素</h4><p>使用多条件查询数组中的元素时，可以在查询语句中指定单个数组元素满足所有查询条件还是多个数组中的元素联合满足所有条件</p><p><strong>使用多条件查询数组中的元素</strong></p><p>下面对 <code>dim_cm</code> 数组的查询，一个元素可以满足大于 <code>15</code> 的条件，而另一个元素可以满足小于 <code>20</code> 的条件，或者一个元素可以 <code>同时满足</code> 这两个条件，<span class="green-line">条件之间是 <code>OR</code> 关系</span></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">find</span>(<br>    &#123;<br>        <span class="hljs-attr">dim_cm</span>: &#123;<br>            <span class="hljs-attr">$gt</span>: <span class="hljs-number">15</span>,<br>            <span class="hljs-attr">$lt</span>: <span class="hljs-number">20</span><br>        &#125;<br>    &#125;<br>)<br><br><br><span class="hljs-comment">/* 1 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;644646dcf6e1b1a011924016&quot;</span>),<br>    <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;journal&quot;</span>,<br>    <span class="hljs-string">&quot;qty&quot;</span> : <span class="hljs-number">25.0</span>,<br>    <span class="hljs-string">&quot;tags&quot;</span> : [ <br>        <span class="hljs-string">&quot;blank&quot;</span>, <br>        <span class="hljs-string">&quot;red&quot;</span><br>    ],<br>    <span class="hljs-string">&quot;dim_cm&quot;</span> : [ <br>        <span class="hljs-number">14.0</span>, <br>        <span class="hljs-number">21.0</span><br>    ]<br>&#125;<br><br><span class="hljs-comment">/* 2 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;644646dcf6e1b1a011924017&quot;</span>),<br>    <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;notebook&quot;</span>,<br>    <span class="hljs-string">&quot;qty&quot;</span> : <span class="hljs-number">50.0</span>,<br>    <span class="hljs-string">&quot;tags&quot;</span> : [ <br>        <span class="hljs-string">&quot;red&quot;</span>, <br>        <span class="hljs-string">&quot;blank&quot;</span><br>    ],<br>    <span class="hljs-string">&quot;dim_cm&quot;</span> : [ <br>        <span class="hljs-number">14.0</span>, <br>        <span class="hljs-number">21.0</span><br>    ]<br>&#125;<br><br><span class="hljs-comment">/* 3 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;644646dcf6e1b1a011924018&quot;</span>),<br>    <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;paper&quot;</span>,<br>    <span class="hljs-string">&quot;qty&quot;</span> : <span class="hljs-number">100.0</span>,<br>    <span class="hljs-string">&quot;tags&quot;</span> : [ <br>        <span class="hljs-string">&quot;red&quot;</span>, <br>        <span class="hljs-string">&quot;blank&quot;</span>, <br>        <span class="hljs-string">&quot;plain&quot;</span><br>    ],<br>    <span class="hljs-string">&quot;dim_cm&quot;</span> : [ <br>        <span class="hljs-number">14.0</span>, <br>        <span class="hljs-number">21.0</span><br>    ]<br>&#125;<br><br><span class="hljs-comment">/* 4 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;644646dcf6e1b1a01192401a&quot;</span>),<br>    <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;postcard&quot;</span>,<br>    <span class="hljs-string">&quot;qty&quot;</span> : <span class="hljs-number">45.0</span>,<br>    <span class="hljs-string">&quot;tags&quot;</span> : [ <br>        <span class="hljs-string">&quot;blue&quot;</span><br>    ],<br>    <span class="hljs-string">&quot;dim_cm&quot;</span> : [ <br>        <span class="hljs-number">10.0</span>, <br>        <span class="hljs-number">15.25</span><br>    ]<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>数组中的一个元素同时满足多个查询条件</strong></p><p>使用 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/query/elemMatch/#mongodb-query-op.-elemMatch"><code>$elemMatch</code></a> 运算符来指定多个查询条件在数组中的元素上，数组中最少一个元素同时满足所有的查询条件</p><p>下面的查询返回数组字段 <code>dim_cm</code> 中最少一个元素同时满足大于 <code>22</code> 和 小于 <code>30</code>，<span class="green-line">条件之间是 <code>AND</code> 关系</span></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">find</span>(<br>    &#123;<br>        <span class="hljs-attr">dim_cm</span>: &#123;<br>            <span class="hljs-attr">$elemMatch</span>: &#123;<br>                <span class="hljs-attr">$gt</span>: <span class="hljs-number">22</span>,<br>                <span class="hljs-attr">$lt</span>: <span class="hljs-number">30</span><br>            &#125;<br>        &#125;<br>    &#125;<br>)<br><br><br><span class="hljs-comment">/* 1 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;644646dcf6e1b1a011924019&quot;</span>),<br>    <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;planner&quot;</span>,<br>    <span class="hljs-string">&quot;qty&quot;</span> : <span class="hljs-number">75.0</span>,<br>    <span class="hljs-string">&quot;tags&quot;</span> : [ <br>        <span class="hljs-string">&quot;blank&quot;</span>, <br>        <span class="hljs-string">&quot;red&quot;</span><br>    ],<br>    <span class="hljs-string">&quot;dim_cm&quot;</span> : [ <br>        <span class="hljs-number">22.85</span>, <br>        <span class="hljs-number">30.0</span><br>    ]<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="数组下标查询"><a class="markdownIt-Anchor" href="#数组下标查询"></a> 数组下标查询</h4><p>使用 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/glossary/#std-term-dot-notation">点号</a>，可以为数组中指定下标的元素指定查询条件，数组下标从0开始</p><p>下面的查询返回数组字段 <code>dim_cm</code> 中第二个元素大于 <code>25</code> 的所有文档</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">find</span>(<br>    &#123;<br>        <span class="hljs-string">&quot;dim_cm.1&quot;</span>: &#123;<br>            <span class="hljs-attr">$gt</span>: <span class="hljs-number">25</span><br>         &#125;<br>    &#125;<br>)<br><br><br><span class="hljs-comment">/* 1 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;644646dcf6e1b1a011924019&quot;</span>),<br>    <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;planner&quot;</span>,<br>    <span class="hljs-string">&quot;qty&quot;</span> : <span class="hljs-number">75.0</span>,<br>    <span class="hljs-string">&quot;tags&quot;</span> : [ <br>        <span class="hljs-string">&quot;blank&quot;</span>, <br>        <span class="hljs-string">&quot;red&quot;</span><br>    ],<br>    <span class="hljs-string">&quot;dim_cm&quot;</span> : [ <br>        <span class="hljs-number">22.85</span>, <br>        <span class="hljs-number">30.0</span><br>    ]<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="数组长度查询"><a class="markdownIt-Anchor" href="#数组长度查询"></a> 数组长度查询</h4><p>使用 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/query/size/#mongodb-query-op.-size"><code>$size</code></a> 操作符通过数组中的元素个数来进行检索</p><p>下面的查询返回数组字段 <code>tags</code> 中有三个元素的所有文档</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">find</span>(<br>    &#123;<br>        <span class="hljs-string">&quot;tags&quot;</span>: &#123;<br>            <span class="hljs-attr">$size</span>: <span class="hljs-number">3</span><br>         &#125;<br>    &#125;<br>)<br><br><br><span class="hljs-comment">/* 1 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;644646dcf6e1b1a011924018&quot;</span>),<br>    <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;paper&quot;</span>,<br>    <span class="hljs-string">&quot;qty&quot;</span> : <span class="hljs-number">100.0</span>,<br>    <span class="hljs-string">&quot;tags&quot;</span> : [ <br>        <span class="hljs-string">&quot;red&quot;</span>, <br>        <span class="hljs-string">&quot;blank&quot;</span>, <br>        <span class="hljs-string">&quot;plain&quot;</span><br>    ],<br>    <span class="hljs-string">&quot;dim_cm&quot;</span> : [ <br>        <span class="hljs-number">14.0</span>, <br>        <span class="hljs-number">21.0</span><br>    ]<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="从查询中返回文档字段"><a class="markdownIt-Anchor" href="#从查询中返回文档字段"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/tutorial/project-fields-from-query-results/">从查询中返回文档字段</a></h3><p>默认情况下，MongoDB的查询语句返回匹配到文档的所有字段，为了限制MongoDB返回给应用的数据，可以通过 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/glossary/#std-term-projection">projection</a> (投影文档)来指定或限制返回的字段</p><p class="note note-primary">测试数据</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">insertMany</span>( [<br>  &#123; <span class="hljs-attr">item</span>: <span class="hljs-string">&quot;journal&quot;</span>, <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-attr">size</span>: &#123; <span class="hljs-attr">h</span>: <span class="hljs-number">14</span>, <span class="hljs-attr">w</span>: <span class="hljs-number">21</span>, <span class="hljs-attr">uom</span>: <span class="hljs-string">&quot;cm&quot;</span> &#125;, <span class="hljs-attr">instock</span>: [ &#123; <span class="hljs-attr">warehouse</span>: <span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">5</span> &#125; ] &#125;,<br>  &#123; <span class="hljs-attr">item</span>: <span class="hljs-string">&quot;notebook&quot;</span>, <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;A&quot;</span>,  <span class="hljs-attr">size</span>: &#123; <span class="hljs-attr">h</span>: <span class="hljs-number">8.5</span>, <span class="hljs-attr">w</span>: <span class="hljs-number">11</span>, <span class="hljs-attr">uom</span>: <span class="hljs-string">&quot;in&quot;</span> &#125;, <span class="hljs-attr">instock</span>: [ &#123; <span class="hljs-attr">warehouse</span>: <span class="hljs-string">&quot;C&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">5</span> &#125; ] &#125;,<br>  &#123; <span class="hljs-attr">item</span>: <span class="hljs-string">&quot;paper&quot;</span>, <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;D&quot;</span>, <span class="hljs-attr">size</span>: &#123; <span class="hljs-attr">h</span>: <span class="hljs-number">8.5</span>, <span class="hljs-attr">w</span>: <span class="hljs-number">11</span>, <span class="hljs-attr">uom</span>: <span class="hljs-string">&quot;in&quot;</span> &#125;, <span class="hljs-attr">instock</span>: [ &#123; <span class="hljs-attr">warehouse</span>: <span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">60</span> &#125; ] &#125;,<br>  &#123; <span class="hljs-attr">item</span>: <span class="hljs-string">&quot;planner&quot;</span>, <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;D&quot;</span>, <span class="hljs-attr">size</span>: &#123; <span class="hljs-attr">h</span>: <span class="hljs-number">22.85</span>, <span class="hljs-attr">w</span>: <span class="hljs-number">30</span>, <span class="hljs-attr">uom</span>: <span class="hljs-string">&quot;cm&quot;</span> &#125;, <span class="hljs-attr">instock</span>: [ &#123; <span class="hljs-attr">warehouse</span>: <span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">40</span> &#125; ] &#125;,<br>  &#123; <span class="hljs-attr">item</span>: <span class="hljs-string">&quot;postcard&quot;</span>, <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-attr">size</span>: &#123; <span class="hljs-attr">h</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">w</span>: <span class="hljs-number">15.25</span>, <span class="hljs-attr">uom</span>: <span class="hljs-string">&quot;cm&quot;</span> &#125;, <span class="hljs-attr">instock</span>: [ &#123; <span class="hljs-attr">warehouse</span>: <span class="hljs-string">&quot;B&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">15</span> &#125;, &#123; <span class="hljs-attr">warehouse</span>: <span class="hljs-string">&quot;C&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">35</span> &#125; ] &#125;<br>]);<br></code></pre></td></tr></table></figure><p class="note note-primary">返回指定的字段</p><p>通过 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/glossary/#std-term-projection">projection</a> 指定或排除返回字段后，<code>_id</code> 默认是返回的。如果不需要 <code>_id</code> 字段，需要显式指定</p><ul><li>1或true：表示要返回的字段</li><li>0或false：表示不返回的字段</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">find</span>(<br>    &#123;<br>        <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;A&quot;</span><br>    &#125;,<br>    &#123;<br>        <span class="hljs-attr">item</span>: <span class="hljs-number">1</span>,<br>        <span class="hljs-attr">status</span>: <span class="hljs-number">1</span><br>    &#125;<br>)<br><br><br><span class="hljs-comment">/* 1 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;64466a70f6e1b1a01192401b&quot;</span>),<br>    <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;journal&quot;</span>,<br>    <span class="hljs-string">&quot;status&quot;</span> : <span class="hljs-string">&quot;A&quot;</span><br>&#125;<br><br><span class="hljs-comment">/* 2 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;64466a70f6e1b1a01192401c&quot;</span>),<br>    <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;notebook&quot;</span>,<br>    <span class="hljs-string">&quot;status&quot;</span> : <span class="hljs-string">&quot;A&quot;</span><br>&#125;<br><br><span class="hljs-comment">/* 3 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;64466a70f6e1b1a01192401f&quot;</span>),<br>    <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;postcard&quot;</span>,<br>    <span class="hljs-string">&quot;status&quot;</span> : <span class="hljs-string">&quot;A&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>上面的操作等价于SQL的</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> _id, item, status <span class="hljs-keyword">from</span> inventory <span class="hljs-keyword">WHERE</span> status <span class="hljs-operator">=</span> &quot;A&quot;<br></code></pre></td></tr></table></figure><p class="note note-primary">去除_id字段</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-title function_">getCollection</span>(<span class="hljs-string">&#x27;inventory&#x27;</span>).<span class="hljs-title function_">find</span>(<br>    &#123;<br>        <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;A&quot;</span><br>    &#125;,<br>    &#123;<br>        <span class="hljs-attr">item</span>: <span class="hljs-number">1</span>,<br>        <span class="hljs-attr">status</span>: <span class="hljs-number">1</span>,<br>        <span class="hljs-attr">_id</span>: <span class="hljs-number">0</span><br>    &#125;<br>)<br><br><br><span class="hljs-comment">/* 1 */</span><br>&#123;<br>    <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;journal&quot;</span>,<br>    <span class="hljs-string">&quot;status&quot;</span> : <span class="hljs-string">&quot;A&quot;</span><br>&#125;<br><br><span class="hljs-comment">/* 2 */</span><br>&#123;<br>    <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;notebook&quot;</span>,<br>    <span class="hljs-string">&quot;status&quot;</span> : <span class="hljs-string">&quot;A&quot;</span><br>&#125;<br><br><span class="hljs-comment">/* 3 */</span><br>&#123;<br>    <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;postcard&quot;</span>,<br>    <span class="hljs-string">&quot;status&quot;</span> : <span class="hljs-string">&quot;A&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p><strong>注意</strong></p><p>除 <code>_id</code> 字段外，不能在映射文档中同时使用 <code>包含</code> 和 <code>去除</code> 语句</p></blockquote><p class="note note-primary">去除指定字段</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-title function_">getCollection</span>(<span class="hljs-string">&#x27;inventory&#x27;</span>).<span class="hljs-title function_">find</span>(<br>    &#123;<br>        <span class="hljs-string">&quot;size.h&quot;</span>: <span class="hljs-number">10</span><br>    &#125;,<br>    &#123;<br>        <span class="hljs-attr">item</span>: <span class="hljs-number">0</span>,<br>        <span class="hljs-attr">instock</span>: <span class="hljs-number">0</span><br>    &#125;<br>)<br><br><br><span class="hljs-comment">/* 1 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;64466a70f6e1b1a01192401f&quot;</span>),<br>    <span class="hljs-string">&quot;status&quot;</span> : <span class="hljs-string">&quot;A&quot;</span>,<br>    <span class="hljs-string">&quot;size&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;h&quot;</span> : <span class="hljs-number">10.0</span>,<br>        <span class="hljs-string">&quot;w&quot;</span> : <span class="hljs-number">15.25</span>,<br>        <span class="hljs-string">&quot;uom&quot;</span> : <span class="hljs-string">&quot;cm&quot;</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p class="note note-primary">返回嵌套文档中的指定字段</p><p>通过 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/document/#std-label-document-dot-notation">点号</a> 引用嵌套文档字段并且在映射文档中将该字段设置为1来实现返回嵌套文档中的指定字段</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">find</span>(<br>   &#123; <br>       <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;A&quot;</span> <br>   &#125;,<br>   &#123; <br>       <span class="hljs-attr">item</span>: <span class="hljs-number">1</span>,<br>       <span class="hljs-attr">status</span>: <span class="hljs-number">1</span>,<br>       <span class="hljs-string">&quot;size.uom&quot;</span>: <span class="hljs-number">1</span> <br>    &#125;<br>)<br></code></pre></td></tr></table></figure><p class="note note-primary">去除嵌套文档中的指定字段</p><p>通过 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/document/#std-label-document-dot-notation">点号</a> 引用嵌套文档字段并且在映射文档中将该字段设置为0来实现去除嵌套文档中的指定字段</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">find</span>(<br>   &#123; <br>       <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;A&quot;</span> <br>   &#125;,<br>   &#123;<br>       <span class="hljs-string">&quot;size.uom&quot;</span>: <span class="hljs-number">0</span> <br>   &#125;<br>)<br></code></pre></td></tr></table></figure><p class="note note-primary">映射数组中的嵌套文档的指定字段</p><p>通过使用 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/document/#std-label-document-dot-notation">点号</a> 来映射数组中嵌套文档的指定字段</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">find</span>(<br>    &#123; <br>        <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;A&quot;</span><br>    &#125;,<br>    &#123; <br>        <span class="hljs-attr">item</span>: <span class="hljs-number">1</span>,<br>        <span class="hljs-attr">status</span>: <span class="hljs-number">1</span>,<br>        <span class="hljs-string">&quot;instock.qty&quot;</span>: <span class="hljs-number">1</span> <br>     &#125;<br>)<br></code></pre></td></tr></table></figure><p class="note note-primary">映射返回数组中指定的数组元素</p><p>对于数组字段，MongoDB 提供了以下用于操作数组的映射运算符: <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/projection/elemMatch/#mongodb-projection-proj.-elemMatch"><code>$elemMatch</code></a>、 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/projection/slice/#mongodb-projection-proj.-slice"><code>$slice</code></a>、 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/projection/positional/#mongodb-projection-proj.-"><code>$</code>.</a></p><p><strong><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/projection/elemMatch/#mongodb-projection-proj.-elemMatch"><code>$elemMatch</code></a></strong></p><p>在嵌套文档数组中，这个对象数组仅返回与 <code>$elemMatch</code> 匹配的 <code>第一个元素</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">find</span>(<br>    &#123;<br>        <span class="hljs-attr">item</span>: <span class="hljs-string">&quot;postcard&quot;</span><br>    &#125;,<br>    &#123;<br>        <span class="hljs-attr">instock</span>: &#123;<br>            <span class="hljs-attr">$elemMatch</span>: &#123;<br>                <span class="hljs-attr">qty</span>: <span class="hljs-number">35</span><br>            &#125;<br>        &#125;<br>    &#125;<br> )<br> <br> <br> <span class="hljs-comment">/* 1 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;64466a70f6e1b1a01192401f&quot;</span>),<br>    <span class="hljs-string">&quot;instock&quot;</span> : [ <br>        &#123;<br>            <span class="hljs-string">&quot;warehouse&quot;</span> : <span class="hljs-string">&quot;C&quot;</span>,<br>            <span class="hljs-string">&quot;qty&quot;</span> : <span class="hljs-number">35.0</span><br>        &#125;<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure><p><strong><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/projection/slice/#mongodb-projection-proj.-slice"><code>$slice</code></a></strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">collection</span>.<span class="hljs-title function_">find</span>(<br>   &lt;query&gt;,<br>   &#123; &lt;arrayField&gt;: &#123; <span class="hljs-attr">$slice</span>: &lt;number&gt; &#125; &#125;<br>);<br></code></pre></td></tr></table></figure><ul><li>number &gt;= 0：返回这个数组的 n 个元素</li><li>number &lt; 0：返回这个数组的最后一个元素</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">collection</span>.<span class="hljs-title function_">find</span>(<br>   &lt;query&gt;,<br>   &#123; &lt;arrayField&gt;: &#123; <span class="hljs-attr">$slice</span>: [ &lt;number&gt;, &lt;number&gt; ] &#125; &#125;<br>);<br></code></pre></td></tr></table></figure><ul><li><p>第一个参数类似 <code>offset</code></p></li><li><p>第二个参数类似 <code>limit</code></p></li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">find</span>(<br>    &#123;<br>        <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;A&quot;</span>,<br>        <span class="hljs-string">&quot;instock.qty&quot;</span>: <span class="hljs-number">35</span><br>    &#125;,<br>    &#123; <br>        <span class="hljs-attr">item</span>: <span class="hljs-number">1</span>,<br>        <span class="hljs-attr">status</span>: <span class="hljs-number">1</span>,<br>        <span class="hljs-attr">instock</span>: &#123;<br>            <span class="hljs-attr">$slice</span>: -<span class="hljs-number">1</span><br>        &#125; <br>    &#125;<br>)<br><br><br><span class="hljs-comment">/* 1 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;64466a70f6e1b1a01192401f&quot;</span>),<br>    <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;postcard&quot;</span>,<br>    <span class="hljs-string">&quot;status&quot;</span> : <span class="hljs-string">&quot;A&quot;</span>,<br>    <span class="hljs-string">&quot;instock&quot;</span> : [ <br>        &#123;<br>            <span class="hljs-string">&quot;warehouse&quot;</span> : <span class="hljs-string">&quot;C&quot;</span>,<br>            <span class="hljs-string">&quot;qty&quot;</span> : <span class="hljs-number">35.0</span><br>        &#125;<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure><p><strong><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/projection/positional/#mongodb-projection-proj.-"><code>$</code></a></strong></p><p><code>$</code> 运算符限制数组返回的内容以返回与数组中的查询条件匹配的 <code>第一个元素</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">find</span>(<br>    &#123;<br>        <span class="hljs-attr">instock</span>: &#123;<br>            <span class="hljs-attr">$elemMatch</span>: &#123;<br>                warehouse : <span class="hljs-string">&quot;C&quot;</span>,<br>                <span class="hljs-attr">qty</span>: <span class="hljs-number">35.0</span><br>            &#125;<br>        &#125;<br>    &#125;,<br>    &#123;<br>        <span class="hljs-string">&quot;instock.$&quot;</span>: <span class="hljs-number">1</span><br>    &#125;<br> )<br><br><br><span class="hljs-comment">/* 1 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;64466a70f6e1b1a01192401f&quot;</span>),<br>    <span class="hljs-string">&quot;instock&quot;</span> : [ <br>        &#123;<br>            <span class="hljs-string">&quot;warehouse&quot;</span> : <span class="hljs-string">&quot;C&quot;</span>,<br>            <span class="hljs-string">&quot;qty&quot;</span> : <span class="hljs-number">35.0</span><br>        &#125;<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="查询空字段或缺失字段"><a class="markdownIt-Anchor" href="#查询空字段或缺失字段"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/tutorial/query-for-null-fields/">查询空字段或缺失字段</a></h3><p>在MongoDB中不同的查询操作符对于 <code>null</code> 值处理方式不同</p><p class="note note-primary">测试数据</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">insertMany</span>([<br>   &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">item</span>: <span class="hljs-literal">null</span> &#125;,<br>   &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">2</span> &#125;<br>])<br></code></pre></td></tr></table></figure><p class="note note-primary">等值匹配</p><p>当使用 <code>&#123; item : null &#125;</code> 作为查询条件的时候，返回的是 <code>item</code> 字段值为 <code>null</code> 的文档或者 <code>不包含item</code> 字段的文档</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-title function_">getCollection</span>(<span class="hljs-string">&#x27;inventory&#x27;</span>).<span class="hljs-title function_">find</span>(<br>    &#123;<br>        <span class="hljs-attr">item</span>: <span class="hljs-literal">null</span><br>    &#125;<br>)<br><br><br><span class="hljs-comment">/* 1 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">1.0</span>,<br>    <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-literal">null</span><br>&#125;<br><br><span class="hljs-comment">/* 2 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">2.0</span><br>&#125;<br></code></pre></td></tr></table></figure><p class="note note-primary">类型检查</p><p>当使用 <code>&#123;item:&#123;$type:10&#125;&#125;</code> 作为查询条件的时候，仅返回 <code>item</code> 字段值为 <code>null</code> 的文档。<code>item</code> 字段的值是 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/bson-types/">BSON Type</a> Null(type number 10)</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-title function_">getCollection</span>(<span class="hljs-string">&#x27;inventory&#x27;</span>).<span class="hljs-title function_">find</span>(<br>    &#123;<br>        <span class="hljs-attr">item</span>: &#123;<br>            <span class="hljs-attr">$type</span>: <span class="hljs-number">10</span><br>        &#125;<br>    &#125;<br>)<br><br><br><span class="hljs-comment">/* 1 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">1.0</span>,<br>    <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-literal">null</span><br>&#125;<br></code></pre></td></tr></table></figure><p class="note note-primary">存在检查</p><p>当使用 <code>&#123;item:&#123;$exists:false&#125;&#125;</code> 作为查询条件的时候，返回不包含 <code>item</code> 字段的文档</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-title function_">getCollection</span>(<span class="hljs-string">&#x27;inventory&#x27;</span>).<span class="hljs-title function_">find</span>(<span class="hljs-params"></span><br><span class="hljs-params">    &#123;</span><br><span class="hljs-params">        item: &#123;</span><br><span class="hljs-params">            $exists: <span class="hljs-literal">false</span></span><br><span class="hljs-params">        &#125;</span><br><span class="hljs-params">    &#125;</span><br><span class="hljs-params"></span>)<br><br><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">2.0</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="在mongo-shell中迭代游标"><a class="markdownIt-Anchor" href="#在mongo-shell中迭代游标"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/tutorial/iterate-a-cursor/">在mongo Shell中迭代游标</a></h3><p><code>db.collection.find()</code> 方法返回一个游标。要访问文档，您需要迭代游标。 但是，在mongo shell中，如果未使用 <code>var</code> 关键字将返回的游标分配给变量，则该游标将自动迭代多达20次，以打印结果中的前20个文档 <em><strong>（查询默认返回前20个文档）</strong></em></p><p class="note note-primary">手动迭代游标</p><p>在 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/mongodb-shell/#mongodb-binary-bin.mongosh"><code>mongo Shell</code></a>中，当使用 <code>var</code> 关键字将<a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.find/#mongodb-method-db.collection.find"><code>find()</code></a> 方法返回的游标分配给变量时，游标不会自动进行迭代</p><p>您可以在shell程序中调用cursor变量以进行多达20次迭代并打印匹配的文档</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs javascript"> <span class="hljs-keyword">var</span> myCursor = db.<span class="hljs-property">user</span>.<span class="hljs-title function_">find</span>(&#123; <span class="hljs-attr">age</span>: &#123;<span class="hljs-attr">$gt</span>: <span class="hljs-number">30</span>&#125; &#125;);<br> <br> <span class="hljs-comment">// 迭代游标</span><br> myCursor<br> <br> <br> &#123;<br>	<span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;5e7835496b6f69d428000004&quot;</span>),<br>	<span class="hljs-string">&quot;name&quot;</span> : <span class="hljs-string">&quot;Dave&quot;</span>,<br>	<span class="hljs-string">&quot;age&quot;</span> : <span class="hljs-number">35</span>,<br>	<span class="hljs-string">&quot;address&quot;</span> : &#123;<br>		<span class="hljs-string">&quot;city&quot;</span> : <span class="hljs-string">&quot;San Francisco&quot;</span>,<br>		<span class="hljs-string">&quot;state&quot;</span> : <span class="hljs-string">&quot;CA&quot;</span>,<br>		<span class="hljs-string">&quot;zip&quot;</span> : <span class="hljs-string">&quot;94107&quot;</span><br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>您还可以使用游标方法 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/cursor.next/#mongodb-method-cursor.next"><code>next()</code></a> 来访问文档，作为一种替代的打印操作，请考虑使用<code>printjson()</code>辅助方法替换<code>print(tojson())</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> myCursor = db.<span class="hljs-property">user</span>.<span class="hljs-title function_">find</span>(&#123; <span class="hljs-attr">age</span>: &#123;<span class="hljs-attr">$gt</span>: <span class="hljs-number">30</span>&#125; &#125;);<br> <br> <span class="hljs-comment">// 迭代游标</span><br><span class="hljs-keyword">while</span>(myCursor.<span class="hljs-title function_">hasNext</span>()) &#123;<br>    <span class="hljs-title function_">printjson</span>(myCursor.<span class="hljs-title function_">next</span>())<br>&#125;<br><br><br>&#123;<br>	<span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;5e7835496b6f69d428000004&quot;</span>),<br>	<span class="hljs-string">&quot;name&quot;</span> : <span class="hljs-string">&quot;Dave&quot;</span>,<br>	<span class="hljs-string">&quot;age&quot;</span> : <span class="hljs-number">35</span>,<br>	<span class="hljs-string">&quot;address&quot;</span> : &#123;<br>		<span class="hljs-string">&quot;city&quot;</span> : <span class="hljs-string">&quot;San Francisco&quot;</span>,<br>		<span class="hljs-string">&quot;state&quot;</span> : <span class="hljs-string">&quot;CA&quot;</span>,<br>		<span class="hljs-string">&quot;zip&quot;</span> : <span class="hljs-string">&quot;94107&quot;</span><br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>您可以使用游标方法 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/cursor.forEach/#mongodb-method-cursor.forEach"><code>forEach()</code></a> 来迭代游标并访问文档</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> myCursor = db.<span class="hljs-property">user</span>.<span class="hljs-title function_">find</span>(&#123; <span class="hljs-attr">age</span>: &#123;<span class="hljs-attr">$gt</span>: <span class="hljs-number">30</span>&#125; &#125;);<br> <br> <span class="hljs-comment">// 迭代游标</span><br>myCursor.<span class="hljs-title function_">forEach</span>(printjson);<br><br><br>&#123;<br>	<span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;5e7835496b6f69d428000004&quot;</span>),<br>	<span class="hljs-string">&quot;name&quot;</span> : <span class="hljs-string">&quot;Dave&quot;</span>,<br>	<span class="hljs-string">&quot;age&quot;</span> : <span class="hljs-number">35</span>,<br>	<span class="hljs-string">&quot;address&quot;</span> : &#123;<br>		<span class="hljs-string">&quot;city&quot;</span> : <span class="hljs-string">&quot;San Francisco&quot;</span>,<br>		<span class="hljs-string">&quot;state&quot;</span> : <span class="hljs-string">&quot;CA&quot;</span>,<br>		<span class="hljs-string">&quot;zip&quot;</span> : <span class="hljs-string">&quot;94107&quot;</span><br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p class="note note-primary">迭代器索引</p><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/cursor.toArray/#mongodb-method-cursor.toArray"><code>toArray()</code></a> 方法将游标返回的所有文档加载到 <code>RAM</code> 中； <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/cursor.toArray/#mongodb-method-cursor.toArray"><code>toArray()</code></a> 方法会遍历游标</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> myCursor = db.<span class="hljs-property">user</span>.<span class="hljs-title function_">find</span>(&#123; <span class="hljs-attr">age</span>: &#123;<span class="hljs-attr">$gt</span>: <span class="hljs-number">30</span>&#125; &#125;);<br> <br><span class="hljs-comment">//  游标转为数组，数据放在内存中</span><br><span class="hljs-keyword">var</span> documentArray = myCursor.<span class="hljs-title function_">toArray</span>();<br><span class="hljs-keyword">var</span> <span class="hljs-variable language_">document</span> = documentArray[<span class="hljs-number">0</span>];<br><span class="hljs-title function_">printjson</span>(<span class="hljs-variable language_">document</span>);<br><br><br>&#123;<br>	<span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;5e7835496b6f69d428000004&quot;</span>),<br>	<span class="hljs-string">&quot;name&quot;</span> : <span class="hljs-string">&quot;Dave&quot;</span>,<br>	<span class="hljs-string">&quot;age&quot;</span> : <span class="hljs-number">35</span>,<br>	<span class="hljs-string">&quot;address&quot;</span> : &#123;<br>		<span class="hljs-string">&quot;city&quot;</span> : <span class="hljs-string">&quot;San Francisco&quot;</span>,<br>		<span class="hljs-string">&quot;state&quot;</span> : <span class="hljs-string">&quot;CA&quot;</span>,<br>		<span class="hljs-string">&quot;zip&quot;</span> : <span class="hljs-string">&quot;94107&quot;</span><br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>此外，一些驱动程序通过使用光标上的索引（即 <code>cursor[index]</code> ）提供对文档的访问。这是先调用 <code>toArray()</code> 方法然后在结果数组上使用索引的快捷方式</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> myCursor = db.<span class="hljs-property">user</span>.<span class="hljs-title function_">find</span>(&#123; <span class="hljs-attr">age</span>: &#123;<span class="hljs-attr">$gt</span>: <span class="hljs-number">30</span>&#125; &#125;);<br> <br><span class="hljs-comment">//  快捷方式</span><br><span class="hljs-keyword">var</span> <span class="hljs-variable language_">document</span> = myCursor[<span class="hljs-number">0</span>];<br><span class="hljs-title function_">printjson</span>(<span class="hljs-variable language_">document</span>);<br><br><br>&#123;<br>	<span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;5e7835496b6f69d428000004&quot;</span>),<br>	<span class="hljs-string">&quot;name&quot;</span> : <span class="hljs-string">&quot;Dave&quot;</span>,<br>	<span class="hljs-string">&quot;age&quot;</span> : <span class="hljs-number">35</span>,<br>	<span class="hljs-string">&quot;address&quot;</span> : &#123;<br>		<span class="hljs-string">&quot;city&quot;</span> : <span class="hljs-string">&quot;San Francisco&quot;</span>,<br>		<span class="hljs-string">&quot;state&quot;</span> : <span class="hljs-string">&quot;CA&quot;</span>,<br>		<span class="hljs-string">&quot;zip&quot;</span> : <span class="hljs-string">&quot;94107&quot;</span><br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="更新文档"><a class="markdownIt-Anchor" href="#更新文档"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/tutorial/update-documents/">更新文档</a></h2><p class="note note-primary">更新方法</p><table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.updateOne/#mongodb-method-db.collection.updateOne"><code>db.collection.updateOne(&lt;filter&gt;, &lt;update&gt;, &lt;options&gt;)</code></a></td><td>多个文档匹配，最多更新一个文档</td></tr><tr><td><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.updateMany/#mongodb-method-db.collection.updateMany"><code>db.collection.updateMany((&lt;filter&gt;, &lt;update&gt;, &lt;options&gt;)</code></a></td><td>更新匹配的所有文档</td></tr><tr><td><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.replaceOne/#mongodb-method-db.collection.replaceOne"><code>db.collection.replaceOne((&lt;filter&gt;, &lt;update&gt;, &lt;options&gt;)</code></a></td><td>多个文档匹配，最多替换一个文档</td></tr><tr><td><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.update/"><code>db.collection.update(query, update, options)</code></a>(已弃用)</td><td>更新一个或多个文档，具体操作取决于更新参数</td></tr></tbody></table><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.update/#std-label-update-parameter">更新参数</a></p><p><strong>附加方法</strong></p><table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.findOneAndReplace/#mongodb-method-db.collection.findOneAndReplace"><code>db.collection.findOneAndReplace( filter, replacement, options )</code></a></td><td>根据 <code>filter</code> 和 <code>sort</code> 条件修改和替换单个文档，然后返回一个文档（新或旧）</td></tr><tr><td><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.findOneAndUpdate/#mongodb-method-db.collection.findOneAndUpdate"><code>db.collection.findOneAndUpdate( filter, update, options )</code></a></td><td>根据 <code>filter</code> 和 <code>sort</code> 条件更新单个文档，然后返回一个文档（新或旧）</td></tr><tr><td><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.findAndModify/#mongodb-method-db.collection.findAndModify"><code>db.collection.findAndModify(document)</code></a></td><td><code>修改</code> 或 <code>删除</code> 并返回单个文档</td></tr><tr><td><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.bulkWrite/#mongodb-method-db.collection.bulkWrite"><code>db.collection.bulkWrite()</code></a></td><td>通过控制执行顺序执行多个写入操作</td></tr><tr><td><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v4.4/reference/method/db.collection.save/"><code>db.collection.save()</code></a></td><td>根据 <code>document</code> 参数更新现有文档或插入新文档<br>已过时，推荐 <code>replaceOne</code> 方法</td></tr></tbody></table><p class="note note-primary">测试数据</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">insertMany</span>( [<br>   &#123; <span class="hljs-attr">item</span>: <span class="hljs-string">&quot;canvas&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">100</span>, <span class="hljs-attr">size</span>: &#123; <span class="hljs-attr">h</span>: <span class="hljs-number">28</span>, <span class="hljs-attr">w</span>: <span class="hljs-number">35.5</span>, <span class="hljs-attr">uom</span>: <span class="hljs-string">&quot;cm&quot;</span> &#125;, <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;A&quot;</span> &#125;,<br>   &#123; <span class="hljs-attr">item</span>: <span class="hljs-string">&quot;journal&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">25</span>, <span class="hljs-attr">size</span>: &#123; <span class="hljs-attr">h</span>: <span class="hljs-number">14</span>, <span class="hljs-attr">w</span>: <span class="hljs-number">21</span>, <span class="hljs-attr">uom</span>: <span class="hljs-string">&quot;cm&quot;</span> &#125;, <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;A&quot;</span> &#125;,<br>   &#123; <span class="hljs-attr">item</span>: <span class="hljs-string">&quot;mat&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">85</span>, <span class="hljs-attr">size</span>: &#123; <span class="hljs-attr">h</span>: <span class="hljs-number">27.9</span>, <span class="hljs-attr">w</span>: <span class="hljs-number">35.5</span>, <span class="hljs-attr">uom</span>: <span class="hljs-string">&quot;cm&quot;</span> &#125;, <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;A&quot;</span> &#125;,<br>   &#123; <span class="hljs-attr">item</span>: <span class="hljs-string">&quot;mousepad&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">25</span>, <span class="hljs-attr">size</span>: &#123; <span class="hljs-attr">h</span>: <span class="hljs-number">19</span>, <span class="hljs-attr">w</span>: <span class="hljs-number">22.85</span>, <span class="hljs-attr">uom</span>: <span class="hljs-string">&quot;cm&quot;</span> &#125;, <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;P&quot;</span> &#125;,<br>   &#123; <span class="hljs-attr">item</span>: <span class="hljs-string">&quot;notebook&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">50</span>, <span class="hljs-attr">size</span>: &#123; <span class="hljs-attr">h</span>: <span class="hljs-number">8.5</span>, <span class="hljs-attr">w</span>: <span class="hljs-number">11</span>, <span class="hljs-attr">uom</span>: <span class="hljs-string">&quot;in&quot;</span> &#125;, <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;P&quot;</span> &#125;,<br>   &#123; <span class="hljs-attr">item</span>: <span class="hljs-string">&quot;paper&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">100</span>, <span class="hljs-attr">size</span>: &#123; <span class="hljs-attr">h</span>: <span class="hljs-number">8.5</span>, <span class="hljs-attr">w</span>: <span class="hljs-number">11</span>, <span class="hljs-attr">uom</span>: <span class="hljs-string">&quot;in&quot;</span> &#125;, <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;D&quot;</span> &#125;,<br>   &#123; <span class="hljs-attr">item</span>: <span class="hljs-string">&quot;planner&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">75</span>, <span class="hljs-attr">size</span>: &#123; <span class="hljs-attr">h</span>: <span class="hljs-number">22.85</span>, <span class="hljs-attr">w</span>: <span class="hljs-number">30</span>, <span class="hljs-attr">uom</span>: <span class="hljs-string">&quot;cm&quot;</span> &#125;, <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;D&quot;</span> &#125;,<br>   &#123; <span class="hljs-attr">item</span>: <span class="hljs-string">&quot;postcard&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">45</span>, <span class="hljs-attr">size</span>: &#123; <span class="hljs-attr">h</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">w</span>: <span class="hljs-number">15.25</span>, <span class="hljs-attr">uom</span>: <span class="hljs-string">&quot;cm&quot;</span> &#125;, <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;A&quot;</span> &#125;,<br>   &#123; <span class="hljs-attr">item</span>: <span class="hljs-string">&quot;sketchbook&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">80</span>, <span class="hljs-attr">size</span>: &#123; <span class="hljs-attr">h</span>: <span class="hljs-number">14</span>, <span class="hljs-attr">w</span>: <span class="hljs-number">21</span>, <span class="hljs-attr">uom</span>: <span class="hljs-string">&quot;cm&quot;</span> &#125;, <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;A&quot;</span> &#125;,<br>   &#123; <span class="hljs-attr">item</span>: <span class="hljs-string">&quot;sketch pad&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">95</span>, <span class="hljs-attr">size</span>: &#123; <span class="hljs-attr">h</span>: <span class="hljs-number">22.85</span>, <span class="hljs-attr">w</span>: <span class="hljs-number">30.5</span>, <span class="hljs-attr">uom</span>: <span class="hljs-string">&quot;cm&quot;</span> &#125;, <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;A&quot;</span> &#125;<br>] );<br></code></pre></td></tr></table></figure><p class="note note-primary">更新集合中的文档</p><p>为了更新文档，MongoDB 提供了 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/update/">更新运算符</a>，例如 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/update/set/#mongodb-update-up.-set"><code>$set</code></a>，来修改字段值</p><p>要使用更新运算符，请将以下形式的更新文档传递给更新方法：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs javascript">&#123;<br>  &lt;update operator&gt;: &#123; &lt;field1&gt;: &lt;value1&gt;, ... &#125;,<br>  &lt;update operator&gt;: &#123; &lt;field2&gt;: &lt;value2&gt;, ... &#125;,<br>  ...<br>&#125;<br></code></pre></td></tr></table></figure><p>如果字段不存在，则某些<a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/update/">更新操作符</a>（例如 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/update/set/#mongodb-update-up.-set"><code>$set</code></a>）将创建该字段</p><h4 id="更新运算符"><a class="markdownIt-Anchor" href="#更新运算符"></a> 更新运算符</h4><p><strong>字段</strong></p><table><thead><tr><th>名称</th><th>描述</th></tr></thead><tbody><tr><td><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/update/currentDate/#mongodb-update-up.-currentDate"><code>$currentDate</code></a></td><td>将字段的值设置为当前日期，即日期或时间戳。</td></tr><tr><td><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/update/inc/#mongodb-update-up.-inc"><code>$inc</code></a></td><td>将字段的值增加指定的数量。</td></tr><tr><td><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/update/min/#mongodb-update-up.-min"><code>$min</code></a></td><td>仅当指定值小于现有字段值时才更新该字段。</td></tr><tr><td><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/update/max/#mongodb-update-up.-max"><code>$max</code></a></td><td>仅当指定值大于现有字段值时才更新该字段。</td></tr><tr><td><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/update/mul/#mongodb-update-up.-mul"><code>$mul</code></a></td><td>将字段的值乘以指定的数量。</td></tr><tr><td><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/update/rename/#mongodb-update-up.-rename"><code>$rename</code></a></td><td>重命名字段。</td></tr><tr><td><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/update/set/#mongodb-update-up.-set"><code>$set</code></a></td><td>设置文档中字段的值。</td></tr><tr><td><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/update/setOnInsert/#mongodb-update-up.-setOnInsert"><code>$setOnInsert</code></a></td><td>如果更新导致插入文档，则设置字段的值。对修改现有文档的更新操作没有影响。</td></tr><tr><td><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/update/unset/#mongodb-update-up.-unset"><code>$unset</code></a></td><td>从文档中删除指定的字段。</td></tr></tbody></table><p><strong>数组</strong></p><table><thead><tr><th style="text-align:left">名称</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td style="text-align:left"><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/update/positional/#mongodb-update-up.-"><code>$</code></a></td><td style="text-align:left">充当更新查询文档的第一个匹配项（数组元素）的占位符。</td></tr><tr><td style="text-align:left"><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/update/positional-all/#mongodb-update-up.---"><code>$[]</code></a></td><td style="text-align:left">充当占位符，以更新匹配查询条件的文档的数组中的所有元素。</td></tr><tr><td style="text-align:left"><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/update/positional-filtered/#mongodb-update-up.---identifier--"><code>$[&lt;identifier&gt;]</code></a></td><td style="text-align:left">充当占位符，以更新<code>arrayFilters</code>与查询条件匹配的文档中所有与条件匹配的元素。</td></tr><tr><td style="text-align:left"><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/update/addToSet/#mongodb-update-up.-addToSet"><code>$addToSet</code></a></td><td style="text-align:left">仅当元素不存在于集合中时才将它们添加到数组中。</td></tr><tr><td style="text-align:left"><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/update/pop/#mongodb-update-up.-pop"><code>$pop</code></a></td><td style="text-align:left">删除数组的第一项或最后一项。</td></tr><tr><td style="text-align:left"><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/update/pull/#mongodb-update-up.-pull"><code>$pull</code></a></td><td style="text-align:left">删除与指定查询匹配的所有数组元素。</td></tr><tr><td style="text-align:left"><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/update/push/#mongodb-update-up.-push"><code>$push</code></a></td><td style="text-align:left">将项目添加到数组。</td></tr><tr><td style="text-align:left"><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/update/pullAll/#mongodb-update-up.-pullAll"><code>$pullAll</code></a></td><td style="text-align:left">从数组中删除所有匹配的值。</td></tr></tbody></table><p><strong>修饰符</strong></p><table><thead><tr><th style="text-align:left">名称</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td style="text-align:left"><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/update/each/#mongodb-update-up.-each"><code>$each</code></a></td><td style="text-align:left">修改<code>$push</code>和<code>$addToSet</code>运算符以附加多个项以进行数组更新。</td></tr><tr><td style="text-align:left"><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/update/position/#mongodb-update-up.-position"><code>$position</code></a></td><td style="text-align:left">修改<code>$push</code>运算符以指定要添加元素的数组中的位置。</td></tr><tr><td style="text-align:left"><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/update/slice/#mongodb-update-up.-slice"><code>$slice</code></a></td><td style="text-align:left">修改<code>$push</code>运算符以限制更新数组的大小。</td></tr><tr><td style="text-align:left"><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/update/sort/#mongodb-update-up.-sort"><code>$sort</code></a></td><td style="text-align:left">修改<code>$push</code>运算符以对存储在数组中的文档重新排序。</td></tr></tbody></table><p><strong>按位运算</strong></p><table><thead><tr><th style="text-align:left">名称</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td style="text-align:left"><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/update/bit/#mongodb-update-up.-bit"><code>$bit</code></a></td><td style="text-align:left">执行按位<code>AND</code>，<code>OR</code>和<code>XOR</code>整数值的更新。</td></tr></tbody></table><h4 id="updateone"><a class="markdownIt-Anchor" href="#updateone"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.updateOne/">updateOne</a></h4><p>查找与过滤器匹配的第一个文档，并应用指定的更新修改</p><p>语法</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs json">db.collection.updateOne(<br>   &lt;filter&gt;<span class="hljs-punctuation">,</span><br>   &lt;update&gt;<span class="hljs-punctuation">,</span><br>   <span class="hljs-punctuation">&#123;</span><br>     upsert<span class="hljs-punctuation">:</span> &lt;boolean&gt;<span class="hljs-punctuation">,</span><br>     writeConcern<span class="hljs-punctuation">:</span> &lt;document&gt;<span class="hljs-punctuation">,</span><br>     collation<span class="hljs-punctuation">:</span> &lt;document&gt;<span class="hljs-punctuation">,</span><br>     arrayFilters<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span> &lt;filterdocument1&gt;<span class="hljs-punctuation">,</span> ... <span class="hljs-punctuation">]</span><br>   <span class="hljs-punctuation">&#125;</span><br>)<br></code></pre></td></tr></table></figure><p>使用例子</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">updateOne</span>(<br>    &#123;<br>        <span class="hljs-attr">item</span>: <span class="hljs-string">&quot;paper&quot;</span><br>    &#125;,<br>    &#123;<br>        <span class="hljs-attr">$set</span>: &#123;<br>            <span class="hljs-string">&quot;size.uom&quot;</span>: <span class="hljs-string">&quot;cm&quot;</span>,<br>            <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;P&quot;</span><br>        &#125;,<br>        <span class="hljs-attr">$currentDate</span>: &#123;<br>            <span class="hljs-attr">lastModified</span>: <span class="hljs-literal">true</span><br>        &#125;<br>    &#125;<br>)<br><br><br><span class="hljs-comment">/* 1 */</span><br>&#123;<br>    <span class="hljs-string">&quot;acknowledged&quot;</span> : <span class="hljs-literal">true</span>,<br>    <span class="hljs-string">&quot;matchedCount&quot;</span> : <span class="hljs-number">1.0</span>,<br>    <span class="hljs-string">&quot;modifiedCount&quot;</span> : <span class="hljs-number">1.0</span><br>&#125;<br><br><span class="hljs-comment">// 修改后的数据</span><br><span class="hljs-comment">/* 1 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;64493abb802c33de71430e81&quot;</span>),<br>    <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;paper&quot;</span>,<br>    <span class="hljs-string">&quot;qty&quot;</span> : <span class="hljs-number">100.0</span>,<br>    <span class="hljs-string">&quot;size&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;h&quot;</span> : <span class="hljs-number">8.5</span>,<br>        <span class="hljs-string">&quot;w&quot;</span> : <span class="hljs-number">11.0</span>,<br>        <span class="hljs-string">&quot;uom&quot;</span> : <span class="hljs-string">&quot;cm&quot;</span><br>    &#125;,<br>    <span class="hljs-string">&quot;status&quot;</span> : <span class="hljs-string">&quot;P&quot;</span>,<br>    <span class="hljs-string">&quot;lastModified&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2023-04-26T14:58:14.173Z&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>使用 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/update/set/#mongodb-update-up.-set"><code>$set</code></a> 运算符将 <code>size.uom</code> 字段的值更新为 <code>&quot;cm&quot;</code> 并将 <code>status</code> 字段的值更新为 <code>&quot;P&quot;</code></p><p>使用 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/update/currentDate/#mongodb-update-up.-currentDate"><code>$currentDate</code></a> 运算符将 <code>lastModified</code> 字段的值更新为当前日期。如果 <code>lastModified</code> 字段不存在， <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/update/currentDate/#mongodb-update-up.-currentDate"><code>$currentDate</code></a> 将创建该字段</p><h4 id="updatemany"><a class="markdownIt-Anchor" href="#updatemany"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.updateMany/">updateMany</a></h4><p>更新与集合的指定过滤器匹配的所有文档</p><p>语法</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs json">db.collection.updateMany(<br>   &lt;filter&gt;<span class="hljs-punctuation">,</span><br>   &lt;update&gt;<span class="hljs-punctuation">,</span><br>   <span class="hljs-punctuation">&#123;</span><br>     upsert<span class="hljs-punctuation">:</span> &lt;boolean&gt;<span class="hljs-punctuation">,</span><br>     writeConcern<span class="hljs-punctuation">:</span> &lt;document&gt;<span class="hljs-punctuation">,</span><br>     collation<span class="hljs-punctuation">:</span> &lt;document&gt;<span class="hljs-punctuation">,</span><br>     arrayFilters<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span> &lt;filterdocument1&gt;<span class="hljs-punctuation">,</span> ... <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>     hint<span class="hljs-punctuation">:</span>  &lt;document|string&gt;        <span class="hljs-comment">// Available starting in MongoDB 4.2.1</span><br>   <span class="hljs-punctuation">&#125;</span><br>)<br></code></pre></td></tr></table></figure><p>使用例子</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">updateMany</span>(<br>    &#123;<br>        <span class="hljs-attr">qty</span>: &#123;<br>            <span class="hljs-attr">$lt</span>: <span class="hljs-number">50</span><br>        &#125;<br>    &#125;,<br>    &#123;<br>        <span class="hljs-attr">$set</span>: &#123;<br>            <span class="hljs-string">&quot;size.uom&quot;</span>: <span class="hljs-string">&quot;in&quot;</span>,<br>            <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;P&quot;</span><br>        &#125;,<br>        <span class="hljs-attr">$currentDate</span>: &#123;<br>            <span class="hljs-attr">lastModified</span>: <span class="hljs-literal">true</span><br>        &#125;<br>    &#125;<br>)<br></code></pre></td></tr></table></figure><p>更新所有 qty 小于5的文档</p><p>使用 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/update/set/#mongodb-update-up.-set"><code>$set</code></a> 运算符将 <code>size.uom</code> 字段的值更新为 <code>&quot;in&quot;</code>，将状态字段的值更新为 <code>&quot;P&quot;</code></p><p>使用 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/update/currentDate/#mongodb-update-up.-currentDate"><code>$currentDate</code></a> 运算符将 <code>lastModified</code> 字段的值更新为当前日期。如果 <code>lastModified</code> 字段不存在， <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/update/currentDate/#mongodb-update-up.-currentDate"><code>$currentDate</code></a> 将创建该字段</p><h4 id="replaceone"><a class="markdownIt-Anchor" href="#replaceone"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.replaceOne/">replaceOne</a></h4><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.replaceOne/">db.collection.replaceOne(filter, replacement, options)</a> 根据过滤器替换集合中的单个文档，替换 <code>_id</code> 字段以外的文档的全部内容</p><p>语法</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs json">db.collection.replaceOne(<br>   &lt;filter&gt;<span class="hljs-punctuation">,</span><br>   &lt;replacement&gt;<span class="hljs-punctuation">,</span><br>   <span class="hljs-punctuation">&#123;</span><br>     upsert<span class="hljs-punctuation">:</span> &lt;boolean&gt;<span class="hljs-punctuation">,</span><br>     writeConcern<span class="hljs-punctuation">:</span> &lt;document&gt;<span class="hljs-punctuation">,</span><br>     collation<span class="hljs-punctuation">:</span> &lt;document&gt;<span class="hljs-punctuation">,</span><br>     hint<span class="hljs-punctuation">:</span> &lt;document|string&gt;                   <span class="hljs-comment">// Available starting in 4.2.1</span><br>   <span class="hljs-punctuation">&#125;</span><br>)<br></code></pre></td></tr></table></figure><p>使用例子</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">replaceOne</span>(<br>    &#123;<br>        <span class="hljs-attr">item</span>: <span class="hljs-string">&quot;paper&quot;</span><br>    &#125;,<br>    &#123;<br>        <span class="hljs-attr">item</span>: <span class="hljs-string">&quot;paper&quot;</span>,<br>        <span class="hljs-attr">instock</span>: [<br>            &#123;<br>                <span class="hljs-attr">warehouse</span>: <span class="hljs-string">&quot;A&quot;</span>,<br>                <span class="hljs-attr">qty</span>: <span class="hljs-number">60</span> <br>            &#125;,<br>            &#123; <br>                <span class="hljs-attr">warehouse</span>: <span class="hljs-string">&quot;B&quot;</span>,<br>                <span class="hljs-attr">qty</span>: <span class="hljs-number">40</span><br>            &#125;<br>        ]<br>    &#125;<br>)<br><br><br><span class="hljs-comment">/* 1 */</span><br>&#123;<br>    <span class="hljs-string">&quot;acknowledged&quot;</span> : <span class="hljs-literal">true</span>,<br>    <span class="hljs-string">&quot;matchedCount&quot;</span> : <span class="hljs-number">1.0</span>,<br>    <span class="hljs-string">&quot;modifiedCount&quot;</span> : <span class="hljs-number">1.0</span><br>&#125;<br><br><br><span class="hljs-comment">/* 1 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;64493abb802c33de71430e81&quot;</span>),<br>    <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;paper&quot;</span>,<br>    <span class="hljs-string">&quot;instock&quot;</span> : [ <br>        &#123;<br>            <span class="hljs-string">&quot;warehouse&quot;</span> : <span class="hljs-string">&quot;A&quot;</span>,<br>            <span class="hljs-string">&quot;qty&quot;</span> : <span class="hljs-number">60.0</span><br>        &#125;, <br>        &#123;<br>            <span class="hljs-string">&quot;warehouse&quot;</span> : <span class="hljs-string">&quot;B&quot;</span>,<br>            <span class="hljs-string">&quot;qty&quot;</span> : <span class="hljs-number">40.0</span><br>        &#125;<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="行为"><a class="markdownIt-Anchor" href="#行为"></a> 行为</h4><p><strong>原子性</strong></p><p>MongoDB中的所有写操作都是 <code>单个文档级别上的原子操作</code>。有关MongoDB和原子性的更多信息，请参见<a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/write-operations-atomicity/">原子性和事务</a></p><hr><p><strong>_id 字段</strong></p><p>设置后，无法更新 <code>_id</code> 字段的值，也无法将现有文档替换为具有不同 <code>_id</code> 字段值的替换文档</p><hr><p><strong>字段顺序</strong></p><p>对于写操作，MongoDB 保留文档字段的顺序，但以下情况除外：</p><ul><li><code>_id</code> 字段始终是文档中的第一个字段</li><li>包含 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/update/rename/#mongodb-update-up.-rename"><code>rename</code></a> 字段名称的更新可能会导致文档中的字段重新排序</li></ul><hr><p><strong>修改或新增</strong></p><p>如果<a target="_blank" rel="noopener" href="https://docs.mongodb.com/master/reference/method/db.collection.updateOne/#db.collection.updateOne"><code>updateOne()</code></a>, <a target="_blank" rel="noopener" href="https://docs.mongodb.com/master/reference/method/db.collection.updateMany/#db.collection.updateMany"><code>updateMany()</code></a>, or <a target="_blank" rel="noopener" href="https://docs.mongodb.com/master/reference/method/db.collection.replaceOne/#db.collection.replaceOne"><code>replaceOne()</code></a> 包含 <code>upsert：true</code>，并且没有文档与指定的过滤器匹配，则该操作将创建一个新文档并将其插入。 如果存在匹配的文档，则该操作将修改或替换一个或多个匹配的文档</p><h3 id="聚合管道更新"><a class="markdownIt-Anchor" href="#聚合管道更新"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/tutorial/update-documents-with-aggregation-pipeline/">聚合管道更新</a></h3><p>从 MongoDB 4.2 开始，可以使用聚合管道进行更新操作，通过更新操作，聚合管道可以包括以下阶段</p><ul><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/addFields/#mongodb-pipeline-pipe.-addFields"><code>$addFields</code></a> 用于向文档中添加新的字段</li><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/set/#mongodb-pipeline-pipe.-set"><code>$set</code></a> 用于更新现有字段的值或者添加新的字段</li><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/project/#mongodb-pipeline-pipe.-project"><code>$project</code></a> 用于选择要返回的字段，并可以对这些字段进行重命名、计算表达式等操作</li><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/unset/#mongodb-pipeline-pipe.-unset"><code>$unset</code></a> 用于从文档中删除指定的字段</li><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/replaceRoot/#mongodb-pipeline-pipe.-replaceRoot"><code>$replaceRoot</code></a> 用于将文档的结构更改为指定字段的内容</li><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/replaceWith/#mongodb-pipeline-pipe.-replaceWith"><code>$replaceWith</code></a> 用于替换当前文档为指定的值</li></ul><p>使用聚合管道允许使用表达性更强的update语句，比如根据当前字段值表示条件更新，或者使用另一个字段的值更新一个字段</p><p class="note note-primary">使用聚合表达式变量</p><p><strong>测试数据</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">students</span>.<span class="hljs-title function_">insertMany</span>( [<br>   &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">test1</span>: <span class="hljs-number">95</span>, <span class="hljs-attr">test2</span>: <span class="hljs-number">92</span>, <span class="hljs-attr">test3</span>: <span class="hljs-number">90</span>, <span class="hljs-attr">modified</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">&quot;01/05/2020&quot;</span>) &#125;,<br>   &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">test1</span>: <span class="hljs-number">98</span>, <span class="hljs-attr">test2</span>: <span class="hljs-number">100</span>, <span class="hljs-attr">test3</span>: <span class="hljs-number">102</span>, <span class="hljs-attr">modified</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">&quot;01/05/2020&quot;</span>) &#125;,<br>   &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">test1</span>: <span class="hljs-number">95</span>, <span class="hljs-attr">test2</span>: <span class="hljs-number">110</span>, <span class="hljs-attr">modified</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">&quot;01/04/2020&quot;</span>) &#125;<br>] )<br></code></pre></td></tr></table></figure><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/aggregation-variables/">聚合表达式中的变量</a></p><p>以下 <code>db.collection.updateOne()</code> 操作使用聚合管道通过 <code>_id: 3</code> 更新文档</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">students</span>.<span class="hljs-title function_">updateOne</span>(<br>    &#123;<br>        <span class="hljs-attr">_id</span>: <span class="hljs-number">3</span><br>    &#125;,<br>    [<br>        &#123;<br>            <span class="hljs-attr">$set</span>: &#123;<br>                <span class="hljs-attr">test3</span>: <span class="hljs-number">98</span>,<br>                <span class="hljs-attr">modified</span>: <span class="hljs-string">&quot;$$NOW&quot;</span><br>            &#125;<br>        &#125;<br>    ]<br>)<br></code></pre></td></tr></table></figure><p>具体来说，管道由一个 <code>$set</code> 阶段组成，该阶段将 <code>test3</code> 字段（并将其值设置为 <code>98</code> ）添加到文档并将 <code>modified</code> 字段设置为当前日期时间。该操作将聚合变量 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/aggregation-variables/#mongodb-variable-variable.NOW"><code>NOW</code></a> 用于当前日期时间。要访问变量，请以 <code>$$</code> 为前缀并用引号引起来</p><h4 id="规范文档字段"><a class="markdownIt-Anchor" href="#规范文档字段"></a> 规范文档字段</h4><p><strong>测试数据</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">students2</span>.<span class="hljs-title function_">insertMany</span>( [<br>   &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">1</span>, <span class="hljs-attr">quiz1</span>: <span class="hljs-number">8</span>, <span class="hljs-attr">test2</span>: <span class="hljs-number">100</span>, <span class="hljs-attr">quiz2</span>: <span class="hljs-number">9</span>, <span class="hljs-attr">modified</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">&quot;01/05/2020&quot;</span>) &#125;,<br>   &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">2</span>, <span class="hljs-attr">quiz2</span>: <span class="hljs-number">5</span>, <span class="hljs-attr">test1</span>: <span class="hljs-number">80</span>, <span class="hljs-attr">test2</span>: <span class="hljs-number">89</span>, <span class="hljs-attr">modified</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">&quot;01/05/2020&quot;</span>) &#125;,<br>] )<br></code></pre></td></tr></table></figure><p>以下 <code>db.collection.updateMany()</code> 操作使用聚合管道来标准化文档的字段（即集合中的文档应具有相同的字段）并更新 <code>modified</code> 字段</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">students2</span>.<span class="hljs-title function_">updateMany</span>(<br>    &#123;&#125;,<br>    [<br>        &#123;<br>            <span class="hljs-attr">$replaceRoot</span>: &#123;<br>                <span class="hljs-attr">newRoot</span>: &#123;<br>                    <span class="hljs-attr">$mergeObjects</span>: [<br>                        &#123;<br>                            <span class="hljs-attr">quiz1</span>: <span class="hljs-number">0</span>,<br>                            <span class="hljs-attr">quiz2</span>: <span class="hljs-number">0</span>,<br>                            <span class="hljs-attr">test1</span>: <span class="hljs-number">0</span>,<br>                            <span class="hljs-attr">test2</span>: <span class="hljs-number">0</span><br>                        &#125;,<br>                        <span class="hljs-string">&quot;$$ROOT&quot;</span><br>                    ]<br>                &#125;<br>            &#125;<br>        &#125;,<br>        &#123;<br>            <span class="hljs-attr">$set</span>: &#123;<br>                <span class="hljs-attr">modified</span>: <span class="hljs-string">&quot;$$NOW&quot;</span><br>            &#125;<br>        &#125;<br>    ]<br>)<br><br><br><span class="hljs-comment">/* 1 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">1.0</span>,<br>    <span class="hljs-string">&quot;quiz1&quot;</span> : <span class="hljs-number">8.0</span>,<br>    <span class="hljs-string">&quot;quiz2&quot;</span> : <span class="hljs-number">9.0</span>,<br>    <span class="hljs-string">&quot;test1&quot;</span> : <span class="hljs-number">0.0</span>,<br>    <span class="hljs-string">&quot;test2&quot;</span> : <span class="hljs-number">100.0</span>,<br>    <span class="hljs-string">&quot;modified&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2023-04-27T07:46:36.526Z&quot;</span>)<br>&#125;<br><br><span class="hljs-comment">/* 2 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">2.0</span>,<br>    <span class="hljs-string">&quot;quiz1&quot;</span> : <span class="hljs-number">0.0</span>,<br>    <span class="hljs-string">&quot;quiz2&quot;</span> : <span class="hljs-number">5.0</span>,<br>    <span class="hljs-string">&quot;test1&quot;</span> : <span class="hljs-number">80.0</span>,<br>    <span class="hljs-string">&quot;test2&quot;</span> : <span class="hljs-number">89.0</span>,<br>    <span class="hljs-string">&quot;modified&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2023-04-27T07:46:36.526Z&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/replaceRoot/#mongodb-pipeline-pipe.-replaceRoot"><code>$replaceRoot</code></a> 阶段，带有 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/mergeObjects/#mongodb-expression-exp.-mergeObjects"><code>$mergeObjects</code></a> 表达式，可为<code>quiz1</code>、<code>quiz2</code>、<code>test1</code>、<code>test2</code> 字段设置默认值。 聚合变量 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/aggregation-variables/#mongodb-variable-variable.ROOT"><code>ROOT</code></a> 指的是正在修改的当前文档，要访问变量，请以 <code>$$</code> 为前缀并用引号引起来。当前文档字段将覆盖默认值</li><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/set/#mongodb-pipeline-pipe.-set"><code>$set</code></a> 阶段用于将修改的字段更新到当前日期时间。 对于当前日期时间，该操作将聚合变量 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/aggregation-variables/#mongodb-variable-variable.NOW"><code>NOW</code></a> 用于（以访问变量，以 <code>$$</code> 为前缀并用引号引起来）</li></ul><p>最终实现的效果是 <code>$mergeObjects</code> 将符合条件的多个文档重新进行字段规划，给出字段和默认值。然后 <code>$replaceRoot</code> 对当前文档进行替换，如果当前文档已存在字段则跳过，负责插入新的字段和默认值</p><h4 id="聚合管道字段引用"><a class="markdownIt-Anchor" href="#聚合管道字段引用"></a> 聚合管道字段引用</h4><p><strong>测试数据</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">students3</span>.<span class="hljs-title function_">insertMany</span>( [<br>   &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">1</span>, <span class="hljs-string">&quot;tests&quot;</span> : [ <span class="hljs-number">95</span>, <span class="hljs-number">92</span>, <span class="hljs-number">90</span> ], <span class="hljs-string">&quot;modified&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2019-01-01T00:00:00Z&quot;</span>) &#125;,<br>   &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">2</span>, <span class="hljs-string">&quot;tests&quot;</span> : [ <span class="hljs-number">94</span>, <span class="hljs-number">88</span>, <span class="hljs-number">90</span> ], <span class="hljs-string">&quot;modified&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2019-01-01T00:00:00Z&quot;</span>) &#125;,<br>   &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">3</span>, <span class="hljs-string">&quot;tests&quot;</span> : [ <span class="hljs-number">70</span>, <span class="hljs-number">75</span>, <span class="hljs-number">82</span> ], <span class="hljs-string">&quot;modified&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2019-01-01T00:00:00Z&quot;</span>) &#125;<br>] );<br></code></pre></td></tr></table></figure><p>以下操作使用聚合管道计算平均值，然后用平均值进行评级</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">students3</span>.<span class="hljs-title function_">updateMany</span>(<br>    &#123;&#125;,<br>    [<br>        &#123; <span class="hljs-attr">$set</span>: &#123; <span class="hljs-attr">average</span>: &#123; <span class="hljs-attr">$trunc</span>: [&#123; <span class="hljs-attr">$avg</span>: <span class="hljs-string">&quot;$tests&quot;</span> &#125;, <span class="hljs-number">0</span>] &#125;, <span class="hljs-attr">modified</span>: <span class="hljs-string">&quot;$$NOW&quot;</span> &#125; &#125;,<br>        &#123;<br>            <span class="hljs-attr">$set</span>: &#123;<br>                <span class="hljs-attr">grade</span>: &#123;<br>                    <span class="hljs-attr">$switch</span>: &#123;<br>                        <span class="hljs-attr">branches</span>: [<br>                            &#123; <span class="hljs-attr">case</span>: &#123; <span class="hljs-attr">$gte</span>: [<span class="hljs-string">&quot;$average&quot;</span>, <span class="hljs-number">90</span>] &#125;, <span class="hljs-attr">then</span>: <span class="hljs-string">&quot;A&quot;</span> &#125;,<br>                            &#123; <span class="hljs-attr">case</span>: &#123; <span class="hljs-attr">$gte</span>: [<span class="hljs-string">&quot;$average&quot;</span>, <span class="hljs-number">80</span>] &#125;, <span class="hljs-attr">then</span>: <span class="hljs-string">&quot;B&quot;</span> &#125;,<br>                            &#123; <span class="hljs-attr">case</span>: &#123; <span class="hljs-attr">$gte</span>: [<span class="hljs-string">&quot;$average&quot;</span>, <span class="hljs-number">70</span>] &#125;, <span class="hljs-attr">then</span>: <span class="hljs-string">&quot;C&quot;</span> &#125;,<br>                            &#123; <span class="hljs-attr">case</span>: &#123; <span class="hljs-attr">$gte</span>: [<span class="hljs-string">&quot;$average&quot;</span>, <span class="hljs-number">60</span>] &#125;, <span class="hljs-attr">then</span>: <span class="hljs-string">&quot;D&quot;</span> &#125;<br>                        ],<br>                        <span class="hljs-attr">default</span>: <span class="hljs-string">&quot;F&quot;</span><br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>    ]<br>)<br><br><br><span class="hljs-comment">/* 1 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">1.0</span>,<br>    <span class="hljs-string">&quot;tests&quot;</span> : [ <br>        <span class="hljs-number">95.0</span>, <br>        <span class="hljs-number">92.0</span>, <br>        <span class="hljs-number">90.0</span><br>    ],<br>    <span class="hljs-string">&quot;modified&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2023-04-27T08:44:41.551Z&quot;</span>),<br>    <span class="hljs-string">&quot;average&quot;</span> : <span class="hljs-number">92.0</span>,<br>    <span class="hljs-string">&quot;grade&quot;</span> : <span class="hljs-string">&quot;A&quot;</span><br>&#125;<br><br><span class="hljs-comment">/* 2 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">2.0</span>,<br>    <span class="hljs-string">&quot;tests&quot;</span> : [ <br>        <span class="hljs-number">94.0</span>, <br>        <span class="hljs-number">88.0</span>, <br>        <span class="hljs-number">90.0</span><br>    ],<br>    <span class="hljs-string">&quot;modified&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2023-04-27T08:44:41.551Z&quot;</span>),<br>    <span class="hljs-string">&quot;average&quot;</span> : <span class="hljs-number">90.0</span>,<br>    <span class="hljs-string">&quot;grade&quot;</span> : <span class="hljs-string">&quot;A&quot;</span><br>&#125;<br><br><span class="hljs-comment">/* 3 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">3.0</span>,<br>    <span class="hljs-string">&quot;tests&quot;</span> : [ <br>        <span class="hljs-number">70.0</span>, <br>        <span class="hljs-number">75.0</span>, <br>        <span class="hljs-number">82.0</span><br>    ],<br>    <span class="hljs-string">&quot;modified&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2023-04-27T08:44:41.551Z&quot;</span>),<br>    <span class="hljs-string">&quot;average&quot;</span> : <span class="hljs-number">75.0</span>,<br>    <span class="hljs-string">&quot;grade&quot;</span> : <span class="hljs-string">&quot;C&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><ul><li>先使用管道计算出平均值， <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/trunc/#mongodb-expression-exp.-trunc"><code>$trunc</code></a> 用于截断平均数，让平均分数为整数，然后再使用 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/aggregation-variables/#mongodb-variable-variable.NOW"><code>NOW</code></a> 聚合变量修改时间字段</li><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/set/#mongodb-pipeline-pipe.-set"><code>$set</code></a> 阶段使用 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/switch/#mongodb-expression-exp.-switch"><code>$switch</code></a> 表达式在 <code>average</code> 的基础上添加 <code>grade</code> 字段</li></ul><h4 id="聚合管道数组拼接"><a class="markdownIt-Anchor" href="#聚合管道数组拼接"></a> 聚合管道数组拼接</h4><p><strong>测试数据</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">students4</span>.<span class="hljs-title function_">insertMany</span>([<br>  &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">1</span>, <span class="hljs-string">&quot;quizzes&quot;</span> : [ <span class="hljs-number">4</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span> ] &#125;,<br>  &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">2</span>, <span class="hljs-string">&quot;quizzes&quot;</span> : [ <span class="hljs-number">5</span> ] &#125;,<br>  &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">3</span>, <span class="hljs-string">&quot;quizzes&quot;</span> : [ <span class="hljs-number">10</span>, <span class="hljs-number">10</span>, <span class="hljs-number">10</span> ] &#125;<br>])<br></code></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">students4</span>.<span class="hljs-title function_">updateOne</span>( <br>    &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">2</span> &#125;,<br>    [ <br>        &#123; <br>            <span class="hljs-attr">$set</span>: &#123; <br>                <span class="hljs-attr">quizzes</span>: &#123;<br>                    <span class="hljs-attr">$concatArrays</span>: [ <br>                        <span class="hljs-string">&quot;$quizzes&quot;</span>,	<span class="hljs-comment">// 数组字段引用</span><br>                        [ <span class="hljs-number">8</span>, <span class="hljs-number">6</span> ]  	<span class="hljs-comment">// 多个数组拼接</span><br>                    ] <br>                &#125; <br>            &#125; <br>        &#125; <br>     ]<br>)<br><br><br><span class="hljs-comment">/* 1 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">1.0</span>,<br>    <span class="hljs-string">&quot;quizzes&quot;</span> : [ <br>        <span class="hljs-number">4.0</span>, <br>        <span class="hljs-number">6.0</span>, <br>        <span class="hljs-number">7.0</span><br>    ]<br>&#125;<br><br><span class="hljs-comment">/* 2 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">2.0</span>,<br>    <span class="hljs-string">&quot;quizzes&quot;</span> : [ <br>        <span class="hljs-number">5.0</span>, <br>        <span class="hljs-number">8.0</span>, <br>        <span class="hljs-number">6.0</span><br>    ]<br>&#125;<br><br><span class="hljs-comment">/* 3 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">3.0</span>,<br>    <span class="hljs-string">&quot;quizzes&quot;</span> : [ <br>        <span class="hljs-number">10.0</span>, <br>        <span class="hljs-number">10.0</span>, <br>        <span class="hljs-number">10.0</span><br>    ]<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="聚合管道新字段计算"><a class="markdownIt-Anchor" href="#聚合管道新字段计算"></a> 聚合管道新字段计算</h4><p><strong>测试数据</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">temperatures</span>.<span class="hljs-title function_">insertMany</span>([<br>  &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">1</span>, <span class="hljs-string">&quot;date&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2019-06-23&quot;</span>), <span class="hljs-string">&quot;tempsC&quot;</span> : [ <span class="hljs-number">4</span>, <span class="hljs-number">12</span>, <span class="hljs-number">17</span> ] &#125;,<br>  &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">2</span>, <span class="hljs-string">&quot;date&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2019-07-07&quot;</span>), <span class="hljs-string">&quot;tempsC&quot;</span> : [ <span class="hljs-number">14</span>, <span class="hljs-number">24</span>, <span class="hljs-number">11</span> ] &#125;,<br>  &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">3</span>, <span class="hljs-string">&quot;date&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2019-10-30&quot;</span>), <span class="hljs-string">&quot;tempsC&quot;</span> : [ <span class="hljs-number">18</span>, <span class="hljs-number">6</span>, <span class="hljs-number">8</span> ] &#125;<br>])<br></code></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">temperatures</span>.<span class="hljs-title function_">updateMany</span>( &#123; &#125;,<br>  [<br>    &#123; <span class="hljs-attr">$addFields</span>: &#123; <span class="hljs-string">&quot;tempsF&quot;</span>: &#123;		<span class="hljs-comment">// 添加一个字段</span><br>          <span class="hljs-attr">$map</span>: &#123;				   <span class="hljs-comment">// 映射转换</span><br>             <span class="hljs-attr">input</span>: <span class="hljs-string">&quot;$tempsC&quot;</span>,<br>             <span class="hljs-attr">as</span>: <span class="hljs-string">&quot;celsius&quot;</span>,			<span class="hljs-comment">// 别名</span><br>             <span class="hljs-attr">in</span>: &#123; <span class="hljs-attr">$add</span>: [ &#123; <span class="hljs-attr">$multiply</span>: [<span class="hljs-string">&quot;$$celsius&quot;</span>, <span class="hljs-number">9</span>/<span class="hljs-number">5</span> ] &#125;, <span class="hljs-number">32</span> ] &#125;	<span class="hljs-comment">// 字段计算</span><br>          &#125;<br>    &#125; &#125; &#125;<br>  ]<br>)<br><br><br><span class="hljs-comment">/* 1 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">1.0</span>,<br>    <span class="hljs-string">&quot;date&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2019-06-23T00:00:00.000Z&quot;</span>),<br>    <span class="hljs-string">&quot;tempsC&quot;</span> : [ <br>        <span class="hljs-number">4.0</span>, <br>        <span class="hljs-number">12.0</span>, <br>        <span class="hljs-number">17.0</span><br>    ],<br>    <span class="hljs-string">&quot;tempsF&quot;</span> : [ <br>        <span class="hljs-number">39.2</span>, <br>        <span class="hljs-number">53.6</span>, <br>        <span class="hljs-number">62.6</span><br>    ]<br>&#125;<br><br><span class="hljs-comment">/* 2 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">2.0</span>,<br>    <span class="hljs-string">&quot;date&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2019-07-07T00:00:00.000Z&quot;</span>),<br>    <span class="hljs-string">&quot;tempsC&quot;</span> : [ <br>        <span class="hljs-number">14.0</span>, <br>        <span class="hljs-number">24.0</span>, <br>        <span class="hljs-number">11.0</span><br>    ],<br>    <span class="hljs-string">&quot;tempsF&quot;</span> : [ <br>        <span class="hljs-number">57.2</span>, <br>        <span class="hljs-number">75.2</span>, <br>        <span class="hljs-number">51.8</span><br>    ]<br>&#125;<br><br><span class="hljs-comment">/* 3 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">3.0</span>,<br>    <span class="hljs-string">&quot;date&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2019-10-30T00:00:00.000Z&quot;</span>),<br>    <span class="hljs-string">&quot;tempsC&quot;</span> : [ <br>        <span class="hljs-number">18.0</span>, <br>        <span class="hljs-number">6.0</span>, <br>        <span class="hljs-number">8.0</span><br>    ],<br>    <span class="hljs-string">&quot;tempsF&quot;</span> : [ <br>        <span class="hljs-number">64.4</span>, <br>        <span class="hljs-number">42.8</span>, <br>        <span class="hljs-number">46.4</span><br>    ]<br>&#125;<br></code></pre></td></tr></table></figure><p>具体来说，该管道由一个 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/addFields/#mongodb-pipeline-pipe.-addFields"><code>$addFields</code></a> 阶段组成，用于添加一个包含华氏温度的新数组字段 <code>tempsF</code> 。为了将 <code>tempsC</code> 数组中的每个摄氏温度转换为华氏温度，该阶段使用 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/map/#mongodb-expression-exp.-map"><code>$map</code></a> 表达式以及 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/add/#mongodb-expression-exp.-add"><code>$add</code></a> 和 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/multiply/#mongodb-expression-exp.-multiply"><code>$multiply</code></a> 表达式</p><h2 id="删除文档"><a class="markdownIt-Anchor" href="#删除文档"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/tutorial/remove-documents/">删除文档</a></h2><p><strong>删除方法</strong></p><table><thead><tr><th style="text-align:left">方法</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td style="text-align:left"><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.deleteOne/#mongodb-method-db.collection.deleteOne"><code>db.collection.deleteOne()</code></a></td><td style="text-align:left">最多删除一个与指定过滤器匹配的文档，即使过滤器匹配到多个文档</td></tr><tr><td style="text-align:left"><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.deleteMany/#mongodb-method-db.collection.deleteMany"><code>db.collection.deleteMany()</code></a></td><td style="text-align:left">删除与指定过滤器匹配的所有文档</td></tr><tr><td style="text-align:left"><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.remove/#mongodb-method-db.collection.remove"><code>db.collection.remove()</code></a></td><td style="text-align:left">删除与指定过滤器匹配的单个文档或所有文档</td></tr></tbody></table><p><strong>其他方法</strong></p><p>以下方法也可以从集合中删除文档:</p><ul><li><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.findOneAndDelete/#mongodb-method-db.collection.findOneAndDelete"><code>db.collection.findOneAndDelete()</code>.</a></p><p>findOneAndDelete() 提供了一个排序选项。该选项允许删除按指定顺序排序的第一个文档</p></li><li><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.findAndModify/#mongodb-method-db.collection.findAndModify"><code>db.collection.findAndModify()</code>.</a></p><p>提供了一个排序选项。该选项允许删除按指定顺序排序的第一个文档</p></li><li><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.bulkWrite/#mongodb-method-db.collection.bulkWrite"><code>db.collection.bulkWrite()</code>.</a></p><p>批量写操作</p></li></ul><h4 id="删除所有文档"><a class="markdownIt-Anchor" href="#删除所有文档"></a> 删除所有文档</h4><p>要从集合中删除所有文档，请将空 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/document/#std-label-document-query-filter">过滤器</a> 文档 <code>&#123;&#125;</code> 传递给 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.deleteMany/#mongodb-method-db.collection.deleteMany"><code>db.collection.deleteMany()</code></a> 方法</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">deleteMany</span>(&#123;&#125;)<br></code></pre></td></tr></table></figure><h4 id="删除符合条件的所有文档"><a class="markdownIt-Anchor" href="#删除符合条件的所有文档"></a> 删除符合条件的所有文档</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">deleteMany</span>(<br>    &#123;<br>        <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;A&quot;</span><br>    &#125;<br>)<br></code></pre></td></tr></table></figure><p>删除 <code>status</code> 为 <code>A</code> 的所有文档</p><h4 id="仅删除一个符合条件的文档"><a class="markdownIt-Anchor" href="#仅删除一个符合条件的文档"></a> 仅删除一个符合条件的文档</h4><p>要删除最多一个与指定过滤器匹配的文档（即使多个文档可以与指定过滤器匹配），请使用 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.deleteOne/#mongodb-method-db.collection.deleteOne"><code>db.collection.deleteOne()</code></a> 方法</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">deleteOne</span>(<br>    &#123;<br>        <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;D&quot;</span><br>    &#125;<br>)<br></code></pre></td></tr></table></figure><h4 id="删除行为"><a class="markdownIt-Anchor" href="#删除行为"></a> 删除行为</h4><p><strong>索引</strong></p><p>即使从集合中删除所有文档，删除操作也不会删除索引</p><hr><p><strong>原子性</strong></p><p>MongoDB 中的所有写操作在单个文档级别上都是原子的。有关 MongoDB 和原子性的更多信息，请参阅 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/write-operations-atomicity/">原子性和事务</a></p><hr><p><strong>写确认</strong></p><p>对于写入问题，您可以指定从MongoDB请求的写入操作的确认级别。 有关详细信息，请参见 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/write-concern/">写确认</a></p><h2 id="批量写入操作"><a class="markdownIt-Anchor" href="#批量写入操作"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/bulk-write-operations/">批量写入操作</a></h2><p>MongoDB为客户端提供了批量写操作的能力。 批量写入操作会影响 <code>单个集合</code>。 MongoDB允许应用程序确定批量写入操作所需的可接受的确认级别</p><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.bulkWrite/#mongodb-method-db.collection.bulkWrite"><code>db.collection.bulkWrite()</code></a> 方法提供了执行批量 <code>插入</code>，<code>更新</code>和 <code>删除</code> 操作的能力。对于批量插入而言，MongoDB也支持 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.insertMany/#mongodb-method-db.collection.insertMany"><code>db.collection.insertMany()</code></a> 方法批量插入</p><p class="note note-primary">有序 VS 无序操作</p><p>批量写操作可以是有序的，也可以无序的</p><ul><li>使用操作的有序列表，MongoDB <code>串行</code> 地执行操作。 <span class="green-line">如果在某个单独的写操作的处理过程中发生错误，MongoDB将直接返回而不再继续处理列表中任何剩余的写操作</span>。参考 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.bulkWrite/#std-label-bulkwrite-example-bulk-write-operation">有序的批量写入</a></li><li>使用无序的操作列表，MongoDB可以 <code>并行</code> 地执行操作，但是不能保证此行为。 <span class="green-line">如果某个单独的写操作的处理过程中发生错误，MongoDB将继续处理列表中剩余的写操作</span>。参考 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.bulkWrite/#std-label-bulkwrite-example-unordered-bulk-write">无序的批量写入</a></li></ul><p>在分片集合上执行有序的批量写操作通常比执行无序批量写操作要慢。这是因为对于有序列表而言，每个操作都必须等待上一个操作完成后才能执行</p><p>默认情况下，<a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.bulkWrite/#mongodb-method-db.collection.bulkWrite"><code>bulkWrite()</code></a> 执行 <code>有序</code> 的写入。 要指定 <code>无序</code> 的写入，请在选项文档中设置 <code>ordered：false</code></p><p class="note note-primary">支持的操作</p><ul><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.bulkWrite/#std-label-bulkwrite-write-operations-insertOne">insertOne</a></li><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.bulkWrite/#std-label-bulkwrite-write-operations-updateOneMany">updateOne</a></li><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.bulkWrite/#std-label-bulkwrite-write-operations-updateOneMany">updateMany</a></li><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.bulkWrite/#std-label-bulkwrite-write-operations-replaceOne">replaceOne</a></li><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.bulkWrite/#std-label-bulkwrite-write-operations-deleteOneMany">deleteOne</a></li><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.bulkWrite/#std-label-bulkwrite-write-operations-deleteOneMany">deleteMany</a></li></ul><p class="note note-primary">用法</p><p>测试数据</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">pizzas</span>.<span class="hljs-title function_">insertMany</span>( [<br>   &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;pepperoni&quot;</span>, <span class="hljs-attr">size</span>: <span class="hljs-string">&quot;small&quot;</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">4</span> &#125;,<br>   &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;cheese&quot;</span>, <span class="hljs-attr">size</span>: <span class="hljs-string">&quot;medium&quot;</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">7</span> &#125;,<br>   &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;vegan&quot;</span>, <span class="hljs-attr">size</span>: <span class="hljs-string">&quot;large&quot;</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">8</span> &#125;<br>] )<br></code></pre></td></tr></table></figure><ul><li>使用 <code>insertOne</code> 添加两个文档</li><li>使用 <code>updateOne</code> 更新文档</li><li>使用 <code>deleteOne</code> 删除文档</li><li>使用 <code>replaceOne</code> 替换文档</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">try</span> &#123;<br>   db.<span class="hljs-property">pizzas</span>.<span class="hljs-title function_">bulkWrite</span>( [<br>      &#123; <span class="hljs-attr">insertOne</span>: &#123; <span class="hljs-attr">document</span>: &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;beef&quot;</span>, <span class="hljs-attr">size</span>: <span class="hljs-string">&quot;medium&quot;</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">6</span> &#125; &#125; &#125;,<br>      &#123; <span class="hljs-attr">insertOne</span>: &#123; <span class="hljs-attr">document</span>: &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">4</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;sausage&quot;</span>, <span class="hljs-attr">size</span>: <span class="hljs-string">&quot;large&quot;</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">10</span> &#125; &#125; &#125;,<br>      &#123; <span class="hljs-attr">updateOne</span>: &#123;<br>         <span class="hljs-attr">filter</span>: &#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;cheese&quot;</span> &#125;,<br>         <span class="hljs-attr">update</span>: &#123; <span class="hljs-attr">$set</span>: &#123; <span class="hljs-attr">price</span>: <span class="hljs-number">8</span> &#125; &#125;<br>      &#125; &#125;,<br>      &#123; <span class="hljs-attr">deleteOne</span>: &#123; <span class="hljs-attr">filter</span>: &#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;pepperoni&quot;</span>&#125; &#125; &#125;,<br>      &#123; <span class="hljs-attr">replaceOne</span>: &#123;<br>         <span class="hljs-attr">filter</span>: &#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;vegan&quot;</span> &#125;,<br>         <span class="hljs-attr">replacement</span>: &#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;tofu&quot;</span>, <span class="hljs-attr">size</span>: <span class="hljs-string">&quot;small&quot;</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">4</span> &#125;<br>      &#125; &#125;<br>   ] )<br>&#125; <span class="hljs-keyword">catch</span>( error ) &#123;<br>   <span class="hljs-title function_">print</span>( error )<br>&#125;<br><br><br><span class="hljs-comment">/* 1 */</span><br>&#123;<br>    <span class="hljs-string">&quot;acknowledged&quot;</span> : <span class="hljs-literal">true</span>,<br>    <span class="hljs-string">&quot;deletedCount&quot;</span> : <span class="hljs-number">1.0</span>,<br>    <span class="hljs-string">&quot;insertedCount&quot;</span> : <span class="hljs-number">2.0</span>,<br>    <span class="hljs-string">&quot;matchedCount&quot;</span> : <span class="hljs-number">2.0</span>,<br>    <span class="hljs-string">&quot;upsertedCount&quot;</span> : <span class="hljs-number">0.0</span>,<br>    <span class="hljs-string">&quot;insertedIds&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;0&quot;</span> : <span class="hljs-number">3.0</span>,<br>        <span class="hljs-string">&quot;1&quot;</span> : <span class="hljs-number">4.0</span><br>    &#125;,<br>    <span class="hljs-string">&quot;upsertedIds&quot;</span> : &#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p class="note note-primary">批量插入分片集合的策略</p><p>大批量插入操作，包括初始数据插入或例行数据导入，会影响分片集群的性能。对于批量插入，请考虑以下策略：</p><p><strong>对分片集合进行预拆分</strong></p><p>如果分片集合为空，则该集合只有一个存储在单个分片上的初始数据块，MongoDB必须花一些时间来接收数据，创建拆分并将拆分的块分发到其他分片上。为了避免这种性能开销，您可以对分片集合进行预拆分，请参考 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/tutorial/split-chunks-in-sharded-cluster/">分片集群中的数据块拆分 </a>中的描述</p><hr><p><strong>对mongos的无序写入</strong></p><p>要提高对分片集群的写入性能，请使用 <code>bulkWrite()</code> 并将可选参数 <code>ordered</code> 设置为 <code>false</code> 。 <code>mongos</code> 可以尝试同时将写入发送到多个分片。对于空集合，首先按照 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/tutorial/split-chunks-in-sharded-cluster/">分片集群中的数据块拆分 </a>中的描述预先拆分集合</p><hr><p><strong>避免单调插入带来的瓶颈</strong></p><p>如果您的分片键在插入过程中是单调递增的，那么所有插入的数据都会插入到该分片集合的最后一个数据块中，也就是说会落到某单个分片上。因此，集群的插入能力将永远不会超过该单个分片的插入性能（木桶的短板原理）</p><p>如果插入量大于单个分片可以处理的数据量，并且无法避免单调递增的分片键，那么可以考虑对应用程序进行如下修改：</p><ul><li>反转分片键的二进制位。这样可以保留信息并避免将插入顺序与增加的值序列相关联</li><li>交换第一个和最后16比特来实现“随机”插入</li></ul><blockquote><p>mongo 分片默认选择范围分片，单调递增的分片键会让数据集中插入到某个分片中</p></blockquote><h2 id="文本搜索"><a class="markdownIt-Anchor" href="#文本搜索"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/text-search/">文本搜索</a></h2><p>对于自我管理（非 Atlas）部署，MongoDB 的文本搜索功能支持执行字符串内容文本搜索的查询操作。为了执行文本搜索，MongoDB 使用 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/index-text/#std-label-index-feature-text">文本索引</a> 和 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/query/text/#mongodb-query-op.-text"><code>$text</code></a> 运算符</p><p class="note note-primary">执行文本搜索</p><p>此示例演示如何构建文本索引并在指定文本段的情况下使用它来查找咖啡店</p><p><strong>测试数据</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">stores</span>.<span class="hljs-title function_">insertMany</span>(<br>   [<br>     &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Java Hut&quot;</span>, <span class="hljs-attr">description</span>: <span class="hljs-string">&quot;Coffee and cakes&quot;</span> &#125;,<br>     &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Burger Buns&quot;</span>, <span class="hljs-attr">description</span>: <span class="hljs-string">&quot;Gourmet hamburgers&quot;</span> &#125;,<br>     &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Coffee Shop&quot;</span>, <span class="hljs-attr">description</span>: <span class="hljs-string">&quot;Just coffee&quot;</span> &#125;,<br>     &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">4</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Clothes Clothes Clothes&quot;</span>, <span class="hljs-attr">description</span>: <span class="hljs-string">&quot;Discount clothing&quot;</span> &#125;,<br>     &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">5</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Java Shopping&quot;</span>, <span class="hljs-attr">description</span>: <span class="hljs-string">&quot;Indonesian goods&quot;</span> &#125;<br>   ]<br>)<br></code></pre></td></tr></table></figure><p><strong>创建文本索引</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">stores</span>.<span class="hljs-title function_">createIndex</span>(<br>    &#123;<br>        <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;text&quot;</span>,<br>        <span class="hljs-attr">description</span>: <span class="hljs-string">&quot;text&quot;</span><br>    &#125;<br>)<br></code></pre></td></tr></table></figure><p class="note note-primary">准确的短语搜索</p><p>可以通过用双引号将它们括起来来搜索确切的短语。如果 <code>$search</code> 字符串包含短语和单个术语，则文本搜索将仅匹配包含该短语的文档</p><p>例如，以下将查找包含 <code>coffee shop</code> 的所有文档：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">stores</span>.<span class="hljs-title function_">find</span>(<br>    &#123;<br>        <span class="hljs-attr">$text</span>: &#123;<br>            <span class="hljs-attr">$search</span>: <span class="hljs-string">&quot;\&quot;coffee shop\&quot;&quot;</span><br>        &#125;<br>    &#125;<br>)<br><br><br><span class="hljs-comment">/* 1 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">3.0</span>,<br>    <span class="hljs-string">&quot;name&quot;</span> : <span class="hljs-string">&quot;Coffee Shop&quot;</span>,<br>    <span class="hljs-string">&quot;description&quot;</span> : <span class="hljs-string">&quot;Just coffee&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/query/text/#examples">全文搜索例子</a></p><ul><li>搜索单个单词</li><li>匹配任何搜索词</li><li>搜索短语</li><li>排除包含的术语</li><li>搜索不同的语言</li></ul><h2 id="地理空间查询"><a class="markdownIt-Anchor" href="#地理空间查询"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/geospatial-queries/">地理空间查询</a></h2><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/geojson/">GeoJSON 地理位置数据类型</a></p><p><code>TODO</code></p><h2 id="可重试写入"><a class="markdownIt-Anchor" href="#可重试写入"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/retryable-writes/">可重试写入</a></h2><p>可重试写入允许MongoDB驱动程序在遇到网络错误或在复制集或分片群集中找不到正常的主节点时自动重试特定的写操作一次</p><p class="note note-primary">前提条件</p><ul><li><p>需要集群部署支持</p><p>可重试写入需要副本集或分片集群，并且不支持独立实例</p></li><li><p>支持的存储引擎</p><p>可重试写入需要支持文档级锁定的存储引擎，例如 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/wiredtiger/">WiredTiger</a> 或 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/inmemory/">内存</a> 存储引擎</p></li><li><p>3.6+版本程序驱动</p><p>客户端需要为 MongoDB 3.6 或更高版本更新 MongoDB 驱动程序</p></li></ul><p class="note note-primary">可重试写入和多文档事务</p><ul><li>事务 <code>提交</code>和 <code>中止</code> 操作是可重试的写操作。如果提交操作或中止操作遇到错误，MongoDB 驱动程序将重试一次操作，而不管 <code>retryWrites</code> 是否设置为 <code>false</code></li><li>无论 <code>retryWrites</code> 的值如何，事务内的写操作都不可单独重试</li></ul><p class="note note-primary">启用可重试写入</p><p>官方的MongoDB 3.6和4.0兼容驱动程序需要在连接字符串中包含 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/master/reference/connection-string/#urioption.retryWrites"><code>retryWrites=true</code></a> 选项，以启用该连接的可重试写操作</p><p>MongoDB 4.2 及更高版本兼容的驱动程序 <code>默认启用</code> 可重试写入。较早的驱动程序需要 <code>retryWrites=true</code> 选项。在使用与 MongoDB 4.2 及更高版本兼容的驱动程序的应用程序中，可以省略 <code>retryWrites=true</code> 选项</p><p>要禁用可重试写入，使用与 MongoDB 4.2 及更高版本兼容的驱动程序的应用程序必须在连接字符串中包含 <code>retryWrites=false</code></p><p><strong>Mongo shell</strong></p><p><code>mongosh</code> 中默认启用可重试写入。要禁用可重试写入，请使用 <code>--retryWrites=false</code> 命令行选项：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">mongosh --retryWrites=<span class="hljs-literal">false</span><br></code></pre></td></tr></table></figure><p class="note note-primary">可重试的写操作</p><p>当发出已确认的写关注时，可以重试以下写操作; 例如 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/write-concern/">Write Concern</a> 不能为 <code>&#123;w：0&#125;</code></p><blockquote><p>事务内的写操作不可单独重试</p></blockquote><table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/db.collection.insertOne/#db.collection.insertOne">db.collection.insertOne()</a><br><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/db.collection.insert/#db.collection.insert">db.collection.insert()</a><br><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/db.collection.insertMany/#db.collection.insertMany">db.collection.insertMany()</a></td><td>插入操作</td></tr><tr><td><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/db.collection.updateOne/#db.collection.updateOne">db.collection.updateOne()</a><br><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/db.collection.replaceOne/#db.collection.replaceOne">db.collection.replaceOne()</a><br><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/db.collection.save/#db.collection.save">db.collection.save()</a><br><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/db.collection.update/#db.collection.update">db.collection.update()</a> where <code>multi</code> is <code>false</code></td><td>单文档更新操作</td></tr><tr><td><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/db.collection.deleteOne/#db.collection.deleteOne">db.collection.deleteOne()</a><br><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/db.collection.remove/#db.collection.remove">db.collection.remove()</a> where justOne is true</td><td>单个文档删除操作</td></tr><tr><td><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/db.collection.findAndModify/#db.collection.findAndModify">db.collection.findAndModify()</a> <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/db.collection.findOneAndDelete/#db.collection.findOneAndDelete">db.collection.findOneAndDelete()</a> <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/db.collection.findOneAndReplace/#db.collection.findOneAndReplace">db.collection.findOneAndReplace()</a> <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/db.collection.findOneAndUpdate/#db.collection.findOneAndUpdate">db.collection.findOneAndUpdate()</a></td><td><code>findAndModify</code> 操作。所有 <code>findAndModify</code> 操作都是单文档操作</td></tr><tr><td><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/db.collection.bulkWrite/#db.collection.bulkWrite">db.collection.bulkWrite()</a> 具有以下写操作：<br><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/db.collection.bulkWrite/#bulkwrite-write-operations-insertone">insertOne</a> .<br><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/db.collection.bulkWrite/#bulkwrite-write-operations-updateonemany">updateOne</a> .<br><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/db.collection.bulkWrite/#bulkwrite-write-operations-replaceone">replaceOne</a> .<br><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/db.collection.bulkWrite/#bulkwrite-write-operations-deleteonemany">deleteOne</a></td><td>仅包含单文档写入操作的批量写入操作。可重试的批量操作可以包括指定写操作的任意组合，但不能包括任何多文档写操作，例如 <code>updateMany</code></td></tr><tr><td><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/Bulk/#Bulk">Bulk</a> operations for:<br><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/Bulk.find.removeOne/#Bulk.find.removeOne">Bulk.find.removeOne()</a> .<br><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/Bulk.find.replaceOne/#Bulk.find.replaceOne">Bulk.find.replaceOne()</a> .<br><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/Bulk.find.replaceOne/#Bulk.find.replaceOne">Bulk.find.replaceOne()</a></td><td>仅包含单文档写入操作的批量写入操作。可重试的批量操作可以包括指定写操作的任意组合，但不能包括任何多文档写操作，例如 <code>update</code> 为 <code>multi</code> 选项指定 <code>true</code></td></tr></tbody></table><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/retryable-writes/#behavior">可重试写入行为</a></p><ul><li><p>持久性网络错误</p><p>MongoDB 可重试写入仅进行一次重试。这有助于解决暂时性网络错误和副本集选举，但不会解决持久性网络错误</p></li><li><p>故障转移期</p><p>如果驱动程序在目标副本集或分片集群分片中找不到健康的主节点，则驱动程序会等待 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/connection-string/#mongodb-urioption-urioption.serverSelectionTimeoutMS"><code>serverSelectionTimeoutMS</code></a> 毫秒以确定新的主节点，然后再重试。可重试写入不会解决故障转移时间超过 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/connection-string/#mongodb-urioption-urioption.serverSelectionTimeoutMS"><code>serverSelectionTimeoutMS</code></a> 的实例</p></li></ul><h2 id="可重试读取"><a class="markdownIt-Anchor" href="#可重试读取"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/retryable-reads/">可重试读取</a></h2><p>可重试读取允许MongoDB驱动程序在遇到某些 <code>网络</code> 或 <code>服务器错误</code> 时，可以一次自动重试某些读取操作</p><p class="note note-primary">前提条件</p><ul><li><p>最低的驱动程序版本</p><p>官方MongoDB驱动兼容MongoDB服务器 <code>4.2</code> 和以后支持重试读取</p></li><li><p>最低服务器版本</p><p>如果连接到MongoDB Server <code>3.6</code> 或更高版本，驱动程序只能重试读取操作</p></li></ul><p class="note note-primary">启用可重试读取</p><p>MongoDB Server 4.2 及更高版本兼容的官方 MongoDB 驱动程序 <code>默认启用</code> 可重试读取。要显式禁用可重试读取，请在部署的连接字符串中指定 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/connection-string/#mongodb-urioption-urioption.retryReads"><code>retryReads=false</code></a></p><p class="note note-primary">可重试读取操作</p><table><thead><tr><th>方法</th><th>内容描述</th></tr></thead><tbody><tr><td><code>Collection.aggregate</code><br><code>Collection.count</code><br><code>Collection.countDocuments</code><br><code>Collection.distinct</code><br><code>Collection.estimatedDocumentCount</code><br><code>Collection.find</code><br><code>Database.aggregate</code></td><td>CRUD API 读取操作</td></tr><tr><td><code>Collection.watch</code><br><code>Database.watch</code><br><code>MongoClient.watch</code></td><td>更改流操作</td></tr><tr><td><code>MongoClient.listDatabases</code><br><code>Database.listCollections</code><br><code>Collection.listIndexes</code></td><td>枚举操作</td></tr><tr><td>由 <code>Collection.find</code> 支持的 GridFS 操作（例如 <code>GridFSBucket.openDownloadStream</code> ）</td><td>GridFS 文件下载操作</td></tr></tbody></table><p class="note note-primary">行为</p><ul><li><p>持久性网络错误</p><p>MongoDB 可重试写入仅进行一次重试。这有助于解决暂时性网络错误和副本集选举，但不会解决持久性网络错误</p></li><li><p>故障转移期</p><p>如果驱动程序在目标副本集或分片集群分片中找不到健康的主节点，则驱动程序会等待 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/connection-string/#mongodb-urioption-urioption.serverSelectionTimeoutMS"><code>serverSelectionTimeoutMS</code></a> 毫秒以确定新的主节点，然后再重试。可重试写入不会解决故障转移时间超过 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/connection-string/#mongodb-urioption-urioption.serverSelectionTimeoutMS"><code>serverSelectionTimeoutMS</code></a> 的实例</p></li></ul><h2 id="读取关注"><a class="markdownIt-Anchor" href="#读取关注"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/read-concern/">读取关注</a></h2><p><code>readConcern</code> 选项允许你控制从 <code>复制集</code> 和 <code>分片集群</code> 读取数据的一致性和隔离性</p><p>通过有效地使用 <code>写关注</code> 和 <code>读关注</code>，你可以适当地调整 <code>一致性</code> 和 <code>可用性</code> 的保证级别，例如等待以保证更强的一致性，或放松一致性要求以提供更高的可用性</p><p>将MongoDB驱动程序更新到MongoDB 3.2或更高版本以支持读关注</p><p>从 MongoDB 4.4 开始，副本集和分片集群支持设置全局默认读关注。未指定显式读取关注的操作会继承全局默认读取关注设置。有关详细信息，请参阅 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/command/setDefaultRWConcern/#mongodb-dbcommand-dbcmd.setDefaultRWConcern"><code>setDefaultRWConcern</code></a></p><p class="note note-primary">读关注级别</p><p><a target="_blank" rel="noopener" href="https://zhangquan.me/2023/02/23/mongodb-du-cao-zuo-shi-wu-zhi-readconcern/#toc-heading-2">读关注详解</a></p><p>类似读隔离级别</p><ul><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/read-concern-local/"><code>local</code></a> 返回单个节点最新数据，主节点同时进行写操作 可能会读取到不一致的数据</li><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/read-concern-available/"><code>available</code></a> 牺牲一致性，提供一种最低延迟的读取。可能会返回孤儿文档</li><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/read-concern-majority/"><code>majority</code></a> 保证读取的数据已被大多数副本集成员写入确认</li><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/read-concern-linearizable/"><code>linearizable</code></a> 保证线性一致性读取，意味着读取操作会等待前面的写操作完成</li><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/read-concern-snapshot/"><code>snapshot</code></a> 快照读取，确保读取的是已提交的数据，只能在副本集和分片集群下使用，需要维护和创建快照</li></ul><p class="note note-primary">使用</p><p>对于不在多文档事务中的操作，可以指定 <code>readConcern</code> 级别作为支持读关注的命令和方法的选项</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-attr">readConcern</span>: &#123; <span class="hljs-attr">level</span>: &lt;level&gt; &#125;<br></code></pre></td></tr></table></figure><p><code>db.collection.find()</code> 指定读取关注级别：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">collection</span>.<span class="hljs-title function_">find</span>().<span class="hljs-title function_">readConcern</span>(&lt;level&gt;)<br></code></pre></td></tr></table></figure><h2 id="写入关注"><a class="markdownIt-Anchor" href="#写入关注"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/write-concern/">写入关注</a></h2><p>写关注描述了从 MongoDB 请求对独立 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/program/mongod/#mongodb-binary-bin.mongod"><code>mongod</code></a> 或副本集或分片集群的写入操作的确认级别。在分片集群中， <code>mongos</code> 实例会将写关注传递给分片</p><div class="note note-warning"><p>对于多文档事务，您在事务级别设置写关注，而不是在单个操作级别。不要为事务中的单个写操作显式设置写关注</p><p>如果您为多文档事务指定了一个 <code>&quot;majority&quot;</code> 写关注点，并且该事务未能复制到计算出的大多数副本集成员，那么该事务可能不会立即在副本集成员上回滚。副本集最终是一致的。始终在所有副本集成员上应用或回滚事务</p></div><p class="note note-primary">写关注规范</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">&#123; <span class="hljs-attr">w</span>: &lt;value&gt;, <span class="hljs-attr">j</span>: &lt;boolean&gt;, <span class="hljs-attr">wtimeout</span>: &lt;number&gt; &#125;<br></code></pre></td></tr></table></figure><ul><li><code>w</code> 选项请求确认写操作已传播到指定数量的mongod实例或具有指定标记的mongod实例<ul><li>0：表示不进行写入确认</li><li>1：主节点的写入确认</li></ul></li><li><code>j</code> 选项请求 MongoDB 确认写入操作已写入磁盘日志，以便在系统出现故障时进行恢复</li><li><code>wtimeout</code> 此选项指定写入关注的时间限制（以毫秒为单位）. <code>wtimeout</code> 仅适用于大于 <code>1</code> 的 <code>w</code> 值</li></ul><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/write-concern/#write-concern-specification">具体用法</a></p><h2 id="curd概念"><a class="markdownIt-Anchor" href="#curd概念"></a> CURD概念</h2><p><strong>查询计划、性能和分析</strong></p><ul><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/query-plans/">查询计划</a></li><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/query-optimization/">查询优化</a></li><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/tutorial/analyze-query-plan/">分析查询性能</a></li><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/write-performance/">写操作性能</a></li></ul><p><strong>原子性、一致性和分布式操作</strong></p><ul><li><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/write-operations-atomicity/">原子性和事务</a></p></li><li><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/read-isolation-consistency-recency/">读隔离性，一致性和近因性</a></p></li><li><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/distributed-queries/">分布式查询</a></p></li></ul><h3 id="查询计划"><a class="markdownIt-Anchor" href="#查询计划"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/query-plans/">查询计划</a></h3><p>对于查询，MongoDB查询优化器在给定可用索引的情况下选择并缓存效率最高的查询计划。最有效的查询计划的评估是基于查询执行计划在查询计划评估候选计划时执行的“工作单元”(works)的数量</p><div class="note note-warning"><p>Work units 是一种计算模型，用于确定 MongoDB 数据库中查询和更新操作的执行时间</p><p>Work units 的计算基于 MongoDB 的查询和更新操作，包括 find、insert、update 和 delete 等操作。每次查询或更新操作都会消耗一个或多个 work units</p></div><p>关联的计划缓存条目用于具有相同查询形状的后续查询</p><p><img src="/2023/04/14/MongoDB/%E6%9F%A5%E8%AF%A2%E8%AE%A1%E5%88%92%E5%99%A8%E9%80%BB%E8%BE%91.png" srcset="/img/loading.gif" lazyload alt="查询计划器逻辑"></p><p class="note note-primary">计划缓存条目状态</p><div class="note note-warning"><p>查询计划是指MongoDB查询优化器生成的用于执行查询的计划</p><p>查询形状（Query Shape）指的是查询的结构或模式，包括查询的字段条件和操作符等。它描述了查询逻辑结构，例如使用哪些字段进行过、排序或聚合等操作。查询形状可以通过查询语句来定义，如使用find()方法或聚合管道操作符</p><p>查询条目（Query Stage）查询计划中的每个步骤或阶段，用于处理查询的不同操作。每个查询阶段都会接收输入数据，并根据查询形状的定义对数据进行处理然后将结果传递下一个阶段。常见的查询段包括索引描、过滤、投影、排序和聚合等</p><p>查询形状和查询条目之间存在联系。查询形状定义了查询的逻辑结构，而查询条目则是实际执行查询的步骤</p><p>MongoDB 通过查询形状来定义查询操作，并指导查询引擎如何检索文档。查询形状中的每个部分都可以用来表示查询的不同方面，例如查询条件、查询范围和查询模式等。开发人员可以根据查询形状来设计和优化查询语句，以获得最佳的查询性能</p></div><p>从 MongoDB 4.2 开始，缓存条目与状态相关联：</p><table><thead><tr><th style="text-align:left">State</th><th style="text-align:left">Description</th></tr></thead><tbody><tr><td style="text-align:left"><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/query-plans/#std-label-cache-entry-missing">Missing （缺失）</a></td><td style="text-align:left">缓存中不存在此形状的条目。<br>对于查询，如果形状的缓存条目状态为 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/query-plans/#std-label-cache-entry-missing">Missing</a>：<br>⁣⁣⁣⁣　⁣⁣⁣⁣1.对候选计划进行评估并选出一个获胜的计划。<br>⁣⁣⁣⁣　⁣⁣⁣⁣2.所选计划以其 <code>works</code> 值添加到处于 Inactive 状态的缓存中。</td></tr><tr><td style="text-align:left"><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/query-plans/#std-label-cache-entry-inactive">Inactive （不活跃）</a></td><td style="text-align:left">缓存中的条目是此形状的占位符条目。也就是说，计划者已经看到了形状并计算了其成本（<code>works</code>值）并存储为占位符条目，但查询形状<code>不</code>用于生成查询计划。<br>对于查询，如果形状的缓存条目状态 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/query-plans/#std-label-cache-entry-inactive">Inactive:</a><br>⁣⁣⁣⁣　1.对候选计划进行评估并选出一个获胜的计划。<br>⁣⁣⁣⁣　2. 将所选计划的 <code>works</code> 值与非活动条目的值进行比较。如果所选计划的 <code>works</code> 值为：<br>　　<strong>小于或等于 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/query-plans/#std-label-cache-entry-inactive">Inactive</a> 条目的</strong><br>　　　所选计划将替换占位符 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/query-plans/#std-label-cache-entry-inactive">Inactive</a> 条目，并具有 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/query-plans/#std-label-cache-entry-active">Active</a> 状态<br>　　　如果在替换发生之前， <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/query-plans/#std-label-cache-entry-inactive">Inactive</a> 条目变为 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/query-plans/#std-label-cache-entry-active">Active</a>（例如，由于另一个查询操作），则仅当新活动条目的<code>works</code>值大于所选计划时，才会替换该新活动条目<br>　　<strong>大于 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/query-plans/#std-label-cache-entry-inactive">Inactive</a> 条目的</strong><br>　　　 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/query-plans/#std-label-cache-entry-inactive">Inactive</a> 条目保留，但其 <code>works</code> 值增加</td></tr><tr><td style="text-align:left"><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/query-plans/#std-label-cache-entry-active">Active （活跃）</a></td><td style="text-align:left">缓存中的条目用于获胜计划。规划器可以使用该条目来生成查询计划。<br>对于查询，如果形状的缓存条目状态为 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/query-plans/#std-label-cache-entry-active">Active:</a><br>活动条目用于生成查询计划。<br>规划器还会评估条目的性能，如果条目的 <code>works</code>值不再符合选择标准，它将转换为非<a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/core/query-plans/cache-entry-inactive">活动</a>状态。</td></tr></tbody></table><p>有关触发计划缓存更改的其他场景，请参阅 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/query-plans/#std-label-query-plans-plan-cache-flushes">计划缓存刷新</a></p><p class="note note-primary">查询计划和高速缓存</p><p>要查看给定查询的查询计划信息，可以使用 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.explain/#mongodb-method-db.collection.explain"><code>db.collection.explain()</code></a> 或 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/cursor.explain/#mongodb-method-cursor.explain"><code>cursor.explain()</code></a></p><p>从 MongoDB 4.2 开始，您可以使用 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/planCacheStats/#mongodb-pipeline-pipe.-planCacheStats"><code>$planCacheStats</code></a> 聚合阶段来查看集合的计划缓存信息</p><p class="note note-primary">计划缓存刷新</p><p>如果 <code>mongod</code> 重新启动或关闭，查询计划缓存不会保留。此外：</p><ul><li>索引或集合删除等目录操作会清除计划缓存</li><li>最近最少使用（LRU）高速缓存替换机制将清除最近最少访问的高速缓存条目</li></ul><p>用户还可以：</p><ul><li>使用 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/PlanCache.clear/#mongodb-method-PlanCache.clear"><code>PlanCache.clear()</code></a> 方法手动清除整个计划缓存</li><li>使用 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/PlanCache.clearPlansByQuery/#mongodb-method-PlanCache.clearPlansByQuery"><code>PlanCache.clearPlansByQuery()</code></a>方法手动清除特定计划缓存条目</li></ul><h3 id="查询优化"><a class="markdownIt-Anchor" href="#查询优化"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/query-optimization/">查询优化</a></h3><p>索引通过减少查询操作需要处理的数据量来提高读操作的效率。这简化了与在MongoDB中完成查询相关的工作</p><p class="note note-primary">创建索引以支持读操作</p><p>如果应用程序查询特定字段或字段集上的集合，那么查询字段上的 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/index-single/">索引</a> 或字段集上的 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/index-compound/">复合索引</a> 可以防止查询扫描整个集合来查找和返回查询结果。有关索引的更多信息，请参阅 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/indexes/">MongoDB中索引中完整文档</a></p><p><strong>例如</strong></p><p>应用程序在 <code>type</code> 字段上查询 <code>inventory</code> 集合。 <code>type</code> 字段的值是用户驱动的</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> typeValue = &lt;someUserInput&gt;;<br>db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">find</span>( &#123; <span class="hljs-attr">type</span>: typeValue &#125; );<br></code></pre></td></tr></table></figure><p>要提高此查询的性能，请向 <code>type</code> 字段上的 <code>inventory</code> 集合添加升序或降序索引。在 <code>mongosh</code> 中，可以使用 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.createIndex/#mongodb-method-db.collection.createIndex"><code>db.collection.createIndex()</code></a> 方法创建索引：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">createIndex</span>( &#123; <span class="hljs-attr">type</span>: <span class="hljs-number">1</span> &#125; )<br></code></pre></td></tr></table></figure><p>该索引可以防止上述对 <code>type</code> 的查询扫描整个集合以返回结果</p><p class="note note-primary">其他优化</p><ul><li><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/query-optimization/#query-selectivity">查询选择性</a></p><p>指查询条件排除或过滤掉集合中文档的程度。查询选择性可以决定查询是否可以有效地使用索引，甚至根本不使用索引</p><p>更具选择性的查询匹配较小比例的文档。例如，对唯一 <code>_id</code> 字段的等式匹配具有高度选择性，因为它最多可以匹配一个文档</p><p>例如，不等运算符 <code>$nin</code> 和 <code>$ne</code> 的选择性不是很强，因为它们通常匹配索引的很大一部分。因此，在许多情况下，带有索引的 <code>$nin</code> 或 <code>$ne</code> 查询的性能可能并不比必须扫描集合中所有文档的 <code>$nin</code> 或 <code>$ne</code> 查询好</p></li><li><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/query-optimization/#covered-query">索引覆盖查询</a></p><p>查询中的所有字段都是索引的一部分</p><p>结果中返回的所有字段都在同一个索引中</p><ul><li><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/query-optimization/#embedded-documents">嵌套文档</a></p><p>索引覆盖同样适用在嵌套文档中</p></li><li><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/query-optimization/#multikey-covering">多键覆盖</a></p><p>如果索引跟踪哪个或哪些字段导致索引成为多键，则多键索引可以覆盖对非数组字段的查询</p><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/index-multikey/#std-label-index-type-multikey">多键索引</a> 不能覆盖对 <code>数组字段</code> 的查询</p></li><li><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/query-optimization/#performance">性能</a></p><p>为索引包含查询所需的所有字段，所以MongoDB既可以匹配 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/tutorial/query-documents/#std-label-read-operations-query-document">查询条件</a> ，又可以仅使用索引返回结果</p><p>仅查询索引要比查询索引之外的文档快得多。索引键通常比它们编目的文档小，索引通常在RAM中可用，或按顺序位于磁盘上</p></li><li><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/query-optimization/#limitations">局限性</a></p><p>地理空间索引无法覆盖查询</p><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/index-multikey/#std-label-index-type-multikey">多键索引</a> 不能覆盖对数组字段的查询</p><p>在 <code>mongos</code> 上运行时，如果索引包含分片键，则索引只能覆盖分片集合上的查询</p></li></ul></li></ul><h3 id="分析查询性能"><a class="markdownIt-Anchor" href="#分析查询性能"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/tutorial/analyze-query-plan/">分析查询性能</a></h3><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/explain-results/#std-label-explain-results">查询计划返回结果</a> 可能会因 MongoDB 版本而异</p><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/cursor.explain/#mongodb-method-cursor.explain"><code>cursor.explain(&quot;executionStats&quot;)</code></a> 和 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.explain/#mongodb-method-db.collection.explain"><code>db.collection.explain(&quot;executionStats&quot;)</code></a> 方法提供有关查询性能的统计信息。这些统计信息可用于衡量查询是否以及如何使用索引。有关详细信息，请参阅 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.explain/#mongodb-method-db.collection.explain"><code>db.collection.explain()</code></a></p><p class="note note-primary">测试数据</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">insertMany</span>(<br>    [<br>        &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">1</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;f1&quot;</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;food&quot;</span>, <span class="hljs-attr">quantity</span>: <span class="hljs-number">500</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">2</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;f2&quot;</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;food&quot;</span>, <span class="hljs-attr">quantity</span>: <span class="hljs-number">100</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">3</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;p1&quot;</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;paper&quot;</span>, <span class="hljs-attr">quantity</span>: <span class="hljs-number">200</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">4</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;p2&quot;</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;paper&quot;</span>, <span class="hljs-attr">quantity</span>: <span class="hljs-number">150</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">5</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;f3&quot;</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;food&quot;</span>, <span class="hljs-attr">quantity</span>: <span class="hljs-number">300</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">6</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;t1&quot;</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;toys&quot;</span>, <span class="hljs-attr">quantity</span>: <span class="hljs-number">500</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">7</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;a1&quot;</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;apparel&quot;</span>, <span class="hljs-attr">quantity</span>: <span class="hljs-number">250</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">8</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;a2&quot;</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;apparel&quot;</span>, <span class="hljs-attr">quantity</span>: <span class="hljs-number">400</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">9</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;t2&quot;</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;toys&quot;</span>, <span class="hljs-attr">quantity</span>: <span class="hljs-number">50</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">10</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;f4&quot;</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;food&quot;</span>, <span class="hljs-attr">quantity</span>: <span class="hljs-number">75</span> &#125;<br>    ]<br>)<br></code></pre></td></tr></table></figure><p class="note note-primary">没有索引的查询</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">find</span>(<span class="hljs-params"></span><br><span class="hljs-params">    &#123;</span><br><span class="hljs-params">        quantity: &#123;</span><br><span class="hljs-params">            $gte: <span class="hljs-number">100</span>,</span><br><span class="hljs-params">            $lte: <span class="hljs-number">200</span></span><br><span class="hljs-params">        &#125;</span><br><span class="hljs-params">    &#125;</span><br><span class="hljs-params"></span>)<br><br><br>&#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">2</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;f2&quot;</span>, <span class="hljs-string">&quot;type&quot;</span> : <span class="hljs-string">&quot;food&quot;</span>, <span class="hljs-string">&quot;quantity&quot;</span> : <span class="hljs-number">100</span> &#125;<br>&#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">3</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;p1&quot;</span>, <span class="hljs-string">&quot;type&quot;</span> : <span class="hljs-string">&quot;paper&quot;</span>, <span class="hljs-string">&quot;quantity&quot;</span> : <span class="hljs-number">200</span> &#125;<br>&#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">4</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;p2&quot;</span>, <span class="hljs-string">&quot;type&quot;</span> : <span class="hljs-string">&quot;paper&quot;</span>, <span class="hljs-string">&quot;quantity&quot;</span> : <span class="hljs-number">150</span> &#125;<br></code></pre></td></tr></table></figure><p>要查看所选的查询计划，请将 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/cursor.explain/#mongodb-method-cursor.explain"><code>cursor.explain(&quot;executionStats&quot;)</code></a> 游标方法链接到查找命令的末尾：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">find</span>(<br>    &#123;<br>        <span class="hljs-attr">quantity</span>: &#123;<br>            <span class="hljs-attr">$gte</span>: <span class="hljs-number">100</span>,<br>            <span class="hljs-attr">$lte</span>: <span class="hljs-number">200</span><br>        &#125;<br>    &#125;<br>).<span class="hljs-title function_">explain</span>(<span class="hljs-string">&quot;executionStats&quot;</span>)<br></code></pre></td></tr></table></figure><p>返回以下执行计划：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><code class="hljs javascript">&#123;<br>    <span class="hljs-string">&quot;explainVersion&quot;</span> : <span class="hljs-string">&quot;1&quot;</span>,<br>    <span class="hljs-string">&quot;queryPlanner&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;namespace&quot;</span> : <span class="hljs-string">&quot;test.inventory&quot;</span>,<br>        <span class="hljs-string">&quot;indexFilterSet&quot;</span> : <span class="hljs-literal">false</span>,<br>        <span class="hljs-string">&quot;parsedQuery&quot;</span> : &#123;<br>            <span class="hljs-string">&quot;$and&quot;</span> : [ <br>                &#123;<br>                    <span class="hljs-string">&quot;quantity&quot;</span> : &#123;<br>                        <span class="hljs-string">&quot;$lte&quot;</span> : <span class="hljs-number">200.0</span><br>                    &#125;<br>                &#125;, <br>                &#123;<br>                    <span class="hljs-string">&quot;quantity&quot;</span> : &#123;<br>                        <span class="hljs-string">&quot;$gte&quot;</span> : <span class="hljs-number">100.0</span><br>                    &#125;<br>                &#125;<br>            ]<br>        &#125;,<br>        <span class="hljs-string">&quot;maxIndexedOrSolutionsReached&quot;</span> : <span class="hljs-literal">false</span>,<br>        <span class="hljs-string">&quot;maxIndexedAndSolutionsReached&quot;</span> : <span class="hljs-literal">false</span>,<br>        <span class="hljs-string">&quot;maxScansToExplodeReached&quot;</span> : <span class="hljs-literal">false</span>,<br>        <span class="hljs-string">&quot;winningPlan&quot;</span> : &#123;<br>            <span class="hljs-string">&quot;stage&quot;</span> : <span class="hljs-string">&quot;COLLSCAN&quot;</span>,<br>            <span class="hljs-string">&quot;filter&quot;</span> : &#123;<br>                <span class="hljs-string">&quot;$and&quot;</span> : [ <br>                    &#123;<br>                        <span class="hljs-string">&quot;quantity&quot;</span> : &#123;<br>                            <span class="hljs-string">&quot;$lte&quot;</span> : <span class="hljs-number">200.0</span><br>                        &#125;<br>                    &#125;, <br>                    &#123;<br>                        <span class="hljs-string">&quot;quantity&quot;</span> : &#123;<br>                            <span class="hljs-string">&quot;$gte&quot;</span> : <span class="hljs-number">100.0</span><br>                        &#125;<br>                    &#125;<br>                ]<br>            &#125;,<br>            <span class="hljs-string">&quot;direction&quot;</span> : <span class="hljs-string">&quot;forward&quot;</span><br>        &#125;,<br>        <span class="hljs-string">&quot;rejectedPlans&quot;</span> : []<br>    &#125;,<br>    <span class="hljs-string">&quot;executionStats&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;executionSuccess&quot;</span> : <span class="hljs-literal">true</span>,<br>        <span class="hljs-string">&quot;nReturned&quot;</span> : <span class="hljs-number">3</span>,<br>        <span class="hljs-string">&quot;executionTimeMillis&quot;</span> : <span class="hljs-number">24</span>,<br>        <span class="hljs-string">&quot;totalKeysExamined&quot;</span> : <span class="hljs-number">0</span>,<br>        <span class="hljs-string">&quot;totalDocsExamined&quot;</span> : <span class="hljs-number">10</span>,<br>        <span class="hljs-string">&quot;executionStages&quot;</span> : &#123;<br>            <span class="hljs-string">&quot;stage&quot;</span> : <span class="hljs-string">&quot;COLLSCAN&quot;</span>,<br>            <span class="hljs-string">&quot;filter&quot;</span> : &#123;<br>                <span class="hljs-string">&quot;$and&quot;</span> : [ <br>                    &#123;<br>                        <span class="hljs-string">&quot;quantity&quot;</span> : &#123;<br>                            <span class="hljs-string">&quot;$lte&quot;</span> : <span class="hljs-number">200.0</span><br>                        &#125;<br>                    &#125;, <br>                    &#123;<br>                        <span class="hljs-string">&quot;quantity&quot;</span> : &#123;<br>                            <span class="hljs-string">&quot;$gte&quot;</span> : <span class="hljs-number">100.0</span><br>                        &#125;<br>                    &#125;<br>                ]<br>            &#125;,<br>            <span class="hljs-string">&quot;nReturned&quot;</span> : <span class="hljs-number">3</span>,<br>            <span class="hljs-string">&quot;executionTimeMillisEstimate&quot;</span> : <span class="hljs-number">0</span>,<br>            <span class="hljs-string">&quot;works&quot;</span> : <span class="hljs-number">12</span>,<br>            <span class="hljs-string">&quot;advanced&quot;</span> : <span class="hljs-number">3</span>,<br>            <span class="hljs-string">&quot;needTime&quot;</span> : <span class="hljs-number">8</span>,<br>            <span class="hljs-string">&quot;needYield&quot;</span> : <span class="hljs-number">0</span>,<br>            <span class="hljs-string">&quot;saveState&quot;</span> : <span class="hljs-number">1</span>,<br>            <span class="hljs-string">&quot;restoreState&quot;</span> : <span class="hljs-number">1</span>,<br>            <span class="hljs-string">&quot;isEOF&quot;</span> : <span class="hljs-number">1</span>,<br>            <span class="hljs-string">&quot;direction&quot;</span> : <span class="hljs-string">&quot;forward&quot;</span>,<br>            <span class="hljs-string">&quot;docsExamined&quot;</span> : <span class="hljs-number">10</span><br>        &#125;<br>    &#125;,<br>    <span class="hljs-string">&quot;command&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;find&quot;</span> : <span class="hljs-string">&quot;inventory&quot;</span>,<br>        <span class="hljs-string">&quot;filter&quot;</span> : &#123;<br>            <span class="hljs-string">&quot;quantity&quot;</span> : &#123;<br>                <span class="hljs-string">&quot;$gte&quot;</span> : <span class="hljs-number">100.0</span>,<br>                <span class="hljs-string">&quot;$lte&quot;</span> : <span class="hljs-number">200.0</span><br>            &#125;<br>        &#125;,<br>        <span class="hljs-string">&quot;$db&quot;</span> : <span class="hljs-string">&quot;test&quot;</span><br>    &#125;,<br>    <span class="hljs-string">&quot;serverInfo&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;host&quot;</span> : <span class="hljs-string">&quot;4ffcfe6b7fdf&quot;</span>,<br>        <span class="hljs-string">&quot;port&quot;</span> : <span class="hljs-number">27017</span>,<br>        <span class="hljs-string">&quot;version&quot;</span> : <span class="hljs-string">&quot;5.0.5&quot;</span>,<br>        <span class="hljs-string">&quot;gitVersion&quot;</span> : <span class="hljs-string">&quot;d65fd89df3fc039b5c55933c0f71d647a54510ae&quot;</span><br>    &#125;,<br>    <span class="hljs-string">&quot;serverParameters&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;internalQueryFacetBufferSizeBytes&quot;</span> : <span class="hljs-number">104857600</span>,<br>        <span class="hljs-string">&quot;internalQueryFacetMaxOutputDocSizeBytes&quot;</span> : <span class="hljs-number">104857600</span>,<br>        <span class="hljs-string">&quot;internalLookupStageIntermediateDocumentMaxSizeBytes&quot;</span> : <span class="hljs-number">104857600</span>,<br>        <span class="hljs-string">&quot;internalDocumentSourceGroupMaxMemoryBytes&quot;</span> : <span class="hljs-number">104857600</span>,<br>        <span class="hljs-string">&quot;internalQueryMaxBlockingSortMemoryUsageBytes&quot;</span> : <span class="hljs-number">104857600</span>,<br>        <span class="hljs-string">&quot;internalQueryProhibitBlockingMergeOnMongoS&quot;</span> : <span class="hljs-number">0</span>,<br>        <span class="hljs-string">&quot;internalQueryMaxAddToSetBytes&quot;</span> : <span class="hljs-number">104857600</span>,<br>        <span class="hljs-string">&quot;internalDocumentSourceSetWindowFieldsMaxMemoryBytes&quot;</span> : <span class="hljs-number">104857600</span><br>    &#125;,<br>    <span class="hljs-string">&quot;ok&quot;</span> : <span class="hljs-number">1.0</span><br>&#125;<br></code></pre></td></tr></table></figure><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/explain-results/#mongodb-data-explain.queryPlanner.winningPlan.queryPlan.stage">执行计划返回结果详解</a></p><ul><li><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/explain-results/#mongodb-data-explain.queryPlanner.winningPlan.queryPlan.stage"><code>queryPlanner.winningPlan.queryPlan.stage</code></a> 显示 <code>COLLSCAN</code> 以指示集合扫描</p><ul><li><code>COLLSCAN</code> 用于集合扫描</li><li><code>IXSCAN</code> 用于扫描索引键</li><li><code>FETCH</code> 用于检索文档</li><li><code>GROUP</code> 用于对文档进行分组</li><li><code>SHARD_MERGE</code> 用于合并分片的结果</li><li><code>SHARDING_FILTER</code> 用于从分片中过滤掉孤立文档</li></ul><p>集合扫描表明 <code>mongod</code> 必须逐个文档扫描整个集合文档才能识别结果。这通常是一项昂贵的操作，可能会导致查询速度变慢</p></li><li><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/explain-results/#mongodb-data-explain.executionStats.nReturned"><code>executionStats.nReturned</code></a> 显示 <code>3</code> 表示查询匹配并返回三个文档</p></li><li><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/explain-results/#mongodb-data-explain.executionStats.totalKeysExamined"><code>executionStats.totalKeysExamined</code></a> 显示 <code>0</code> 以指示此查询未使用索引</p></li><li><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/explain-results/#mongodb-data-explain.executionStats.totalDocsExamined"><code>executionStats.totalDocsExamined</code></a> 显示 <code>10</code> 表示 MongoDB 必须扫描十个文档（即集合中的所有文档）才能找到三个匹配的文档</p></li></ul><p><code>匹配</code> 文档的数量和 <code>检查</code> 文档的数量之间的差异可能表明，为了提高效率，查询可能会受益于索引的使用</p><p class="note note-primary">使用索引</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">createIndex</span>(<br>    &#123;<br>        <span class="hljs-attr">quantity</span>: <span class="hljs-number">1</span><br>    &#125;<br>)<br></code></pre></td></tr></table></figure><p>查看执行计划：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">find</span>(<br>    &#123;<br>        <span class="hljs-attr">quantity</span>: &#123;<br>            <span class="hljs-attr">$gte</span>: <span class="hljs-number">100</span>,<br>            <span class="hljs-attr">$lte</span>: <span class="hljs-number">200</span><br>        &#125;<br>    &#125;<br>).<span class="hljs-title function_">explain</span>(<span class="hljs-string">&quot;executionStats&quot;</span>)<br></code></pre></td></tr></table></figure><p>返回的查询计划：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><code class="hljs javascript">&#123;<br>    <span class="hljs-string">&quot;explainVersion&quot;</span> : <span class="hljs-string">&quot;1&quot;</span>,<br>    <span class="hljs-string">&quot;queryPlanner&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;namespace&quot;</span> : <span class="hljs-string">&quot;test.inventory&quot;</span>,<br>        <span class="hljs-string">&quot;indexFilterSet&quot;</span> : <span class="hljs-literal">false</span>,<br>        <span class="hljs-string">&quot;parsedQuery&quot;</span> : &#123;<br>            <span class="hljs-string">&quot;$and&quot;</span> : [ <br>                &#123;<br>                    <span class="hljs-string">&quot;quantity&quot;</span> : &#123;<br>                        <span class="hljs-string">&quot;$lte&quot;</span> : <span class="hljs-number">200.0</span><br>                    &#125;<br>                &#125;, <br>                &#123;<br>                    <span class="hljs-string">&quot;quantity&quot;</span> : &#123;<br>                        <span class="hljs-string">&quot;$gte&quot;</span> : <span class="hljs-number">100.0</span><br>                    &#125;<br>                &#125;<br>            ]<br>        &#125;,<br>        <span class="hljs-string">&quot;maxIndexedOrSolutionsReached&quot;</span> : <span class="hljs-literal">false</span>,<br>        <span class="hljs-string">&quot;maxIndexedAndSolutionsReached&quot;</span> : <span class="hljs-literal">false</span>,<br>        <span class="hljs-string">&quot;maxScansToExplodeReached&quot;</span> : <span class="hljs-literal">false</span>,<br>        <span class="hljs-string">&quot;winningPlan&quot;</span> : &#123;<br>            <span class="hljs-string">&quot;stage&quot;</span> : <span class="hljs-string">&quot;FETCH&quot;</span>,<br>            <span class="hljs-string">&quot;inputStage&quot;</span> : &#123;<br>                <span class="hljs-string">&quot;stage&quot;</span> : <span class="hljs-string">&quot;IXSCAN&quot;</span>,<br>                <span class="hljs-string">&quot;keyPattern&quot;</span> : &#123;<br>                    <span class="hljs-string">&quot;quantity&quot;</span> : <span class="hljs-number">1.0</span><br>                &#125;,<br>                <span class="hljs-string">&quot;indexName&quot;</span> : <span class="hljs-string">&quot;quantity_1&quot;</span>,<br>                <span class="hljs-string">&quot;isMultiKey&quot;</span> : <span class="hljs-literal">false</span>,<br>                <span class="hljs-string">&quot;multiKeyPaths&quot;</span> : &#123;<br>                    <span class="hljs-string">&quot;quantity&quot;</span> : []<br>                &#125;,<br>                <span class="hljs-string">&quot;isUnique&quot;</span> : <span class="hljs-literal">false</span>,<br>                <span class="hljs-string">&quot;isSparse&quot;</span> : <span class="hljs-literal">false</span>,<br>                <span class="hljs-string">&quot;isPartial&quot;</span> : <span class="hljs-literal">false</span>,<br>                <span class="hljs-string">&quot;indexVersion&quot;</span> : <span class="hljs-number">2</span>,<br>                <span class="hljs-string">&quot;direction&quot;</span> : <span class="hljs-string">&quot;forward&quot;</span>,<br>                <span class="hljs-string">&quot;indexBounds&quot;</span> : &#123;<br>                    <span class="hljs-string">&quot;quantity&quot;</span> : [ <br>                        <span class="hljs-string">&quot;[100.0, 200.0]&quot;</span><br>                    ]<br>                &#125;<br>            &#125;<br>        &#125;,<br>        <span class="hljs-string">&quot;rejectedPlans&quot;</span> : []<br>    &#125;,<br>    <span class="hljs-string">&quot;executionStats&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;executionSuccess&quot;</span> : <span class="hljs-literal">true</span>,<br>        <span class="hljs-string">&quot;nReturned&quot;</span> : <span class="hljs-number">3</span>,<br>        <span class="hljs-string">&quot;executionTimeMillis&quot;</span> : <span class="hljs-number">1</span>,<br>        <span class="hljs-string">&quot;totalKeysExamined&quot;</span> : <span class="hljs-number">3</span>,<br>        <span class="hljs-string">&quot;totalDocsExamined&quot;</span> : <span class="hljs-number">3</span>,<br>        <span class="hljs-string">&quot;executionStages&quot;</span> : &#123;<br>            <span class="hljs-string">&quot;stage&quot;</span> : <span class="hljs-string">&quot;FETCH&quot;</span>,<br>            <span class="hljs-string">&quot;nReturned&quot;</span> : <span class="hljs-number">3</span>,<br>            <span class="hljs-string">&quot;executionTimeMillisEstimate&quot;</span> : <span class="hljs-number">0</span>,<br>            <span class="hljs-string">&quot;works&quot;</span> : <span class="hljs-number">4</span>,<br>            <span class="hljs-string">&quot;advanced&quot;</span> : <span class="hljs-number">3</span>,<br>            <span class="hljs-string">&quot;needTime&quot;</span> : <span class="hljs-number">0</span>,<br>            <span class="hljs-string">&quot;needYield&quot;</span> : <span class="hljs-number">0</span>,<br>            <span class="hljs-string">&quot;saveState&quot;</span> : <span class="hljs-number">0</span>,<br>            <span class="hljs-string">&quot;restoreState&quot;</span> : <span class="hljs-number">0</span>,<br>            <span class="hljs-string">&quot;isEOF&quot;</span> : <span class="hljs-number">1</span>,<br>            <span class="hljs-string">&quot;docsExamined&quot;</span> : <span class="hljs-number">3</span>,<br>            <span class="hljs-string">&quot;alreadyHasObj&quot;</span> : <span class="hljs-number">0</span>,<br>            <span class="hljs-string">&quot;inputStage&quot;</span> : &#123;<br>                <span class="hljs-string">&quot;stage&quot;</span> : <span class="hljs-string">&quot;IXSCAN&quot;</span>,<br>                <span class="hljs-string">&quot;nReturned&quot;</span> : <span class="hljs-number">3</span>,<br>                <span class="hljs-string">&quot;executionTimeMillisEstimate&quot;</span> : <span class="hljs-number">0</span>,<br>                <span class="hljs-string">&quot;works&quot;</span> : <span class="hljs-number">4</span>,<br>                <span class="hljs-string">&quot;advanced&quot;</span> : <span class="hljs-number">3</span>,<br>                <span class="hljs-string">&quot;needTime&quot;</span> : <span class="hljs-number">0</span>,<br>                <span class="hljs-string">&quot;needYield&quot;</span> : <span class="hljs-number">0</span>,<br>                <span class="hljs-string">&quot;saveState&quot;</span> : <span class="hljs-number">0</span>,<br>                <span class="hljs-string">&quot;restoreState&quot;</span> : <span class="hljs-number">0</span>,<br>                <span class="hljs-string">&quot;isEOF&quot;</span> : <span class="hljs-number">1</span>,<br>                <span class="hljs-string">&quot;keyPattern&quot;</span> : &#123;<br>                    <span class="hljs-string">&quot;quantity&quot;</span> : <span class="hljs-number">1.0</span><br>                &#125;,<br>                <span class="hljs-string">&quot;indexName&quot;</span> : <span class="hljs-string">&quot;quantity_1&quot;</span>,<br>                <span class="hljs-string">&quot;isMultiKey&quot;</span> : <span class="hljs-literal">false</span>,<br>                <span class="hljs-string">&quot;multiKeyPaths&quot;</span> : &#123;<br>                    <span class="hljs-string">&quot;quantity&quot;</span> : []<br>                &#125;,<br>                <span class="hljs-string">&quot;isUnique&quot;</span> : <span class="hljs-literal">false</span>,<br>                <span class="hljs-string">&quot;isSparse&quot;</span> : <span class="hljs-literal">false</span>,<br>                <span class="hljs-string">&quot;isPartial&quot;</span> : <span class="hljs-literal">false</span>,<br>                <span class="hljs-string">&quot;indexVersion&quot;</span> : <span class="hljs-number">2</span>,<br>                <span class="hljs-string">&quot;direction&quot;</span> : <span class="hljs-string">&quot;forward&quot;</span>,<br>                <span class="hljs-string">&quot;indexBounds&quot;</span> : &#123;<br>                    <span class="hljs-string">&quot;quantity&quot;</span> : [ <br>                        <span class="hljs-string">&quot;[100.0, 200.0]&quot;</span><br>                    ]<br>                &#125;,<br>                <span class="hljs-string">&quot;keysExamined&quot;</span> : <span class="hljs-number">3</span>,<br>                <span class="hljs-string">&quot;seeks&quot;</span> : <span class="hljs-number">1</span>,<br>                <span class="hljs-string">&quot;dupsTested&quot;</span> : <span class="hljs-number">0</span>,<br>                <span class="hljs-string">&quot;dupsDropped&quot;</span> : <span class="hljs-number">0</span><br>            &#125;<br>        &#125;<br>    &#125;,<br>    <span class="hljs-string">&quot;command&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;find&quot;</span> : <span class="hljs-string">&quot;inventory&quot;</span>,<br>        <span class="hljs-string">&quot;filter&quot;</span> : &#123;<br>            <span class="hljs-string">&quot;quantity&quot;</span> : &#123;<br>                <span class="hljs-string">&quot;$gte&quot;</span> : <span class="hljs-number">100.0</span>,<br>                <span class="hljs-string">&quot;$lte&quot;</span> : <span class="hljs-number">200.0</span><br>            &#125;<br>        &#125;,<br>        <span class="hljs-string">&quot;$db&quot;</span> : <span class="hljs-string">&quot;test&quot;</span><br>    &#125;,<br>    <span class="hljs-string">&quot;serverInfo&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;host&quot;</span> : <span class="hljs-string">&quot;4ffcfe6b7fdf&quot;</span>,<br>        <span class="hljs-string">&quot;port&quot;</span> : <span class="hljs-number">27017</span>,<br>        <span class="hljs-string">&quot;version&quot;</span> : <span class="hljs-string">&quot;5.0.5&quot;</span>,<br>        <span class="hljs-string">&quot;gitVersion&quot;</span> : <span class="hljs-string">&quot;d65fd89df3fc039b5c55933c0f71d647a54510ae&quot;</span><br>    &#125;,<br>    <span class="hljs-string">&quot;serverParameters&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;internalQueryFacetBufferSizeBytes&quot;</span> : <span class="hljs-number">104857600</span>,<br>        <span class="hljs-string">&quot;internalQueryFacetMaxOutputDocSizeBytes&quot;</span> : <span class="hljs-number">104857600</span>,<br>        <span class="hljs-string">&quot;internalLookupStageIntermediateDocumentMaxSizeBytes&quot;</span> : <span class="hljs-number">104857600</span>,<br>        <span class="hljs-string">&quot;internalDocumentSourceGroupMaxMemoryBytes&quot;</span> : <span class="hljs-number">104857600</span>,<br>        <span class="hljs-string">&quot;internalQueryMaxBlockingSortMemoryUsageBytes&quot;</span> : <span class="hljs-number">104857600</span>,<br>        <span class="hljs-string">&quot;internalQueryProhibitBlockingMergeOnMongoS&quot;</span> : <span class="hljs-number">0</span>,<br>        <span class="hljs-string">&quot;internalQueryMaxAddToSetBytes&quot;</span> : <span class="hljs-number">104857600</span>,<br>        <span class="hljs-string">&quot;internalDocumentSourceSetWindowFieldsMaxMemoryBytes&quot;</span> : <span class="hljs-number">104857600</span><br>    &#125;,<br>    <span class="hljs-string">&quot;ok&quot;</span> : <span class="hljs-number">1.0</span><br>&#125;<br></code></pre></td></tr></table></figure><ul><li><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/explain-results/#mongodb-data-explain.queryPlanner.winningPlan.queryPlan.inputStage"><code>queryPlanner.winningPlan.queryPlan.inputStage.stage</code></a> 显示 <code>IXSCAN</code> 说明使用索引</p></li><li><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/explain-results/#mongodb-data-explain.executionStats.nReturned"><code>executionStats.nReturned</code></a> 显示 <code>3</code> 表示查询匹配并返回三个文档</p></li><li><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/explain-results/#mongodb-data-explain.executionStats.totalKeysExamined"><code>executionStats.totalKeysExamined</code></a> 显示 <code>3</code> 表示 MongoDB 扫描了三个索引条目。检查的键数与返回的文档数相匹配，这意味着 <code>mongod</code> 只需检查索引键即可返回结果。 <code>mongod</code> 不必扫描所有文档，只需将三个匹配的文档拉入内存即可。这导致非常有效的查询</p></li><li><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/explain-results/#mongodb-data-explain.executionStats.totalDocsExamined"><code>executionStats.totalDocsExamined</code></a> 显示 <code>3</code> 表示MongoDB扫描了三个文档</p></li></ul><p>如果没有索引，查询将扫描整个 <code>10</code> 文档集合以返回 <code>3</code> 匹配文档。查询还必须扫描每个文档的全部内容，可能会将它们拉入内存。这会导致昂贵且可能很慢的查询操作</p><p>使用索引运行时，查询会扫描 <code>3</code> 索引条目和 <code>3</code> 文档以返回 <code>3</code> 匹配文档，从而实现非常高效的查询</p><h3 id="原子性和事务"><a class="markdownIt-Anchor" href="#原子性和事务"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/write-operations-atomicity/">原子性和事务</a></h3><p class="note note-primary">原子性</p><p>在MongoDB中，写操作在单个文档级别上是原子的，即使该操作修改了单个文档中嵌入的多个文档</p><p class="note note-primary">多文档事务</p><p>当单个写操作（例如 <code>db.collection.updateMany()</code> ）修改多个文档时，每个文档的修改是原子的，但整个操作不是原子的</p><p>当执行多文档写操作时，无论是通过单个写操作还是通过多个写操作，其他操作都可能会交错</p><p>对于需要对多个文档（在单个或多个集合中）进行读写原子性的情况，MongoDB 支持多文档事务：</p><ul><li>在 4.0 版本中，MongoDB 支持副本集上的多文档事务</li><li>在 4.2 版本中，MongoDB 引入了分布式事务，增加了对分片集群上的多文档事务的支持，并合并了现有的对副本集上的多文档事务的支持</li></ul><p>有关 MongoDB 中事务的详细信息，请参阅 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/transactions/">事务</a> 页面</p><blockquote><p>在大多数情况下，多文档事务会比单文档写入产生更大的性能成本，并且多文档事务的可用性不应取代有效的模式设计。对于许多场景，非规范化数据模型（嵌入式文档和数组）将继续成为您的数据和用例的最佳选择。也就是说，对于许多场景，适当地建模数据将最大限度地减少对多文档事务的需求。</p></blockquote><p class="note note-primary">并发控制</p><p>并发控制允许多个应用程序并发运行，而不会导致数据不一致或冲突</p><p>对文档的 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/command/findAndModify/#mongodb-dbcommand-dbcmd.findAndModify"><code>findAndModify</code></a> 操作是原子的：如果查找条件与文档匹配，则对该文档执行更新。在当前更新完成之前，对该文档的并发查询和其他更新不会受到影响</p><p><strong>例如</strong></p><p>包含两个文档的集合：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">myCollection</span>.<span class="hljs-title function_">insertMany</span>( [<br>   &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">b</span>: <span class="hljs-number">1</span> &#125;,<br>   &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">b</span>: <span class="hljs-number">1</span> &#125;<br>] )<br></code></pre></td></tr></table></figure><p>以下两个 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/command/findAndModify/#mongodb-dbcommand-dbcmd.findAndModify"><code>findAndModify</code></a> 操作同时运行：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">myCollection</span>.<span class="hljs-title function_">findAndModify</span>( &#123;<br>   <span class="hljs-attr">query</span>: &#123; <span class="hljs-attr">a</span>: <span class="hljs-number">1</span> &#125;,<br>   <span class="hljs-attr">update</span>: &#123; <span class="hljs-attr">$inc</span>: &#123; <span class="hljs-attr">b</span>: <span class="hljs-number">1</span> &#125;, <span class="hljs-attr">$set</span>: &#123; <span class="hljs-attr">a</span>: <span class="hljs-number">2</span> &#125; &#125;<br>&#125; )<br></code></pre></td></tr></table></figure><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/command/findAndModify/#mongodb-dbcommand-dbcmd.findAndModify"><code>findAndModify</code></a> 操作完成后，保证两个文档中的 <code>a</code> 和 <code>b</code> 都设置为 <code>2</code></p><p>说明并发是互斥的</p><p>还可以在字段上创 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/index-unique/#std-label-index-type-unique">唯一索引</a> ，以便它只能具有唯一值。这可以防止插入和更新创建重复数据。您可以在多个字段上创建唯一索引，以确保字段值的组合是唯一的。有关示例，请参阅 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.findAndModify/#std-label-upsert-and-unique-index">findAndModify() 使用唯一索引更新或插入</a></p><h3 id="读隔离性一致性和因果一致"><a class="markdownIt-Anchor" href="#读隔离性一致性和因果一致"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/read-isolation-consistency-recency/">读隔离性，一致性和因果一致</a></h3><p class="note note-primary">隔离保证</p><p><strong><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/read-isolation-consistency-recency/#read-uncommitted">读未提交</a></strong></p><p>根据读取的关注点，客户端可以在 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/glossary/#std-term-durable">持久化</a> 写入之前看到写入的结果：</p><ul><li>无论写操作的写关注点如何，使用 “local” 或 “available” 读取关注点的其他客户端可以在写操作被确认给发出该写操作的客户端之前看到写操作的结果</li><li>使用 “local” 或 “available” 读取关注点的客户端可以读取可能在副本集故障切换期间被回滚的数据</li></ul><p>在多文档事务中，当事务提交时，事务中所做的所有数据更改都会保存并在事务外部可见。也就是说，事务不会只提交其中的一些更改同时回滚其他更改</p><p>在事务提交之前，事务中所做的数据更改对事务外部是不可见的</p><p>然而，当事务写入多个分片时，并不是所有外部读取操作都需要等待已提交事务的结果在所有分片间可见。例如，如果事务已提交，写入 1 在分片 A 上可见，但写入 2 在分片 B 上尚不可见，在使用“local”读取关注点时，可以读取写入 1 的结果而无需看到写入 2</p><p>读未提交是 <code>默认的隔离级别</code>，适用于mongod独立实例以及复制集和分片群集</p><div class="note note-primary"><p>一致性保证</p></div><p><strong><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/read-isolation-consistency-recency/#read-uncommitted-and-single-document-atomicity">读未提交和单文档原子性</a></strong></p><p>写操作对于单个文档是原子的；也就是说，如果写操作正在更新文档中的多个字段，那么读操作永远不会看到只更新了一部分字段的文档。然而，即使客户端可能没有看到部分更新的文档，读取未提交意味着并发读操作仍然可以在更改变得持久之前看到更新的文档</p><p><span class="green-line">在独立的 mongod 实例中，对于单个文档的一组读取和写入操作是可串行化的。在副本集中，只有在没有回滚的情况下，对于单个文档的一系列读取和写入操作才是可串行化的</span></p><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/read-isolation-consistency-recency/#read-uncommitted-and-multiple-document-write"><strong>读未提交和多文档写入</strong></a></p><ul><li>当单个写操作（例如 db.collection.updateMany()）修改多个文档时，每个文档的修改是原子的，但整个操作不是原子的</li><li>执行多文档写入操作时，无论是通过单个写操作还是多个写操作，其他操作都可能交错执行</li><li>对于需要对多个文档进行读取和写入操作（在单个或多个集合中）的情况，MongoDB 支持多文档事务<ul><li>在 4.0 版本中，MongoDB 在副本集上支持多文档事务</li><li>在 4.2 版本中，MongoDB 引入分布式事务，为分片集群添加了对多文档事务的支持，并整合了对副本集的多文档事务支持</li></ul></li></ul><p>在大多数情况下，相对于单文档写入，多文档事务会带来更大的性能开销，并且多文档事务的可用性不应该取代有效的架构设计。对于许多场景，规范化的数据模型（嵌入式文档和数组）仍然是数据和使用案例的最佳选择。也就是说，对于许多场景，适当地对数据进行建模将最小化对多文档事务的需求</p><p><strong><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/read-isolation-consistency-recency/#cursor-snapshot">游标快照</a></strong></p><ul><li>在某些情况下，MongoDB 游标可以返回同一文档多次。当游标返回文档时，其他操作可以与查询交错执行。如果这些操作之一更改了查询所使用的索引上的索引字段，那么游标可能会多次返回相同的文档</li><li>使用唯一索引的查询在某些情况下可能会返回重复的值。如果一个使用唯一索引的游标与具有相同唯一值的文档的删除和插入交错执行，那么游标可能会从不同的文档中两次返回相同的唯一值</li><li>可以使用读关注点的 <code>snapshot</code> 来解决这个问题</li></ul><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/read-isolation-consistency-recency/#real-time-order"><strong>实时顺序</strong></a></p><p>将读关注设置为 <code>linearizable</code>，将写关注设置为 <code>majority</code>，那么这种读写模型组合可以使多个线程可以在单个文档上执行读写操作，就好像单个线程实时执行了这些操作一样 ; 也就是说，这些读写的相应计划被认为是线性的</p><div class="note note-primary"><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/read-isolation-consistency-recency/#causal-consistency"><strong>因果一致性</strong></a></p></div><p>如果一个操作在逻辑上依赖于前一个操作，那么这两个操作之间存在因果关系。例如，一个删除基于特定条件的所有文档的写操作和一个后续的读操作来验证删除操作之间存在因果关系。</p><p>使用因果一致性会话，MongoDB 按照它们的因果关系对操作进行排序，并保证客户端所观察到的结果与这些因果关系一致</p><p><strong>客户端会话和因果一致性保证</strong></p><p>为了提供因果一致性，MongoDB 3.6 在客户端会话中启用了因果一致性。因果一致性会话表示具有 <code>majority</code> 读关注点的读操作序列和具有 <code>majority</code> 写关注点的写操作序列之间具有因果关系，并通过它们的顺序来体现。应用程序必须确保一次只能有一个线程在客户端会话中执行这些操作</p><p><strong>重要提示</strong>：客户端会话仅对以下情况保证因果一致性：</p><ul><li><p>具有 <code>majority</code> 读关注点的读操作，即返回的数据已被副本集中的大多数成员确认并持久化</p></li><li><p>具有 <code>majority</code> 写关注点的写操作，即要求写操作在副本集的多数投票成员上应用之后才返回确认信息</p></li></ul><p>当客户端发出带有 <code>majority</code> 读关注点的读操作和带有 <code>majority</code> 写关注点的写操作序列时，客户端会在每个操作中包含会话信息</p><p>对于与会话关联的每个带有 <code>majority</code> 读关注点的读操作和带有 <code>majority</code> 写关注点的写操作，MongoDB 返回操作时间和集群时间，即使操作出现错误。客户端会话会跟踪操作时间和集群时间（线性一致）</p><p>因果一致性会话中的操作与会话外的操作不隔离。如果并发写操作在会话的写操作和读操作之间交错执行，会话的读操作可能会返回反映在会话的写操作之后发生的写操作的结果</p><p><strong>因果一致性使用</strong></p><p>考虑一个名为 items 的集合，该集合维护各种物品的当前和历史数据。只有历史数据具有非空的结束日期。如果某个物品的 SKU 值发生更改，需要将具有旧 SKU 值的文档进行更新，并在之后插入一个新文档以包含当前的 SKU 值。客户端可以使用因果一致性会话确保更新发生在插入之前</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ClientSession</span> <span class="hljs-variable">session1</span> <span class="hljs-operator">=</span> client.startSession(ClientSessionOptions.builder().causallyConsistent(<span class="hljs-literal">true</span>).build());<br><span class="hljs-type">Date</span> <span class="hljs-variable">currentDate</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();<br>MongoCollection&lt;Document&gt; items = client.getDatabase(<span class="hljs-string">&quot;test&quot;</span>)<br>        .withReadConcern(ReadConcern.MAJORITY)<br>        .withWriteConcern(WriteConcern.MAJORITY.withWTimeout(<span class="hljs-number">1000</span>, TimeUnit.MILLISECONDS))<br>        .getCollection(<span class="hljs-string">&quot;test&quot;</span>);<br><br>items.updateOne(session1, eq(<span class="hljs-string">&quot;sku&quot;</span>, <span class="hljs-string">&quot;111&quot;</span>), set(<span class="hljs-string">&quot;end&quot;</span>, currentDate));<br><br><span class="hljs-type">Document</span> <span class="hljs-variable">document</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Document</span>(<span class="hljs-string">&quot;sku&quot;</span>, <span class="hljs-string">&quot;nuts-111&quot;</span>)<br>        .append(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;Pecans&quot;</span>)<br>        .append(<span class="hljs-string">&quot;start&quot;</span>, currentDate);<br>items.insertOne(session1, document);<br></code></pre></td></tr></table></figure><h1 id="聚合"><a class="markdownIt-Anchor" href="#聚合"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/aggregation/">聚合</a></h1><p>聚合操作处理数据记录并返回计算结果(诸如统计平均值，求和等)。聚合操作组值来自多个文档，可以对分组数据执行各种操作以返回单个结果。聚合操作包含三类：</p><ul><li>单一作用聚合：提供了对常见聚合过程的简单访问，操作都从单个集合聚合文档</li><li>聚合管道是一个数据聚合的框架，模型基于数据处理流水线的概念。文档进入多级管道，将文档转换为聚合结果</li><li>从 MongoDB 5.0 开始，不推荐使用 map-reduce</li></ul><p><a target="_blank" rel="noopener" href="https://docs.mongoing.com/can-kao/yun-suan-fu/aggregation-pipeline-operators">聚合管道操作符</a></p><h2 id="单一作用聚合"><a class="markdownIt-Anchor" href="#单一作用聚合"></a> 单一作用聚合</h2><p>这类单一作用的聚合函数。 所有这些操作都聚合来自单个集合的文档。虽然这些操作提供了对公共聚合过程的简单访问，但它们缺乏聚合管道和map-Reduce的灵活性和功能</p><table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.estimatedDocumentCount/"><code>db.collection.estimatedDocumentCount()</code></a></td><td>忽略查询条件，返回集合或视图中所有文档的计数</td></tr><tr><td><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/reference/method/db.collection.count/"><code>db.collection.count()</code></a></td><td>返回与find()集合或视图的查询匹配的文档计数 。<br>等同于 db.collection.find(query).count()构造</td></tr><tr><td><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/reference/method/db.collection.distinct/"><code>db.collection.distinct()</code></a></td><td>在单个集合或视图中查找指定字段的不同值，并在数组中返回结果</td></tr></tbody></table><p><strong>测试数据</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">insertMany</span>(<br>    [<br>        &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">1</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;f1&quot;</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;food&quot;</span>, <span class="hljs-attr">quantity</span>: <span class="hljs-number">500</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">2</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;f2&quot;</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;food&quot;</span>, <span class="hljs-attr">quantity</span>: <span class="hljs-number">100</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">3</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;p1&quot;</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;paper&quot;</span>, <span class="hljs-attr">quantity</span>: <span class="hljs-number">200</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">4</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;p2&quot;</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;paper&quot;</span>, <span class="hljs-attr">quantity</span>: <span class="hljs-number">150</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">5</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;f3&quot;</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;food&quot;</span>, <span class="hljs-attr">quantity</span>: <span class="hljs-number">300</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">6</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;t1&quot;</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;toys&quot;</span>, <span class="hljs-attr">quantity</span>: <span class="hljs-number">500</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">7</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;a1&quot;</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;apparel&quot;</span>, <span class="hljs-attr">quantity</span>: <span class="hljs-number">250</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">8</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;a2&quot;</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;apparel&quot;</span>, <span class="hljs-attr">quantity</span>: <span class="hljs-number">400</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">9</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;t2&quot;</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;toys&quot;</span>, <span class="hljs-attr">quantity</span>: <span class="hljs-number">50</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">10</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;f4&quot;</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;food&quot;</span>, <span class="hljs-attr">quantity</span>: <span class="hljs-number">75</span> &#125;<br>    ]<br>)<br></code></pre></td></tr></table></figure><p class="note note-primary">estimatedDocumentCount()</p><p>忽略查询条件，返回集合或视图中所有文档的计数</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">estimatedDocumentCount</span>()<br><br><br><span class="hljs-number">10</span><br></code></pre></td></tr></table></figure><p class="note note-primary">count()</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">count</span>(<br>    &#123;<br>       <span class="hljs-attr">quantity</span>: &#123;<br>           <span class="hljs-attr">$gte</span>: <span class="hljs-number">300</span><br>       &#125; <br>    &#125;<br>)<br><br><br><span class="hljs-number">4</span><br></code></pre></td></tr></table></figure><p class="note note-primary">distinct()</p><ul><li>type 字段去重</li><li>查询条件 quantity &gt;= 100</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">distinct</span>(<br>    <span class="hljs-string">&quot;type&quot;</span>,<br>    &#123;<br>       <span class="hljs-attr">quantity</span>: &#123;<br>           <span class="hljs-attr">$gte</span>: <span class="hljs-number">100</span><br>       &#125; <br>    &#125;<br>)<br><br><br>[<br>    <span class="hljs-string">&quot;apparel&quot;</span>,<br>    <span class="hljs-string">&quot;food&quot;</span>,<br>    <span class="hljs-string">&quot;paper&quot;</span>,<br>    <span class="hljs-string">&quot;toys&quot;</span><br>]<br></code></pre></td></tr></table></figure><h2 id="聚合管道"><a class="markdownIt-Anchor" href="#聚合管道"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/reference/operator/aggregation-pipeline/">聚合管道</a></h2><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/sql-aggregation-comparison/">SQL和Mongo聚合对比</a></p><p class="note note-primary">聚合框架</p><p>MongoDB 聚合框架（Aggregation Framework）是一个计算框架，它可以：</p><ul><li>作用在一个或几个集合上</li><li>对集合中的数据进行的一系列运算</li><li>将这些数据转化为期望的形式</li></ul><p>从效果而言，聚合框架相当于 SQL 查询中的GROUP BY、 LEFT OUTER JOIN 、 AS等</p><p class="note note-primary">聚合与管道</p><p>聚合管道阶段文档</p><p>整个聚合运算过程称为管道（Pipeline），它是由多个阶段（Stage）组成的， 每个管道：</p><ul><li>接受一系列文档（原始数据）</li><li>每个阶段对这些文档进行一系列运算</li><li>结果文档输出给下一个阶段</li></ul><p class="note note-primary">完整的聚合管道示例</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">orders</span>.<span class="hljs-title function_">insertMany</span>( [<br>   &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Pepperoni&quot;</span>, <span class="hljs-attr">size</span>: <span class="hljs-string">&quot;small&quot;</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">19</span>,<br>     <span class="hljs-attr">quantity</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">date</span>: <span class="hljs-title class_">ISODate</span>( <span class="hljs-string">&quot;2021-03-13T08:14:30Z&quot;</span> ) &#125;,<br>   &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Pepperoni&quot;</span>, <span class="hljs-attr">size</span>: <span class="hljs-string">&quot;medium&quot;</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">20</span>,<br>     <span class="hljs-attr">quantity</span>: <span class="hljs-number">20</span>, date : <span class="hljs-title class_">ISODate</span>( <span class="hljs-string">&quot;2021-03-13T09:13:24Z&quot;</span> ) &#125;,<br>   &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Pepperoni&quot;</span>, <span class="hljs-attr">size</span>: <span class="hljs-string">&quot;large&quot;</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">21</span>,<br>     <span class="hljs-attr">quantity</span>: <span class="hljs-number">30</span>, date : <span class="hljs-title class_">ISODate</span>( <span class="hljs-string">&quot;2021-03-17T09:22:12Z&quot;</span> ) &#125;,<br>   &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Cheese&quot;</span>, <span class="hljs-attr">size</span>: <span class="hljs-string">&quot;small&quot;</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">12</span>,<br>     <span class="hljs-attr">quantity</span>: <span class="hljs-number">15</span>, date : <span class="hljs-title class_">ISODate</span>( <span class="hljs-string">&quot;2021-03-13T11:21:39.736Z&quot;</span> ) &#125;,<br>   &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">4</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Cheese&quot;</span>, <span class="hljs-attr">size</span>: <span class="hljs-string">&quot;medium&quot;</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">13</span>,<br>     <span class="hljs-attr">quantity</span>:<span class="hljs-number">50</span>, date : <span class="hljs-title class_">ISODate</span>( <span class="hljs-string">&quot;2022-01-12T21:23:13.331Z&quot;</span> ) &#125;,<br>   &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">5</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Cheese&quot;</span>, <span class="hljs-attr">size</span>: <span class="hljs-string">&quot;large&quot;</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">14</span>,<br>     <span class="hljs-attr">quantity</span>: <span class="hljs-number">10</span>, date : <span class="hljs-title class_">ISODate</span>( <span class="hljs-string">&quot;2022-01-12T05:08:13Z&quot;</span> ) &#125;,<br>   &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">6</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Vegan&quot;</span>, <span class="hljs-attr">size</span>: <span class="hljs-string">&quot;small&quot;</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">17</span>,<br>     <span class="hljs-attr">quantity</span>: <span class="hljs-number">10</span>, date : <span class="hljs-title class_">ISODate</span>( <span class="hljs-string">&quot;2021-01-13T05:08:13Z&quot;</span> ) &#125;,<br>   &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">7</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Vegan&quot;</span>, <span class="hljs-attr">size</span>: <span class="hljs-string">&quot;medium&quot;</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">18</span>,<br>     <span class="hljs-attr">quantity</span>: <span class="hljs-number">10</span>, date : <span class="hljs-title class_">ISODate</span>( <span class="hljs-string">&quot;2021-01-13T05:10:13Z&quot;</span> ) &#125;<br>] )<br></code></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">orders</span>.<span class="hljs-title function_">aggregate</span>(<br>    [<br>        <span class="hljs-comment">// 第 1 阶段：按披萨大小过滤披萨订单文档</span><br>        &#123;<br>            <span class="hljs-attr">$match</span>: &#123;<span class="hljs-attr">size</span>: <span class="hljs-string">&quot;medium&quot;</span>&#125;<br>        &#125;,<br>        <br>        <span class="hljs-comment">// 第 2 阶段：按披萨名称分组进行聚合运算</span><br>        &#123;<br>            <span class="hljs-attr">$group</span>: &#123;<br>                        <span class="hljs-attr">_id</span>: <span class="hljs-string">&quot;$name&quot;</span>,<br>                        <span class="hljs-attr">totalQuantity</span>: &#123; <span class="hljs-attr">$sum</span>: <span class="hljs-string">&quot;$quantity&quot;</span> &#125;,<br>                        <span class="hljs-attr">totalPrice</span>: &#123;<span class="hljs-attr">$sum</span>:&#123; <span class="hljs-attr">$multiply</span>: [<span class="hljs-string">&quot;$price&quot;</span>, <span class="hljs-string">&quot;$quantity&quot;</span>]&#125;&#125;<br>                    &#125;<br>        &#125;<br>    ]<br>)<br><br><br><br><span class="hljs-comment">/* 1 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-string">&quot;Vegan&quot;</span>,<br>    <span class="hljs-string">&quot;totalQuantity&quot;</span> : <span class="hljs-number">10.0</span>,<br>    <span class="hljs-string">&quot;totalPrice&quot;</span> : <span class="hljs-number">180.0</span><br>&#125;<br><br><span class="hljs-comment">/* 2 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-string">&quot;Pepperoni&quot;</span>,<br>    <span class="hljs-string">&quot;totalQuantity&quot;</span> : <span class="hljs-number">20.0</span>,<br>    <span class="hljs-string">&quot;totalPrice&quot;</span> : <span class="hljs-number">400.0</span><br>&#125;<br><br><span class="hljs-comment">/* 3 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-string">&quot;Cheese&quot;</span>,<br>    <span class="hljs-string">&quot;totalQuantity&quot;</span> : <span class="hljs-number">50.0</span>,<br>    <span class="hljs-string">&quot;totalPrice&quot;</span> : <span class="hljs-number">650.0</span><br>&#125;<br></code></pre></td></tr></table></figure><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/reference/operator/aggregation/match/#mongodb-pipeline-pipe.-match"><code>$match</code></a> 阶段：</p><ul><li>过滤 <code>size</code> 为 <code>medium</code> 的比萨订单</li><li>将剩余的文档传递到 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/reference/operator/aggregation/group/#mongodb-pipeline-pipe.-group"><code>$group</code></a> 阶段</li></ul><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/reference/operator/aggregation/group/#mongodb-pipeline-pipe.-group"><code>$group</code></a> 阶段：</p><ul><li>按 pizza <code>name</code> 对剩余文档进行分组</li><li>使用 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/reference/operator/aggregation/sum/#mongodb-group-grp.-sum"><code>$sum</code></a> 计算每个比萨 <code>name</code> 的总订单 <code>quantity</code> 。总数存储在聚合管道返回的 <code>totalQuantity</code> 字段中</li></ul><h3 id="聚合阶段"><a class="markdownIt-Anchor" href="#聚合阶段"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/aggregation-pipeline/">聚合阶段</a></h3><table><thead><tr><th>阶段</th><th>描述</th></tr></thead><tbody><tr><td><a href>$addFields</a></td><td>向文档添加新字段。与project类似，addFields重塑了流中的每个文档;具体而言，通过向输出文档添加新字段，该文档包含输入文档和新添加字段中的现有字段。 <code>$set</code>是的别名<code>$addFields</code>。</td></tr><tr><td><a href>$bucket</a></td><td>根据指定的表达式和存储段边界将传入文档分类为称为存储段的组。</td></tr><tr><td><a href>$bucketAuto</a></td><td>根据指定的表达式将传入的文档分类为特定数量的组(称为存储桶)。自动确定存储桶边界，以尝试将文档均匀地分配到指定数量的存储桶中。</td></tr><tr><td><a href>$collStats</a></td><td>返回有关集合或视图的统计信息。</td></tr><tr><td><a href>$count</a></td><td>返回聚合管道此阶段的文档数量计数。</td></tr><tr><td><a href>$facet</a></td><td>在同一阶段的同一组输入文档上处理多个聚合管道。支持在一个阶段中创建能够表征多维或多面数据的多面聚合。</td></tr><tr><td><a href>$geoNear</a></td><td>基于与地理空间点的接近度返回有序的文档流。将<code>$match</code>，<code>$sort</code>和<code>$limit</code>的功能合并到地理空间数据中。输出文档包括附加距离字段，并且可以包括位置标识符字段。</td></tr><tr><td><a href>$graphLookup</a></td><td>对集合执行递归搜索。对于每个输出文档，添加一个新的 array 字段，该字段包含该文档的递归搜索的遍历结果。</td></tr><tr><td><a href>$group</a></td><td>按指定的标识符表达式对文档进行分组，并将累加器表达式(如果指定)应用于每个 group。消耗所有输入文档，并为每个不同的 group 输出一个文档。输出文档仅包含标识符字段，如果指定，则包含累积字段。</td></tr><tr><td><a href>$indexStats</a></td><td>返回有关集合的每个索引的使用的统计信息。</td></tr><tr><td><a href>$limit</a></td><td>将未修改的前 n 个文档传递给管道，其中 n 是指定的限制。对于每个输入文档，输出一个文档(对于前 n 个文档)或零文档(在前 n 个文档之后)。</td></tr><tr><td><a href>$listSessions</a></td><td>列出所有活动时间已足够长以传播到<code>system.sessions</code>集合的会话。</td></tr><tr><td><a href>$lookup</a></td><td>对同一数据库中的另一个集合执行左外连接，以从“已连接”集合中过滤文档以进行处理。</td></tr><tr><td><a href>$match</a></td><td>过滤文档流以仅允许匹配的文档未经修改地传递到下一个管道阶段。 <code>$match</code>使用标准的 MongoDB 查询。对于每个输入文档，输出一个文档(匹配)或零文档(不匹配)。</td></tr><tr><td><a href>$merge</a></td><td>将聚合管道的结果文档写入集合。该阶段可以将结果合并（插入新文档，合并文档，替换文档，保留现有文档，使操作失败，使用自定义更新管道处理文档）将结果合并到输出集合中。要使用该<code>$merge</code>阶段，它必须是管道中的最后一个阶段。 <em>4.2版中的新功能。</em></td></tr><tr><td><a href>$out</a></td><td>将聚合管道的结果文档写入集合。要使用$out阶段，它必须是管道中的最后一个阶段。</td></tr><tr><td><a href>$planCacheStats</a></td><td>返回集合的计划缓存信息。</td></tr><tr><td><a href>$project</a></td><td>重塑流中的每个文档，例如通过添加新字段或删除现有字段。对于每个输入文档，输出一个文档。 另请参阅<code>$unset</code>删除现有字段。</td></tr><tr><td><a href>$redact</a></td><td>通过基于文档本身中存储的信息限制每个文档的内容来重塑流中的每个文档。包含<code>$project</code>和<code>$match</code>的功能。可用于实现字段级编辑。对于每个输入文档，输出一个或零个文档。</td></tr><tr><td><a href>$replaceRoot</a></td><td>用指定的嵌入文档替换文档。该操作将替换输入文档中的所有现有字段，包括<code>_id</code>字段。指定嵌入在输入文档中的文档，以将嵌入的文档提升到顶部级别。 <code>$replaceWith</code>是<code>$replaceRoot</code>阶段的别名 。</td></tr><tr><td><a href>$replaceWith</a></td><td>用指定的嵌入文档替换文档。该操作将替换输入文档中的所有现有字段，包括<code>_id</code>字段。指定嵌入在输入文档中的文档，以将嵌入的文档提升到顶部级别。 <code>$replaceWith</code>是<code>$replaceRoot</code>阶段的别名 。</td></tr><tr><td><a href>$sample</a></td><td>从输入中随机选择指定数量的文档。</td></tr><tr><td><a href>$set</a></td><td>将新字段添加到文档。与<code>$project</code>相似，<code>$set</code>重塑流中的每个文档；具体而言，通过向输出文档添加新字段，该输出文档既包含输入文档中的现有字段，又包含新添加的字段。 <code>$set</code>是<code>$addFields</code>阶段的别名。</td></tr><tr><td><a href>$skip</a></td><td>跳过前 n 个文档，其中 n 是指定的跳过编号，并将未修改的其余文档传递给管道。对于每个输入文档，输出零文档(对于前 n 个文档)或一个文档(如果在前 n 个文档之后)。</td></tr><tr><td><a href>$sort</a></td><td>按指定的排序 key 重新排序文档流。只有顺序改变;文档保持不变。对于每个输入文档，输出一个文档。</td></tr><tr><td><a href>sortByCount</a></td><td>根据指定表达式的 value 对传入文档进行分组，然后计算每个不同 group 中的文档计数。</td></tr><tr><td><a href>$unset</a></td><td>从文档中删除/排除字段。 <code>$unset</code>是<code>$project</code>删除字段的阶段的别名。</td></tr><tr><td><a href>$unwind</a></td><td>将数组展开后形成一个独立的文档。每个输出文档都使用元素 value 替换 array。对于每个输入文档，输出 n 个文档，其中 n 是 array 元素的数量，对于空 array 可以为零。</td></tr></tbody></table><h3 id="match"><a class="markdownIt-Anchor" href="#match"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/match/#mongodb-pipeline-pipe.-match">$match</a></h3><p>过滤文档以仅允许匹配的文档未经修改地传递到下一个管道阶段</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">&#123; <span class="hljs-attr">$match</span>: &#123; &lt;query&gt; &#125; &#125;<br></code></pre></td></tr></table></figure><p>测试数据</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">articles</span>.<span class="hljs-title function_">insertMany</span>(<br>    [<br>        &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;512bc95fe835e68f199c8686&quot;</span>), <span class="hljs-string">&quot;author&quot;</span> : <span class="hljs-string">&quot;dave&quot;</span>, <span class="hljs-string">&quot;score&quot;</span> : <span class="hljs-number">80</span>, <span class="hljs-string">&quot;views&quot;</span> : <span class="hljs-number">100</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;512bc962e835e68f199c8687&quot;</span>), <span class="hljs-string">&quot;author&quot;</span> : <span class="hljs-string">&quot;dave&quot;</span>, <span class="hljs-string">&quot;score&quot;</span> : <span class="hljs-number">85</span>, <span class="hljs-string">&quot;views&quot;</span> : <span class="hljs-number">521</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;55f5a192d4bede9ac365b257&quot;</span>), <span class="hljs-string">&quot;author&quot;</span> : <span class="hljs-string">&quot;ahn&quot;</span>, <span class="hljs-string">&quot;score&quot;</span> : <span class="hljs-number">60</span>, <span class="hljs-string">&quot;views&quot;</span> : <span class="hljs-number">1000</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;55f5a192d4bede9ac365b258&quot;</span>), <span class="hljs-string">&quot;author&quot;</span> : <span class="hljs-string">&quot;li&quot;</span>, <span class="hljs-string">&quot;score&quot;</span> : <span class="hljs-number">55</span>, <span class="hljs-string">&quot;views&quot;</span> : <span class="hljs-number">5000</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;55f5a1d3d4bede9ac365b259&quot;</span>), <span class="hljs-string">&quot;author&quot;</span> : <span class="hljs-string">&quot;annT&quot;</span>, <span class="hljs-string">&quot;score&quot;</span> : <span class="hljs-number">60</span>, <span class="hljs-string">&quot;views&quot;</span> : <span class="hljs-number">50</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;55f5a1d3d4bede9ac365b25a&quot;</span>), <span class="hljs-string">&quot;author&quot;</span> : <span class="hljs-string">&quot;li&quot;</span>, <span class="hljs-string">&quot;score&quot;</span> : <span class="hljs-number">94</span>, <span class="hljs-string">&quot;views&quot;</span> : <span class="hljs-number">999</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;55f5a1d3d4bede9ac365b25b&quot;</span>), <span class="hljs-string">&quot;author&quot;</span> : <span class="hljs-string">&quot;ty&quot;</span>, <span class="hljs-string">&quot;score&quot;</span> : <span class="hljs-number">95</span>, <span class="hljs-string">&quot;views&quot;</span> : <span class="hljs-number">1000</span> &#125;<br>    ]<br>)<br></code></pre></td></tr></table></figure><p>简单数据匹配</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">articles</span>.<span class="hljs-title function_">aggregate</span>(<br>    [<br>        &#123;<span class="hljs-attr">$match</span>: &#123;<span class="hljs-attr">author</span>: <span class="hljs-string">&quot;dave&quot;</span>&#125;&#125;<br>    ]<br>)<br><br><br><span class="hljs-comment">/* 1 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;512bc95fe835e68f199c8686&quot;</span>),<br>    <span class="hljs-string">&quot;author&quot;</span> : <span class="hljs-string">&quot;dave&quot;</span>,<br>    <span class="hljs-string">&quot;score&quot;</span> : <span class="hljs-number">80.0</span>,<br>    <span class="hljs-string">&quot;views&quot;</span> : <span class="hljs-number">100.0</span><br>&#125;<br><br><span class="hljs-comment">/* 2 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;512bc962e835e68f199c8687&quot;</span>),<br>    <span class="hljs-string">&quot;author&quot;</span> : <span class="hljs-string">&quot;dave&quot;</span>,<br>    <span class="hljs-string">&quot;score&quot;</span> : <span class="hljs-number">85.0</span>,<br>    <span class="hljs-string">&quot;views&quot;</span> : <span class="hljs-number">521.0</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="project"><a class="markdownIt-Anchor" href="#project"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/project/#mongodb-pipeline-pipe.-project">$project</a></h3><p>将具有请求字段的文档传递到管道中的下一阶段。指定的字段可以是输入文档中的现有字段或新计算的字段</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">&#123; <span class="hljs-attr">$project</span>: &#123; <span class="language-xml">&lt;specification(s)&gt; &#125; &#125;</span><br></code></pre></td></tr></table></figure><p>测试数据</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">books</span>.<span class="hljs-title function_">insertMany</span>(<br>    [<br>        &#123;<br>          <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">1</span>,<br>          <span class="hljs-attr">title</span>: <span class="hljs-string">&quot;abc123&quot;</span>,<br>          <span class="hljs-attr">isbn</span>: <span class="hljs-string">&quot;0001122223334&quot;</span>,<br>          <span class="hljs-attr">author</span>: &#123; <span class="hljs-attr">last</span>: <span class="hljs-string">&quot;zzz&quot;</span>, <span class="hljs-attr">first</span>: <span class="hljs-string">&quot;aaa&quot;</span> &#125;,<br>          <span class="hljs-attr">copies</span>: <span class="hljs-number">5</span><br>        &#125;<br>    ]<br>)<br></code></pre></td></tr></table></figure><p>下面的聚合仅展示 <code>title</code> 和 <code>author</code> 字段（_id 是默认展示的）</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">books</span>.<span class="hljs-title function_">aggregate</span>(<span class="hljs-params"></span><br><span class="hljs-params">    [</span><br><span class="hljs-params">        &#123;$project: &#123;title:<span class="hljs-number">1</span>, author:<span class="hljs-number">1</span>&#125;&#125;</span><br><span class="hljs-params">    ]</span><br><span class="hljs-params"></span>)<br><br><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">1.0</span>,<br>    <span class="hljs-string">&quot;title&quot;</span> : <span class="hljs-string">&quot;abc123&quot;</span>,<br>    <span class="hljs-string">&quot;author&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;last&quot;</span> : <span class="hljs-string">&quot;zzz&quot;</span>,<br>        <span class="hljs-string">&quot;first&quot;</span> : <span class="hljs-string">&quot;aaa&quot;</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="count"><a class="markdownIt-Anchor" href="#count"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/count/">$count</a></h3><p>返回聚合管道此阶段的文档数量计数</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">&#123; <span class="hljs-attr">$count</span>: &lt;string&gt; &#125;<br></code></pre></td></tr></table></figure><p>测试数据</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">scores</span>.<span class="hljs-title function_">insertMany</span>(<br>    [<br>        &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">1</span>, <span class="hljs-string">&quot;subject&quot;</span> : <span class="hljs-string">&quot;History&quot;</span>, <span class="hljs-string">&quot;score&quot;</span> : <span class="hljs-number">88</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">2</span>, <span class="hljs-string">&quot;subject&quot;</span> : <span class="hljs-string">&quot;History&quot;</span>, <span class="hljs-string">&quot;score&quot;</span> : <span class="hljs-number">92</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">3</span>, <span class="hljs-string">&quot;subject&quot;</span> : <span class="hljs-string">&quot;History&quot;</span>, <span class="hljs-string">&quot;score&quot;</span> : <span class="hljs-number">97</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">4</span>, <span class="hljs-string">&quot;subject&quot;</span> : <span class="hljs-string">&quot;History&quot;</span>, <span class="hljs-string">&quot;score&quot;</span> : <span class="hljs-number">71</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">5</span>, <span class="hljs-string">&quot;subject&quot;</span> : <span class="hljs-string">&quot;History&quot;</span>, <span class="hljs-string">&quot;score&quot;</span> : <span class="hljs-number">79</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">6</span>, <span class="hljs-string">&quot;subject&quot;</span> : <span class="hljs-string">&quot;History&quot;</span>, <span class="hljs-string">&quot;score&quot;</span> : <span class="hljs-number">83</span> &#125;<br>    ]<br>)<br></code></pre></td></tr></table></figure><p>统计成绩高于80分的人数</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">scores</span>.<span class="hljs-title function_">aggregate</span>(<span class="hljs-params"></span><br><span class="hljs-params">    [</span><br><span class="hljs-params">        &#123;$match: &#123;score: &#123;$gt: <span class="hljs-number">80</span>&#125;&#125;&#125;,</span><br><span class="hljs-params">        &#123;$count: <span class="hljs-string">&quot;countNum&quot;</span>&#125;</span><br><span class="hljs-params">    ]</span><br><span class="hljs-params"></span>)<br><br><br>&#123;<br>    <span class="hljs-string">&quot;countNum&quot;</span> : <span class="hljs-number">4</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="group"><a class="markdownIt-Anchor" href="#group"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/group/">$group</a></h3><p>按指定的标识符表达式对文档进行分组，并将累加器表达式(如果指定)应用于每个 group</p><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/group/#considerations">支持的累加运算符</a></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs javascript">&#123;<br>  <span class="hljs-attr">$group</span>:<br>    &#123;<br>      <span class="hljs-attr">_id</span>: &lt;expression&gt;, <span class="hljs-comment">// 分组字段</span><br>      &lt;field1&gt;: &#123; &lt;accumulator1&gt; : &lt;expression1&gt; &#125;, <span class="hljs-comment">// 定义累加字段名，累加运算符，累加表达式</span><br>      ...<br>    &#125;<br> &#125;<br></code></pre></td></tr></table></figure><p>测试数据</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">sales</span>.<span class="hljs-title function_">insertMany</span>([<br>  &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">1</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;abc&quot;</span>, <span class="hljs-string">&quot;price&quot;</span> : <span class="hljs-title class_">NumberDecimal</span>(<span class="hljs-string">&quot;10&quot;</span>), <span class="hljs-string">&quot;quantity&quot;</span> : <span class="hljs-title class_">NumberInt</span>(<span class="hljs-string">&quot;2&quot;</span>), <span class="hljs-string">&quot;date&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2014-03-01T08:00:00Z&quot;</span>) &#125;,<br>  &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">2</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;jkl&quot;</span>, <span class="hljs-string">&quot;price&quot;</span> : <span class="hljs-title class_">NumberDecimal</span>(<span class="hljs-string">&quot;20&quot;</span>), <span class="hljs-string">&quot;quantity&quot;</span> : <span class="hljs-title class_">NumberInt</span>(<span class="hljs-string">&quot;1&quot;</span>), <span class="hljs-string">&quot;date&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2014-03-01T09:00:00Z&quot;</span>) &#125;,<br>  &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">3</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;xyz&quot;</span>, <span class="hljs-string">&quot;price&quot;</span> : <span class="hljs-title class_">NumberDecimal</span>(<span class="hljs-string">&quot;5&quot;</span>), <span class="hljs-string">&quot;quantity&quot;</span> : <span class="hljs-title class_">NumberInt</span>( <span class="hljs-string">&quot;10&quot;</span>), <span class="hljs-string">&quot;date&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2014-03-15T09:00:00Z&quot;</span>) &#125;,<br>  &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">4</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;xyz&quot;</span>, <span class="hljs-string">&quot;price&quot;</span> : <span class="hljs-title class_">NumberDecimal</span>(<span class="hljs-string">&quot;5&quot;</span>), <span class="hljs-string">&quot;quantity&quot;</span> :  <span class="hljs-title class_">NumberInt</span>(<span class="hljs-string">&quot;20&quot;</span>) , <span class="hljs-string">&quot;date&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2014-04-04T11:21:39.736Z&quot;</span>) &#125;,<br>  &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">5</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;abc&quot;</span>, <span class="hljs-string">&quot;price&quot;</span> : <span class="hljs-title class_">NumberDecimal</span>(<span class="hljs-string">&quot;10&quot;</span>), <span class="hljs-string">&quot;quantity&quot;</span> : <span class="hljs-title class_">NumberInt</span>(<span class="hljs-string">&quot;10&quot;</span>) , <span class="hljs-string">&quot;date&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2014-04-04T21:23:13.331Z&quot;</span>) &#125;,<br>  &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">6</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;def&quot;</span>, <span class="hljs-string">&quot;price&quot;</span> : <span class="hljs-title class_">NumberDecimal</span>(<span class="hljs-string">&quot;7.5&quot;</span>), <span class="hljs-string">&quot;quantity&quot;</span>: <span class="hljs-title class_">NumberInt</span>(<span class="hljs-string">&quot;5&quot;</span> ) , <span class="hljs-string">&quot;date&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2015-06-04T05:08:13Z&quot;</span>) &#125;,<br>  &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">7</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;def&quot;</span>, <span class="hljs-string">&quot;price&quot;</span> : <span class="hljs-title class_">NumberDecimal</span>(<span class="hljs-string">&quot;7.5&quot;</span>), <span class="hljs-string">&quot;quantity&quot;</span>: <span class="hljs-title class_">NumberInt</span>(<span class="hljs-string">&quot;10&quot;</span>) , <span class="hljs-string">&quot;date&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2015-09-10T08:43:00Z&quot;</span>) &#125;,<br>  &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">8</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;abc&quot;</span>, <span class="hljs-string">&quot;price&quot;</span> : <span class="hljs-title class_">NumberDecimal</span>(<span class="hljs-string">&quot;10&quot;</span>), <span class="hljs-string">&quot;quantity&quot;</span> : <span class="hljs-title class_">NumberInt</span>(<span class="hljs-string">&quot;5&quot;</span> ) , <span class="hljs-string">&quot;date&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2016-02-06T20:20:13Z&quot;</span>) &#125;,<br>])<br></code></pre></td></tr></table></figure><p>根据 <code>item</code> 分组，统计每组 <code>item</code> 的文档数量</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">sales</span>.<span class="hljs-title function_">aggregate</span>(<br>    [<br>        &#123;<br>            <span class="hljs-attr">$group</span>: &#123;<br>                <span class="hljs-attr">_id</span>: <span class="hljs-string">&quot;$item&quot;</span>,<br>                <span class="hljs-attr">count</span>: &#123;<br>                    <span class="hljs-attr">$count</span>: &#123;&#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>    ]<br>)<br><br><br><span class="hljs-comment">/* 1 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-string">&quot;jkl&quot;</span>,<br>    <span class="hljs-string">&quot;count&quot;</span> : <span class="hljs-number">1</span><br>&#125;<br><br><span class="hljs-comment">/* 2 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-string">&quot;def&quot;</span>,<br>    <span class="hljs-string">&quot;count&quot;</span> : <span class="hljs-number">2</span><br>&#125;<br><br><span class="hljs-comment">/* 3 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-string">&quot;abc&quot;</span>,<br>    <span class="hljs-string">&quot;count&quot;</span> : <span class="hljs-number">3</span><br>&#125;<br><br><span class="hljs-comment">/* 4 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-string">&quot;xyz&quot;</span>,<br>    <span class="hljs-string">&quot;count&quot;</span> : <span class="hljs-number">2</span><br>&#125;<br></code></pre></td></tr></table></figure><p>按照 <code>item</code> 分组，求每组最大的 <code>quantity</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">sales</span>.<span class="hljs-title function_">aggregate</span>(<br>    [<br>        &#123;<br>            <span class="hljs-attr">$group</span>: &#123;<br>                <span class="hljs-attr">_id</span>: <span class="hljs-string">&quot;$item&quot;</span>,<br>                <span class="hljs-attr">maxQuantity</span>: &#123;<br>                    <span class="hljs-attr">$max</span>: <span class="hljs-string">&quot;$quantity&quot;</span><br>                &#125;<br>            &#125;<br>        &#125;<br>    ]<br>)<br><br><br><span class="hljs-comment">/* 1 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-string">&quot;xyz&quot;</span>,<br>    <span class="hljs-string">&quot;maxQuantity&quot;</span> : <span class="hljs-number">20</span><br>&#125;<br><br><span class="hljs-comment">/* 2 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-string">&quot;jkl&quot;</span>,<br>    <span class="hljs-string">&quot;maxQuantity&quot;</span> : <span class="hljs-number">1</span><br>&#125;<br><br><span class="hljs-comment">/* 3 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-string">&quot;abc&quot;</span>,<br>    <span class="hljs-string">&quot;maxQuantity&quot;</span> : <span class="hljs-number">10</span><br>&#125;<br><br><span class="hljs-comment">/* 4 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-string">&quot;def&quot;</span>,<br>    <span class="hljs-string">&quot;maxQuantity&quot;</span> : <span class="hljs-number">10</span><br>&#125;<br></code></pre></td></tr></table></figure><p class="note note-primary">实现having</p><p>先按照 <code>item</code> 分组计算销售总价，然后再过滤销售总价少于100的数据</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">sales</span>.<span class="hljs-title function_">aggregate</span>(<br>    [<br>        &#123;<br>            <span class="hljs-attr">$group</span>: &#123;<br>                <span class="hljs-attr">_id</span>: <span class="hljs-string">&quot;$item&quot;</span>,<br>                <span class="hljs-attr">total</span>: &#123;<br>                    <span class="hljs-attr">$sum</span>: &#123;<br>                        <span class="hljs-attr">$multiply</span>: [<span class="hljs-string">&quot;$price&quot;</span>, <span class="hljs-string">&quot;$quantity&quot;</span>]<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;,<br>        &#123;<br>            <span class="hljs-attr">$match</span>: &#123;<br>                <span class="hljs-attr">total</span>: &#123;<br>                    <span class="hljs-attr">$gt</span>: <span class="hljs-number">100</span><br>                &#125;<br>            &#125;<br>        &#125;<br>    ]<br>)<br><br><br><span class="hljs-comment">/* 1 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-string">&quot;xyz&quot;</span>,<br>    <span class="hljs-string">&quot;total&quot;</span> : <span class="hljs-title class_">NumberDecimal</span>(<span class="hljs-string">&quot;150&quot;</span>)<br>&#125;<br><br><span class="hljs-comment">/* 2 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-string">&quot;abc&quot;</span>,<br>    <span class="hljs-string">&quot;total&quot;</span> : <span class="hljs-title class_">NumberDecimal</span>(<span class="hljs-string">&quot;170&quot;</span>)<br>&#125;<br><br><span class="hljs-comment">/* 3 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-string">&quot;def&quot;</span>,<br>    <span class="hljs-string">&quot;total&quot;</span> : <span class="hljs-title class_">NumberDecimal</span>(<span class="hljs-string">&quot;112.5&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="unwind"><a class="markdownIt-Anchor" href="#unwind"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/unwind/#examples">$unwind</a></h3><p>将数组字段进行展开，然后每个数组元素重新生成一份新的文档</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">&#123; <span class="hljs-attr">$unwind</span>: <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">field</span> <span class="hljs-attr">path</span>&gt;</span> &#125;</span><br></code></pre></td></tr></table></figure><p>测试数据</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">insertOne</span>(&#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">1</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;ABC1&quot;</span>, <span class="hljs-attr">sizes</span>: [ <span class="hljs-string">&quot;S&quot;</span>, <span class="hljs-string">&quot;M&quot;</span>, <span class="hljs-string">&quot;L&quot;</span>] &#125;)<br></code></pre></td></tr></table></figure><p>将数组 <code>$sizes</code> 进行展开</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">aggregate</span>(<br>    [<br>        &#123;<span class="hljs-attr">$unwind</span>: <span class="hljs-string">&quot;$sizes&quot;</span>&#125;<br>    ]<br>)<br><br><br><span class="hljs-comment">/* 1 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">1.0</span>,<br>    <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;ABC1&quot;</span>,<br>    <span class="hljs-string">&quot;sizes&quot;</span> : <span class="hljs-string">&quot;S&quot;</span><br>&#125;<br><br><span class="hljs-comment">/* 2 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">1.0</span>,<br>    <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;ABC1&quot;</span>,<br>    <span class="hljs-string">&quot;sizes&quot;</span> : <span class="hljs-string">&quot;M&quot;</span><br>&#125;<br><br><span class="hljs-comment">/* 3 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">1.0</span>,<br>    <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;ABC1&quot;</span>,<br>    <span class="hljs-string">&quot;sizes&quot;</span> : <span class="hljs-string">&quot;L&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="limit"><a class="markdownIt-Anchor" href="#limit"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/limit/">$limit</a></h3><p>限制传递到管道中下一阶段的文档数量</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">&#123; <span class="hljs-attr">$limit</span>: <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">positive</span> <span class="hljs-attr">64-bit</span> <span class="hljs-attr">integer</span>&gt;</span> &#125;</span><br></code></pre></td></tr></table></figure><p>测试数据</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">sales</span>.<span class="hljs-title function_">insertMany</span>([<br>  &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">1</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;abc&quot;</span>, <span class="hljs-string">&quot;price&quot;</span> : <span class="hljs-title class_">NumberDecimal</span>(<span class="hljs-string">&quot;10&quot;</span>), <span class="hljs-string">&quot;quantity&quot;</span> : <span class="hljs-title class_">NumberInt</span>(<span class="hljs-string">&quot;2&quot;</span>), <span class="hljs-string">&quot;date&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2014-03-01T08:00:00Z&quot;</span>) &#125;,<br>  &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">2</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;jkl&quot;</span>, <span class="hljs-string">&quot;price&quot;</span> : <span class="hljs-title class_">NumberDecimal</span>(<span class="hljs-string">&quot;20&quot;</span>), <span class="hljs-string">&quot;quantity&quot;</span> : <span class="hljs-title class_">NumberInt</span>(<span class="hljs-string">&quot;1&quot;</span>), <span class="hljs-string">&quot;date&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2014-03-01T09:00:00Z&quot;</span>) &#125;,<br>  &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">3</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;xyz&quot;</span>, <span class="hljs-string">&quot;price&quot;</span> : <span class="hljs-title class_">NumberDecimal</span>(<span class="hljs-string">&quot;5&quot;</span>), <span class="hljs-string">&quot;quantity&quot;</span> : <span class="hljs-title class_">NumberInt</span>( <span class="hljs-string">&quot;10&quot;</span>), <span class="hljs-string">&quot;date&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2014-03-15T09:00:00Z&quot;</span>) &#125;,<br>  &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">4</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;xyz&quot;</span>, <span class="hljs-string">&quot;price&quot;</span> : <span class="hljs-title class_">NumberDecimal</span>(<span class="hljs-string">&quot;5&quot;</span>), <span class="hljs-string">&quot;quantity&quot;</span> :  <span class="hljs-title class_">NumberInt</span>(<span class="hljs-string">&quot;20&quot;</span>) , <span class="hljs-string">&quot;date&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2014-04-04T11:21:39.736Z&quot;</span>) &#125;,<br>  &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">5</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;abc&quot;</span>, <span class="hljs-string">&quot;price&quot;</span> : <span class="hljs-title class_">NumberDecimal</span>(<span class="hljs-string">&quot;10&quot;</span>), <span class="hljs-string">&quot;quantity&quot;</span> : <span class="hljs-title class_">NumberInt</span>(<span class="hljs-string">&quot;10&quot;</span>) , <span class="hljs-string">&quot;date&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2014-04-04T21:23:13.331Z&quot;</span>) &#125;,<br>  &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">6</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;def&quot;</span>, <span class="hljs-string">&quot;price&quot;</span> : <span class="hljs-title class_">NumberDecimal</span>(<span class="hljs-string">&quot;7.5&quot;</span>), <span class="hljs-string">&quot;quantity&quot;</span>: <span class="hljs-title class_">NumberInt</span>(<span class="hljs-string">&quot;5&quot;</span> ) , <span class="hljs-string">&quot;date&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2015-06-04T05:08:13Z&quot;</span>) &#125;,<br>  &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">7</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;def&quot;</span>, <span class="hljs-string">&quot;price&quot;</span> : <span class="hljs-title class_">NumberDecimal</span>(<span class="hljs-string">&quot;7.5&quot;</span>), <span class="hljs-string">&quot;quantity&quot;</span>: <span class="hljs-title class_">NumberInt</span>(<span class="hljs-string">&quot;10&quot;</span>) , <span class="hljs-string">&quot;date&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2015-09-10T08:43:00Z&quot;</span>) &#125;,<br>  &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">8</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;abc&quot;</span>, <span class="hljs-string">&quot;price&quot;</span> : <span class="hljs-title class_">NumberDecimal</span>(<span class="hljs-string">&quot;10&quot;</span>), <span class="hljs-string">&quot;quantity&quot;</span> : <span class="hljs-title class_">NumberInt</span>(<span class="hljs-string">&quot;5&quot;</span> ) , <span class="hljs-string">&quot;date&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2016-02-06T20:20:13Z&quot;</span>) &#125;,<br>])<br></code></pre></td></tr></table></figure><p>传递2条数据到聚合下个阶段</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">sales</span>.<span class="hljs-title function_">aggregate</span>(<br>    [<br>        &#123;<span class="hljs-attr">$limit</span>: <span class="hljs-number">2</span>&#125;<br>    ]<br>)<br><br><br><span class="hljs-comment">/* 1 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">1.0</span>,<br>    <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;abc&quot;</span>,<br>    <span class="hljs-string">&quot;price&quot;</span> : <span class="hljs-title class_">NumberDecimal</span>(<span class="hljs-string">&quot;10&quot;</span>),<br>    <span class="hljs-string">&quot;quantity&quot;</span> : <span class="hljs-number">2</span>,<br>    <span class="hljs-string">&quot;date&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2014-03-01T08:00:00.000Z&quot;</span>)<br>&#125;<br><br><span class="hljs-comment">/* 2 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">2.0</span>,<br>    <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;jkl&quot;</span>,<br>    <span class="hljs-string">&quot;price&quot;</span> : <span class="hljs-title class_">NumberDecimal</span>(<span class="hljs-string">&quot;20&quot;</span>),<br>    <span class="hljs-string">&quot;quantity&quot;</span> : <span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;date&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2014-03-01T09:00:00.000Z&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="skip"><a class="markdownIt-Anchor" href="#skip"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/skip/">$skip</a></h3><p>取一个正整数，指定要跳过的最大文档数，并将剩余的文档传递到管道中的下一阶段</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">&#123; <span class="hljs-attr">$skip</span>: <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">positive</span> <span class="hljs-attr">64-bit</span> <span class="hljs-attr">integer</span>&gt;</span> &#125;</span><br></code></pre></td></tr></table></figure><p>测试数据</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">sales</span>.<span class="hljs-title function_">insertMany</span>([<br>  &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">1</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;abc&quot;</span>, <span class="hljs-string">&quot;price&quot;</span> : <span class="hljs-title class_">NumberDecimal</span>(<span class="hljs-string">&quot;10&quot;</span>), <span class="hljs-string">&quot;quantity&quot;</span> : <span class="hljs-title class_">NumberInt</span>(<span class="hljs-string">&quot;2&quot;</span>), <span class="hljs-string">&quot;date&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2014-03-01T08:00:00Z&quot;</span>) &#125;,<br>  &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">2</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;jkl&quot;</span>, <span class="hljs-string">&quot;price&quot;</span> : <span class="hljs-title class_">NumberDecimal</span>(<span class="hljs-string">&quot;20&quot;</span>), <span class="hljs-string">&quot;quantity&quot;</span> : <span class="hljs-title class_">NumberInt</span>(<span class="hljs-string">&quot;1&quot;</span>), <span class="hljs-string">&quot;date&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2014-03-01T09:00:00Z&quot;</span>) &#125;,<br>  &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">3</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;xyz&quot;</span>, <span class="hljs-string">&quot;price&quot;</span> : <span class="hljs-title class_">NumberDecimal</span>(<span class="hljs-string">&quot;5&quot;</span>), <span class="hljs-string">&quot;quantity&quot;</span> : <span class="hljs-title class_">NumberInt</span>( <span class="hljs-string">&quot;10&quot;</span>), <span class="hljs-string">&quot;date&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2014-03-15T09:00:00Z&quot;</span>) &#125;,<br>  &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">4</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;xyz&quot;</span>, <span class="hljs-string">&quot;price&quot;</span> : <span class="hljs-title class_">NumberDecimal</span>(<span class="hljs-string">&quot;5&quot;</span>), <span class="hljs-string">&quot;quantity&quot;</span> :  <span class="hljs-title class_">NumberInt</span>(<span class="hljs-string">&quot;20&quot;</span>) , <span class="hljs-string">&quot;date&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2014-04-04T11:21:39.736Z&quot;</span>) &#125;,<br>  &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">5</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;abc&quot;</span>, <span class="hljs-string">&quot;price&quot;</span> : <span class="hljs-title class_">NumberDecimal</span>(<span class="hljs-string">&quot;10&quot;</span>), <span class="hljs-string">&quot;quantity&quot;</span> : <span class="hljs-title class_">NumberInt</span>(<span class="hljs-string">&quot;10&quot;</span>) , <span class="hljs-string">&quot;date&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2014-04-04T21:23:13.331Z&quot;</span>) &#125;,<br>  &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">6</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;def&quot;</span>, <span class="hljs-string">&quot;price&quot;</span> : <span class="hljs-title class_">NumberDecimal</span>(<span class="hljs-string">&quot;7.5&quot;</span>), <span class="hljs-string">&quot;quantity&quot;</span>: <span class="hljs-title class_">NumberInt</span>(<span class="hljs-string">&quot;5&quot;</span> ) , <span class="hljs-string">&quot;date&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2015-06-04T05:08:13Z&quot;</span>) &#125;,<br>  &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">7</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;def&quot;</span>, <span class="hljs-string">&quot;price&quot;</span> : <span class="hljs-title class_">NumberDecimal</span>(<span class="hljs-string">&quot;7.5&quot;</span>), <span class="hljs-string">&quot;quantity&quot;</span>: <span class="hljs-title class_">NumberInt</span>(<span class="hljs-string">&quot;10&quot;</span>) , <span class="hljs-string">&quot;date&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2015-09-10T08:43:00Z&quot;</span>) &#125;,<br>  &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">8</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;abc&quot;</span>, <span class="hljs-string">&quot;price&quot;</span> : <span class="hljs-title class_">NumberDecimal</span>(<span class="hljs-string">&quot;10&quot;</span>), <span class="hljs-string">&quot;quantity&quot;</span> : <span class="hljs-title class_">NumberInt</span>(<span class="hljs-string">&quot;5&quot;</span> ) , <span class="hljs-string">&quot;date&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2016-02-06T20:20:13Z&quot;</span>) &#125;,<br>])<br></code></pre></td></tr></table></figure><p>跳过前两条数据</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">sales</span>.<span class="hljs-title function_">aggregate</span>(<br>    [<br>        &#123;<span class="hljs-attr">$skip</span>: <span class="hljs-number">2</span>&#125;,<br>        &#123;<span class="hljs-attr">$project</span>: &#123;<span class="hljs-attr">_id</span>: <span class="hljs-number">1</span>&#125;&#125;<br>    ]<br>)<br><br><br><span class="hljs-comment">/* 1 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">3.0</span><br>&#125;<br><br><span class="hljs-comment">/* 2 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">4.0</span><br>&#125;<br><br><span class="hljs-comment">/* 3 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">5.0</span><br>&#125;<br><br><span class="hljs-comment">/* 4 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">6.0</span><br>&#125;<br><br><span class="hljs-comment">/* 5 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">7.0</span><br>&#125;<br><br><span class="hljs-comment">/* 6 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">8.0</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="sort"><a class="markdownIt-Anchor" href="#sort"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/skip/#example">$sort</a></h3><p>对所有输入文档进行排序并按排序顺序将它们返回到管道</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">&#123; <span class="hljs-attr">$sort</span>: &#123; &lt;field1&gt;: &lt;sort order&gt;, &lt;field2&gt;: &lt;sort order&gt; ... &#125; &#125;<br></code></pre></td></tr></table></figure><ul><li><code>1</code>: ASC</li><li><code>-1</code>: DESC</li></ul><p>测试数据</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">sales</span>.<span class="hljs-title function_">insertMany</span>([<br>  &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">1</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;abc&quot;</span>, <span class="hljs-string">&quot;price&quot;</span> : <span class="hljs-title class_">NumberDecimal</span>(<span class="hljs-string">&quot;10&quot;</span>), <span class="hljs-string">&quot;quantity&quot;</span> : <span class="hljs-title class_">NumberInt</span>(<span class="hljs-string">&quot;2&quot;</span>), <span class="hljs-string">&quot;date&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2014-03-01T08:00:00Z&quot;</span>) &#125;,<br>  &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">2</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;jkl&quot;</span>, <span class="hljs-string">&quot;price&quot;</span> : <span class="hljs-title class_">NumberDecimal</span>(<span class="hljs-string">&quot;20&quot;</span>), <span class="hljs-string">&quot;quantity&quot;</span> : <span class="hljs-title class_">NumberInt</span>(<span class="hljs-string">&quot;1&quot;</span>), <span class="hljs-string">&quot;date&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2014-03-01T09:00:00Z&quot;</span>) &#125;,<br>  &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">3</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;xyz&quot;</span>, <span class="hljs-string">&quot;price&quot;</span> : <span class="hljs-title class_">NumberDecimal</span>(<span class="hljs-string">&quot;5&quot;</span>), <span class="hljs-string">&quot;quantity&quot;</span> : <span class="hljs-title class_">NumberInt</span>( <span class="hljs-string">&quot;10&quot;</span>), <span class="hljs-string">&quot;date&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2014-03-15T09:00:00Z&quot;</span>) &#125;,<br>  &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">4</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;xyz&quot;</span>, <span class="hljs-string">&quot;price&quot;</span> : <span class="hljs-title class_">NumberDecimal</span>(<span class="hljs-string">&quot;5&quot;</span>), <span class="hljs-string">&quot;quantity&quot;</span> :  <span class="hljs-title class_">NumberInt</span>(<span class="hljs-string">&quot;20&quot;</span>) , <span class="hljs-string">&quot;date&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2014-04-04T11:21:39.736Z&quot;</span>) &#125;,<br>  &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">5</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;abc&quot;</span>, <span class="hljs-string">&quot;price&quot;</span> : <span class="hljs-title class_">NumberDecimal</span>(<span class="hljs-string">&quot;10&quot;</span>), <span class="hljs-string">&quot;quantity&quot;</span> : <span class="hljs-title class_">NumberInt</span>(<span class="hljs-string">&quot;10&quot;</span>) , <span class="hljs-string">&quot;date&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2014-04-04T21:23:13.331Z&quot;</span>) &#125;,<br>  &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">6</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;def&quot;</span>, <span class="hljs-string">&quot;price&quot;</span> : <span class="hljs-title class_">NumberDecimal</span>(<span class="hljs-string">&quot;7.5&quot;</span>), <span class="hljs-string">&quot;quantity&quot;</span>: <span class="hljs-title class_">NumberInt</span>(<span class="hljs-string">&quot;5&quot;</span> ) , <span class="hljs-string">&quot;date&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2015-06-04T05:08:13Z&quot;</span>) &#125;,<br>  &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">7</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;def&quot;</span>, <span class="hljs-string">&quot;price&quot;</span> : <span class="hljs-title class_">NumberDecimal</span>(<span class="hljs-string">&quot;7.5&quot;</span>), <span class="hljs-string">&quot;quantity&quot;</span>: <span class="hljs-title class_">NumberInt</span>(<span class="hljs-string">&quot;10&quot;</span>) , <span class="hljs-string">&quot;date&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2015-09-10T08:43:00Z&quot;</span>) &#125;,<br>  &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">8</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;abc&quot;</span>, <span class="hljs-string">&quot;price&quot;</span> : <span class="hljs-title class_">NumberDecimal</span>(<span class="hljs-string">&quot;10&quot;</span>), <span class="hljs-string">&quot;quantity&quot;</span> : <span class="hljs-title class_">NumberInt</span>(<span class="hljs-string">&quot;5&quot;</span> ) , <span class="hljs-string">&quot;date&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2016-02-06T20:20:13Z&quot;</span>) &#125;,<br>])<br></code></pre></td></tr></table></figure><p>按照 price <code>升序</code> quantity <code>降序</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">sales</span>.<span class="hljs-title function_">aggregate</span>(<br>    [<br>        &#123;<br>            <span class="hljs-attr">$sort</span>: &#123;<br>                <span class="hljs-attr">price</span>: <span class="hljs-number">1</span>,<br>                <span class="hljs-attr">quantity</span>: -<span class="hljs-number">1</span><br>            &#125;<br>        &#125;,<br>        &#123;<br>            <span class="hljs-attr">$project</span>: &#123;<br>                <span class="hljs-attr">price</span>: <span class="hljs-number">1</span>,<br>                <span class="hljs-attr">quantity</span>: <span class="hljs-number">1</span>     <br>            &#125;<br>        &#125;<br>    ]<br>)<br><br><br><span class="hljs-comment">/* 1 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">4.0</span>,<br>    <span class="hljs-string">&quot;price&quot;</span> : <span class="hljs-title class_">NumberDecimal</span>(<span class="hljs-string">&quot;5&quot;</span>),<br>    <span class="hljs-string">&quot;quantity&quot;</span> : <span class="hljs-number">20</span><br>&#125;<br><br><span class="hljs-comment">/* 2 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">3.0</span>,<br>    <span class="hljs-string">&quot;price&quot;</span> : <span class="hljs-title class_">NumberDecimal</span>(<span class="hljs-string">&quot;5&quot;</span>),<br>    <span class="hljs-string">&quot;quantity&quot;</span> : <span class="hljs-number">10</span><br>&#125;<br><br><span class="hljs-comment">/* 3 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">7.0</span>,<br>    <span class="hljs-string">&quot;price&quot;</span> : <span class="hljs-title class_">NumberDecimal</span>(<span class="hljs-string">&quot;7.5&quot;</span>),<br>    <span class="hljs-string">&quot;quantity&quot;</span> : <span class="hljs-number">10</span><br>&#125;<br><br><span class="hljs-comment">/* 4 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">6.0</span>,<br>    <span class="hljs-string">&quot;price&quot;</span> : <span class="hljs-title class_">NumberDecimal</span>(<span class="hljs-string">&quot;7.5&quot;</span>),<br>    <span class="hljs-string">&quot;quantity&quot;</span> : <span class="hljs-number">5</span><br>&#125;<br><br><span class="hljs-comment">/* 5 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">5.0</span>,<br>    <span class="hljs-string">&quot;price&quot;</span> : <span class="hljs-title class_">NumberDecimal</span>(<span class="hljs-string">&quot;10&quot;</span>),<br>    <span class="hljs-string">&quot;quantity&quot;</span> : <span class="hljs-number">10</span><br>&#125;<br><br><span class="hljs-comment">/* 6 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">8.0</span>,<br>    <span class="hljs-string">&quot;price&quot;</span> : <span class="hljs-title class_">NumberDecimal</span>(<span class="hljs-string">&quot;10&quot;</span>),<br>    <span class="hljs-string">&quot;quantity&quot;</span> : <span class="hljs-number">5</span><br>&#125;<br><br><span class="hljs-comment">/* 7 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">1.0</span>,<br>    <span class="hljs-string">&quot;price&quot;</span> : <span class="hljs-title class_">NumberDecimal</span>(<span class="hljs-string">&quot;10&quot;</span>),<br>    <span class="hljs-string">&quot;quantity&quot;</span> : <span class="hljs-number">2</span><br>&#125;<br><br><span class="hljs-comment">/* 8 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">2.0</span>,<br>    <span class="hljs-string">&quot;price&quot;</span> : <span class="hljs-title class_">NumberDecimal</span>(<span class="hljs-string">&quot;20&quot;</span>),<br>    <span class="hljs-string">&quot;quantity&quot;</span> : <span class="hljs-number">1</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="lookup"><a class="markdownIt-Anchor" href="#lookup"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/lookup/#examples">$lookup</a></h3><p>主要用来实现多表关联查询， 相当关系型数据库中多表左外连接。每个输入待处理的文档，经过$lookup 阶段的处理，输出的新文档中会包含一个新生成的数（可根据需要命名新key ）。数组列存放的数据是来自被Join集合的适配文档，如果没有，集合为空</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs javascript">&#123;<br>   <span class="hljs-attr">$lookup</span>:<br>     &#123;<br>       <span class="hljs-attr">from</span>: &lt;collection to join&gt;,<br>       localField: &lt;field from the input documents&gt;,<br>       foreignField: &lt;field from the documents of the &quot;from&quot; collection&gt;,<br>       as: &lt;output array field&gt;<br>     &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>测试数据</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">orders</span>.<span class="hljs-title function_">insertMany</span>( [<br>   &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">1</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;almonds&quot;</span>, <span class="hljs-string">&quot;price&quot;</span> : <span class="hljs-number">12</span>, <span class="hljs-string">&quot;quantity&quot;</span> : <span class="hljs-number">2</span> &#125;,<br>   &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">2</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;pecans&quot;</span>, <span class="hljs-string">&quot;price&quot;</span> : <span class="hljs-number">20</span>, <span class="hljs-string">&quot;quantity&quot;</span> : <span class="hljs-number">1</span> &#125;,<br>   &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">3</span>  &#125;<br>] )<br></code></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">insertMany</span>( [<br>   &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">1</span>, <span class="hljs-string">&quot;sku&quot;</span> : <span class="hljs-string">&quot;almonds&quot;</span>, <span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;product 1&quot;</span>, <span class="hljs-string">&quot;instock&quot;</span> : <span class="hljs-number">120</span> &#125;,<br>   &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">2</span>, <span class="hljs-string">&quot;sku&quot;</span> : <span class="hljs-string">&quot;bread&quot;</span>, <span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;product 2&quot;</span>, <span class="hljs-string">&quot;instock&quot;</span> : <span class="hljs-number">80</span> &#125;,<br>   &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">3</span>, <span class="hljs-string">&quot;sku&quot;</span> : <span class="hljs-string">&quot;cashews&quot;</span>, <span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;product 3&quot;</span>, <span class="hljs-string">&quot;instock&quot;</span> : <span class="hljs-number">60</span> &#125;,<br>   &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">4</span>, <span class="hljs-string">&quot;sku&quot;</span> : <span class="hljs-string">&quot;pecans&quot;</span>, <span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;product 4&quot;</span>, <span class="hljs-string">&quot;instock&quot;</span> : <span class="hljs-number">70</span> &#125;,<br>   &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">5</span>, <span class="hljs-string">&quot;sku&quot;</span>: <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;Incomplete&quot;</span> &#125;,<br>   &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">6</span> &#125;<br>] )<br></code></pre></td></tr></table></figure><p>以下对 <code>orders</code> 集合的聚合操作使用来自 <code>orders</code> 集合的字段 <code>item</code> 和来自 <code>inventory</code> 集合的 <code>sku</code> 字段将来自 <code>orders</code> 的文档与来自 <code>inventory</code> 集合的文档连接起来</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">orders</span>.<span class="hljs-title function_">aggregate</span>(<br>    [<br>        &#123;<br>            <span class="hljs-attr">$lookup</span>: &#123;<br>                <span class="hljs-attr">from</span>: <span class="hljs-string">&quot;inventory&quot;</span>,<br>                <span class="hljs-attr">localField</span>: <span class="hljs-string">&quot;item&quot;</span>,<br>                <span class="hljs-attr">foreignField</span>: <span class="hljs-string">&quot;sku&quot;</span>,<br>                <span class="hljs-attr">as</span>: <span class="hljs-string">&quot;inventory_docs&quot;</span><br>            &#125;<br>        &#125;<br>    ]<br>)<br><br><br><span class="hljs-comment">/* 1 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">1.0</span>,<br>    <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;almonds&quot;</span>,<br>    <span class="hljs-string">&quot;price&quot;</span> : <span class="hljs-number">12.0</span>,<br>    <span class="hljs-string">&quot;quantity&quot;</span> : <span class="hljs-number">2.0</span>,<br>    <span class="hljs-string">&quot;inventory_docs&quot;</span> : [ <br>        &#123;<br>            <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">1.0</span>,<br>            <span class="hljs-string">&quot;sku&quot;</span> : <span class="hljs-string">&quot;almonds&quot;</span>,<br>            <span class="hljs-string">&quot;description&quot;</span> : <span class="hljs-string">&quot;product 1&quot;</span>,<br>            <span class="hljs-string">&quot;instock&quot;</span> : <span class="hljs-number">120.0</span><br>        &#125;<br>    ]<br>&#125;<br><br><span class="hljs-comment">/* 2 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">2.0</span>,<br>    <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;pecans&quot;</span>,<br>    <span class="hljs-string">&quot;price&quot;</span> : <span class="hljs-number">20.0</span>,<br>    <span class="hljs-string">&quot;quantity&quot;</span> : <span class="hljs-number">1.0</span>,<br>    <span class="hljs-string">&quot;inventory_docs&quot;</span> : [ <br>        &#123;<br>            <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">4.0</span>,<br>            <span class="hljs-string">&quot;sku&quot;</span> : <span class="hljs-string">&quot;pecans&quot;</span>,<br>            <span class="hljs-string">&quot;description&quot;</span> : <span class="hljs-string">&quot;product 4&quot;</span>,<br>            <span class="hljs-string">&quot;instock&quot;</span> : <span class="hljs-number">70.0</span><br>        &#125;<br>    ]<br>&#125;<br><br><span class="hljs-comment">/* 3 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">3.0</span>,<br>    <span class="hljs-string">&quot;inventory_docs&quot;</span> : [ <br>        &#123;<br>            <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">5.0</span>,<br>            <span class="hljs-string">&quot;sku&quot;</span> : <span class="hljs-literal">null</span>,<br>            <span class="hljs-string">&quot;description&quot;</span> : <span class="hljs-string">&quot;Incomplete&quot;</span><br>        &#125;, <br>        &#123;<br>            <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">6.0</span><br>        &#125;<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="map-reduce"><a class="markdownIt-Anchor" href="#map-reduce"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.mapReduce/">Map-Reduce</a></h2><p>从MongoDB 5.0开始，map-reduce被弃用，推荐使用管道聚合</p><p>Map-reduce是一种数据处理范例，用于将大量数据压缩为有用的聚合结果。MapReduce操作将大量的数据处理工作拆分成多个线程并行处理，然后将结果合并在一起。MongoDB提供的Map-Reduce非常灵活，对于大规模数据分析也相当实用</p><p>MapReduce具有两个阶段：</p><ul><li>将具有相同Key的文档数据整合在一起的map阶段</li><li>组合map操作的结果进行统计输出的reduce阶段</li></ul><p><img src="/2023/04/14/MongoDB/mapreduce.png" srcset="/img/loading.gif" lazyload alt></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">collection</span>.<span class="hljs-title function_">mapReduce</span>(<br>                         &lt;map&gt;,<br>                         &lt;reduce&gt;,<br>                         &#123;<br>                           <span class="hljs-attr">out</span>: &lt;collection&gt;,<br>                           <span class="hljs-attr">query</span>: &lt;<span class="hljs-variable language_">document</span>&gt;,<br>                           <span class="hljs-attr">sort</span>: &lt;<span class="hljs-variable language_">document</span>&gt;,<br>                           <span class="hljs-attr">limit</span>: &lt;number&gt;,<br>                           <span class="hljs-attr">finalize</span>: &lt;<span class="hljs-keyword">function</span>&gt;,<br>                           <span class="hljs-attr">scope</span>: &lt;<span class="hljs-variable language_">document</span>&gt;,<br>                           <span class="hljs-attr">jsMode</span>: &lt;boolean&gt;,<br>                           <span class="hljs-attr">verbose</span>: &lt;boolean&gt;,<br>                           <span class="hljs-attr">bypassDocumentValidation</span>: &lt;boolean&gt;<br>                         &#125;<br>                       )<br></code></pre></td></tr></table></figure><ul><li><p>map，将数据拆分成键值对，交给reduce函数</p></li><li><p>reduce，根据键将值做统计运算</p></li><li><p>out，可选，将结果汇入指定表</p></li><li><p>quey，可选筛选数据的条件，筛选的数据送入map</p></li><li><p>sort，排序完后，送入map视图</p></li><li><p>limit，限制送入map的文档数</p></li><li><p>finalize，可选，修改reduce的结果后进行输出</p></li><li><p>scope，可选，指定map、reduce、finalize的全局变量</p></li><li><p>jsMode，可选，默认false。在mapreduce过程中是否将数据转换成bson格式。</p></li><li><p>verbose，可选，是否在结果中显示时间，默认false</p></li><li><p>bypassDocmentValidation，可选，是否略过数据校验</p></li></ul><p class="note note-primary">用法</p><p>测试数据</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">orders</span>.<span class="hljs-title function_">insertMany</span>([<br>   &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">cust_id</span>: <span class="hljs-string">&quot;Ant O. Knee&quot;</span>, <span class="hljs-attr">ord_date</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">&quot;2020-03-01&quot;</span>), <span class="hljs-attr">price</span>: <span class="hljs-number">25</span>, <span class="hljs-attr">items</span>: [ &#123; <span class="hljs-attr">sku</span>: <span class="hljs-string">&quot;oranges&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">5</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">2.5</span> &#125;, &#123; <span class="hljs-attr">sku</span>: <span class="hljs-string">&quot;apples&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">5</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">2.5</span> &#125; ], <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;A&quot;</span> &#125;,<br>   &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">cust_id</span>: <span class="hljs-string">&quot;Ant O. Knee&quot;</span>, <span class="hljs-attr">ord_date</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">&quot;2020-03-08&quot;</span>), <span class="hljs-attr">price</span>: <span class="hljs-number">70</span>, <span class="hljs-attr">items</span>: [ &#123; <span class="hljs-attr">sku</span>: <span class="hljs-string">&quot;oranges&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">8</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">2.5</span> &#125;, &#123; <span class="hljs-attr">sku</span>: <span class="hljs-string">&quot;chocolates&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">5</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">10</span> &#125; ], <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;A&quot;</span> &#125;,<br>   &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">cust_id</span>: <span class="hljs-string">&quot;Busby Bee&quot;</span>, <span class="hljs-attr">ord_date</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">&quot;2020-03-08&quot;</span>), <span class="hljs-attr">price</span>: <span class="hljs-number">50</span>, <span class="hljs-attr">items</span>: [ &#123; <span class="hljs-attr">sku</span>: <span class="hljs-string">&quot;oranges&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">2.5</span> &#125;, &#123; <span class="hljs-attr">sku</span>: <span class="hljs-string">&quot;pears&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">2.5</span> &#125; ], <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;A&quot;</span> &#125;,<br>   &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">4</span>, <span class="hljs-attr">cust_id</span>: <span class="hljs-string">&quot;Busby Bee&quot;</span>, <span class="hljs-attr">ord_date</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">&quot;2020-03-18&quot;</span>), <span class="hljs-attr">price</span>: <span class="hljs-number">25</span>, <span class="hljs-attr">items</span>: [ &#123; <span class="hljs-attr">sku</span>: <span class="hljs-string">&quot;oranges&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">2.5</span> &#125; ], <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;A&quot;</span> &#125;,<br>   &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">5</span>, <span class="hljs-attr">cust_id</span>: <span class="hljs-string">&quot;Busby Bee&quot;</span>, <span class="hljs-attr">ord_date</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">&quot;2020-03-19&quot;</span>), <span class="hljs-attr">price</span>: <span class="hljs-number">50</span>, <span class="hljs-attr">items</span>: [ &#123; <span class="hljs-attr">sku</span>: <span class="hljs-string">&quot;chocolates&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">5</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">10</span> &#125; ], <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;A&quot;</span>&#125;,<br>   &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">6</span>, <span class="hljs-attr">cust_id</span>: <span class="hljs-string">&quot;Cam Elot&quot;</span>, <span class="hljs-attr">ord_date</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">&quot;2020-03-19&quot;</span>), <span class="hljs-attr">price</span>: <span class="hljs-number">35</span>, <span class="hljs-attr">items</span>: [ &#123; <span class="hljs-attr">sku</span>: <span class="hljs-string">&quot;carrots&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">1.0</span> &#125;, &#123; <span class="hljs-attr">sku</span>: <span class="hljs-string">&quot;apples&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">2.5</span> &#125; ], <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;A&quot;</span> &#125;,<br>   &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">7</span>, <span class="hljs-attr">cust_id</span>: <span class="hljs-string">&quot;Cam Elot&quot;</span>, <span class="hljs-attr">ord_date</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">&quot;2020-03-20&quot;</span>), <span class="hljs-attr">price</span>: <span class="hljs-number">25</span>, <span class="hljs-attr">items</span>: [ &#123; <span class="hljs-attr">sku</span>: <span class="hljs-string">&quot;oranges&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">2.5</span> &#125; ], <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;A&quot;</span> &#125;,<br>   &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">8</span>, <span class="hljs-attr">cust_id</span>: <span class="hljs-string">&quot;Don Quis&quot;</span>, <span class="hljs-attr">ord_date</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">&quot;2020-03-20&quot;</span>), <span class="hljs-attr">price</span>: <span class="hljs-number">75</span>, <span class="hljs-attr">items</span>: [ &#123; <span class="hljs-attr">sku</span>: <span class="hljs-string">&quot;chocolates&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">5</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">10</span> &#125;, &#123; <span class="hljs-attr">sku</span>: <span class="hljs-string">&quot;apples&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">2.5</span> &#125; ], <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;A&quot;</span> &#125;,<br>   &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">9</span>, <span class="hljs-attr">cust_id</span>: <span class="hljs-string">&quot;Don Quis&quot;</span>, <span class="hljs-attr">ord_date</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">&quot;2020-03-20&quot;</span>), <span class="hljs-attr">price</span>: <span class="hljs-number">55</span>, <span class="hljs-attr">items</span>: [ &#123; <span class="hljs-attr">sku</span>: <span class="hljs-string">&quot;carrots&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">5</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">1.0</span> &#125;, &#123; <span class="hljs-attr">sku</span>: <span class="hljs-string">&quot;apples&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">2.5</span> &#125;, &#123; <span class="hljs-attr">sku</span>: <span class="hljs-string">&quot;oranges&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">2.5</span> &#125; ], <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;A&quot;</span> &#125;,<br>   &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">cust_id</span>: <span class="hljs-string">&quot;Don Quis&quot;</span>, <span class="hljs-attr">ord_date</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">&quot;2020-03-23&quot;</span>), <span class="hljs-attr">price</span>: <span class="hljs-number">25</span>, <span class="hljs-attr">items</span>: [ &#123; <span class="hljs-attr">sku</span>: <span class="hljs-string">&quot;oranges&quot;</span>, <span class="hljs-attr">qty</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">2.5</span> &#125; ], <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;A&quot;</span> &#125;<br>])<br></code></pre></td></tr></table></figure><p>求每位客户订单的总额</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// 定义map函数，需要返回一个键值对</span><br><span class="hljs-keyword">var</span> mapFun = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">emit</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cust_id</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">price</span>);<br>&#125;<br><br><span class="hljs-comment">// 定义reduce函数，实现价格统计</span><br><span class="hljs-keyword">var</span> reduceFun = <span class="hljs-keyword">function</span>(<span class="hljs-params">cust_id, price</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">sum</span>(price);<br>&#125;<br><br>db.<span class="hljs-property">orders</span>.<span class="hljs-title function_">mapReduce</span>(<br>    mapFun,<br>    reduceFun,<br>    &#123; <span class="hljs-attr">out</span>: <span class="hljs-string">&quot;map_reduce_example&quot;</span> &#125;   <span class="hljs-comment">// 将结果输出到一个集合</span><br>)<br></code></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-title function_">getCollection</span>(<span class="hljs-string">&#x27;map_reduce_example&#x27;</span>).<span class="hljs-title function_">find</span>(&#123;&#125;)<br><br><br><span class="hljs-comment">/* 1 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-string">&quot;Don Quis&quot;</span>,<br>    <span class="hljs-string">&quot;value&quot;</span> : <span class="hljs-number">155.0</span><br>&#125;<br><br><span class="hljs-comment">/* 2 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-string">&quot;Cam Elot&quot;</span>,<br>    <span class="hljs-string">&quot;value&quot;</span> : <span class="hljs-number">60.0</span><br>&#125;<br><br><span class="hljs-comment">/* 3 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-string">&quot;Busby Bee&quot;</span>,<br>    <span class="hljs-string">&quot;value&quot;</span> : <span class="hljs-number">125.0</span><br>&#125;<br><br><span class="hljs-comment">/* 4 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-string">&quot;Ant O. Knee&quot;</span>,<br>    <span class="hljs-string">&quot;value&quot;</span> : <span class="hljs-number">95.0</span><br>&#125;<br></code></pre></td></tr></table></figure><h1 id="视图"><a class="markdownIt-Anchor" href="#视图"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/core/views/">视图</a></h1><p class="note note-primary">只读</p><p>MongoDB 视图是一个只读的可查询对象，其内容由其他集合或视图上的聚合管道定义，通过视图进行写操作会报错</p><p>MongoDB不会将视图内容保存到磁盘。当客户端查询视图时，将按需计算视图的内容</p><p class="note note-primary">视图种类</p><p>MongoDB提供两种不同的视图类型：标准视图和物化视图。这两种视图类型都从聚合管道返回结果</p><ul><li>标准视图是在读取视图时计算的，不会存储到磁盘(和mysql一样，对查询进行封装)</li><li>视图存储在磁盘上并从磁盘读取。他们使用 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/reference/operator/aggregation/merge/#mongodb-pipeline-pipe.-merge"><code>$merge</code></a> 或 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/reference/operator/aggregation/out/#mongodb-pipeline-pipe.-out"><code>$out</code></a> 阶段来更新保存的数据</li></ul><p class="note note-primary">物化视图</p><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/core/materialized-views/">物化视图</a>（Materialized Views）是一种预计算和存储查询结果的数据结构。它们类似于传统数据库中的视图，但与视图不同，物化视图会将查询结果实际存储在磁盘上，而不是每次查询时动态计算。</p><p>MongoDB 4.2 版本引入了物化视图的概念。使用物化视图，您可以定义一个查询，并将其结果存储在集合中。这样，当数据发生变化时，您可以通过刷新物化视图来更新存储的查询结果，而不需要重新执行整个查询。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// 创建源集合</span><br>db.<span class="hljs-property">sourceCollection</span>.<span class="hljs-title function_">insertMany</span>([<br>  &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">1</span>,: <span class="hljs-string">&quot;John&quot;</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">25</span> &#125;,<br>  &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">2</span>,: <span class="hljs-string">&quot;Jane&quot;</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">30</span> &#125;,<br>  &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Bob&quot;</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">35</span> &#125;<br>]);<br><br><span class="hljs-comment">// 定义聚合管道</span><br><span class="hljs-keyword">var</span> pipeline = [<br>  &#123; <span class="hljs-attr">$match</span>: &#123; <span class="hljs-attr">age</span>: &#123; <span class="hljs-attr">$gte</span>: <span class="hljs-number">30</span> &#125; &#125; &#125;,<br>  &#123; <span class="hljs-attr">$project</span>: &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">0</span>,: <span class="hljs-number">1</span> &#125; &#125;<br>];<br><br><span class="hljs-comment">// 创建物化视图</span><br>db.<span class="hljs-title function_">createView</span>(<span class="hljs-string">&quot;myMaterializedView&quot;</span>, <span class="hljs-string">&quot;sourceCollection&quot;</span>, pipeline);<br><br><span class="hljs-comment">// 刷新物化视图</span><br>db.<span class="hljs-property">myMaterializedView</span>.<span class="hljs-title function_">refresh</span>();<br></code></pre></td></tr></table></figure><p class="note note-primary">索引</p><ul><li>标准视图使用基础集合的索引。因此，您无法直接在标准视图上创建、删除或重新生成索引，也无法在视图上获取索引列表</li><li>可以直接在物化视图上创建索引，因为它们存储在磁盘上</li></ul><h2 id="创建视图"><a class="markdownIt-Anchor" href="#创建视图"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/core/views/create-view/">创建视图</a></h2><p class="note note-primary">语法</p><p></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-title function_">createView</span>(<br>  <span class="hljs-string">&quot;&lt;viewName&gt;&quot;</span>,			<span class="hljs-comment">// 视图名称</span><br>  <span class="hljs-string">&quot;&lt;source&gt;&quot;</span>,				<span class="hljs-comment">// 数据源</span><br>  [&lt;pipeline&gt;],			<span class="hljs-comment">// 管道</span><br>  &#123;<br>    <span class="hljs-string">&quot;collation&quot;</span> : &#123; &lt;collation&gt; &#125;<br>  &#125;<br>)<br></code></pre></td></tr></table></figure><p></p><p class="note note-primary">限制</p><p></p><ul><li>不支持 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/reference/method/db.collection.mapReduce/#mongodb-method-db.collection.mapReduce"><code>db.collection.mapReduce()</code></a></li><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/reference/operator/query/text/#mongodb-query-op.-text"><code>$text</code></a> 运算符，因为聚合中的 <code>$text</code> 操作仅对第一阶段有效</li><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/reference/operator/aggregation/geoNear/#mongodb-pipeline-pipe.-geoNear"><code>$geoNear</code></a></li><li>重命名视图</li></ul><p></p><p class="note note-primary">创建单集合视图</p><p></p><p>测试数据</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">students</span>.<span class="hljs-title function_">insertMany</span>( [<br>   &#123; <span class="hljs-attr">sID</span>: <span class="hljs-number">22001</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Alex&quot;</span>, <span class="hljs-attr">year</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">score</span>: <span class="hljs-number">4.0</span> &#125;,<br>   &#123; <span class="hljs-attr">sID</span>: <span class="hljs-number">21001</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;bernie&quot;</span>, <span class="hljs-attr">year</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">score</span>: <span class="hljs-number">3.7</span> &#125;,<br>   &#123; <span class="hljs-attr">sID</span>: <span class="hljs-number">20010</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Chris&quot;</span>, <span class="hljs-attr">year</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">score</span>: <span class="hljs-number">2.5</span> &#125;,<br>   &#123; <span class="hljs-attr">sID</span>: <span class="hljs-number">22021</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Drew&quot;</span>, <span class="hljs-attr">year</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">score</span>: <span class="hljs-number">3.2</span> &#125;,<br>   &#123; <span class="hljs-attr">sID</span>: <span class="hljs-number">17301</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;harley&quot;</span>, <span class="hljs-attr">year</span>: <span class="hljs-number">6</span>, <span class="hljs-attr">score</span>: <span class="hljs-number">3.1</span> &#125;,<br>   &#123; <span class="hljs-attr">sID</span>: <span class="hljs-number">21022</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Farmer&quot;</span>, <span class="hljs-attr">year</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">score</span>: <span class="hljs-number">2.2</span> &#125;,<br>   &#123; <span class="hljs-attr">sID</span>: <span class="hljs-number">20020</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;george&quot;</span>, <span class="hljs-attr">year</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">score</span>: <span class="hljs-number">2.8</span> &#125;,<br>   &#123; <span class="hljs-attr">sID</span>: <span class="hljs-number">18020</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Harley&quot;</span>, <span class="hljs-attr">year</span>: <span class="hljs-number">5</span>, <span class="hljs-attr">score</span>: <span class="hljs-number">2.8</span> &#125;,<br>] )<br></code></pre></td></tr></table></figure><p>创建一个只有一年级学生的视图</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-title function_">createView</span>(<br>    <span class="hljs-string">&quot;firstYear&quot;</span>,    <span class="hljs-comment">// 视图名称</span><br>    <span class="hljs-string">&quot;students&quot;</span>,     <span class="hljs-comment">// 集合名称</span><br>    [<br>        &#123; <span class="hljs-attr">$match</span>: &#123; <span class="hljs-attr">year</span>: <span class="hljs-number">1</span> &#125; &#125;,   <span class="hljs-comment">// 数据过滤     </span><br>        &#123; <span class="hljs-attr">$sort</span>: &#123; <span class="hljs-attr">score</span>: <span class="hljs-number">1</span> &#125; &#125;    <span class="hljs-comment">// 分数排序</span><br>    ]<br>)<br></code></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">firstYear</span>.<span class="hljs-title function_">find</span>(&#123;&#125;)<br><br><br><span class="hljs-comment">/* 1 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;64552b676378f2a57f74e957&quot;</span>),<br>    <span class="hljs-string">&quot;sID&quot;</span> : <span class="hljs-number">21022.0</span>,<br>    <span class="hljs-string">&quot;name&quot;</span> : <span class="hljs-string">&quot;Farmer&quot;</span>,<br>    <span class="hljs-string">&quot;year&quot;</span> : <span class="hljs-number">1.0</span>,<br>    <span class="hljs-string">&quot;score&quot;</span> : <span class="hljs-number">2.2</span><br>&#125;<br><br><span class="hljs-comment">/* 2 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;64552b676378f2a57f74e955&quot;</span>),<br>    <span class="hljs-string">&quot;sID&quot;</span> : <span class="hljs-number">22021.0</span>,<br>    <span class="hljs-string">&quot;name&quot;</span> : <span class="hljs-string">&quot;Drew&quot;</span>,<br>    <span class="hljs-string">&quot;year&quot;</span> : <span class="hljs-number">1.0</span>,<br>    <span class="hljs-string">&quot;score&quot;</span> : <span class="hljs-number">3.2</span><br>&#125;<br><br><span class="hljs-comment">/* 3 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;64552b676378f2a57f74e952&quot;</span>),<br>    <span class="hljs-string">&quot;sID&quot;</span> : <span class="hljs-number">22001.0</span>,<br>    <span class="hljs-string">&quot;name&quot;</span> : <span class="hljs-string">&quot;Alex&quot;</span>,<br>    <span class="hljs-string">&quot;year&quot;</span> : <span class="hljs-number">1.0</span>,<br>    <span class="hljs-string">&quot;score&quot;</span> : <span class="hljs-number">4.0</span><br>&#125;<br></code></pre></td></tr></table></figure><p class="note note-primary">创建多集合的视图</p><p></p><p>测试数据</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">orders</span>.<span class="hljs-title function_">insertMany</span>( [<br>   &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">1</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;almonds&quot;</span>, <span class="hljs-string">&quot;price&quot;</span> : <span class="hljs-number">12</span>, <span class="hljs-string">&quot;quantity&quot;</span> : <span class="hljs-number">2</span> &#125;,<br>   &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">2</span>, <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;pecans&quot;</span>, <span class="hljs-string">&quot;price&quot;</span> : <span class="hljs-number">20</span>, <span class="hljs-string">&quot;quantity&quot;</span> : <span class="hljs-number">1</span> &#125;,<br>   &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">3</span>  &#125;<br>] )<br></code></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">insertMany</span>( [<br>   &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">1</span>, <span class="hljs-string">&quot;sku&quot;</span> : <span class="hljs-string">&quot;almonds&quot;</span>, <span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;product 1&quot;</span>, <span class="hljs-string">&quot;instock&quot;</span> : <span class="hljs-number">120</span> &#125;,<br>   &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">2</span>, <span class="hljs-string">&quot;sku&quot;</span> : <span class="hljs-string">&quot;bread&quot;</span>, <span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;product 2&quot;</span>, <span class="hljs-string">&quot;instock&quot;</span> : <span class="hljs-number">80</span> &#125;,<br>   &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">3</span>, <span class="hljs-string">&quot;sku&quot;</span> : <span class="hljs-string">&quot;cashews&quot;</span>, <span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;product 3&quot;</span>, <span class="hljs-string">&quot;instock&quot;</span> : <span class="hljs-number">60</span> &#125;,<br>   &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">4</span>, <span class="hljs-string">&quot;sku&quot;</span> : <span class="hljs-string">&quot;pecans&quot;</span>, <span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;product 4&quot;</span>, <span class="hljs-string">&quot;instock&quot;</span> : <span class="hljs-number">70</span> &#125;,<br>   &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">5</span>, <span class="hljs-string">&quot;sku&quot;</span>: <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;Incomplete&quot;</span> &#125;,<br>   &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">6</span> &#125;<br>] )<br></code></pre></td></tr></table></figure><p>创建一个视图，使用 <code>orders</code> 的 <code>item</code> 字段关联 <code>inventory</code> 集合的 <code>sku</code> ,并输出 item 和 sku 字段</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-title function_">createView</span>(<br>    <span class="hljs-string">&quot;orderDetail&quot;</span>,<br>    <span class="hljs-string">&quot;orders&quot;</span>,<br>    [<br>        &#123;<br>            <span class="hljs-attr">$lookup</span>: &#123; <span class="hljs-attr">from</span>: <span class="hljs-string">&quot;inventory&quot;</span>, <span class="hljs-attr">localField</span>: <span class="hljs-string">&quot;item&quot;</span>, <span class="hljs-attr">foreignField</span>:<span class="hljs-string">&quot;sku&quot;</span>, <span class="hljs-attr">as</span>: <span class="hljs-string">&quot;product&quot;</span>&#125;<br>        &#125;,<br>        &#123;<br>            <span class="hljs-attr">$project</span>: &#123; <span class="hljs-attr">item</span>:<span class="hljs-number">1</span>, <span class="hljs-string">&quot;product.sku&quot;</span>:<span class="hljs-number">1</span> &#125;<br>        &#125;<br>    ]<br>)<br><br><br>db.<span class="hljs-title function_">getCollection</span>(<span class="hljs-string">&#x27;orderDetail&#x27;</span>).<span class="hljs-title function_">find</span>(&#123;&#125;)<br><span class="hljs-comment">/* 1 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">1.0</span>,<br>    <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;almonds&quot;</span>,<br>    <span class="hljs-string">&quot;product&quot;</span> : [ <br>        &#123;<br>            <span class="hljs-string">&quot;sku&quot;</span> : <span class="hljs-string">&quot;almonds&quot;</span><br>        &#125;<br>    ]<br>&#125;<br><br><span class="hljs-comment">/* 2 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">2.0</span>,<br>    <span class="hljs-string">&quot;item&quot;</span> : <span class="hljs-string">&quot;pecans&quot;</span>,<br>    <span class="hljs-string">&quot;product&quot;</span> : [ <br>        &#123;<br>            <span class="hljs-string">&quot;sku&quot;</span> : <span class="hljs-string">&quot;pecans&quot;</span><br>        &#125;<br>    ]<br>&#125;<br><br><span class="hljs-comment">/* 3 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">3.0</span>,<br>    <span class="hljs-string">&quot;product&quot;</span> : [ <br>        &#123;<br>            <span class="hljs-string">&quot;sku&quot;</span> : <span class="hljs-literal">null</span><br>        &#125;, <br>        &#123;&#125;<br>    ]<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="修改视图"><a class="markdownIt-Anchor" href="#修改视图"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/core/views/update-view/">修改视图</a></h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-title function_">runCommand</span>( &#123;<br>   <span class="hljs-attr">collMod</span>: <span class="hljs-string">&quot;lowStock&quot;</span>,		<span class="hljs-comment">// 视图名</span><br>   <span class="hljs-attr">viewOn</span>: <span class="hljs-string">&quot;products&quot;</span>,		<span class="hljs-comment">// 集合</span><br>   <span class="hljs-string">&quot;pipeline&quot;</span>: []					<span class="hljs-comment">// 要求修改的管道</span><br>&#125; )<br></code></pre></td></tr></table></figure><p>测试数据</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">students</span>.<span class="hljs-title function_">insertMany</span>( [<br>   &#123; <span class="hljs-attr">sID</span>: <span class="hljs-number">22001</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Alex&quot;</span>, <span class="hljs-attr">year</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">score</span>: <span class="hljs-number">4.0</span> &#125;,<br>   &#123; <span class="hljs-attr">sID</span>: <span class="hljs-number">21001</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;bernie&quot;</span>, <span class="hljs-attr">year</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">score</span>: <span class="hljs-number">3.7</span> &#125;,<br>   &#123; <span class="hljs-attr">sID</span>: <span class="hljs-number">20010</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Chris&quot;</span>, <span class="hljs-attr">year</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">score</span>: <span class="hljs-number">2.5</span> &#125;,<br>   &#123; <span class="hljs-attr">sID</span>: <span class="hljs-number">22021</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Drew&quot;</span>, <span class="hljs-attr">year</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">score</span>: <span class="hljs-number">3.2</span> &#125;,<br>   &#123; <span class="hljs-attr">sID</span>: <span class="hljs-number">17301</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;harley&quot;</span>, <span class="hljs-attr">year</span>: <span class="hljs-number">6</span>, <span class="hljs-attr">score</span>: <span class="hljs-number">3.1</span> &#125;,<br>   &#123; <span class="hljs-attr">sID</span>: <span class="hljs-number">21022</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Farmer&quot;</span>, <span class="hljs-attr">year</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">score</span>: <span class="hljs-number">2.2</span> &#125;,<br>   &#123; <span class="hljs-attr">sID</span>: <span class="hljs-number">20020</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;george&quot;</span>, <span class="hljs-attr">year</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">score</span>: <span class="hljs-number">2.8</span> &#125;,<br>   &#123; <span class="hljs-attr">sID</span>: <span class="hljs-number">18020</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Harley&quot;</span>, <span class="hljs-attr">year</span>: <span class="hljs-number">5</span>, <span class="hljs-attr">score</span>: <span class="hljs-number">2.8</span> &#125;,<br>] )<br></code></pre></td></tr></table></figure><p>创建一张只包含1年级学生的视图</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-title function_">createView</span>(<br>    <span class="hljs-string">&quot;studentsView&quot;</span>,<br>    <span class="hljs-string">&quot;students&quot;</span>,<br>    [ &#123; <span class="hljs-attr">$match</span>: &#123; <span class="hljs-attr">year</span>: <span class="hljs-number">1</span> &#125; &#125; ]<br>)<br></code></pre></td></tr></table></figure><p>视图修改，改为只包含2年级学生的视图</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-title function_">runCommand</span>(<br>    &#123;<br>        <span class="hljs-attr">collMod</span>: <span class="hljs-string">&quot;studentsView&quot;</span>,<br>        <span class="hljs-attr">viewOn</span>: <span class="hljs-string">&quot;students&quot;</span>,<br>        <span class="hljs-attr">pipeline</span>: [ &#123; <span class="hljs-attr">$match</span>: &#123; <span class="hljs-attr">year</span>: <span class="hljs-number">2</span> &#125; &#125; ]<br>    &#125;<br>)<br></code></pre></td></tr></table></figure><h2 id="删除视图"><a class="markdownIt-Anchor" href="#删除视图"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/core/views/drop-view/">删除视图</a></h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">view</span>.<span class="hljs-title function_">drop</span>()<br></code></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">studentsView</span>.<span class="hljs-title function_">drop</span>()<br></code></pre></td></tr></table></figure><h1 id="索引"><a class="markdownIt-Anchor" href="#索引"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/indexes/">索引</a></h1><p>索引支持在MongoDB中高效执行查询。如果没有索引，MongoDB必须执行集合扫描，即扫描集合中的每个文档，以选择与查询语句匹配的文档。如果查询存在适当的索引，MongoDB可以使用该索引来限制它必须检查的文档数量</p><p><span class="green-line">索引是特殊的数据结构（B+树，官网说的B树实际上是文化差异，老外认为B+树是B树的变种）</span> ，它以易于遍历的形式存储集合数据集的一小部分。索引存储特定字段或一组字段的值，按字段值排序。索引条目的排序支持高效的相等匹配和基于范围的查询操作。此外，MongoDB可以使用索引中的排序返回排序结果</p><p><img src="/2023/04/14/MongoDB/%E7%B4%A2%E5%BC%95.png" srcset="/img/loading.gif" lazyload alt="使用索引匹配和排序"></p><p>从根本上说，MongoDB中的索引类似于其他数据库系统中的索引。MongoDB在集合级别定义索引，并支持MongoDB集合中文档的任何字段或子字段上的索引</p><p class="note note-primary">默认 _id 索引</p><p>MongoDB在创建集合期间在 <code>_id</code> 字段上创建一个 <code>唯一索引</code>。 <code>_id</code> 索引可防止客户端为 <code>_id</code> 字段插入两个具有相同值的文档。不能将 <code>_id</code> 字段的索引删除</p><blockquote><p>在分片集群中，如果你不使用 <code>_id</code> 字段作为分片键，那么你的应用程序必须确保 <code>_id</code> 字段中值的唯一性以防止错误。这通常是通过使用标准的自动生成的 ObjectId 来完成的</p></blockquote><p class="note note-primary">创建索引</p><p>要在 Mongo Shell 中创建索引，请使用 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/db.collection.createIndex/#mongodb-method-db.collection.createIndex"><code>db.collection.createIndex()</code></a></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">collection</span>.<span class="hljs-title function_">createIndex</span>( &lt;key and index type specification&gt;, &lt;options&gt; )<br></code></pre></td></tr></table></figure><p>参考<a href="#%E7%B4%A2%E5%BC%95%E5%B1%9E%E6%80%A7">索引属性</a></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">collection</span>.<span class="hljs-title function_">createIndex</span>( &#123; <span class="hljs-attr">name</span>: -<span class="hljs-number">1</span> &#125; )<br></code></pre></td></tr></table></figure><p class="note note-primary">索引名称</p><p>索引的默认名称是索引键和索引中每个键排序（即 1 或 -1）的串联，使用下划线作为分隔符。例如，在 <code>&#123; item : 1, quantity: -1 &#125;</code> 上创建的索引的名称为 <code>item_1_quantity_-1</code></p><p>可以自定义索引名称</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">products</span>.<span class="hljs-title function_">createIndex</span>(<br>  &#123; <span class="hljs-attr">item</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">quantity</span>: -<span class="hljs-number">1</span> &#125; ,<br>  &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;query for inventory&quot;</span> &#125;<br>)<br></code></pre></td></tr></table></figure><p class="note note-primary">查看索引</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs javascript">查看索引信息 db.<span class="hljs-property">books</span>.<span class="hljs-title function_">getIndexes</span>() <br>查看索引键 db.<span class="hljs-property">books</span>.<span class="hljs-title function_">getIndexKeys</span>()<br></code></pre></td></tr></table></figure><p class="note note-primary">查看索引占用空间</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">collection</span>.<span class="hljs-title function_">totalIndexSize</span>([is_detail])<br></code></pre></td></tr></table></figure><p>is_detail：可选参数，传入除0或false外的任意数据，都会显示该集合中每个索引的大小及总大小。如果传入0或false则只显示该集合中所有索引的总大小。默认值为false</p><p class="note note-primary">删除索引</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs javascript">删除集合指定索引 db.<span class="hljs-property">col</span>.<span class="hljs-title function_">dropIndex</span>(<span class="hljs-string">&quot;索引名称&quot;</span>)<br>删除集合所有索引 db.<span class="hljs-property">col</span>.<span class="hljs-title function_">dropIndexes</span>()<br></code></pre></td></tr></table></figure><h2 id="索引类型"><a class="markdownIt-Anchor" href="#索引类型"></a> 索引类型</h2><p>MongoDB提供了许多不同的索引类型来支持特定类型的数据和查询</p><h3 id="单字段索引"><a class="markdownIt-Anchor" href="#单字段索引"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/index-single/">单字段索引</a></h3><p><img src="/2023/04/14/MongoDB/%E5%8D%95%E5%AD%97%E6%AE%B5%E7%B4%A2%E5%BC%95.png" srcset="/img/loading.gif" lazyload alt></p><p>MongoDB为文档集合中任何字段的索引提供了完整的支持。默认情况下，所有集合在 _id 字段上都有一个索引，应用程序和用户可以添加其他索引来支持重要的查询和操作</p><p class="note note-primary">创建一个单字段索引</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">records</span>.<span class="hljs-title function_">createIndex</span>( &#123; <span class="hljs-attr">score</span>: <span class="hljs-number">1</span> &#125; )<br></code></pre></td></tr></table></figure><ul><li>1: 索引升序排序</li><li>-1: 索引降序排序</li></ul><p class="note note-primary">在嵌套字段建立索引</p><p>测试数据</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">records</span>.<span class="hljs-title function_">insertOne</span>(<br>    &#123;<br>      <span class="hljs-string">&quot;_id&quot;</span>: <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;570c04a4ad233577f97dc459&quot;</span>),<br>      <span class="hljs-string">&quot;score&quot;</span>: <span class="hljs-number">1034</span>,<br>      <span class="hljs-string">&quot;location&quot;</span>: &#123; <span class="hljs-attr">state</span>: <span class="hljs-string">&quot;NY&quot;</span>, <span class="hljs-attr">city</span>: <span class="hljs-string">&quot;New York&quot;</span> &#125;<br>    &#125;<br>)<br></code></pre></td></tr></table></figure><p>以下操作在 <code>location.state</code> 字段上创建索引：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">records</span>.<span class="hljs-title function_">createIndex</span>(&#123;<span class="hljs-string">&quot;location.state&quot;</span>: <span class="hljs-number">1</span>&#125;)<br><br><br>db.<span class="hljs-property">records</span>.<span class="hljs-title function_">getIndexKeys</span>()<br><br><br>[<br>    &#123;<br>        <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">1</span><br>    &#125;,<br>    &#123;<br>        <span class="hljs-string">&quot;location.state&quot;</span> : <span class="hljs-number">1.0</span><br>    &#125;<br>]<br></code></pre></td></tr></table></figure><p class="note note-primary">在嵌套文档上创建索引</p><p>支持对整个嵌套文档创建索引</p><p><code>location</code> 字段是一个嵌套文档，包含嵌入字段 <code>city</code> 和 <code>state</code> 。以下命令在整个 <code>location</code> 字段上创建索引：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">records</span>.<span class="hljs-title function_">createIndex</span>( &#123; <span class="hljs-attr">location</span>: <span class="hljs-number">1</span> &#125; )<br></code></pre></td></tr></table></figure><h3 id="复合索引"><a class="markdownIt-Anchor" href="#复合索引"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/index-compound/">复合索引</a></h3><p>复合索引是多个字段组合而成的索引，其性质和单字段索引类似。但不同的是，复合索引中字段的顺序、字段的升降序对查询性能有直接的影响，因此在设计复合索引时则需要考虑不同的查询场景</p><p><img src="/2023/04/14/MongoDB/%E5%A4%8D%E5%90%88%E7%B4%A2%E5%BC%95.png" srcset="/img/loading.gif" lazyload alt></p><blockquote><p>MongoDB对任何复合索引施加了32个字段的限制</p></blockquote><p class="note note-primary">创建索引</p><p>测试数据</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">products</span>.<span class="hljs-title function_">insertOne</span>(<br>    &#123;<br>     <span class="hljs-string">&quot;_id&quot;</span>: <span class="hljs-number">1</span>,<br>     <span class="hljs-string">&quot;item&quot;</span>: <span class="hljs-string">&quot;Banana&quot;</span>,<br>     <span class="hljs-string">&quot;category&quot;</span>: [<span class="hljs-string">&quot;food&quot;</span>, <span class="hljs-string">&quot;produce&quot;</span>, <span class="hljs-string">&quot;grocery&quot;</span>],<br>     <span class="hljs-string">&quot;location&quot;</span>: <span class="hljs-string">&quot;4th Street Store&quot;</span>,<br>     <span class="hljs-string">&quot;stock&quot;</span>: <span class="hljs-number">4</span>,<br>     <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;cases&quot;</span><br>    &#125;<br>)<br></code></pre></td></tr></table></figure><p>以下操作在 <code>item</code> 和 <code>stock</code> 字段上分别创建升序和降序索引：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">products</span>.<span class="hljs-title function_">createIndex</span>(<br>    &#123;<br>        <span class="hljs-attr">item</span>: <span class="hljs-number">1</span>,<br>        <span class="hljs-attr">stock</span>: -<span class="hljs-number">1</span><br>    &#125;<br>)<br></code></pre></td></tr></table></figure><blockquote><p>复合索引和SQL一样，在使用时需要遵循 <code>最左匹配原则</code>，并且复合索引的排序要根据业务查询的实际排序为准</p></blockquote><h3 id="多键索引"><a class="markdownIt-Anchor" href="#多键索引"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/index-multikey/">多键索引</a></h3><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/multikey-index-bounds/">多键索引范围</a></p><p>在 <code>数组</code> 的属性上建立索引。MongoDB为数组中的每个元素创建一个索引键。这些多键索引支持对数组字段进行高效查询</p><p><img src="/2023/04/14/MongoDB/%E5%A4%9A%E9%94%AE%E7%B4%A2%E5%BC%95.png" srcset="/img/loading.gif" lazyload alt></p><p class="note note-primary">索引基本数组</p><p>测试数据</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">survey</span>.<span class="hljs-title function_">insertOne</span>(<br>   &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">item</span>: <span class="hljs-string">&quot;ABC&quot;</span>, <span class="hljs-attr">ratings</span>: [ <span class="hljs-number">2</span>, <span class="hljs-number">5</span>, <span class="hljs-number">9</span> ], <span class="hljs-attr">range</span>: [<span class="hljs-number">8</span>, <span class="hljs-number">10</span>, <span class="hljs-number">15</span>] &#125;<br>)<br></code></pre></td></tr></table></figure><p>为数组字段 <code>ratings</code> 创建多键索引</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">survey</span>.<span class="hljs-title function_">createIndex</span>(<br>    &#123;<br>        <span class="hljs-attr">ratings</span>: <span class="hljs-number">1</span><br>    &#125;<br>)<br></code></pre></td></tr></table></figure><p>由于 <code>ratings</code> 字段包含一个数组，因此 <code>ratings</code> 上的索引是多键的。多键索引包含以下三个索引键，每个索引键指向同一文档：</p><ul><li>2</li><li>5</li><li>9</li></ul><div class="note note-warning"><p>注意</p><p>对于一个复合索引而言，一个索引文档只能包含一个多键索引（一个基本数组类型的字段索引），否则创建索引会报错</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">survey</span>.<span class="hljs-title function_">createIndex</span>(<span class="hljs-params"></span><br><span class="hljs-params">    &#123;</span><br><span class="hljs-params">        ratings: <span class="hljs-number">1</span>,</span><br><span class="hljs-params">        range: <span class="hljs-number">1</span></span><br><span class="hljs-params">    &#125;</span><br><span class="hljs-params"></span>)<br><br>&#123;<br>    <span class="hljs-string">&quot;ok&quot;</span> : <span class="hljs-number">0.0</span>,<br>    <span class="hljs-string">&quot;errmsg&quot;</span> : <span class="hljs-string">&quot;Index build failed: 9a1ff53c-5550-4315-a94f-74998bd81ab4: Collection test.survey ( 6d437930-01ee-4911-82e5-a3653088c692 ) :: caused by :: cannot index parallel arrays [range] [ratings]&quot;</span>,<br>    <span class="hljs-string">&quot;code&quot;</span> : <span class="hljs-number">171</span>,<br>    <span class="hljs-string">&quot;codeName&quot;</span> : <span class="hljs-string">&quot;CannotIndexParallelArrays&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure></div><p class="note note-primary">索引嵌套文档数组</p><p>测试数据</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">insertOne</span>(<br>    &#123;<br>      <span class="hljs-attr">_id</span>: <span class="hljs-number">1</span>,<br>      <span class="hljs-attr">item</span>: <span class="hljs-string">&quot;abc&quot;</span>,<br>      <span class="hljs-attr">stock</span>: [<br>        &#123; <span class="hljs-attr">size</span>: <span class="hljs-string">&quot;S&quot;</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">&quot;red&quot;</span>, <span class="hljs-attr">quantity</span>: <span class="hljs-number">25</span> &#125;,<br>        &#123; <span class="hljs-attr">size</span>: <span class="hljs-string">&quot;S&quot;</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">&quot;blue&quot;</span>, <span class="hljs-attr">quantity</span>: <span class="hljs-number">10</span> &#125;,<br>        &#123; <span class="hljs-attr">size</span>: <span class="hljs-string">&quot;M&quot;</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">&quot;blue&quot;</span>, <span class="hljs-attr">quantity</span>: <span class="hljs-number">50</span> &#125;<br>      ]<br>    &#125;<br>)<br></code></pre></td></tr></table></figure><p>以下操作在 <code>stock.size</code> 和 <code>stock.quantity</code> 字段上创建多键索引：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">createIndex</span>(<br>    &#123;<br>        <span class="hljs-string">&quot;stock.size&quot;</span>: <span class="hljs-number">1</span>,<br>        <span class="hljs-string">&quot;stock.quantity&quot;</span>: <span class="hljs-number">1</span><br>    &#125;<br>)<br></code></pre></td></tr></table></figure><p>复合多键索引可以支持具有谓词的查询，这些谓词既包括索引字段，也包括仅包括索引前缀 <code>stock.size</code> 的谓词。如以下例子所示:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">find</span>( &#123; <span class="hljs-string">&quot;stock.size&quot;</span>: <span class="hljs-string">&quot;M&quot;</span> &#125; )<br>db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">find</span>( &#123; <span class="hljs-string">&quot;stock.size&quot;</span>: <span class="hljs-string">&quot;S&quot;</span>, <span class="hljs-string">&quot;stock.quantity&quot;</span>: &#123; <span class="hljs-attr">$gt</span>: <span class="hljs-number">20</span> &#125; &#125; )<br></code></pre></td></tr></table></figure><h3 id="文本索引"><a class="markdownIt-Anchor" href="#文本索引"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/index-text/">文本索引</a></h3><p>一个集合只能有一个文本搜索索引，但该索引可以涵盖多个字段</p><p>MongoDB的文本索引功能存在诸多限制，而官方并未提供中文分词的功能，这使得该功能的应用场景十分受限</p><p>用法</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">reviews</span>.<span class="hljs-title function_">createIndex</span>( &#123; <span class="hljs-attr">comments</span>: <span class="hljs-string">&quot;text&quot;</span>, <span class="hljs-attr">description</span>: <span class="hljs-string">&quot;text&quot;</span> &#125; )<br></code></pre></td></tr></table></figure><p>测试数据</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">insertMany</span>(<br>    [<br>        &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">dept</span>: <span class="hljs-string">&quot;tech&quot;</span>, <span class="hljs-attr">description</span>: <span class="hljs-string">&quot;lime green computer&quot;</span> &#125;,<br>        &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">dept</span>: <span class="hljs-string">&quot;tech&quot;</span>, <span class="hljs-attr">description</span>: <span class="hljs-string">&quot;wireless red mouse&quot;</span> &#125;,<br>        &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">dept</span>: <span class="hljs-string">&quot;kitchen&quot;</span>, <span class="hljs-attr">description</span>: <span class="hljs-string">&quot;green placemat&quot;</span> &#125;,<br>        &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">4</span>, <span class="hljs-attr">dept</span>: <span class="hljs-string">&quot;kitchen&quot;</span>, <span class="hljs-attr">description</span>: <span class="hljs-string">&quot;red peeler&quot;</span> &#125;,<br>        &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">5</span>, <span class="hljs-attr">dept</span>: <span class="hljs-string">&quot;food&quot;</span>, <span class="hljs-attr">description</span>: <span class="hljs-string">&quot;green apple&quot;</span> &#125;,<br>        &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">6</span>, <span class="hljs-attr">dept</span>: <span class="hljs-string">&quot;food&quot;</span>, <span class="hljs-attr">description</span>: <span class="hljs-string">&quot;red potato&quot;</span> &#125;<br>    ]<br>)<br></code></pre></td></tr></table></figure><p>为 <code>description</code> 字段创建文本索引</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">db.inventory.createIndex(<br>    &#123; description: <span class="hljs-string">&quot;text&quot;</span> &#125;<br>)<br></code></pre></td></tr></table></figure><p>使用文本索引搜索</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">inventory</span>.<span class="hljs-title function_">find</span>(<br>    &#123;<br>        <span class="hljs-attr">$text</span>: &#123; <span class="hljs-attr">$search</span>: <span class="hljs-string">&quot;green&quot;</span> &#125;<br>    &#125;<br>)<br><br><br><span class="hljs-comment">/* 1 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">5.0</span>,<br>    <span class="hljs-string">&quot;dept&quot;</span> : <span class="hljs-string">&quot;food&quot;</span>,<br>    <span class="hljs-string">&quot;description&quot;</span> : <span class="hljs-string">&quot;green apple&quot;</span><br>&#125;<br><br><span class="hljs-comment">/* 2 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">3.0</span>,<br>    <span class="hljs-string">&quot;dept&quot;</span> : <span class="hljs-string">&quot;kitchen&quot;</span>,<br>    <span class="hljs-string">&quot;description&quot;</span> : <span class="hljs-string">&quot;green placemat&quot;</span><br>&#125;<br><br><span class="hljs-comment">/* 3 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">1.0</span>,<br>    <span class="hljs-string">&quot;dept&quot;</span> : <span class="hljs-string">&quot;tech&quot;</span>,<br>    <span class="hljs-string">&quot;description&quot;</span> : <span class="hljs-string">&quot;lime green computer&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><p><code>$text</code> 操作符可以在有text index的集合上执行文本检索。<code>$text</code> 将会使用 <code>空格</code> 和 <code>标点符号</code> 作为分隔符对检索字符串进行分词（查询条件和索引数据都会分词）， 并且对检索字符串中所有的分词结果进行一个逻辑上的 OR 操作</p><h3 id="通配符索引"><a class="markdownIt-Anchor" href="#通配符索引"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/index-wildcard/">通配符索引</a></h3><p>MongoDB支持在一个或一组字段上创建索引，以支持查询。由于MongoDB支持动态模式（动态添加字段），应用程序可以查询不能提前知道名称或任意名称的字段</p><p>例如， <code>product_catalog</code> 集合中的文档可能包含 <code>product_attributes</code> 字段。 <code>product_attributes</code> 字段可以包含任意嵌套字段，包括嵌入的文档和数组：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">product_catalog</span>.<span class="hljs-title function_">insertMany</span>(<br>    [<br>        &#123;<br>          <span class="hljs-string">&quot;product_name&quot;</span> : <span class="hljs-string">&quot;Spy Coat&quot;</span>,<br>          <span class="hljs-string">&quot;product_attributes&quot;</span> : &#123;<br>            <span class="hljs-string">&quot;material&quot;</span> : [ <span class="hljs-string">&quot;Tweed&quot;</span>, <span class="hljs-string">&quot;Wool&quot;</span>, <span class="hljs-string">&quot;Leather&quot;</span> ],<br>            <span class="hljs-string">&quot;size&quot;</span> : &#123;<br>              <span class="hljs-string">&quot;length&quot;</span> : <span class="hljs-number">72</span>,<br>              <span class="hljs-string">&quot;units&quot;</span> : <span class="hljs-string">&quot;inches&quot;</span><br>            &#125;<br>          &#125;<br>        &#125;,<br>        &#123;<br>          <span class="hljs-string">&quot;product_name&quot;</span> : <span class="hljs-string">&quot;Spy Pen&quot;</span>,<br>          <span class="hljs-string">&quot;product_attributes&quot;</span> : &#123;<br>             <span class="hljs-string">&quot;colors&quot;</span> : [ <span class="hljs-string">&quot;Blue&quot;</span>, <span class="hljs-string">&quot;Black&quot;</span> ],<br>             <span class="hljs-string">&quot;secret_feature&quot;</span> : &#123;<br>               <span class="hljs-string">&quot;name&quot;</span> : <span class="hljs-string">&quot;laser&quot;</span>,<br>               <span class="hljs-string">&quot;power&quot;</span> : <span class="hljs-string">&quot;1000&quot;</span>,<br>               <span class="hljs-string">&quot;units&quot;</span> : <span class="hljs-string">&quot;watts&quot;</span>,<br>             &#125;<br>          &#125;<br>        &#125;<br>    ]<br>)<br></code></pre></td></tr></table></figure><p>以下操作在 <code>product_attributes</code> 字段上创建通配符索引：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">product_catalog</span>.<span class="hljs-title function_">createIndex</span>(<br>    &#123; <span class="hljs-string">&quot;product_attributes.$**&quot;</span>: <span class="hljs-number">1</span> &#125;<br>)<br></code></pre></td></tr></table></figure><p>通配符索引可以支持对 <code>product_attributes</code> 或其嵌入字段进行 <code>任意单字段</code> 查询：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">products_catalog</span>.<span class="hljs-title function_">find</span>( &#123; <span class="hljs-string">&quot;product_attributes.size.length&quot;</span> : &#123; $gt : <span class="hljs-number">60</span> &#125; &#125; )<br>db.<span class="hljs-property">products_catalog</span>.<span class="hljs-title function_">find</span>( &#123; <span class="hljs-string">&quot;product_attributes.material&quot;</span> : <span class="hljs-string">&quot;Leather&quot;</span> &#125; )<br>db.<span class="hljs-property">products_catalog</span>.<span class="hljs-title function_">find</span>( &#123; <span class="hljs-string">&quot;product_attributes.secret_feature.name&quot;</span> : <span class="hljs-string">&quot;laser&quot;</span> &#125; )<br></code></pre></td></tr></table></figure><p class="note note-primary">使用限制</p><ul><li>不能使用通配符索引来分片集合。在要分片的一个或多个字段上创建一个非通配符索引</li><li>不能创建复合索引</li><li>不能为通配符索引指定以下属性：<ul><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/index-ttl/">TTL</a></li><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/index-unique/">Unique</a></li></ul></li><li>您不能使用通配符语法创建以下索引类型：<ul><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/geospatial-indexes/">2d (Geospatial)</a></li><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/2dsphere/">2dsphere (Geospatial)</a></li><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/index-hashed/">Hashed</a></li></ul></li></ul><h3 id="哈希索引"><a class="markdownIt-Anchor" href="#哈希索引"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/index-hashed/">哈希索引</a></h3><p>不同于传统的B+Tree索引,哈希索引使用hash函数来创建索引。在索引字段上进行 <code>精确匹配</code>,但不支持 <code>范围查询</code> ,不支持 <code>多键hash</code></p><p>使用散列分片键对集合进行分片会导致数据分布更均匀。有关更多详细信息，请参阅 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/hashed-sharding/#std-label-sharding-hashed-sharding">哈希分片</a></p><p>Hashed索引使用hashing函数来计算索引字段值的哈希。hashing函数折叠嵌入式文档并计算整个值的hash，但不支持多键（即数组）索引</p><p class="note note-primary">创建哈希索引</p><p>若要创建哈希索引，请指定 <code>hashed</code> 作为索引键的值，如以下示例所示：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">collection</span>.<span class="hljs-title function_">createIndex</span>( &#123; <span class="hljs-attr">_id</span>: <span class="hljs-string">&quot;hashed&quot;</span> &#125; )<br></code></pre></td></tr></table></figure><p class="note note-primary">创建复合哈希索引</p><p>从MongoDB 4.4开始，MongoDB支持创建包含 <code>单个哈希字段</code> 的复合索引。若要创建复合哈希索引，请在创建索引时指定 <code>hashed</code> 作为任何单个索引键的值：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">collection</span>.<span class="hljs-title function_">createIndex</span>( &#123; <span class="hljs-string">&quot;fieldA&quot;</span> : <span class="hljs-number">1</span>, <span class="hljs-string">&quot;fieldB&quot;</span> : <span class="hljs-string">&quot;hashed&quot;</span>, <span class="hljs-string">&quot;fieldC&quot;</span> : -<span class="hljs-number">1</span> &#125; )<br></code></pre></td></tr></table></figure><h3 id="地理位置索引"><a class="markdownIt-Anchor" href="#地理位置索引"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/geohaystack/">地理位置索引</a></h3><p>TODO</p><h2 id="索引属性"><a class="markdownIt-Anchor" href="#索引属性"></a> 索引属性</h2><table><thead><tr><th>Option</th><th>Type</th><th>描述</th></tr></thead><tbody><tr><td>background</td><td>Boolean</td><td>建索引过程会阻塞其它数据库操作，background可指定以后台方式创建索引，即增加 “background” 可选参数。<br>“background” 默认值为false</td></tr><tr><td>unique</td><td>Boolean</td><td>建立的索引是否唯一。指定为true创建唯一索引。默认值为false</td></tr><tr><td>name</td><td>string</td><td>索引的名称。如果未指定，MongoDB的通过连接索引的字段名和排序顺序生成一个索引名称</td></tr><tr><td>dropDups</td><td>Boolean</td><td>3.0+版本已废弃。在建立唯一索引时是否删除重复记 录,指定 true 创建唯一索引。默认值为 false</td></tr><tr><td>sparse</td><td>Boolean</td><td>对文档中不存在的字段数据不启用索引；这个参数需 要特别注意，如果设置为true的话，在索引字段中不 会查询出不包含对应字段的文档.。默认值为 false</td></tr><tr><td>expireAfterSeconds</td><td>integer</td><td>指定一个以秒为单位的数值，完成 TTL设定，设定集合的生存时间</td></tr><tr><td>v</td><td>index version</td><td>索引的版本号。默认的索引版本取决于mongod创建索引时运行的版本</td></tr><tr><td>weights</td><td>document</td><td>索引权重值，数值在 1 到 99,999 之间，表示该索引 相对于其他索引字段的得分权重</td></tr><tr><td>default_language</td><td>string</td><td>对于文本索引，该参数决定了停用词及词干和词器的 规则的列表。 默认为英语</td></tr><tr><td>language_override</td><td>string</td><td>对于文本索引，该参数指定了包含在文档中的字段 名，语言覆盖默认的language，默认值为 language</td></tr></tbody></table><h3 id="唯一索引"><a class="markdownIt-Anchor" href="#唯一索引"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/index-unique/">唯一索引</a></h3><p>唯一索引可确保索引字段不存储重复值;即强制索引字段的唯一性。默认情况下，MongoDB 在创建集合期间在 <code>_id</code> 字段上创建一个唯一索引</p><p class="note note-primary">创建唯一索引</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">members</span>.<span class="hljs-title function_">createIndex</span>( &#123; <span class="hljs-string">&quot;user_id&quot;</span>: <span class="hljs-number">1</span> &#125;, &#123; <span class="hljs-attr">unique</span>: <span class="hljs-literal">true</span> &#125; )<br></code></pre></td></tr></table></figure><p class="note note-primary">限制</p><ul><li>如果集合字段已经有重复值，则MongoDB无法在指定的索引字段上创建唯一索引（同一字段有重复值）</li><li>不能对 <code>哈希索引</code> 指定唯一约束</li></ul><p class="note note-primary">缺失字段</p><p>唯一性索引对于文档中缺失的字段，会使用null值代替，因此不允许存在多个文档缺失索引字段的情况</p><p>例如，集合在 <code>x</code> 上具有唯一索引：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">collection</span>.<span class="hljs-title function_">createIndex</span>( &#123; <span class="hljs-string">&quot;x&quot;</span>: <span class="hljs-number">1</span> &#125;, &#123; <span class="hljs-attr">unique</span>: <span class="hljs-literal">true</span> &#125; )<br></code></pre></td></tr></table></figure><p>如果集合尚未包含缺少字段 <code>x</code> 的文档，则唯一索引允许插入不带字段 <code>x</code> 的文档：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">collection</span>.<span class="hljs-title function_">insertOne</span>( &#123; <span class="hljs-attr">y</span>: <span class="hljs-number">1</span> &#125; )<br></code></pre></td></tr></table></figure><p>但是，如果集合已包含缺少字段 <code>x</code> 的文档，则插入没有字段 <code>x</code> 的文档时会出现唯一索引错误：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">collection</span>.<span class="hljs-title function_">insertOne</span>( &#123; <span class="hljs-attr">z</span>: <span class="hljs-number">1</span> &#125; )<br><span class="hljs-comment">// duplicate key error </span><br></code></pre></td></tr></table></figure><p>创建复合唯一索引</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">collection</span>.<span class="hljs-title function_">createIndex</span>( &#123; <span class="hljs-string">&quot;a.loc&quot;</span>: <span class="hljs-number">1</span>, <span class="hljs-string">&quot;a.qty&quot;</span>: <span class="hljs-number">1</span> &#125;, &#123; <span class="hljs-attr">unique</span>: <span class="hljs-literal">true</span> &#125; )<br></code></pre></td></tr></table></figure><p class="note note-primary">在复制集和分片上建立唯一索引</p><p>对于副本集和分片集群，使用 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/tutorial/build-indexes-on-replica-sets/">rolling procedure (滚动过程)</a> 创建唯一索引需要在过程中停止对集合的所有写操作。如果在此过程中无法停止对集合的所有写入，请不要使用滚动过程。相反，请通过以下方式在集合上构建唯一索引：</p><ul><li>在副本集的主数据库上调用 <code>db.collection.createIndex()</code></li><li>或者，在分片集群的 <code>mongos</code> 上调用 <code>db.collection.createIndex()</code></li></ul><p class="note note-primary">分片集群和唯一索引</p><p>对于范围分片集合，只有以下索引是唯一的：</p><ul><li>分片键上的索引</li><li>一个复合索引，其中分片键是一个 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/index-compound/#std-label-compound-index-prefix">前缀</a>（分片键必须作为唯一索引的前缀）</li><li>默认 <code>_id</code> 索引;但是如果 <code>_id</code> 字段不是分片键或分片键的前缀，则 <code>_id</code> 索引仅强制实施每个分片的唯一性约束</li></ul><h3 id="部分索引"><a class="markdownIt-Anchor" href="#部分索引"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/index-partial/">部分索引</a></h3><p>部分索引只索引集合中满足指定筛选器表达式的文档。通过索引集合中文档的子集，部分索引可以降低存储需求，并降低创建和维护索引的性能成本</p><p>使用 <code>db.collection.createIndex()</code> 方法与 <code>partialFilterExpression</code> 选项一起使用创建部分索引，<code>partialFilterExpression</code> 选项接受使用以下方法指定筛选条件的文档：</p><ul><li>相等表达式（即 <code>field: value</code> 或使用 <code>$eq</code> 运算符）</li><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/query/exists/#mongodb-query-op.-exists"><code>$exists: true</code></a> 表达式</li><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/query/gt/#mongodb-query-op.-gt"><code>$gt</code></a>, <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/query/gte/#mongodb-query-op.-gte"><code>$gte</code></a>, <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/query/lt/#mongodb-query-op.-lt"><code>$lt</code></a>, <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/query/lte/#mongodb-query-op.-lte"><code>$lte</code></a> 表达式</li><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/query/type/#mongodb-query-op.-type"><code>$type</code></a> 表达式</li><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/query/and/#mongodb-query-op.-and"><code>$and</code></a> 运算符</li><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/query/or/#mongodb-query-op.-or"><code>$or</code></a> 运算符</li><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/operator/query/in/#mongodb-query-op.-in"><code>$in</code></a> 运算符</li></ul><p class="note note-primary">部分索引生效必须满足 partialFilterExpression</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">users</span>.<span class="hljs-title function_">insertMany</span>(<br>  [<br>    &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;56424f1efa0358a27fa1f99a&quot;</span>), <span class="hljs-string">&quot;username&quot;</span> : <span class="hljs-string">&quot;david&quot;</span>, <span class="hljs-string">&quot;age&quot;</span> : <span class="hljs-number">29</span> &#125;,<br>    &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;56424f37fa0358a27fa1f99b&quot;</span>), <span class="hljs-string">&quot;username&quot;</span> : <span class="hljs-string">&quot;amanda&quot;</span>, <span class="hljs-string">&quot;age&quot;</span> : <span class="hljs-number">35</span> &#125;,<br>    &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;56424fe2fa0358a27fa1f99c&quot;</span>), <span class="hljs-string">&quot;username&quot;</span> : <span class="hljs-string">&quot;rajiv&quot;</span>, <span class="hljs-string">&quot;age&quot;</span> : <span class="hljs-number">57</span> &#125;<br>  ]<br>)<br></code></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">users</span>.<span class="hljs-title function_">createIndex</span>(<br>    &#123; <span class="hljs-attr">username</span>: <span class="hljs-number">1</span> &#125;,    <span class="hljs-comment">// 对username字段创建所索引</span><br>    &#123; <span class="hljs-attr">partialFilterExpression</span>: &#123; <span class="hljs-attr">age</span>: &#123; <span class="hljs-attr">$gt</span>: <span class="hljs-number">30</span> &#125; &#125; &#125;   <span class="hljs-comment">// 部分索引，只有年龄大于30的数据才创建和使用索引</span><br>)<br></code></pre></td></tr></table></figure><p>以下查询将使用部分索引</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">users</span>.<span class="hljs-title function_">find</span>(<br>    &#123; <span class="hljs-attr">username</span>: <span class="hljs-string">&quot;david&quot;</span> , <span class="hljs-attr">age</span>: <span class="hljs-number">35</span>&#125;<br>)<br></code></pre></td></tr></table></figure><p>以下查询不会使用部分索引</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">users</span>.<span class="hljs-title function_">find</span>(<br>    &#123; <span class="hljs-attr">username</span>: <span class="hljs-string">&quot;rajiv&quot;</span>&#125;<br>)<br></code></pre></td></tr></table></figure><p>因为查询条件没有满足或缺失满足部分索引的 <code>partialFilterExpression</code> 条件，则不使用部分索引</p><p class="note note-primary">部分索引导致唯一索引失效</p><p>分部索引仅索引集合中满足指定筛选表达式的文档。如果同时指定 <code>partialFilterExpression</code> 和唯一约束，则唯一约束仅适用于满足筛选表达式的文档。<span class="green-line">如果文档不符合筛选条件，则具有唯一约束的部分索引不会阻止插入不符合唯一约束的文档</span></p><p>引用上面的测试数据，假设 users 创建一个索引</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">users</span>.<span class="hljs-title function_">createIndex</span>(<br>   &#123; <span class="hljs-attr">username</span>: <span class="hljs-number">1</span> &#125;,<br>   &#123; <span class="hljs-attr">unique</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">partialFilterExpression</span>: &#123; <span class="hljs-attr">age</span>: &#123; <span class="hljs-attr">$gte</span>: <span class="hljs-number">30</span> &#125; &#125; &#125;<br>)<br></code></pre></td></tr></table></figure><p>那么这个部分唯一索引对于 <code>age</code> 大于等于30的数据可以保证 <code>username</code> 唯一，但是 <code>age</code> 小于30则不保证 <code>username</code> 唯一</p><h3 id="稀疏索引"><a class="markdownIt-Anchor" href="#稀疏索引"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/index-sparse/">稀疏索引</a></h3><p>索引的稀疏属性确保索引只包含具有索引字段的文档的条目，索引将跳过没有索引字段的文档</p><p>特性： 只对存在字段的文档进行索引（包括字段值为null的文档）</p><p class="note note-primary">集合上的稀疏索引无法返回完整结果</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">score</span>.<span class="hljs-title function_">insertMany</span>(<br>    [<br>        &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;523b6e32fb408eea0eec2647&quot;</span>), <span class="hljs-string">&quot;userid&quot;</span> : <span class="hljs-string">&quot;newbie&quot;</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;523b6e61fb408eea0eec2648&quot;</span>), <span class="hljs-string">&quot;userid&quot;</span> : <span class="hljs-string">&quot;abby&quot;</span>, <span class="hljs-string">&quot;score&quot;</span> : <span class="hljs-number">82</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;523b6e6ffb408eea0eec2649&quot;</span>), <span class="hljs-string">&quot;userid&quot;</span> : <span class="hljs-string">&quot;nina&quot;</span>, <span class="hljs-string">&quot;score&quot;</span> : <span class="hljs-number">90</span> &#125;<br>    ]<br>)<br></code></pre></td></tr></table></figure><p>创建一个稀疏索引</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">score</span>.<span class="hljs-title function_">createIndex</span>( &#123; <span class="hljs-attr">score</span>: <span class="hljs-number">1</span> &#125; , &#123; <span class="hljs-attr">sparse</span>: <span class="hljs-literal">true</span> &#125; )<br></code></pre></td></tr></table></figure><p>下面查询不会返回 userid 为 <code>newbie</code> 的文档，因为强制使用了稀疏索引，该文档没有 <code>score</code>字段，不会被加入索引</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">score</span>.<span class="hljs-title function_">find</span>().<span class="hljs-title function_">sort</span>( &#123; <span class="hljs-attr">score</span>: -<span class="hljs-number">1</span> &#125; ).<span class="hljs-title function_">hint</span>( &#123;<span class="hljs-attr">score</span>: <span class="hljs-number">1</span>&#125; )<br><br><span class="hljs-comment">/* 1 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;523b6e6ffb408eea0eec2649&quot;</span>),<br>    <span class="hljs-string">&quot;userid&quot;</span> : <span class="hljs-string">&quot;nina&quot;</span>,<br>    <span class="hljs-string">&quot;score&quot;</span> : <span class="hljs-number">90.0</span><br>&#125;<br><br><span class="hljs-comment">/* 2 */</span><br>&#123;<br>    <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;523b6e61fb408eea0eec2648&quot;</span>),<br>    <span class="hljs-string">&quot;userid&quot;</span> : <span class="hljs-string">&quot;abby&quot;</span>,<br>    <span class="hljs-string">&quot;score&quot;</span> : <span class="hljs-number">82.0</span><br>&#125;<br></code></pre></td></tr></table></figure><p><span class="green-line">需要返回完整的查询结果就不能暗示使用稀疏索引</span></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">score</span>.<span class="hljs-title function_">find</span>().<span class="hljs-title function_">sort</span>( &#123; <span class="hljs-attr">score</span>: -<span class="hljs-number">1</span> &#125; )<br></code></pre></td></tr></table></figure><p class="note note-primary">具有唯一约束的稀疏索引</p><p>可以使用以下命令创建具有唯一约束的稀疏索引</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">score</span>.<span class="hljs-title function_">createIndex</span>( &#123; <span class="hljs-attr">score</span>: <span class="hljs-number">1</span> &#125; , &#123; <span class="hljs-attr">sparse</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">unique</span>: <span class="hljs-literal">true</span> &#125; )<br></code></pre></td></tr></table></figure><p>以下数据可以插入到集合中</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">score</span>.<span class="hljs-title function_">insertMany</span>( [<br>   &#123; <span class="hljs-string">&quot;userid&quot;</span>: <span class="hljs-string">&quot;newbie&quot;</span>, <span class="hljs-string">&quot;score&quot;</span>: <span class="hljs-number">43</span> &#125;,<br>   &#123; <span class="hljs-string">&quot;userid&quot;</span>: <span class="hljs-string">&quot;abby&quot;</span>, <span class="hljs-string">&quot;score&quot;</span>: <span class="hljs-number">34</span> &#125;,<br>   &#123; <span class="hljs-string">&quot;userid&quot;</span>: <span class="hljs-string">&quot;nina&quot;</span> &#125; <span class="hljs-comment">// 原本唯一索引只允许集合中字段有一个为null值，但是使用稀疏索引后，缺失字段的文档可以插入多个，但是不会被索引</span><br>] )<br></code></pre></td></tr></table></figure><p>以下数据不能插入到集合中，因为 <code>score</code> 值为 <code>82</code> 和 <code>90</code> 的文档已经存在：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">score</span>.<span class="hljs-title function_">insertMany</span>( [<br>   &#123; <span class="hljs-string">&quot;userid&quot;</span>: <span class="hljs-string">&quot;newbie&quot;</span>, <span class="hljs-string">&quot;score&quot;</span>: <span class="hljs-number">82</span> &#125;,<br>   &#123; <span class="hljs-string">&quot;userid&quot;</span>: <span class="hljs-string">&quot;abby&quot;</span>, <span class="hljs-string">&quot;score&quot;</span>: <span class="hljs-number">90</span> &#125;<br>] )<br></code></pre></td></tr></table></figure><h3 id="ttl索引"><a class="markdownIt-Anchor" href="#ttl索引"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/index-ttl/">TTL索引</a></h3><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/tutorial/expire-data/">通过设置TTL使集合中的数据过期</a></p><p>TTL索引是一种特殊的 <code>单字段索引</code>，MongoDB可以使用它在一定的时间或特定的时钟时间后自动从集合中删除文档。数据过期对于某些类型的信息很有用，比如机器生成的事件数据、日志和会话信息，这些信息只需要在数据库中保存有限的时间</p><p>测试数据</p><p>创建一个 user 集合，根据 createTime 创建一个TTL索引，数据在10秒后过期</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">user</span>.<span class="hljs-title function_">createIndex</span>( &#123; <span class="hljs-string">&quot;createTime&quot;</span>: <span class="hljs-number">1</span> &#125;, &#123; <span class="hljs-attr">expireAfterSeconds</span>: <span class="hljs-number">10</span> &#125; )<br></code></pre></td></tr></table></figure><p>插入一条用户数据，数据将在10秒后自动删除</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">user</span>.<span class="hljs-title function_">insertOne</span>(<br>    &#123;<br>        <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;56424f1efa0358a27fa1f99a&quot;</span>),<br>        <span class="hljs-string">&quot;username&quot;</span> : <span class="hljs-string">&quot;david&quot;</span>,<br>        <span class="hljs-string">&quot;createTime&quot;</span> : <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()<br>    &#125;<br>)<br><span class="hljs-comment">// 数据将在10秒后自动删除</span><br></code></pre></td></tr></table></figure><h3 id="隐藏索引"><a class="markdownIt-Anchor" href="#隐藏索引"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/index-hidden/">隐藏索引</a></h3><p>通过对规划器隐藏索引，用户可以评估删除索引而不实际删除索引的潜在影响。如果影响是负面的，用户可以取消隐藏索引，而不必重新创建已删除的索引</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs javascript">创建隐藏索引 <br>db.<span class="hljs-property">restaurants</span>.<span class="hljs-title function_">createIndex</span>(&#123; <span class="hljs-attr">fileName</span>: <span class="hljs-number">1</span> &#125;,&#123; <span class="hljs-attr">hidden</span>: <span class="hljs-literal">true</span> &#125;);<br><br>隐藏现有索引 <br>db.<span class="hljs-property">restaurants</span>.<span class="hljs-title function_">hideIndex</span>( &#123; <span class="hljs-attr">fileName</span>: <span class="hljs-number">1</span>&#125; );<br>或者<br>db.<span class="hljs-property">restaurants</span>.<span class="hljs-title function_">hideIndex</span>( <span class="hljs-string">&quot;索引名称&quot;</span> ) <br><br>取消隐藏索引 <br>db.<span class="hljs-property">restaurants</span>.<span class="hljs-title function_">unhideIndex</span>( &#123; <span class="hljs-attr">fileName</span>: <span class="hljs-number">1</span>&#125; ); <br>或者<br>db.<span class="hljs-property">restaurants</span>.<span class="hljs-title function_">unhideIndex</span>( <span class="hljs-string">&quot;索引名称&quot;</span> );<br></code></pre></td></tr></table></figure><h2 id="索引使用建议"><a class="markdownIt-Anchor" href="#索引使用建议"></a> 索引使用建议</h2><p class="note note-primary">为每一个查询建立合适的索引</p><p>这个是针对于数据量较大比如说超过几十上百万（文档数目）数量级的集合。如果没有索引MongoDB需要把所有的Document从盘上读到内存，这会对MongoDB服务器造成较大的压力并影响到其他请求的执行。</p><p class="note note-primary">创建合适的复合索引，不要依赖于交叉索引</p><p>如果你的查询会使用到多个字段，MongoDB有两个索引技术可以使用：交叉索引和复合索引。交叉索引就是针对每个字段单独建立一个单字段索引，然后在查询执行时候使用相应的单字段索引进行索引交叉而得到查询结果。交叉索引目前触发率较低，所以如果你有一个多字段查询的时候，建议使用复合索引能够保证索引正常的使用。</p><p class="note note-primary">复合索引字段顺序：匹配条件在前，范围条件在后</p><p><strong>Equality First, Range After</strong></p><p>前面的例子，在创建复合索引时如果条件有匹配和范围之分，那么匹配条件（sport: “marathon”) 应该在复合索引的前面。范围条件(age: &lt;30)字段应该放在复合索引的后面，使用复合索引也要遵循最左匹配原则。</p><p class="note note-primary">尽可能使用覆盖索引</p><p>使用索引覆盖的好处是查询的数据在索引上都能获取到，直接查询索引后返回数据，提高查询效率。</p><p class="note note-primary">建索引要在后台运行</p><p>在对一个集合创建索引时，该集合所在的数据库将不接受其他读写操作。对大数据量的集合建索引，建议使用后台运行选项 {background: true}</p><h1 id="springboot整合"><a class="markdownIt-Anchor" href="#springboot整合"></a> SpringBoot整合</h1><p>Pom配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;dependencies&gt;<br>       &lt;dependency&gt;<br>           &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>           &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;<br>       &lt;/dependency&gt;<br><br>       &lt;dependency&gt;<br>           &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>           &lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt;<br>       &lt;/dependency&gt;<br><br>       &lt;dependency&gt;<br>           &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>           &lt;artifactId&gt;spring-boot-starter-data-mongodb&lt;/artifactId&gt;<br>       &lt;/dependency&gt;<br><br>       &lt;dependency&gt;<br>           &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;<br>           &lt;artifactId&gt;lombok&lt;/artifactId&gt;<br>           &lt;optional&gt;<span class="hljs-literal">true</span>&lt;/optional&gt;<br>       &lt;/dependency&gt;<br>       &lt;dependency&gt;<br>           &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>           &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;<br>           &lt;scope&gt;test&lt;/scope&gt;<br>       &lt;/dependency&gt;<br>   &lt;/dependencies&gt;<br></code></pre></td></tr></table></figure><p>yml配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">9090</span><br><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">data:</span><br>    <span class="hljs-attr">mongodb:</span><br>      <span class="hljs-attr">host:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">27017</span><br>      <span class="hljs-attr">username:</span> <span class="hljs-string">test</span><br>      <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span><br>      <span class="hljs-attr">database:</span> <span class="hljs-string">test</span><br></code></pre></td></tr></table></figure><p>Mongo配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@RequiredArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MongoConfig</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MongoDatabaseFactory mongoDbFactory;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MongoMappingContext mongoMappingContext;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 转换类配置</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 转换类</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> MappingMongoConverter <span class="hljs-title function_">mappingMongoConverter</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">DbRefResolver</span> <span class="hljs-variable">dbRefResolver</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultDbRefResolver</span>(mongoDbFactory);<br>        <span class="hljs-type">MappingMongoConverter</span> <span class="hljs-variable">converter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MappingMongoConverter</span>(dbRefResolver, mongoMappingContext);<br>        <span class="hljs-comment">//不保存 _class 属性到mongo</span><br>        converter.setTypeMapper(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultMongoTypeMapper</span>(<span class="hljs-literal">null</span>));<br>        <span class="hljs-keyword">return</span> converter;<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 定义事务管理器</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> mongoDbFactory</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> MongoTransactionManager <span class="hljs-title function_">mongoTransactionManager</span><span class="hljs-params">(MongoDatabaseFactory mongoDatabaseFactory)</span> &#123;<br>        <span class="hljs-comment">// 设置事务级别的读/写关注级别</span><br>        <span class="hljs-type">TransactionOptions</span> <span class="hljs-variable">transactionOptions</span> <span class="hljs-operator">=</span> TransactionOptions.builder().readConcern(ReadConcern.SNAPSHOT).writeConcern(WriteConcern.MAJORITY).build();<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MongoTransactionManager</span>(mongoDatabaseFactory, transactionOptions);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>实体</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@ToString</span><br><span class="hljs-meta">@Accessors(chain = true)</span><br><span class="hljs-meta">@Document(collection = &quot;product&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span> &#123;<br>    <span class="hljs-meta">@MongoId</span><br>    <span class="hljs-keyword">private</span> ObjectId id;<br><br>    <span class="hljs-keyword">private</span> String productName;<br><br>    <span class="hljs-keyword">private</span> BigDecimal price;<br><br>    <span class="hljs-keyword">private</span> Integer num;<br>&#125;<br></code></pre></td></tr></table></figure><p>VO</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductAggVo</span> &#123;<br>    <span class="hljs-meta">@MongoId</span><br>    <span class="hljs-keyword">private</span> ObjectId id;<br><br>    <span class="hljs-keyword">private</span> Integer total;<br>&#125;<br></code></pre></td></tr></table></figure><p>单元测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CURDTest</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> MongoTemplate mongoTemplate;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertTest</span><span class="hljs-params">()</span> &#123;<br>        List&lt;Product&gt; productList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        productList.add(<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>()<br>                        .setProductName(<span class="hljs-string">&quot;iphone 14&quot;</span>)<br>                        .setPrice(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">&quot;1234&quot;</span>))<br>                        .setNum(<span class="hljs-number">5</span>));<br><br>        productList.add(<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>()<br>                        .setProductName(<span class="hljs-string">&quot;iphone 15&quot;</span>)<br>                        .setPrice(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">&quot;2134&quot;</span>))<br>                        .setNum(<span class="hljs-number">6</span>));<br><br>        productList.add(<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>()<br>                        .setProductName(<span class="hljs-string">&quot;iphone xiaomi&quot;</span>)<br>                        .setPrice(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">&quot;3333&quot;</span>))<br>                        .setNum(<span class="hljs-number">7</span>));<br><br>        <span class="hljs-built_in">this</span>.mongoTemplate.insert(productList, Product.class);<br>    &#125;<br><br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">selectTest</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Query</span> <span class="hljs-variable">query</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Query</span>(Criteria.where(<span class="hljs-string">&quot;productName&quot;</span>).is(<span class="hljs-string">&quot;iphone 14&quot;</span>));<br>        <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.mongoTemplate.findOne(query, Product.class);<br>        log.info(product.toString());<br>    &#125;<br><br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateTest</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Query</span> <span class="hljs-variable">query</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Query</span>(Criteria.where(<span class="hljs-string">&quot;productName&quot;</span>).is(<span class="hljs-string">&quot;iphone 14&quot;</span>));<br>        <span class="hljs-type">Update</span> <span class="hljs-variable">update</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Update</span>().inc(<span class="hljs-string">&quot;num&quot;</span>, <span class="hljs-number">1</span>);<br><br>        <span class="hljs-type">UpdateResult</span> <span class="hljs-variable">updateResult</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.mongoTemplate.updateFirst(query, update, Product.class);<br>        log.info(updateResult.toString());<br>    &#125;<br><br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeTest</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Query</span> <span class="hljs-variable">query</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Query</span>(Criteria.where(<span class="hljs-string">&quot;productName&quot;</span>).is(<span class="hljs-string">&quot;iphone 14&quot;</span>));<br>        <span class="hljs-type">DeleteResult</span> <span class="hljs-variable">deleteResult</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.mongoTemplate.remove(query, Product.class);<br>        log.info(deleteResult.toString());<br>    &#125;<br><br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">aggTest</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">MatchOperation</span> <span class="hljs-variable">match</span> <span class="hljs-operator">=</span> Aggregation.match(Criteria.where(<span class="hljs-string">&quot;num&quot;</span>).gte(<span class="hljs-number">6</span>));<br>        <span class="hljs-type">GroupOperation</span> <span class="hljs-variable">group</span> <span class="hljs-operator">=</span> Aggregation.group(<span class="hljs-string">&quot;_id&quot;</span>).sum(<span class="hljs-string">&quot;$num&quot;</span>).as(<span class="hljs-string">&quot;total&quot;</span>);<br><br>        <span class="hljs-type">Aggregation</span> <span class="hljs-variable">aggregation</span> <span class="hljs-operator">=</span> Aggregation.newAggregation(<br>                match,<br>                group<br>        );<br><br>        AggregationResults&lt;ProductAggVo&gt; aggregate = <span class="hljs-built_in">this</span>.mongoTemplate.aggregate(aggregation, Product.class, ProductAggVo.class);<br>        log.info(aggregate.toString());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="存储引擎"><a class="markdownIt-Anchor" href="#存储引擎"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/core/storage-engines/">存储引擎</a></h1><p>存储引擎是数据库的组成部分，负责管理数据在内存和磁盘上的存储方式。MongoDB支持多个存储引擎，因为不同的引擎对特定的工作负载性能更好。</p><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/core/wiredtiger/">WiredTiger</a> 是MongoDB 3.2开始的默认存储引擎。它非常适用于大多数工作负载，并且推荐在新部署中使用。WiredTiger提供了文档级的并发模型、检查点和压缩等功能。</p><p>内存存储引擎在MongoDB 商业版中可用。它不是将文档存储在磁盘上，而是将它们保留在内存中，以实现更可预测的数据延迟。</p><h2 id="wiredtiger"><a class="markdownIt-Anchor" href="#wiredtiger"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/core/wiredtiger/">WiredTiger</a></h2><p>从MongoDB 3.2开始，WiredTiger存储引擎是默认的存储引擎。</p><p class="note note-primary">文档级并发</p><p>WiredTiger 使用文档级并发控制进行写入操作。因此，多个客户端可以同时修改集合的不同文档。</p><p>对于大多数读写操作，WiredTiger使用 <code>乐观并发</code> 控制模式。 WiredTiger仅在全局、数据库和集合级别使用意向锁。</p><p>当存储引擎检测到两个操作之间存在冲突时，将引发写冲突，从而导致MongoDB自动重试该操作。</p><p>一些全局操作（通常是涉及多个数据库的短暂操作）仍然需要全局“实例范围级别的”锁。 其他一些操作（例如删除集合）仍然需要独占数据库锁。</p><p class="note note-primary">内存快照和检查点</p><p><img src="/2023/04/14/MongoDB/checkPoint%E5%92%8CJournal.png" srcset="/img/loading.gif" lazyload alt="checkPoint和Journal"></p><p>WiredTiger 存储引擎使用 MVCC（多版本并发控制）技术。在进行操作时，WiredTiger 为操作提供数据的一个时间点快照。快照提供了内存中数据的一致视图。</p><p>写入磁盘时，WiredTiger将所有数据文件中的快照中的所有数据以一致的方式写入磁盘。 现在持久的数据充当数据文件中的 <code>检查点</code>。 该检查点可确保数据文件直到最后一个检查点（包括最后一个检查点）都保持一致； 即检查点可以充当恢复点。</p><p>从3.6版本开始，MongoDB将WiredTiger配置为以 <code>60秒</code> 的间隔创建 <code>检查点</code>（即将内存快照数据写入磁盘）。 在早期版本中，MongoDB将检查点设置为在WiredTiger中以60秒的间隔或在写入 <code>2GB</code> 日志数据时对用户数据进行检查，以先到者为准。</p><p>在写入新检查点期间，以前的检查点仍然有效。因此，即使MongoDB在写入新检查点时终止或遇到错误，在重新启动时，MongoDB也可以从上一个有效的检查点恢复。</p><p>当 WiredTiger 的元数据表以原子方式更新以引用新检查点时，当新的检查点可用户时。一旦可以访问新的检查点，WiredTiger 就会从旧检查点中释放内存page。</p><p>使用WiredTiger，即使没有日志，MongoDB也可以从最后一个检查点恢复;但是，若要恢复在最后一个检查点之后所做的更改，请使用日记功能运行。</p><div class="note note-warning"><p>检查点</p><p>检查点是指定时将内存中的数据写入到磁盘中并创建一个检查点文件用于数据恢复的操作</p></div><p class="note note-primary">Journal(日志)</p><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/write-concern/#std-label-wc-j">写入关注的 j 选项</a> 可以控制 mongodb 必须要成功写入 Journal 才返回</p><p>WiredTiger 将预写日志（即 journal）与检查点结合使用，以确保数据的持久性。</p><p>WiredTiger 日志（journal）保留检查点之间的所有数据修改。如果MongoDB在检查点之间宕机，它将使用日志重放自上次检查点以来修改的所有数据。</p><p>WiredTiger 日志使用 snappy 压缩库进行压缩。若要指定不同的压缩算法或不压缩，请使用<code>storage.wiredTiger.engineConfig.journalCompressor</code> 设置（超过128M才会开启压缩）。</p><p>可以通过将 <code>storage.journal.enabled</code> 设置为 <code>false</code> 来禁用独立实例的日记功能，这可以减少维护日志的开销。对于独立实例，不使用日志意味着当MongoDB意外宕机时，最后一个检查点后面的数据会丢失。</p><p class="note note-primary">压缩</p><p>使用WiredTiger，MongoDB支持对所有集合和索引进行压缩。 压缩可最大程度地减少存储空间的使用量，但会增加CPU的开销。</p><p>默认情况下，WiredTiger 对所有集合使用块压缩和 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/reference/glossary/#std-term-snappy">snappy</a> 压缩库，对所有索引使用前缀压缩。</p><p>对于集合，可选的压缩库有</p><ul><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/reference/glossary/#std-term-zlib">zlib</a></li><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/reference/glossary/#std-term-zstd">zstd</a> (MongoDB 4.2)</li></ul><p>对于索引，若要禁用前缀压缩，请使用 <code>storage.wiredTiger.indexConfig.prefixCompression</code> 设置。</p><p>压缩设置还可以在集合和索引创建期间基于每个集合和每个索引进行配置。</p><p class="note note-primary">内存使用</p><p>使用WiredTiger，MongoDB同时利用WiredTiger内部缓存和文件系统缓存。</p><p>从MongoDB 3.4开始，默认的WiredTiger内部缓存大小是以下两者中的较大者：</p><ul><li>（内存大小 -1GB） * 50%</li><li>256MB</li></ul><p>例如，在总共具有 4GB RAM 的系统上，WiredTiger 缓存将使用 1.5GB 的 RAM （ <code>0.5 * (4 GB - 1 GB) = 1.5 GB</code> ）</p><p>相反，总内存为1.25 GB的系统将为WiredTiger缓存分配256 MB，因为这是总RAM的一半以上减去一GB（0.5* （1.25 GB-1 GB）= 128 MB</p><h2 id="内存存储引擎"><a class="markdownIt-Anchor" href="#内存存储引擎"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/core/inmemory/">内存存储引擎</a></h2><p>商业版本提供</p><h2 id="gridfs"><a class="markdownIt-Anchor" href="#gridfs"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/core/gridfs/">GridFS</a></h2><p><img src="/2023/04/14/MongoDB/GridFS.png" srcset="/img/loading.gif" lazyload alt></p><p>GridFS是MongoDB提供的一种存储和检索大文件（如图片、视频等）的机制。它允许将一个大文件分割成多个小文件进行存储，并且可以方便地进行文件的读写操作。<span class="green-line">GridFS会自动处理文件的切分和重组（每个chunk 255KB），同时还可以提供基于文件名、类型、大小等条件进行搜索的功能。</span></p><p>GridFS 不仅可用于存储超过 16 MB 的文件，还可用于存储要访问的任何文件，而无需将整个文件加载到内存中。</p><p class="note note-primary">使用场景</p><p>在MongoDB中，使用GridFS存储大于16 MB的文件。</p><p>在某些情况下，在MongoDB数据库中存储大文件可能比在系统级文件系统中更有效:</p><ul><li>如果文件系统限制目录中的文件数，则可以使用 GridFS 根据需要存储任意数量的文件。</li><li>如果要访问大文件部分的信息，而不必将整个文件加载到内存中，则可以使用 GridFS 调用文件的各个部分，而无需将整个文件读入内存（比如视频）。</li><li>当你希望保持文件和元数据在多个系统和设施之间自动同步和部署时，可以使用GridFS。使用<a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/core/replica-set-architecture-geographically-distributed/#std-label-replica-set-geographical-distribution">地理分布的复制集</a>时，MongoDB可以自动将文件及其元数据分发到多个<a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/program/mongod/#mongodb-binary-bin.mongod">mongod</a>实例和设施</li></ul><p class="note note-primary">如何使用</p><p>GridFS 将文件存储在两个集合中：</p><ul><li><code>chunks</code> 存储二进制块</li><li><code>files</code> 存储文件的元数据</li></ul><p>GridFS通过使用存储桶名称为每个集合添加前缀，将集合放置在一个公共存储桶中。默认情况下，GridFS使用两个集合以及一个名为fs的存储桶：</p><ul><li><code>fs.files</code></li><li><code>fs.chunks</code></li></ul><p><strong>chunks 集合</strong></p><p><code>chunks</code> 集合中的每个文档都表示 GridFS 中表示的文件的不同块。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs javascript">&#123;<br>  <span class="hljs-string">&quot;_id&quot;</span> : &lt;<span class="hljs-title class_">ObjectId</span>&gt;,<br>  <span class="hljs-string">&quot;files_id&quot;</span> : &lt;<span class="hljs-title class_">ObjectId</span>&gt;,<br>  <span class="hljs-string">&quot;n&quot;</span> : &lt;num&gt;,<br>  <span class="hljs-string">&quot;data&quot;</span> : &lt;binary&gt;<br>&#125;<br></code></pre></td></tr></table></figure><table><thead><tr><th>字段</th><th>说明</th></tr></thead><tbody><tr><td><code>chunks._id</code></td><td>块的唯一ObjectId</td></tr><tr><td><code>chunks.files_id</code></td><td>“父”文档的 <code>_id</code> ，在 <code>files</code> 集合中指定</td></tr><tr><td><code>chunks.n</code></td><td>区块的序列号。GridFS 对所有块进行编号，从 0 开始</td></tr><tr><td><code>chunks.data</code></td><td>BSON 二进制类型</td></tr></tbody></table><p><strong>files 集合</strong></p><p><code>files</code> 集合中的每个文档都表示 GridFS 中的一个文件</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs javascript">&#123;<br>  <span class="hljs-string">&quot;_id&quot;</span> : &lt;<span class="hljs-title class_">ObjectId</span>&gt;,<br>  <span class="hljs-string">&quot;length&quot;</span> : &lt;num&gt;,<br>  <span class="hljs-string">&quot;chunkSize&quot;</span> : &lt;num&gt;,<br>  <span class="hljs-string">&quot;uploadDate&quot;</span> : &lt;timestamp&gt;,<br>  <span class="hljs-string">&quot;md5&quot;</span> : &lt;hash&gt;,<br>  <span class="hljs-string">&quot;filename&quot;</span> : &lt;string&gt;,<br>  <span class="hljs-string">&quot;contentType&quot;</span> : &lt;string&gt;,<br>  <span class="hljs-string">&quot;aliases&quot;</span> : &lt;string array&gt;,<br>  &quot;metadata&quot; : &lt;any&gt;,<br>&#125;<br></code></pre></td></tr></table></figure><table><thead><tr><th>字段</th><th>描述</th></tr></thead><tbody><tr><td>files._id</td><td>该文档的唯一标识符。 <code>_id</code> 是您为原始文档选择的数据类型。 MongoDB 文档的默认类型是 BSON ObjectId。</td></tr><tr><td>files.length</td><td>文件大小，以字节为单位。</td></tr><tr><td>files.chunkSize</td><td>每个块的大小，以字节为单位。 GridFS 将文档分成大小为 <code>chunkSize</code> 的块，除了最后一个块外，它只有所需的大小。 默认大小为 <code>255kB</code>。</td></tr><tr><td>files.uploadDate</td><td>文件首次被 GridFS 存储的日期。此值的类型为 <code>Date</code>。</td></tr><tr><td>files.md5</td><td>已弃用。 FIPS 140-2 禁止使用 MD5 算法。 MongoDB 驱动程序已弃用 MD5 支持，并将在未来版本中删除 MD5 生成。需要文件摘要的应用程序应在 GridFS 外部实现它并存储在 <code>files.metadata</code> 中。返回完整文件的 MD5 哈希由 <code>filemd5</code> 命令返回。此值的类型为 <code>String</code>。</td></tr><tr><td>files.filename</td><td>可选。适用于 GridFS 文件的人类可读名称。</td></tr><tr><td>files.contentType</td><td>已弃用。可选。适用于 GridFS 文件的有效 MIME 类型。仅供应用程序使用。请使用 <code>files.metadata</code> 存储与 GridFS 文件的 MIME 类型相关的信息。</td></tr><tr><td>files.aliases</td><td>已弃用。可选。别名字符串数组。仅供应用程序使用。请使用 <code>files.metadata</code> 存储与 GridFS 文件的 MIME 类型相关的信息。</td></tr><tr><td>files.metadata</td><td>可选。元数据字段可以是任何数据类型，并且可以保存您希望存储的任何其他信息。如果您希望向 <code>files</code> 集合中的文档添加其他任意字段，请将它们添加到 <code>metadata</code> 字段中的对象中。</td></tr></tbody></table><p class="note note-primary">添加文件</p><p>我们使用 GridFS 的 put 命令来存储 mp3 文件。 调用 MongoDB 安装目录下bin的 <code>mongofiles</code> 工具</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">mongofiles -d gridfs put song.<span class="hljs-property">mp3</span><br></code></pre></td></tr></table></figure><p><code>-d gridfs</code> 指定存储文件的数据库名称，如果不存在该数据库，MongoDB会自动创建。如果不存在该数据库，MongoDB会自动创建。Song.mp3 是音频文件名</p><p>切换数据库后查询文件</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">fs</span>.<span class="hljs-property">files</span>.<span class="hljs-title function_">find</span>()<br></code></pre></td></tr></table></figure><p>查询数据块</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">fs</span>.<span class="hljs-property">chunks</span>.<span class="hljs-title function_">find</span>()<br></code></pre></td></tr></table></figure><h1 id="副本集-replica-sets"><a class="markdownIt-Anchor" href="#副本集-replica-sets"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/replication/">副本集 Replica Sets</a></h1><p>MongoDB中的副本集（Replica Set）是一组维护相同数据集的mongod服务。 副本集可提供 <code>数据冗余</code> 和 <code>高可用性</code>，是所有生产部署的基础。</p><p>也可以说，副本集类似于有自动故障恢复功能的主从集群。通俗的讲就是用多台机器进行同一数据的异步复制，从而使多台机器拥有同一数据的多个副本，并且当主库宕机时在不需要用户干预的情况下自动切换其他备份服务器做主库。而且还可以利用副本服务器做只读服务器，实现读写分离，提高负载。</p><p class="note note-primary">冗余和数据可用性</p><p>复制提供冗余并提高数据可用性。 通过在不同数据库服务器上提供多个数据副本，复制提供了针对单个数据库服务器宕机的容错级别</p><p>在某些情况下，复制可以提高读取性能，因为客户端可以将读取操作发送到不同的服务上， 在不同数据中心维护数据副本可以增加分布式应用程序的数据位置和可用性。 您还可以为专用目的维护其他副本，例如灾难恢复，报告或备份。</p><p class="note note-primary">MongoDB中的复制</p><p>副本集是一组维护相同数据集的 <code>mongod</code> 实例。副本集包含多个数据承载节点和一个可选的仲裁节点。在数据承载节点中，一个且只有一个成员被视为主节点，而其他节点被视为辅助节点。</p><p>主节点接收所有写入操作。一个副本集只能有一个能够确认具有 <code>&#123; w: &quot;majority&quot; &#125;</code> 写入关注的写入的主节点，尽管在某些情况下，另一个Mongod实例可能会暂时认为自己也是主节点（网络分区），主节点在其操作日志中记录其数据集的所有更改，记录 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/replica-set-oplog/">oplog</a>.</p><p><img src="/2023/04/14/MongoDB/%E5%89%AF%E6%9C%AC%E9%9B%86%E8%AF%BB%E5%86%99.png" srcset="/img/loading.gif" lazyload alt></p><p>辅助节点复制主节点的 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/replica-set-oplog/">oplog</a> 并将操作应用于其数据集，完成辅助节点和主节点的数据同步。 如果主节点宕机，则在符合条件的副本节点中重新选举主节点。</p><p class="note note-primary">主从复制和副本集区别</p><p><span class="green">主从集群和副本集最大的区别就是副本集没有固定的 <code>主节点</code></span>。整个集群会选出一个“主节点”，当其挂掉后，又在剩下的从节点中选中其他节点为“主节点”，副本集总有一个活跃点(主、primary)和一个或多个备份节点(从、secondary)。</p><h2 id="副本集角色"><a class="markdownIt-Anchor" href="#副本集角色"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/replica-set-members/">副本集角色</a></h2><p>副本集有两种类型三种角色</p><p>两种类型：</p><ul><li>主节点：数据操作的主要连接点，可读写</li><li>辅助节点：数据冗余备份，可读或选举</li></ul><p>三种角色</p><div class="note note-primary"><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/replica-set-primary/">主节点</a></p></div><p><img src="/2023/04/14/MongoDB/%E5%89%AF%E6%9C%AC%E9%9B%86%E8%AF%BB%E5%86%99.png" srcset="/img/loading.gif" lazyload alt="主从读写"></p><p>主节点负责所有写请求操作，然后主节点使用 <code>oplog</code> 记录写操作。 辅助节点复制 <code>oplog</code> 完成数据同步</p><p><img src="/2023/04/14/MongoDB/%E4%B8%BB%E8%8A%82%E7%82%B9%E9%80%89%E4%B8%BE.png" srcset="/img/loading.gif" lazyload alt="主节点选举"></p><p>主节点宕机。会触发新一轮主节点选举，会从辅助节点中重新选举出一个新的主节点</p><div class="note note-primary"><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/replica-set-secondary/">辅助节点</a></p></div><p>辅助节点维护主节点的数据副本。辅助节点使用主节点的 <code>oplog</code> 将数据从主节点复制本辅助节点，当主节点宕机辅助节点有机会晋升为主节点。</p><p>辅助节点不能进行写操作，通过额外配置后辅助节点可以进行读操作。</p><p><img src="/2023/04/14/MongoDB/%E4%B8%BB%E8%BE%85%E8%8A%82%E7%82%B9%E6%95%B0%E6%8D%AE%E5%A4%8D%E5%88%B6.png" srcset="/img/loading.gif" lazyload alt="主辅节点数据复制"></p><div class="note note-primary"><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/replica-set-arbiter/">仲裁节点</a></p></div><p><img src="/2023/04/14/MongoDB/%E4%BB%B2%E8%A3%81%E8%8A%82%E7%82%B9.png" srcset="/img/loading.gif" lazyload alt="仲裁节点"></p><p>不同步任何数据的副本，只具有投票选举作用。当然也可以将仲裁节点维护为副本集的一部分，即副本节点同时也可以是仲裁节点。也是一种从节点类型</p><p>可以将额外的mongod实例添加到副本集作为仲裁节点。 仲裁节点不维护数据集。 仲裁节点的目的是通过响应其他副本集成员的心跳和选举请求来维护副本集中的仲裁。 因为它们不存储数据集，所以仲裁器可以是提供副本集仲裁功能的好方法，其占用资源更低。</p><p>如果你的副本+主节点的个数是偶数，建议加一个仲裁节点，形成奇数，容易满足大多数的投票。</p><p>如果你的副本+主节点的个数是奇数，可以不加仲裁节点。</p><h2 id="oplog"><a class="markdownIt-Anchor" href="#oplog"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/replica-set-oplog/">Oplog</a></h2><p><img src="/2023/04/14/MongoDB/oplog.png" srcset="/img/loading.gif" lazyload alt="链式复制"></p><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/replica-set-sync/">Oplog同步</a></p><p>oplog（操作日志）是一个特殊的 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/glossary/#std-term-capped-collection">有限集合</a> ，它保留修改数据库中存储的数据的所有操作的滚动记录。</p><p>与其他有上限的集合不同，oplog 可以超过其配置的大小限制，避免误删提交点。</p><p>MongoDB的所有写操作请求都是在 <code>主节点</code> 上进行的，然后将这些操作记录到主节点的 <code>oplog</code> 上，最后 <code>辅助节点</code> 会以异步复制的方式同步这些日志（4.4后是推送模式）。所有副本集成员都包含一个 <code>oplog</code> 的副本，其位于<a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/local-database/#mongodb-data-local.oplog.rs"><code>local.oplog.rs</code></a> 集合中，该集合可以让副本集成员维护数据库的当前状态。</p><p><code>local.oplog.rs</code> 是 MongoDB 中的一个特殊集合，用于支持复制和sharding。它存储了所有对MongoDB数据库进行更改的操作，包括插入、更新和删除等操作，这些操作都是通过primary节点执行的。每个secondary节点都会从primary节点获取并应用这些操作（回放），从而保证数据在各个节点上的一致性。</p><p><span class="green-line">为了便于复制，所有副本集成员将心跳(ping)发送给所有其他成员。任何从节点都可以从任何其他节点导入oplog条目。</span></p><p>oplog中的每个操作都是 <code>幂等</code> 的。也就是说，oplog 操作无论应用于目标数据集一次还是多次，都会产生相同的结果。</p><p>为了确保不会重复复制操作，每个辅助节点在复制过程中会追踪自己已经复制和执行过的 oplog 条目的状态。每个副本集成员都有一个叫做 “复制进程 ID（replication processId）” 的标识符，用来标记已经复制过的 oplog 条目。当一个副本集成员读取主节点的 oplog 时，它会记住自己在最近的复制过程中读取的最后一个条目的复制进程 ID。下一次复制过程开始时，它会使用该复制进程 ID 作为起点，只复制新的操作</p><p class="note note-primary">操作日志大小</p><p>默认操作日志大小</p><p>Unix和Windows系统</p><table><thead><tr><th>存储引擎</th><th>默认Oplog大小</th><th>下限</th><th>上限</th></tr></thead><tbody><tr><td>In-Memory</td><td>物理内存的5%</td><td>50MB</td><td>50GB</td></tr><tr><td>WiredTiger</td><td>可用磁盘空间的5%</td><td>990MB</td><td>50GB</td></tr></tbody></table><p>macOS系统</p><table><thead><tr><th>存储引擎</th><th>默认Oplog大小</th></tr></thead><tbody><tr><td>In-Memory</td><td>192MB物理内存</td></tr><tr><td>WiredTiger</td><td>192MB磁盘空间</td></tr></tbody></table><p>在大多数情况下，默认的oplog大小就足够了。例如，如果一个oplog是空闲磁盘空间的5%，并且可容纳24小时的操作记录，那么从节点从oplog停止复制条目的时间可以长达24小时，并且不会因oplog条目变得太陈旧而无法继续复制</p><p>在 <code>mongod</code> 创建操作日志之前，可以使用 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/configuration-options/#mongodb-setting-replication.oplogSizeMB"><code>oplogSizeMB</code></a> 选项指定其大小。首次启动副本集成员后，请使用 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/command/replSetResizeOplog/#mongodb-dbcommand-dbcmd.replSetResizeOplog"><code>replSetResizeOplog</code></a> 管理命令更改 oplog 大小，不用重启进程。</p><p>要查看操作日志状态（包括操作的大小和时间范围），请使用<a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/method/rs.printReplicationInfo/#mongodb-method-rs.printReplicationInfo"><code>rs.printReplicationInfo()</code></a> ,有关操作日志状态的详细信息，请参考 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/tutorial/troubleshoot-replica-sets/#std-label-replica-set-troubleshooting-check-oplog-size">Check the Size of the Oplog.</a></p><h2 id="主节点选举原则"><a class="markdownIt-Anchor" href="#主节点选举原则"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/replica-set-elections/">主节点选举原则</a></h2><p><img src="/2023/04/14/MongoDB/%E4%B8%BB%E8%8A%82%E7%82%B9%E9%80%89%E4%B8%BE.png" srcset="/img/loading.gif" lazyload alt></p><p>MongoDB在副本集中，会自动进行主节点的选举，主节点选举的触发条件：</p><ul><li>主节点宕机</li><li>主节点网络抖动（默认心跳超时时间为10秒）</li><li>人工干预（rs.stepDown(600)）</li></ul><p>一旦触发选举，就要根据一定规则来选主节点。</p><p>选举规则是根据票数来决定谁当选：</p><ul><li>票数最高，且获得了半数以上票数的从节点当选主节点（N/2 + 1）;当复制集内存活的成员数量不满足总节点半数以上的数量时，无法进行主节点选举，此时服务处于只读状态</li><li>若票数相同，且票数都满足总节点半数以上，数据新的节点当选；数据的新旧是通过操作日志 <code>oplog</code> 来对比的</li></ul><p class="note note-primary">优先级</p><p>在获得票数的时候，优先级（priority）参数影响重大，优先级默认为 <code>1</code></p><p>可以通过设置优先级（priority）来设置额外票数。优先级即权重，取值为0-1000，相当于可额外增加0-1000的票数，优先级的值越大，就越可能获得多数成员的投票（votes）数。指定较高的值可使成员更有资格成为主节点</p><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/tutorial/adjust-replica-set-member-priority/">调整副本集成员的优先级</a></p><h2 id="故障转移期间的数据回滚"><a class="markdownIt-Anchor" href="#故障转移期间的数据回滚"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/replica-set-rollbacks/">故障转移期间的数据回滚</a></h2><p>只有在主节点宕机之前进行了写操作并且写操作没有同步到副本节点时才需要回滚。当宕机的主节点以副本节点重新加入副本集时，它将回滚未完成同步的写操作，以确保和其他节点的数据保持一致.</p><h2 id="读偏好"><a class="markdownIt-Anchor" href="#读偏好"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/core/read-preference/">读偏好</a></h2><p><img src="/2023/04/14/MongoDB/%E8%AF%BB%E5%81%8F%E5%A5%BD.png" srcset="/img/loading.gif" lazyload alt></p><p>MongoDB的读偏好选项是指在进行读取操作时，优先选择从哪个节点或副本集成员读取数据</p><table><thead><tr><th>读偏好选项</th><th>描述</th></tr></thead><tbody><tr><td>primary</td><td>将读操作发送到主节点（Primary）。这是默认的读偏模式，适用于大多数情况。</td></tr><tr><td>PrimaryPreferred</td><td>首选将读操作发送到主节点（Primary），但如果主节点不可用，则可以从副本集中的任何成员读取数据。</td></tr><tr><td>Secondary</td><td>将读操作发送到副本集中的次要节点（Secondary）。这可以用分担主节点的读负载或现读扩展。</td></tr><tr><td>secondaryPreferred</td><td>首选将操作发送到副本中的次要节点（Secondary），但如果没有次要节点可用，则可以从主节点读取数据。</td></tr><tr><td>nearest</td><td>将读操作发送到距离客端最近的节点，无论其角色是主节点还次要节点。这个模式适用于需要最小读延迟的场景。</td></tr></tbody></table><h2 id="副本集架构搭建"><a class="markdownIt-Anchor" href="#副本集架构搭建"></a> 副本集架构搭建</h2><p>目标：一主一副本一仲裁</p><p><img src="/2023/04/14/MongoDB/%E5%89%AF%E6%9C%AC%E9%9B%86%E6%9E%B6%E6%9E%84.png" srcset="/img/loading.gif" lazyload alt="副本集架构"></p><p class="note note-primary">主节点</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">日志和数据目录<br>mkdir -p /data/mongodb/rs/27020/log<br>mkdir -p /data/mongodb/rs/27020/data<br>mkdir -p /data/mongodb/rs/27020/config<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs shell">新建配置<br>vi /data/mongodb/rs/27020/config/mongod.conf<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">mongod.conf</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-keyword">for</span> documentation of all options, see:</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">  http://docs.mongodb.org/manual/reference/configuration-options/</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Where and how to store data.</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">storage:</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"> dbPath: /data/db</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"> engine:</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"> wiredTiger:</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-built_in">where</span> to write logging data.</span><br>systemLog:<br>  destination: file<br>  logAppend: true<br>  path: /data/log/mongo.log<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">network interfaces</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">net:</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"> port: 27017</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"> bindIp: 127.0.0.1</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">how the process runs</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">processManagement:</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"> timeZoneInfo: /usr/share/zoneinfo</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">安全项先保持注释状态，配好集群后放开。mongo.key后面步骤里会有生成。</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">security:</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">  keyFile: /etc/mongo/mongo.key</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">  authorization: enabled</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">operationProfiling:</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">配副本集名</span><br>replication:<br>  replSetName: &quot;rs&quot;  <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">sharding:</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># Enterprise-Only Options:</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">auditLog:</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">snmp:</span><br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">启动服务<br>docker run -d \<br>--name mongod_27020 \<br>-p 0.0.0.0:27020:27017 \<br>-v /data/mongodb/rs/27020/data:/data/db \<br>-v /data/mongodb/rs/27020/log:/data/log \<br>-v /data/mongodb/rs/27020/config:/data/conf \<br>--privileged=true mongo \<br>--replSet &quot;rs&quot; <br></code></pre></td></tr></table></figure><p class="note note-primary">副本节点</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">日志和数据目录<br>mkdir -p /data/mongodb/rs/27021/log<br>mkdir -p /data/mongodb/rs/27021/data<br>mkdir -p /data/mongodb/rs/27021/config<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs shell">新建配置<br>vi /data/mongodb/rs/27021/config/mongod.conf<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">mongod.conf</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-keyword">for</span> documentation of all options, see:</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">  http://docs.mongodb.org/manual/reference/configuration-options/</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Where and how to store data.</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">storage:</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"> dbPath: /data/db</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"> engine:</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"> wiredTiger:</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-built_in">where</span> to write logging data.</span><br>systemLog:<br>  destination: file<br>  logAppend: true<br>  path: /data/log/mongo.log<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">network interfaces</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">net:</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"> port: 27017</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"> bindIp: 127.0.0.1</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">how the process runs</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">processManagement:</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"> timeZoneInfo: /usr/share/zoneinfo</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">安全项先保持注释状态，配好集群后放开。mongo.key后面步骤里会有生成。</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">security:</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">  keyFile: /etc/mongo/mongo.key</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">  authorization: enabled</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">operationProfiling:</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">配副本集名</span><br>replication:<br>  replSetName: &quot;rs&quot;  <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">sharding:</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># Enterprise-Only Options:</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">auditLog:</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">snmp:</span><br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">启动服务<br>docker run -d \<br>--name mongod_27021 \<br>-p 0.0.0.0:27021:27017 \<br>-v /data/mongodb/rs/27021/data:/data/db \<br>-v /data/mongodb/rs/27021/log:/data/log \<br>-v /data/mongodb/rs/27021/config:/data/conf \<br>--privileged=true mongo \<br>--replSet &quot;rs&quot; <br></code></pre></td></tr></table></figure><p class="note note-primary">仲裁节点</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">日志和数据目录<br>mkdir -p /data/mongodb/rs/27022/log<br>mkdir -p /data/mongodb/rs/27022/data<br>mkdir -p /data/mongodb/rs/27022/config<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs shell">新建配置<br>vi /data/mongodb/rs/27022/config/mongod.conf<br><br>vi /data/mongodb/rs/27021/config/mongod.conf<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">mongod.conf</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-keyword">for</span> documentation of all options, see:</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">  http://docs.mongodb.org/manual/reference/configuration-options/</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Where and how to store data.</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">storage:</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"> dbPath: /data/db</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"> engine:</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"> wiredTiger:</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-built_in">where</span> to write logging data.</span><br>systemLog:<br>  destination: file<br>  logAppend: true<br>  path: /data/log/mongo.log<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">network interfaces</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">net:</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"> port: 27017</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"> bindIp: 127.0.0.1</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">how the process runs</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">processManagement:</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"> timeZoneInfo: /usr/share/zoneinfo</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">安全项先保持注释状态，配好集群后放开。mongo.key后面步骤里会有生成。</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">security:</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">  keyFile: /etc/mongo/mongo.key</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">  authorization: enabled</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">operationProfiling:</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">配副本集名</span><br>replication:<br>  replSetName: &quot;rs&quot;  <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">sharding:</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># Enterprise-Only Options:</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">auditLog:</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">snmp:</span><br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">启动服务<br>docker run -d \<br>--name mongod_27022 \<br>-p 0.0.0.0:27022:27017 \<br>-v /data/mongodb/rs/27022/data:/data/db \<br>-v /data/mongodb/rs/27022/log:/data/log \<br>-v /data/mongodb/rs/27022/config:/data/conf \<br>--privileged=true mongo \<br>--replSet &quot;rs&quot; <br></code></pre></td></tr></table></figure><p class="note note-primary">添加节点和仲裁节点</p><p>添加，删除副本集节点参考 <code>rs</code> 命令</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php">rs.<span class="hljs-title function_ invoke__">initiate</span>(&#123;<br><span class="hljs-attr">_id</span>: <span class="hljs-string">&quot;rs&quot;</span>,<br><span class="hljs-attr">members</span>: [<br>&#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">host</span>: <span class="hljs-string">&quot;192.168.0.181:27020&quot;</span> &#125;,<br>&#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">host</span>: <span class="hljs-string">&quot;192.168.0.181:27021&quot;</span> &#125;,<br>&#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">host</span>: <span class="hljs-string">&quot;192.168.0.181:27022&quot;</span>, <span class="hljs-attr">arbiterOnly</span>: <span class="hljs-literal">true</span> &#125;<br>] &#125;)<br></code></pre></td></tr></table></figure><p class="note note-primary">查看集群状态</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><code class="hljs shell">rs:PRIMARY&gt; rs.status()<br>&#123;<br>        &quot;set&quot; : &quot;rs&quot;,<br>        &quot;date&quot; : ISODate(&quot;2023-05-10T16:00:35.077Z&quot;),<br>        &quot;myState&quot; : 1,<br>        &quot;term&quot; : NumberLong(1),<br>        &quot;syncSourceHost&quot; : &quot;&quot;,<br>        &quot;syncSourceId&quot; : -1,<br>        &quot;heartbeatIntervalMillis&quot; : NumberLong(2000),<br>        &quot;majorityVoteCount&quot; : 2,<br>        &quot;writeMajorityCount&quot; : 2,<br>        &quot;votingMembersCount&quot; : 3,<br>        &quot;writableVotingMembersCount&quot; : 2,<br>        &quot;optimes&quot; : &#123;<br>                &quot;lastCommittedOpTime&quot; : &#123;<br>                        &quot;ts&quot; : Timestamp(1683734432, 3),<br>                        &quot;t&quot; : NumberLong(1)<br>                &#125;,<br>                &quot;lastCommittedWallTime&quot; : ISODate(&quot;2023-05-10T16:00:32.456Z&quot;),<br>                &quot;readConcernMajorityOpTime&quot; : &#123;<br>                        &quot;ts&quot; : Timestamp(1683734432, 3),<br>                        &quot;t&quot; : NumberLong(1)<br>                &#125;,<br>                &quot;appliedOpTime&quot; : &#123;<br>                        &quot;ts&quot; : Timestamp(1683734432, 3),<br>                        &quot;t&quot; : NumberLong(1)<br>                &#125;,<br>                &quot;durableOpTime&quot; : &#123;<br>                        &quot;ts&quot; : Timestamp(1683734432, 3),<br>                        &quot;t&quot; : NumberLong(1)<br>                &#125;,<br>                &quot;lastAppliedWallTime&quot; : ISODate(&quot;2023-05-10T16:00:32.456Z&quot;),<br>                &quot;lastDurableWallTime&quot; : ISODate(&quot;2023-05-10T16:00:32.456Z&quot;)<br>        &#125;,<br>        &quot;lastStableRecoveryTimestamp&quot; : Timestamp(1683734409, 1),<br>        &quot;electionCandidateMetrics&quot; : &#123;<br>                &quot;lastElectionReason&quot; : &quot;electionTimeout&quot;,<br>                &quot;lastElectionDate&quot; : ISODate(&quot;2023-05-10T15:58:29.320Z&quot;),<br>                &quot;electionTerm&quot; : NumberLong(1),<br>                &quot;lastCommittedOpTimeAtElection&quot; : &#123;<br>                        &quot;ts&quot; : Timestamp(1683734298, 1),<br>                        &quot;t&quot; : NumberLong(-1)<br>                &#125;,<br>                &quot;lastSeenOpTimeAtElection&quot; : &#123;<br>                        &quot;ts&quot; : Timestamp(1683734298, 1),<br>                        &quot;t&quot; : NumberLong(-1)<br>                &#125;,<br>                &quot;numVotesNeeded&quot; : 2,<br>                &quot;priorityAtElection&quot; : 1,<br>                &quot;electionTimeoutMillis&quot; : NumberLong(10000),<br>                &quot;numCatchUpOps&quot; : NumberLong(0),<br>                &quot;newTermStartDate&quot; : ISODate(&quot;2023-05-10T15:58:29.377Z&quot;),<br>                &quot;wMajorityWriteAvailabilityDate&quot; : ISODate(&quot;2023-05-10T15:58:30.274Z&quot;)<br>        &#125;,<br>        &quot;members&quot; : [<br>                &#123;<br>                        &quot;_id&quot; : 0,<br>                        &quot;name&quot; : &quot;192.168.0.181:27020&quot;,<br>                        &quot;health&quot; : 1,<br>                        &quot;state&quot; : 1,<br>                        &quot;stateStr&quot; : &quot;PRIMARY&quot;,	// 主节点<br>                        &quot;uptime&quot; : 605,<br>                        &quot;optime&quot; : &#123;<br>                                &quot;ts&quot; : Timestamp(1683734432, 3),<br>                                &quot;t&quot; : NumberLong(1)<br>                        &#125;,<br>                        &quot;optimeDate&quot; : ISODate(&quot;2023-05-10T16:00:32Z&quot;),<br>                        &quot;lastAppliedWallTime&quot; : ISODate(&quot;2023-05-10T16:00:32.456Z&quot;),<br>                        &quot;lastDurableWallTime&quot; : ISODate(&quot;2023-05-10T16:00:32.456Z&quot;),<br>                        &quot;syncSourceHost&quot; : &quot;&quot;,<br>                        &quot;syncSourceId&quot; : -1,<br>                        &quot;infoMessage&quot; : &quot;&quot;,<br>                        &quot;electionTime&quot; : Timestamp(1683734309, 1),<br>                        &quot;electionDate&quot; : ISODate(&quot;2023-05-10T15:58:29Z&quot;),<br>                        &quot;configVersion&quot; : 1,<br>                        &quot;configTerm&quot; : 1,<br>                        &quot;self&quot; : true,<br>                        &quot;lastHeartbeatMessage&quot; : &quot;&quot;<br>                &#125;,<br>                &#123;<br>                        &quot;_id&quot; : 1,<br>                        &quot;name&quot; : &quot;192.168.0.181:27021&quot;,<br>                        &quot;health&quot; : 1,<br>                        &quot;state&quot; : 2,<br>                        &quot;stateStr&quot; : &quot;SECONDARY&quot;,	// 副本节点<br>                        &quot;uptime&quot; : 136,<br>                        &quot;optime&quot; : &#123;<br>                                &quot;ts&quot; : Timestamp(1683734432, 3),<br>                                &quot;t&quot; : NumberLong(1)<br>                        &#125;,<br>                        &quot;optimeDurable&quot; : &#123;<br>                                &quot;ts&quot; : Timestamp(1683734432, 3),<br>                                &quot;t&quot; : NumberLong(1)<br>                        &#125;,<br>                        &quot;optimeDate&quot; : ISODate(&quot;2023-05-10T16:00:32Z&quot;),<br>                        &quot;optimeDurableDate&quot; : ISODate(&quot;2023-05-10T16:00:32Z&quot;),<br>                        &quot;lastAppliedWallTime&quot; : ISODate(&quot;2023-05-10T16:00:32.456Z&quot;),<br>                        &quot;lastDurableWallTime&quot; : ISODate(&quot;2023-05-10T16:00:32.456Z&quot;),<br>                        &quot;lastHeartbeat&quot; : ISODate(&quot;2023-05-10T16:00:33.337Z&quot;),<br>                        &quot;lastHeartbeatRecv&quot; : ISODate(&quot;2023-05-10T16:00:34.358Z&quot;),<br>                        &quot;pingMs&quot; : NumberLong(0),<br>                        &quot;lastHeartbeatMessage&quot; : &quot;&quot;,<br>                        &quot;syncSourceHost&quot; : &quot;192.168.0.181:27020&quot;,<br>                        &quot;syncSourceId&quot; : 0,<br>                        &quot;infoMessage&quot; : &quot;&quot;,<br>                        &quot;configVersion&quot; : 1,<br>                        &quot;configTerm&quot; : 1<br>                &#125;,<br>                &#123;<br>                        &quot;_id&quot; : 2,<br>                        &quot;name&quot; : &quot;192.168.0.181:27022&quot;,<br>                        &quot;health&quot; : 1,<br>                        &quot;state&quot; : 7,<br>                        &quot;stateStr&quot; : &quot;ARBITER&quot;,	// 仲裁节点<br>                        &quot;uptime&quot; : 136,<br>                        &quot;lastHeartbeat&quot; : ISODate(&quot;2023-05-10T16:00:33.338Z&quot;),<br>                        &quot;lastHeartbeatRecv&quot; : ISODate(&quot;2023-05-10T16:00:33.351Z&quot;),<br>                        &quot;pingMs&quot; : NumberLong(0),<br>                        &quot;lastHeartbeatMessage&quot; : &quot;&quot;,<br>                        &quot;syncSourceHost&quot; : &quot;&quot;,<br>                        &quot;syncSourceId&quot; : -1,<br>                        &quot;infoMessage&quot; : &quot;&quot;,<br>                        &quot;configVersion&quot; : 1,<br>                        &quot;configTerm&quot; : 1<br>                &#125;<br>        ],<br>        &quot;ok&quot; : 1,<br>        &quot;$clusterTime&quot; : &#123;<br>                &quot;clusterTime&quot; : Timestamp(1683734432, 3),<br>                &quot;signature&quot; : &#123;<br>                        &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),<br>                        &quot;keyId&quot; : NumberLong(0)<br>                &#125;<br>        &#125;,<br>        &quot;operationTime&quot; : Timestamp(1683734432, 3)<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2023/04/14/MongoDB/%E5%89%AF%E6%9C%AC%E9%9B%86%E8%8A%82%E7%82%B9.png" srcset="/img/loading.gif" lazyload alt="副本集节点"></p><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/92b1f01977eb">集群安全生成 key文件</a></p><h2 id="副本集的读写操作"><a class="markdownIt-Anchor" href="#副本集的读写操作"></a> 副本集的读写操作</h2><p>在主节点上执行写操作</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs javascript">use test;<br><br><span class="hljs-attr">rs</span>:<span class="hljs-variable constant_">PRIMARY</span>&gt; db.<span class="hljs-property">user</span>.<span class="hljs-title function_">insertOne</span>(<span class="hljs-params"> &#123; userName:<span class="hljs-string">&quot;wgf&quot;</span>, sex:<span class="hljs-number">1</span> &#125; </span>)<br>&#123;<br>        <span class="hljs-string">&quot;acknowledged&quot;</span> : <span class="hljs-literal">true</span>,<br>        <span class="hljs-string">&quot;insertedId&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;645bc114a1d8b7b70ea2dbd0&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>在副本节点查询插入的数据</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-attr">rs</span>:<span class="hljs-variable constant_">SECONDARY</span>&gt; db.<span class="hljs-property">user</span>.<span class="hljs-title function_">find</span>(&#123;&#125;)<br><span class="hljs-title class_">Error</span>: <span class="hljs-attr">error</span>: &#123;<br>        <span class="hljs-string">&quot;topologyVersion&quot;</span> : &#123;<br>                <span class="hljs-string">&quot;processId&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;645bbe1c68a22fb5732aef90&quot;</span>),<br>                <span class="hljs-string">&quot;counter&quot;</span> : <span class="hljs-title class_">NumberLong</span>(<span class="hljs-number">4</span>)<br>        &#125;,<br>        <span class="hljs-string">&quot;ok&quot;</span> : <span class="hljs-number">0</span>,<br>        <span class="hljs-string">&quot;errmsg&quot;</span> : <span class="hljs-string">&quot;not master and slaveOk=false&quot;</span>,	<span class="hljs-comment">// 不是 slave节点，不能读取</span><br>        <span class="hljs-string">&quot;code&quot;</span> : <span class="hljs-number">13435</span>,<br>        <span class="hljs-string">&quot;codeName&quot;</span> : <span class="hljs-string">&quot;NotPrimaryNoSecondaryOk&quot;</span>,<br>        <span class="hljs-string">&quot;$clusterTime&quot;</span> : &#123;<br>                <span class="hljs-string">&quot;clusterTime&quot;</span> : <span class="hljs-title class_">Timestamp</span>(<span class="hljs-number">1683734919</span>, <span class="hljs-number">1</span>),<br>                <span class="hljs-string">&quot;signature&quot;</span> : &#123;<br>                        <span class="hljs-string">&quot;hash&quot;</span> : <span class="hljs-title class_">BinData</span>(<span class="hljs-number">0</span>,<span class="hljs-string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span>),<br>                        <span class="hljs-string">&quot;keyId&quot;</span> : <span class="hljs-title class_">NumberLong</span>(<span class="hljs-number">0</span>)<br>                &#125;<br>        &#125;,<br>        <span class="hljs-string">&quot;operationTime&quot;</span> : <span class="hljs-title class_">Timestamp</span>(<span class="hljs-number">1683734919</span>, <span class="hljs-number">1</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>发现，不能读取集合的数据。当前从节点只是一个备份，不是奴隶节点，无法读取数据，写当然更不行。因为默认情况下，从节点是没有读写权限的，可以增加读的权限，但需要进行设置。</p><p class="note note-primary">设置为奴隶节点</p><p>设置为奴隶节点，允许在从成员上运行读的操作</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs javascript">在副本节点执行<br><br>rs.<span class="hljs-title function_">slaveOk</span>()<br>或<br>rs.<span class="hljs-title function_">slaveOk</span>(<span class="hljs-literal">true</span>)<br></code></pre></td></tr></table></figure><p>再次在 <code>奴隶节点</code> 执行查询请求，数据已经被同步到副本节点</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-attr">rs</span>:<span class="hljs-variable constant_">SECONDARY</span>&gt; db.<span class="hljs-property">user</span>.<span class="hljs-title function_">find</span>(<span class="hljs-params">&#123;&#125;</span>)<br>&#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;645bc114a1d8b7b70ea2dbd0&quot;</span>), <span class="hljs-string">&quot;userName&quot;</span> : <span class="hljs-string">&quot;wgf&quot;</span>, <span class="hljs-string">&quot;sex&quot;</span> : <span class="hljs-number">1</span> &#125;<br></code></pre></td></tr></table></figure><h2 id="副本集故障测试"><a class="markdownIt-Anchor" href="#副本集故障测试"></a> 副本集故障测试</h2><p class="note note-primary">副本节点宕机</p><p>关闭 <code>mongod_27021</code> 节点</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker stop mongod_27021<br></code></pre></td></tr></table></figure><p>主节点和仲裁节点对 mongod_27021 的心跳失败。因为主节点还在，因此，没有触发投票选举。</p><p>如果此时，在主节点写入数据,写入不受影响</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-property">user</span>.<span class="hljs-title function_">insertOne</span>(<span class="hljs-params"> &#123; userName:<span class="hljs-string">&quot;test&quot;</span>, age:<span class="hljs-number">30</span> &#125; </span>)<br>&#123;<br>        <span class="hljs-string">&quot;acknowledged&quot;</span> : <span class="hljs-literal">true</span>,<br>        <span class="hljs-string">&quot;insertedId&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;645c5203a79b5534f6f3e61a&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>重新启动 <code>mongod_27021</code> 节点</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs javascript">rs.<span class="hljs-title function_">slaveOk</span>(<span class="hljs-literal">true</span>) #设置为奴隶节点<br>db.<span class="hljs-property">user</span>.<span class="hljs-title function_">find</span>(<span class="hljs-params"> &#123; userName:<span class="hljs-string">&quot;test&quot;</span> &#125; </span>)<br>&#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;645c5203a79b5534f6f3e61a&quot;</span>), <span class="hljs-string">&quot;userName&quot;</span> : <span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-string">&quot;age&quot;</span> : <span class="hljs-number">30</span> &#125;<br></code></pre></td></tr></table></figure><p>再启动从节点，会发现，主节点写入的数据，会自动同步给从节点。</p><p class="note note-primary">主节点宕机</p><p>关闭 <code>mongod_27020</code> 节点</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker stop mongod_27020<br></code></pre></td></tr></table></figure><p>发现，从节点和仲裁节点对 <code>mongod_27020</code>的心跳失败，当失败超过10秒，此时因为没有主节点了，会自动发起投票。</p><p><code>mongod_27022</code> 向 <code>mongod_27021</code> 投了一票，<code>mongod_27021</code> 本身自带一票，因此共两票，满足过半原则，<code>mongod_27020</code> 成为新主节点</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">连接新的主节点</span><br>mongo 192.168.0.181:27021<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">插入数据</span><br>rs:PRIMARY&gt; db.user.insertOne( &#123; userName:&quot;test2&quot;, age:30 &#125; )<br>&#123;<br>        &quot;acknowledged&quot; : true,<br>        &quot;insertedId&quot; : ObjectId(&quot;645c5bc84518ca10db10c508&quot;)<br>&#125;<br></code></pre></td></tr></table></figure><p>重新启动 <code>mongod_27020</code> 节点，发现其变成从节点，会向新的主节点重新同步数据</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">use test<br>rs.slaveOk(true)<br>rs:SECONDARY&gt; db.user.find()<br>&#123; &quot;_id&quot; : ObjectId(&quot;645bc114a1d8b7b70ea2dbd0&quot;), &quot;userName&quot; : &quot;wgf&quot;, &quot;sex&quot; : 1 &#125;<br>&#123; &quot;_id&quot; : ObjectId(&quot;645c5203a79b5534f6f3e61a&quot;), &quot;userName&quot; : &quot;test&quot;, &quot;age&quot; : 30 &#125;<br>&#123; &quot;_id&quot; : ObjectId(&quot;645c5bc84518ca10db10c508&quot;), &quot;userName&quot; : &quot;test2&quot;, &quot;age&quot; : 30 &#125;<br></code></pre></td></tr></table></figure><p class="note note-primary">服务降级</p><p>关闭仲裁节点和从节点</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker stop mongod_27020<br>docker stop mongod_27022<br></code></pre></td></tr></table></figure><p>登录 <code>mongod_27021</code> 节点，查看副本集状态</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-attr">rs</span>:<span class="hljs-variable constant_">SECONDARY</span>&gt; rs.<span class="hljs-title function_">status</span>(<span class="hljs-params"></span>)<br>&#123;<br>        <span class="hljs-string">&quot;set&quot;</span> : <span class="hljs-string">&quot;rs&quot;</span>,<br>        <span class="hljs-string">&quot;date&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2023-05-11T03:13:32.135Z&quot;</span>),<br>        <span class="hljs-string">&quot;myState&quot;</span> : <span class="hljs-number">2</span>,<br>        <span class="hljs-string">&quot;term&quot;</span> : <span class="hljs-title class_">NumberLong</span>(<span class="hljs-number">3</span>),<br>        <span class="hljs-string">&quot;syncSourceHost&quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>        <span class="hljs-string">&quot;syncSourceId&quot;</span> : -<span class="hljs-number">1</span>,<br>        <span class="hljs-string">&quot;heartbeatIntervalMillis&quot;</span> : <span class="hljs-title class_">NumberLong</span>(<span class="hljs-number">2000</span>),<br>        <span class="hljs-string">&quot;majorityVoteCount&quot;</span> : <span class="hljs-number">2</span>,<br>        <span class="hljs-string">&quot;writeMajorityCount&quot;</span> : <span class="hljs-number">2</span>,<br>        <span class="hljs-string">&quot;votingMembersCount&quot;</span> : <span class="hljs-number">3</span>,<br>        <span class="hljs-string">&quot;writableVotingMembersCount&quot;</span> : <span class="hljs-number">2</span>,<br>        <span class="hljs-string">&quot;optimes&quot;</span> : &#123;<br>                <span class="hljs-string">&quot;lastCommittedOpTime&quot;</span> : &#123;<br>                        <span class="hljs-string">&quot;ts&quot;</span> : <span class="hljs-title class_">Timestamp</span>(<span class="hljs-number">1683774683</span>, <span class="hljs-number">1</span>),<br>                        <span class="hljs-string">&quot;t&quot;</span> : <span class="hljs-title class_">NumberLong</span>(<span class="hljs-number">3</span>)<br>                &#125;,<br>                <span class="hljs-string">&quot;lastCommittedWallTime&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2023-05-11T03:11:23.552Z&quot;</span>),<br>                <span class="hljs-string">&quot;readConcernMajorityOpTime&quot;</span> : &#123;<br>                        <span class="hljs-string">&quot;ts&quot;</span> : <span class="hljs-title class_">Timestamp</span>(<span class="hljs-number">1683774683</span>, <span class="hljs-number">1</span>),<br>                        <span class="hljs-string">&quot;t&quot;</span> : <span class="hljs-title class_">NumberLong</span>(<span class="hljs-number">3</span>)<br>                &#125;,<br>                <span class="hljs-string">&quot;appliedOpTime&quot;</span> : &#123;<br>                        <span class="hljs-string">&quot;ts&quot;</span> : <span class="hljs-title class_">Timestamp</span>(<span class="hljs-number">1683774703</span>, <span class="hljs-number">1</span>),<br>                        <span class="hljs-string">&quot;t&quot;</span> : <span class="hljs-title class_">NumberLong</span>(<span class="hljs-number">3</span>)<br>                &#125;,<br>                <span class="hljs-string">&quot;durableOpTime&quot;</span> : &#123;<br>                        <span class="hljs-string">&quot;ts&quot;</span> : <span class="hljs-title class_">Timestamp</span>(<span class="hljs-number">1683774703</span>, <span class="hljs-number">1</span>),<br>                        <span class="hljs-string">&quot;t&quot;</span> : <span class="hljs-title class_">NumberLong</span>(<span class="hljs-number">3</span>)<br>                &#125;,<br>                <span class="hljs-string">&quot;lastAppliedWallTime&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2023-05-11T03:11:43.552Z&quot;</span>),<br>                <span class="hljs-string">&quot;lastDurableWallTime&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2023-05-11T03:11:43.552Z&quot;</span>)<br>        &#125;,<br>        <span class="hljs-string">&quot;lastStableRecoveryTimestamp&quot;</span> : <span class="hljs-title class_">Timestamp</span>(<span class="hljs-number">1683774683</span>, <span class="hljs-number">1</span>),<br>        <span class="hljs-string">&quot;members&quot;</span> : [<br>                &#123;<br>                        <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">0</span>,<br>                        <span class="hljs-string">&quot;name&quot;</span> : <span class="hljs-string">&quot;192.168.0.181:27020&quot;</span>,<br>                        <span class="hljs-string">&quot;health&quot;</span> : <span class="hljs-number">0</span>,<br>                        <span class="hljs-string">&quot;state&quot;</span> : <span class="hljs-number">8</span>,<br>                        <span class="hljs-string">&quot;stateStr&quot;</span> : <span class="hljs-string">&quot;(not reachable/healthy)&quot;</span>,<br>                        <span class="hljs-string">&quot;uptime&quot;</span> : <span class="hljs-number">0</span>,<br>                        <span class="hljs-string">&quot;optime&quot;</span> : &#123;<br>                                <span class="hljs-string">&quot;ts&quot;</span> : <span class="hljs-title class_">Timestamp</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>),<br>                                <span class="hljs-string">&quot;t&quot;</span> : <span class="hljs-title class_">NumberLong</span>(-<span class="hljs-number">1</span>)<br>                        &#125;,<br>                        <span class="hljs-string">&quot;optimeDurable&quot;</span> : &#123;<br>                                <span class="hljs-string">&quot;ts&quot;</span> : <span class="hljs-title class_">Timestamp</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>),<br>                                <span class="hljs-string">&quot;t&quot;</span> : <span class="hljs-title class_">NumberLong</span>(-<span class="hljs-number">1</span>)<br>                        &#125;,<br>                        <span class="hljs-string">&quot;optimeDate&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;1970-01-01T00:00:00Z&quot;</span>),<br>                        <span class="hljs-string">&quot;optimeDurableDate&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;1970-01-01T00:00:00Z&quot;</span>),<br>                        <span class="hljs-string">&quot;lastAppliedWallTime&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2023-05-11T03:11:23.552Z&quot;</span>),<br>                        <span class="hljs-string">&quot;lastDurableWallTime&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2023-05-11T03:11:23.552Z&quot;</span>),<br>                        <span class="hljs-string">&quot;lastHeartbeat&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2023-05-11T03:13:32.067Z&quot;</span>),<br>                        <span class="hljs-string">&quot;lastHeartbeatRecv&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2023-05-11T03:11:25.994Z&quot;</span>),<br>                        <span class="hljs-string">&quot;pingMs&quot;</span> : <span class="hljs-title class_">NumberLong</span>(<span class="hljs-number">0</span>),<br>                        <span class="hljs-string">&quot;lastHeartbeatMessage&quot;</span> : <span class="hljs-string">&quot;Error connecting to 192.168.0.181:27020 :: caused by :: Connection refused&quot;</span>,<br>                        <span class="hljs-string">&quot;syncSourceHost&quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>                        <span class="hljs-string">&quot;syncSourceId&quot;</span> : -<span class="hljs-number">1</span>,<br>                        <span class="hljs-string">&quot;infoMessage&quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>                        <span class="hljs-string">&quot;configVersion&quot;</span> : <span class="hljs-number">1</span>,<br>                        <span class="hljs-string">&quot;configTerm&quot;</span> : <span class="hljs-number">3</span><br>                &#125;,<br>                &#123;<br>                        <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">1</span>,<br>                        <span class="hljs-string">&quot;name&quot;</span> : <span class="hljs-string">&quot;192.168.0.181:27021&quot;</span>,<br>                        <span class="hljs-string">&quot;health&quot;</span> : <span class="hljs-number">1</span>,<br>                        <span class="hljs-string">&quot;state&quot;</span> : <span class="hljs-number">2</span>,<br>                        <span class="hljs-string">&quot;stateStr&quot;</span> : <span class="hljs-string">&quot;SECONDARY&quot;</span>,<br>                        <span class="hljs-string">&quot;uptime&quot;</span> : <span class="hljs-number">2823</span>,<br>                        <span class="hljs-string">&quot;optime&quot;</span> : &#123;<br>                                <span class="hljs-string">&quot;ts&quot;</span> : <span class="hljs-title class_">Timestamp</span>(<span class="hljs-number">1683774703</span>, <span class="hljs-number">1</span>),<br>                                <span class="hljs-string">&quot;t&quot;</span> : <span class="hljs-title class_">NumberLong</span>(<span class="hljs-number">3</span>)<br>                        &#125;,<br>                        <span class="hljs-string">&quot;optimeDate&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2023-05-11T03:11:43Z&quot;</span>),<br>                        <span class="hljs-string">&quot;lastAppliedWallTime&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2023-05-11T03:11:43.552Z&quot;</span>),<br>                        <span class="hljs-string">&quot;lastDurableWallTime&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2023-05-11T03:11:43.552Z&quot;</span>),<br>                        <span class="hljs-string">&quot;syncSourceHost&quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>                        <span class="hljs-string">&quot;syncSourceId&quot;</span> : -<span class="hljs-number">1</span>,<br>                        <span class="hljs-string">&quot;infoMessage&quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>                        <span class="hljs-string">&quot;configVersion&quot;</span> : <span class="hljs-number">1</span>,<br>                        <span class="hljs-string">&quot;configTerm&quot;</span> : <span class="hljs-number">3</span>,<br>                        <span class="hljs-string">&quot;self&quot;</span> : <span class="hljs-literal">true</span>,<br>                        <span class="hljs-string">&quot;lastHeartbeatMessage&quot;</span> : <span class="hljs-string">&quot;&quot;</span><br>                &#125;,<br>                &#123;<br>                        <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">2</span>,<br>                        <span class="hljs-string">&quot;name&quot;</span> : <span class="hljs-string">&quot;192.168.0.181:27022&quot;</span>,<br>                        <span class="hljs-string">&quot;health&quot;</span> : <span class="hljs-number">0</span>,<br>                        <span class="hljs-string">&quot;state&quot;</span> : <span class="hljs-number">8</span>,<br>                        <span class="hljs-string">&quot;stateStr&quot;</span> : <span class="hljs-string">&quot;(not reachable/healthy)&quot;</span>,<br>                        <span class="hljs-string">&quot;uptime&quot;</span> : <span class="hljs-number">0</span>,<br>                        <span class="hljs-string">&quot;lastHeartbeat&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2023-05-11T03:13:32.048Z&quot;</span>),<br>                        <span class="hljs-string">&quot;lastHeartbeatRecv&quot;</span> : <span class="hljs-title class_">ISODate</span>(<span class="hljs-string">&quot;2023-05-11T03:11:37.565Z&quot;</span>),<br>                        <span class="hljs-string">&quot;pingMs&quot;</span> : <span class="hljs-title class_">NumberLong</span>(<span class="hljs-number">0</span>),<br>                        <span class="hljs-string">&quot;lastHeartbeatMessage&quot;</span> : <span class="hljs-string">&quot;Error connecting to 192.168.0.181:27022 :: caused by :: Connection refused&quot;</span>,<br>                        <span class="hljs-string">&quot;syncSourceHost&quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>                        <span class="hljs-string">&quot;syncSourceId&quot;</span> : -<span class="hljs-number">1</span>,<br>                        <span class="hljs-string">&quot;infoMessage&quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>                        <span class="hljs-string">&quot;configVersion&quot;</span> : <span class="hljs-number">1</span>,<br>                        <span class="hljs-string">&quot;configTerm&quot;</span> : <span class="hljs-number">3</span><br>                &#125;<br>        ],<br>        <span class="hljs-string">&quot;ok&quot;</span> : <span class="hljs-number">1</span>,<br>        <span class="hljs-string">&quot;$clusterTime&quot;</span> : &#123;<br>                <span class="hljs-string">&quot;clusterTime&quot;</span> : <span class="hljs-title class_">Timestamp</span>(<span class="hljs-number">1683774703</span>, <span class="hljs-number">1</span>),<br>                <span class="hljs-string">&quot;signature&quot;</span> : &#123;<br>                        <span class="hljs-string">&quot;hash&quot;</span> : <span class="hljs-title class_">BinData</span>(<span class="hljs-number">0</span>,<span class="hljs-string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span>),<br>                        <span class="hljs-string">&quot;keyId&quot;</span> : <span class="hljs-title class_">NumberLong</span>(<span class="hljs-number">0</span>)<br>                &#125;<br>        &#125;,<br>        <span class="hljs-string">&quot;operationTime&quot;</span> : <span class="hljs-title class_">Timestamp</span>(<span class="hljs-number">1683774703</span>, <span class="hljs-number">1</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p><span class="green-line">由于副本集存活的节点数少于总节点数的一半，服务进入降级模式，主节点自动降级为副本节点，此时的服务只能够读取不能够写入。当重新加入的节点数过半后，重新选举主节点，副本集写入功能恢复</span></p><h2 id="连接副本集"><a class="markdownIt-Anchor" href="#连接副本集"></a> 连接副本集</h2><p>连接副本集写法</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">mongodb://&lt;<span class="hljs-keyword">replica</span>-<span class="hljs-keyword">set</span>-hostname&gt;/&lt;<span class="hljs-keyword">database</span>-<span class="hljs-type">name</span>&gt;?replicaSet=&lt;<span class="hljs-keyword">replica</span>-<span class="hljs-keyword">set</span>-<span class="hljs-type">name</span>&gt;<br></code></pre></td></tr></table></figure><p><code>mongod</code> 命令连接副本集</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">mongo &quot;mongodb://192.168.0.181:27021,192.168.0.181:27021,192.168.0.181:27022/test?replicaSet=rs&quot;<br></code></pre></td></tr></table></figure><h1 id="分片集群"><a class="markdownIt-Anchor" href="#分片集群"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/sharding/">分片集群</a></h1><p><img src="/2023/04/14/MongoDB/%E5%88%86%E7%89%87.png" srcset="/img/loading.gif" lazyload alt></p><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/reference/glossary/#std-term-sharding">分片</a> 是一种将数据分配到多个机器上的方法。MongoDB通过分片技术来支持具有海量数据集和高吞吐量操作的部署方案。</p><p>数据库系统的数据集或应用的吞吐量比较大的情况下，会给单台服务器的处理能力带来极大的挑战。例如，高查询率会耗尽服务器的CPU资源。工作的数据集大于系统的内存压力、磁盘驱动器的I/O容量。</p><p>分片是水平扩展的一种方案，通过将系统数据集划分至多台机器，并根据需要添加服务器来提升容量。虽然单个机器的总体速度或容量可能不高，但每台机器只需处理整个数据集的某个子集，所以可能会提供比单个高速大容量服务器更高的效率，而且机器的数量只需要根据数据集大小来进行扩展，与单个机器的高端硬件相比，这个方案可以降低总体成本。不过，这种方式会提高基础设施部署维护的复杂性。</p><h2 id="分片集群组件"><a class="markdownIt-Anchor" href="#分片集群组件"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/core/sharded-cluster-components/">分片集群组件</a></h2><p><img src="/2023/04/14/MongoDB/%E5%88%86%E7%89%87%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84.png" srcset="/img/loading.gif" lazyload alt="分片集群架构"></p><ul><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/core/sharded-cluster-shards/">分片</a>：每个分片都包含分片数据的一个子集。从MongoDB 3.6开始，分片必须部署为副本集。</li><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/core/sharded-cluster-query-router/">路由器</a>： <code>mongos</code> 充当查询路由器，在客户端应用程序和分片集群之间提供接口。从MongoDB 4.4开始， <code>mongos</code> 可以支持 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/core/sharded-cluster-query-router/#std-label-mongos-hedged-reads">对冲读取</a> 以最大程度地减少延迟。</li><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/core/sharded-cluster-config-servers/">配置服务器</a>：配置服务器存储群集的元数据和配置设置。从MongoDB 3.4开始，配置服务器必须部署为副本集（CSRS）</li></ul><p class="note note-primary">分片集群角色</p><table><thead><tr><th>角色</th><th>描述</th></tr></thead><tbody><tr><td>configsvr</td><td>该角色表示当前节点是分片集群的配置服务器。配置服务器负责管理集群的元数据信息，如分片键、分片状态等等。</td></tr><tr><td>shardsvr</td><td>该角色表示当前节点是一个数据分片节点。数据分片节点存储了实际的数据，并负责对数据进行读写操作。</td></tr><tr><td>mongos</td><td>该角色表示当前节点是 mongos 路由器节点。mongos 负责将客户端请求路由到正确的分片节点上，并合并结果返回给客户端。</td></tr></tbody></table><h2 id="集群搭建"><a class="markdownIt-Anchor" href="#集群搭建"></a> 集群搭建</h2><p><img src="/2023/04/14/MongoDB/%E5%88%86%E7%89%87%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84%E5%9B%BE.png" srcset="/img/loading.gif" lazyload alt="分片集群架构图"></p><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44975592/article/details/125244812">参考搭建</a></p><p class="note note-primary">创建第一个分片副本集</p><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs dsconfig"><span class="hljs-string">docker</span> <span class="hljs-string">run</span> <span class="hljs-built_in">--name</span> <span class="hljs-string">mongo_rs1_1</span> <span class="hljs-built_in">--network</span> <span class="hljs-string">bridge</span>  -<span class="hljs-string">d</span> <span class="hljs-string">mongo</span> <span class="hljs-built_in">--replSet</span> <span class="hljs-string">rs1</span> <span class="hljs-built_in">--shardsvr</span> <span class="hljs-built_in">--port</span> <span class="hljs-string">27017</span><br><span class="hljs-string">docker</span> <span class="hljs-string">run</span> <span class="hljs-built_in">--name</span> <span class="hljs-string">mongo_rs1_2</span> <span class="hljs-built_in">--network</span> <span class="hljs-string">bridge</span>  -<span class="hljs-string">d</span> <span class="hljs-string">mongo</span> <span class="hljs-built_in">--replSet</span> <span class="hljs-string">rs1</span> <span class="hljs-built_in">--shardsvr</span> <span class="hljs-built_in">--port</span> <span class="hljs-string">27017</span><br><span class="hljs-string">docker</span> <span class="hljs-string">run</span> <span class="hljs-built_in">--name</span> <span class="hljs-string">mongo_rs1_3</span> <span class="hljs-built_in">--network</span> <span class="hljs-string">bridge</span>  -<span class="hljs-string">d</span> <span class="hljs-string">mongo</span> <span class="hljs-built_in">--replSet</span> <span class="hljs-string">rs1</span> <span class="hljs-built_in">--shardsvr</span> <span class="hljs-built_in">--port</span> <span class="hljs-string">27017</span><br><br><span class="hljs-comment"># 查看3个容器的ip地址</span><br><span class="hljs-string">docker</span> <span class="hljs-string">inspect</span> 容器<span class="hljs-string">ID</span> | <span class="hljs-string">grep</span> <span class="hljs-string">IPAddress</span><br><span class="hljs-comment"># ip分别为</span><br><span class="hljs-string">172</span>.<span class="hljs-string">17</span>.<span class="hljs-string">0</span>.<span class="hljs-string">2</span><br><span class="hljs-string">172</span>.<span class="hljs-string">17</span>.<span class="hljs-string">0</span>.<span class="hljs-string">3</span><br><span class="hljs-string">172</span>.<span class="hljs-string">17</span>.<span class="hljs-string">0</span>.<span class="hljs-string">4</span><br><br><span class="hljs-string">docker</span> <span class="hljs-string">exec</span> -<span class="hljs-string">it</span> <span class="hljs-string">mongo_rs1_1</span> <span class="hljs-string">bash</span><br><br><span class="hljs-string">mongo</span><br><br><span class="hljs-comment"># 初始化副本集</span><br><span class="hljs-string">rs</span>.<span class="hljs-string">initiate</span>(<br>	&#123;<br>	     <span class="hljs-string">_id</span>:<span class="hljs-string">&quot;rs1&quot;</span>,<br>	     <span class="hljs-string">members</span>:[<br>	        &#123;<span class="hljs-string">_id:0,</span><span class="hljs-string">host</span>:<span class="hljs-string">&quot; 172.17.0.2:27017&quot;</span>&#125;,<br>	        &#123;<span class="hljs-string">_id:1,</span><span class="hljs-string">host</span>:<span class="hljs-string">&quot; 172.17.0.3:27017&quot;</span>&#125;,<br>	        &#123;<span class="hljs-string">_id:2,</span><span class="hljs-string">host</span>:<span class="hljs-string">&quot; 172.17.0.4:27017&quot;</span>&#125;<br>	     ]<br>	 &#125;<br>)<br></code></pre></td></tr></table></figure><p class="note note-primary">创建第二个分片副本集</p><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs dsconfig"><span class="hljs-string">docker</span> <span class="hljs-string">run</span> <span class="hljs-built_in">--name</span> <span class="hljs-string">mongo_rs2_1</span> <span class="hljs-built_in">--network</span> <span class="hljs-string">bridge</span>  -<span class="hljs-string">d</span> <span class="hljs-string">mongo</span> <span class="hljs-built_in">--replSet</span> <span class="hljs-string">rs2</span> <span class="hljs-built_in">--shardsvr</span> <span class="hljs-built_in">--port</span> <span class="hljs-string">27017</span><br><span class="hljs-string">docker</span> <span class="hljs-string">run</span> <span class="hljs-built_in">--name</span> <span class="hljs-string">mongo_rs2_2</span> <span class="hljs-built_in">--network</span> <span class="hljs-string">bridge</span>  -<span class="hljs-string">d</span> <span class="hljs-string">mongo</span> <span class="hljs-built_in">--replSet</span> <span class="hljs-string">rs2</span> <span class="hljs-built_in">--shardsvr</span> <span class="hljs-built_in">--port</span> <span class="hljs-string">27017</span><br><span class="hljs-string">docker</span> <span class="hljs-string">run</span> <span class="hljs-built_in">--name</span> <span class="hljs-string">mongo_rs2_3</span> <span class="hljs-built_in">--network</span> <span class="hljs-string">bridge</span>  -<span class="hljs-string">d</span> <span class="hljs-string">mongo</span> <span class="hljs-built_in">--replSet</span> <span class="hljs-string">rs2</span> <span class="hljs-built_in">--shardsvr</span> <span class="hljs-built_in">--port</span> <span class="hljs-string">27017</span><br><br><span class="hljs-comment"># 查看3个容器的ip地址</span><br><span class="hljs-string">docker</span> <span class="hljs-string">inspect</span> 容器<span class="hljs-string">ID</span> | <span class="hljs-string">grep</span> <span class="hljs-string">IPAddress</span><br><span class="hljs-comment"># ip分别为</span><br><span class="hljs-string">172</span>.<span class="hljs-string">17</span>.<span class="hljs-string">0</span>.<span class="hljs-string">5</span><br><span class="hljs-string">172</span>.<span class="hljs-string">17</span>.<span class="hljs-string">0</span>.<span class="hljs-string">6</span><br><span class="hljs-string">172</span>.<span class="hljs-string">17</span>.<span class="hljs-string">0</span>.<span class="hljs-string">7</span><br><br><span class="hljs-string">docker</span> <span class="hljs-string">exec</span> -<span class="hljs-string">it</span> <span class="hljs-string">mongo_rs2_1</span> <span class="hljs-string">bash</span><br><br><span class="hljs-string">mongo</span><br><br><span class="hljs-comment"># 初始化副本集</span><br><span class="hljs-string">rs</span>.<span class="hljs-string">initiate</span>(<br>	&#123;<br>	     <span class="hljs-string">_id</span>:<span class="hljs-string">&quot;rs2&quot;</span>,<br>	     <span class="hljs-string">members</span>:[<br>	        &#123;<span class="hljs-string">_id:0,</span><span class="hljs-string">host</span>:<span class="hljs-string">&quot; 172.17.0.5:27017&quot;</span>&#125;,<br>	        &#123;<span class="hljs-string">_id:1,</span><span class="hljs-string">host</span>:<span class="hljs-string">&quot; 172.17.0.6:27017&quot;</span>&#125;,<br>	        &#123;<span class="hljs-string">_id:2,</span><span class="hljs-string">host</span>:<span class="hljs-string">&quot; 172.17.0.7:27017&quot;</span>&#125;<br>	     ]<br>	 &#125;<br>)<br></code></pre></td></tr></table></figure><p class="note note-primary">创建配置服务副本集</p><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs dsconfig"><span class="hljs-string">docker</span> <span class="hljs-string">run</span> <span class="hljs-built_in">--name</span> <span class="hljs-string">mongo_config_1</span> <span class="hljs-built_in">--network</span> <span class="hljs-string">bridge</span>  -<span class="hljs-string">d</span> <span class="hljs-string">mongo</span>  <span class="hljs-built_in">--replSet</span> <span class="hljs-string">rsconfig</span>  <span class="hljs-built_in">--configsvr</span>  <span class="hljs-built_in">--port</span> <span class="hljs-string">27017</span><br><span class="hljs-string">docker</span> <span class="hljs-string">run</span> <span class="hljs-built_in">--name</span> <span class="hljs-string">mongo_config_2</span> <span class="hljs-built_in">--network</span> <span class="hljs-string">bridge</span>  -<span class="hljs-string">d</span> <span class="hljs-string">mongo</span>  <span class="hljs-built_in">--replSet</span> <span class="hljs-string">rsconfig</span>  <span class="hljs-built_in">--configsvr</span>  <span class="hljs-built_in">--port</span> <span class="hljs-string">27017</span><br><span class="hljs-string">docker</span> <span class="hljs-string">run</span> <span class="hljs-built_in">--name</span> <span class="hljs-string">mongo_config_3</span> <span class="hljs-built_in">--network</span> <span class="hljs-string">bridge</span>  -<span class="hljs-string">d</span> <span class="hljs-string">mongo</span>  <span class="hljs-built_in">--replSet</span> <span class="hljs-string">rsconfig</span>  <span class="hljs-built_in">--configsvr</span>  <span class="hljs-built_in">--port</span> <span class="hljs-string">27017</span><br><br><span class="hljs-comment"># 查看3个容器的ip地址</span><br><span class="hljs-string">docker</span> <span class="hljs-string">inspect</span> 容器<span class="hljs-string">ID</span> | <span class="hljs-string">grep</span> <span class="hljs-string">IPAddress</span><br><span class="hljs-comment"># ip分别为</span><br><span class="hljs-string">172</span>.<span class="hljs-string">17</span>.<span class="hljs-string">0</span>.<span class="hljs-string">8</span><br><span class="hljs-string">172</span>.<span class="hljs-string">17</span>.<span class="hljs-string">0</span>.<span class="hljs-string">9</span><br><span class="hljs-string">172</span>.<span class="hljs-string">17</span>.<span class="hljs-string">0</span>.<span class="hljs-string">10</span><br><br><span class="hljs-string">docker</span> <span class="hljs-string">exec</span> -<span class="hljs-string">it</span> <span class="hljs-string">mongo_config_1</span> <span class="hljs-string">bash</span><br><br><span class="hljs-string">mongo</span><br><br><span class="hljs-comment"># 初始化副本集</span><br><span class="hljs-string">rs</span>.<span class="hljs-string">initiate</span>(<br>	&#123;<br>	     <span class="hljs-string">_id</span>:<span class="hljs-string">&quot;rsconfig&quot;</span>,<br>	     <span class="hljs-string">members</span>:[<br>	        &#123;<span class="hljs-string">_id:0,</span><span class="hljs-string">host</span>:<span class="hljs-string">&quot; 172.17.0.8:27017&quot;</span>&#125;,<br>	        &#123;<span class="hljs-string">_id:1,</span><span class="hljs-string">host</span>:<span class="hljs-string">&quot; 172.17.0.9:27017&quot;</span>&#125;,<br>	        &#123;<span class="hljs-string">_id:2,</span><span class="hljs-string">host</span>:<span class="hljs-string">&quot; 172.17.0.10:27017&quot;</span>&#125;<br>	     ]<br>	 &#125;<br>)<br></code></pre></td></tr></table></figure><p class="note note-primary">创建路由服务</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">docker</span> run -p <span class="hljs-number">28000</span>:<span class="hljs-number">27018</span> --name mongo_router_1 --network bridge -d mongo --bind_ip <span class="hljs-number">0.0.0.0</span><br><span class="hljs-attribute">docker</span> exec -it mongo_router_1 bash<br><br><span class="hljs-comment"># 启动mongo路由服务，指向配置服务器地址</span><br><span class="hljs-attribute">mongos</span> --configdb rsconfig/<span class="hljs-number">172.17.0.8:27017</span>,<span class="hljs-number">172.17.0.9:27017</span>,<span class="hljs-number">172.17.0.10:27017</span> --port <span class="hljs-number">27018</span> --bind_ip <span class="hljs-number">0.0.0.0</span><br></code></pre></td></tr></table></figure><p>打开新的shell</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs applescript">docker exec -<span class="hljs-keyword">it</span> mongo_router_1 bash<br><br><span class="hljs-comment"># 连接mongo路由</span><br>mongo <span class="hljs-comment">--port 27018</span><br></code></pre></td></tr></table></figure><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs stylus">use test<br>db<span class="hljs-selector-class">.user</span><span class="hljs-selector-class">.insert</span>( &#123;userName:<span class="hljs-number">1</span>&#125; )<br><br><span class="hljs-built_in">WriteCommandError</span>(&#123;<br>        <span class="hljs-string">&quot;ok&quot;</span> : <span class="hljs-number">0</span>,<br>        <span class="hljs-string">&quot;errmsg&quot;</span> : <span class="hljs-string">&quot;Database test could not be created :: caused by :: No shards found&quot;</span>,<br>        <span class="hljs-string">&quot;code&quot;</span> : <span class="hljs-number">70</span>,<br>        <span class="hljs-string">&quot;codeName&quot;</span> : <span class="hljs-string">&quot;ShardNotFound&quot;</span>,<br>        <span class="hljs-string">&quot;$clusterTime&quot;</span> : &#123;<br>                <span class="hljs-string">&quot;clusterTime&quot;</span> : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1683909745</span>, <span class="hljs-number">1</span>),<br>                <span class="hljs-string">&quot;signature&quot;</span> : &#123;<br>                        <span class="hljs-string">&quot;hash&quot;</span> : <span class="hljs-built_in">BinData</span>(<span class="hljs-number">0</span>,<span class="hljs-string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span>),<br>                        <span class="hljs-string">&quot;keyId&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">0</span>)<br>                &#125;<br>        &#125;,<br>        <span class="hljs-string">&quot;operationTime&quot;</span> : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1683909745</span>, <span class="hljs-number">1</span>)<br>&#125;)<br></code></pre></td></tr></table></figure><p>插入失败的原因：通过路由节点操作，现在只是连接了配置节点，还没有连接分片数据节点，因此无法写入业务数据。</p><h3 id="在路由节点上进行分片操作"><a class="markdownIt-Anchor" href="#在路由节点上进行分片操作"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/reference/method/js-sharding/">在路由节点上进行分片操作</a></h3><p class="note note-primary">将第一套分片副本集添加进来</p><p>使用语法</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">sh.<span class="hljs-title function_">addShard</span>(<span class="hljs-string">&quot;副本集名称/IP:Port&quot;</span>)<br></code></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs javascript">mongo --port <span class="hljs-number">27018</span><br><br>sh.<span class="hljs-title function_">addShard</span>(<span class="hljs-params"><span class="hljs-string">&quot;rs1/172.17.0.2:27017,172.17.0.3:27017,172.17.0.4:27017&quot;</span></span>)<br><br><br>&#123;<br>        <span class="hljs-string">&quot;shardAdded&quot;</span> : <span class="hljs-string">&quot;rs1&quot;</span>,<br>        <span class="hljs-string">&quot;ok&quot;</span> : <span class="hljs-number">1</span>,<br>        <span class="hljs-string">&quot;$clusterTime&quot;</span> : &#123;<br>                <span class="hljs-string">&quot;clusterTime&quot;</span> : <span class="hljs-title class_">Timestamp</span>(<span class="hljs-number">1684141648</span>, <span class="hljs-number">4</span>),<br>                <span class="hljs-string">&quot;signature&quot;</span> : &#123;<br>                        <span class="hljs-string">&quot;hash&quot;</span> : <span class="hljs-title class_">BinData</span>(<span class="hljs-number">0</span>,<span class="hljs-string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span>),<br>                        <span class="hljs-string">&quot;keyId&quot;</span> : <span class="hljs-title class_">NumberLong</span>(<span class="hljs-number">0</span>)<br>                &#125;<br>        &#125;,<br>        <span class="hljs-string">&quot;operationTime&quot;</span> : <span class="hljs-title class_">Timestamp</span>(<span class="hljs-number">1684141648</span>, <span class="hljs-number">4</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>查看分片状态</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs javascript">mongos&gt; sh.<span class="hljs-title function_">status</span>()<br>--- <span class="hljs-title class_">Sharding</span> <span class="hljs-title class_">Status</span> --- <br>  sharding <span class="hljs-attr">version</span>: &#123;<br>        <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">1</span>,<br>        <span class="hljs-string">&quot;minCompatibleVersion&quot;</span> : <span class="hljs-number">5</span>,<br>        <span class="hljs-string">&quot;currentVersion&quot;</span> : <span class="hljs-number">6</span>,<br>        <span class="hljs-string">&quot;clusterId&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;645e6ad0efcc6b2b53143174&quot;</span>)<br>  &#125;<br>  <span class="hljs-attr">shards</span>:<br>        &#123;  <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-string">&quot;rs1&quot;</span>,  <span class="hljs-string">&quot;host&quot;</span> : <span class="hljs-string">&quot;rs1/172.17.0.2:27017,172.17.0.3:27017,172.17.0.4:27017&quot;</span>,  <span class="hljs-string">&quot;state&quot;</span> : <span class="hljs-number">1</span>,  <span class="hljs-string">&quot;topologyTime&quot;</span> : <span class="hljs-title class_">Timestamp</span>(<span class="hljs-number">1684141648</span>, <span class="hljs-number">1</span>) &#125;<br>  active <span class="hljs-attr">mongoses</span>:<br>        <span class="hljs-string">&quot;5.0.5&quot;</span> : <span class="hljs-number">1</span><br>  <span class="hljs-attr">autosplit</span>:<br>        <span class="hljs-title class_">Currently</span> <span class="hljs-attr">enabled</span>: yes<br>  <span class="hljs-attr">balancer</span>:<br>        <span class="hljs-title class_">Currently</span> <span class="hljs-attr">enabled</span>: yes<br>        <span class="hljs-title class_">Currently</span> <span class="hljs-attr">running</span>: no<br>        <span class="hljs-title class_">Failed</span> balancer rounds <span class="hljs-keyword">in</span> last <span class="hljs-number">5</span> <span class="hljs-attr">attempts</span>: <span class="hljs-number">0</span><br>        <span class="hljs-title class_">Migration</span> results <span class="hljs-keyword">for</span> the last <span class="hljs-number">24</span> <span class="hljs-attr">hours</span>: <br>                <span class="hljs-title class_">No</span> recent migrations<br>  <span class="hljs-attr">databases</span>:<br>        &#123;  <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-string">&quot;config&quot;</span>,  <span class="hljs-string">&quot;primary&quot;</span> : <span class="hljs-string">&quot;config&quot;</span>,  <span class="hljs-string">&quot;partitioned&quot;</span> : <span class="hljs-literal">true</span> &#125;<br>                config.<span class="hljs-property">system</span>.<span class="hljs-property">sessions</span><br>                        shard <span class="hljs-attr">key</span>: &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">1</span> &#125;<br>                        <span class="hljs-attr">unique</span>: <span class="hljs-literal">false</span><br>                        <span class="hljs-attr">balancing</span>: <span class="hljs-literal">true</span><br>                        <span class="hljs-attr">chunks</span>:<br>                                rs1     <span class="hljs-number">1024</span><br>                        too many chunks to print, use verbose <span class="hljs-keyword">if</span> you want to force print<br></code></pre></td></tr></table></figure><p class="note note-primary">添加第二套分片副本集</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs javascript">sh.<span class="hljs-title function_">addShard</span>(<span class="hljs-params"><span class="hljs-string">&quot;rs2/172.17.0.5:27017,172.17.0.6:27017,172.17.0.7:27017&quot;</span></span>)<br><br><br>&#123;<br>        <span class="hljs-string">&quot;shardAdded&quot;</span> : <span class="hljs-string">&quot;rs2&quot;</span>,<br>        <span class="hljs-string">&quot;ok&quot;</span> : <span class="hljs-number">1</span>,<br>        <span class="hljs-string">&quot;$clusterTime&quot;</span> : &#123;<br>                <span class="hljs-string">&quot;clusterTime&quot;</span> : <span class="hljs-title class_">Timestamp</span>(<span class="hljs-number">1684142090</span>, <span class="hljs-number">4</span>),<br>                <span class="hljs-string">&quot;signature&quot;</span> : &#123;<br>                        <span class="hljs-string">&quot;hash&quot;</span> : <span class="hljs-title class_">BinData</span>(<span class="hljs-number">0</span>,<span class="hljs-string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span>),<br>                        <span class="hljs-string">&quot;keyId&quot;</span> : <span class="hljs-title class_">NumberLong</span>(<span class="hljs-number">0</span>)<br>                &#125;<br>        &#125;,<br>        <span class="hljs-string">&quot;operationTime&quot;</span> : <span class="hljs-title class_">Timestamp</span>(<span class="hljs-number">1684142090</span>, <span class="hljs-number">4</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>查看分片状态</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs javascript">mongos&gt; sh.<span class="hljs-title function_">status</span>()<br>--- <span class="hljs-title class_">Sharding</span> <span class="hljs-title class_">Status</span> --- <br>  sharding <span class="hljs-attr">version</span>: &#123;<br>        <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">1</span>,<br>        <span class="hljs-string">&quot;minCompatibleVersion&quot;</span> : <span class="hljs-number">5</span>,<br>        <span class="hljs-string">&quot;currentVersion&quot;</span> : <span class="hljs-number">6</span>,<br>        <span class="hljs-string">&quot;clusterId&quot;</span> : <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;645e6ad0efcc6b2b53143174&quot;</span>)<br>  &#125;<br>  <span class="hljs-attr">shards</span>:<br>        &#123;  <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-string">&quot;rs1&quot;</span>,  <span class="hljs-string">&quot;host&quot;</span> : <span class="hljs-string">&quot;rs1/172.17.0.2:27017,172.17.0.3:27017,172.17.0.4:27017&quot;</span>,  <span class="hljs-string">&quot;state&quot;</span> : <span class="hljs-number">1</span>,  <span class="hljs-string">&quot;topologyTime&quot;</span> : <span class="hljs-title class_">Timestamp</span>(<span class="hljs-number">1684141648</span>, <span class="hljs-number">1</span>) &#125;<br>        &#123;  <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-string">&quot;rs2&quot;</span>,  <span class="hljs-string">&quot;host&quot;</span> : <span class="hljs-string">&quot;rs2/172.17.0.5:27017,172.17.0.6:27017,172.17.0.7:27017&quot;</span>,  <span class="hljs-string">&quot;state&quot;</span> : <span class="hljs-number">1</span>,  <span class="hljs-string">&quot;topologyTime&quot;</span> : <span class="hljs-title class_">Timestamp</span>(<span class="hljs-number">1684142090</span>, <span class="hljs-number">2</span>) &#125;<br>  active <span class="hljs-attr">mongoses</span>:<br>        <span class="hljs-string">&quot;5.0.5&quot;</span> : <span class="hljs-number">1</span><br>  <span class="hljs-attr">autosplit</span>:<br>        <span class="hljs-title class_">Currently</span> <span class="hljs-attr">enabled</span>: yes<br>  <span class="hljs-attr">balancer</span>:<br>        <span class="hljs-title class_">Currently</span> <span class="hljs-attr">enabled</span>: yes<br>        <span class="hljs-title class_">Currently</span> <span class="hljs-attr">running</span>: no<br>        <span class="hljs-title class_">Failed</span> balancer rounds <span class="hljs-keyword">in</span> last <span class="hljs-number">5</span> <span class="hljs-attr">attempts</span>: <span class="hljs-number">0</span><br>        <span class="hljs-title class_">Migration</span> results <span class="hljs-keyword">for</span> the last <span class="hljs-number">24</span> <span class="hljs-attr">hours</span>: <br>                <span class="hljs-number">30</span> : <span class="hljs-title class_">Success</span><br>  <span class="hljs-attr">databases</span>:<br>        &#123;  <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-string">&quot;config&quot;</span>,  <span class="hljs-string">&quot;primary&quot;</span> : <span class="hljs-string">&quot;config&quot;</span>,  <span class="hljs-string">&quot;partitioned&quot;</span> : <span class="hljs-literal">true</span> &#125;<br>                config.<span class="hljs-property">system</span>.<span class="hljs-property">sessions</span><br>                        shard <span class="hljs-attr">key</span>: &#123; <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-number">1</span> &#125;<br>                        <span class="hljs-attr">unique</span>: <span class="hljs-literal">false</span><br>                        <span class="hljs-attr">balancing</span>: <span class="hljs-literal">true</span><br>                        <span class="hljs-attr">chunks</span>:<br>                                rs1     <span class="hljs-number">994</span><br>                                rs2     <span class="hljs-number">30</span><br>                        too many chunks to print, use verbose <span class="hljs-keyword">if</span> you want to force print<br></code></pre></td></tr></table></figure><div class="note note-warning"><p>如果添加分片失败，需要先手动移除分片，检查添加分片的信息的正确性后，再次添加分片。移除分片参考：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">db.<span class="hljs-title function_">runCommand</span>( &#123; <span class="hljs-attr">removeShard</span>: <span class="hljs-string">&quot;rs1&quot;</span> &#125; )<br></code></pre></td></tr></table></figure><p>如果只剩下最后一个shard，是无法删除的，移除时会自动转移分片数据，需要一个时间过程。完成后，再次执行删除分片命令才能真正删除。</p></div><h3 id="数据库开启分片功能"><a class="markdownIt-Anchor" href="#数据库开启分片功能"></a> 数据库开启分片功能</h3><ul><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/reference/method/sh.enableSharding/">sh.enableSharding(database, primaryShard)</a> 显式创建数据库。使用 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/mongodb-shell/#mongodb-binary-bin.mongosh"><code>mongosh</code></a> 方法 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/reference/method/sh.shardCollection/#mongodb-method-sh.shardCollection"><code>sh.shardCollection()</code></a> 对数据库上的集合进行分片（从 MongoDB 6.0 开始，对集合进行分片不需要此方法）</li><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/reference/method/sh.shardCollection/">sh.shardCollection(namespace, key, unique, options)</a> 使用 <code>key</code> 作为分片键对集合进行分片。分片键确定MongoDB如何在分片之间分发集合的文档</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs javascript">mongos&gt; sh.<span class="hljs-title function_">enableSharding</span>(<span class="hljs-params"><span class="hljs-string">&quot;test&quot;</span></span>)<br><br><br>&#123;<br>        <span class="hljs-string">&quot;ok&quot;</span> : <span class="hljs-number">1</span>,<br>        <span class="hljs-string">&quot;$clusterTime&quot;</span> : &#123;<br>                <span class="hljs-string">&quot;clusterTime&quot;</span> : <span class="hljs-title class_">Timestamp</span>(<span class="hljs-number">1684143030</span>, <span class="hljs-number">5</span>),<br>                <span class="hljs-string">&quot;signature&quot;</span> : &#123;<br>                        <span class="hljs-string">&quot;hash&quot;</span> : <span class="hljs-title class_">BinData</span>(<span class="hljs-number">0</span>,<span class="hljs-string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span>),<br>                        <span class="hljs-string">&quot;keyId&quot;</span> : <span class="hljs-title class_">NumberLong</span>(<span class="hljs-number">0</span>)<br>                &#125;<br>        &#125;,<br>        <span class="hljs-string">&quot;operationTime&quot;</span> : <span class="hljs-title class_">Timestamp</span>(<span class="hljs-number">1684143030</span>, <span class="hljs-number">4</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>将名为 “mydb” 的数据库中的 “mycollection” 集合按照 “_id” 字段进行分片</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sh.shardCollection(&quot;mydb.mycollection&quot;, &#123;_id: 1&#125;)<br></code></pre></td></tr></table></figure><h3 id="分片键和分片策略"><a class="markdownIt-Anchor" href="#分片键和分片策略"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/core/sharding-shard-key/">分片键和分片策略</a></h3><p>分片键可以是单个索引字段，也可以是复合索引涵盖的多个字段，复合索引确定集合文档在集群分片中的分布。</p><p>MongoDB将分片键值（或使用 Hash散列分片键值）的范围划分为分片键值的非重叠范围。每个范围都与一个块（ <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/reference/glossary/#std-term-chunk">chunk</a>）相关联。</p><p><img src="/2023/04/14/MongoDB/%E5%88%86%E7%89%87%E8%8C%83%E5%9B%B4.png" srcset="/img/loading.gif" lazyload alt></p><div class="note note-warning"><p>chunk</p><p>特定分片内连续的分片键值范围。区块范围包括下边界，不包括上限。MongoDB在块增长超过配置的块大小（默认情况下为128MB）时会拆分块</p><p>当一个分片包含相对于其他分片的集合的区块过多时，MongoDB会迁移块。参考 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/core/sharding-balancer-administration/#std-label-sharding-balancing">分片集群负载均衡</a></p></div><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/core/sharding-choose-a-shard-key/">分片键的选择</a>：</p><ul><li><p><strong>分片键的基数</strong></p><p>分片键的基数代表分片键最大能有多少个块（chunk）</p></li><li><p><strong>分片键频率</strong></p><p>考虑分片键值在文档出现的频率，尽量选择重复出现频率不会差异很大的字段</p></li><li><p><strong>非单调变更</strong></p><p>在范围分片时，单调递增的主键要注意minKey和maxKey的分片，如果单调递增，大部分数据可能会在maxKey的数据块上</p></li></ul><div class="note note-primary"><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/core/hashed-sharding/">Hash分片策略</a></p></div><p><img src="/2023/04/14/MongoDB/hash%E5%88%86%E7%89%87.png" srcset="/img/loading.gif" lazyload alt></p><p>哈希分片使用单字段哈希索引或复合哈希索引（4.4 版新功能）作为分片键，用于跨分片集群对数据进行分区。如无范围查询需求，使用 <code>_id</code> 进行Hash分片是一个不错的选择。</p><p>下面的例子是使用nickname作为片键，根据其值的哈希值进行数据分片</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs javascript">mongos&gt; sh.<span class="hljs-title function_">shardCollection</span>(<span class="hljs-params"><span class="hljs-string">&quot;articledb.comment&quot;</span>,&#123;<span class="hljs-string">&quot;nickname&quot;</span>:<span class="hljs-string">&quot;hashed&quot;</span>&#125;</span>)<br>&#123;<br>    <span class="hljs-string">&quot;collectionsharded&quot;</span> : <span class="hljs-string">&quot;articledb.comment&quot;</span>,<br>    <span class="hljs-string">&quot;collectionUUID&quot;</span> : <span class="hljs-title function_">UUID</span>(<span class="hljs-string">&quot;ddea6ed8-ee61-4693-bd16-196acc3a45e8&quot;</span>),<br>    <span class="hljs-string">&quot;ok&quot;</span> : <span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;operationTime&quot;</span> : <span class="hljs-title class_">Timestamp</span>(<span class="hljs-number">1564612840</span>, <span class="hljs-number">28</span>),<br>    <span class="hljs-string">&quot;$clusterTime&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;clusterTime&quot;</span> : <span class="hljs-title class_">Timestamp</span>(<span class="hljs-number">1564612840</span>, <span class="hljs-number">28</span>),<br>        <span class="hljs-string">&quot;signature&quot;</span> : &#123;<br>			<span class="hljs-string">&quot;hash&quot;</span> : <span class="hljs-title class_">BinData</span>(<span class="hljs-number">0</span>,<span class="hljs-string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span>),<br>            <span class="hljs-string">&quot;keyId&quot;</span> : <span class="hljs-title class_">NumberLong</span>(<span class="hljs-number">0</span>)<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><div class="note note-primary"><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/core/ranged-sharding/">范围分片策略（默认）</a></p></div><p><img src="/2023/04/14/MongoDB/%E8%8C%83%E5%9B%B4%E5%88%86%E7%89%87.png" srcset="/img/loading.gif" lazyload alt></p><p>基于范围的分片会将数据划分为由片键值确定的连续范围。 在此模型中，具有 <code>相邻</code> 分片键值的文档可能位于相同的块或分片中。 这有 <code>效提高范围查询效率</code>，但是如果分片键没选择好，则容易导致数据倾斜。</p><p>每个chunk的数据都存储在同一个Shard上，每个Shard可以存储很多个chunk，chunk存储在哪个shard的信息会存储在Config server中，mongos也会根据各个shard上的chunk的数量来自动做负载均衡。</p><p>下例是使用年龄进行范围分片</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs javascript">mongos&gt; sh.<span class="hljs-title function_">shardCollection</span>(<span class="hljs-params"><span class="hljs-string">&quot;articledb.author&quot;</span>,&#123;<span class="hljs-string">&quot;age&quot;</span>:<span class="hljs-number">1</span>&#125;</span>)<br>&#123;<br>    <span class="hljs-string">&quot;collectionsharded&quot;</span> : <span class="hljs-string">&quot;articledb.author&quot;</span>,<br>    <span class="hljs-string">&quot;collectionUUID&quot;</span> : <span class="hljs-title function_">UUID</span>(<span class="hljs-string">&quot;9a47bdaa-213a-4039-9c18-e70bfc369df7&quot;</span>),<br>    <span class="hljs-string">&quot;ok&quot;</span> : <span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;operationTime&quot;</span> : <span class="hljs-title class_">Timestamp</span>(<span class="hljs-number">1567512803</span>, <span class="hljs-number">13</span>),<br>    <span class="hljs-string">&quot;$clusterTime&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;clusterTime&quot;</span> : <span class="hljs-title class_">Timestamp</span>(<span class="hljs-number">1567512803</span>, <span class="hljs-number">13</span>),<br>        <span class="hljs-string">&quot;signature&quot;</span> : &#123;<br>            <span class="hljs-string">&quot;hash&quot;</span> : <span class="hljs-title class_">BinData</span>(<span class="hljs-number">0</span>,<span class="hljs-string">&quot;eE9QT5yE5sL1Tyr7+3U8GRy5+5Q=&quot;</span>),<br>            <span class="hljs-string">&quot;keyId&quot;</span> : <span class="hljs-title class_">NumberLong</span>(<span class="hljs-string">&quot;6732061237309341726&quot;</span>)<br>			&#125;<br>		&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>一旦对一个集合分片，分片键和分片值就不可改变。</p><h3 id="集合进行分片"><a class="markdownIt-Anchor" href="#集合进行分片"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/reference/method/sh.shardCollection/">集合进行分片</a></h3><p>语法：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">sh.<span class="hljs-title function_">shardCollection</span>(namespace, key, unique, options)<br></code></pre></td></tr></table></figure><table><thead><tr><th>Parameter</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td><code>namespace</code></td><td>string</td><td>要分片的集合的命名空间，格式为 <code>&quot;&lt;database&gt;.&lt;collection&gt;&quot;</code></td></tr><tr><td><code>key</code></td><td>document</td><td>指定要用作分片键的一个或多个字段的文档；<br>字段值为1，用于范围分片；字段值为 “hash”，用于hash分片；<br>分片键必须由索引支持。除非集合为空，否则索引必须在<br><code>shardCollection</code> 命令之前存在。如果集合为空，MongoDB<br>会在分片集合之前创建索引，如果可以支持分片键的索引尚不存在。</td></tr><tr><td><code>unique</code></td><td>boolean</td><td>可选，指定 <code>true</code> 以确保基础索引强制实施唯一约束。默认为 <code>false</code></td></tr><tr><td><code>options</code></td><td></td><td>可选，包含可选字段的文档，包括 <code>numInitialChunks</code> 和 <code>collation</code></td></tr></tbody></table><p>对 test 数据库的 user 表进行hash分片</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs javascript">mongos&gt; sh.<span class="hljs-title function_">shardCollection</span>(<span class="hljs-params"><span class="hljs-string">&quot;test.user&quot;</span>, &#123;<span class="hljs-string">&quot;_id&quot;</span>: <span class="hljs-string">&quot;hashed&quot;</span>&#125;</span>)<br><br>&#123;<br>        <span class="hljs-string">&quot;collectionsharded&quot;</span> : <span class="hljs-string">&quot;test.user&quot;</span>,<br>        <span class="hljs-string">&quot;ok&quot;</span> : <span class="hljs-number">1</span>,<br>        <span class="hljs-string">&quot;$clusterTime&quot;</span> : &#123;<br>                <span class="hljs-string">&quot;clusterTime&quot;</span> : <span class="hljs-title class_">Timestamp</span>(<span class="hljs-number">1684150040</span>, <span class="hljs-number">29</span>),<br>                <span class="hljs-string">&quot;signature&quot;</span> : &#123;<br>                        <span class="hljs-string">&quot;hash&quot;</span> : <span class="hljs-title class_">BinData</span>(<span class="hljs-number">0</span>,<span class="hljs-string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span>),<br>                        <span class="hljs-string">&quot;keyId&quot;</span> : <span class="hljs-title class_">NumberLong</span>(<span class="hljs-number">0</span>)<br>                &#125;<br>        &#125;,<br>        <span class="hljs-string">&quot;operationTime&quot;</span> : <span class="hljs-title class_">Timestamp</span>(<span class="hljs-number">1684150040</span>, <span class="hljs-number">28</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p class="note note-primary">插入数据测试</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">use</span> <span class="hljs-title">test</span><br><br><span class="hljs-title">mongos</span>&gt; <span class="hljs-title">for</span> (<span class="hljs-title">var</span> <span class="hljs-title">i</span>=1; i&lt;=<span class="hljs-number">100</span>; i++) &#123;<br>        db.user.<span class="hljs-title function_ invoke__">insertOne</span>(<br>            &#123;<br>                <span class="hljs-attr">_id</span>: i+<span class="hljs-string">&quot;&quot;</span>,<br>                <span class="hljs-attr">userName</span>: <span class="hljs-string">&quot;wgf_&quot;</span>+i<br>            &#125;<br>        )<br>    &#125;<br>    <br>&#123; <span class="hljs-string">&quot;acknowledged&quot;</span> : <span class="hljs-literal">true</span>, <span class="hljs-string">&quot;insertedId&quot;</span> : <span class="hljs-string">&quot;100&quot;</span> &#125;<br></code></pre></td></tr></table></figure><p>登陆第一个副本集 <code>mongo_rs1_1</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs javascript">docker exec -it mongo_rs1_1 bash<br>mongo<br>use test<br><span class="hljs-attr">rs1</span>:<span class="hljs-variable constant_">PRIMARY</span>&gt; db.<span class="hljs-property">user</span>.<span class="hljs-title function_">find</span>().<span class="hljs-title function_">count</span>()<br><br><span class="hljs-number">58</span><br></code></pre></td></tr></table></figure><p>登陆第二个副本集 <code>mongo_rs2_1</code></p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs stata">docker exec -it mongo_rs2_1 bash<br>mongo<br><span class="hljs-keyword">use</span> <span class="hljs-keyword">test</span><br>s2:PRIMARY&gt; <span class="hljs-keyword">db</span>.user.find().<span class="hljs-keyword">count</span>()<br><br>42<br></code></pre></td></tr></table></figure><p>可以看到，100条数据近似均匀的分布到了2个shard上。是根据片键的哈希值分配的。</p><h3 id="分片负载均衡"><a class="markdownIt-Anchor" href="#分片负载均衡"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/sharding-balancer-administration/">分片负载均衡</a></h3><p><img src="/2023/04/14/MongoDB/%E5%88%86%E7%89%87%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1.png" srcset="/img/loading.gif" lazyload alt="分片负载均衡"></p><p>MongoDB 平衡器是一个后台进程，用于监控每个分片集合的每个分片上的数据量。当给定分片上分片集合的数据量达到特定的 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/sharding-balancer-administration/#std-label-sharding-migration-thresholds">迁移阈值</a> 时，平衡器会尝试在分片之间自动迁移数据，并在遵守区域的情况下达到每个分片的均匀数据量。默认情况下，始终启用平衡器进程。</p><p>分片集群的平衡过程对用户和应用程序层是无感知的，但是在执行该过程时可能会对性能产生一些影响。</p><p>MongoDB可以执行并行数据迁移，但一个分片一次最多可以参与一个迁移。对于具有 n 个分片的分片集群，MongoDB 最多可以同时执行 <code>n/2</code>（向下舍入）迁移</p><p class="note note-primary">迁移阈值</p><p>为了最大程度地减少均衡对集群的影响，均衡器仅在分片集合的数据分布达到特定阈值后才开始自我平衡。</p><p>如果分片之间的数据差异（对于该集合）小于集合配置的范围大小的 <code>三倍</code>，则认为集合是平衡的。对于默认范围大小 <code>128MB</code> ，对于给定集合，两个分片的数据大小差异必须至少为 <code>384MB</code> 才能进行迁移。</p><div class="note note-warning"><p>分片集群与SpringBoot时，连接的是Router节点</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">data:</span><br>    <span class="hljs-attr">mongodb:</span><br>      <span class="hljs-attr">uri:</span> <span class="hljs-string">mongodb://172.17.0.11:27018/test</span> <span class="hljs-comment"># 多个逗号分隔</span><br></code></pre></td></tr></table></figure></div><h1 id="事务"><a class="markdownIt-Anchor" href="#事务"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/transactions/">事务</a></h1><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/core/transactions-operations/">事务支持和被限制的操作</a></p><p>在MongoDB中，对单个文档的操作是原子的。由于可以使用嵌入式文档和数组来组织单个文档结构中数据之间的关系，而不是跨多个文档和集合进行规范化（范式），因此这种单文档原子性消除了许多实际用例对多文档事务的需求。</p><p>对于需要对多个文档（在单个或多个集合中）进行读取和写入的原子性的情况，MongoDB支持多文档事务。使用分布式事务可以跨多个操作、集合、数据库、文档和分片使用。</p><div class="note note-warning"><p><strong>分布式事务和多文档事务</strong></p><p>从MongoDB 4.2开始，这两个术语是同义词。分布式事务是指分片集群和副本集上的多文档事务。多文档事务（无论是在分片集群还是副本集上）也称为从MongoDB 4.2开始的分布式事务。</p><p>分布式事务是非常影响数据库性能的，官方推荐尽量使用反范式的设计规避分布式事务问题，不建议在Mongo大量使用多文档事务。</p></div><div class="note note-primary"><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/core/transactions/#transactions-and-atomicity">事务和原子性</a></p></div><p>对于需要读取和写入多个文档（在单个或多个集合中）的原子性的情况，MongoDB支持多文档事务：</p><ul><li>在4.0版本中，MongoDB支持副本集上的多文档事务。</li><li>在 4.2 版本中，MongoDB 引入了分布式事务，它增加了对分片集群上的多文档事务的支持，并结合了对副本集上多文档事务的现有支持。</li></ul><p>多文档事务是原子的（即提供 <code>全有或全无</code> 的语义）：</p><ul><li>当一个事务提交后，所有数据的修改都会被保存并且变得可见。也就是说，在一个事务中，它所做的所有更改要么全部提交，要么全部回滚，保证了数据的一致性。</li><li>在一个事务提交之前，该事务所做的数据更改在事务外部是不可见的。</li><li>然而，当一个事务向多个Shard写入时，并不是所有的外部读操作都需要等待事务提交结果后在所有分片上都可见才能进行。</li><li>例如，如果一个事务已经提交，并且在Shard A上的写入1可见，但在Shard B上的写入2还不能被看到，对于使用 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/reference/read-concern-local/#mongodb-readconcern-readconcern.-local-"><code>&quot;local&quot;</code></a> 读关注点的外部读取操作可以读取到写入1的结果，而不会看到写入2（Seata也是如此，为了提高读取性能，全局事务未提交下，允许外部读取提交的分支事务）。</li><li>当一个事务中止时，所有在该事务中作出的数据更改都将被回滚。</li></ul><div class="note note-primary"><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/core/transactions/#transactions-and-operations">事务和操作</a></p></div><p>分布式事务可以跨多个<code>操作</code>、<code>集合</code>、<code>数据库</code>、<code>文档</code>以及从 MongoDB 4.2 开始的 <code>分片</code> 中使用。</p><p>关于事务：</p><ul><li>可以对现有集合指定读/写 （CRUD） 操作。</li><li>MongoDB 4.4开始，可以在 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/core/transactions/#std-label-transactions-create-collections-indexes">事务中创建集合和索引</a>；但是，不能在跨分片的写事务中创建新集合。例如，如果你想对一个分片中已存在的集合进行写入且在另外一个不同的分片中隐式地创建集合，那么MongoDB无法在同一事务中执行这两种操作。</li><li>事务中使用的集合可以位于不同的数据库中</li><li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/core/capped-collections/">capped collections</a> 不能使用事务</li><li>MongoDB 5.0开始，<a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/core/capped-collections/">capped collections</a> 不能使用取关注点 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/reference/read-concern-snapshot/#mongodb-readconcern-readconcern.-snapshot-"><code>&quot;snapshot&quot;</code></a></li><li>无法返回支持的操作的查询计划（即 <code>explain</code> )</li><li>对于在事务外部创建的游标，不能在事务内部调用 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/reference/command/getMore/#mongodb-dbcommand-dbcmd.getMore"><code>getMore</code></a></li><li>对于在事务中创建的游标，不能在事务外部调用 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/reference/command/getMore/#mongodb-dbcommand-dbcmd.getMore"><code>getMore</code></a></li></ul><div class="note note-primary"><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/core/transactions/#transactions-and-sessions">事务与会话</a></p></div><ol><li>事务是与某个会话相关联的；即你为一个会话启动一个事务。</li><li>在任何给定时间，一个会话最多可以有一个打开的事务。</li><li>使用驱动程序时，事务中的每个操作都必须与会话相关联。</li><li>如果一个会话结束了并且它有一个打开的事务，则事务会中止。</li></ol><div class="note note-primary"><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/core/transactions/#transactions-and-operations">事务和读取偏好</a></p></div><p>在使用驱动时，可以在事务开始时设置事务级别的 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/core/read-preference/#std-label-replica-set-read-preference">read preference</a> ：</p><ul><li>如果事务级别的读偏好没有设置，事务级的读偏好默认为会话级的读偏好</li><li>如果未设置事务级别和会话级别读取偏好，则事务将使用客户端级别的读取偏好。默认情况下，客户端级别的读取偏好项为 <code>primary</code></li><li><span class="green-line">包含读取操作的多文档事务必须使用 <code>primary</code> 读取偏好</span>。给定事务中的所有操作都必须路由到同一成员。</li></ul><div class="note note-primary"><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/core/transactions/#transactions-and-read-concern">事务和读取关注（事务读隔离）</a></p></div><p>事务中的操作使用事务级读取关注点。也就是说，在 <code>集合</code> 和 <code>数据库</code> 级别设置的任何读取关注点都将在事务中被忽略。</p><p>可以在事务启动时设置事务级读取关注点</p><ul><li><p>如果未设置事务级读取关注点，则事务级读取关注点默认为会话级读取关注点。</p></li><li><p>如果未设置事务级和会话级读取关注点，则事务级读取关注点默认为客户端级读取关注点。默认情况下，对于针对主数据库的读取，客户端级读取关注点为 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/reference/read-concern-local/#mongodb-readconcern-readconcern.-local-"><code>&quot;local&quot;</code></a></p><div class="note note-warning"><p>在分布式事务中，<code>local</code> 意味着 <code>读未提交</code>，因为它返回节点最新的可用数据，在分片集群事务中，它可以读取到分支事务（分片事务）提交而全局事务未提交的更改数据</p></div></li></ul><table><thead><tr><th>读取关注</th><th>说明</th></tr></thead><tbody><tr><td><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/reference/read-concern-local/#mongodb-readconcern-readconcern.-local-"><code>&quot;local（默认）&quot;</code></a></td><td>读取关注点 <code>&quot;local&quot;</code> 返回节点中可用的最新数据，但可以回滚（读未提交）。<br><br>对于分片集群上的事务， <code>&quot;local&quot;</code> 读取关注点无法保证数据来自同一个跨分片的快照视图，如果需要快照隔离，请使用 <code>&quot;snapshot&quot;</code> 读取关注点<br><br>MongoDB 4.4开始，可以在事务中创建集合和索引。如果显式创建集合或索引，则事务必须使用读取关注点 <code>&quot;local&quot;</code> 。 集合的隐式创建可以使用可用于事务的任何读取关注点。</td></tr><tr><td><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/reference/read-concern-majority/#mongodb-readconcern-readconcern.-majority-"><code>&quot;majority&quot;</code></a></td><td>读取关注点 <code>&quot;majority&quot;</code> 返回已由大多数副本集成员确认的数据（即数据无法回滚，读已提交），如果事务以写关注点<code>&quot;majority&quot;</code>提交<br><br>对于分片集群上的事务， <code>&quot;local&quot;</code> 读取关注点无法保证数据来自分片上的同一快照视图（视图未完成同步），如果需要快照隔离，请使用 <code>&quot;snapshot&quot;</code> 读取关注点</td></tr><tr><td><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/reference/read-concern-snapshot/#mongodb-readconcern-readconcern.-snapshot-"><code>&quot;snapshot&quot;</code></a></td><td>如果事务以写入关注点<code>&quot;majority&quot;</code>提交，则读取关注点 <code>&quot;snapshot&quot;</code> 会从一个大多数已提交数据的快照中返回数据（可重复读）。<br><br>对于分片集群上的事务，数据的 <code>&quot;snapshot&quot;</code> 视图在分片之间同步。</td></tr></tbody></table><div class="note note-primary"><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/core/transactions/#transactions-and-write-concern">事务和写入关注（写一致性）</a></p></div><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/write-concern/#implicit-default-write-concern">隐式默认写关注</a></p><p>MongoDB事务中的写入操作必须使用默认的写入关注，并在提交时使用事务级别的写入关注来提交写入操作。</p><div class="note note-warning"><p>注意</p><p>不要为事务中的各个写入操作显式设置写入关注点。为事务中的各个写入操作设置写入关注点会导致异常。</p></div><p>可以在事务启动时设置事务级写入关注点：</p><table><thead><tr><th>写关注点</th><th>说明</th></tr></thead><tbody><tr><td><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v6.0/reference/write-concern/#mongodb-writeconcern-writeconcern.-number-"><code>w: 1</code></a></td><td>使用 <code>w: 1</code> 写入关注点提交时，事务级 <code>&quot;majority&quot;</code> 读取关注点无法保证事务中的读取操作能读取大多数已提交的数据。<br><br>使用 <code>w: 1</code> 写入关注点提交时，事务级 <code>&quot;snapshot&quot;</code> 读取关注不保证事务中的读取操作使用多数提的交快照数据。</td></tr><tr><td><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/write-concern/#mongodb-writeconcern-writeconcern.-majority-"><code>w: &quot;majority(默认)&quot;</code></a></td><td>在提交已应用于多数（ M）有投票权的成员后，写关注 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/write-concern/#mongodb-writeconcern-writeconcern.-majority-"><code>w: &quot;majority&quot;</code></a> ;即提交到主节点和（M-1）个辅助节点。<br><br>使用 <code>w: &quot;majority&quot;</code> 写入关注点提交时，事务级 <code>&quot;majority&quot;</code> 读关注会保证操作已经读取了大多数提交的数据。 对于分片群集上的事务，大多数提交的数据的视图不会在分片之间同步。<br><br>使用 <code>w: &quot;majority&quot;</code> 写入关注点提交时，事务级 <code>&quot;snapshot&quot;</code> 读取关注点可确保操作来自大多数提交数据的同步快照。</td></tr></tbody></table><div class="note note-primary"><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/transactions-production-consideration/#runtime-limit">执行时长限制</a></p></div><p>默认情况下，事务的运行时间必须小于 <code>一分钟</code>。您可以使用 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/parameters/#mongodb-parameter-param.transactionLifetimeLimitSeconds"><code>transactionLifetimeLimitSeconds</code></a> 对 <code>mongod</code> 实例修改此限制。对于分片集群，必须修改所有分片副本集成员的参数。超过此限制的事务被视为已过期，并将通过定期清理过程中止。</p><div class="note note-primary"><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/transactions-production-consideration/#oplog-size-limit">Oplog大小限制</a></p></div><p>MongoDB根据需要创建尽可能多的oplog条目来封装事务中的所有写入操作，而不是为事务中的所有写入操作创建一个条目。这将删除单个 oplog 条目对其所有写入操作施加的事务的 16MB 总大小限制。尽管删除了总大小限制，但每个oplog条目仍必须在16MB的BSON文档大小限制范围内。</p><div class="note note-primary"><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/transactions-production-consideration/#acquiring-locks">获取锁</a></p></div><p>默认情况下，事务最多等待 <code>5</code> 毫秒来获取事务中操作所需的锁。如果事务无法在 <code>5</code> 毫秒内获取其所需的锁，则事务将中止。</p><p>事务在中止或提交时释放所有锁。</p><div class="note note-warning"><p>在开始事务之前立即创建或删除集合时，如果需要在事务内访问该集合，则在进行创建或删除操作时使用写关注 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/write-concern/#mongodb-writeconcern-writeconcern.-majority-"><code>&quot;majority&quot;</code></a> 可以保证事务能获取到请求的锁。</p></div><p>可以使用 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/parameters/#mongodb-parameter-param.maxTransactionLockRequestTimeoutMillis"><code>maxTransactionLockRequestTimeoutMillis</code></a> 参数来调整事务等待获取锁的时间。增加 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/parameters/#mongodb-parameter-param.maxTransactionLockRequestTimeoutMillis"><code>maxTransactionLockRequestTimeoutMillis</code></a> 允许事务中的操作等待指定的时间来获取所需的锁。这有助于避免在瞬时并发锁获取（如快速运行的元数据操作）上中止事务。但是，这可能会延迟死锁事务操作的中止。</p><div class="note note-primary"><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/transactions-production-consideration/#in-progress-transactions-and-write-conflicts">正在进行的事务和写入冲突</a></p></div><ul><li><p>如果事务正在进行中，但事务外部的写入修改了该事务之后尝试修改的文档（写冲突），则事务会因写入冲突而中止。</p></li><li><p>如果一个事务正在进行并且已经锁定修改文档，那么当事务外部的写操作试图修改同一个文档时，写操作会一直等到事务结束。</p></li></ul><div class="note note-primary"><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/transactions-production-consideration/#in-progress-transactions-and-stale-reads">正在进行的事务和过时的读取</a></p></div><p>事务内的读取操作可能会返回历史版本数据。也就是说，事务内的读操作不能保证看到其他已提交的事务或非事务性写入的内容。例如，假设有以下操作顺序：</p><ol><li>事务正在进行中</li><li>事务外部的写入删除文档</li><li>事务内部的读取操作能够读取现在删除的文档，因为该操作使用的是写入之前的快照。</li></ol><p><span class="green-line">为避免事务内部单个文档的读取过时，可以使用 <code>db.collection.findOneAndUpdate()</code> 方法</span>。例如：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs javascript">session.<span class="hljs-title function_">startTransaction</span>( &#123; <span class="hljs-attr">readConcern</span>: &#123; <span class="hljs-attr">level</span>: <span class="hljs-string">&quot;snapshot&quot;</span> &#125;, <span class="hljs-attr">writeConcern</span>: &#123; <span class="hljs-attr">w</span>: <span class="hljs-string">&quot;majority&quot;</span> &#125; &#125; );<br><br>employeesCollection = session.<span class="hljs-title function_">getDatabase</span>(<span class="hljs-string">&quot;hr&quot;</span>).<span class="hljs-property">employees</span>;<br><br>employeeDoc = employeesCollection.<span class="hljs-title function_">findOneAndUpdate</span>(<br>   &#123; <span class="hljs-attr">_id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">employee</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;Active&quot;</span> &#125;,<br>   &#123; <span class="hljs-attr">$set</span>: &#123; <span class="hljs-attr">employee</span>: <span class="hljs-number">1</span> &#125; &#125;,<br>   &#123; <span class="hljs-attr">returnNewDocument</span>: <span class="hljs-literal">true</span> &#125;<br>);<br></code></pre></td></tr></table></figure><ul><li>如果员工文档在事务之外发生更改，则事务将中止。</li><li>如果员工文档未更改，则事务将返回该文档并锁定该文档。</li></ul><div class="note note-primary"><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/transactions-production-consideration/#in-progress-transactions-and-chunk-migration">正在进行的事务和块迁移</a></p></div><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/sharding-balancer-administration/#std-label-chunk-migration-procedure">区块迁移</a> 在某些阶段获取独占集合锁。</p><p>如果正在进行的事务持有集合上的锁，并且涉及该集合的块迁移刚开始，则这些迁移阶段必须等待事务释放集合上的锁，从而会影响块迁移的性能。</p><p>如果块迁移与事务交错进行（例如，如果事务在块迁移正在进行时开始，并且迁移在事务锁定集合之前完成），则事务在提交期间出错并中止。</p><div class="note note-primary"><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/transactions-production-consideration/#outside-reads-during-commit">提交期间的外部读取</a></p></div><p>在事务提交期间，外部的读操作可能会尝试读取将被事务修改的相同文档。如果事务写入多个分片，则在跨分片提交尝试期间。</p><ul><li>使用读取关注点 <code>&quot;snapshot&quot;</code> 或 <code>&quot;linearizable&quot;</code> 的外部读取，或者是因果一致性会话的一部分（即包括 afterClusterTime）等待事务的所有写入都可见。</li><li>使用其他读取关注点的外部读取不会等待事务的所有写入都可见，而是读取可用文档的事务的历史版本。</li></ul><h2 id="事务操作"><a class="markdownIt-Anchor" href="#事务操作"></a> <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/transactions-in-applications/">事务操作</a></h2><p><a target="_blank" rel="noopener" href="https://blog.clairvoyantsoft.com/mongodb-transaction-management-884f82f62767">Spring Data MongoDB 事务整合</a></p><p class="note note-primary">SpringBoot整合</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-mongodb<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure><p>Mongo配置类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@RequiredArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MongoConfig</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MongoDatabaseFactory mongoDbFactory;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MongoMappingContext mongoMappingContext;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 转换类配置</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 转换类</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> MappingMongoConverter <span class="hljs-title function_">mappingMongoConverter</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">DbRefResolver</span> <span class="hljs-variable">dbRefResolver</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultDbRefResolver</span>(mongoDbFactory);<br>        <span class="hljs-type">MappingMongoConverter</span> <span class="hljs-variable">converter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MappingMongoConverter</span>(dbRefResolver, mongoMappingContext);<br>        <span class="hljs-comment">//不保存 _class 属性到mongo</span><br>        converter.setTypeMapper(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultMongoTypeMapper</span>(<span class="hljs-literal">null</span>));<br>        <span class="hljs-keyword">return</span> converter;<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 定义事务管理器</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> mongoDbFactory</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> MongoTransactionManager <span class="hljs-title function_">mongoTransactionManager</span><span class="hljs-params">(MongoDatabaseFactory mongoDatabaseFactory)</span> &#123;<br>        <span class="hljs-comment">// 设置事务级别的读/写关注级别，目前副本集就三个节点，写关注故意配置为4</span><br>        <span class="hljs-type">TransactionOptions</span> <span class="hljs-variable">transactionOptions</span> <span class="hljs-operator">=</span> TransactionOptions.builder().readConcern(ReadConcern.LOCAL).writeConcern(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WriteConcern</span>(<span class="hljs-number">4</span>)).build();<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MongoTransactionManager</span>(mongoDatabaseFactory, transactionOptions);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>单元测试</p><p>使用上一章节做好分片的 <code>user</code> 集合</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs javascript">@<span class="hljs-title class_">SpringBootTest</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionTest</span> &#123;<br>    @<span class="hljs-title class_">Autowired</span><br>    private <span class="hljs-title class_">UserService</span> userService;<br>    <br>    @<span class="hljs-title class_">Test</span><br>    public <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertTest</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-title class_">User</span> user1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>        user1.<span class="hljs-title function_">setId</span>(<span class="hljs-variable constant_">UUID</span>.<span class="hljs-title function_">randomUUID</span>().<span class="hljs-title function_">toString</span>())<br>                .<span class="hljs-title function_">setUserName</span>(<span class="hljs-variable constant_">UUID</span>.<span class="hljs-title function_">randomUUID</span>().<span class="hljs-title function_">toString</span>());<br><br>        <span class="hljs-title class_">User</span> user2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>        user2.<span class="hljs-title function_">setId</span>(<span class="hljs-variable constant_">UUID</span>.<span class="hljs-title function_">randomUUID</span>().<span class="hljs-title function_">toString</span>())<br>                .<span class="hljs-title function_">setUserName</span>(<span class="hljs-variable constant_">UUID</span>.<span class="hljs-title function_">randomUUID</span>().<span class="hljs-title function_">toString</span>());<br><br>        <span class="hljs-title class_">User</span> user3 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>        user3.<span class="hljs-title function_">setId</span>(<span class="hljs-variable constant_">UUID</span>.<span class="hljs-title function_">randomUUID</span>().<span class="hljs-title function_">toString</span>())<br>                .<span class="hljs-title function_">setUserName</span>(<span class="hljs-variable constant_">UUID</span>.<span class="hljs-title function_">randomUUID</span>().<span class="hljs-title function_">toString</span>());<br><br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">userService</span>.<span class="hljs-title function_">insert</span>(user1, user2, user3);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs javascript">@<span class="hljs-title class_">Service</span><br>@<span class="hljs-title class_">RequiredArgsConstructor</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> &#123;<br>    private final <span class="hljs-title class_">MongoTemplate</span> mongoTemplate;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 分片集群事务</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> <span class="hljs-variable">user1</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> <span class="hljs-variable">user2</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> <span class="hljs-variable">user3</span></span><br><span class="hljs-comment">     */</span><br>    @<span class="hljs-title class_">Transactional</span>(value = <span class="hljs-string">&quot;mongoTransactionManager&quot;</span>)<br>    public <span class="hljs-keyword">void</span> <span class="hljs-title function_">insert</span>(<span class="hljs-params">User user1, User user2, User user3</span>) &#123;<br>        mongoTemplate.<span class="hljs-title function_">insert</span>(user1);<br>        mongoTemplate.<span class="hljs-title function_">insert</span>(user2);<br>        mongoTemplate.<span class="hljs-title function_">insert</span>(user3);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2023/04/14/MongoDB/%E5%86%99%E5%85%B3%E6%B3%A8%E5%BC%82%E5%B8%B8.png" srcset="/img/loading.gif" lazyload alt></p><p>报错是因为写关注没有足够的数据节点承载，原因是副本集只有三个数据节点，事务配置正常</p><p class="note note-primary">分布式事务回滚测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> MongoTransactionManager <span class="hljs-title function_">mongoTransactionManager</span><span class="hljs-params">(MongoDatabaseFactory mongoDatabaseFactory)</span> &#123;<br>    <span class="hljs-comment">// 设置事务级别的读/写关注级别</span><br>    <span class="hljs-type">TransactionOptions</span> <span class="hljs-variable">transactionOptions</span> <span class="hljs-operator">=</span> TransactionOptions.builder().readConcern(ReadConcern.LOCAL).writeConcern(WriteConcern.MAJORITY).build();<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MongoTransactionManager</span>(mongoDatabaseFactory, transactionOptions);<br>&#125;<br></code></pre></td></tr></table></figure><p>修改事务级别的写关注为 <code>MAJORITY</code></p><p>单元测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertErrorTest</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">User</span> <span class="hljs-variable">user1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>    user1.setId(UUID.randomUUID().toString())<br>            .setUserName(UUID.randomUUID().toString());<br><br>    <span class="hljs-type">User</span> <span class="hljs-variable">user2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>    user2.setId(UUID.randomUUID().toString())<br>            .setUserName(UUID.randomUUID().toString());<br><br>    <span class="hljs-type">User</span> <span class="hljs-variable">user3</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>    user3.setId(UUID.randomUUID().toString())<br>            .setUserName(UUID.randomUUID().toString());<br><br>    <span class="hljs-built_in">this</span>.userService.insertError(user1, user2, user3);<br>&#125;<br></code></pre></td></tr></table></figure><p>UserService 添加事务回滚方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Transactional(value = &quot;mongoTransactionManager&quot;, rollbackFor = Exception.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertError</span><span class="hljs-params">(User user1, User user2, User user3)</span> &#123;<br>    mongoTemplate.insert(user1);<br>    mongoTemplate.insert(user2);<br>    mongoTemplate.insert(user3);<br>    <span class="hljs-comment">// 抛出异常，让分片事务回滚</span><br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2023/04/14/MongoDB/%E5%BC%82%E5%B8%B8%E5%9B%9E%E6%BB%9A.png" srcset="/img/loading.gif" lazyload alt></p><p>异常，事务终止提交</p><p><img src="/2023/04/14/MongoDB/%E4%BA%8B%E5%8A%A1%E5%9B%9E%E6%BB%9A.png" srcset="/img/loading.gif" lazyload alt><br>数据没有新增到Mongodb</p><p class="note note-primary">生产可用配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> MongoTransactionManager <span class="hljs-title function_">mongoTransactionManager</span><span class="hljs-params">(MongoDatabaseFactory mongoDatabaseFactory)</span> &#123;<br>    <span class="hljs-comment">// 设置事务级别的读/写关注级别</span><br>    <span class="hljs-type">TransactionOptions</span> <span class="hljs-variable">transactionOptions</span> <span class="hljs-operator">=</span> TransactionOptions.builder().readConcern(ReadConcern.SNAPSHOT).writeConcern(WriteConcern.MAJORITY).build();<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MongoTransactionManager</span>(mongoDatabaseFactory, transactionOptions);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Transactional(value = &quot;mongoTransactionManager&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insert</span><span class="hljs-params">(User user1, User user2, User user3)</span> &#123;<br>    mongoTemplate.insert(user1);<br>    mongoTemplate.insert(user2);<br>    mongoTemplate.insert(user3);<br>&#125;<br></code></pre></td></tr></table></figure><p>单元测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertErrorTest</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">User</span> <span class="hljs-variable">user1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>    user1.setId(UUID.randomUUID().toString())<br>            .setUserName(UUID.randomUUID().toString());<br><br>    <span class="hljs-type">User</span> <span class="hljs-variable">user2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>    user2.setId(UUID.randomUUID().toString())<br>            .setUserName(UUID.randomUUID().toString());<br><br>    <span class="hljs-type">User</span> <span class="hljs-variable">user3</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>    user3.setId(UUID.randomUUID().toString())<br>            .setUserName(UUID.randomUUID().toString());<br><br>    <span class="hljs-built_in">this</span>.userService.insertError(user1, user2, user3);<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2023/04/14/MongoDB/%E4%BA%8B%E5%8A%A1%E6%95%B0%E6%8D%AE%E5%86%99%E5%85%A5.png" srcset="/img/loading.gif" lazyload alt></p><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css"></div><hr><div><div class="post-metas my-3"></div><div class="license-box my-3"><div class="license-title"><div>MongoDB</div><div>https://wugengfeng.cn/2023/04/14/MongoDB/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>wugengfeng</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2023年4月14日</div></div><div class="license-meta-item"><div>许可协议</div><div><a target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"></article><article class="post-next col-6"><a href="/2022/12/21/DDD%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1/" title="DDD领域驱动设计"><span class="hidden-mobile">DDD领域驱动设计</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目录</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",function(){NProgress.done()})</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t){var e=Fluid.plugins.typing,i=t.getElementById("subtitle");i&&e&&e(i.getAttribute("data-typed-text"))}((window,document))</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",function(){var t,o=jQuery("#toc");0!==o.length&&window.tocbot&&(t=jQuery("#board-ctn").offset().top,window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-t},CONFIG.toc)),0<o.find(".toc-list-item").length&&o.css("visibility","visible"),Fluid.events.registerRefreshCallback(function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;0<t.find(".toc-list-item").length&&t.css("visibility","visible")}}))})</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",function(){Fluid.plugins.fancyBox()})</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>